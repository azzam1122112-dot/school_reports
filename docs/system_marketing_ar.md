# نظام التقارير والتذاكر المدرسية — تعريف وتسويق (Arabic)

> هذا الملف مُستخلص من كود المشروع الحالي داخل مستودع `school_reports`، ويهدف لشرح النظام بشكل قابل للاستخدام في التسويق والتعريف، مع تفاصيل عملية عن مهام المستخدمين ومسارات العمل.

## 1) فكرة النظام باختصار
منصة ويب لإدارة **التقارير المدرسية** و**التذاكر/الطلبات** و**الإشعارات** و**ملفات الإنجاز** داخل بيئة متعددة المدارس (Multi‑School). تركيزها الأساسي:
- توحيد إدخال التقارير اليومية/البرامج مع مرفقات صور.
- تنظيم الطلبات الداخلية بين المعلمين والأقسام والإدارة (Ticketing) مع مرفقات وصور.
- إدارة ملفات إنجاز سنوية للمعلمين مع شواهد (صور) وتوليد PDF.
- توفير إشعارات موجّهة (مدرسة/مستخدمين) مع حالة قراءة.
- إدارة اشتراكات المدارس وباقات المنصة والمدفوعات.
- دعم دور "مشرف عام" للمنصة بصلاحيات **مقيدة (عرض + تواصل فقط)**.
- مشاركة تقرير أو ملف إنجاز عبر **رابط عام token** لفترة صلاحية قابلة للضبط.

## 2) من هم المستخدمون؟ (User Types)
النظام مبني حول مستخدم أساسي اسمه **Teacher** (حساب مستخدم) لكن يتفرع منه أدوار/صلاحيات متعددة بحسب العضويات.

### أ) المعلّم (Teacher)
حساب المعلم هو الأساس:
- يكتب التقارير الخاصة به.
- يرفع مرفقات الصور للتقرير.
- ينشئ تذاكر/طلبات ويُتابعها.
- يستقبل إشعارات النظام.
- يدير ملف إنجازه السنوي ويضيف شواهد.
- يمكنه إنشاء رابط مشاركة عام لتقرير/ملف إنجاز (اختياري).

### ب) مدير المدرسة (School Manager)
صلاحية مدرسية تُدار عبر عضوية المدرسة `SchoolMembership` بدور `manager`:
- لوحة مدير المدرسة (لوحة التحكم) لإدارة المدرسة.
- إدارة المعلمين (إضافة/تعديل/حذف + استيراد جماعي من Excel).
- إدارة الأقسام وتكليفات الأقسام.
- إدارة أنواع التقارير داخل المدرسة.
- الاطلاع على تقارير المدرسة (بحسب المدرسة النشطة) وطباعة/إدارة.
- إدارة الاشتراك/رفع إيصال الدفع (عند انتهاء الاشتراك).
- الاطلاع على السجل (Audit Logs) داخل المدرسة.

### ج) مسؤول قسم (Officer)
دور مسؤول القسم يُدار عبر `DepartmentMembership` (role_type=officer) داخل قسم معين:
- صفحة “تقارير قسمي” لعرض تقارير ضمن صلاحيات قسمه.
- الصلاحيات مرتبطة بأنواع التقارير المرتبطة بالقسم (ReportTypes المرتبطة بالـ Department).
- يتعامل مع تذاكر القسم (بحسب الإسناد/الاستلام والقيود).

### د) مشرف عرض فقط (Report Viewer)
صلاحية مدرسية عبر `SchoolMembership` بدور `report_viewer`:
- حسابات “عرض فقط” مخصصة لاستعراض محتوى المدرسة (التقارير/ملفات الإنجاز) بدون إنشاء.
- يوجد حد أقصى افتراضي: **2 مشرفين عرض نشطين لكل مدرسة**.

### هـ) مشرف عام للمنصة (Platform Admin)
حساب مميز عبر `Teacher.is_platform_admin=True` وله نطاق وصول `PlatformAdminScope`:
- يرى **دليل المدارس** مع تقييد نطاقه:
  - مدارس محددة (allowed_schools) أو
  - نطاق بنين/بنات (gender_scope) و/أو
  - مدن مسموحة (allowed_cities)
- يدخل “سياق مدرسة” (active school) ثم:
  - يعرض تقارير المدرسة
  - يعرض تذاكر المدرسة
  - يرسل إشعارًا لطاقم المدرسة
  - يضيف تعليقات خاصة (Private Comments) يراها المعلم فقط
- يوجد تقييد دفاعي على مستوى الـ middleware يمنع هذا الدور من تصفّح بقية النظام خارج صفحات “العرض والتواصل”.

### و) مدير النظام (System Admin / Superuser)
يمتلك صلاحيات إدارة المنصة بالكامل:
- لوحة “لوحة الآدمن” (Dashboard) لإدارة المنصة.
- إدارة المدارس والمديرين.
- إدارة المشرفين العامين (إضافة/تعديل/حذف + تحديد النطاق).
- إدارة باقات الاشتراك (SubscriptionPlan) وتجديد اشتراكات المدارس.
- إدارة المدفوعات والاطلاع على تفاصيل إيصالات الدفع.
- ضبط إعدادات المنصة العامة مثل **مدة صلاحية روابط المشاركة** (PlatformSettings).

## 3) المفاهيم الأساسية في البيانات (Core Concepts)
- **School**: المدرسة (الكيان/المستأجر Tenant). يحتوي خصائص مثل المرحلة/الجنس/المدينة/شعار المدرسة ولون الطباعة.
- **SchoolMembership**: يربط المستخدم بالمدرسة بدور (معلم/مدير/عرض فقط). يدعم تعدد المدارس للحساب الواحد.
- **Department** + **DepartmentMembership**: أقسام داخل المدرسة وتكليفات المعلمين داخل القسم (معلم/مسؤول).
- **ReportType**: أنواع/تصنيفات التقارير داخل المدرسة.
- **Report**: التقرير نفسه (عنوان/تاريخ/اليوم/عدد مستفيدين/وصف/تصنيف/صور).
- **Ticket** + **TicketNote** + **TicketImage**: منظومة التذاكر والملاحظات والمرفقات.
- **Notification** + **NotificationRecipient**: إشعارات + حالة القراءة لكل مستلم.
- **TeacherAchievementFile** + **AchievementSection** + **AchievementEvidenceImage**: ملف إنجاز سنوي للمعلم + محاوره + صور الشواهد.
- **SubscriptionPlan** + **SchoolSubscription** + **Payment**: الاشتراكات والباقات والمدفوعات.
- **AuditLog**: سجل عمليات على الكيانات الأساسية (إنشاء/تعديل/حذف…)
- **ShareLink**: رابط مشاركة عام (token) لتقرير/ملف إنجاز مع صلاحية وانتهاء.

## 4) مسارات العمل الرئيسية (Workflows)

### 4.1 التقارير (Reports)
- المعلم ينشئ تقريرًا من صفحة إضافة تقرير.
- يدعم تصنيف التقرير عبر `ReportType`.
- رفع حتى 4 صور مرفقة للتقرير.
- الطباعة عبر صفحة Print مع دعم شعار المدرسة ولون طباعة مخصص (إن تم ضبطه).

عمليات داعمة:
- ضغط/تحسين صور التقارير في الخلفية عبر Celery (مع fallback آمن عند عدم توفر broker).

### 4.2 “تقارير قسمي” لمسؤول القسم
- مسؤول القسم يفتح صفحة “تقارير قسمي”.
- يرى تقارير ضمن التصنيفات المرتبطة بالقسم داخل المدرسة النشطة.
- يمكنه فتح التفاصيل داخل Modal + طباعة التقرير.

### 4.3 التذاكر/الطلبات (Tickets)
- المعلم ينشئ طلب/تذكرة مع عنوان وتفاصيل ومرفق (PDF/صور/DOCX حتى 5MB).
- التذكرة يمكن أن تكون:
  - **داخل المدرسة** (موجهة لمدير المدرسة أو مسؤول قسم)
  - **دعم فني للمنصة** (is_platform=True) تصل لإدارة المنصة (superusers)
- التذاكر تدعم:
  - مستلم رئيسي (assignee)
  - مستلمين متعددين (recipients) عبر TicketRecipient
  - ملاحظات (TicketNote) مع خيار إظهار/إخفاء للمرسل (is_public)
  - صور إضافية للتذكرة (TicketImage) مع معالجة خلفية للصور
- عند إنشاء تذكرة جديدة يتم إنشاء إشعار تلقائي للمستهدفين المناسبين.

### 4.4 الإشعارات (Notifications)
- إنشاء إشعار بعنوان ورسالة مع خيار “مهم”.
- يمكن تخصيصه بمدرسة معينة أو تركه عامًا.
- لكل مستلم يوجد سجل `NotificationRecipient` لتتبع القراءة.
- إرسال المستلمين يتم في الخلفية (bulk_create) لتخفيف الحمل.

### 4.5 ملف الإنجاز (Achievement File)
- لكل معلم ملف إنجاز سنوي لكل مدرسة وسنة (هجري) بصيغة `1447-1448`.
- يحتوي محاور ثابتة (11 محورًا) مع ملاحظات المعلم + صور شواهد لكل محور.
- يدعم حالات سير العمل: مسودة → مُرسل → مُعاد → معتمد.
- توليد PDF يعتمد WeasyPrint (مدعوم في Dockerfile) ويمكن تخزينه كملف.

### 4.6 التبديل بين المدارس (Multi‑School Switching)
- إذا كان للمستخدم أكثر من مدرسة، يظهر زر “تبديل المدرسة” في الواجهة (Header/Drawer).
- يعتمد على `active_school_id` داخل session لتحديد المدرسة النشطة.
- كثير من صفحات الإدارة/الصلاحيات تُفلتر بالمدرسة النشطة لضمان العزل.

### 4.7 روابط مشاركة عامة بدون حساب (Public Share Links)
- المعلم يمكنه إنشاء/تفعيل رابط مشاركة عام لتقرير أو ملف إنجاز.
- الرابط يعتمد token عشوائي (`ShareLink.token`) ويملك:
  - `is_active`
  - `expires_at`
  - `last_accessed_at`
- مدة الصلاحية الافتراضية تُقرأ من إعدادات المنصة:
  - أولاً من `PlatformSettings.share_link_default_days`
  - ثم fallback من env: `SHARE_LINK_DEFAULT_DAYS` (افتراضي 7 أيام)
- الوصول العام يمر عبر صفحات public endpoints:
  - `share/<token>/`
  - و endpoints لحماية تحميل صور التقرير/ملف الإنجاز عبر token.

### 4.8 الاشتراكات والمدفوعات (Subscriptions & Payments)
- باقات اشتراك `SubscriptionPlan`: اسم/سعر/مدة أيام/حد المعلمين.
- لكل مدرسة اشتراك واحد `SchoolSubscription` مرتبط بباقة.
- النظام يمنع إضافة معلمين فوق حد الباقة (لا يشمل مدير المدرسة).
- عند انتهاء الاشتراك: يمنع معظم صفحات المدرسة ويُسمح فقط لمسارات التجديد/رفع الإيصال.
- المدفوعات `Payment`: مبلغ + صورة إيصال + حالة (قيد المراجعة/مقبول/مرفوض).

### 4.9 سجل العمليات (Audit Logs)
- يتم تسجيل إنشاء/تعديل/حذف على نماذج أساسية مثل Report/Teacher/School/Department/Ticket/SchoolSubscription.
- يسجل المدرسة إن أمكن، والمستخدم، ووقت العملية وبيانات مبسطة.

## 5) نقاط قوة تسويقية (Marketing Highlights)
- “كل شيء في مكان واحد”: تقارير + طلبات + إشعارات + ملف إنجاز.
- عزل قوي متعدد المدارس: عضويات مدرسية + مدرسة نشطة + فلترة حسب المدرسة.
- إدارة مرنة للأقسام وأنواع التقارير حسب المدرسة.
- مشاركة آمنة بدون حساب: روابط مؤقتة (token + expiry + enable/disable).
- تقليل الحمل: مهام خلفية لمعالجة الصور وإرسال الإشعارات.
- قابلية تشغيل سحابية: Docker + Gunicorn + Whitenoise + دعم تخزين S3‑Compatible (Cloudflare R2).

## 6) الأمان والحوكمة (Security & Governance) — بشكل عملي
- جلسة المستخدم تُغلق تلقائيًا بعد الخمول (Idle Logout) مع تمييز طلبات الخلفية.
- سياسة اشتراك تمنع استخدام المدرسة المنتهية (SubscriptionMiddleware).
- تقييد صارم لحساب “المشرف العام” عبر Allowlist middleware (Defense‑in‑depth).
- Content Security Policy middleware (تقوية للإنتاج).

## 7) نظرة تقنية سريعة (Tech Snapshot)
- Django (إصدار ضمن نطاق 4.2.x)
- قاعدة بيانات: SQLite محليًا، و Postgres مدعوم عبر `psycopg2-binary`.
- Redis/Celery: للمهام الخلفية مع fallback عند عدم توفر broker.
- WeasyPrint: توليد PDF لملفات الإنجاز.
- openpyxl: استيراد المعلمين من Excel.
- تخزين ملفات الوسائط: محلي أو Cloudflare R2 عبر `django-storages`/`boto3`.

## 8) صفحات/وحدات النظام (للاستخدام في عروض التسويق)
> (هذه ليست قائمة كاملة لكل URL، لكنها التجمعات الرئيسية)
- التقارير: إضافة/تقاريري/طباعة/تقارير الإدارة/تقارير قسمي.
- التذاكر: إنشاء طلب/طلباتي/الوارد/المسند لي/تفاصيل تذكرة.
- الإشعارات: إنشاء/المرسلة/إشعاراتي/تفاصيل الإشعار.
- ملف الإنجاز: ملفي/ملفات المدرسة/تفاصيل/طباعة/PDF.
- إدارة المدرسة: المعلمين/الأقسام/أنواع التقارير/إعدادات المدرسة/سجل العمليات.
- إدارة المنصة: المدارس/المديرين/المشرفين العامين/الباقات/الاشتراكات/المدفوعات/التذاكر.

## 9) ملاحظات مهمة للتسويق (Policy/Behavior Notes)
- رابط المشاركة العام **اختياري** ويتطلب تفعيل المعلم (enable/disable).
- مدة صلاحية الرابط قابلة للإدارة مركزيًا من لوحة مدير النظام.
- وجود دور “مشرف عام” لا يعني صلاحيات إدارة كاملة؛ هو دور مراقبة وتواصل فقط.

---

### ملحق (للمطورين/التشغيل)
- تشغيل الإنتاج داخل Docker يقوم بـ `migrate` و `collectstatic` ثم Gunicorn.
- يوجد Service Worker في جذر الموقع (`/sw.js`) لدعم نطاق `/`.

