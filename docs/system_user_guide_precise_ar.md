# دليل المستخدم التفصيلي لنظام توثيق المدارس

## 1) نظرة عامة
هذا الدليل يشرح استخدام النظام كما هو مطبق فعليًا في المشروع، مع التركيز على الأدوار، مسارات العمل، والصلاحيات.  
النظام مبني لإدارة عمليات المدرسة اليومية عبر وحدات متكاملة: التقارير، ملفات الإنجاز، التعاميم/الإشعارات، الطلبات (التذاكر)، وإدارة الاشتراكات.

## 2) الأدوار داخل النظام

1. مدير النظام (Superuser)
- إدارة المنصة كاملة.
- إدارة المدارس، المشرفين، الباقات، الاشتراكات، المدفوعات، وسجلات التدقيق.

2. مشرف المنصة (Platform Admin)
- يعمل ضمن نطاق مدارس محدد (Scope).
- الوصول إلى مدارس النطاق، عرض تقاريرها وتذاكرها، وإرسال تعاميم/إشعارات ضمن النطاق.

3. مدير/مديرة المدرسة
- إدارة المدرسة النشطة: المعلمين، الأقسام، أنواع التقارير، تقارير المدرسة، التذاكر، والإشعارات/التعاميم.

4. المعلم/المعلمة
- إنشاء التقارير، إدارة ملف الإنجاز، استقبال التعميمات والإشعارات، إنشاء طلبات الدعم/الطلبات المدرسية.

5. عضو قسم / مسؤول قسم (Officer)
- صلاحيات مرتبطة بالقسم داخل المدرسة النشطة، خصوصًا في التقارير والطلبات.

## 3) مفاهيم أساسية يجب فهمها

1. المدرسة النشطة (Active School)
- كل العمليات تتأثر بالمدرسة المختارة في الجلسة.
- في بيئة متعددة المدارس، يجب اختيار مدرسة نشطة قبل تنفيذ معظم مهام الإدارة.

2. عزل البيانات بين المدارس
- التقارير، الإشعارات، التذاكر، والمعلمين تُعرض ضمن نطاق المدرسة النشطة وصلاحية المستخدم.

3. العضويات متعددة المدارس
- يمكن ربط نفس المستخدم بأكثر من مدرسة عبر `SchoolMembership`.
- لكل مدرسة دور مستقل للمستخدم (معلم/مدير/مشرف تقارير).

4. مسميات اللغة حسب نوع المدرسة
- إذا كانت المدرسة `بنات` تتغير المسميات تلقائيًا (مثل: مديرة المدرسة، المعلمة، رئيسة القسم).

## 4) تسجيل الدخول والتنقل الأساسي

1. تسجيل الدخول
- عبر رقم الجوال (الأساسي) أو رقم الهوية (إذا كان مرتبطًا بالحساب).

2. بعد الدخول
- يتم التوجيه حسب الدور:
  - مدير النظام إلى لوحة المنصة.
  - مدير المدرسة إلى لوحة المدير.
  - المعلم إلى الصفحة الرئيسية.

3. اختيار/تبديل المدرسة
- من شاشة اختيار المدرسة أو زر "تبديل المدرسة" في الهيدر (عند وجود أكثر من مدرسة).
- مدير المدرسة يرى في التبديل فقط المدارس التي هو مدير فيها.
- المعلم يرى المدارس التي لديه فيها عضوية نشطة.

## 5) دليل المعلم

### 5.1 الصفحة الرئيسية
- ملخص سريع للوصول إلى: تقاريري، ملف الإنجاز، الإشعارات، التعاميم، الطلبات.

### 5.2 التقارير

1. إنشاء تقرير
- المسار: `/reports/add/`
- الحقول: العنوان، التاريخ، اليوم، عدد المستفيدين، الفكرة، نوع التقرير، حتى 4 صور.
- النظام يضغط الصور ويتحقق من الحجم.

2. تقاريري
- المسار: `/reports/my/`
- عرض التقارير الخاصة بالمعلم ضمن المدرسة النشطة.

3. تعديل/حذف التقرير
- المسارات:
  - تعديل: `/reports/<id>/edit/`
  - حذف: `/reports/<id>/delete/`

4. الطباعة والمشاركة
- طباعة: `/reports/<id>/print/`
- مشاركة عبر رابط آمن: `/reports/<id>/share/`

### 5.3 ملف الإنجاز

1. ملفي
- المسار: `/achievement/my/`
- إنشاء ملف إنجاز حسب السنة الدراسية المتاحة للمدرسة.

2. إدارة الملف
- عرض التفاصيل: `/achievement/<id>/`
- تعديل السنة: `/achievement/<id>/update-year/`
- حذف: `/achievement/<id>/delete/`

3. إخراج ومشاركة
- PDF: `/achievement/<id>/pdf/`
- طباعة: `/achievement/<id>/print/`
- مشاركة: `/achievement/<id>/share/`

### 5.4 الإشعارات والتعاميم

1. إشعاراتي
- `/notifications/mine/`

2. تعاميمي الواردة
- `/circulars/mine/`

3. التوقيع على التعميم
- `/circulars/mine/<id>/sign/`
- يتطلب إقرار + التحقق من الجوال المسجل عند تفعيل التوقيع الإلزامي.

### 5.5 الطلبات (Tickets)

1. إنشاء طلب
- `/requests/new/`

2. طلباتي
- `/requests/mine/`

3. تفاصيل الطلب
- `/requests/<id>/`
- يمكن تتبع الحالة والملاحظات حسب الصلاحية.

### 5.6 الحساب الشخصي
- `/profile/` لتحديث بيانات الحساب المسموح بها.

## 6) دليل مدير المدرسة

### 6.1 لوحة المدير
- `/admin-dashboard/`
- إحصاءات: التقارير، المعلمون، التذاكر، مؤشرات تشغيلية.

### 6.2 تقارير المدرسة
- `/reports/admin/`
- عرض كل تقارير المدرسة النشطة مع فلاتر (تاريخ، معلم، نوع).

### 6.3 إدارة المعلمين

1. القائمة
- `/staff/teachers/`

2. إضافة معلم
- `/staff/teachers/add/`
- إذا كان رقم الجوال موجودًا مسبقًا: يتم ربط نفس الحساب بالمدرسة الحالية بدل إنشاء حساب جديد.

3. استيراد جماعي
- `/staff/teachers/import/`

4. تعديل/إزالة من المدرسة
- تعديل: `/staff/teachers/<id>/edit/`
- إزالة: `/staff/teachers/<id>/delete/`
- في تعدد المدارس: الحذف من شاشة المدير يزيل العضوية من المدرسة الحالية فقط (لا يحذف المستخدم عالميًا).

### 6.4 إدارة الأقسام

1. الأقسام
- `/staff/departments/`

2. إضافة/تعديل/حذف
- إضافة: `/staff/departments/add/`
- تعديل: `/staff/departments/<code>/edit/`
- حذف: `/staff/departments/<code>/delete/`

3. أعضاء القسم
- `/staff/departments/<code>/members/`

### 6.5 أنواع التقارير
- `/staff/report-types/`
- إضافة وتخصيص الأنواع حسب المدرسة النشطة.

### 6.6 التعاميم والإشعارات

1. إنشاء إشعار
- `/notifications/create/`

2. إنشاء تعميم
- `/circulars/create/`
- التعاميم في النظام مرتبطة بالتوقيع الإلزامي وتتبع القراءة/التوقيع.

3. المرسلة
- إشعارات مرسلة: `/notifications/sent/`
- تعاميم مرسلة: `/circulars/sent/`

4. تقارير التوقيع
- طباعة: `/notifications/<id>/signatures/print/`
- CSV: `/notifications/<id>/signatures.csv`

### 6.7 الطلبات المدرسية

1. طلبات المدرسة
- `/requests/school/`

2. صندوق الوارد/المسند
- `/requests/inbox/`
- `/requests/assigned/`

3. تفاصيل الطلب والطباعة
- `/requests/<id>/`
- `/requests/<id>/print/`

### 6.8 إعدادات المدرسة
- `/staff/my-school/`
- الحقول المحمية من التعديل (حسب الإعداد الحالي):
  - اسم المدرسة
  - المرحلة
  - بنين/بنات
  - المدينة

### 6.9 الاشتراك والمدفوعات

1. حالة اشتراك المدرسة
- `/subscription/my/`

2. سجل المدفوعات
- `/subscription/history/`

3. رفع إيصال دفع
- `/subscription/payment/create/`

## 7) دليل مشرف المنصة ومدير النظام

### 7.1 مشرف المنصة (ضمن النطاق)

1. دليل المدارس
- `/platform/schools/`

2. دخول مدرسة ضمن النطاق
- `/platform/schools/<id>/enter/`

3. لوحة المدرسة ضمن المنصة
- `/platform/school/`

4. تقارير/تذاكر المدرسة
- `/platform/school/reports/`
- `/platform/school/tickets/`

5. إرسال إشعار/تعميم ضمن النطاق
- `/platform/school/notify/`

### 7.2 مدير النظام

1. لوحة المنصة
- `/platform-dashboard/`

2. إدارة المشرفين
- `/platform/admins/`

3. إدارة المدارس ومدراء المدارس
- `/staff/schools/`
- `/staff/schools/managers/`

4. إدارة الباقات والاشتراكات والمدفوعات
- الباقات: `/platform/plans/`
- الاشتراكات: `/platform/subscriptions/`
- المدفوعات: `/platform/payments/`

5. سجل عمليات التدقيق
- `/platform/audit-logs/`

## 8) آلية التعاميم والتوقيع (مختصر تشغيلي)

1. المُرسل ينشئ تعميمًا مع تفعيل التوقيع.
2. يصل التعميم للمستلمين حسب المدرسة/النطاق.
3. المستلم يفتح التعميم ويوقّع بعد الإقرار.
4. المدير يستخرج تقارير من وقّع/لم يوقّع من شاشة التوقيعات.

## 9) قيود ونقاط مهمة في النسخة الحالية

1. الإشعارات الفورية تعمل داخل التطبيق المفتوح (WebSocket + تحديث العدادات).
2. لا يوجد حاليًا Web Push كامل لإظهار تنبيه نظامي عند إغلاق التطبيق.
3. الاشتراك الفعّال شرط أساسي لبعض عمليات المدارس (مثل إضافة عضويات معلمين).
4. يوجد حد أقصى لعدد المعلمين حسب الباقة (`max_teachers`).

## 10) رسائل الخطأ الشائعة ومعناها

1. `active_school_required`
- يجب اختيار مدرسة نشطة أولاً.

2. `Forbidden (CSRF token from POST incorrect.)`
- غالبًا جلسة قديمة/تعارض CSRF؛ يلزم تحديث الصفحة وإعادة المحاولة.

3. "ليست لديك صلاحية على هذه المدرسة"
- المدرسة النشطة خارج نطاق العضوية/الصلاحية الحالية.

## 11) أفضل ممارسات الاستخدام

1. قبل أي عملية إدارية تأكد من المدرسة النشطة الصحيحة.
2. عند إضافة معلم موجود مسبقًا استخدم نفس رقم الجوال لربط الحساب بدل إنشاء نسخة جديدة.
3. للتعاميم الحساسة استخدم التوقيع الإلزامي + موعد نهائي.
4. راجع سجل التوقيع دوريًا لضمان الامتثال.

## 12) مرفقات مفيدة داخل النظام

1. دليل الاستخدام داخل المنصة: `/guide/`
2. تحميل الدليل: `/guide/download/`
3. الأسئلة الشائعة: `/faq/`
4. سياسة الخصوصية: `/privacy/`
