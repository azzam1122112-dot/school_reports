# تقرير شرح النظام (منصة التقارير والتذاكر المدرسية)

> هذا التقرير مُعدّ للاستخدام في الشرح/العرض (Presentation/Onboarding) ويعكس البنية الحالية للمشروع: Django + وحدات التقارير/التذاكر/التعاميم/ملف الإنجاز + الاشتراكات.

---

## 1) الملخص التنفيذي
المنصة هي نظام ويب متعدد المدارس (Multi‑School) يهدف إلى تنظيم العمل اليومي داخل المدرسة عبر:
- **التقارير المدرسية**: إنشاء تقارير يومية/برامج/مبادرات مع صور وطباعة رسمية.
- **التذاكر/الطلبات**: طلبات داخلية منظمة مع مرفقات ومتابعة حالات.
- **الإشعارات والتعاميم**: رسائل موجّهة للطاقم مع تتبع القراءة، ودعم **تعميم يتطلب توقيع**.
- **ملفات الإنجاز**: ملف إنجاز سنوي للمعلم بمحاور وشواهد وإخراج PDF.
- **الاشتراكات والمدفوعات**: باقات، حد معلمين، منع استخدام المدرسة عند انتهاء الاشتراك، ورفع إيصال الدفع.

---

## 2) أصحاب المصلحة (Stakeholders)
- **مدير/قائد المدرسة**: إدارة المدرسة، المعلمين، الأقسام، أنواع التقارير، متابعة التقارير والطلبات، إرسال تعاميم.
- **المعلم**: رفع تقارير، متابعة طلبات، الاطلاع على التعاميم والتوقيع عليها، إدارة ملف الإنجاز.
- **مسؤول قسم**: متابعة الوارد/المهام ضمن قسمه (حسب تكليف المدرسة).
- **مشرف تقارير (عرض فقط)**: حسابات عرض مخصصة للمتابعة بدون إنشاء.
- **مشرف منصة/دعم**: إدارة مدارس متعددة ضمن نطاق محدد، إدارة الاشتراكات والمدفوعات، دعم فني.

---

## 3) المكونات الرئيسية للنظام (Modules)
### 3.1 تطبيقات Django
- `core`: Middleware مبكر لحماية مسارات غير مرغوبة (BlockBadPaths)، وإطار عام.
- `reports`: قلب النظام (نماذج، صلاحيات، Middleware، Views، Templates، Tasks).

### 3.2 الخدمات والمهام الخلفية
- Celery + `django-celery-results` للمهام الخلفية (مثل معالجة الصور وإجراءات bulk).
- نمط حماية: يوجد تشغيل آمن للمهام (fallback) عند عدم توفر broker في بيئات معينة.

### 3.3 PDF
- WeasyPrint لتوليد PDF (خصوصًا لملف الإنجاز).

### 3.4 التخزين والملفات
- Static عبر WhiteNoise.
- Media: محلي أو S3‑Compatible (Cloudflare R2) عبر `django-storages`.

---

## 4) نموذج الصلاحيات والأدوار (Roles & Permissions)
> النظام يعتمد على حساب مستخدم أساسي (Teacher)، ويُدار الوصول عبر عضويات مدرسية وأقسام.

### 4.1 عضوية المدرسة `SchoolMembership`
- أدوار رئيسية داخل المدرسة:
  - `teacher` (معلم)
  - `manager` (مدير مدرسة)
  - `report_viewer` (عرض فقط)
- قيود تشغيلية مهمة:
  - مدير المدرسة: **حد مدير نشط واحد** لكل مدرسة.
  - مشرف تقارير (عرض فقط): **حد أقصى 2 نشطين** لكل مدرسة.
  - حد المعلمين مرتبط بباقة الاشتراك (ولا يشمل مدير المدرسة).

### 4.2 الأقسام وتكليفات الأقسام
- `Department`: قسم داخل مدرسة (slug مخصص لكل مدرسة).
- `DepartmentMembership`: تكليف المعلمين داخل القسم، مع نوع تكليف (Teacher/Officer).

### 4.3 مشرف المنصة (Platform Admin)
- حساب مميز بصلاحيات مراقبة/تواصل ضمن **نطاق محدد** (مدارس/مدن/بنين‑بنات).
- يوجد تقييد إضافي على مستوى Middleware لمنع الوصول لصفحات غير مسموحة (Defense‑in‑depth).

---

## 5) نموذج البيانات (Data Model Overview)
### 5.1 المدرسة والهوية
- `School`: بيانات المدرسة (المرحلة، الجنس، المدينة، الشعار، ألوان الطباعة…)
- `SchoolMembership`: ربط المستخدم بالمدرسة ودوره.

### 5.2 التقارير
- `ReportType`: نوع/تصنيف تقرير (مخصص لمدرسة أو عام).
- `Report`: تقرير عام يحتوي العنوان والتاريخ والتصنيف والوصف ومرفقات الصور.

### 5.3 التذاكر/الطلبات
- `Ticket`: تذكرة موحدة (داخل المدرسة أو دعم منصة `is_platform`).
- `TicketRecipient`: مستلمون متعددون.
- `TicketNote`: ملاحظات داخل التذكرة.
- `TicketImage`: صور إضافية للتذكرة.

### 5.4 الإشعارات والتعاميم
- `Notification`: إشعار نصي مع مرفق اختياري.
- `NotificationRecipient`: مستلمون مع تتبع:
  - القراءة `is_read/read_at`
  - التوقيع على التعميم `is_signed/signed_at` عند تفعيل `requires_signature`.

### 5.5 ملف الإنجاز
- `TeacherAchievementFile`: ملف سنوي للمعلم داخل مدرسة وسنة دراسية (هجري)، مع حالات (مسودة/مُرسل/مُعاد/معتمد).
- توجد نماذج مساعدة للمحاور والشواهد (حسب بنية المشروع الحالية).

### 5.6 الاشتراك والمدفوعات
- `SubscriptionPlan`: اسم/سعر/مدة/حد معلمين.
- `SchoolSubscription`: اشتراك المدرسة وحالته وانتهاؤه.
- `Payment`: عملية دفع مع صورة إيصال وحالات الموافقة.

### 5.7 مشاركة عامة (اختياري)
- `ShareLink`: روابط مشاركة عامة (token + expiry) لتقرير أو ملف إنجاز.

---

## 6) مسارات العمل الأساسية (Key Workflows)
### 6.1 التقارير
1) المعلم ينشئ تقريرًا ويختار نوع التقرير (ReportType) إن كان مفعّلًا.
2) يرفع صورًا (حتى 4 صور وفق نموذج التقرير).
3) يمكن للمدرسة طباعة التقرير بتنسيق رسمي (A4) مع شعار المدرسة.
4) الخلفية: عند وجود صور، تُجدول مهمة لمعالجة/تحسين الصور.

### 6.2 الطلبات/التذاكر
1) المعلم ينشئ تذكرة بعنوان وتفاصيل ومرفق (PDF/صور/DOCX بحد حجم).
2) تُسند لمدير المدرسة أو مسؤول قسم، أو تُرسل كدعم منصة.
3) تتم متابعة الحالة (جديد/قيد المعالجة/مكتمل/مرفوض) مع ملاحظات وصور.

### 6.3 الإشعارات والتعاميم (مع/بدون توقيع)
- إشعار عادي: إرسال + تتبع قراءة.
- تعميم بتوقيع:
  1) تفعيل `requires_signature` + نص إقرار + موعد نهائي اختياري.
  2) كل مستلم لديه حالة توقيع وتوقيت المحاولة.
  3) الهدف: ضمان الاستلام والفهم والالتزام عبر سجل توقيع واضح.

### 6.4 ملف الإنجاز
1) المعلم يحدّث محاور الملف ويرفع شواهد.
2) يرسل للاعتماد.
3) الإدارة تعتمد/تعيد للمراجعة.
4) يمكن إخراج PDF عند الحاجة.

### 6.5 الاشتراك والمدفوعات
- الاشتراك مرتبط بباقة، ويتحكم في حد المعلمين وفترة الاستخدام.
- عند انتهاء الاشتراك (أو إيقافه): يتم تقييد الوصول لمعظم صفحات المدرسة مع السماح بمسارات التجديد.

---

## 7) الأمان والحوكمة (Security & Governance)
- **جلسة واحدة لكل مستخدم**: منع تعدد الجلسات (Single Session Enforcement).
- **تسجيل خروج بعد الخمول**: Idle Logout مع تمييز الطلبات التفاعلية عن طلبات الخلفية.
- **تقييد المدارس المنتهية**: Subscription Middleware يعيد توجيه/403 JSON حسب نوع الطلب.
- **تقييد مشرف المنصة**: Allowlist على مستوى Middleware للصفحات المسموح بها فقط.
- **CSP**: تعزيز أمان المحتوى في الإنتاج.
- **روابط مشاركة عامة**: token عشوائي + صلاحية وانتهاء + تعطيل/تفعيل.

---

## 8) التشغيل والنشر (Ops & Deployment)
### 8.1 الإعدادات (Environment)
- `ENV`, `DEBUG`, `SECRET_KEY`
- `ALLOWED_HOSTS`, `CSRF_TRUSTED_ORIGINS`
- قاعدة البيانات عبر `DATABASE_URL` (إن توفر) أو إعدادات محلية.
- Celery broker عبر `REDIS_URL`/`CELERY_BROKER_URL`.
- تخزين R2 عبر متغيرات `R2_*`.

### 8.2 البنية
- `Dockerfile` وتهيئة إنتاج (Gunicorn + collectstatic + migrate).
- Render/Procfile موجودان لدعم نشر سحابي.

---

## 9) سيناريو تشغيل مدرسة جديدة (Onboarding مختصر)
1) إنشاء المدرسة وربط مدير المدرسة.
2) تفعيل اشتراك المدرسة/باقة مناسبة.
3) إعداد الأقسام وأنواع التقارير وربطها.
4) إضافة المعلمين (يدويًا أو Excel).
5) تجربة أسبوع أول: تقرير + طباعة + تذكرة + تعميم.

---

## 10) نقاط جاهزة للاستخدام في العرض
- المنصة توحّد التقارير والطلبات والتعاميم وملف الإنجاز.
- كل شيء موثق (من/متى/حالة/مرفقات/توقيع).
- صلاحيات دقيقة حسب المدرسة والقسم.
- جاهزية للطباعة الرسمية وPDF.
- دعم اشتراكات وحد معلمين وسياسة منع عند الانتهاء.

