{# templates/reports/report_edit.html (Ø£Ùˆ Ø§Ø³Ù… Ù…Ù„ÙÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠ) #}
{% extends "base.html" %}
{% load static %}
{% block title %}âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± #{{ report.id }}{% endblock %}

{% block head %}
<style>
  /* =========================================================
     Report Edit (page-only polish)
     - Scoped Ø¯Ø§Ø®Ù„ .er-scope
     - Ø¨Ø¯ÙˆÙ† Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹Ø±ÙŠÙ .btn / .card Ø§Ù„Ø¹Ø§Ù…Ø©
     - Ù…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ data-theme ÙÙŠ base.html
     ========================================================= */
  .er-scope{
    --er-radius: 18px;
    --er-rsm: 12px;
    --er-shadow: 0 16px 46px rgba(2,6,23,.10);
    --er-shadow2: 0 18px 54px rgba(2,6,23,.16);
    --er-t: var(--t-fast);

    /* Fall back Ù„Ùˆ Ù„Ù… ØªØªÙˆÙØ± Ù…ØªØºÙŠØ±Ø§Øª base */
    --er-ink: var(--ink, #0f172a);
    --er-ink2: var(--ink-2, #1f2937);
    --er-muted: var(--muted, #64748b);
    --er-line: var(--line, #e5e7eb);
    --er-card: var(--card, #ffffff);
    --er-line2: var(--line-2, #f1f5f9);
    --er-brand: var(--brand, #2563eb);
    --er-danger: #ef4444;
    --er-danger2: #dc2626;
    --er-good: #10b981;
  }

  .er-scope .wrap{
    max-width: 980px;
    margin: 0 auto;
    padding: 20px 14px;
  }

  .er-scope .er-card{
    border-radius: var(--er-radius);
    box-shadow: var(--er-shadow);
    overflow: hidden;
  }

  .er-scope .er-hd{
    padding: 18px 20px;
    border-bottom: 1px solid var(--er-line);
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:12px;
    flex-wrap:wrap;
    background: linear-gradient(180deg, var(--er-line2), var(--er-card));
  }

  .er-scope .er-title{
    margin: 0;
    font-weight: 950;
    color: var(--er-ink2);
    font-size: 1.08rem;
    letter-spacing: -.2px;
  }

  .er-scope .er-sub{
    margin: 6px 0 0;
    color: var(--er-muted);
    font-weight: 850;
    font-size: .95rem;
    line-height: 1.6;
  }

  .er-scope .er-body{ padding: 20px; }

  .er-scope .grid{ display:grid; gap: 18px; }
  .er-scope .row{ display:flex; flex-direction:column; gap: 8px; }

  .er-scope label{
    font-weight: 950;
    color: var(--er-ink2);
  }

  .er-scope .help{
    font-size: .88rem;
    color: var(--er-muted);
    font-weight: 800;
    margin-top: 2px;
  }

  /* Inputs styling (Ù†Ø¶ÙŠÙ class control Ø¹Ø¨Ø± JS) */
  .er-scope .control{
    width:100%;
    padding: 12px 14px;
    border: 1px solid var(--er-line);
    border-radius: var(--er-rsm);
    background: var(--er-card);
    color: var(--er-ink2);
    font-size: 1rem;
    transition: border var(--er-t), box-shadow var(--er-t), background var(--er-t);
  }
  .er-scope textarea.control{ min-height: 120px; resize: vertical; }
  .er-scope .control:focus{
    outline:none;
    border-color: rgba(37,99,235,.55);
    box-shadow: 0 0 0 3px rgba(37,99,235,.18);
  }

  /* Messages */
  .er-scope .msg{
    border: 1px solid var(--er-line);
    padding: 10px 12px;
    border-radius: 12px;
    font-weight: 900;
    background: linear-gradient(180deg, var(--er-line2), var(--er-card));
    color: var(--er-ink2);
  }
  .er-scope .msg.err{
    border-color: rgba(239,68,68,.30);
    background: rgba(239,68,68,.08);
    color: var(--er-danger2);
  }

  /* Images */
  .er-scope .images{
    display:grid;
    gap: 14px;
  }
  @media(min-width:720px){
    .er-scope .images{ grid-template-columns: repeat(4, 1fr); }
  }

  .er-scope .img-card{
    border: 1px dashed rgba(148,163,184,.55);
    border-radius: 14px;
    background: linear-gradient(180deg, var(--er-line2), var(--er-card));
    padding: 12px;
    display:flex;
    flex-direction:column;
    gap: 10px;
    transition: transform var(--er-t), box-shadow var(--er-t), border-color var(--er-t);
  }
  .er-scope .img-card:hover{
    transform: translateY(-2px);
    box-shadow: var(--er-shadow2);
    border-color: rgba(37,99,235,.35);
  }

  .er-scope .thumb{
    width:100%;
    height: 130px;
    border-radius: 12px;
    object-fit: cover;
    display:block;
    border: 1px solid var(--er-line);
    background: var(--er-line2);
    cursor: zoom-in;
  }
  .er-scope .thumb--empty{
    height: 130px;
    border-radius: 12px;
    border: 1px solid var(--er-line);
    background: var(--er-card);
    display:grid;
    place-items:center;
    color: var(--er-muted);
    font-weight: 950;
    font-size: .9rem;
  }

  .er-scope .img-meta{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 8px;
  }
  .er-scope .img-meta small{
    color: var(--er-muted);
    font-weight: 900;
  }
  .er-scope .img-meta .links{
    display:flex;
    gap:10px;
    align-items:center;
  }
  .er-scope .img-meta a{
    font-size: .86rem;
    color: var(--er-brand);
    text-decoration:none;
    font-weight: 950;
  }
  .er-scope .img-meta a:hover{ text-decoration: underline; }

  .er-scope .img-actions{
    display:flex;
    gap: 8px;
    align-items:center;
    justify-content:space-between;
    flex-wrap:wrap;
  }

  .er-scope .btn-file{
    position: relative;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap: 8px;
    padding: 9px 12px;
    border-radius: 10px;
    border: 1px solid rgba(37,99,235,.25);
    background: rgba(37,99,235,.08);
    color: #1e3a8a;
    font-weight: 950;
    cursor: pointer;
    min-height: 40px;
  }
  html[data-theme="dark"] .er-scope .btn-file{
    background: rgba(37,99,235,.16);
    color: #dbeafe;
    border-color: rgba(37,99,235,.30);
  }
  .er-scope .btn-file input[type="file"]{
    position:absolute;
    inset:0;
    opacity:0;
    cursor:pointer;
  }

  .er-scope .clearbox{
    display:flex;
    align-items:center;
    gap: 6px;
  }
  .er-scope .clearbox input{ width: 18px; height: 18px; }
  .er-scope .clearbox span{ font-size: .9rem; color: var(--er-danger2); font-weight: 950; }

  .er-scope .note{
    font-size: .88rem;
    color: var(--er-muted);
    font-weight: 850;
    background: linear-gradient(180deg, var(--er-card), var(--er-line2));
    border: 1px solid var(--er-line);
    border-radius: 12px;
    padding: 10px 12px;
  }

  /* Actions (Ù†Ø³ØªØ®Ø¯Ù… Ø£Ø²Ø±Ø§Ø± base .btn) */
  .er-scope .actions{
    display:grid;
    grid-template-columns: 1fr;
    gap: 12px;
    margin-top: 8px;
  }
  @media(min-width:560px){
    .er-scope .actions{ grid-template-columns: 1fr 1fr; }
  }

  /* Submit loading - Enhanced */
  .er-scope .is-submitting{
    opacity: .75;
    pointer-events: none;
    filter: saturate(.9);
  }
  
  /* Upload Overlay - Enhanced Design */
  .er-upload-overlay {
    position: fixed; 
    inset: 0; 
    background: rgba(15, 23, 42, 0.85); 
    backdrop-filter: blur(8px);
    z-index: 9999; 
    display: none; 
    align-items: center; 
    justify-content: center;
    animation: fadeIn 0.3s ease;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  
  .er-upload-modal {
    background: var(--er-card); 
    padding: 40px 32px;
    border-radius: 24px;
    width: 90%; 
    max-width: 420px; 
    text-align: center;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
  }
  
  @keyframes slideUp {
    from { 
      opacity: 0; 
      transform: translateY(20px) scale(0.95); 
    }
    to { 
      opacity: 1; 
      transform: translateY(0) scale(1); 
    }
  }
  
  .er-upload-modal-icon {
    font-size: 3rem; 
    color: var(--er-brand); 
    margin-bottom: 16px;
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }
  
  @keyframes pulse {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.05); opacity: 0.8; }
  }
  
  .er-upload-modal h3 {
    margin: 0 0 8px;
    font-size: 1.5rem;
    font-weight: 900;
    color: var(--er-ink);
  }
  
  .er-upload-modal p {
    margin: 0 0 24px;
    color: var(--er-muted);
    font-size: 0.95rem;
    font-weight: 600;
  }
  
  .er-progress-container {
    position: relative;
    height: 8px; 
    background: var(--er-line); 
    border-radius: 12px; 
    overflow: hidden;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.06);
  }
  
  .er-progress-fill {
    height: 100%; 
    width: 0; 
    background: linear-gradient(90deg, var(--er-brand), #1e40af);
    border-radius: 12px;
    transition: width 0.3s ease;
    position: relative;
    overflow: hidden;
  }
  
  .er-progress-fill::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    bottom: 0;
    right: 0;
    background: linear-gradient(
      90deg, 
      transparent 0%, 
      rgba(255,255,255,0.3) 50%, 
      transparent 100%
    );
    animation: shimmer 2s infinite;
  }
  
  @keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
  }
  
  .er-progress-labels {
    display: flex; 
    justify-content: space-between; 
    font-size: 0.85rem; 
    font-weight: 800; 
    margin-top: 12px;
  }
  
  .er-progress-label {
    color: var(--er-muted);
  }
  
  .er-progress-pct {
    color: var(--er-brand);
    font-size: 0.95rem;
  }
  
  @media (max-width: 480px) {
    .er-upload-modal {
      padding: 32px 24px;
      max-width: 340px;
    }
    .er-upload-modal-icon {
      font-size: 2.5rem;
    }
    .er-upload-modal h3 {
      font-size: 1.25rem;
    }
  }

  /* Preview modal */
  .er-scope .pm-overlay{
    position: fixed;
    inset: 0;
    background: rgba(2,6,23,.65);
    z-index: 12600;
    display: none;
    place-items: center;
    padding: 14px;
  }
  .er-scope .pm-overlay.is-open{ display: grid; }
  .er-scope .pm{
    width: min(980px, 96vw);
    max-height: 92vh;
    background: var(--er-card);
    border: 1px solid var(--er-line);
    border-radius: 18px;
    box-shadow: 0 40px 90px rgba(2,6,23,.30);
    overflow: hidden;
    display:flex;
    flex-direction:column;
  }
  .er-scope .pm-hd{
    padding: 12px 14px;
    border-bottom: 1px solid var(--er-line);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 10px;
    background: linear-gradient(180deg, var(--er-line2), var(--er-card));
  }
  .er-scope .pm-hd .ttl{
    margin: 0;
    font-weight: 950;
    color: var(--er-ink2);
    display:flex;
    gap: 8px;
    align-items:center;
  }
  .er-scope .pm-close{
    width: 44px;
    height: 44px;
    border-radius: 999px;
    border: 1px solid var(--er-line);
    background: var(--er-card);
    cursor: pointer;
    font-weight: 950;
    color: var(--er-ink2);
  }
  .er-scope .pm-bd{
    padding: 12px;
    overflow:auto;
  }
  .er-scope .pm-img{
    width: 100%;
    height: auto;
    display:block;
    border-radius: 14px;
    border: 1px solid var(--er-line);
    background: var(--er-line2);
  }
</style>
{% endblock %}

{% block content %}
<div class="er-scope">
  <div class="wrap" dir="rtl">
    <div class="card er-card">
      <div class="er-hd">
        <div>
          <h2 class="er-title">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± #{{ report.id }}</h2>
          <p class="er-sub">Ø­Ø¯Ù‘Ø« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙ‚Ø±ÙŠØ±ØŒ ÙˆØ§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„ØµÙˆØ± Ø£Ùˆ Ø§Ø­Ø°ÙÙ‡Ø§ Ø¥Ù† Ù„Ø²Ù….</p>
        </div>

        {# Ø§Ø®ØªÙŠØ§Ø±ÙŠ: Ø±Ø§Ø¨Ø· Ø³Ø±ÙŠØ¹ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© Ø¥Ù† ÙƒØ§Ù† Ù…Ù†Ø§Ø³Ø¨Ù‹Ø§ Ø¹Ù†Ø¯Ùƒ #}
        {# <a class="btn btn-ghost" href="{% url 'reports:report_print' report.id %}"><i class="fa-solid fa-print"></i> Ø·Ø¨Ø§Ø¹Ø©</a> #}
      </div>

      <div class="er-body">
        {% if messages %}
          {% for message in messages %}
            <div class="msg err" style="margin-bottom:10px">{{ message }}</div>
          {% endfor %}
        {% endif %}

        {% if form.non_field_errors %}
          <div class="msg err" style="margin-bottom:10px">
            {% for e in form.non_field_errors %}â€¢ {{ e }}<br>{% endfor %}
          </div>
        {% endif %}

        <form method="post" enctype="multipart/form-data" autocomplete="off" novalidate id="editReportForm">
          {% csrf_token %}

          <div class="grid">
            <div class="row">
              <label for="{{ form.category.id_for_label }}">Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</label>
              {{ form.category }}
              {% if form.category.errors %}
                <div class="msg err">{% for e in form.category.errors %}â€¢ {{ e }}<br>{% endfor %}</div>
              {% endif %}
            </div>

            {% if form.fields.teacher_name %}
              <div class="row">
                <label for="id_teacher_name">Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…</label>
                <input
                  class="control"
                  type="text"
                  id="id_teacher_name"
                  name="teacher_name"
                  maxlength="120"
                  value="{{ form.data.teacher_name|default:report.teacher_name|default:request.user.name }}"
                >
                <div class="help">ÙŠØ¸Ù‡Ø± Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ø¯Ø§Ø®Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©.</div>
              </div>
            {% endif %}

            <div class="row">
              <label for="{{ form.title.id_for_label }}">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† / Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</label>
              {{ form.title }}
              {% if form.title.errors %}
                <div class="msg err">{% for e in form.title.errors %}â€¢ {{ e }}<br>{% endfor %}</div>
              {% endif %}
            </div>

            <div class="row">
              <label for="{{ form.report_date.id_for_label }}">ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
              {{ form.report_date }}
              {% if form.report_date.errors %}
                <div class="msg err">{% for e in form.report_date.errors %}â€¢ {{ e }}<br>{% endfor %}</div>
              {% endif %}
            </div>

            <div class="row">
              <label for="{{ form.day_name.id_for_label }}">ğŸ“Œ Ø§Ù„ÙŠÙˆÙ…</label>
              {{ form.day_name }}
              <div class="help">ÙŠÙØ­Ø¯Ù‘ÙØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ØªØ§Ø±ÙŠØ® (ÙˆÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„Ù‡ ÙŠØ¯ÙˆÙŠÙ‹Ø§).</div>
              {% if form.day_name.errors %}
                <div class="msg err">{% for e in form.day_name.errors %}â€¢ {{ e }}<br>{% endfor %}</div>
              {% endif %}
            </div>

            <div class="row">
              <label for="{{ form.beneficiaries_count.id_for_label }}">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªÙÙŠØ¯ÙŠÙ†</label>
              {{ form.beneficiaries_count }}
              {% if form.beneficiaries_count.errors %}
                <div class="msg err">{% for e in form.beneficiaries_count.errors %}â€¢ {{ e }}<br>{% endfor %}</div>
              {% endif %}
            </div>

            <div class="row">
              <label for="{{ form.idea.id_for_label }}">Ø§Ù„ÙˆØµÙ / ÙÙƒØ±Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</label>
              {{ form.idea }}
              {% if form.idea.errors %}
                <div class="msg err">{% for e in form.idea.errors %}â€¢ {{ e }}<br>{% endfor %}</div>
              {% endif %}
            </div>

            <div class="row">
              <label>Ø§Ù„ØµÙˆØ±</label>

              <div class="images">
                {# ========= Slot 1 ========= #}
                <div class="img-card" data-slot="1">
                  {% if report.image1 %}
                    <img class="thumb" id="thumb-1" src="{{ report.image1.url }}" alt="image1" data-full="{{ report.image1.url }}">
                    <div class="img-meta">
                      <small>Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</small>
                      <div class="links">
                        <a href="#" class="er-preview" data-src="{{ report.image1.url }}">Ù…Ø¹Ø§ÙŠÙ†Ø©</a>
                        <a href="{{ report.image1.url }}" target="_blank" rel="noopener">ÙØªØ­</a>
                      </div>
                    </div>
                  {% else %}
                    <div class="thumb--empty" id="thumb-1">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø©</div>
                    <div class="img-meta"><small>â€”</small><span></span></div>
                  {% endif %}

                  <div class="img-actions">
                    <label class="btn-file">
                      ğŸ“· Ø§Ø®ØªØ± Ù…Ù„ÙÙ‹Ø§
                      <input type="file" id="id_image1" name="image1" accept="image/*">
                    </label>
                    <label class="clearbox">
                      <input type="checkbox" id="id_image1_clear" name="image1-clear">
                      <span>Ø¥Ø²Ø§Ù„Ø©</span>
                    </label>
                  </div>

                  {% if form.image1.errors %}
                    <div class="msg err">{% for e in form.image1.errors %}â€¢ {{ e }}<br>{% endfor %}</div>
                  {% endif %}
                </div>

                {# ========= Slot 2 ========= #}
                <div class="img-card" data-slot="2">
                  {% if report.image2 %}
                    <img class="thumb" id="thumb-2" src="{{ report.image2.url }}" alt="image2" data-full="{{ report.image2.url }}">
                    <div class="img-meta">
                      <small>Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</small>
                      <div class="links">
                        <a href="#" class="er-preview" data-src="{{ report.image2.url }}">Ù…Ø¹Ø§ÙŠÙ†Ø©</a>
                        <a href="{{ report.image2.url }}" target="_blank" rel="noopener">ÙØªØ­</a>
                      </div>
                    </div>
                  {% else %}
                    <div class="thumb--empty" id="thumb-2">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø©</div>
                    <div class="img-meta"><small>â€”</small><span></span></div>
                  {% endif %}

                  <div class="img-actions">
                    <label class="btn-file">
                      ğŸ“· Ø§Ø®ØªØ± Ù…Ù„ÙÙ‹Ø§
                      <input type="file" id="id_image2" name="image2" accept="image/*">
                    </label>
                    <label class="clearbox">
                      <input type="checkbox" id="id_image2_clear" name="image2-clear">
                      <span>Ø¥Ø²Ø§Ù„Ø©</span>
                    </label>
                  </div>

                  {% if form.image2.errors %}
                    <div class="msg err">{% for e in form.image2.errors %}â€¢ {{ e }}<br>{% endfor %}</div>
                  {% endif %}
                </div>

                {# ========= Slot 3 ========= #}
                <div class="img-card" data-slot="3">
                  {% if report.image3 %}
                    <img class="thumb" id="thumb-3" src="{{ report.image3.url }}" alt="image3" data-full="{{ report.image3.url }}">
                    <div class="img-meta">
                      <small>Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</small>
                      <div class="links">
                        <a href="#" class="er-preview" data-src="{{ report.image3.url }}">Ù…Ø¹Ø§ÙŠÙ†Ø©</a>
                        <a href="{{ report.image3.url }}" target="_blank" rel="noopener">ÙØªØ­</a>
                      </div>
                    </div>
                  {% else %}
                    <div class="thumb--empty" id="thumb-3">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø©</div>
                    <div class="img-meta"><small>â€”</small><span></span></div>
                  {% endif %}

                  <div class="img-actions">
                    <label class="btn-file">
                      ğŸ“· Ø§Ø®ØªØ± Ù…Ù„ÙÙ‹Ø§
                      <input type="file" id="id_image3" name="image3" accept="image/*">
                    </label>
                    <label class="clearbox">
                      <input type="checkbox" id="id_image3_clear" name="image3-clear">
                      <span>Ø¥Ø²Ø§Ù„Ø©</span>
                    </label>
                  </div>

                  {% if form.image3.errors %}
                    <div class="msg err">{% for e in form.image3.errors %}â€¢ {{ e }}<br>{% endfor %}</div>
                  {% endif %}
                </div>

                {# ========= Slot 4 ========= #}
                <div class="img-card" data-slot="4">
                  {% if report.image4 %}
                    <img class="thumb" id="thumb-4" src="{{ report.image4.url }}" alt="image4" data-full="{{ report.image4.url }}">
                    <div class="img-meta">
                      <small>Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</small>
                      <div class="links">
                        <a href="#" class="er-preview" data-src="{{ report.image4.url }}">Ù…Ø¹Ø§ÙŠÙ†Ø©</a>
                        <a href="{{ report.image4.url }}" target="_blank" rel="noopener">ÙØªØ­</a>
                      </div>
                    </div>
                  {% else %}
                    <div class="thumb--empty" id="thumb-4">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø©</div>
                    <div class="img-meta"><small>â€”</small><span></span></div>
                  {% endif %}

                  <div class="img-actions">
                    <label class="btn-file">
                      ğŸ“· Ø§Ø®ØªØ± Ù…Ù„ÙÙ‹Ø§
                      <input type="file" id="id_image4" name="image4" accept="image/*">
                    </label>
                    <label class="clearbox">
                      <input type="checkbox" id="id_image4_clear" name="image4-clear">
                      <span>Ø¥Ø²Ø§Ù„Ø©</span>
                    </label>
                  </div>

                  {% if form.image4.errors %}
                    <div class="msg err">{% for e in form.image4.errors %}â€¢ {{ e }}<br>{% endfor %}</div>
                  {% endif %}
                </div>
              </div>

              <div class="note" style="margin-top:10px">
                Ù„Ø¥Ø²Ø§Ù„Ø© ØµÙˆØ±Ø© Ø­Ø§Ù„ÙŠØ© ÙØ¹Ù‘ÙÙ„ Ù…Ø±Ø¨Ø¹ <b>Ø¥Ø²Ø§Ù„Ø©</b>Ø› Ø£Ùˆ Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§ (Ø³ÙŠØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¥Ø²Ø§Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§).
              </div>
            </div>

            {% if request.GET.next %}
              <input type="hidden" name="next" value="{{ request.GET.next }}">
            {% endif %}

            <div class="actions">
              <button type="submit" class="btn btn-primary" id="saveBtn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
              {% if request.GET.next %}
                <a class="btn btn-ghost" href="{{ request.GET.next }}">â†© Ø§Ù„Ø±Ø¬ÙˆØ¹</a>
              {% else %}
                <a class="btn btn-ghost" href="{% url 'reports:my_reports' %}">â†© Ø§Ù„Ø±Ø¬ÙˆØ¹</a>
              {% endif %}
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  {# Enhanced Upload Overlay #}
  <div class="er-upload-overlay" id="uploadOverlay" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="uploadTitle">
    <div class="er-upload-modal">
      <div class="er-upload-modal-icon">
        <i class="fa-solid fa-cloud-arrow-up"></i>
      </div>
      <h3 id="uploadTitle">Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</h3>
      <p>ÙŠØªÙ… Ø§Ù„Ø¢Ù† Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„ØªØºÙŠÙŠØ±Ø§ØªØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...</p>
      
      <div class="er-progress-container">
         <div id="upFill" class="er-progress-fill"></div>
      </div>
      
      <div class="er-progress-labels">
         <span id="upLabel" class="er-progress-label">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¶ÙŠØ±</span>
         <span id="upPct" class="er-progress-pct">0%</span>
      </div>
    </div>
  </div>

  {# Preview modal #}
  <div class="pm-overlay" id="pmOverlay" role="dialog" aria-modal="true" aria-label="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø©">
    <div class="pm" role="document">
      <div class="pm-hd">
        <h3 class="ttl"><i class="fa-regular fa-image"></i> Ù…Ø¹Ø§ÙŠÙ†Ø©</h3>
        <button type="button" class="pm-close" id="pmClose" aria-label="Ø¥ØºÙ„Ø§Ù‚">âœ•</button>
      </div>
      <div class="pm-bd">
        <img class="pm-img" id="pmImg" src="" alt="preview">
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script nonce="{{ CSP_NONCE }}">
  // Ø¥Ø¶Ø§ÙØ© class control Ù„Ù…Ø¯Ø®Ù„Ø§Øª Django
  (function(){
    const form = document.getElementById('editReportForm');
    if(!form) return;
    const sel = 'input[type=text], input[type=number], input[type=date], input[type=email], input[type=tel], input[type=search], textarea, select';
    form.querySelectorAll(sel).forEach(el=>{
      if(!el.classList.contains('control')) el.classList.add('control');
    });
  })();

  // Ù…Ù†Ø¹ Ø§Ù„Ø¯Ø¨Ù„-Ø³Ø¨Ù…ÙŠØª + Enhanced Upload Progress
  (function(){
    const form = document.getElementById('editReportForm');
    const btn = document.getElementById('saveBtn');
    const overlay = document.getElementById('uploadOverlay');
    const fill = document.getElementById('upFill');
    const pctEl = document.getElementById('upPct');
    const labelEl = document.getElementById('upLabel');
    
    if(!form || !btn) return;

    form.addEventListener('submit', function(e){
      e.preventDefault();
      
      // Haptic feedback for mobile
      if (navigator.vibrate) {
        navigator.vibrate([50, 30, 50]);
      }
      
      btn.disabled = true;
      btn.textContent = 'â³ Ø¬Ø§Ø±Ù Ø§Ù„Ø­ÙØ¸...';
      form.classList.add('is-submitting');
      
      if(overlay) {
        overlay.style.display = 'flex';
        overlay.setAttribute('aria-hidden', 'false');
      }
      
      // Prepare FormData
      const fd = new FormData(form);
      
      if(labelEl) labelEl.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¶ÙŠØ±";
      
      const xhr = new XMLHttpRequest();
      xhr.open('POST', form.action || window.location.href, true);
      
      const tok = form.querySelector('[name="csrfmiddlewaretoken"]');
      if(tok) xhr.setRequestHeader('X-CSRFToken', tok.value);
      xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
      
      xhr.upload.onprogress = function(ev){
        if(ev.lengthComputable && fill && pctEl){
          const p = Math.round((ev.loaded / ev.total) * 100);
          fill.style.width = p + "%"; 
          pctEl.textContent = p + "%";
          
          if(labelEl) {
            if(p < 30) labelEl.textContent = "Ø¨Ø¯Ø¡ Ø§Ù„Ø±ÙØ¹";
            else if(p < 70) labelEl.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹";
            else if(p < 100) labelEl.textContent = "Ø§Ù‚ØªØ±Ø§Ø¨ Ø§Ù„Ø¥ÙƒØªÙ…Ø§Ù„";
            else labelEl.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸";
          }
        }
      };
      
      xhr.onload = function(){
        if(xhr.status >= 200 && xhr.status < 400){
          if(labelEl) labelEl.textContent = "ØªÙ… Ø¨Ù†Ø¬Ø§Ø­!";
          if(pctEl) pctEl.textContent = "100%";
          if(fill) fill.style.width = "100%";
          
          // Success vibration
          if (navigator.vibrate) {
            navigator.vibrate([100, 50, 100]);
          }
          
          setTimeout(function(){
            // Check if response has redirect
            if(xhr.responseURL && xhr.responseURL !== window.location.href){
              window.location.href = xhr.responseURL;
            } else {
              window.location.reload();
            }
          }, 300);
        } else {
          const ct = xhr.getResponseHeader('Content-Type') || "";
          if(ct.includes('text/html')){
            document.open(); 
            document.write(xhr.responseText); 
            document.close();
          } else {
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸");
            if(overlay) {
              overlay.style.display = "none"; 
              overlay.setAttribute("aria-hidden", "true");
            }
            btn.disabled = false;
            btn.textContent = 'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª';
            form.classList.remove('is-submitting');
          }
        }
      };
      
      xhr.onerror = function(){ 
        alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø´Ø¨ÙƒØ©");
        if(overlay) {
          overlay.style.display = "none"; 
          overlay.setAttribute("aria-hidden", "true");
        }
        btn.disabled = false;
        btn.textContent = 'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª';
        form.classList.remove('is-submitting');
      };
      
      xhr.send(fd);
    }, { once: false }); // Changed from { once: true } to allow retry on error
  })();

  // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙŠÙˆÙ… ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
  (function(){
    const dateInput = document.getElementById("id_report_date");
    const dayInput  = document.getElementById("id_day_name");
    if(!dateInput || !dayInput) return;

    function setDay(v){
      if(!v){ dayInput.value=""; return; }
      const d = new Date(v);
      const days = ["Ø§Ù„Ø£Ø­Ø¯","Ø§Ù„Ø§Ø«Ù†ÙŠÙ†","Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡","Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡","Ø§Ù„Ø®Ù…ÙŠØ³","Ø§Ù„Ø¬Ù…Ø¹Ø©","Ø§Ù„Ø³Ø¨Øª"];
      if(!isNaN(d.getTime())) dayInput.value = days[d.getDay()];
    }

    setDay(dateInput.value);
    dateInput.addEventListener("change", e => setDay(e.target.value));
  })();

  // Ù…Ø¹Ø§ÙŠÙ†Ø© ÙÙˆØ±ÙŠØ© Ù„ÙƒÙ„ Ø®Ø§Ù†Ø© + Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¥Ø²Ø§Ù„Ø© Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù + Ø¥Ø¸Ù‡Ø§Ø± placeholder Ø¹Ù†Ø¯ ØªÙØ¹ÙŠÙ„ Ø¥Ø²Ø§Ù„Ø©
  (function(){
    const slots = [1,2,3,4];

    function makeEmpty(slot){
      const old = document.getElementById(`thumb-${slot}`);
      if(!old) return;

      const box = document.createElement('div');
      box.className = 'thumb--empty';
      box.id = `thumb-${slot}`;
      box.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø©';
      old.replaceWith(box);
    }

    function setThumb(slot, dataUrl){
      const old = document.getElementById(`thumb-${slot}`);
      if(!old) return;

      if(old.tagName && old.tagName.toLowerCase() === 'img'){
        old.src = dataUrl;
        old.setAttribute('data-full', dataUrl);
        return;
      }

      const img = document.createElement('img');
      img.className = 'thumb';
      img.id = `thumb-${slot}`;
      img.src = dataUrl;
      img.alt = `image${slot}`;
      img.setAttribute('data-full', dataUrl);
      old.replaceWith(img);
    }

    slots.forEach(n=>{
      const input = document.getElementById(`id_image${n}`);
      const clear = document.getElementById(`id_image${n}_clear`);
      if(input){
        input.addEventListener('change', function(e){
          const file = e.target.files && e.target.files[0];
          if(!file) return;

          if(clear) clear.checked = false;

          const reader = new FileReader();
          reader.onload = ev => setThumb(n, ev.target.result);
          reader.readAsDataURL(file);
        });
      }

      if(clear){
        clear.addEventListener('change', function(){
          if(clear.checked){
            // Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙØ¹Ù‘Ù„ Ø¥Ø²Ø§Ù„Ø©ØŒ Ù†Ø¹Ø±Ø¶ placeholder (Ø¨Ø¯ÙˆÙ† Ù„Ù…Ø³ Ø§Ù„Ø±Ø§Ø¨Ø·)
            makeEmpty(n);
            // Ù…Ø­Ø§ÙˆÙ„Ø© ØªÙ†Ø¸ÙŠÙ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„Ù (Ø¥Ù† ÙˆØ¬Ø¯)
            try{
              if(input) input.value = '';
            }catch(e){
              // ignore
            }
          }
        });
      }
    });
  })();

  // Modal Ù…Ø¹Ø§ÙŠÙ†Ø©
  (function(){
    const overlay = document.getElementById('pmOverlay');
    const closeBtn = document.getElementById('pmClose');
    const img = document.getElementById('pmImg');
    if(!overlay || !closeBtn || !img) return;

    function open(src){
      if(!src) return;
      img.src = src;
      overlay.classList.add('is-open');
      try{
        if(window.__lockScroll) window.__lockScroll(true);
      }catch(e){
        // ignore
      }
    }

    function close(){
      overlay.classList.remove('is-open');
      img.src = '';
      try{
        if(window.__lockScroll) window.__lockScroll(false);
      }catch(e){
        // ignore
      }
    }

    document.addEventListener('click', function(ev){
      const a = ev.target.closest && ev.target.closest('.er-preview');
      if(a){
        ev.preventDefault();
        open(a.getAttribute('data-src'));
        return;
      }

      const t = ev.target;
      if(t && t.classList && t.classList.contains('thumb')){
        const src = t.getAttribute('data-full') || t.src;
        open(src);
        return;
      }

      if(ev.target === overlay){
        close();
      }
    });

    closeBtn.addEventListener('click', close);

    document.addEventListener('keydown', function(ev){
      if(ev.key === 'Escape' && overlay.classList.contains('is-open')){
        close();
      }
    });
  })();
</script>
{% endblock %}
