{# templates/reports/report_edit.html (Ø£Ùˆ Ø§Ø³Ù… Ù…Ù„ÙÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠ) #}
{% extends "base.html" %}
{% load static %}
{% block title %}âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± #{{ report.id }}{% endblock %}

{% block head %}
<style>
  .edit-report-scope{
    --ink:#0f172a; --ink-soft:#1f2937; --muted:#64748b; --line:#e5e7eb;
    --brand:#2563eb; --brand2:#3b82f6;
    --accent:#059669; --accent2:#10b981;
    --danger:#ef4444; --danger2:#dc2626;
    --card:#ffffff; --bg:#f8fafc;
    --radius:16px; --rsm:12px;
    --shadow:0 10px 30px rgba(2,6,23,.08);
    --shadow2:0 14px 34px rgba(2,6,23,.14);
    --tr:.2s ease;
  }
  @media (prefers-color-scheme: dark){
    .edit-report-scope{
      --ink:#e5e7eb; --ink-soft:#f1f5f9; --muted:#94a3b8; --line:#1f2937;
      --card:#0f172a; --bg:#0b1220;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --shadow2:0 18px 40px rgba(0,0,0,.45);
    }
  }

  .edit-report-scope .wrap{max-width:980px;margin:0 auto;padding:20px 14px}
  .edit-report-scope .card{
    background:var(--card);border:1px solid var(--line);
    border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden
  }
  .edit-report-scope .hd{
    padding:18px 20px;border-bottom:1px solid var(--line);
    display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap
  }
  .edit-report-scope .title{margin:0;font-weight:950;color:var(--ink-soft);font-size:1.05rem}
  .edit-report-scope .sub{margin:0;color:var(--muted);font-weight:800;font-size:.92rem}
  .edit-report-scope .body{padding:20px}

  .edit-report-scope .grid{display:grid;gap:18px}
  .edit-report-scope .row{display:flex;flex-direction:column;gap:8px}
  .edit-report-scope label{font-weight:900;color:var(--ink-soft)}
  .edit-report-scope .help{font-size:.88rem;color:var(--muted);font-weight:800;margin-top:2px}

  .edit-report-scope .control{
    width:100%;padding:12px 14px;border:1px solid var(--line);border-radius:var(--rsm);
    background:color-mix(in srgb, var(--card) 92%, var(--bg) 8%);color:var(--ink-soft);
    font-size:1rem;transition:border var(--tr), box-shadow var(--tr)
  }
  .edit-report-scope textarea.control{min-height:120px;resize:vertical}
  .edit-report-scope .control:focus{outline:none;border-color:var(--brand2);box-shadow:0 0 0 3px rgba(59,130,246,.18)}

  /* Ø±Ø³Ø§Ø¦Ù„ */
  .edit-report-scope .msg{
    border:1px solid; padding:10px 12px; border-radius:12px; font-weight:900;
    background:color-mix(in srgb, var(--card) 88%, var(--bg) 12%);
  }
  .edit-report-scope .msg.err{border-color:#fecaca;background:#fef2f2;color:#991b1b}
  @media (prefers-color-scheme: dark){
    .edit-report-scope .msg.err{border-color:#7f1d1d;background:#2a0f14;color:#fecaca}
  }

  /* ØµÙˆØ± */
  .edit-report-scope .images{display:grid;gap:14px}
  @media(min-width:720px){.edit-report-scope .images{grid-template-columns:repeat(4,1fr)}}
  .edit-report-scope .img-card{
    border:1px dashed color-mix(in srgb, var(--line) 70%, #cbd5e1 30%);
    border-radius:14px;background:color-mix(in srgb, var(--card) 92%, var(--bg) 8%);
    padding:12px;display:flex;flex-direction:column;gap:10px;transition:transform var(--tr), box-shadow var(--tr)
  }
  .edit-report-scope .img-card:hover{transform:translateY(-2px);box-shadow:var(--shadow2)}
  .edit-report-scope .thumb{
    width:100%;height:130px;border-radius:12px;background:#f1f5f9;object-fit:cover;display:block;border:1px solid var(--line)
  }
  .edit-report-scope .thumb--empty{
    height:130px;border-radius:12px;background:color-mix(in srgb, var(--card) 80%, var(--bg) 20%);
    border:1px solid var(--line);
    display:grid;place-items:center;color:var(--muted);font-weight:900;font-size:.9rem
  }
  .edit-report-scope .img-meta{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .edit-report-scope .img-meta small{color:var(--muted);font-weight:900}
  .edit-report-scope .img-meta a{font-size:.85rem;color:var(--brand);text-decoration:none;font-weight:900}
  .edit-report-scope .img-meta a:hover{text-decoration:underline}

  .edit-report-scope .img-actions{display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  .edit-report-scope .btn-file{
    position:relative;display:inline-flex;align-items:center;justify-content:center;gap:8px;
    padding:9px 12px;border-radius:10px;border:1px solid #c7d2fe;
    background:#eef2ff;color:#1e3a8a;font-weight:950;cursor:pointer;min-height:40px
  }
  @media (prefers-color-scheme: dark){
    .edit-report-scope .btn-file{background:#0e1b35;color:#cdd9ff;border-color:#1e2e59}
  }
  .edit-report-scope .btn-file input[type="file"]{position:absolute;inset:0;opacity:0;cursor:pointer}

  .edit-report-scope .clearbox{display:flex;align-items:center;gap:6px}
  .edit-report-scope .clearbox input{width:18px;height:18px}
  .edit-report-scope .clearbox span{font-size:.9rem;color:var(--danger2);font-weight:950}

  .edit-report-scope .note{
    font-size:.88rem;color:var(--muted);font-weight:850;
    background:color-mix(in srgb, var(--card) 92%, var(--bg) 8%);
    border:1px solid var(--line);border-radius:12px;padding:10px 12px
  }

  /* Ø£Ø²Ø±Ø§Ø± */
  .edit-report-scope .actions{display:grid;grid-template-columns:1fr;gap:12px;margin-top:8px}
  @media(min-width:560px){.edit-report-scope .actions{grid-template-columns:1fr 1fr}}
  .edit-report-scope .btn{
    padding:12px 16px;border-radius:12px;border:1px solid var(--line);
    background:color-mix(in srgb, var(--card) 92%, var(--bg) 8%);
    font-weight:950;cursor:pointer;text-decoration:none;text-align:center;color:var(--ink-soft);
    transition:transform var(--tr), filter var(--tr)
  }
  .edit-report-scope .btn:hover{transform:translateY(-1px)}
  .edit-report-scope .btn-save{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;border-color:transparent}
  .edit-report-scope .btn-save:hover{filter:brightness(1.03)}
  .edit-report-scope .btn-ghost{color:#1e3a8a;background:#eef2ff;border-color:#c7d2fe}
  @media (prefers-color-scheme: dark){
    .edit-report-scope .btn-ghost{background:#0e1b35;color:#cdd9ff;border-color:#1e2e59}
  }
</style>
{% endblock %}

{% block content %}
<div class="edit-report-scope">
  <div class="wrap" dir="rtl">
    <div class="card">
      <div class="hd">
        <div>
          <h2 class="title">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± #{{ report.id }}</h2>
          <p class="sub">Ø­Ø¯Ù‘Ø« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙ‚Ø±ÙŠØ±ØŒ ÙˆØ§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„ØµÙˆØ± Ø£Ùˆ Ø§Ø­Ø°ÙÙ‡Ø§ Ø¥Ù† Ù„Ø²Ù….</p>
        </div>
      </div>

      <div class="body">
        {% if messages %}
          {% for message in messages %}
            <div class="msg err" style="margin-bottom:10px">{{ message }}</div>
          {% endfor %}
        {% endif %}

        {% if form.non_field_errors %}
          <div class="msg err" style="margin-bottom:10px">
            {% for e in form.non_field_errors %}â€¢ {{ e }}<br>{% endfor %}
          </div>
        {% endif %}

        <form method="post" enctype="multipart/form-data" autocomplete="off" novalidate id="editReportForm">
          {% csrf_token %}

          <div class="grid">
            <div class="row">
              <label for="{{ form.category.id_for_label }}">Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</label>
              {{ form.category }}
              {% if form.category.errors %}
                <div class="msg err">{% for e in form.category.errors %}â€¢ {{ e }}<br>{% endfor %}</div>
              {% endif %}
            </div>

            {% if form.fields.teacher_name %}
              <div class="row">
                <label for="id_teacher_name">Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…</label>
                <input class="control" type="text" id="id_teacher_name" name="teacher_name" maxlength="120"
                       value="{{ form.data.teacher_name|default:report.teacher_name|default:request.user.name }}">
                <div class="help">ÙŠØ¸Ù‡Ø± Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ø¯Ø§Ø®Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©.</div>
              </div>
            {% endif %}

            <div class="row">
              <label for="{{ form.title.id_for_label }}">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† / Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</label>
              {{ form.title }}
              {% if form.title.errors %}
                <div class="msg err">{% for e in form.title.errors %}â€¢ {{ e }}<br>{% endfor %}</div>
              {% endif %}
            </div>

            <div class="row">
              <label for="{{ form.report_date.id_for_label }}">ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
              {{ form.report_date }}
              {% if form.report_date.errors %}
                <div class="msg err">{% for e in form.report_date.errors %}â€¢ {{ e }}<br>{% endfor %}</div>
              {% endif %}
            </div>

            <div class="row">
              <label for="{{ form.day_name.id_for_label }}">ğŸ“Œ Ø§Ù„ÙŠÙˆÙ…</label>
              {{ form.day_name }}
              <div class="help">ÙŠÙØ­Ø¯Ù‘ÙØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ØªØ§Ø±ÙŠØ® (ÙˆÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„Ù‡ ÙŠØ¯ÙˆÙŠÙ‹Ø§).</div>
              {% if form.day_name.errors %}
                <div class="msg err">{% for e in form.day_name.errors %}â€¢ {{ e }}<br>{% endfor %}</div>
              {% endif %}
            </div>

            <div class="row">
              <label for="{{ form.beneficiaries_count.id_for_label }}">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªÙÙŠØ¯ÙŠÙ†</label>
              {{ form.beneficiaries_count }}
              {% if form.beneficiaries_count.errors %}
                <div class="msg err">{% for e in form.beneficiaries_count.errors %}â€¢ {{ e }}<br>{% endfor %}</div>
              {% endif %}
            </div>

            <div class="row">
              <label for="{{ form.idea.id_for_label }}">Ø§Ù„ÙˆØµÙ / ÙÙƒØ±Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</label>
              {{ form.idea }}
              {% if form.idea.errors %}
                <div class="msg err">{% for e in form.idea.errors %}â€¢ {{ e }}<br>{% endfor %}</div>
              {% endif %}
            </div>

            <div class="row">
              <label>Ø§Ù„ØµÙˆØ±</label>

              <div class="images">
                {# ========= Slot 1 ========= #}
                <div class="img-card" data-slot="1">
                  {% if report.image1 %}
                    <img class="thumb" id="thumb-1" src="{{ report.image1.url }}" alt="image1">
                    <div class="img-meta">
                      <small>Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</small>
                      <a href="{{ report.image1.url }}" target="_blank" rel="noopener">ÙØªØ­</a>
                    </div>
                  {% else %}
                    <div class="thumb--empty" id="thumb-1">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø©</div>
                    <div class="img-meta"><small>â€”</small><span></span></div>
                  {% endif %}

                  <div class="img-actions">
                    <label class="btn-file">
                      ğŸ“· Ø§Ø®ØªØ± Ù…Ù„ÙÙ‹Ø§
                      <input type="file" id="id_image1" name="image1" accept="image/*" capture="environment">
                    </label>
                    <label class="clearbox">
                      <input type="checkbox" id="id_image1_clear" name="image1-clear">
                      <span>Ø¥Ø²Ø§Ù„Ø©</span>
                    </label>
                  </div>

                  {% if form.image1.errors %}
                    <div class="msg err">{% for e in form.image1.errors %}â€¢ {{ e }}<br>{% endfor %}</div>
                  {% endif %}
                </div>

                {# ========= Slot 2 ========= #}
                <div class="img-card" data-slot="2">
                  {% if report.image2 %}
                    <img class="thumb" id="thumb-2" src="{{ report.image2.url }}" alt="image2">
                    <div class="img-meta">
                      <small>Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</small>
                      <a href="{{ report.image2.url }}" target="_blank" rel="noopener">ÙØªØ­</a>
                    </div>
                  {% else %}
                    <div class="thumb--empty" id="thumb-2">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø©</div>
                    <div class="img-meta"><small>â€”</small><span></span></div>
                  {% endif %}

                  <div class="img-actions">
                    <label class="btn-file">
                      ğŸ“· Ø§Ø®ØªØ± Ù…Ù„ÙÙ‹Ø§
                      <input type="file" id="id_image2" name="image2" accept="image/*" capture="environment">
                    </label>
                    <label class="clearbox">
                      <input type="checkbox" id="id_image2_clear" name="image2-clear">
                      <span>Ø¥Ø²Ø§Ù„Ø©</span>
                    </label>
                  </div>

                  {% if form.image2.errors %}
                    <div class="msg err">{% for e in form.image2.errors %}â€¢ {{ e }}<br>{% endfor %}</div>
                  {% endif %}
                </div>

                {# ========= Slot 3 ========= #}
                <div class="img-card" data-slot="3">
                  {% if report.image3 %}
                    <img class="thumb" id="thumb-3" src="{{ report.image3.url }}" alt="image3">
                    <div class="img-meta">
                      <small>Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</small>
                      <a href="{{ report.image3.url }}" target="_blank" rel="noopener">ÙØªØ­</a>
                    </div>
                  {% else %}
                    <div class="thumb--empty" id="thumb-3">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø©</div>
                    <div class="img-meta"><small>â€”</small><span></span></div>
                  {% endif %}

                  <div class="img-actions">
                    <label class="btn-file">
                      ğŸ“· Ø§Ø®ØªØ± Ù…Ù„ÙÙ‹Ø§
                      <input type="file" id="id_image3" name="image3" accept="image/*" capture="environment">
                    </label>
                    <label class="clearbox">
                      <input type="checkbox" id="id_image3_clear" name="image3-clear">
                      <span>Ø¥Ø²Ø§Ù„Ø©</span>
                    </label>
                  </div>

                  {% if form.image3.errors %}
                    <div class="msg err">{% for e in form.image3.errors %}â€¢ {{ e }}<br>{% endfor %}</div>
                  {% endif %}
                </div>

                {# ========= Slot 4 ========= #}
                <div class="img-card" data-slot="4">
                  {% if report.image4 %}
                    <img class="thumb" id="thumb-4" src="{{ report.image4.url }}" alt="image4">
                    <div class="img-meta">
                      <small>Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</small>
                      <a href="{{ report.image4.url }}" target="_blank" rel="noopener">ÙØªØ­</a>
                    </div>
                  {% else %}
                    <div class="thumb--empty" id="thumb-4">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø©</div>
                    <div class="img-meta"><small>â€”</small><span></span></div>
                  {% endif %}

                  <div class="img-actions">
                    <label class="btn-file">
                      ğŸ“· Ø§Ø®ØªØ± Ù…Ù„ÙÙ‹Ø§
                      <input type="file" id="id_image4" name="image4" accept="image/*" capture="environment">
                    </label>
                    <label class="clearbox">
                      <input type="checkbox" id="id_image4_clear" name="image4-clear">
                      <span>Ø¥Ø²Ø§Ù„Ø©</span>
                    </label>
                  </div>

                  {% if form.image4.errors %}
                    <div class="msg err">{% for e in form.image4.errors %}â€¢ {{ e }}<br>{% endfor %}</div>
                  {% endif %}
                </div>
              </div>

              <div class="note" style="margin-top:10px">
                Ù„Ø¥Ø²Ø§Ù„Ø© ØµÙˆØ±Ø© Ø­Ø§Ù„ÙŠØ© ÙØ¹Ù‘ÙÙ„ Ù…Ø±Ø¨Ø¹ <b>Ø¥Ø²Ø§Ù„Ø©</b>Ø› Ø£Ùˆ Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§.
              </div>
            </div>

            {% if request.GET.next %}
              <input type="hidden" name="next" value="{{ request.GET.next }}">
            {% endif %}

            <div class="actions">
              <button type="submit" class="btn btn-save">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
              {% if request.GET.next %}
                <a class="btn btn-ghost" href="{{ request.GET.next }}">â†© Ø§Ù„Ø±Ø¬ÙˆØ¹</a>
              {% else %}
                <a class="btn btn-ghost" href="{% url 'reports:my_reports' %}">â†© Ø§Ù„Ø±Ø¬ÙˆØ¹</a>
              {% endif %}
            </div>
          </div>
        </form>

      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
  // Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù .control Ù„ÙƒÙ„ Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© Ù…Ù† Django (Ù„Ù„ØªÙˆØ­ÙŠØ¯)
  (function(){
    const form = document.getElementById('editReportForm');
    if(!form) return;
    const sel = 'input[type=text], input[type=number], input[type=date], input[type=email], input[type=tel], input[type=search], textarea, select';
    form.querySelectorAll(sel).forEach(el=>{
      if(!el.classList.contains('control')) el.classList.add('control');
    });
  })();

  // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙŠÙˆÙ… ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
  (function(){
    const dateInput = document.getElementById("id_report_date");
    const dayInput  = document.getElementById("id_day_name");
    if(dateInput && dayInput){
      function setDay(v){
        if(!v){ dayInput.value=""; return; }
        const d = new Date(v);
        const days = ["Ø§Ù„Ø£Ø­Ø¯","Ø§Ù„Ø§Ø«Ù†ÙŠÙ†","Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡","Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡","Ø§Ù„Ø®Ù…ÙŠØ³","Ø§Ù„Ø¬Ù…Ø¹Ø©","Ø§Ù„Ø³Ø¨Øª"];
        dayInput.value = days[d.getDay()];
      }
      setDay(dateInput.value);
      dateInput.addEventListener("change", e => setDay(e.target.value));
    }
  })();

  // Ù…Ø¹Ø§ÙŠÙ†Ø© ÙÙˆØ±ÙŠØ© Ù„ÙƒÙ„ Ø®Ø§Ù†Ø© ØµÙˆØ±Ø© + Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¥Ø²Ø§Ù„Ø© Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù
  (function(){
    const slots = [1,2,3,4];

    function setThumb(slot, dataUrl){
      const old = document.getElementById(`thumb-${slot}`);
      if(!old) return;

      if(old.tagName && old.tagName.toLowerCase() === 'img'){
        old.src = dataUrl;
        return;
      }

      const img = document.createElement('img');
      img.className = 'thumb';
      img.id = `thumb-${slot}`;
      img.src = dataUrl;
      img.alt = `image${slot}`;
      old.replaceWith(img);
    }

    slots.forEach(n=>{
      const input = document.getElementById(`id_image${n}`);
      const clear = document.getElementById(`id_image${n}_clear`);
      if(!input) return;

      input.addEventListener('change', function(e){
        const file = e.target.files && e.target.files[0];
        if(!file) return;

        if(clear) clear.checked = false;

        const reader = new FileReader();
        reader.onload = ev => setThumb(n, ev.target.result);
        reader.readAsDataURL(file);
      });
    });
  })();
</script>
{% endblock %}
