{% extends "base.html" %}
{% block title %}{% if mode == 'edit' %}تعديل مدرسة{% else %}إنشاء مدرسة جديدة{% endif %}{% endblock %}

{% block head %}
<style>
  /* ✅ Scoped styles فقط لهذه الصفحة */
  .schoolform-page{max-width:980px;margin:0 auto;padding:clamp(10px,2.2vw,18px)}
  .schoolform-shell{
    background:var(--card);
    border:1px solid var(--line-2);
    border-radius:18px;
    box-shadow:var(--shadow);
    overflow:hidden;
  }

  /* Header */
  .schoolform-head{
    padding:clamp(16px,2.2vw,22px) clamp(16px,3vw,26px);
    background:
      radial-gradient(900px 240px at 12% 0%, rgba(37,99,235,.18), transparent 58%),
      radial-gradient(700px 220px at 92% 92%, rgba(16,185,129,.14), transparent 62%),
      linear-gradient(135deg, rgba(37,99,235,.94), rgba(59,130,246,.86));
    color:#fff;
  }
  .schoolform-top{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap}
  .schoolform-title{
    margin:0;
    font-weight:950;
    font-size:clamp(1.15rem,2.4vw,1.6rem);
    display:flex;gap:10px;align-items:center;
  }
  .schoolform-sub{margin:6px 0 0;opacity:.95;font-weight:850;line-height:1.7}

  .schoolform-actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
  .schoolform-actions .btn{border-radius:14px}

  /* Body */
  .schoolform-body{padding:clamp(14px,2.6vw,22px)}
  .schoolform-card{
    background:var(--card);
    border:1px solid var(--line-2);
    border-radius:18px;
    box-shadow:var(--shadow-sm);
    padding:14px;
  }

  .grid{display:grid;gap:12px}
  .row-3{display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(180px,1fr))}
  .row-2{display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
  .row-4{display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}

  .field{min-width:0}
  .lbl{
    display:flex;align-items:center;justify-content:space-between;gap:10px;
    font-weight:950;margin-bottom:6px;color:var(--ink);
  }
  .hint{color:var(--muted);font-weight:850;font-size:.9rem;margin-top:6px;line-height:1.6}

  /* Form controls: نعتمد على app.css قدر الإمكان */
  .schoolform-page input,
  .schoolform-page select,
  .schoolform-page textarea{
    width:100%;
  }

  /* Preview */
  .preview{
    margin-top:10px;
    display:flex;gap:10px;align-items:center;flex-wrap:wrap;
    padding:10px 12px;
    border:1px solid var(--line-2);
    border-radius:14px;
    background:rgba(248,250,252,.55);
  }
  html[data-theme="dark"] .preview{background:rgba(255,255,255,.03)}
  .preview img{
    width:54px;height:54px;object-fit:contain;border-radius:14px;
    border:1px solid var(--line-2);background:#fff;
  }
  html[data-theme="dark"] .preview img{background:rgba(255,255,255,.06)}
  .preview .meta{display:grid;gap:2px}
  .preview .meta b{color:var(--ink);font-weight:950}
  .preview .meta span{color:var(--muted);font-weight:850}

  /* Footer actions */
  .actions{
    display:flex;gap:10px;flex-wrap:wrap;margin-top:14px;
  }
  .actions .btn{min-height:42px}
  .actions .btn-primary{flex:1}
  .actions .btn-outline{flex:0 0 auto}

  @media(max-width:520px){
    .actions .btn{width:100%;justify-content:center}
    .schoolform-actions{width:100%}
    .schoolform-actions .btn{width:100%;justify-content:center}
  }
</style>
{% endblock %}

{% block content %}
<div class="schoolform-page" dir="rtl">
  <div class="schoolform-shell">
    <div class="schoolform-head">
      <div class="schoolform-top">
        <div>
          <h1 class="schoolform-title">
            <i class="fa-solid fa-school" aria-hidden="true"></i>
            {% if mode == 'edit' %}تعديل مدرسة{% else %}إنشاء مدرسة جديدة{% endif %}
          </h1>
          <p class="schoolform-sub">املأ بيانات المدرسة كما ستظهر في النظام.</p>
        </div>

        <div class="schoolform-actions">
          <a href="{% url 'reports:schools_admin_list' %}" class="btn btn-outline" style="background:rgba(255,255,255,.10);border-color:rgba(255,255,255,.22);color:#fff">
            <i class="fa-solid fa-arrow-right" aria-hidden="true"></i>
            عودة
          </a>
        </div>
      </div>
    </div>

    <div class="schoolform-body">
      <div class="schoolform-card">
        <form method="post" enctype="multipart/form-data" class="grid" novalidate>
          {% csrf_token %}

          {% if form.non_field_errors %}
            <div class="msg error" data-autohide="false">
              {{ form.non_field_errors }}
            </div>
          {% endif %}

          <!-- اسم المدرسة -->
          <div class="field">
            <label for="id_name" class="lbl">اسم المدرسة</label>
            {{ form.name }}
            {% if form.name.errors %}
              <div style="color:var(--danger);font-weight:950;font-size:.9rem;margin-top:6px">{{ form.name.errors.0 }}</div>
            {% endif %}
          </div>

          <!-- الكود/المرحلة/النوع -->
          <div class="row-3">
            <div class="field">
              <label for="id_code" class="lbl">الكود الداخلي</label>
              {{ form.code }}
              <div class="hint">كود قصير (بالإنجليزية) لتمييز المدرسة، يُستخدم داخليًا.</div>
              {% if form.code.errors %}
                <div style="color:var(--danger);font-weight:950;font-size:.9rem;margin-top:6px">{{ form.code.errors.0 }}</div>
              {% endif %}
            </div>

            <div class="field">
              <label for="id_stage" class="lbl">المرحلة</label>
              {{ form.stage }}
              {% if form.stage.errors %}
                <div style="color:var(--danger);font-weight:950;font-size:.9rem;margin-top:6px">{{ form.stage.errors.0 }}</div>
              {% endif %}
            </div>

            <div class="field">
              <label for="id_gender" class="lbl">بنين / بنات</label>
              {{ form.gender }}
              {% if form.gender.errors %}
                <div style="color:var(--danger);font-weight:950;font-size:.9rem;margin-top:6px">{{ form.gender.errors.0 }}</div>
              {% endif %}
            </div>
          </div>

          <!-- المدينة/الجوال -->
          <div class="row-2">
            <div class="field">
              <label for="id_city" class="lbl">المدينة</label>
              {{ form.city }}
              {% if form.city.errors %}
                <div style="color:var(--danger);font-weight:950;font-size:.9rem;margin-top:6px">{{ form.city.errors.0 }}</div>
              {% endif %}
            </div>

            <div class="field">
              <label for="id_phone" class="lbl">رقم الجوال</label>
              {{ form.phone }}
              {% if form.phone.errors %}
                <div style="color:var(--danger);font-weight:950;font-size:.9rem;margin-top:6px">{{ form.phone.errors.0 }}</div>
              {% endif %}
            </div>
          </div>

          <!-- ألوان/شعار/رابط/حالة -->
          <div class="row-4">
            <div class="field">
              <label for="id_print_primary_color" class="lbl">لون قالب الطباعة</label>
              {{ form.print_primary_color }}
              <div class="hint">لون رئيسي لقالب الطباعة (يمكن تغييره لاحقًا من إعدادات المدرسة).</div>
              {% if form.print_primary_color.errors %}
                <div style="color:var(--danger);font-weight:950;font-size:.9rem;margin-top:6px">{{ form.print_primary_color.errors.0 }}</div>
              {% endif %}
            </div>

            <div class="field">
              <label for="id_logo_file" class="lbl">رفع الشعار (اختياري)</label>
              {{ form.logo_file }}
              <div class="hint">PNG / JPG / SVG / WEBP.</div>
              {% if form.logo_file.errors %}
                <div style="color:var(--danger);font-weight:950;font-size:.9rem;margin-top:6px">{{ form.logo_file.errors.0 }}</div>
              {% endif %}
            </div>

            <div class="field">
              <label for="id_logo_url" class="lbl">رابط الشعار (اختياري)</label>
              {{ form.logo_url }}
              <div class="hint">يُستخدم إذا لم يتوفر شعار مرفوع.</div>
              {% if form.logo_url.errors %}
                <div style="color:var(--danger);font-weight:950;font-size:.9rem;margin-top:6px">{{ form.logo_url.errors.0 }}</div>
              {% endif %}
            </div>

            <div class="field">
              <label for="id_is_active" class="lbl">الحالة</label>
              {{ form.is_active }}
              {% if form.is_active.errors %}
                <div style="color:var(--danger);font-weight:950;font-size:.9rem;margin-top:6px">{{ form.is_active.errors.0 }}</div>
              {% endif %}
            </div>
          </div>

          <!-- معاينة الشعار (عند التعديل فقط إذا توفّر instance) -->
          {% if mode == 'edit' %}
            {% if form.instance.logo_file %}
              <div class="preview" aria-label="معاينة الشعار الحالي">
                <img src="{{ form.instance.logo_file.url }}" alt="الشعار الحالي">
                <div class="meta">
                  <b>الشعار الحالي (مرفوع)</b>
                  <span class="mono">{{ form.instance.logo_file.name }}</span>
                </div>
              </div>
            {% elif form.instance.logo_url %}
              <div class="preview" aria-label="معاينة الشعار الحالي">
                <img src="{{ form.instance.logo_url }}" alt="الشعار الحالي">
                <div class="meta">
                  <b>الشعار الحالي (رابط)</b>
                  <span class="mono">{{ form.instance.logo_url|truncatechars:42 }}</span>
                </div>
              </div>
            {% endif %}
          {% endif %}

          <!-- أزرار -->
          <div class="actions">
            <button type="submit" class="btn btn-primary">
              <i class="fa-solid fa-floppy-disk" aria-hidden="true"></i>
              حفظ
            </button>
            <a href="{% url 'reports:schools_admin_list' %}" class="btn btn-outline">
              رجوع
            </a>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}
