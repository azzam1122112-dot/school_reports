{# reports/templates/reports/notification_create.html (or your path) #}
{% extends "base.html" %}
{% load static %}

{% block title %}إرسال إشعار{% endblock %}

{% block head %}
<style>
  /* =========================================================
     Notification Create (Scoped)
     - Scoped بالكامل داخل .notify-scope لتجنب تعارضات base/app.css
     - متوافق مع data-theme="dark" (بدل prefers-color-scheme)
     - جاهز لـ CheckboxSelectMultiple أو SelectMultiple
     ========================================================= */
  .notify-scope{
    --primary:#4361ee;
    --secondary:#7209b7;
    --accent:#f72585;

    --bg:#f8fafc;
    --card:#ffffff;
    --text:#1e293b;
    --text-light:#64748b;
    --border:#e2e8f0;

    --radius-lg:20px;
    --radius-md:12px;
    --radius-sm:10px;
    --shadow:0 10px 40px rgba(2, 6, 23, 0.08);
    --gradient:linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    --transition:all .25s ease;

    color: var(--text);
  }
  html[data-theme="dark"] .notify-scope{
    --bg:#0f172a;
    --card:#111c33;
    --text:#f1f5f9;
    --text-light:#94a3b8;
    --border:#22314f;
  }

  .notify-scope .wrap{max-width:1400px;margin:0 auto;padding:20px}

  .notify-scope .page-head{
    display:flex;align-items:flex-end;justify-content:space-between;gap:16px;
    margin-bottom:22px;flex-wrap:wrap
  }
  .notify-scope .title{
    margin:0;font-weight:950;font-size:2rem;
    background:var(--gradient);
    -webkit-background-clip:text;-webkit-text-fill-color:transparent;
    position:relative;padding-bottom:8px
  }
  .notify-scope .title::after{
    content:"";position:absolute;bottom:0;right:0;width:88px;height:4px;
    background:var(--gradient);border-radius:999px
  }
  .notify-scope .hint{
    color:var(--text-light);font-weight:800;margin-top:8px;
    font-size:1.02rem;line-height:1.7
  }

  .notify-scope .grid{display:grid;gap:22px}
  @media (min-width:1040px){
    .notify-scope .grid{grid-template-columns:1.15fr .85fr;align-items:start}
  }

  .notify-scope .card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:var(--radius-lg);
    box-shadow:var(--shadow);
    transition:var(--transition);
    position:relative;overflow:hidden
  }
  .notify-scope .card::before{
    content:"";position:absolute;top:0;right:0;width:100%;height:5px;background:var(--gradient)
  }
  .notify-scope .card-hd{
    padding:16px 20px;border-bottom:1px solid var(--border);
    display:flex;align-items:center;justify-content:space-between;gap:10px;
    background:linear-gradient(180deg, rgba(255,255,255,.5), rgba(255,255,255,0));
  }
  html[data-theme="dark"] .notify-scope .card-hd{
    background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,0));
  }
  .notify-scope .card-hd strong{font-weight:950;color:var(--text);font-size:1.15rem}
  .notify-scope .card-bd{padding:20px}
  .notify-scope .help{color:var(--text-light);font-size:.92rem;font-weight:800}

  .notify-scope .form-grid{display:grid;gap:18px}
  @media (min-width:720px){.notify-scope .form-grid{grid-template-columns:1fr 1fr}}
  .notify-scope .field{display:flex;flex-direction:column;gap:8px}
  .notify-scope .field.full{grid-column:1/-1}

  .notify-scope label{
    font-weight:950;color:var(--text);
    display:flex;align-items:center;gap:8px
  }

  .notify-scope input[type="text"],
  .notify-scope input[type="url"],
  .notify-scope input[type="datetime-local"],
  .notify-scope textarea,
  .notify-scope select{
    border:2px solid var(--border);
    border-radius:var(--radius-md);
    padding:12px 14px;
    font:inherit;
    background:var(--bg);
    color:var(--text);
    transition:var(--transition)
  }
  .notify-scope textarea{min-height:180px;resize:vertical;line-height:1.8}
  .notify-scope input:focus,
  .notify-scope textarea:focus,
  .notify-scope select:focus{
    outline:none;
    border-color:var(--primary);
    box-shadow:0 0 0 3px rgba(67, 97, 238, .18)
  }

  .notify-scope .errors{
    color:#ef4444;font-weight:850;font-size:.92rem;margin-top:4px
  }

  /* Actions */
  .notify-scope .actions{display:flex;gap:12px;flex-wrap:wrap;margin-top:20px}
  .notify-scope .actions--top{margin-top:0;margin-bottom:16px}

  /* Scoped buttons */
  .notify-scope .btn{
    display:inline-flex;align-items:center;gap:8px;
    padding:12px 18px;border-radius:var(--radius-md);
    border:1px solid var(--border);
    background:var(--card);
    font-weight:950;cursor:pointer;text-decoration:none;color:var(--text);
    transition:var(--transition)
  }
  .notify-scope .btn:hover{transform:translateY(-2px);box-shadow:0 8px 22px rgba(2,6,23,.10)}
  .notify-scope .btn-primary{
    background:var(--gradient);
    border:none;color:#fff;
    box-shadow:0 10px 26px rgba(67, 97, 238, .30)
  }
  .notify-scope .btn-primary:hover{box-shadow:0 14px 34px rgba(67, 97, 238, .38)}
  .notify-scope .btn-ghost{
    background:rgba(238,242,255,.95);
    border-color:#e5e7eb;
    color:#1e40af
  }
  html[data-theme="dark"] .notify-scope .btn-ghost{
    background:rgba(67,97,238,.12);
    border-color:rgba(67,97,238,.22);
    color:#dbeafe
  }
  .notify-scope .btn:disabled{opacity:.75;cursor:not-allowed;transform:none;box-shadow:none}

  /* Teachers tools */
  .notify-scope .teacher-tools{
    display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin:10px 0 12px
  }
  .notify-scope .teacher-tools input[type="search"]{
    flex:1 1 260px;
    border:2px solid var(--border);
    border-radius:var(--radius-md);
    padding:10px 12px;
    background:var(--card);
    color:var(--text);
  }
  .notify-scope .teacher-tools .mini{font-weight:950;color:var(--text)}
  .notify-scope .teacher-tools .count{
    background:var(--primary);color:#fff;border-radius:999px;
    padding:6px 12px;font-weight:950;font-size:.9rem
  }
  .notify-scope .teacher-actions{display:flex;align-items:center;gap:8px;font-size:.92rem}
  .notify-scope .teacher-actions button{
    background:none;border:0;padding:0;color:var(--primary);
    cursor:pointer;font-weight:950
  }
  .notify-scope .teacher-actions button:hover{text-decoration:underline}

  /* Teachers list container (Checkboxes OR SelectMultiple) */
  .notify-scope .teacher-list{
    border:2px solid var(--border);
    border-radius:var(--radius-md);
    background:var(--bg);
    padding:10px 12px;
    max-height:360px;
    overflow:auto
  }
  .notify-scope .teacher-list ul{
    list-style:none;padding:0;margin:0;
    display:grid;gap:8px
  }
  .notify-scope .teacher-list li{
    background:var(--card);
    border:1px solid transparent;
    border-radius:var(--radius-sm);
    padding:10px 12px
  }
  .notify-scope .teacher-list li:hover{
    border-color:rgba(67, 97, 238, .25);
    background:rgba(67, 97, 238, .06)
  }
  .notify-scope .teacher-list label{
    display:flex;align-items:center;gap:10px;margin:0;cursor:pointer;
    font-weight:900;
  }
  .notify-scope .teacher-list input[type="checkbox"]{
    width:18px;height:18px;accent-color:var(--primary)
  }
  /* If field is a <select multiple> */
  .notify-scope .teacher-list select[multiple]{
    width:100%;
    min-height:320px;
    padding:10px 12px;
    border-radius:var(--radius-md);
    border:2px solid var(--border);
    background:var(--card);
    color:var(--text);
  }
  .notify-scope .teacher-list select[multiple] option{
    padding:8px 10px;
  }

  /* Preview */
  .notify-scope .preview{
    background:linear-gradient(180deg, rgba(249,251,255,.9), rgba(255,255,255,.7));
  }
  html[data-theme="dark"] .notify-scope .preview{
    background:linear-gradient(180deg, rgba(15,23,42,.85), rgba(11,19,38,.85));
  }

  .notify-scope .notif{
    border:2px dashed rgba(219,234,254,.95);
    border-radius:var(--radius-lg);
    padding:18px;
    background:var(--card);
    box-shadow:0 10px 22px rgba(2,6,23,.07)
  }
  html[data-theme="dark"] .notify-scope .notif{
    border-color: rgba(67,97,238,.28);
  }
  .notify-scope .nt-h{
    display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:12px
  }
  .notify-scope .nt-title{margin:0;font-weight:950;color:var(--text);font-size:1.25rem}
  .notify-scope .nt-body{
    white-space:pre-wrap;
    margin:14px 0;
    color:var(--text);
    font-weight:800;
    line-height:1.85;
    padding:14px;
    background:var(--bg);
    border-radius:var(--radius-md);
    border-right:4px solid var(--primary)
  }
  .notify-scope .nt-meta{
    margin-top:12px;
    color:var(--text-light);
    font-weight:850;
    display:flex;gap:10px;flex-wrap:wrap
  }
  .notify-scope .pill{
    display:inline-flex;align-items:center;gap:6px;
    padding:8px 12px;border:1px solid var(--border);
    background:var(--bg);
    color:var(--text);
    border-radius:999px;font-weight:950;font-size:.9rem
  }

  /* Loading */
  .notify-scope .loading{
    display:inline-block;width:20px;height:20px;
    border:3px solid rgba(255,255,255,.32);
    border-radius:50%;
    border-top-color:#fff;
    animation:spin 1s ease-in-out infinite
  }
  @keyframes spin{to{transform:rotate(360deg)}}

  /* Mobile */
  @media (max-width:820px){
    .notify-scope .wrap{padding:16px}
    .notify-scope .page-head{flex-direction:column;align-items:flex-start}
    .notify-scope .title{font-size:1.6rem}
    .notify-scope .card-hd{flex-direction:column;align-items:flex-start;gap:8px}
    .notify-scope .teacher-tools{flex-direction:column;align-items:stretch}
    .notify-scope .actions{flex-direction:column;align-items:stretch}
    .notify-scope .btn{justify-content:center}
  }
  @media (max-width:480px){
    .notify-scope .title{font-size:1.4rem}
    .notify-scope .form-grid{grid-template-columns:1fr}
    .notify-scope .nt-meta{flex-direction:column;gap:8px}
  }
</style>
{% endblock %}

{% block content %}
<div class="notify-scope" dir="rtl">
  <div class="wrap">

    <header class="page-head">
      <div>
        <h1 class="title">إرسال إشعار</h1>
        <div class="hint">اكتب عنوانًا جذابًا ومحتوى واضحًا. يمكنك معاينة الشكل قبل الإرسال.</div>
      </div>
      <div>
        <a class="btn btn-ghost" href="{% url 'reports:notifications_sent' %}">
          <i class="fa-solid fa-list"></i> الإشعارات المرسلة
        </a>
      </div>
    </header>

    <div class="grid">

      <!-- العمود الأيسر: النموذج -->
      <section class="card" aria-labelledby="form-title">
        <div class="card-hd">
          <strong id="form-title">نموذج الإشعار</strong>
          <span class="help">يظهر هذا الخيار للمصرّح لهم فقط</span>
        </div>

        <div class="card-bd">
          {% if form %}
            {% if form.media %}{{ form.media }}{% endif %}

            <form method="post" enctype="multipart/form-data" action="" id="notifyForm" novalidate>
              {% csrf_token %}

              {% if form.non_field_errors %}
                <div class="errors">{{ form.non_field_errors }}</div>
              {% endif %}

              <div class="actions actions--top">
                <button class="btn btn-primary" type="submit">
                  <i class="fa-solid fa-paper-plane"></i> إرسال الإشعار
                </button>
                <a class="btn" href="{% url 'reports:home' %}">
                  <i class="fa-solid fa-home"></i> الرجوع للرئيسية
                </a>
              </div>

              <div class="form-grid">
                {% for field in form.visible_fields %}
                  {% if field.name == "teachers" or field.name == "target_department" %}
                    <div class="field full" data-name="{{ field.html_name|lower }}">
                      <label for="{{ field.id_for_label }}" style="display:flex;align-items:center;justify-content:space-between;gap:8px">
                        <span>
                          {% if field.field.required %}<span style="color:#ef4444">*</span>{% endif %}
                          {{ field.label }}
                        </span>

                        {% if field.name == "teachers" %}
                          <span class="teacher-actions">
                            <button type="button" id="selectAllTeachers">تحديد الكل</button>
                            <span>/</span>
                            <button type="button" id="clearAllTeachers">إلغاء التحديد</button>
                          </span>
                        {% endif %}
                      </label>

                      {% if field.name == "teachers" %}
                        <div class="teacher-tools">
                          <input id="teacherSearch" type="search" placeholder="ابحث باسم المعلّم…" aria-label="البحث عن معلّم">
                          <span class="mini">المحدّد: <span class="count" id="selCount">0</span></span>
                        </div>

                        <div class="teacher-list" id="teacherList">
                          {{ field }}
                        </div>
                      {% else %}
                        {{ field }}
                      {% endif %}

                      {% if field.help_text %}<div class="help">{{ field.help_text|safe }}</div>{% endif %}
                      {% for e in field.errors %}<div class="errors">{{ e }}</div>{% endfor %}
                    </div>
                  {% else %}
                    <div class="field" data-name="{{ field.html_name|lower }}">
                      <label for="{{ field.id_for_label }}">
                        {% if field.field.required %}<span style="color:#ef4444">*</span>{% endif %}
                        {{ field.label|default:"الحقل" }}
                      </label>
                      {{ field }}
                      {% if field.help_text %}<div class="help">{{ field.help_text|safe }}</div>{% endif %}
                      {% for e in field.errors %}<div class="errors">{{ e }}</div>{% endfor %}
                    </div>
                  {% endif %}
                {% endfor %}
              </div>

              <div class="actions">
                <button class="btn btn-primary" type="submit">
                  <i class="fa-solid fa-paper-plane"></i> إرسال الإشعار
                </button>
                <a class="btn" href="{% url 'reports:home' %}">
                  <i class="fa-solid fa-home"></i> الرجوع للرئيسية
                </a>
              </div>
            </form>
          {% else %}
            <div class="errors">لم يتم تمرير الفورم من الـ view.</div>
          {% endif %}
        </div>
      </section>

      <!-- العمود الأيمن: المعاينة -->
      <aside class="card preview" aria-labelledby="preview-title">
        <div class="card-hd">
          <strong id="preview-title">معاينة فورية</strong>
          <span class="help">تحدَّث تلقائيًا</span>
        </div>
        <div class="card-bd">
          <div class="notif">
            <div class="nt-h">
              <h3 class="nt-title" id="pv_title">عنوان الإشعار</h3>
              <div id="pv_important" title="هام" style="display:none">
                <i class="fa-solid fa-circle-exclamation" style="color:#ef4444"></i>
              </div>
            </div>
            <div class="nt-body" id="pv_body">سيظهر نص الإشعار هنا…</div>
            <div class="nt-meta">
              <span class="pill">
                <i class="fa-solid fa-user-tie" aria-hidden="true"></i>
                <span>مرسل: {% firstof request.user.name request.user.phone "الإدارة" %}</span>
              </span>
              <span class="pill" id="pv_action" style="display:none">
                <i class="fa-solid fa-link"></i> يحتوي على رابط إجراء
              </span>
              <span class="pill" id="pv_expires" style="display:none">
                <i class="fa-solid fa-clock"></i> ينتهي لاحقًا
              </span>
            </div>
          </div>
        </div>
      </aside>

    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script nonce="{{ CSP_NONCE }}">
  (function(){
    const $ = s => document.querySelector(s);

    function escapeHtml(val){
      return String(val ?? "").replace(/[&<>"']/g, ch => ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#39;",
      })[ch]);
    }

    // ===== Preview bindings (flexible) =====
    const titleInput =
      $("#id_title") ||
      document.querySelector('[name$="title"],[name*="title"],[name*="subject"],[name*="heading"]');

    const msgInput =
      $("#id_message") ||
      document.querySelector('textarea[name*="message"],textarea[name*="body"],textarea[name*="content"],textarea[name*="text"],textarea[name*="details"]');

    const urlInput =
      $("#id_action_url") ||
      document.querySelector('input[type="url"][name*="action_url"],input[type="url"]');

    const impInput =
      $("#id_is_important") ||
      document.querySelector('input[type="checkbox"][name*="is_important"]');

    const expInput =
      $("#id_expires_at") ||
      document.querySelector('input[type="datetime-local"][name*="expires_at"],input[name*="expires_at"]');

    const pvTitle = $("#pv_title");
    const pvBody  = $("#pv_body");
    const pvImportant = $("#pv_important");
    const pvAction = $("#pv_action");
    const pvExpires = $("#pv_expires");

    function updatePreview(){
      if(pvTitle && titleInput){
        pvTitle.textContent = (titleInput.value || "").trim() || "عنوان الإشعار";
      }
      if(pvBody && msgInput){
        pvBody.textContent = (msgInput.value || "").trim() || "سيظهر نص الإشعار هنا…";
      }
      if(pvImportant && impInput){
        pvImportant.style.display = impInput.checked ? "block" : "none";
      }
      if(pvAction && urlInput){
        pvAction.style.display = (urlInput.value || "").trim() ? "inline-flex" : "none";
      }
      if(pvExpires && expInput){
        pvExpires.style.display = (expInput.value || "").trim() ? "inline-flex" : "none";
      }
    }

    [titleInput, msgInput, urlInput, impInput, expInput].forEach(el=>{
      if(el){
        el.addEventListener("input", updatePreview);
        el.addEventListener("change", updatePreview);
      }
    });
    updatePreview();

    // ===== Teachers filter/select-all (checkboxes OR select[multiple]) =====
    const teacherField = document.querySelector('.form-grid .field[data-name*="teachers"]');
    if(teacherField){
      const searchInput = $('#teacherSearch');
      const selCount = $('#selCount');
      const btnSelectAll = $('#selectAllTeachers');
      const btnClearAll = $('#clearAllTeachers');

      const teacherListBox = document.getElementById('teacherList') || teacherField;

      // Determine actual field name (supports prefixes)
      function getTeachersFieldName(){
        const cb = teacherField.querySelector('input[type="checkbox"][name]');
        if(cb && cb.name) return cb.name;

        const ms = teacherField.querySelector('select[multiple][name]');
        if(ms && ms.name) return ms.name;

        return 'teachers';
      }
      const teachersFieldName = getTeachersFieldName();

      const scopeSel = document.getElementById('id_audience_scope');
      const schoolSel = document.getElementById('id_target_school');
      const deptSel = document.getElementById('id_target_department');

      let isLoadingTeachers = false;
      let isLoadingDepts = false;

      function getCheckboxInputs(){
        return Array.from(teacherField.querySelectorAll('input[type="checkbox"][name="' + CSS.escape(teachersFieldName) + '"]'));
      }

      function getMultiSelect(){
        const ms = teacherField.querySelector('select[multiple][name="' + CSS.escape(teachersFieldName) + '"]');
        return ms || teacherField.querySelector('select[multiple]');
      }

      function updateCount(){
        let count = 0;
        const checkboxInputs = getCheckboxInputs();
        const multiSelect = getMultiSelect();

        if(checkboxInputs.length){
          checkboxInputs.forEach(cb => { if(cb.checked) count++; });
        } else if(multiSelect){
          Array.from(multiSelect.options).forEach(op => { if(op.selected) count++; });
        }

        if(selCount) selCount.textContent = String(count);
      }

      function applyFilter(term){
        const q = (term || "").trim().toLowerCase();

        const checkboxInputs = getCheckboxInputs();
        const multiSelect = getMultiSelect();

        if(checkboxInputs.length){
          checkboxInputs.forEach(cb => {
            const wrap = cb.closest('li') || cb.closest('.form-check') || cb.closest('label') || cb.parentElement;
            const txt = (wrap && wrap.textContent || "").toLowerCase();
            const show = !q || txt.includes(q);
            if(wrap) wrap.style.display = show ? "" : "none";
          });
        } else if(multiSelect){
          Array.from(multiSelect.options).forEach(op => {
            const txt = (op.textContent || "").toLowerCase();
            op.hidden = !!q && !txt.includes(q);
          });
        }

        updateCount();
      }

      function toggleAll(select){
        const checkboxInputs = getCheckboxInputs();
        const multiSelect = getMultiSelect();

        if(checkboxInputs.length){
          checkboxInputs.forEach(cb => {
            const wrap = cb.closest('li') || cb.closest('.form-check') || cb.closest('label') || cb.parentElement;
            const hidden = wrap && wrap.style.display === "none";
            if(hidden) return;
            cb.checked = !!select;
          });
        } else if(multiSelect){
          Array.from(multiSelect.options).forEach(op => {
            if(op.hidden) return;
            op.selected = !!select;
          });
        }

        updateCount();
      }

      if(searchInput){
        searchInput.addEventListener('input', () => applyFilter(searchInput.value));
      }
      if(btnSelectAll){
        btnSelectAll.addEventListener('click', () => toggleAll(true));
      }
      if(btnClearAll){
        btnClearAll.addEventListener('click', () => toggleAll(false));
      }

      teacherField.addEventListener('change', updateCount);

      async function refreshTeachers(){
        if(isLoadingTeachers) return;

        if(!scopeSel && !schoolSel && !deptSel) return;

        // Preserve current selections
        const selected = new Set(getCheckboxInputs().filter(cb => cb.checked).map(cb => String(cb.value)));
        const multiSelect = getMultiSelect();
        if(multiSelect){
          Array.from(multiSelect.options).forEach(op => { if(op.selected) selected.add(String(op.value)); });
        }

        const params = new URLSearchParams();
        if(scopeSel && scopeSel.value) params.set('audience_scope', scopeSel.value);
        if(schoolSel && schoolSel.value) params.set('target_school', schoolSel.value);
        if(deptSel && deptSel.value) params.set('target_department', deptSel.value);

        if(params.toString() === '') return;

        const url = '{% url "reports:api_notification_teachers" %}?' + params.toString();
        isLoadingTeachers = true;

        const prevHtml = teacherListBox.innerHTML;
        teacherListBox.innerHTML = '<div class="help">جارٍ تحديث قائمة المستلمين…</div>';
        if(btnSelectAll) btnSelectAll.disabled = true;
        if(btnClearAll) btnClearAll.disabled = true;

        try{
          const res = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
          const payload = await res.json();
          const results = Array.isArray(payload && payload.results) ? payload.results : [];

          if(!results.length){
            teacherListBox.innerHTML = '<div class="help">لا يوجد مستلمون مطابقون للاختيار الحالي.</div>';
            updateCount();
            return;
          }

          const items = ['<ul>'];
          for(const t of results){
            const id = String(t.id);
            const nm = escapeHtml(t.name || '—');
            const checked = selected.has(id) ? ' checked' : '';
            items.push(
              `<li><label><input type="checkbox" name="${escapeHtml(teachersFieldName)}" value="${escapeHtml(id)}"${checked}> <span>${nm}</span></label></li>`
            );
          }
          items.push('</ul>');
          teacherListBox.innerHTML = items.join('');

          if(searchInput) applyFilter(searchInput.value);
          updateCount();
        }catch(e){
          teacherListBox.innerHTML = prevHtml;
          updateCount();
        }finally{
          isLoadingTeachers = false;
          if(btnSelectAll) btnSelectAll.disabled = false;
          if(btnClearAll) btnClearAll.disabled = false;
        }
      }

      async function refreshDepartments(opts){
        const options = opts || {};
        if(!deptSel) return;
        if(isLoadingDepts) return;

        const prevVal = String(deptSel.value || "");
        const params = new URLSearchParams();

        const scopeVal = scopeSel ? String(scopeSel.value || "") : "";
        if(scopeVal !== 'all' && schoolSel && schoolSel.value){
          params.set('school', schoolSel.value);
        }

        const url = '{% url "reports:api_school_departments" %}' + (params.toString() ? ('?' + params.toString()) : '');
        isLoadingDepts = true;
        deptSel.disabled = true;

        const oldOptions = Array.from(deptSel.options).map(o => ({value: o.value, text: o.text, selected: o.selected}));
        deptSel.innerHTML = '<option value="">—</option>';

        try{
          const res = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
          const payload = await res.json();
          const results = Array.isArray(payload && payload.results) ? payload.results : [];

          for(const d of results){
            const opt = document.createElement('option');
            opt.value = String(d.id);
            opt.textContent = d.name || '—';
            deptSel.appendChild(opt);
          }

          if(options.clearSelection){
            deptSel.value = '';
          } else if(prevVal && Array.from(deptSel.options).some(o => o.value === prevVal)){
            deptSel.value = prevVal;
          } else {
            deptSel.value = '';
          }
        }catch(e){
          deptSel.innerHTML = '';
          for(const o of oldOptions){
            const opt = document.createElement('option');
            opt.value = o.value;
            opt.textContent = o.text;
            if(o.selected) opt.selected = true;
            deptSel.appendChild(opt);
          }
        }finally{
          deptSel.disabled = false;
          isLoadingDepts = false;
        }
      }

      if(scopeSel){
        scopeSel.addEventListener('change', async () => {
          await refreshDepartments({clearSelection: true});
          await refreshTeachers();
        });
      }
      if(schoolSel){
        schoolSel.addEventListener('change', async () => {
          await refreshDepartments({clearSelection: true});
          await refreshTeachers();
        });
      }
      if(deptSel){
        deptSel.addEventListener('change', refreshTeachers);
      }

      applyFilter('');
      updateCount();

      try{
        if((scopeSel && scopeSel.value) || (schoolSel && schoolSel.value) || (deptSel && deptSel.value)){
          Promise.resolve(refreshDepartments({clearSelection: false})).then(refreshTeachers);
        }
      }catch(e){ /* ignore */ }
    }

    // ===== Prevent double submit =====
    const form = document.getElementById('notifyForm');
    if(form){
      form.addEventListener('submit', function(){
        const btns = Array.from(form.querySelectorAll('button[type="submit"]'));
        btns.forEach(btn => {
          btn.disabled = true;
          btn.innerHTML = '<span class="loading"></span> جارٍ الإرسال…';
        });
      });
    }
  })();
</script>
{% endblock %}
