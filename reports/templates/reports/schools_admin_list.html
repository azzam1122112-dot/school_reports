{# reports/templates/reports/schools_manage.html (مثال اسم) #}
{% extends "base.html" %}
{% block title %}إدارة المدارس{% endblock %}

{% block head %}
<style>
  /* ✅ Scoped فقط لهذه الصفحة */
  .schools-page{max-width:1100px;margin:0 auto;padding:clamp(10px,2.2vw,18px)}
  .schools-shell{
    background:var(--card);
    border:1px solid var(--line-2);
    border-radius:18px;
    box-shadow:var(--shadow);
    overflow:hidden;
  }

  /* Header */
  .schools-head{
    padding:clamp(16px,2.2vw,22px) clamp(16px,3vw,26px);
    background:
      radial-gradient(900px 220px at 18% 0%, rgba(37,99,235,.18), transparent 55%),
      radial-gradient(700px 220px at 85% 90%, rgba(16,185,129,.14), transparent 60%),
      linear-gradient(135deg, rgba(37,99,235,.92), rgba(59,130,246,.86));
    color:#fff;
  }
  .schools-head-top{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap}
  .schools-title{
    margin:0;
    font-weight:950;
    font-size:clamp(1.15rem,2.4vw,1.6rem);
    display:flex;align-items:center;gap:10px;
  }
  .schools-sub{margin:6px 0 0;opacity:.95;font-weight:850;line-height:1.65}

  .schools-actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
  .schools-actions .btn{border-radius:14px}
  .schools-actions .btn-primary{
    background:rgba(255,255,255,.14);
    border:1px solid rgba(255,255,255,.22);
    color:#fff;
    backdrop-filter: blur(10px);
  }
  .schools-actions .btn-primary:hover{background:rgba(255,255,255,.18)}
  .schools-actions .btn-outline{
    background:rgba(255,255,255,.10);
    border:1px solid rgba(255,255,255,.20);
    color:#fff;
  }

  /* Body */
  .schools-body{padding:clamp(14px,2.6vw,22px)}
  .cardish{
    background:var(--card);
    border:1px solid var(--line-2);
    border-radius:18px;
    box-shadow:var(--shadow-sm);
    padding:14px;
  }

  .topbar{
    display:flex;
    gap:12px;
    align-items:flex-end;
    justify-content:space-between;
    flex-wrap:wrap;
    margin-top:10px;
  }
  .search-wrap{flex:1 1 420px;min-width:240px}
  .lbl{
    display:flex;align-items:center;gap:8px;
    font-weight:950;color:var(--muted);margin:0 0 8px;font-size:.92rem
  }
  .lbl i{opacity:.85}
  .search{
    width:100%;
    min-height:var(--tap);
    border-radius:14px;
    border:1px solid var(--line);
    padding:12px 14px;
    background:rgba(248,250,252,.85);
    font-weight:850;
    transition: box-shadow .18s ease, border-color .18s ease;
  }
  html[data-theme="dark"] .search{
    background: rgba(255,255,255,.04);
    border-color: rgba(148,163,184,.16);
  }
  .search:focus{outline:none;border-color:var(--brand);box-shadow:var(--ring)}
  .count-pill{
    display:inline-flex;align-items:center;gap:8px;
    padding:8px 12px;border-radius:999px;
    border:1px solid var(--line-2);
    background:rgba(248,250,252,.65);
    font-weight:950;color:var(--ink);
    white-space:nowrap;
  }
  html[data-theme="dark"] .count-pill{background:rgba(255,255,255,.03)}
  .count-pill b{color:var(--brand);font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}

  .nores{
    display:none;
    margin-top:12px;
    padding:14px;
    border-radius:16px;
    border:1px solid var(--line-2);
    background:rgba(248,250,252,.65);
    text-align:center;
    font-weight:950;
    color:var(--muted);
  }
  html[data-theme="dark"] .nores{background:rgba(255,255,255,.03)}

  /* Table */
  .table-wrap{overflow:auto;margin-top:12px}
  table.rtable{width:100%}
  table.rtable thead th{white-space:nowrap}

  /* Row actions */
  .row-actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-start}
  .row-actions .btn{border-radius:12px;padding:8px 10px;min-height:36px}
  .btn-danger{background:var(--danger);border-color:var(--danger);color:#fff}

  /* Mobile polish */
  @media(max-width:520px){
    .schools-actions{width:100%}
    .schools-actions .btn{width:100%;justify-content:center}
    .count-pill{width:100%;justify-content:center}
  }
</style>
{% endblock %}

{% block content %}
<div class="schools-page" dir="rtl">
  <div class="schools-shell">

    <div class="schools-head">
      <div class="schools-head-top">
        <div>
          <h1 class="schools-title">
            <i class="fa-solid fa-school" aria-hidden="true"></i>
            إدارة المدارس
          </h1>
          <p class="schools-sub">إدارة المدارس وتعيين مدراء لكل مدرسة، مع بحث سريع داخل القائمة.</p>
        </div>

        <div class="schools-actions">
          <a class="btn btn-primary" href="{% url 'reports:school_create' %}">
            <i class="fa-solid fa-plus" aria-hidden="true"></i>
            إنشاء مدرسة جديدة
          </a>
          <a class="btn btn-outline" href="{% url 'reports:school_manager_create' %}">
            <i class="fa-solid fa-user-tie" aria-hidden="true"></i>
            إنشاء مدير مدرسة
          </a>
        </div>
      </div>
    </div>

    <div class="schools-body">
      <div class="cardish">
        <div class="section-title">قائمة المدارس</div>

        {% if schools %}
          <div class="topbar">
            <div class="search-wrap">
              <label class="lbl" for="schoolSearch">
                <i class="fa-solid fa-magnifying-glass" aria-hidden="true"></i>
                بحث
              </label>
              <input id="schoolSearch"
                     class="search"
                     type="search"
                     placeholder="ابحث باسم المدرسة / الكود / الجوال / المدينة…"
                     autocomplete="off"
                     spellcheck="false">
            </div>

            <div class="count-pill" aria-live="polite">
              <b id="schoolCount">{{ schools|length }}</b>
              مدرسة
            </div>
          </div>

          <div id="schoolNoResults" class="nores">
            لا توجد نتائج مطابقة.
          </div>
        {% endif %}

        {% if schools %}
          <div class="table-wrap table-responsive">
            <table class="rtable">
              <thead>
                <tr>
                  <th style="text-align:right">المدرسة</th>
                  <th>المرحلة</th>
                  <th>بنين/بنات</th>
                  <th>المدينة</th>
                  <th>الجوال</th>
                  <th>الحالة</th>
                  <th>لديه اشتراك؟</th>
                  <th style="text-align:right">المدراء</th>
                  <th>إجراءات</th>
                </tr>
              </thead>
              <tbody>
                {% for item in schools %}
                  {% with s=item.school managers=item.managers %}
                  <tr
                    data-search="{{ s.name|lower }} {{ s.code|default:''|lower }} {{ s.city|default:''|lower }} {{ s.phone|default:''|lower }}{% if managers %} {{ managers|join:' '|lower }}{% endif %}">
                    <td data-label="المدرسة" style="text-align:right">
                      <div style="font-weight:950;color:var(--ink)">{{ s.name }}</div>
                      {% if s.code %}
                        <div class="muted" style="font-weight:850;font-family:ui-monospace,monospace;margin-top:2px">#{{ s.code }}</div>
                      {% endif %}
                    </td>

                    <td data-label="المرحلة">
                      {% if s.get_stage_display %}{{ s.get_stage_display }}{% else %}-{% endif %}
                    </td>

                    <td data-label="بنين/بنات">
                      {% if s.get_gender_display %}{{ s.get_gender_display }}{% else %}-{% endif %}
                    </td>

                    <td data-label="المدينة">{{ s.city|default:"-" }}</td>
                    <td data-label="الجوال" style="font-family:ui-monospace,monospace">{{ s.phone|default:"-" }}</td>

                    <td data-label="الحالة">
                      {% if s.is_active %}
                        <span class="badge success">نشطة</span>
                      {% else %}
                        <span class="badge danger">موقوفة</span>
                      {% endif %}
                    </td>

                    <td data-label="لديه اشتراك؟">
                      {% if s.subscription %}
                        <span class="badge success">نعم</span>
                      {% else %}
                        <span class="badge danger">لا</span>
                      {% endif %}
                    </td>

                    <td data-label="المدراء" style="text-align:right">
                      {% if managers %}
                        {{ managers|join:"، " }}
                      {% else %}
                        <span class="muted" style="font-weight:900">لا يوجد مدير معيَّن</span>
                      {% endif %}
                    </td>

                    <td data-label="إجراءات">
                      <div class="row-actions">
                        <a class="btn btn-outline" href="{% url 'reports:school_profile' s.id %}">بروفايل</a>
                        <a class="btn btn-outline" href="{% url 'reports:school_managers_manage' s.id %}">المدراء</a>
                        <a class="btn btn-outline" href="{% url 'reports:school_update' s.id %}">تعديل</a>

                        <form method="post"
                              action="{% url 'reports:school_delete' s.id %}"
                              style="display:inline"
                              onsubmit="return confirm('سيتم حذف المدرسة وكل بياناتها، هل أنت متأكد؟');">
                          {% csrf_token %}
                          <button type="submit" class="btn btn-danger">حذف</button>
                        </form>
                      </div>
                    </td>
                  </tr>
                  {% endwith %}
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="muted" style="font-weight:900;padding:10px 2px">لا توجد مدارس مضافة بعد.</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script nonce="{{ CSP_NONCE }}">
  (function(){
    const input = document.getElementById('schoolSearch');
    const rows  = Array.from(document.querySelectorAll('table.rtable tbody tr'));
    const count = document.getElementById('schoolCount');
    const empty = document.getElementById('schoolNoResults');

    function applyFilter(){
      if(!input) return;
      const q = (input.value || '').trim().toLowerCase();
      let visible = 0;

      rows.forEach((row)=>{
        const hay = (row.getAttribute('data-search') || '').toLowerCase();
        const ok = !q || hay.includes(q);
        row.style.display = ok ? '' : 'none';
        if(ok) visible += 1;
      });

      if(count) count.textContent = String(visible);
      if(empty) empty.style.display = visible === 0 ? 'block' : 'none';
    }

    if(input){
      input.addEventListener('input', applyFilter);
      applyFilter();
    }
  })();
</script>
{% endblock %}
