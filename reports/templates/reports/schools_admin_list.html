{% extends "base.html" %}
{% block title %}إدارة المدارس{% endblock %}

{% block content %}
<div class="container" dir="rtl">
  <div class="page-head" style="max-width:980px;margin-inline:auto">
    <div>
      <h1 class="page-title">إدارة المدارس</h1>
      <p class="page-subtitle">إدارة المدارس وتعيين مدراء لكل مدرسة.</p>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <a class="btn btn-primary" href="{% url 'reports:school_create' %}">+ إنشاء مدرسة جديدة</a>
      <a class="btn btn-outline" href="{% url 'reports:school_manager_create' %}">+ إنشاء مدير مدرسة جديد</a>
    </div>
  </div>

  <div style="max-width:980px;margin-inline:auto">
    <div class="card">
      <div class="section-title">قائمة المدارس</div>

      {% if schools %}
      <div style="display:flex;gap:10px;align-items:end;flex-wrap:wrap;margin-top:10px">
        <div style="flex:1 1 320px;min-width:240px">
          <label class="muted" for="schoolSearch" style="display:block;font-weight:900;margin-bottom:6px">بحث</label>
          <input id="schoolSearch" class="input" type="search" placeholder="ابحث باسم المدرسة / الكود / الجوال / المدينة…" autocomplete="off" spellcheck="false">
        </div>
        <div class="muted" style="font-weight:900;white-space:nowrap">
          <span id="schoolCount">{{ schools|length }}</span>
          مدرسة
        </div>
      </div>
      <div id="schoolNoResults" class="card" style="display:none;margin-top:12px;padding:14px;text-align:center">
        <span class="muted" style="font-weight:900">لا توجد نتائج مطابقة.</span>
      </div>
      {% endif %}

      {% if schools %}
      <div class="table-responsive">
        <table class="rtable">
          <thead>
            <tr>
              <th>المدرسة</th>
              <th>المرحلة</th>
              <th>بنين/بنات</th>
              <th>المدينة</th>
              <th>الجوال</th>
              <th>الحالة</th>
              <th>المدراء</th>
              <th>إجراءات</th>
            </tr>
          </thead>
          <tbody>
            {% for item in schools %}
              {% with s=item.school managers=item.managers %}
              <tr data-search="{{ s.name|lower }} {{ s.code|lower }} {{ s.city|default:''|lower }} {{ s.phone|default:''|lower }}{% if managers %} {{ managers|join:' '|lower }}{% endif %}">
                <td data-label="المدرسة"><b>{{ s.name }}</b></td>
                <td data-label="المرحلة">{{ s.get_stage_display }}</td>
                <td data-label="بنين/بنات">{{ s.get_gender_display }}</td>
                <td data-label="المدينة">{{ s.city|default:"-" }}</td>
                <td data-label="الجوال">{{ s.phone|default:"-" }}</td>
                <td data-label="الحالة">
                  {% if s.is_active %}
                    <span class="badge success">نشطة</span>
                  {% else %}
                    <span class="badge danger">موقوفة</span>
                  {% endif %}
                </td>
                <td data-label="المدراء">
                  {% if managers %}
                    {{ managers|join:"، " }}
                  {% else %}
                    <span class="muted" style="font-weight:900">لا يوجد مدير معيَّن</span>
                  {% endif %}
                </td>
                <td data-label="إجراءات">
                  <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-start">
                    <a class="btn btn-outline" href="{% url 'reports:school_profile' s.id %}" style="padding:8px 10px">بروفايل</a>
                    <a class="btn btn-outline" href="{% url 'reports:school_managers_manage' s.id %}" style="padding:8px 10px">المدراء</a>
                    <a class="btn btn-outline" href="{% url 'reports:school_update' s.id %}" style="padding:8px 10px">تعديل</a>
                    <form method="post" action="{% url 'reports:school_delete' s.id %}" style="display:inline" onsubmit="return confirm('سيتم حذف المدرسة وكل بياناتها، هل أنت متأكد؟');">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-danger" style="padding:8px 10px">حذف</button>
                    </form>
                  </div>
                </td>
              </tr>
              {% endwith %}
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
        <div class="muted" style="font-weight:900">لا توجد مدارس مضافة بعد.</div>
      {% endif %}
    </div>
  </div>
</div>

<script>
  (function(){
    const input = document.getElementById('schoolSearch');
    const rows = Array.from(document.querySelectorAll('table.rtable tbody tr'));
    const count = document.getElementById('schoolCount');
    const empty = document.getElementById('schoolNoResults');

    function applyFilter(){
      if(!input) return;
      const q = (input.value || '').trim().toLowerCase();
      let visible = 0;
      rows.forEach((row)=>{
        const hay = (row.getAttribute('data-search') || '').toLowerCase();
        const ok = !q || hay.includes(q);
        row.style.display = ok ? '' : 'none';
        if(ok) visible += 1;
      });
      if(count) count.textContent = String(visible);
      if(empty) empty.style.display = visible === 0 ? 'block' : 'none';
    }

    if(input){
      input.addEventListener('input', applyFilter);
      applyFilter();
    }
  })();
</script>
{% endblock %}
