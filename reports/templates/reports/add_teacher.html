{# reports/templates/reports/teacher_form.html (or your file name) #}
{% extends "base.html" %}

{% block title %}{{ page_title|default:"إضافة معلم جديد" }}{% endblock %}

{% block head %}
<style>
  /* ✅ Scoped styles: لا نلمس :root نهائيًا حتى ما نكسر هوية المنصة */
  .teacher-page{max-width:980px;margin:0 auto;padding:clamp(10px,2.2vw,18px)}
  .teacher-page .teacher-shell{
    background:var(--card);
    border:1px solid var(--line-2);
    border-radius:18px;
    box-shadow:var(--shadow);
    overflow:hidden;
    position:relative;
  }

  /* Header */
  .teacher-page .teacher-head{
    padding:clamp(16px,2.2vw,22px) clamp(16px,3vw,26px);
    background:
      radial-gradient(900px 200px at 20% 0%, rgba(37,99,235,.18), transparent 55%),
      radial-gradient(700px 220px at 85% 80%, rgba(16,185,129,.14), transparent 60%),
      linear-gradient(135deg, rgba(37,99,235,.92), rgba(59,130,246,.86));
    color:#fff;
  }
  .teacher-page .teacher-head-top{display:flex;align-items:flex-start;justify-content:space-between;gap:14px;flex-wrap:wrap}
  .teacher-page .teacher-title{
    margin:0;
    font-weight:900;
    font-size:clamp(1.25rem,2.4vw,1.65rem);
    display:flex;align-items:center;gap:10px;
  }
  .teacher-page .teacher-sub{margin:6px 0 0;opacity:.95;font-weight:800}
  .teacher-page .teacher-chip{
    display:inline-flex;align-items:center;gap:8px;
    padding:8px 12px;border-radius:999px;
    background:rgba(255,255,255,.14);
    border:1px solid rgba(255,255,255,.22);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    font-weight:900;
  }

  /* Body */
  .teacher-page .teacher-body{padding:clamp(14px,2.6vw,22px)}
  .teacher-page .tgrid{display:grid;grid-template-columns:repeat(2,minmax(260px,1fr));gap:14px}
  @media(max-width:900px){.teacher-page .tgrid{grid-template-columns:1fr}}

  .teacher-page .group{display:block}
  .teacher-page .label{
    display:flex;align-items:center;gap:10px;
    margin:0 0 8px;
    font-weight:900;
    color:var(--ink);
  }
  .teacher-page .label i{color:rgba(37,99,235,.95)}
  .teacher-page .hint{margin-top:6px;color:var(--muted);font-weight:800;font-size:.88rem}

  /* Inputs */
  .teacher-page .teacher-body input:not([type="checkbox"]),
  .teacher-page .teacher-body select,
  .teacher-page .teacher-body textarea{
    width:100%;
    min-height:var(--tap);
    border-radius:14px;
    border:1px solid var(--line);
    padding:12px 14px;
    background:rgba(248,250,252,.85);
    font-weight:800;
    transition: box-shadow .18s ease, border-color .18s ease, transform .12s ease;
  }
  html[data-theme="dark"] .teacher-page .teacher-body input:not([type="checkbox"]),
  html[data-theme="dark"] .teacher-page .teacher-body select,
  html[data-theme="dark"] .teacher-page .teacher-body textarea{
    background: rgba(255,255,255,.04);
    border-color: rgba(148,163,184,.16);
  }
  .teacher-page .teacher-body input:not([type="checkbox"]):focus,
  .teacher-page .teacher-body select:focus,
  .teacher-page .teacher-body textarea:focus{
    outline:none;
    border-color:var(--brand);
    box-shadow:var(--ring);
  }

  /* Password control */
  .teacher-page .pw-wrap{position:relative}
  .teacher-page .pw-wrap input{padding-inline:44px}
  .teacher-page .pw-ico{
    position:absolute;right:12px;top:50%;transform:translateY(-50%);
    color:rgba(100,116,139,.95);
    pointer-events:none;
  }
  .teacher-page .pw-toggle{
    position:absolute;left:10px;top:50%;transform:translateY(-50%);
    width:40px;height:40px;border-radius:12px;
    border:1px solid rgba(15,23,42,.10);
    background:rgba(255,255,255,.70);
    cursor:pointer;
    display:grid;place-items:center;
    color:rgba(100,116,139,.95);
    transition:transform .12s ease,border-color .12s ease,color .12s ease;
  }
  .teacher-page .pw-toggle:hover{transform:translateY(-50%) translateY(-1px);border-color:rgba(37,99,235,.28);color:var(--brand)}
  html[data-theme="dark"] .teacher-page .pw-toggle{background:rgba(255,255,255,.06);border-color:rgba(148,163,184,.18)}

  /* Switch */
  .teacher-page .switch-row{display:flex;align-items:center;gap:12px}
  .teacher-page .switch{position:relative;width:56px;height:32px;flex:0 0 auto}
  .teacher-page .switch input{opacity:0;width:0;height:0}
  .teacher-page .slider{
    position:absolute;inset:0;border-radius:999px;
    background:#cbd5e1;
    transition:.25s;
  }
  .teacher-page .slider:before{
    content:"";
    position:absolute;top:5px;right:5px;
    width:22px;height:22px;border-radius:50%;
    background:#fff;transition:.25s;
  }
  .teacher-page .switch input:checked + .slider{background:var(--brand)}
  .teacher-page .switch input:checked + .slider:before{transform:translateX(-24px)}
  .teacher-page .switch-meta{display:grid;gap:4px}
  .teacher-page .switch-meta b{font-weight:900}

  /* Errors */
  .teacher-page .field-error{margin-top:6px;color:#b91c1c;font-weight:900;font-size:.9rem}
  html[data-theme="dark"] .teacher-page .field-error{color:#fecaca}

  .teacher-page .nferr{
    margin-bottom:12px;
    padding:12px 14px;
    border-radius:16px;
    border:1px solid rgba(254,202,202,.9);
    background:rgba(254,242,242,.92);
    color:#991b1b;
    font-weight:900;
  }
  html[data-theme="dark"] .teacher-page .nferr{
    background: rgba(239,68,68,.10);
    border-color: rgba(239,68,68,.22);
    color: #fecaca;
  }

  /* Actions */
  .teacher-page .actions{
    margin-top:16px;
    padding-top:14px;
    border-top:1px solid var(--line-2);
    display:flex;
    gap:12px;
    justify-content:flex-start;
    flex-wrap:wrap;
  }
  .teacher-page .actions .btn{border-radius:14px}
  .teacher-page .actions .btn-primary{min-width:200px}
  @media(max-width:560px){
    .teacher-page .actions{flex-direction:column}
    .teacher-page .actions .btn,
    .teacher-page .actions .btn-primary{width:100%}
  }
</style>
{% endblock %}

{% block content %}
<div class="teacher-page">
  <div class="teacher-shell">
    <div class="teacher-head">
      <div class="teacher-head-top">
        <div>
          <h2 class="teacher-title">
            <i class="fas fa-user-plus" aria-hidden="true"></i>
            {{ page_title|default:"إضافة معلم جديد" }}
          </h2>
          <p class="teacher-sub">{{ page_subtitle|default:"أضف بيانات المعلم بدقة — يمكن تعديلها لاحقًا" }}</p>
        </div>
        <div class="teacher-chip">
          <i class="fas fa-shield-halved" aria-hidden="true"></i>
          <span>صلاحيات آمنة</span>
        </div>
      </div>
    </div>

    <div class="teacher-body">
      {% if form.non_field_errors %}
        <div class="nferr" role="alert">
          {% for e in form.non_field_errors %}{{ e }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
        </div>
      {% endif %}

      <form method="POST" novalidate>
        {% csrf_token %}

        <div class="tgrid">
          <!-- الاسم -->
          <div class="group">
            <label class="label" for="{{ form.name.id_for_label }}">
              <i class="fas fa-user" aria-hidden="true"></i> اسم المعلّم
            </label>
            {{ form.name }}
            {% for e in form.name.errors %}<div class="field-error">{{ e }}</div>{% endfor %}
            <div class="hint">الاسم الكامل للمعلم كما سيظهر في النظام</div>
          </div>

          <!-- الهوية -->
          <div class="group">
            <label class="label" for="{{ form.national_id.id_for_label }}">
              <i class="fas fa-id-card" aria-hidden="true"></i> رقم الهوية
            </label>
            {{ form.national_id }}
            {% for e in form.national_id.errors %}<div class="field-error">{{ e }}</div>{% endfor %}
            <div class="hint">اختياري — 10 أرقام</div>
          </div>

          <!-- الجوال -->
          <div class="group">
            <label class="label" for="{{ form.phone.id_for_label }}">
              <i class="fas fa-phone" aria-hidden="true"></i> رقم الجوال
            </label>
            {{ form.phone }}
            {% for e in form.phone.errors %}<div class="field-error">{{ e }}</div>{% endfor %}
            <div class="hint">05XXXXXXXX — يستخدم لتسجيل الدخول</div>
          </div>

          <!-- كلمة المرور -->
          <div class="group">
            <label class="label" for="{{ form.password.id_for_label }}">
              <i class="fas fa-key" aria-hidden="true"></i> كلمة المرور
            </label>
            <div class="pw-wrap">
              {{ form.password }}
              <span class="pw-ico" aria-hidden="true"><i class="fas fa-lock"></i></span>
              <button type="button" class="pw-toggle" id="togglePassword" aria-label="إظهار كلمة المرور">
                <i class="fa-regular fa-eye" aria-hidden="true"></i>
              </button>
            </div>
            {% for e in form.password.errors %}<div class="field-error">{{ e }}</div>{% endfor %}

            {% if form.instance.pk %}
              <div class="hint">اتركها فارغة إذا لا تريد تغيير كلمة المرور</div>
            {% else %}
              <div class="hint">اختر كلمة مرور قوية (8 أحرف فأكثر) — يمكن تغييرها لاحقًا</div>
            {% endif %}
          </div>

          <!-- الدور (اختياري إذا كان موجودًا في الفورم) -->
          {% if form.job_title %}
            <div class="group">
              <label class="label" for="{{ form.job_title.id_for_label }}">
                <i class="fas fa-user-tag" aria-hidden="true"></i> الدور
              </label>
              {{ form.job_title }}
              {% for e in form.job_title.errors %}<div class="field-error">{{ e }}</div>{% endfor %}
              <div class="hint">اختر (معلم / موظف إداري / محضر مختبر) — بنفس الصلاحيات</div>
            </div>
          {% endif %}

          <!-- نشط -->
          <div class="group">
            <div class="label"><i class="fas fa-toggle-on" aria-hidden="true"></i> حالة الحساب</div>
            <div class="switch-row">
              <label class="switch" aria-label="تفعيل حساب المعلم">
                {{ form.is_active }}
                <span class="slider"></span>
              </label>
              <span class="switch-meta">
                <b>نشط</b>
                <span class="hint">تفعيل حساب المعلم للنظام</span>
              </span>
            </div>
            {% for e in form.is_active.errors %}<div class="field-error">{{ e }}</div>{% endfor %}
          </div>
        </div>

        <div class="actions">
          <button type="submit" class="btn btn-primary" id="submitBtn">
            <i class="fas fa-save" aria-hidden="true"></i>
            {{ save_label|default:"حفظ المعلم" }}
          </button>

          {% if back_href %}
            <a href="{{ back_href }}" class="btn">
              <i class="fas fa-arrow-right" aria-hidden="true"></i>
              {{ back_label|default:"رجوع للقائمة" }}
            </a>
          {% else %}
            <a href="{% url 'reports:manage_teachers' %}" class="btn">
              <i class="fas fa-arrow-right" aria-hidden="true"></i>
              {{ back_label|default:"رجوع للقائمة" }}
            </a>
          {% endif %}
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script nonce="{{ CSP_NONCE }}">
  document.addEventListener("DOMContentLoaded", function () {
    const national = document.getElementById('{{ form.national_id.id_for_label }}') || document.getElementById('id_national_id');
    const phone = document.getElementById('{{ form.phone.id_for_label }}') || document.getElementById('id_phone');

    if(national){
      national.setAttribute('inputmode','numeric');
      national.setAttribute('pattern','^\\d{10}$');
      national.setAttribute('maxlength','10');
      national.dir='ltr';
      national.style.textAlign='left';
      national.setAttribute('autocomplete','off');
    }

    if(phone){
      phone.setAttribute('inputmode','tel');
      phone.setAttribute('pattern','^05\\d{8}$');
      phone.setAttribute('maxlength','10');
      phone.dir='ltr';
      phone.style.textAlign='left';
      phone.setAttribute('autocomplete','tel');
    }

    const toggle = document.getElementById("togglePassword");
    const pwd =
      document.getElementById('{{ form.password.id_for_label }}') ||
      document.getElementById('id_password') ||
      document.querySelector('input[type="password"],input[name="password"]');

    if(pwd && pwd.type !== 'password'){
      pwd.type = 'password';
    }
    if(pwd){
      // أفضل للمتصفحات (حتى لو التغيير اختياري عند التعديل)
      pwd.setAttribute('autocomplete','new-password');
    }

    if(toggle && pwd){
      toggle.addEventListener("click", function(){
        const isPwd = pwd.type === "password";
        pwd.type = isPwd ? "text" : "password";
        toggle.setAttribute('aria-label', isPwd ? 'إخفاء كلمة المرور' : 'إظهار كلمة المرور');
        toggle.innerHTML = isPwd
          ? '<i class="fa-regular fa-eye-slash" aria-hidden="true"></i>'
          : '<i class="fa-regular fa-eye" aria-hidden="true"></i>';
      });
    }

    const form = document.querySelector(".teacher-body form");
    const btn = document.getElementById("submitBtn");
    if(form && btn){
      form.addEventListener("submit", function(){
        btn.disabled = true;
        btn.style.opacity = ".75";
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin" aria-hidden="true"></i> جارٍ الحفظ...';
      });
    }
  });
</script>
{% endblock %}
