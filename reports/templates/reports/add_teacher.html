{% extends "base.html" %}
{% block title %}إضافة معلم جديد{% endblock %}

{% block head %}
<style>
  /* ✅ Scoped styles: لا نلمس :root نهائيًا حتى ما نكسر هوية المنصة */
  .teacher-page{max-width:980px;margin:0 auto;padding:clamp(10px,2.2vw,18px)}
  .teacher-shell{
    background:var(--card);
    border:1px solid var(--line-2);
    border-radius:18px;
    box-shadow:var(--shadow);
    overflow:hidden;
    position:relative;
  }

  /* Header */
  .teacher-head{
    padding:clamp(16px,2.2vw,22px) clamp(16px,3vw,26px);
    background:
      radial-gradient(900px 200px at 20% 0%, rgba(37,99,235,.18), transparent 55%),
      radial-gradient(700px 220px at 85% 80%, rgba(16,185,129,.14), transparent 60%),
      linear-gradient(135deg, rgba(37,99,235,.92), rgba(59,130,246,.86));
    color:#fff;
  }
  .teacher-head-top{display:flex;align-items:flex-start;justify-content:space-between;gap:14px;flex-wrap:wrap}
  .teacher-title{
    margin:0;
    font-weight:900;
    font-size:clamp(1.25rem,2.4vw,1.65rem);
    display:flex;align-items:center;gap:10px;
  }
  .teacher-sub{margin:6px 0 0;opacity:.95;font-weight:800}
  .teacher-chip{
    display:inline-flex;align-items:center;gap:8px;
    padding:8px 12px;border-radius:999px;
    background:rgba(255,255,255,.14);
    border:1px solid rgba(255,255,255,.22);
    backdrop-filter: blur(10px);
    font-weight:900;
  }

  /* Body */
  .teacher-body{padding:clamp(14px,2.6vw,22px)}
  .grid{display:grid;grid-template-columns:repeat(2,minmax(260px,1fr));gap:14px}
  @media(max-width:900px){.grid{grid-template-columns:1fr}}

  .group{display:block}
  .label{
    display:flex;align-items:center;gap:10px;
    margin:0 0 8px;
    font-weight:900;
    color:var(--ink);
  }
  .label i{color:rgba(37,99,235,.95)}
  .hint{margin-top:6px;color:var(--muted);font-weight:800;font-size:.88rem}

  /* Inputs: نستخدم أسلوب المنصة (نفس app.css) */
  .teacher-body input:not([type="checkbox"]),
  .teacher-body select,
  .teacher-body textarea{
    width:100%;
    min-height:var(--tap);
    border-radius:14px;
    border:1px solid var(--line);
    padding:12px 14px;
    background:rgba(248,250,252,.85);
    font-weight:800;
    transition: box-shadow .18s ease, border-color .18s ease, transform .12s ease;
  }
  html[data-theme="dark"] .teacher-body input:not([type="checkbox"]),
  html[data-theme="dark"] .teacher-body select,
  html[data-theme="dark"] .teacher-body textarea{
    background: rgba(255,255,255,.04);
    border-color: rgba(148,163,184,.16);
  }
  .teacher-body input:not([type="checkbox"]):focus,
  .teacher-body select:focus,
  .teacher-body textarea:focus{
    outline:none;
    border-color:var(--brand);
    box-shadow:var(--ring);
  }

  /* Password control */
  .pw-wrap{position:relative}
  .pw-wrap input{padding-inline:44px} /* يمين ويسار */
  .pw-ico{
    position:absolute;right:12px;top:50%;transform:translateY(-50%);
    color:rgba(100,116,139,.95);
    pointer-events:none;
  }
  .pw-toggle{
    position:absolute;left:10px;top:50%;transform:translateY(-50%);
    width:40px;height:40px;border-radius:12px;
    border:1px solid rgba(15,23,42,.10);
    background:rgba(255,255,255,.70);
    cursor:pointer;
    display:grid;place-items:center;
    color:rgba(100,116,139,.95);
    transition:transform .12s ease,border-color .12s ease,color .12s ease;
  }
  .pw-toggle:hover{transform:translateY(-50%) translateY(-1px);border-color:rgba(37,99,235,.28);color:var(--brand)}
  html[data-theme="dark"] .pw-toggle{background:rgba(255,255,255,.06);border-color:rgba(148,163,184,.18)}

  /* Switch */
  .switch-row{display:flex;align-items:center;gap:12px}
  .switch{position:relative;width:56px;height:32px;flex:0 0 auto}
  .switch input{opacity:0;width:0;height:0}
  .slider{
    position:absolute;inset:0;border-radius:999px;
    background:#cbd5e1;
    transition:.25s;
  }
  .slider:before{
    content:"";
    position:absolute;top:5px;right:5px; /* RTL: تبدأ من اليمين */
    width:22px;height:22px;border-radius:50%;
    background:#fff;transition:.25s;
  }
  .switch input:checked + .slider{background:var(--brand)}
  .switch input:checked + .slider:before{transform:translateX(-24px)} /* RTL */
  .switch-meta{display:grid;gap:4px}
  .switch-meta b{font-weight:900}

  /* Select caret */
  .select-wrap{position:relative}
  .select-wrap select{appearance:none;padding-left:44px}
  .caret{
    position:absolute;left:14px;top:50%;transform:translateY(-50%);
    color:rgba(100,116,139,.95);
    pointer-events:none;
  }

  /* Errors */
  .field-error{margin-top:6px;color:#b91c1c;font-weight:900;font-size:.9rem}
  html[data-theme="dark"] .field-error{color:#fecaca}

  /* non-field error box */
  .nferr{
    margin-bottom:12px;
    padding:12px 14px;
    border-radius:16px;
    border:1px solid rgba(254,202,202,.9);
    background:rgba(254,242,242,.92);
    color:#991b1b;
    font-weight:900;
  }

  /* Actions */
  .actions{
    margin-top:16px;
    padding-top:14px;
    border-top:1px solid var(--line-2);
    display:flex;
    gap:12px;
    justify-content:flex-start;
    flex-wrap:wrap;
  }
  .actions .btn{border-radius:14px}
  .actions .btn-primary{min-width:200px}
  @media(max-width:560px){
    .actions{flex-direction:column}
    .actions .btn,
    .actions .btn-primary{width:100%}
  }
</style>
{% endblock %}

{% block content %}
<div class="teacher-page">
  <div class="teacher-shell">
    <div class="teacher-head">
      <div class="teacher-head-top">
        <div>
          <h2 class="teacher-title">
            <i class="fas fa-user-plus" aria-hidden="true"></i>
            إضافة معلم جديد
          </h2>
          <p class="teacher-sub">أضف بيانات المعلم بدقة — يمكن تعديلها لاحقًا</p>
        </div>
        <div class="teacher-chip">
          <i class="fas fa-shield-halved" aria-hidden="true"></i>
          <span>صلاحيات آمنة</span>
        </div>
      </div>
    </div>

    <div class="teacher-body">
      {% if form.non_field_errors %}
        <div class="nferr" role="alert">
          {% for e in form.non_field_errors %}{{ e }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
        </div>
      {% endif %}

      <form method="POST" novalidate>
        {% csrf_token %}

        <div class="grid">
          <!-- الاسم -->
          <div class="group">
            <label class="label" for="{{ form.name.id_for_label }}">
              <i class="fas fa-user" aria-hidden="true"></i> اسم المعلّم
            </label>
            {{ form.name }}
            {% for e in form.name.errors %}<div class="field-error">{{ e }}</div>{% endfor %}
            <div class="hint">الاسم الكامل للمعلم كما سيظهر في النظام</div>
          </div>

          <!-- الهوية -->
          <div class="group">
            <label class="label" for="{{ form.national_id.id_for_label }}">
              <i class="fas fa-id-card" aria-hidden="true"></i> رقم الهوية
            </label>
            {{ form.national_id }}
            {% for e in form.national_id.errors %}<div class="field-error">{{ e }}</div>{% endfor %}
            <div class="hint">اختياري — 10 أرقام</div>
          </div>

          <!-- الجوال -->
          <div class="group">
            <label class="label" for="{{ form.phone.id_for_label }}">
              <i class="fas fa-phone" aria-hidden="true"></i> رقم الجوال
            </label>
            {{ form.phone }}
            {% for e in form.phone.errors %}<div class="field-error">{{ e }}</div>{% endfor %}
            <div class="hint">05XXXXXXXX — يستخدم لتسجيل الدخول</div>
          </div>

          <!-- كلمة المرور -->
          <div class="group">
            <label class="label" for="{{ form.password.id_for_label }}">
              <i class="fas fa-key" aria-hidden="true"></i> كلمة المرور
            </label>
            <div class="pw-wrap">
              {{ form.password }}
              <span class="pw-ico" aria-hidden="true"><i class="fas fa-lock"></i></span>
              <button type="button" class="pw-toggle" id="togglePassword" aria-label="إظهار كلمة المرور">
                <i class="fa-regular fa-eye" aria-hidden="true"></i>
              </button>
            </div>
            {% for e in form.password.errors %}<div class="field-error">{{ e }}</div>{% endfor %}
            <div class="hint">اتركها فارغة عند التعديل إذا لا تريد تغييرها</div>
          </div>

          <!-- نشط -->
          <div class="group">
            <div class="label"><i class="fas fa-toggle-on" aria-hidden="true"></i> حالة الحساب</div>
            <div class="switch-row">
              <span class="switch">
                {{ form.is_active }}
                <span class="slider"></span>
              </span>
              <span class="switch-meta">
                <b>نشط</b>
                <span class="hint">تفعيل حساب المعلم للنظام</span>
              </span>
            </div>
            {% for e in form.is_active.errors %}<div class="field-error">{{ e }}</div>{% endfor %}
          </div>

          <!-- القسم -->
          <div class="group">
            <label class="label" for="{{ form.department.id_for_label }}">
              <i class="fas fa-building" aria-hidden="true"></i> القسم
            </label>
            <div class="select-wrap">
              {{ form.department }}
              <span class="caret" aria-hidden="true"><i class="fas fa-chevron-down"></i></span>
            </div>
            {% for e in form.department.errors %}<div class="field-error">{{ e }}</div>{% endfor %}
            <div class="hint">اختر القسم الذي يتبع له المعلّم</div>
          </div>

          <!-- الدور داخل القسم -->
          <div class="group">
            <label class="label" for="{{ form.membership_role.id_for_label }}">
              <i class="fas fa-user-shield" aria-hidden="true"></i> الدور داخل القسم
            </label>
            <div class="select-wrap">
              {{ form.membership_role }}
              <span class="caret" aria-hidden="true"><i class="fas fa-chevron-down"></i></span>
            </div>
            {% for e in form.membership_role.errors %}<div class="field-error">{{ e }}</div>{% endfor %}
            <div class="hint">“مسؤول القسم” يمنح صلاحيات الاطلاع على تقارير القسم</div>
          </div>
        </div>

        <div class="actions">
          <button type="submit" class="btn btn-primary" id="submitBtn">
            <i class="fas fa-save" aria-hidden="true"></i>
            حفظ المعلم
          </button>

          <a href="{% url 'reports:manage_teachers' %}" class="btn">
            <i class="fas fa-arrow-right" aria-hidden="true"></i>
            رجوع للقائمة
          </a>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // تحسين الإدخال للجوال/الهوية بدون تعديل الـ Form widgets
    const national = document.getElementById('{{ form.national_id.id_for_label }}') || document.getElementById('id_national_id');
    const phone = document.getElementById('{{ form.phone.id_for_label }}') || document.getElementById('id_phone');

    if(national){
      national.setAttribute('inputmode','numeric');
      national.setAttribute('pattern','\\d{10}');
      national.setAttribute('maxlength','10');
      national.dir='ltr';
      national.style.textAlign='left';
    }
    if(phone){
      phone.setAttribute('inputmode','tel');
      phone.setAttribute('pattern','05\\d{8}');
      phone.setAttribute('maxlength','10');
      phone.dir='ltr';
      phone.style.textAlign='left';
    }

    // إظهار/إخفاء كلمة المرور
    const toggle = document.getElementById("togglePassword");
    const pwd = document.getElementById('{{ form.password.id_for_label }}') || document.getElementById('id_password') || document.querySelector('input[type="password"]');
    if(toggle && pwd){
      toggle.addEventListener("click", function(){
        const isPwd = pwd.type === "password";
        pwd.type = isPwd ? "text" : "password";
        toggle.setAttribute('aria-label', isPwd ? 'إخفاء كلمة المرور' : 'إظهار كلمة المرور');
        toggle.innerHTML = isPwd ? '<i class="fa-regular fa-eye-slash" aria-hidden="true"></i>' : '<i class="fa-regular fa-eye" aria-hidden="true"></i>';
      });
    }

    // منع الإرسال المزدوج (بدون فقدان الأيقونة)
    const form = document.querySelector(".teacher-body form");
    const btn = document.getElementById("submitBtn");
    if(form && btn){
      form.addEventListener("submit", function(){
        btn.disabled = true;
        btn.style.opacity = ".75";
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin" aria-hidden="true"></i> جارٍ الحفظ...';
      });
    }

    // ضبط خيارات الدور داخل قسم "المعلمين" (تعطيل officer)
    const dept = document.getElementById('{{ form.department.id_for_label }}') || document.getElementById('id_department');
    const role = document.getElementById('{{ form.membership_role.id_for_label }}') || document.getElementById('id_membership_role');

    const TEACHERS = new Set(["teachers","معلمين","المعلمين"]);
    function adjustRoleChoices(){
      if(!dept || !role) return;
      const val = (dept.value || "").trim().toLowerCase();
      const isTeachers = TEACHERS.has(val);

      for(const opt of (role.options || [])){
        if((opt.value || "").toLowerCase() === "officer"){
          opt.disabled = isTeachers;
          if(isTeachers && (role.value || "").toLowerCase() === "officer"){
            for(const o of role.options){
              if((o.value || "").toLowerCase() === "teacher"){ role.value = o.value; break; }
            }
          }
        }
      }
    }
    if(dept){
      dept.addEventListener("change", adjustRoleChoices);
      adjustRoleChoices();
    }
  });
</script>
{% endblock %}
