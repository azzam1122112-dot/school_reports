{# reports/templates/reports/platform_subscriptions_list.html #}
{% extends "base.html" %}

{% block title %}إدارة الاشتراكات{% endblock %}

{% block head %}
<style>
  /* ✅ Scoped فقط لهذه الصفحة — بدون لمس .btn / .card العامة */
  .subslist-scope{
    --sl-brand: var(--brand, #2563eb);
    --sl-ink: var(--ink, #0f172a);
    --sl-muted: var(--muted, #64748b);
    --sl-line: var(--line-2, var(--line, #e5e7eb));
    --sl-card: var(--card, #fff);
    --sl-shadow: var(--shadow, 0 14px 36px rgba(2,6,23,.10));
    --sl-danger: var(--danger, #ef4444);
    --sl-ok: var(--accent, #10b981);
    --sl-warn: #f59e0b;
    --sl-grad: linear-gradient(135deg, rgba(37,99,235,.95), rgba(59,130,246,.88));
    --sl-grad-2: linear-gradient(135deg, rgba(15,23,42,.94), rgba(30,41,59,.86));
    --sl-t: var(--t-fast, 180ms ease);
  }

  .subslist-scope .wrap{max-width:1100px;margin-inline:auto}

  .subslist-scope .kpis{
    display:grid;
    grid-template-columns: repeat(4, minmax(190px, 1fr));
    gap: 12px;
    margin: 12px 0 14px;
  }
  @media(max-width:980px){
    .subslist-scope .kpis{grid-template-columns: repeat(2, minmax(160px, 1fr));}
  }
  @media(max-width:520px){
    .subslist-scope .kpis{grid-template-columns:1fr;}
  }

  .subslist-scope .kpi{
    background: var(--sl-card);
    border:1px solid var(--sl-line);
    border-radius: 16px;
    box-shadow: var(--sl-shadow);
    padding: 14px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 12px;
  }
  .subslist-scope .kpi .meta{display:grid;gap:4px;min-width:0}
  .subslist-scope .kpi .label{color:var(--sl-muted);font-weight:900}
  .subslist-scope .kpi .value{font-weight:950;font-size:1.25rem;color:var(--sl-ink)}
  .subslist-scope .kpi .chip{
    width: 44px;
    height: 44px;
    border-radius: 14px;
    display:flex;
    align-items:center;
    justify-content:center;
    background: rgba(37,99,235,.10);
    color: var(--sl-brand);
    border: 1px solid rgba(37,99,235,.14);
    flex: 0 0 auto;
  }
  .subslist-scope .kpi.ok .chip{background: rgba(16,185,129,.10); color: var(--sl-ok); border-color: rgba(16,185,129,.16)}
  .subslist-scope .kpi.bad .chip{background: rgba(239,68,68,.10); color: var(--sl-danger); border-color: rgba(239,68,68,.16)}
  .subslist-scope .kpi.warn .chip{background: rgba(245,158,11,.12); color: var(--sl-warn); border-color: rgba(245,158,11,.18)}

  /* Hero */
  .subslist-scope .hero{
    padding: 16px 18px;
    border-radius: 16px;
    color:#fff;
    background:
      radial-gradient(900px 240px at 15% 0%, rgba(16,185,129,.16), transparent 55%),
      radial-gradient(700px 220px at 90% 70%, rgba(255,255,255,.14), transparent 60%),
      var(--sl-grad);
    border: 1px solid rgba(255,255,255,.14);
    box-shadow: var(--sl-shadow);
    margin-bottom: 12px;
  }
  .subslist-scope .hero-head{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:12px;
    flex-wrap:wrap;
  }
  .subslist-scope .hero h1{
    margin:0;
    font-weight:950;
    font-size:clamp(1.15rem,2.4vw,1.55rem);
  }
  .subslist-scope .hero p{
    margin:6px 0 0;
    opacity:.95;
    font-weight:850;
    line-height:1.65;
    max-width:68ch;
  }
  .subslist-scope .hero-actions{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
  }

  /* أزرار داخل الهيرو فقط */
  .subslist-scope .hero-actions .btn{
    border-radius: 14px;
    min-height: 44px;
    transition: var(--sl-t);
  }
  .subslist-scope .hero-actions .btn:hover{
    transform: translateY(-1px);
  }
  .subslist-scope .hero-actions .btn-outline{
    background: rgba(255,255,255,.12);
    border-color: rgba(255,255,255,.22);
    color:#fff;
  }
  .subslist-scope .hero-actions .btn-outline:hover{
    background: rgba(255,255,255,.16);
    border-color: rgba(255,255,255,.28);
  }

  /* Cards */
  .subslist-scope .fcard,
  .subslist-scope .tcard{
    border:1px solid var(--sl-line);
    border-radius: 16px;
    box-shadow: var(--sl-shadow);
  }
  .subslist-scope .fcard{
    padding: 14px;
    margin-bottom: 14px;
  }
  .subslist-scope .tcard{
    overflow:hidden;
  }

  /* Filters */
  .subslist-scope .filters{
    display:grid;
    gap: 12px;
    grid-template-columns: repeat(3, minmax(220px, 1fr));
    align-items:end;
  }
  .subslist-scope .filters .f-actions{
    display:flex;
    gap: 10px;
    flex-wrap: wrap;
    justify-content:flex-start;
  }
  @media(max-width:860px){
    .subslist-scope .filters{grid-template-columns:1fr}
  }

  .subslist-scope .f-label{
    display:block;
    margin-bottom: 6px;
    color: var(--sl-muted);
    font-weight: 900;
  }
  .subslist-scope .filters select{
    width:100%;
    min-height: 44px;
  }
  .subslist-scope .filters input[type="search"]{
    width:100%;
    min-height: 44px;
  }
  .subslist-scope .filters .btn{
    min-height: 44px;
    justify-content:center;
    border-radius: 14px;
  }

  /* Table (نعتمد rtable من app.css، فقط تحسينات خفيفة) */
  .subslist-scope .rtable thead th{font-weight:950}
  .subslist-scope .school{font-weight:950;color:var(--sl-ink)}

  /* Row actions */
  .subslist-scope .row-actions{
    display:flex;
    gap: 8px;
    flex-wrap: wrap;
    justify-content:flex-start;
  }
  .subslist-scope .row-actions .btn{
    min-height: 38px;
    padding: 8px 10px;
    border-radius: 12px;
  }

  .subslist-scope .row-actions .btn-danger{
    background: rgba(239,68,68,.10);
    border-color: rgba(239,68,68,.22);
    color: var(--sl-danger);
  }
  .subslist-scope .row-actions .btn-danger:hover{
    background: rgba(239,68,68,.14);
    border-color: rgba(239,68,68,.30);
  }

  /* Badges fallback */
  .subslist-scope .badge{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding: 5px 10px;
    border-radius: 999px;
    font-weight: 900;
    font-size: .86rem;
    border: 1px solid rgba(15,23,42,.08);
    background: rgba(148,163,184,.15);
    color: var(--sl-ink);
    white-space:nowrap;
  }
  .subslist-scope .badge.success{
    background: rgba(16,185,129,.12);
    border-color: rgba(16,185,129,.22);
    color: var(--sl-ok);
  }
  .subslist-scope .badge.danger{
    background: rgba(239,68,68,.12);
    border-color: rgba(239,68,68,.22);
    color: var(--sl-danger);
  }

  /* Mobile tweaks */
  @media(max-width:520px){
    .subslist-scope .hero{padding:14px}
    .subslist-scope .hero-actions .btn{width:100%;justify-content:center}
    .subslist-scope .row-actions .btn{width:100%}
  }

  /* Reduce motion */
  @media (prefers-reduced-motion: reduce){
    .subslist-scope .hero-actions .btn{transition:none !important}
    .subslist-scope .hero-actions .btn:hover{transform:none !important}
  }
</style>
{% endblock %}

{% block content %}
<div class="container subslist-scope" dir="rtl">
  <div class="wrap">

    <section class="hero" aria-label="رأس إدارة الاشتراكات">
      <div class="hero-head">
        <div>
          <h1>إدارة الاشتراكات</h1>
          <p>تجديد وتعديل اشتراكات المدارس على مستوى المنصة.</p>
        </div>

        <div class="hero-actions">
          <a href="{% url 'reports:platform_subscription_add' %}" class="btn btn-primary">
            <i class="fa-solid fa-plus" aria-hidden="true"></i>
            إضافة اشتراك
          </a>
          <a href="{% url 'reports:platform_admin_dashboard' %}" class="btn btn-outline">
            <i class="fa-solid fa-arrow-right" aria-hidden="true"></i>
            عودة للوحة المنصة
          </a>
        </div>
      </div>
    </section>

    <section class="kpis" aria-label="ملخص الاشتراكات">
      <div class="kpi">
        <div class="meta">
          <div class="label">إجمالي الاشتراكات</div>
          <div class="value">{{ stats_total|default:0 }}</div>
        </div>
        <div class="chip" aria-hidden="true"><i class="fa-solid fa-layer-group"></i></div>
      </div>

      <div class="kpi ok">
        <div class="meta">
          <div class="label">اشتراكات سارية</div>
          <div class="value">{{ stats_active|default:0 }}</div>
        </div>
        <div class="chip" aria-hidden="true"><i class="fa-solid fa-circle-check"></i></div>
      </div>

      <div class="kpi bad">
        <div class="meta">
          <div class="label">اشتراكات ملغاة</div>
          <div class="value">{{ stats_cancelled|default:0 }}</div>
        </div>
        <div class="chip" aria-hidden="true"><i class="fa-solid fa-ban"></i></div>
      </div>

      <div class="kpi warn">
        <div class="meta">
          <div class="label">اشتراكات منتهية</div>
          <div class="value">{{ stats_expired|default:0 }}</div>
        </div>
        <div class="chip" aria-hidden="true"><i class="fa-solid fa-triangle-exclamation"></i></div>
      </div>
    </section>

    <div class="card fcard">
      <form method="get" class="filters" novalidate>
        <div>
          <label class="f-label">فلترة حسب الاشتراك</label>
          <select name="status" class="input">
            <option value="all" {% if status == 'all' or not status %}selected{% endif %}>الكل</option>
            <option value="active" {% if status == 'active' %}selected{% endif %}>ساري</option>
            <option value="cancelled" {% if status == 'cancelled' %}selected{% endif %}>ملغي</option>
            <option value="expired" {% if status == 'expired' %}selected{% endif %}>منتهي</option>
          </select>
        </div>

        <div>
          <label class="f-label">حسب الباقة</label>
          <select name="plan" class="input">
            <option value="" {% if not plan_id %}selected{% endif %}>كل الباقات</option>
            {% for p in plans %}
              <option value="{{ p.id }}" {% if plan_id|stringformat:'s' == p.id|stringformat:'s' %}selected{% endif %}>
                {{ p.name }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div>
          <label class="f-label">بحث باسم المدرسة</label>
          <input type="search" name="q" class="input" placeholder="اكتب اسم المدرسة..." value="{{ q|default:'' }}">
        </div>

        <div class="f-actions">
          <button type="submit" class="btn btn-outline">
            <i class="fa-solid fa-filter" aria-hidden="true"></i>
            تطبيق
          </button>

          {% if plan_id or status and status != 'all' %}
            <a href="{% url 'reports:platform_subscriptions_list' %}" class="btn btn-outline">
              <i class="fa-solid fa-rotate-left" aria-hidden="true"></i>
              مسح الفلتر
            </a>
          {% endif %}
        </div>
      </form>
    </div>

    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin:8px 2px 10px;">
      <div class="muted" style="font-weight:900">عرض {{ results_count|default:0 }} نتيجة</div>
    </div>

    <div class="card tcard table-responsive">
      <table class="rtable">
        <thead>
          <tr>
            <th style="text-align:right">المدرسة</th>
            <th style="text-align:right">الخطة</th>
            <th>تاريخ البدء</th>
            <th>تاريخ الانتهاء</th>
            <th>الحالة</th>
            <th>إجراءات</th>
          </tr>
        </thead>
        <tbody>
          {% for sub in subscriptions %}
            <tr>
              <td data-label="المدرسة" style="text-align:right">
                <span class="school">{{ sub.school.name }}</span>
              </td>

              <td data-label="الخطة" style="text-align:right">
                {{ sub.plan.name }}
              </td>

              <td data-label="البدء">
                {{ sub.start_date|date:"Y-m-d" }}
              </td>

              <td data-label="الانتهاء">
                {{ sub.end_date|date:"Y-m-d" }}
              </td>

              <td data-label="الحالة">
                {% if sub.is_cancelled %}
                  <span class="badge danger"><i class="fa-solid fa-ban" aria-hidden="true"></i> ملغي</span>
                  {% if sub.cancel_reason %}
                    <div class="muted" style="margin-top:6px">
                      <span style="font-weight:950">سبب الإلغاء:</span>
                      {{ sub.cancel_reason }}
                    </div>
                  {% endif %}
                  <div class="muted" style="margin-top:6px">
                    <span style="font-weight:950">المبلغ المسترجع:</span>
                    {{ sub.refund_amount_for_period|default:0 }} ريال
                  </div>
                {% elif sub.is_expired %}
                  <span class="badge danger"><i class="fa-solid fa-circle-xmark" aria-hidden="true"></i> منتهي</span>
                {% else %}
                  <span class="badge success"><i class="fa-solid fa-circle-check" aria-hidden="true"></i> ساري</span>
                {% endif %}
              </td>

              <td data-label="إجراء">
                <div class="row-actions">
                  <form method="post" action="{% url 'reports:platform_subscription_renew' sub.id %}" style="display:inline">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="{{ request.get_full_path }}">

                    <button
                      type="submit"
                      class="btn btn-primary"
                      data-confirm="تأكيد تجديد الاشتراك؟"
                    >
                      <i class="fa-solid fa-rotate" aria-hidden="true"></i>
                      تجديد
                    </button>
                  </form>

                  {% if sub.is_active and not sub.has_payment_for_period and sub.plan.price %}
                    <form method="post" action="{% url 'reports:platform_subscription_record_payment' sub.id %}" style="display:inline">
                      {% csrf_token %}
                      <input type="hidden" name="next" value="{{ request.get_full_path }}">
                      <button
                        type="submit"
                        class="btn btn-outline"
                        data-confirm="تسجيل دفعة لهذا الاشتراك؟"
                      >
                        <i class="fa-solid fa-receipt" aria-hidden="true"></i>
                        تسجيل دفعة
                      </button>
                    </form>
                  {% endif %}

                  <a href="{% url 'reports:platform_subscription_edit' sub.id %}" class="btn btn-outline">
                    <i class="fa-solid fa-pen" aria-hidden="true"></i>
                    تعديل
                  </a>

                  <form method="post" action="{% url 'reports:platform_subscription_delete' sub.id %}" style="display:inline">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="{{ request.get_full_path }}">
                    <input type="hidden" name="reason" value="{{ sub.cancel_reason|default:'' }}">
                    <input type="hidden" name="refund_amount" value="">

                    <button
                      type="submit"
                      class="btn btn-outline btn-danger"
                      data-reason-prompt="سبب الإلغاء (سيظهر للمدرسة):"
                      data-refund-prompt="استرجاع مبلغ؟ اتركه فارغًا بدون استرجاع. اكتب (كامل) للاسترجاع الكامل أو اكتب رقمًا مثل 150.00 للاسترجاع الجزئي."
                      data-confirm="سيتم إلغاء اشتراك مدرسة: {{ sub.school.name }}. هل أنت متأكد؟"
                    >
                      <i class="fa-solid fa-ban" aria-hidden="true"></i>
                      إلغاء
                    </button>
                  </form>
                </div>
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="6" style="padding:20px;text-align:center" class="muted">
                لا توجد اشتراكات مسجلة.
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  (function(){
    // تأكيدات آمنة بدون inline onclick
    var buttons = document.querySelectorAll('.subslist-scope [data-confirm]');
    if(!buttons || !buttons.length) return;

    for(var i=0;i<buttons.length;i++){
      buttons[i].addEventListener('click', function(ev){
        // لو كان هذا الزر خاص بـ "إلغاء الاشتراك": اجلب سبب الإلغاء
        var promptLabel = this.getAttribute('data-reason-prompt');
        if(promptLabel){
          var form = this.closest ? this.closest('form') : null;
          var reasonInput = form ? form.querySelector('input[name="reason"]') : null;
          var refundInput = form ? form.querySelector('input[name="refund_amount"]') : null;
          var current = reasonInput && reasonInput.value ? reasonInput.value : '';
          var reason = window.prompt(promptLabel, current);
          if(reason === null){
            ev.preventDefault();
            ev.stopPropagation();
            return false;
          }
          reason = (reason || '').trim();
          if(!reason){
            window.alert('سبب الإلغاء مطلوب.');
            ev.preventDefault();
            ev.stopPropagation();
            return false;
          }
          if(reasonInput){
            reasonInput.value = reason;
          }

          // خيار استرجاع مبلغ (اختياري)
          var refundPrompt = this.getAttribute('data-refund-prompt');
          if(refundPrompt && refundInput){
            var currentRefund = refundInput.value ? refundInput.value : '';
            var refund = window.prompt(refundPrompt, currentRefund);
            if(refund === null){
              // إلغاء كامل العملية
              ev.preventDefault();
              ev.stopPropagation();
              return false;
            }
            refund = (refund || '').trim();
            refundInput.value = refund; // قد يكون فارغًا (بدون استرجاع)
          }
        }

        var msg = this.getAttribute('data-confirm') || 'هل أنت متأكد؟';
        if(!window.confirm(msg)){
          ev.preventDefault();
          ev.stopPropagation();
          return false;
        }
      });
    }
  })();
</script>
{% endblock %}
