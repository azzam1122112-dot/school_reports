{% extends "base.html" %}
{% block title %}إدارة الاشتراكات{% endblock %}

{% block content %}
<div class="container" dir="rtl">
  <div class="page-head">
    <div>
      <h1 class="page-title">إدارة الاشتراكات</h1>
      <p class="page-subtitle">تجديد وتعديل اشتراكات المدارس على مستوى المنصة.</p>
    </div>
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <a href="{% url 'reports:platform_subscription_add' %}" class="btn btn-primary">إضافة اشتراك</a>
      <a href="{% url 'reports:platform_admin_dashboard' %}" class="btn btn-outline">عودة للوحة المنصة</a>
    </div>
  </div>

  <div class="card" style="padding:14px;margin-bottom:14px">
    <form method="get" style="display:flex;gap:10px;align-items:end;flex-wrap:wrap">
      <div>
        <label class="muted" style="font-weight:900;display:block;margin-bottom:6px">فلترة حسب الاشتراك</label>
        <select name="status" class="input" style="min-width:220px">
          <option value="all" {% if status == 'all' or not status %}selected{% endif %}>الكل</option>
          <option value="active" {% if status == 'active' %}selected{% endif %}>ساري</option>
          <option value="expired" {% if status == 'expired' %}selected{% endif %}>منتهي</option>
        </select>
      </div>

      <div>
        <label class="muted" style="font-weight:900;display:block;margin-bottom:6px">حسب الباقة</label>
        <select name="plan" class="input" style="min-width:240px">
          <option value="" {% if not plan_id %}selected{% endif %}>كل الباقات</option>
          {% for p in plans %}
            <option value="{{ p.id }}" {% if plan_id|stringformat:'s' == p.id|stringformat:'s' %}selected{% endif %}>{{ p.name }}</option>
          {% endfor %}
        </select>
      </div>

      <button type="submit" class="btn btn-outline" style="min-height:44px">تطبيق</button>
      {% if plan_id or status and status != 'all' %}
        <a href="{% url 'reports:platform_subscriptions_list' %}" class="btn btn-outline" style="min-height:44px">مسح الفلتر</a>
      {% endif %}
    </form>
  </div>

  <div class="card table-responsive">
    <table class="rtable">
      <thead>
        <tr>
          <th style="text-align:right">المدرسة</th>
          <th style="text-align:right">الخطة</th>
          <th>تاريخ البدء</th>
          <th>تاريخ الانتهاء</th>
          <th>الحالة</th>
          <th>إجراءات</th>
        </tr>
      </thead>
      <tbody>
        {% for sub in subscriptions %}
        <tr>
          <td data-label="المدرسة" style="text-align:right;font-weight:950">{{ sub.school.name }}</td>
          <td data-label="الخطة" style="text-align:right">{{ sub.plan.name }}</td>
          <td data-label="البدء">{{ sub.start_date|date:"Y-m-d" }}</td>
          <td data-label="الانتهاء">{{ sub.end_date|date:"Y-m-d" }}</td>
          <td data-label="الحالة">
            {% if sub.is_expired %}
              <span class="badge danger">منتهي</span>
            {% else %}
              <span class="badge success">ساري</span>
            {% endif %}
          </td>
          <td data-label="إجراء">
            <a href="{% url 'reports:platform_subscription_edit' sub.id %}" class="btn btn-outline" style="min-height:38px;padding:8px 10px">تعديل</a>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="6" style="padding:20px;text-align:center" class="muted">لا توجد اشتراكات مسجلة.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
