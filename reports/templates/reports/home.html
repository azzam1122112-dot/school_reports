{# reports/templates/reports/home.html #}
{% extends "base.html" %}
{% load static %}

{% block title %}Ù…Ø±Ø­Ø¨Ø§Ù‹ {{ request.user.name|default:"" }}{% endblock %}

{% block head %}
<style>
  /* Local overrides for formatting specific to the new 2026 Dashboard look */
  .dashboard-container { display: flex; flex-direction: column; gap: var(--s-5); }
  
  /* --- Hero Section --- */
  .dash-hero {
    position: relative;
    border-radius: var(--radius-xl);
    padding: clamp(24px, 4vw, 40px);
    background: linear-gradient(135deg, var(--brand-700), var(--brand-ink));
    color: #fff;
    box-shadow: var(--shadow-lg);
    overflow: hidden;
    isolation: isolate;
  }
  .dash-hero::after {
    content: ""; position: absolute; inset: 0;
    background: url("{% static 'img/pattern.svg' %}") center/cover no-repeat;
    opacity: .10;
    z-index: -1; mix-blend-mode: overlay;
  }
  .dash-hero-content { display: flex; flex-direction: column; gap: var(--s-3); position: relative; z-index: 2; max-width: 600px; }
  .dash-hero h1 { font-size: clamp(1.8rem, 4vw, 2.4rem); margin: 0; line-height: 1.1; font-weight: 950; }
  .dash-hero p { font-size: 1.05rem; opacity: 0.9; margin: 0; line-height: 1.6; max-width: 48ch; }
  
  .dash-actions { margin-top: var(--s-4); display: flex; flex-wrap: wrap; gap: 12px; }
  .btn-dash-primary { background: #fff; color: var(--brand-700); border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
  .btn-dash-primary:hover { background: #f8fafc; color: var(--brand-ink); transform: translateY(-2px); }
  .btn-dash-outline { background: rgba(255,255,255,0.15); color: #fff; border: 1px solid rgba(255,255,255,0.3); backdrop-filter: blur(4px); }
  .btn-dash-outline:hover { background: rgba(255,255,255,0.25); border-color: rgba(255,255,255,0.5); }
  
  /* --- Bento Grid Stats --- */
  .bento-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: var(--s-3); }
  .stat-card {
    background: var(--card); border: 1px solid var(--line-2); border-radius: var(--radius-lg); padding: 20px;
    display: flex; flex-direction: column; gap: 12px; transition: transform var(--t) var(--ease), box-shadow var(--t) var(--ease);
    position: relative; overflow: hidden;
  }
  .stat-card:hover { transform: translateY(-3px); box-shadow: var(--shadow); border-color: var(--brand-ghost); }
  .stat-icon {
    width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center;
    font-size: 1.3rem; background: var(--bg); color: var(--muted);
  }
  .stat-val { font-size: 2.2rem; font-weight: 950; line-height: 1; color: var(--ink); }
  .stat-lbl { font-size: 0.95rem; font-weight: 800; color: var(--muted); }
  .stat-card.primary .stat-icon { background: var(--brand-ghost); color: var(--brand); }
  .stat-card.accent .stat-icon { background: rgba(5,150,105,0.1); color: var(--accent); }
  .stat-card.warn .stat-icon { background: rgba(245,158,11,0.1); color: var(--warning); }

  /* --- Sections --- */
  .dash-split { display: grid; gap: var(--s-4); }
  @media(min-width: 900px) { .dash-split { grid-template-columns: 2fr 1fr; } }
  
  .dash-list { display: flex; flex-direction: column; gap: 8px; }
  .dash-item {
    display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: var(--radius);
    background: var(--bg); text-decoration: none; transition: background var(--t-fast) var(--ease);
  }
  .dash-item:hover { background: var(--line-2); }
  .di-icon {
    width: 40px; height: 40px; border-radius: 10px; background: #fff;
    display: flex; align-items: center; justify-content: center; color: var(--brand); font-size: 1rem;
    box-shadow: var(--shadow-sm); flex-shrink: 0;
  }
  .di-content { flex: 1; min-width: 0; }
  .di-title { font-weight: 900; color: var(--ink); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 1rem; }
  .di-meta { font-size: 0.85rem; color: var(--muted); margin-top: 2px; }
  .hpill { font-size: 0.75rem; padding: 4px 8px; border-radius: 6px; font-weight: 800; background: var(--line); color: var(--muted); }
  .hpill.hp-blue { background: var(--brand-ghost); color: var(--brand-700); }
  .hpill.hp-green { background: rgba(5,150,105,0.1); color: var(--accent); }
  .hpill.hp-red { background: rgba(220,38,38,0.1); color: var(--danger); }

  .motivate-card { background: linear-gradient(135deg, #10b981, #059669); color: #fff; }
  .motivate-card .section-title { color: #fff; opacity: 0.95; margin-bottom: 8px; }
  .motivate-text { font-size: 1rem; line-height: 1.5; font-weight: 600; opacity: 0.9; }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container home-wrap">

  <!-- NOTIFICATION MODAL (Preserved Logic) -->
  {% if home_notification %}
    <div
      class="hn-overlay is-open"
      id="homeNotifOverlay"
      role="dialog"
      aria-modal="true"
      aria-label="Ø¥Ø´Ø¹Ø§Ø± Ø¬Ø¯ÙŠØ¯"
      {% if home_notification_recipient_id %}
        data-recipient-id="{{ home_notification_recipient_id }}"
        data-mark-url="{% url 'reports:notification_mark_read' home_notification_recipient_id %}"
      {% endif %}
    >
      <div class="hn-modal" role="document">
        <div class="hn-hd">
          <h3 class="ttl">
            <i class="fa-solid fa-bell" style="opacity:.9"></i>
            Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©
            {% if home_notification.is_important %}<span class="hpill hp-red">Ù‡Ø§Ù…</span>{% endif %}
          </h3>
          <button type="button" class="hn-close" id="homeNotifClose" aria-label="Ø¥ØºÙ„Ø§Ù‚">âœ•</button>
        </div>
        <div class="hn-bd">
          {% if home_notification.title %}
            <div class="hn-title">{{ home_notification.title }}</div>
          {% endif %}
          <div class="hn-body">{{ home_notification.message|linebreaksbr }}</div>
          <div class="hn-meta">
            <span>
              Ø§Ù„Ù…Ø±Ø³Ù„:
              {% if home_notification.created_by %}
                {% firstof home_notification.created_by.name home_notification.created_by.phone home_notification.created_by.username "Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©" %}
                {% if home_notification.created_by.is_platform_admin or home_notification.created_by.role %}
                  â€” {{ home_notification.created_by.display_role_label }}
                {% endif %}
              {% else %}
                Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
              {% endif %}
            </span>
            {% if home_notification.created_at %}<span dir="ltr">{{ home_notification.created_at|date:"Y-m-d H:i" }}</span>{% endif %}
          </div>
        </div>
      </div>
    </div>
  {% endif %}

  <!-- ZERO: HERO SECTION -->
  <section class="dash-hero">
    <div class="dash-hero-content">
      <div>
        <div style="font-size:0.9rem; font-weight:700; opacity:0.8; margin-bottom:4px; text-transform:uppercase; letter-spacing:1px;">
           {% if SCHOOL_NAME %}{{ SCHOOL_NAME }}{% else %}Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…{% endif %}
        </div>
        <h1>Ø£Ù‡Ù„Ù‹Ø§ØŒ {{ request.user.name|default:"Ù…Ø³ØªØ®Ø¯Ù…Ù†Ø§ Ø§Ù„Ø¹Ø²ÙŠØ²" }} ğŸ‘‹</h1>
        <p>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ø¹ÙˆØ¯ØªÙƒ Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø°ÙƒÙŠ. Ù„Ø¯ÙŠÙƒ Ø§Ù„ÙŠÙˆÙ… ÙØ±ØµØ© Ø¬Ø¯ÙŠØ¯Ø© Ù„ØªÙˆØ«ÙŠÙ‚ Ø¥Ù†Ø¬Ø§Ø²Ø§ØªÙƒ ÙˆÙ…ØªØ§Ø¨Ø¹Ø© ØªÙ‚Ø¯Ù…Ùƒ Ø¨ÙƒÙ„ Ø³Ù‡ÙˆÙ„Ø©.</p>
      </div>

      <div class="dash-actions">
        <a class="btn btn-lg btn-dash-primary" href="{% url 'reports:add_report' %}">
          <i class="fa-solid fa-plus"></i> Ø¥Ø¶Ø§ÙØ© ØªÙ‚Ø±ÙŠØ±
        </a>
        <a class="btn btn-lg btn-dash-outline" href="{% url 'reports:my_reports' %}">
          <i class="fa-solid fa-folder-open"></i> ØªÙ‚Ø§Ø±ÙŠØ±ÙŠ
        </a>
        {% url 'reports:assigned_to_me' as inbox_url %}
        {% if inbox_url %}
          <a class="btn btn-lg btn-dash-outline" href="{{ inbox_url }}">
            <i class="fa-solid fa-inbox"></i> Ø§Ù„ÙˆØ§Ø±Ø¯
          </a>
        {% endif %}

        {% url 'reports:my_notifications' as myNotificationsUrl %}
        {% if myNotificationsUrl %}
          <a class="btn btn-lg btn-dash-outline" href="{{ myNotificationsUrl }}" title="Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª">
            <i class="fa-solid fa-bell"></i> Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
            {% if NAV_NOTIFICATIONS_UNREAD %}
              <span class="hpill hp-blue" style="margin-inline-start:8px">{{ NAV_NOTIFICATIONS_UNREAD }} Ø¬Ø¯ÙŠØ¯</span>
            {% endif %}
          </a>
        {% endif %}

        {% url 'reports:my_circulars' as myCircularsUrl %}
        {% if myCircularsUrl %}
          <a class="btn btn-lg btn-dash-outline" href="{{ myCircularsUrl }}" title="Ø¹Ø±Ø¶ Ø§Ù„ØªØ¹Ø§Ù…ÙŠÙ…">
            <i class="fa-solid fa-pen-to-square"></i> Ø§Ù„ØªØ¹Ø§Ù…ÙŠÙ…
            {% if NAV_SIGNATURES_PENDING %}
              <span class="hpill hp-red" style="margin-inline-start:8px">{{ NAV_SIGNATURES_PENDING }} Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªÙˆÙ‚ÙŠØ¹</span>
            {% endif %}
          </a>
        {% endif %}
      </div>
    </div>
  </section>

  {% if NAV_SIGNATURES_PENDING %}
    <div class="card" style="border:1px solid rgba(220,38,38,.25); background:rgba(220,38,38,.06)">
      <div class="row-between" style="gap:12px; align-items:center">
        <div>
          <h3 class="section-title" style="margin:0 0 6px 0">
            <i class="fa-solid fa-triangle-exclamation" style="color:var(--danger);margin-left:8px"></i>
            Ù„Ø¯ÙŠÙƒ ØªØ¹Ø§Ù…ÙŠÙ… ØªØªØ·Ù„Ø¨ ØªÙˆÙ‚ÙŠØ¹Ø§Ù‹
          </h3>
          <div class="section-sub" style="margin:0">
            Ø¹Ø¯Ø¯ Ø§Ù„ØªØ¹Ø§Ù…ÙŠÙ… ØºÙŠØ± Ø§Ù„Ù…ÙˆÙ‚Ù‘Ø¹Ø©: <strong>{{ NAV_SIGNATURES_PENDING }}</strong> â€” Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ø·Ù„Ø§Ø¹ ÙˆØ§Ù„ØªÙˆÙ‚ÙŠØ¹ Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù….
          </div>
        </div>
        {% if myCircularsUrl %}
          <a class="btn btn-sm" href="{{ myCircularsUrl }}" style="background:#fff">
            ÙØªØ­ Ø§Ù„ØªØ¹Ø§Ù…ÙŠÙ…
          </a>
        {% endif %}
      </div>
    </div>
  {% endif %}

  <!-- ONE: KEY METRICS (Bento Grid) -->
  <section class="bento-grid">
    <!-- Reports Today -->
    <div class="stat-card primary">
      <div class="row-between" style="align-items:flex-start">
        <div class="stat-icon"><i class="fa-solid fa-sun"></i></div>
        {% if stats.today_count > 0 %}
          <span class="hpill hp-blue">Ù†Ø´Ø· Ø§Ù„ÙŠÙˆÙ…</span>
        {% endif %}
      </div>
      <div>
        <div class="stat-val">{{ stats.today_count|default:"0" }}</div>
        <div class="stat-lbl">ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…</div>
      </div>
    </div>

    <!-- Total Reports -->
    <div class="stat-card">
      <div class="row-between" style="align-items:flex-start">
        <div class="stat-icon"><i class="fa-solid fa-layer-group"></i></div>
      </div>
      <div>
        <div class="stat-val">{{ stats.total_count|default:"0" }}</div>
        <div class="stat-lbl">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</div>
      </div>
    </div>

    <!-- Active Requests -->
    <div class="stat-card accent">
      <div class="row-between" style="align-items:flex-start">
        <div class="stat-icon"><i class="fa-solid fa-hourglass-half"></i></div>
        <span class="hpill hp-green">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</span>
      </div>
      <div>
        <div class="stat-val">{{ req_stats.in_progress|default:"0" }}</div>
        <div class="stat-lbl">Ø·Ù„Ø¨Ø§Øª Ø¬Ø§Ø±ÙŠØ©</div>
      </div>
    </div>

    <!-- Inbox/New Interactions -->
    <div class="stat-card warn">
      <div class="row-between" style="align-items:flex-start">
        <div class="stat-icon"><i class="fa-solid fa-bell"></i></div>
      </div>
      <div>
        <div class="stat-val">{{ req_stats.open|default:"0" }}</div>
        <div class="stat-lbl">ØªÙ†Ø¨ÙŠÙ‡Ø§Øª / Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</div>
      </div>
    </div>
  </section>

  <!-- TWO: MAIN CONTENT SPLIT -->
  <div class="dash-split">
    <!-- Left: Recents -->
    <div class="card">
      <div class="row-between" style="margin-bottom:16px;">
        <div>
          <h3 class="section-title"><i class="fa-solid fa-clock-rotate-left" style="color:var(--brand);margin-left:8px"></i> Ø£Ø­Ø¯Ø« Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª</h3>
          <p class="section-sub">Ø¢Ø®Ø± Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ØªÙŠ Ù‚Ù…Øª Ø¨Ø±ÙØ¹Ù‡Ø§ Ù„Ù„Ù†Ø¸Ø§Ù…</p>
        </div>
        <a href="{% url 'reports:my_reports' %}" class="btn btn-sm" style="background:var(--bg)">Ø§Ù„ÙƒÙ„</a>
      </div>

      {% if recent_reports %}
        <div class="dash-list">
          {% for r in recent_reports %}
            <a class="dash-item" href="{% url 'reports:report_print' r.id %}?next={{ request.get_full_path|urlencode }}" title="Ø¹Ø±Ø¶ ÙˆØ·Ø¨Ø§Ø¹Ø©">
              <div class="di-icon">
                <i class="fa-regular fa-file-lines"></i>
              </div>
              <div class="di-content">
                <div class="di-title">{{ r.title }}</div>
                <div class="di-meta">
                  <i class="fa-regular fa-calendar"></i> {{ r.report_date }} 
                  <span style="margin:0 4px">â€¢</span> 
                  {{ r.day_name }}
                </div>
              </div>
              <span class="hpill hp-blue desktop-only">
                {% if r.category and r.category.name %}{{ r.category.name }}{% else %}Ø¹Ø§Ù…{% endif %}
              </span>
              <i class="fa-solid fa-chevron-left" style="font-size:0.8rem; color:var(--muted); opacity:0.5; margin-right:8px"></i>
            </a>
          {% endfor %}
        </div>
      {% else %}
        <div style="text-align:center; padding:40px 20px; color:var(--muted);">
          <div style="font-size:3rem; margin-bottom:10px; opacity:0.3"><i class="fa-solid fa-folder-open"></i></div>
          <p>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚Ø§Ø±ÙŠØ± Ø­Ø¯ÙŠØ«Ø© Ù„Ù„Ø¹Ø±Ø¶.</p>
          <a class="btn btn-primary btn-sm" href="{% url 'reports:add_report' %}">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†</a>
        </div>
      {% endif %}
    </div>

    <!-- Right: Sidebar -->
    <div class="stack">
      <!-- Quick Actions / Request Status -->
      <div class="card">
        <h3 class="section-title"><i class="fa-solid fa-ticket" style="color:var(--accent);margin-left:8px"></i> Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3>
        <p class="section-sub">Ù…Ù„Ø®Øµ Ù„Ø­Ø§Ù„Ø© ØªØ°Ø§ÙƒØ± Ø§Ù„Ø¯Ø¹Ù… ÙˆØ§Ù„Ø·Ù„Ø¨Ø§Øª</p>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:16px;">
          <div style="background:var(--bg); padding:12px; border-radius:12px; text-align:center;">
            <div style="font-weight:900; font-size:1.5rem; color:var(--accent)">{{ req_stats.done|default:"0" }}</div>
            <div style="font-size:0.85rem; font-weight:700; color:var(--muted)">Ù…ÙƒØªÙ…Ù„Ø©</div>
          </div>
          <div style="background:var(--bg); padding:12px; border-radius:12px; text-align:center;">
            <div style="font-weight:900; font-size:1.5rem; color:var(--danger)">{{ req_stats.rejected|default:"0" }}</div>
            <div style="font-size:0.85rem; font-weight:700; color:var(--muted)">Ù…Ø±ÙÙˆØ¶Ø©</div>
          </div>
        </div>

        <a class="btn btn-block btn-accent" href="{% url 'reports:request_create' %}">
          <i class="fa-solid fa-plus"></i> ÙØªØ­ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
        </a>
        <a class="btn btn-block" style="background:var(--bg); margin-top:8px;" href="{% url 'reports:my_requests' %}">
          Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
        </a>
      </div>

      <!-- Motivation / Banner -->
      <div class="card motivate-card">
        <div style="display:flex; justify-content:space-between; align-items:flex-start">
          <h3 class="section-title" style="margin:0"><i class="fa-solid fa-bolt"></i> Ø¥Ù†Ø¬Ø§Ø² Ø³Ø±ÙŠØ¹</h3>
          <i class="fa-solid fa-star" style="opacity:0.6"></i>
        </div>
        <p class="motivate-text" style="margin:12px 0 20px;">
          Ù‡Ù„ ØªØ¹Ù„Ù…ØŸ ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ ÙÙˆØ± Ø§Ù†ØªÙ‡Ø§Ø¦Ù‡Ø§ ÙŠÙˆÙØ± Ø¹Ù„ÙŠÙƒ 70% Ù…Ù† ÙˆÙ‚Øª ÙƒØªØ§Ø¨Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ù„Ø§Ø­Ù‚Ø§Ù‹.
        </p>
        <a class="btn btn-sm" style="background:rgba(255,255,255,0.2); color:#fff; border:1px solid rgba(255,255,255,0.4);" href="{% url 'reports:add_report' %}">
          ÙˆØ«Ù‘Ù‚ Ø§Ù„Ø¢Ù†
        </a>
      </div>
    </div>
  </div>

</div>
{% endblock %}

{% block scripts %}
<script nonce="{{ CSP_NONCE }}">
  (function(){
    var overlay = document.getElementById('homeNotifOverlay');
    if(!overlay) return;

    var closeBtn = document.getElementById('homeNotifClose');
    var modal = overlay.querySelector('.hn-modal');

    var recipientId = overlay.getAttribute('data-recipient-id') || '';
    var storageKey = recipientId ? ('hn_dismissed_recipient_' + recipientId) : '';

    function hide(){
      overlay.classList.remove('is-open');
      try{
        if(window.__lockScroll) window.__lockScroll(false);
        if(window.__trapFocus && modal) window.__trapFocus(modal, false);
      }catch(e){
        // ignore
      }
    }

    async function markRead(){
      var url = overlay.getAttribute('data-mark-url');
      if(!url) return;

      try{
        var csrftoken = (window.getCsrfToken ? window.getCsrfToken() : (window.csrfToken || ''));
        await fetch(url, {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrftoken || '',
            'X-Requested-With': 'XMLHttpRequest'
          },
          credentials: 'same-origin'
        });
      }catch(e){
        // ignore
      }
    }

    function openModal(){
      try{
        if(window.__lockScroll) window.__lockScroll(true);
        if(window.__trapFocus && modal) window.__trapFocus(modal, true);
      }catch(e){
        // ignore
      }
    }

    // Ø¥Ù† ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£ØºÙ„Ù‚Ù‡Ø§ Ø³Ø§Ø¨Ù‚Ø§Ù‹ Ù„Ù†ÙØ³ Ø§Ù„Ù…Ø³ØªÙ„Ù…
    try{
      if(storageKey && window.localStorage && localStorage.getItem(storageKey) === '1'){
        hide();
        markRead();
        return;
      }
    }catch(e){
      // ignore
    }

    // Ù…ÙˆØ¯Ø§Ù„ Ù…ÙØªÙˆØ­ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ Ø¥Ø´Ø¹Ø§Ø±
    openModal();

    // Ø¥ØºÙ„Ø§Ù‚ Ø¨Ø§Ù„Ø²Ø±
    if(closeBtn){
      closeBtn.addEventListener('click', function(){
        try{
          if(storageKey && window.localStorage) localStorage.setItem(storageKey, '1');
        }catch(e){
          // ignore
        }
        markRead();
        hide();
      });
    }

    // Ø¥ØºÙ„Ø§Ù‚ Ø¨Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
    overlay.addEventListener('click', function(ev){
      if(ev.target === overlay){
        try{
          if(storageKey && window.localStorage) localStorage.setItem(storageKey, '1');
        }catch(e){
          // ignore
        }
        markRead();
        hide();
      }
    });

    // Ø¥ØºÙ„Ø§Ù‚ Ø¨Ù€ ESC
    document.addEventListener('keydown', function(ev){
      if(ev.key === 'Escape' && overlay.classList.contains('is-open')){
        try{
          if(storageKey && window.localStorage) localStorage.setItem(storageKey, '1');
        }catch(e){
          // ignore
        }
        markRead();
        hide();
      }
    });
  })();
</script>
{% endblock %}
