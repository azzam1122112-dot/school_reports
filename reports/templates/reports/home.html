{# reports/templates/reports/home.html #}
{% extends "base.html" %}
{% load static %}

{% block title %}Ù…Ø±Ø­Ø¨Ø§Ù‹ {{ request.user.name|default:"" }}{% endblock %}

{% block head %}
{% endblock %}

{% block content %}
<div class="home-wrap">
  {% if home_notification %}
    <div
      class="hn-overlay is-open"
      id="homeNotifOverlay"
      role="dialog"
      aria-modal="true"
      aria-label="Ø¥Ø´Ø¹Ø§Ø± Ø¬Ø¯ÙŠØ¯"
      {% if home_notification_recipient_id %}
        data-recipient-id="{{ home_notification_recipient_id }}"
        data-mark-url="{% url 'reports:notification_mark_read' home_notification_recipient_id %}"
      {% endif %}
    >
      <div class="hn-modal" role="document">
        <div class="hn-hd">
          <h3 class="ttl">
            <i class="fa-solid fa-bell" style="opacity:.9"></i>
            Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©
            {% if home_notification.is_important %}<span class="hpill hp-red">Ù‡Ø§Ù…</span>{% endif %}
          </h3>
          <button type="button" class="hn-close" id="homeNotifClose" aria-label="Ø¥ØºÙ„Ø§Ù‚">âœ•</button>
        </div>
        <div class="hn-bd">
          {% if home_notification.title %}
            <div class="hn-title">{{ home_notification.title }}</div>
          {% endif %}
          <div class="hn-body">{{ home_notification.message|linebreaksbr }}</div>
          <div class="hn-meta">
            <span>Ø§Ù„Ù…Ø±Ø³Ù„: {% firstof home_notification.created_by.name home_notification.created_by.phone "Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©" %}</span>
            {% if home_notification.created_at %}<span dir="ltr">{{ home_notification.created_at|date:"Y-m-d H:i" }}</span>{% endif %}
          </div>
        </div>
      </div>
    </div>
  {% endif %}

  <!-- HERO -->
  <section class="home-hero" aria-labelledby="welcomeTitle">
    <div class="home-hero-inner">
      <div class="hero-top">
        <div>
          <h1 class="hero-title" id="welcomeTitle">Ø£Ù‡Ù„Ù‹Ø§ {{ request.user.name|default:"Ø¨Ùƒ" }} ğŸ‘‹</h1>
          <p class="hero-sub">
            Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ø¹ÙˆØ¯ØªÙƒ! ÙˆØ«Ù‘Ù‚ Ø¥Ù†Ø¬Ø§Ø²Ø§ØªÙƒØŒ ØªØ§Ø¨Ø¹ Ø·Ù„Ø¨Ø§ØªÙƒØŒ ÙˆØ§Ø·Ù‘Ù„Ø¹ Ø¹Ù„Ù‰ Ø¢Ø®Ø± Ø§Ù„Ù…Ø³ØªØ¬Ø¯Ø§Øª Ø¨Ø³Ø±Ø¹Ø©.
          </p>
        </div>

        <div class="hero-meta" aria-label="Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø³Ø±ÙŠØ¹Ø©">
          <span class="hero-chip">
            <i class="fa-solid fa-building"></i>
            {% if SCHOOL_NAME %}{{ SCHOOL_NAME }}{% else %}Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±{% endif %}
          </span>
          <span class="hero-chip">
            <i class="fa-solid fa-user"></i>
            {% firstof request.user.role "Ù…Ø³ØªØ®Ø¯Ù…" %}
          </span>
        </div>
      </div>

      <div class="hero-actions" aria-label="Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø³Ø±ÙŠØ¹Ø©">
        <a class="btn btn-hero" href="{% url 'reports:add_report' %}">
          <i class="fa-solid fa-plus"></i> Ø¥Ø¶Ø§ÙØ© ØªÙ‚Ø±ÙŠØ±
        </a>

        <a class="btn btn-hero-outline" href="{% url 'reports:my_reports' %}">
          <i class="fa-solid fa-file-lines"></i> ØªÙ‚Ø§Ø±ÙŠØ±ÙŠ
        </a>

        {% url 'reports:assigned_to_me' as inbox_url %}
        {% if inbox_url %}
          <a class="btn btn-hero-outline" href="{{ inbox_url }}">
            <i class="fa-solid fa-inbox"></i> Ø§Ù„ÙˆØ§Ø±Ø¯
          </a>
        {% endif %}

        <a class="btn btn-hero-outline" href="{% url 'reports:my_requests' %}">
          <i class="fa-solid fa-rectangle-list"></i> Ø·Ù„Ø¨Ø§ØªÙŠ
        </a>
      </div>
    </div>
  </section>

  <div class="home-grid">
    <!-- LEFT -->
    <div class="grid" style="align-content:start">
      <div class="card">
        <h3 style="margin:0 0 10px; font-weight:950; display:flex; gap:10px; align-items:center;">
          <i class="fa-solid fa-chart-simple" style="opacity:.85"></i> Ù†Ø¸Ø±Ø© Ø³Ø±ÙŠØ¹Ø©
        </h3>

        <div class="kpis" role="list">
          <div class="kpi" role="listitem">
            <div class="v">{{ stats.today_count|default:"0" }}</div>
            <div class="l">ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…</div>
            <div class="bub" aria-hidden="true"><i class="fa-solid fa-sun"></i></div>
          </div>

          <div class="kpi" role="listitem">
            <div class="v">{{ stats.total_count|default:"0" }}</div>
            <div class="l">Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªÙ‚Ø§Ø±ÙŠØ±ÙŠ</div>
            <div class="bub" aria-hidden="true"><i class="fa-solid fa-layer-group"></i></div>
          </div>

          <div class="kpi kpi-amber" role="listitem">
            <div class="v">{{ req_stats.open|default:"0" }}</div>
            <div class="l">Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</div>
            <div class="bub" aria-hidden="true"><i class="fa-solid fa-door-open"></i></div>
          </div>

          <div class="kpi kpi-green" role="listitem">
            <div class="v">{{ req_stats.in_progress|default:"0" }}</div>
            <div class="l">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</div>
            <div class="bub" aria-hidden="true"><i class="fa-solid fa-hourglass-half"></i></div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 10px; font-weight:950; display:flex; gap:10px; align-items:center;">
          <i class="fa-solid fa-file-circle-check" style="opacity:.85"></i> Ø£Ø­Ø¯Ø« ØªÙ‚Ø§Ø±ÙŠØ±ÙŠ
        </h3>

        {% if recent_reports %}
          <div class="list" role="list">
            {% for r in recent_reports %}
              <a class="item" role="listitem" href="{% url 'reports:report_print' r.id %}" title="ÙØªØ­ Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±">
                <div>
                  <strong>{{ r.title }}</strong>
                  <div class="meta">Ø¨ØªØ§Ø±ÙŠØ® {{ r.report_date }} â€” {{ r.day_name }}</div>
                </div>

                <span class="hpill hp-blue">
                  {% if r.category and r.category.name %}{{ r.category.name }}{% else %}â€”{% endif %}
                </span>
              </a>
            {% endfor %}
          </div>

          <div style="margin-top:14px; display:flex; gap:8px; flex-wrap:wrap">
            <a class="btn btn-ghost" href="{% url 'reports:my_reports' %}">
              <i class="fa-solid fa-list"></i> Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ ØªÙ‚Ø§Ø±ÙŠØ±ÙŠ
            </a>
            <a class="btn btn-primary" href="{% url 'reports:add_report' %}">
              <i class="fa-solid fa-plus"></i> Ø¥Ø¶Ø§ÙØ© ØªÙ‚Ø±ÙŠØ±
            </a>
          </div>
        {% else %}
          <div class="empty">
            Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚Ø§Ø±ÙŠØ± Ø­Ø¯ÙŠØ«Ø© Ø¨Ø¹Ø¯ â€” <b>Ø§Ø¨Ø¯Ø£ Ø¨ØªÙˆØ«ÙŠÙ‚ Ø£ÙˆÙ„ Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ø¢Ù†</b>.
            <div style="margin-top:12px">
              <a class="btn btn-primary" href="{% url 'reports:add_report' %}">
                <i class="fa-solid fa-plus"></i> Ø¥Ø¶Ø§ÙØ© ØªÙ‚Ø±ÙŠØ± Ø¬Ø¯ÙŠØ¯
              </a>
            </div>
          </div>
        {% endif %}
      </div>
    </div>

    <!-- RIGHT -->
    <div class="grid" style="align-content:start">
      <div class="card">
        <h3 style="margin:0 0 10px; font-weight:950; display:flex; gap:10px; align-items:center;">
          <i class="fa-solid fa-clipboard-check" style="opacity:.85"></i> Ø­Ø§Ù„Ø© Ø·Ù„Ø¨Ø§ØªÙŠ
        </h3>

        <div class="list" role="list">
          <div class="item" role="listitem" style="cursor:default">
            <div><strong>Ù…ÙƒØªÙ…Ù„Ø©</strong></div>
            <span class="hpill hp-green">{{ req_stats.done|default:"0" }}</span>
          </div>

          <div class="item" role="listitem" style="cursor:default">
            <div><strong>Ù…Ø±ÙÙˆØ¶Ø©</strong></div>
            <span class="hpill hp-red">{{ req_stats.rejected|default:"0" }}</span>
          </div>
        </div>

        <div style="margin-top:14px; display:flex; gap:8px; flex-wrap:wrap">
          <a class="btn btn-ghost" href="{% url 'reports:request_create' %}">
            <i class="fa-solid fa-ticket"></i> ÙØªØ­ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
          </a>
          <a class="btn" href="{% url 'reports:my_requests' %}">
            <i class="fa-solid fa-rectangle-list"></i> Ø·Ù„Ø¨Ø§ØªÙŠ
          </a>
        </div>
      </div>

      <div class="card" id="motivateCard" aria-live="polite">
        <h3 style="margin:0 0 10px; font-weight:950; display:flex; gap:10px; align-items:center;">
          <i class="fa-solid fa-bolt" style="opacity:.85"></i> Ø¯ÙØ¹Ø© Ø·Ø§Ù‚Ø©
        </h3>

        <div class="meta" style="font-weight:900">
          Ø§Ø¨Ø¯Ø£ ÙŠÙˆÙ…Ùƒ Ø¨Ø®Ø·ÙˆØ© ØµØºÙŠØ±Ø© Ø§Ù„Ø¢Ù†. Ø¯Ù‚ÙŠÙ‚Ø© ÙˆØ§Ø­Ø¯Ø© Ù‚Ø¯ ØªØºÙŠÙ‘Ø± Ù†ØªÙŠØ¬Ø© ÙŠÙˆÙ…Ùƒ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„.
        </div>

        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:14px;">
          <a class="btn btn-primary" href="{% url 'reports:add_report' %}">
            <i class="fa-solid fa-plus"></i> ØªÙˆØ«ÙŠÙ‚ Ø¥Ù†Ø¬Ø§Ø²
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script nonce="{{ CSP_NONCE }}">
  (function(){
    var overlay = document.getElementById('homeNotifOverlay');
    if(!overlay) return;

    var closeBtn = document.getElementById('homeNotifClose');
    var modal = overlay.querySelector('.hn-modal');

    var recipientId = overlay.getAttribute('data-recipient-id') || '';
    var storageKey = recipientId ? ('hn_dismissed_recipient_' + recipientId) : '';

    function hide(){
      overlay.classList.remove('is-open');
      try{
        if(window.__lockScroll) window.__lockScroll(false);
        if(window.__trapFocus && modal) window.__trapFocus(modal, false);
      }catch(e){
        // ignore
      }
    }

    async function markRead(){
      var url = overlay.getAttribute('data-mark-url');
      if(!url) return;

      try{
        var csrftoken = (window.getCsrfToken ? window.getCsrfToken() : (window.csrfToken || ''));
        await fetch(url, {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrftoken || '',
            'X-Requested-With': 'XMLHttpRequest'
          },
          credentials: 'same-origin'
        });
      }catch(e){
        // ignore
      }
    }

    function openModal(){
      try{
        if(window.__lockScroll) window.__lockScroll(true);
        if(window.__trapFocus && modal) window.__trapFocus(modal, true);
      }catch(e){
        // ignore
      }
    }

    // Ø¥Ù† ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£ØºÙ„Ù‚Ù‡Ø§ Ø³Ø§Ø¨Ù‚Ø§Ù‹ Ù„Ù†ÙØ³ Ø§Ù„Ù…Ø³ØªÙ„Ù…
    try{
      if(storageKey && window.localStorage && localStorage.getItem(storageKey) === '1'){
        hide();
        markRead();
        return;
      }
    }catch(e){
      // ignore
    }

    // Ù…ÙˆØ¯Ø§Ù„ Ù…ÙØªÙˆØ­ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ Ø¥Ø´Ø¹Ø§Ø±
    openModal();

    // Ø¥ØºÙ„Ø§Ù‚ Ø¨Ø§Ù„Ø²Ø±
    if(closeBtn){
      closeBtn.addEventListener('click', function(){
        try{
          if(storageKey && window.localStorage) localStorage.setItem(storageKey, '1');
        }catch(e){
          // ignore
        }
        markRead();
        hide();
      });
    }

    // Ø¥ØºÙ„Ø§Ù‚ Ø¨Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
    overlay.addEventListener('click', function(ev){
      if(ev.target === overlay){
        try{
          if(storageKey && window.localStorage) localStorage.setItem(storageKey, '1');
        }catch(e){
          // ignore
        }
        markRead();
        hide();
      }
    });

    // Ø¥ØºÙ„Ø§Ù‚ Ø¨Ù€ ESC
    document.addEventListener('keydown', function(ev){
      if(ev.key === 'Escape' && overlay.classList.contains('is-open')){
        try{
          if(storageKey && window.localStorage) localStorage.setItem(storageKey, '1');
        }catch(e){
          // ignore
        }
        markRead();
        hide();
      }
    });
  })();
</script>
{% endblock %}
