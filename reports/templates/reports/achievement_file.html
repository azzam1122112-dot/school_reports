{# reports/templates/reports/achievement_file_detail.html (or your file) #}
{% extends "base.html" %}
{% load static %}

{% block title %}ملف الإنجاز{% endblock %}

{% block head %}
<style>
  /* =========================================================
     Achievement File Detail — Luxury 2026 Theme
     ========================================================= */
  :root {
    --brand: #2563eb;
    --brand-dark: #1e40af;
    --brand-light: #eff6ff;
    --accent: #d97706; /* Gold/Bronze */
    --surface: #f8fafc;
    --border-color: #e2e8f0;
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow-lg: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.01);
    --text-main: #0f172a;
    --text-secondary: #64748b;
  }

  .af-wrap{ 
    max-width:1150px; 
    margin:30px auto; 
    padding:clamp(16px, 3vw, 24px);
    animation: fadeIn 0.6s ease-out;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .af-card{
    background: white;
    border: 1px solid var(--border-color);
    border-radius: 24px;
    box-shadow: var(--shadow-lg);
    overflow: hidden;
  }
  
  .af-head { padding: 0; background: white; }
  .af-body { padding: 32px; background: white; }

  /* New Modern Hero */
  .af-hero {
    position: relative;
    padding: 40px 32px;
    background: white;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
    overflow: hidden;
  }
  /* Decorative background element */
  .af-hero::before {
    content: '';
    position: absolute;
    top: -50%; right: -10%; width: 50%; height: 200%;
    background: radial-gradient(circle, rgba(37,99,235,0.04) 0%, transparent 70%);
    transform: rotate(-15deg);
    pointer-events: none;
  }

  .af-hero-start {
    display: flex;
    align-items: center;
    gap: 24px;
    position: relative;
    z-index: 2;
  }
  
  .af-ministry-logo {
    width: 80px; height: 80px;
    object-fit: contain;
  }

  .af-hero-info h1 {
    font-size: 1.8rem;
    font-weight: 800;
    margin: 0 0 6px;
    color: var(--text-main);
    letter-spacing: -0.5px;
  }
  .af-hero-info .sub-info {
    font-size: 1rem;
    color: var(--text-secondary);
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .af-hero-info .sub-info i { color: var(--brand); font-size: 0.9em; }

  .af-hero-end {
    text-align: left;
    position: relative;
    z-index: 2;
  }
  .af-year-badge {
    background: var(--surface);
    color: var(--text-main);
    padding: 8px 16px;
    border-radius: 12px;
    font-weight: 800;
    font-size: 1rem;
    border: 1px solid var(--border-color);
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }

  /* Status Bar */
  .af-status-bar {
    background: var(--surface);
    padding: 12px 32px;
    border-bottom: 1px dashed var(--border-color);
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 16px;
  }
  
  .af-status-pill {
    display: inline-flex; align-items: center; gap: 8px;
    padding: 6px 14px; border-radius: 999px;
    font-weight: 700; font-size: 0.9rem;
  }
  .status-draft { background: #e2e8f0; color: #475569; }
  .status-submit { background: #e0f2fe; color: #0284c7; }
  .status-approve { background: #dcfce7; color: #16a34a; }
  .status-return { background: #fee2e2; color: #dc2626; }

  /* Action Buttons */
  .af-actions { display: flex; gap: 10px; flex-wrap: wrap; }
  
  .af-btn {
    display: inline-flex; align-items: center; justify-content: center; gap: 8px;
    height: 42px; padding: 0 18px; border-radius: 12px;
    font-weight: 700; font-size: 0.95rem; cursor: pointer; text-decoration: none;
    transition: all 0.2s ease;
    border: 1px solid var(--border-color); background: white; color: var(--text-secondary);
  }
  .af-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    color: var(--brand); border-color: var(--brand);
  }
  .af-btn-primary {
    background: linear-gradient(135deg, var(--brand), var(--brand-dark));
    color: white; border: none;
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
  }
  .af-btn-primary:hover {
    color: white; transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(37, 99, 235, 0.3);
  }
  .af-btn-danger {
    background: #fee2e2; color: #dc2626; border-color: #fecaca;
  }
  .af-btn-danger:hover {
    background: #fecaca; color: #b91c1c; transform: translateY(-2px);
  }

  /* Section Titles */
  h2.af-section-title {
    font-size: 1.4rem;
    font-weight: 800;
    color: var(--text-main);
    margin: 30px 0 20px;
    display: flex; align-items: center; gap: 10px;
  }
  h2.af-section-title::before {
    content: ''; width: 4px; height: 24px;
    background: var(--accent); border-radius: 4px;
  }

  /* Comment Box */
  .af-comment-box {
    background: var(--surface);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    padding: 20px;
  }
  .af-comment-item {
    padding: 16px 0;
    border-bottom: 1px dashed var(--border-color);
  }
  .af-comment-item:last-child { border-bottom: none; }
  .af-comment-meta { font-weight: 800; font-size: 0.9rem; color: var(--text-main); margin-bottom: 6px; }
  .af-comment-body { color: var(--text-secondary); line-height: 1.6; }

  /* Form & Grid */
  .af-grid {
    display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px;
    background: white; border: 1px solid var(--border-color);
    border-radius: 20px; padding: 24px;
  }
  @media(max-width: 800px) { .af-grid { grid-template-columns: 1fr; } }
  
  .af-label { display: block; margin-bottom: 8px; font-weight: 700; color: var(--text-secondary); font-size: 0.9rem; }
  .af-form input, .af-form select, .af-form textarea, .af-muted {
    width: 100%; padding: 12px 16px; border-radius: 12px;
    border: 1px solid var(--border-color); background: var(--surface);
    outline: none; transition: 0.2s;
    font-weight: 600; color: var(--text-main);
    font-size: 1rem;
    box-sizing: border-box;
  }
  .af-form input:focus, .af-form select:focus, .af-form textarea:focus {
    background: white; border-color: var(--brand);
    box-shadow: 0 0 0 4px rgba(37,99,235,0.08);
  }
  textarea { min-height: 120px; resize: vertical; }

  /* Details/Accordions (Evidence) */
  .af-details {
    border: 1px solid var(--border-color); border-radius: 16px;
    background: white; margin-bottom: 16px; overflow: hidden;
    transition: 0.3s;
  }
  .af-details[open] { box-shadow: 0 8px 20px -4px rgba(0,0,0,0.05); border-color: var(--brand); }
  .af-summary {
    padding: 16px 20px; font-weight: 800; cursor: pointer;
    display: flex; justify-content: space-between; align-items: center;
    background: white;
  }
  .af-summary::-webkit-details-marker { display: none; }
  .af-sec-body { padding: 20px; border-top: 1px solid var(--border-color); background: var(--surface); }

  /* Evidence Images */
  .af-evidence { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 16px; }
  .af-imgbox {
    border-radius: 12px; overflow: hidden; position: relative;
    border: 1px solid var(--border-color); box-shadow: var(--shadow-sm);
    background: white; transition: 0.3s;
  }
  .af-imgbox:hover { transform: translateY(-3px); box-shadow: var(--shadow-lg); }
  .af-imgbox img { width: 100%; height: 140px; object-fit: cover; display: block; }
  .af-imgbtn { padding:0; border:none; background:transparent; width:100%; cursor:pointer; }
  .af-img-actions { padding: 8px; }
  
  /* Manager Note Box */
  .af-note {
    padding: 16px; border-radius: 16px; margin-bottom: 24px;
    background: #fffbeb; border: 1px solid #fcd34d;
    color: #b45309; font-weight: 700;
  }

  /* Modal */
  .af-modal { display: none; position: fixed; inset: 0; z-index: 14000; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); place-items: center; }
  .af-modal.is-open { display: grid; }
  .af-modal-card { background: white; border-radius: 20px; width: min(900px, 95vw); max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; }
  .af-modal-hd { padding: 16px 24px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
  .af-modal-bd { padding: 20px; overflow: auto; text-align: center; background: #f0f0f0; }
  
  /* Responsive Hero */
  @media(max-width:768px){
    .af-hero { flex-direction: column; text-align: center; gap: 20px; }
    .af-hero-start { flex-direction: column; }
    .af-hero-info .sub-info { justify-content: center; }
    .af-status-bar { flex-direction: column; align-items: stretch; text-align: center; }
    .af-status-bar > div:first-child { justify-content: center; }
    .af-actions { justify-content: center; }
  }
</style>
{% endblock %}

{% block content %}
<div class="af-wrap">
  <div class="af-card">
    
    <!-- Modern Header -->
    <header class="af-hero" aria-label="رأس الملف">
      <div class="af-hero-start">
        <img class="af-ministry-logo" src="{% static 'img/logo1.png' %}" alt="شعار">
        <div class="af-hero-info">
          <h1>{{ file.school_name }}</h1>
          <div class="sub-info">
            <i class="fa-solid fa-user-tie"></i>
            {{ file.teacher_name }}
          </div>
        </div>
      </div>
      <div class="af-hero-end">
        <div class="af-year-badge">
            <i class="fa-solid fa-calendar-check" style="color:var(--brand);"></i>
            {{ file.academic_year }} هـ
        </div>
      </div>
    </header>

    <!-- Status & Meta Bar -->
    <div class="af-status-bar">
        <div style="display:flex; gap:16px; align-items:center;">
            {% if file.status == "approved" or file.status == "APPROVED" %}
              <div class="af-status-pill status-approve"><i class="fa-solid fa-check-circle"></i> معتمد</div>
            {% elif file.status == "submitted" or file.status == "SUBMITTED" %}
              <div class="af-status-pill status-submit"><i class="fa-solid fa-hourglass-half"></i> بانتظار الاعتماد</div>
            {% elif file.status == "returned" or file.status == "RETURNED" %}
              <div class="af-status-pill status-return"><i class="fa-solid fa-rotate-left"></i> معاد للمراجعة</div>
            {% else %}
              <div class="af-status-pill status-draft"><i class="fa-solid fa-pen-ruler"></i> مسودة</div>
            {% endif %}

            <div class="af-status-pill" style="background:rgba(255,255,255,0.5); border:1px solid var(--border-color); color:var(--text-secondary);">
                {% if can_edit_teacher %}وضع التحرير{% else %}وضع العرض{% endif %}
            </div>
        </div>

        <div class="af-actions">
            <a class="af-btn" href="{{ back_url }}">
              <i class="fa-solid fa-arrow-right"></i> رجوع
            </a>
            <a class="af-btn" href="{% url 'reports:achievement_file_print' file.pk %}" target="_blank">
              <i class="fa-solid fa-print"></i> PDF
            </a>
            {% if is_owner %}
            <a class="af-btn" href="{% url 'reports:achievement_share_manage' file.pk %}">
              <i class="fa-solid fa-share-nodes"></i> مشاركة
            </a>
            <a class="af-btn" href="{% url 'reports:achievement_my_files' %}">
              <i class="fa-solid fa-folder-open"></i> ملفاتي
            </a>
            {% endif %}
        </div>
    </div>

    <div class="af-body">
      
      {% if file.manager_notes %}
        <div class="af-note">ملاحظات المدير: {{ file.manager_notes|linebreaksbr }}</div>
      {% endif %}

      <!-- Private Comments -->
      {% if show_private_comments %}
        <h2 class="af-section-title">تعليقات خاصة (تظهر لك فقط)</h2>

        {% if can_add_private_comment %}
          <form class="af-form" method="post" autocomplete="off" style="margin-bottom:24px;">
            {% csrf_token %}
            <input type="hidden" name="action" value="private_comment_create" />
            <label class="af-label">أضف تعليقًا للمعلّم</label>
            {{ private_comment_form.body }}
            <div class="af-actions" style="margin-top:10px">
              <button class="af-btn af-btn-primary" type="submit">
                <i class="fa-solid fa-paper-plane" aria-hidden="true"></i> إرسال التعليق
              </button>
            </div>
          </form>
        {% endif %}

        {% if private_comments %}
          <div class="af-comment-box">
            {% for c in private_comments %}
              <div class="af-comment-item">
                <div class="af-comment-meta">
                  {% if c.created_by %}{{ c.created_by.name }}{% else %}النظام{% endif %}
                  <span style="font-weight:400; color:var(--text-secondary)">
                   {% if c.created_by %}
                    {% if c.created_by_role_label %} ({{ c.created_by_role_label }}){% else %} ({{ c.created_by.display_role_label }}){% endif %}
                   {% endif %}
                   — {{ c.created_at|date:"Y-m-d H:i" }}
                  </span>
                </div>
                <div class="af-comment-body" style="white-space:pre-wrap">{{ c.body }}</div>

                {% if can_add_private_comment and current_user_id %}
                  <div class="af-actions" style="margin-top:10px;gap:8px;flex-wrap:wrap">
                    {% if c.created_by_id == current_user_id %}
                      <details>
                        <summary class="af-btn" style="cursor:pointer; font-size:0.85rem; height:32px;">تعديل</summary>
                        <form method="post" class="af-form" style="margin-top:10px" autocomplete="off">
                          {% csrf_token %}
                          <input type="hidden" name="action" value="private_comment_update" />
                          <input type="hidden" name="comment_id" value="{{ c.id }}" />
                          <label class="af-label">نص التعليق</label>
                          <textarea name="body" rows="3" required>{{ c.body }}</textarea>
                          <div class="af-actions" style="margin-top:10px">
                            <button class="af-btn af-btn-primary" type="submit">حفظ التعديل</button>
                          </div>
                        </form>
                      </details>
                    {% endif %}
                    {% if c.created_by_id == current_user_id or is_superuser %}
                      <form method="post" onsubmit="return confirm('حذف التعليق نهائيًا؟');" style="display:inline">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="private_comment_delete" />
                        <input type="hidden" name="comment_id" value="{{ c.id }}" />
                        <button class="af-btn af-btn-danger" type="submit" style="font-size:0.85rem; height:32px;">حذف</button>
                      </form>
                    {% endif %}
                  </div>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="af-muted">لا توجد تعليقات خاصة.</div>
        {% endif %}
      {% endif %}

      <!-- General Data -->
      <h2 class="af-section-title">البيانات العامة</h2>

      {% if can_edit_teacher %}
        <form class="af-form" method="post" autocomplete="off">
          {% csrf_token %}
          <input type="hidden" name="action" value="save_general" />
          <div class="af-grid">
            <div>
              <label class="af-label">المؤهلات</label>
              {{ general_form.qualifications }}
            </div>
            <div>
              <label class="af-label">الخبرات المهنية</label>
              {{ general_form.professional_experience }}
            </div>
            <div>
              <label class="af-label">التخصص</label>
              {{ general_form.specialization }}
            </div>
            <div>
              <label class="af-label">نصاب الحصص</label>
              {{ general_form.teaching_load }}
            </div>
            <div>
              <label class="af-label">مواد التدريس</label>
              {{ general_form.subjects_taught }}
            </div>
            <div>
              <label class="af-label">بيانات التواصل</label>
              {{ general_form.contact_info }}
            </div>
          </div>

          <div class="af-actions" style="margin-top:24px; justify-content:flex-end;">
            <button class="af-btn" type="submit" name="action" value="import_prev" title="استيراد البيانات من آخر ملف إنجاز">
              <i class="fa-solid fa-clock-rotate-left" aria-hidden="true"></i> استيراد من السابق
            </button>
            <button class="af-btn af-btn-primary" type="submit">
                <i class="fa-solid fa-floppy-disk"></i> حفظ البيانات
            </button>
            <button class="af-btn af-btn-primary" type="submit" name="action" value="submit" style="background:#0f172a; border-color:#0f172a;">
              <i class="fa-solid fa-paper-plane" aria-hidden="true"></i> إرسال للاعتماد
            </button>
          </div>
        </form>
      {% else %}
        <div class="af-grid">
          <div><label class="af-label">المؤهلات</label><div class="af-muted">{{ file.qualifications|default:"-"|linebreaksbr }}</div></div>
          <div><label class="af-label">الخبرات المهنية</label><div class="af-muted">{{ file.professional_experience|default:"-"|linebreaksbr }}</div></div>
          <div><label class="af-label">التخصص</label><div class="af-muted">{{ file.specialization|default:"-"|linebreaksbr }}</div></div>
          <div><label class="af-label">نصاب الحصص</label><div class="af-muted">{{ file.teaching_load|default:"-"|linebreaksbr }}</div></div>
          <div><label class="af-label">مواد التدريس</label><div class="af-muted">{{ file.subjects_taught|default:"-"|linebreaksbr }}</div></div>
          <div><label class="af-label">بيانات التواصل</label><div class="af-muted">{{ file.contact_info|default:"-"|linebreaksbr }}</div></div>
        </div>
      {% endif %}

      <!-- Manager Actions -->
      {% if is_manager %}
        <h2 class="af-section-title">اعتماد مدير المدرسة</h2>
        <form class="af-form" method="post" autocomplete="off" class="af-card" style="padding:24px; box-shadow:none; border:2px dashed var(--brand); background:var(--brand-light);">
          {% csrf_token %}
          <div>
            <label class="af-label">ملاحظات المدير</label>
            {{ manager_notes_form.manager_notes }}
          </div>
          <div class="af-actions" style="margin-top:16px">
            <button class="af-btn af-btn-primary" type="submit" name="action" value="approve">
              <i class="fa-solid fa-circle-check" aria-hidden="true"></i> اعتماد + شكر
            </button>
            <button class="af-btn af-btn-danger" type="submit" name="action" value="return">
              <i class="fa-solid fa-arrow-rotate-left" aria-hidden="true"></i> رفض/إرجاع
            </button>
          </div>
        </form>
      {% endif %}

      <!-- Sections -->
      <h2 class="af-section-title">المحاور والشواهد</h2>

      <div class="af-sections">
        {% for s in sections %}
          <details class="af-details">
            <summary class="af-summary">
              <span>{{ s.get_code_display }}</span>
              <span style="font-size:0.85rem; padding:4px 10px; background:var(--surface); border-radius:8px;">
                 {{ s.evidence_images.count }} / 8
              </span>
            </summary>

            <div class="af-sec-body">
              {% if can_edit_teacher %}
                <form class="af-form" method="post" autocomplete="off">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="save_section" />
                  <input type="hidden" name="section_id" value="{{ s.id }}" />
                  <label class="af-label">ملاحظات المعلّم</label>
                  <textarea name="teacher_notes">{{ s.teacher_notes }}</textarea>
                  <div class="af-actions" style="margin-top:10px; justify-content:flex-end;">
                    <button class="af-btn af-btn-primary" type="submit">
                      <i class="fa-solid fa-floppy-disk" aria-hidden="true"></i> حفظ
                    </button>
                  </div>
                </form>

                <form class="af-form" method="post" enctype="multipart/form-data" style="margin-top:20px; padding-top:20px; border-top:1px dashed var(--border-color);" autocomplete="off">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="upload_evidence" />
                  <input type="hidden" name="section_id" value="{{ s.id }}" />
                  <label class="af-label">إضافة صور (يمكنك تحديد عدة صور)</label>
                  <input type="file" name="images" multiple accept="image/*" />
                  <div class="af-actions" style="margin-top:10px; justify-content:flex-end;">
                    <button class="af-btn af-btn-primary" type="submit">
                      <i class="fa-solid fa-cloud-arrow-up" aria-hidden="true"></i> رفع الصور
                    </button>
                  </div>
                </form>
              {% else %}
                <label class="af-label">ملاحظات المعلّم</label>
                <div class="af-muted" style="min-height:auto;">{{ s.teacher_notes|default:"-"|linebreaksbr }}</div>
              {% endif %}

              <div class="af-evidence" aria-label="صور الشواهد">
                {% for img in s.evidence_images.all %}
                  <div class="af-imgbox">
                    <button class="af-imgbtn" type="button" data-preview-src="{{ img.image.url }}" aria-label="معاينة الشاهد">
                      <img
                        src="{{ img.image.url }}"
                        alt="شاهد"
                        loading="lazy"
                        decoding="async"
                      />
                    </button>

                    {% if can_edit_teacher %}
                      <div class="af-img-actions">
                        <form method="post" style="margin:0">
                          {% csrf_token %}
                          <input type="hidden" name="action" value="delete_evidence" />
                          <input type="hidden" name="image_id" value="{{ img.id }}" />
                          <button class="af-btn af-btn-danger" type="submit" style="width:100%; height:32px; font-size:0.85rem;">
                            <i class="fa-solid fa-trash" aria-hidden="true"></i> حذف
                          </button>
                        </form>
                      </div>
                    {% endif %}
                  </div>
                {% empty %}
                  <div class="af-muted af-empty-mini" style="grid-column:1/-1; text-align:center; padding:20px;">لا توجد شواهد بعد.</div>
                {% endfor %}
              </div>
            </div>
          </details>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

{# Image Preview Modal #}
<div class="af-modal" id="afImgModal" role="dialog" aria-modal="true" aria-label="معاينة الصورة">
  <div class="af-modal-card" role="document">
    <div class="af-modal-hd">
      <h3 class="af-modal-ttl"><i class="fa-solid fa-image" aria-hidden="true"></i> معاينة الشاهد</h3>
      <button class="af-modal-close" type="button" id="afImgClose" aria-label="إغلاق">✕</button>
    </div>
    <div class="af-modal-bd">
      <img id="afImgPreview" src="" alt="معاينة" />
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  (function(){
    var modal = document.getElementById('afImgModal');
    var closeBtn = document.getElementById('afImgClose');
    var img = document.getElementById('afImgPreview');

    if(!modal || !img) return;

    function open(src){
      img.src = src;
      modal.classList.add('is-open');
      try{ if(window.__lockScroll) window.__lockScroll(true); }catch(e){}
    }

    function close(){
      modal.classList.remove('is-open');
      img.src = '';
      try{ if(window.__lockScroll) window.__lockScroll(false); }catch(e){}
    }

    document.addEventListener('click', function(ev){
      var btn = ev.target.closest && ev.target.closest('[data-preview-src]');
      if(btn){
        open(btn.getAttribute('data-preview-src'));
        return;
      }
    });

    if(closeBtn){
      closeBtn.addEventListener('click', close);
    }

    modal.addEventListener('click', function(ev){
      if(ev.target === modal) close();
    });

    document.addEventListener('keydown', function(ev){
      if(ev.key === 'Escape' && modal.classList.contains('is-open')) close();
    });
  })();

  // =========================================================
  // ضغط الصور قبل الرفع (Client-Side Compression)
  // =========================================================
  (function(){
    const MAX_WIDTH = 1600;
    const MAX_HEIGHT = 1600;
    const QUALITY = 0.7;

    async function compressFile(file) {
      // نضغط الصور فقط
      if (!file.type.match(/image.*/)) return file;

      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
          const img = new Image();
          img.src = event.target.result;
          img.onload = () => {
            let width = img.width;
            let height = img.height;

            // الحفاظ على الأبعاد النسبية
            if (width > MAX_WIDTH || height > MAX_HEIGHT) {
              if (width > height) {
                height = Math.round((height * MAX_WIDTH) / width);
                width = MAX_WIDTH;
              } else {
                width = Math.round((width * MAX_HEIGHT) / height);
                height = MAX_HEIGHT;
              }
            }

            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);

            // التحويل إلى Blob (JPEG)
            canvas.toBlob((blob) => {
              if (!blob) {
                resolve(file); // فشل الضغط، نعيد الملف الأصلي
                return;
              }
              // إنشاء ملف جديد من الـ Blob
              const newFile = new File([blob], file.name, {
                type: 'image/jpeg',
                lastModified: Date.now(),
              });
              resolve(newFile);
            }, 'image/jpeg', QUALITY);
          };
          img.onerror = () => resolve(file);
        };
        reader.onerror = () => resolve(file);
      });
    }

    // البحث عن جميع نماذج رفع الشواهد
    const forms = document.querySelectorAll('form');
    forms.forEach((form) => {
      // نتأكد أن الفورم هو فورم رفع شواهد (action=upload_evidence)
      const actionInput = form.querySelector('input[name="action"][value="upload_evidence"]');
      if (!actionInput) return;

      form.addEventListener('submit', async function(e) {
        const fileInput = form.querySelector('input[type="file"]');
        if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
          return; // لا توجد ملفات، اترك الفورم يرسل بشكل طبيعي (أو يظهر خطأ)
        }

        // إذا تم الضغط مسبقاً، لا تكرر العملية
        if (form.dataset.processed === "true") return;

        e.preventDefault(); // إيقاف الإرسال مؤقتاً

        // تحديث واجهة الزر
        const btn = form.querySelector('button[type="submit"]');
        const originalContent = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> جاري ضغط الصور...';

        try {
          const dataTransfer = new DataTransfer();
          const files = Array.from(fileInput.files);

          // ضغط كل ملف
          for (const file of files) {
            const compressed = await compressFile(file);
            dataTransfer.items.add(compressed);
          }

          // استبدال الملفات في الـ Input
          fileInput.files = dataTransfer.files;

          // وضع علامة وإعادة الإرسال
          form.dataset.processed = "true";
          form.submit();

        } catch (err) {
          console.error("Compression error:", err);
          // في حال حدوث خطأ، نحاول الإرسال بالملفات الأصلية
          form.dataset.processed = "true";
          form.submit();
        }
      });
    });
  })();
</script>
{% endblock %}
