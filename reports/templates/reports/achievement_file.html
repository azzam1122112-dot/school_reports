{# reports/templates/reports/achievement_file_detail.html (or your file) #}
{% extends "base.html" %}
{% load static %}

{% block title %}ملف الإنجاز{% endblock %}

{% block head %}
<style>
  /* =========================================================
     ملف الإنجاز - تصميم 2026 الفاخر
     Achievement File Detail — Luxury 2026 Edition
     ========================================================= */
  :root {
    --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --accent-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    --gold-gradient: linear-gradient(135deg, #ffd89b 0%, #f59e0b 100%);
    
    --brand: #667eea;
    --brand-dark: #764ba2;
    --brand-light: #eff6ff;
    --accent: #f59e0b;
    --surface: #f5f7fa;
    --border-color: #e2e8f0;
    --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.04);
    --shadow-md: 0 10px 40px rgba(0, 0, 0, 0.08);
    --shadow-lg: 0 20px 60px rgba(0, 0, 0, 0.15);
    --text-main: #0f172a;
    --text-secondary: #64748b;
  }

  html[data-theme="dark"] {
    --surface: #0f172a;
    --border-color: #334155;
    --text-main: #f1f5f9;
    --text-secondary: #94a3b8;
  }

  .af-wrap { 
    max-width: 1200px; 
    margin: 40px auto; 
    padding: clamp(20px, 3vw, 32px);
    animation: fadeInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1) backwards;
  }
  
  @keyframes fadeInUp {
    from { 
      opacity: 0; 
      transform: translateY(30px); 
    }
    to { 
      opacity: 1; 
      transform: translateY(0); 
    }
  }

  .af-card {
    background: white;
    border: 2px solid var(--border-color);
    border-radius: 28px;
    box-shadow: var(--shadow-lg);
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  html[data-theme="dark"] .af-card {
    background: #1e293b;
  }
  
  .af-head { 
    padding: 0; 
    background: white; 
  }
  
  html[data-theme="dark"] .af-head {
    background: #1e293b;
  }
  
  .af-body { 
    padding: 40px; 
    background: white; 
  }
  
  html[data-theme="dark"] .af-body {
    background: #1e293b;
  }

  /* ===== Hero Section ===== */
  .af-hero {
    position: relative;
    padding: 48px 40px;
    background: white;
    border-bottom: 2px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
    overflow: hidden;
  }
  
  html[data-theme="dark"] .af-hero {
    background: #1e293b;
  }
  
  .af-hero::before {
    content: '';
    position: absolute;
    top: -50%; 
    right: -10%; 
    width: 60%; 
    height: 220%;
    background: radial-gradient(circle, rgba(102, 126, 234, 0.08) 0%, transparent 65%);
    transform: rotate(-18deg);
    pointer-events: none;
    animation: pulseGlow 6s ease-in-out infinite;
  }
  
  @keyframes pulseGlow {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
  }
  
  .af-hero::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background: var(--primary-gradient);
    opacity: 0.3;
  }

  .af-hero-start {
    display: flex;
    align-items: center;
    gap: 28px;
    position: relative;
    z-index: 2;
  }
  
  .af-ministry-logo {
    width: 90px; 
    height: 90px;
    object-fit: contain;
    filter: drop-shadow(0 4px 12px rgba(102, 126, 234, 0.2));
    transition: all 0.3s ease;
  }
  
  .af-ministry-logo:hover {
    transform: scale(1.05) rotate(2deg);
  }

  .af-hero-info h1 {
    font-size: clamp(1.5rem, 3vw, 2.1rem);
    font-weight: 800;
    margin: 0 0 10px;
    background: var(--primary-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    letter-spacing: -0.6px;
    line-height: 1.2;
  }
  
  .af-hero-info .sub-info {
    font-size: 1.05rem;
    color: var(--text-secondary);
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 14px;
  }
  
  .af-hero-info .sub-info i { 
    color: var(--brand); 
    font-size: 1em;
    animation: bounce 2s ease-in-out infinite;
  }
  
  @keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-3px); }
  }

  .af-hero-end {
    text-align: left;
    position: relative;
    z-index: 2;
  }
  
  .af-year-badge {
    background: var(--gold-gradient);
    color: white;
    padding: 12px 20px;
    border-radius: 16px;
    font-weight: 800;
    font-size: 1.1rem;
    border: 2px solid rgba(245, 158, 11, 0.3);
    display: inline-flex;
    align-items: center;
    gap: 10px;
    box-shadow: 0 8px 20px rgba(245, 158, 11, 0.3);
    transition: all 0.3s ease;
  }
  
  .af-year-badge:hover {
    transform: translateY(-2px) scale(1.02);
    box-shadow: 0 12px 28px rgba(245, 158, 11, 0.4);
  }

  /* ===== Status Bar ===== */
  .af-status-bar {
    background: linear-gradient(to bottom, rgba(102, 126, 234, 0.03), transparent);
    padding: 18px 40px;
    border-bottom: 2px dashed var(--border-color);
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 20px;
  }
  
  .af-status-pill {
    display: inline-flex; 
    align-items: center; 
    gap: 10px;
    padding: 10px 18px; 
    border-radius: 999px;
    font-weight: 700; 
    font-size: 0.95rem;
    border: 2px solid transparent;
    transition: all 0.3s ease;
  }
  
  .af-status-pill:hover {
    transform: scale(1.05);
  }
  
  .status-draft { 
    background: linear-gradient(135deg, #e2e8f0, #cbd5e1); 
    color: #475569;
    border-color: rgba(71, 85, 105, 0.2);
  }
  
  .status-submit { 
    background: linear-gradient(135deg, #dbeafe, #bfdbfe); 
    color: #0284c7;
    border-color: rgba(2, 132, 199, 0.2);
  }
  
  .status-approve { 
    background: linear-gradient(135deg, #dcfce7, #bbf7d0); 
    color: #16a34a;
    border-color: rgba(22, 163, 74, 0.2);
  }
  
  .status-return { 
    background: linear-gradient(135deg, #fee2e2, #fecaca); 
    color: #dc2626;
    border-color: rgba(220, 38, 38, 0.2);
  }

  /* ===== Action Buttons ===== */
  .af-actions { 
    display: flex; 
    gap: 12px; 
    flex-wrap: wrap; 
  }
  
  .af-btn {
    display: inline-flex; 
    align-items: center; 
    justify-content: center; 
    gap: 10px;
    height: 48px; 
    padding: 0 22px; 
    border-radius: 14px;
    font-weight: 700; 
    font-size: 0.95rem; 
    cursor: pointer; 
    text-decoration: none;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border: 2px solid var(--border-color); 
    background: white; 
    color: var(--text-secondary);
  }
  
  html[data-theme="dark"] .af-btn {
    background: #1e293b;
  }
  
  .af-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    color: var(--brand); 
    border-color: var(--brand);
    background: rgba(102, 126, 234, 0.05);
  }
  
  .af-btn-primary {
    background: var(--primary-gradient);
    color: white; 
    border: none;
    box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
  }
  
  .af-btn-primary:hover {
    color: white; 
    transform: translateY(-3px);
    box-shadow: 0 12px 30px rgba(102, 126, 234, 0.4);
    background: var(--primary-gradient);
  }
  
  .af-btn-danger {
    background: linear-gradient(135deg, #fee2e2, #fecaca); 
    color: #dc2626; 
    border-color: rgba(220, 38, 38, 0.3);
  }
  
  .af-btn-danger:hover {
    background: linear-gradient(135deg, #fecaca, #fca5a5); 
    color: #b91c1c; 
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(220, 38, 38, 0.2);
  }

  /* ===== Section Titles ===== */
  h2.af-section-title {
    font-size: 1.5rem;
    font-weight: 800;
    color: var(--text-main);
    margin: 40px 0 24px;
    display: flex; 
    align-items: center; 
    gap: 14px;
    position: relative;
  }
  
  h2.af-section-title::before {
    content: ''; 
    width: 5px; 
    height: 32px;
    background: var(--gold-gradient); 
    border-radius: 6px;
    box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
  }

  /* ===== Comment Box ===== */
  .af-comment-box {
    background: var(--surface);
    border: 2px solid var(--border-color);
    border-radius: 20px;
    padding: 24px;
    box-shadow: var(--shadow-sm);
  }
  
  .af-comment-item {
    padding: 20px 0;
    border-bottom: 2px dashed var(--border-color);
  }
  
  .af-comment-item:last-child { 
    border-bottom: none; 
  }
  
  .af-comment-meta { 
    font-weight: 800; 
    font-size: 0.95rem; 
    color: var(--text-main); 
    margin-bottom: 8px; 
  }
  
  .af-comment-body { 
    color: var(--text-secondary); 
    line-height: 1.7; 
    font-weight: 600;
  }

  /* ===== Form & Grid ===== */
  .af-grid {
    display: grid; 
    grid-template-columns: repeat(2, 1fr); 
    gap: 28px;
    background: white; 
    border: 2px solid var(--border-color);
    border-radius: 24px; 
    padding: 32px;
    box-shadow: var(--shadow-sm);
  }
  
  html[data-theme="dark"] .af-grid {
    background: #1e293b;
  }
  
  @media(max-width: 800px) { 
    .af-grid { 
      grid-template-columns: 1fr; 
      padding: 24px;
    } 
  }
  
  .af-label { 
    display: block; 
    margin-bottom: 10px; 
    font-weight: 700; 
    color: var(--text-main); 
    font-size: 0.95rem;
    text-transform: uppercase;
    letter-spacing: 0.3px;
  }
  
  .af-form input, .af-form select, .af-form textarea, .af-muted {
    width: 100%; 
    padding: 14px 18px; 
    border-radius: 14px;
    border: 2px solid var(--border-color); 
    background: var(--surface);
    outline: none; 
    transition: all 0.3s ease;
    font-weight: 600; 
    color: var(--text-main);
    font-size: 1rem;
    box-sizing: border-box;
  }
  
  html[data-theme="dark"] .af-form input,
  html[data-theme="dark"] .af-form select,
  html[data-theme="dark"] .af-form textarea,
  html[data-theme="dark"] .af-muted {
    background: #0f172a;
  }
  
  .af-form input:focus, .af-form select:focus, .af-form textarea:focus {
    background: white; 
    border-color: var(--brand);
    box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    transform: translateY(-1px);
  }
  
  html[data-theme="dark"] .af-form input:focus,
  html[data-theme="dark"] .af-form select:focus,
  html[data-theme="dark"] .af-form textarea:focus {
    background: #1e293b;
  }
  
  textarea { 
    min-height: 140px; 
    resize: vertical; 
  }

  /* ===== Details/Accordions (Evidence) ===== */
  .af-details {
    border: 2px solid var(--border-color); 
    border-radius: 20px;
    background: white; 
    margin-bottom: 20px; 
    overflow: hidden;
    transition: all 0.3s ease;
  }
  
  html[data-theme="dark"] .af-details {
    background: #1e293b;
  }
  
  .af-details[open] { 
    box-shadow: 0 12px 30px rgba(0, 0, 0, 0.08); 
    border-color: var(--brand);
    background: rgba(102, 126, 234, 0.02);
  }
  
  .af-summary {
    padding: 20px 24px; 
    font-weight: 800; 
    cursor: pointer;
    display: flex; 
    justify-content: space-between; 
    align-items: center;
    background: white;
    transition: all 0.3s ease;
    font-size: 1.05rem;
  }
  
  html[data-theme="dark"] .af-summary {
    background: #1e293b;
  }
  
  .af-summary:hover {
    background: rgba(102, 126, 234, 0.05);
  }
  
  .af-summary::-webkit-details-marker { 
    display: none; 
  }
  
  .af-sec-body { 
    padding: 28px; 
    border-top: 2px solid var(--border-color); 
    background: var(--surface); 
  }

  /* ===== Evidence Images ===== */
  .af-evidence { 
    display: grid; 
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); 
    gap: 20px; 
    margin-top: 20px;
  }
  
  .af-imgbox {
    border-radius: 16px; 
    overflow: hidden; 
    position: relative;
    border: 2px solid var(--border-color); 
    box-shadow: var(--shadow-sm);
    background: white; 
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .af-imgbox:hover { 
    transform: translateY(-6px) scale(1.02); 
    box-shadow: var(--shadow-md);
    border-color: var(--brand);
  }
  
  .af-imgbox img { 
    width: 100%; 
    height: 160px; 
    object-fit: cover; 
    display: block; 
  }
  
  .af-imgbtn { 
    padding: 0; 
    border: none; 
    background: transparent; 
    width: 100%; 
    cursor: pointer; 
  }
  
  .af-img-actions { 
    padding: 12px; 
  }
  
  /* ===== Manager Note Box ===== */
  .af-note {
    padding: 20px; 
    border-radius: 18px; 
    margin-bottom: 28px;
    background: linear-gradient(135deg, #fffbeb, #fef3c7);
    border: 2px solid rgba(245, 158, 11, 0.4);
    color: #b45309; 
    font-weight: 700;
    box-shadow: 0 4px 12px rgba(245, 158, 11, 0.15);
  }

  /* ===== Evidence Reports ===== */
  .af-evr { 
    margin-top: 28px; 
    padding-top: 28px; 
    border-top: 2px dashed var(--border-color); 
  }
  
  .af-evr-head { 
    display: flex; 
    align-items: center; 
    justify-content: space-between; 
    gap: 16px; 
    flex-wrap: wrap; 
  }
  
  .af-evr-title { 
    font-weight: 800; 
    color: var(--text-main); 
    display: flex; 
    align-items: center; 
    gap: 12px;
    font-size: 1.1rem;
  }
  
  .af-evr-list { 
    display: grid; 
    gap: 16px; 
    margin-top: 16px; 
  }
  
  .af-evr-item { 
    background: white; 
    border: 2px solid var(--border-color); 
    border-radius: 18px; 
    padding: 20px; 
    display: flex; 
    align-items: flex-start; 
    justify-content: space-between; 
    gap: 18px;
    transition: all 0.3s ease;
  }
  
  html[data-theme="dark"] .af-evr-item {
    background: #1e293b;
  }
  
  .af-evr-item:hover {
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
    border-color: var(--brand);
  }
  
  .af-evr-meta { 
    margin-top: 8px; 
    color: var(--text-secondary); 
    font-weight: 700; 
    font-size: 0.9rem; 
    display: flex; 
    gap: 12px; 
    flex-wrap: wrap; 
    justify-content: flex-end; 
  }
  
  .af-badge { 
    display: inline-flex; 
    align-items: center; 
    gap: 8px; 
    padding: 6px 14px; 
    border-radius: 999px; 
    border: 2px solid var(--border-color); 
    background: var(--surface); 
    font-weight: 800; 
    font-size: 0.88rem; 
    color: var(--text-main);
    transition: all 0.3s ease;
  }
  
  .af-badge:hover {
    transform: scale(1.05);
  }
  
  .af-badge-frozen { 
    background: linear-gradient(135deg, #cffafe, #a5f3fc); 
    border-color: rgba(6, 182, 212, 0.3); 
    color: #0e7490;
    box-shadow: 0 4px 12px rgba(6, 182, 212, 0.15);
  }

  /* ===== Modal ===== */
  .af-modal { 
    display: none; 
    position: fixed; 
    inset: 0; 
    z-index: 14000; 
    background: rgba(0, 0, 0, 0.75); 
    backdrop-filter: blur(8px); 
    place-items: center; 
  }
  
  .af-modal.is-open { 
    display: grid; 
  }
  
  .af-modal-card { 
    background: white; 
    border-radius: 24px; 
    width: min(950px, 96vw); 
    max-height: 92vh; 
    overflow: hidden; 
    display: flex; 
    flex-direction: column;
    box-shadow: 0 30px 80px rgba(0, 0, 0, 0.4);
    animation: modalSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  html[data-theme="dark"] .af-modal-card {
    background: #1e293b;
  }
  
  @keyframes modalSlideIn {
    from {
      opacity: 0;
      transform: translateY(-40px) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }
  
  .af-modal-hd { 
    padding: 24px 28px; 
    border-bottom: 2px solid var(--border-color); 
    display: flex; 
    justify-content: space-between; 
    align-items: center;
    background: linear-gradient(to bottom, rgba(102, 126, 234, 0.05), transparent);
  }
  
  .af-modal-hd h3 {
    margin: 0;
    font-weight: 800;
    font-size: 1.3rem;
    color: var(--text-main);
  }
  
  .af-modal-bd { 
    padding: 28px; 
    overflow: auto; 
    text-align: center; 
    background: #f5f7fa; 
  }
  
  html[data-theme="dark"] .af-modal-bd {
    background: #0f172a;
  }
  
  /* ===== Responsive Hero ===== */
  @media(max-width: 768px) {
    .af-hero { 
      flex-direction: column; 
      text-align: center; 
      gap: 24px;
      padding: 32px 24px;
    }
    
    .af-hero-start { 
      flex-direction: column; 
    }
    
    .af-hero-info .sub-info { 
      justify-content: center; 
    }
    
    .af-status-bar { 
      flex-direction: column; 
      align-items: stretch; 
      text-align: center;
      padding: 16px 24px;
    }
    
    .af-status-bar > div:first-child { 
      justify-content: center; 
    }
    
    .af-actions { 
      justify-content: center; 
    }
    
    h2.af-section-title {
      font-size: 1.3rem;
    }
    
    .af-body {
      padding: 28px 20px;
    }
    
    .af-evidence {
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    }
  }
  
  /* ===== Reduce Motion ===== */
  @media (prefers-reduced-motion: reduce) {
    .af-wrap,
    .af-card,
    .af-btn,
    .af-imgbox,
    .af-evr-item,
    .af-modal-card {
      animation: none !important;
      transition: none !important;
    }
    
    .af-btn:hover,
    .af-imgbox:hover,
    .af-evr-item:hover {
      transform: none !important;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="af-wrap">
  <div class="af-card">
    
    <!-- Modern Header -->
    <header class="af-hero" aria-label="رأس الملف">
      <div class="af-hero-start">
        <img class="af-ministry-logo" src="{% static 'img/logo1.png' %}" alt="شعار">
        <div class="af-hero-info">
          <h1>{{ file.school_name }}</h1>
          <div class="sub-info">
            <i class="fa-solid fa-user-tie"></i>
            {{ file.teacher_name }}
          </div>
        </div>
      </div>
      <div class="af-hero-end">
        <div class="af-year-badge">
            <i class="fa-solid fa-calendar-check" style="color:var(--brand);"></i>
            {{ file.academic_year }} هـ
        </div>
      </div>
    </header>

    <!-- Status & Meta Bar -->
    <div class="af-status-bar">
        <div style="display:flex; gap:16px; align-items:center;">
            {% if file.status == "approved" or file.status == "APPROVED" %}
              <div class="af-status-pill status-approve"><i class="fa-solid fa-check-circle"></i> معتمد</div>
            {% elif file.status == "submitted" or file.status == "SUBMITTED" %}
              <div class="af-status-pill status-submit"><i class="fa-solid fa-hourglass-half"></i> بانتظار الاعتماد</div>
            {% elif file.status == "returned" or file.status == "RETURNED" %}
              <div class="af-status-pill status-return"><i class="fa-solid fa-rotate-left"></i> معاد للمراجعة</div>
            {% else %}
              <div class="af-status-pill status-draft"><i class="fa-solid fa-pen-ruler"></i> مسودة</div>
            {% endif %}

            <div class="af-status-pill" style="background:rgba(255,255,255,0.5); border:1px solid var(--border-color); color:var(--text-secondary);">
                {% if can_edit_teacher %}وضع التحرير{% else %}وضع العرض{% endif %}
            </div>
        </div>

        <div class="af-actions">
            <a class="af-btn" href="{{ back_url }}">
              <i class="fa-solid fa-arrow-right"></i> رجوع
            </a>
            <a class="af-btn" href="{% url 'reports:achievement_file_print' file.pk %}" target="_blank">
              <i class="fa-solid fa-print"></i> PDF
            </a>
            {% if is_owner %}
            <a class="af-btn" href="{% url 'reports:achievement_share_manage' file.pk %}">
              <i class="fa-solid fa-share-nodes"></i> مشاركة
            </a>
            <a class="af-btn" href="{% url 'reports:achievement_my_files' %}">
              <i class="fa-solid fa-folder-open"></i> ملفاتي
            </a>
            {% endif %}
        </div>
    </div>

    <div class="af-body">
      
      {% if file.manager_notes %}
        <div class="af-note">ملاحظات المدير: {{ file.manager_notes|linebreaksbr }}</div>
      {% endif %}

      <!-- Private Comments -->
      {% if show_private_comments %}
        <h2 class="af-section-title">تعليقات خاصة (تظهر لك فقط)</h2>

        {% if can_add_private_comment %}
          <form class="af-form" method="post" autocomplete="off" style="margin-bottom:24px;">
            {% csrf_token %}
            <input type="hidden" name="action" value="private_comment_create" />
            <label class="af-label">أضف تعليقًا للمعلّم</label>
            {{ private_comment_form.body }}
            <div class="af-actions" style="margin-top:10px">
              <button class="af-btn af-btn-primary" type="submit">
                <i class="fa-solid fa-paper-plane" aria-hidden="true"></i> إرسال التعليق
              </button>
            </div>
          </form>
        {% endif %}

        {% if private_comments %}
          <div class="af-comment-box">
            {% for c in private_comments %}
              <div class="af-comment-item">
                <div class="af-comment-meta">
                  {% if c.created_by %}{{ c.created_by.name }}{% else %}النظام{% endif %}
                  <span style="font-weight:400; color:var(--text-secondary)">
                   {% if c.created_by %}
                    {% if c.created_by_role_label %} ({{ c.created_by_role_label }}){% else %} ({{ c.created_by.display_role_label }}){% endif %}
                   {% endif %}
                   — {{ c.created_at|date:"Y-m-d H:i" }}
                  </span>
                </div>
                <div class="af-comment-body" style="white-space:pre-wrap">{{ c.body }}</div>

                {% if can_add_private_comment and current_user_id %}
                  <div class="af-actions" style="margin-top:10px;gap:8px;flex-wrap:wrap">
                    {% if c.created_by_id == current_user_id %}
                      <details>
                        <summary class="af-btn" style="cursor:pointer; font-size:0.85rem; height:32px;">تعديل</summary>
                        <form method="post" class="af-form" style="margin-top:10px" autocomplete="off">
                          {% csrf_token %}
                          <input type="hidden" name="action" value="private_comment_update" />
                          <input type="hidden" name="comment_id" value="{{ c.id }}" />
                          <label class="af-label">نص التعليق</label>
                          <textarea name="body" rows="3" required>{{ c.body }}</textarea>
                          <div class="af-actions" style="margin-top:10px">
                            <button class="af-btn af-btn-primary" type="submit">حفظ التعديل</button>
                          </div>
                        </form>
                      </details>
                    {% endif %}
                    {% if c.created_by_id == current_user_id or is_superuser %}
                      <form method="post" onsubmit="return confirm('حذف التعليق نهائيًا؟');" style="display:inline">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="private_comment_delete" />
                        <input type="hidden" name="comment_id" value="{{ c.id }}" />
                        <button class="af-btn af-btn-danger" type="submit" style="font-size:0.85rem; height:32px;">حذف</button>
                      </form>
                    {% endif %}
                  </div>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="af-muted">لا توجد تعليقات خاصة.</div>
        {% endif %}
      {% endif %}

      <!-- General Data -->
      <h2 class="af-section-title">البيانات العامة</h2>

      {% if can_edit_teacher %}
        <form class="af-form" method="post" autocomplete="off">
          {% csrf_token %}
          <input type="hidden" name="action" value="save_general" />
          <div class="af-grid">
            <div>
              <label class="af-label">المؤهلات</label>
              {{ general_form.qualifications }}
            </div>
            <div>
              <label class="af-label">الخبرات المهنية</label>
              {{ general_form.professional_experience }}
            </div>
            <div>
              <label class="af-label">التخصص</label>
              {{ general_form.specialization }}
            </div>
            <div>
              <label class="af-label">نصاب الحصص</label>
              {{ general_form.teaching_load }}
            </div>
            <div>
              <label class="af-label">مواد التدريس</label>
              {{ general_form.subjects_taught }}
            </div>
            <div>
              <label class="af-label">بيانات التواصل</label>
              {{ general_form.contact_info }}
            </div>
          </div>

          <div class="af-actions" style="margin-top:24px; justify-content:flex-end;">
            <button class="af-btn" type="submit" name="action" value="import_prev" title="استيراد البيانات من آخر ملف إنجاز">
              <i class="fa-solid fa-clock-rotate-left" aria-hidden="true"></i> استيراد من السابق
            </button>
            <button class="af-btn af-btn-primary" type="submit">
                <i class="fa-solid fa-floppy-disk"></i> حفظ البيانات
            </button>
            <button class="af-btn af-btn-primary" type="submit" name="action" value="submit" style="background:#0f172a; border-color:#0f172a;">
              <i class="fa-solid fa-paper-plane" aria-hidden="true"></i> إرسال للاعتماد
            </button>
          </div>
        </form>
      {% else %}
        <div class="af-grid">
          <div><label class="af-label">المؤهلات</label><div class="af-muted">{{ file.qualifications|default:"-"|linebreaksbr }}</div></div>
          <div><label class="af-label">الخبرات المهنية</label><div class="af-muted">{{ file.professional_experience|default:"-"|linebreaksbr }}</div></div>
          <div><label class="af-label">التخصص</label><div class="af-muted">{{ file.specialization|default:"-"|linebreaksbr }}</div></div>
          <div><label class="af-label">نصاب الحصص</label><div class="af-muted">{{ file.teaching_load|default:"-"|linebreaksbr }}</div></div>
          <div><label class="af-label">مواد التدريس</label><div class="af-muted">{{ file.subjects_taught|default:"-"|linebreaksbr }}</div></div>
          <div><label class="af-label">بيانات التواصل</label><div class="af-muted">{{ file.contact_info|default:"-"|linebreaksbr }}</div></div>
        </div>
      {% endif %}

      <!-- Manager Actions -->
      {% if is_manager %}
        <h2 class="af-section-title">اعتماد {{ SCHOOL_MANAGER_LABEL|default:"مدير المدرسة" }}</h2>
        <form class="af-form" method="post" autocomplete="off" class="af-card" style="padding:24px; box-shadow:none; border:2px dashed var(--brand); background:var(--brand-light);">
          {% csrf_token %}
          <div>
            <label class="af-label">ملاحظات المدير</label>
            {{ manager_notes_form.manager_notes }}
          </div>
          <div class="af-actions" style="margin-top:16px">
            <button class="af-btn af-btn-primary" type="submit" name="action" value="approve">
              <i class="fa-solid fa-circle-check" aria-hidden="true"></i> اعتماد + شكر
            </button>
            <button class="af-btn af-btn-danger" type="submit" name="action" value="return">
              <i class="fa-solid fa-arrow-rotate-left" aria-hidden="true"></i> رفض/إرجاع
            </button>
          </div>
        </form>
      {% endif %}

      <!-- Sections -->
      <h2 class="af-section-title">المحاور والشواهد</h2>

      <div class="af-sections">
        {% for s in sections %}
          <details class="af-details">
            <summary class="af-summary">
              <span>{{ s.get_code_display }}</span>
              <span style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-start;">
                <span style="font-size:0.85rem; padding:4px 10px; background:var(--surface); border-radius:8px; border:1px solid var(--border-color);">
                  صور: {{ s.evidence_images.all|length }} / 8
                </span>
                <span style="font-size:0.85rem; padding:4px 10px; background:var(--surface); border-radius:8px; border:1px solid var(--border-color);">
                  تقارير: {{ s.evidence_reports.all|length }}
                </span>
              </span>
            </summary>

            <div class="af-sec-body">
              {% if can_edit_teacher %}
                <form class="af-form" method="post" autocomplete="off">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="save_section" />
                  <input type="hidden" name="section_id" value="{{ s.id }}" />
                  <label class="af-label">ملاحظات {{ SCHOOL_TEACHER_LABEL|default:"المعلّم" }}</label>
                  <textarea name="teacher_notes">{{ s.teacher_notes }}</textarea>
                  <div class="af-actions" style="margin-top:10px; justify-content:flex-end;">
                    <button class="af-btn af-btn-primary" type="submit">
                      <i class="fa-solid fa-floppy-disk" aria-hidden="true"></i> حفظ
                    </button>
                  </div>
                </form>

                <form class="af-form" method="post" enctype="multipart/form-data" style="margin-top:20px; padding-top:20px; border-top:1px dashed var(--border-color);" autocomplete="off">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="upload_evidence" />
                  <input type="hidden" name="section_id" value="{{ s.id }}" />
                  <label class="af-label">إضافة صور (يمكنك تحديد عدة صور)</label>
                  <input type="file" name="images" multiple accept="image/*" />
                  <div class="af-actions" style="margin-top:10px; justify-content:flex-end;">
                    <button class="af-btn af-btn-primary" type="submit">
                      <i class="fa-solid fa-cloud-arrow-up" aria-hidden="true"></i> رفع الصور
                    </button>
                  </div>
                </form>
              {% else %}
                <label class="af-label">ملاحظات {{ SCHOOL_TEACHER_LABEL|default:"المعلّم" }}</label>
                <div class="af-muted" style="min-height:auto;">{{ s.teacher_notes|default:"-"|linebreaksbr }}</div>
              {% endif %}

              <div class="af-evr" aria-label="تقارير الشواهد">
                <div class="af-evr-head">
                  <div class="af-evr-title">
                    <i class="fa-solid fa-file-lines" aria-hidden="true"></i>
                    تقارير كشواهد
                  </div>
                  {% if can_edit_teacher %}
                    <button class="af-btn" type="button" data-open-report-picker data-section-id="{{ s.id }}">
                      <i class="fa-solid fa-plus" aria-hidden="true"></i> إضافة تقرير
                    </button>
                  {% endif %}
                </div>

                <div class="af-evr-list">
                  {% for ev in s.evidence_reports.all %}
                    <div class="af-evr-item">
                      <div style="min-width:0; text-align:right;">
                        <div style="display:flex; gap:10px; align-items:center; justify-content:flex-end; flex-wrap:wrap;">
                          <div style="font-weight:900; color:var(--text-main); line-height:1.4; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:620px;">
                            {% if ev.is_frozen %}
                              {{ ev.frozen_data.title|default:"(تقرير مثبت)" }}
                            {% elif ev.report %}
                              {{ ev.report.title|default:"(بدون عنوان)" }}
                            {% else %}
                              (تم حذف التقرير)
                            {% endif %}
                          </div>
                          {% if ev.is_frozen %}
                            <span class="af-badge af-badge-frozen"><i class="fa-solid fa-lock" aria-hidden="true"></i> مثبت</span>
                          {% endif %}
                        </div>

                        <div class="af-evr-meta">
                          {% if ev.is_frozen and ev.frozen_data.category %}
                            <span class="af-badge">{{ ev.frozen_data.category }}</span>
                          {% elif ev.report and ev.report.category %}
                            <span class="af-badge">{{ ev.report.category.name }}</span>
                          {% endif %}

                          {% if ev.is_frozen and ev.frozen_data.report_date %}
                            <span style="opacity:0.9;">{{ ev.frozen_data.report_date }}</span>
                          {% elif ev.report and ev.report.report_date %}
                            <span style="opacity:0.9;">{{ ev.report.report_date|date:"Y-m-d" }}</span>
                          {% endif %}
                        </div>
                      </div>

                      <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-start;">
                        {% if ev.report %}
                          <a class="af-btn" href="{% url 'reports:report_print' ev.report.pk %}" target="_blank" rel="noopener" style="height:38px;">
                            <i class="fa-solid fa-print" aria-hidden="true"></i> عرض الأصلي
                          </a>
                        {% else %}
                          <button class="af-btn" type="button" disabled style="opacity:0.6; cursor:not-allowed; height:38px;">الأصلي محذوف</button>
                        {% endif %}

                        {% if can_edit_teacher %}
                          <form method="post" style="margin:0">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="delete_report_evidence" />
                            <input type="hidden" name="section_id" value="{{ s.id }}" />
                            <input type="hidden" name="evidence_id" value="{{ ev.id }}" />
                            <button class="af-btn af-btn-danger" type="submit" style="height:38px;">
                              <i class="fa-solid fa-trash" aria-hidden="true"></i> إزالة
                            </button>
                          </form>
                        {% endif %}
                      </div>
                    </div>
                  {% empty %}
                    <div class="af-muted" style="padding:14px; background:white; border-radius:16px; border:1px dashed var(--border-color); text-align:center;">
                      لا توجد تقارير كشواهد لهذا المحور.
                    </div>
                  {% endfor %}
                </div>
              </div>

              <div class="af-evidence" aria-label="صور الشواهد">
                {% for img in s.evidence_images.all %}
                  <div class="af-imgbox">
                    <button class="af-imgbtn" type="button" data-preview-src="{{ img.image.url }}" aria-label="معاينة الشاهد">
                      <img
                        src="{{ img.image.url }}"
                        alt="شاهد"
                        loading="lazy"
                        decoding="async"
                      />
                    </button>

                    {% if can_edit_teacher %}
                      <div class="af-img-actions">
                        <form method="post" style="margin:0">
                          {% csrf_token %}
                          <input type="hidden" name="action" value="delete_evidence" />
                          <input type="hidden" name="image_id" value="{{ img.id }}" />
                          <button class="af-btn af-btn-danger" type="submit" style="width:100%; height:32px; font-size:0.85rem;">
                            <i class="fa-solid fa-trash" aria-hidden="true"></i> حذف
                          </button>
                        </form>
                      </div>
                    {% endif %}
                  </div>
                {% empty %}
                  <div class="af-muted af-empty-mini" style="grid-column:1/-1; text-align:center; padding:20px;">لا توجد شواهد بعد.</div>
                {% endfor %}
              </div>
            </div>
          </details>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

{# Image Preview Modal #}
<div class="af-modal" id="afImgModal" role="dialog" aria-modal="true" aria-label="معاينة الصورة">
  <div class="af-modal-card" role="document">
    <div class="af-modal-hd">
      <h3 class="af-modal-ttl"><i class="fa-solid fa-image" aria-hidden="true"></i> معاينة الشاهد</h3>
      <button class="af-modal-close" type="button" id="afImgClose" aria-label="إغلاق">✕</button>
    </div>
    <div class="af-modal-bd">
      <img id="afImgPreview" src="" alt="معاينة" />
    </div>
  </div>
</div>

{# Report Picker Modal #}
<div class="af-modal" id="afReportModal" role="dialog" aria-modal="true" aria-label="اختيار تقرير كشاهد">
  <div class="af-modal-card" role="document">
    <div class="af-modal-hd" style="gap:12px; flex-wrap:wrap;">
      <h3 class="af-modal-ttl" style="margin:0"><i class="fa-solid fa-file-lines" aria-hidden="true"></i> اختيار تقرير</h3>
      <div style="display:flex; align-items:center; gap:10px; flex:1; justify-content:flex-start;">
        <input id="afReportSearch" type="text" placeholder="ابحث في تقاريري..." style="width: min(460px, 70vw);" />
        <button class="af-btn" type="button" id="afReportReload" style="height:38px;"><i class="fa-solid fa-rotate" aria-hidden="true"></i></button>
        <button class="af-modal-close" type="button" id="afReportClose" aria-label="إغلاق">✕</button>
      </div>
    </div>
    <div class="af-modal-bd" style="background:var(--surface); text-align:right;">
      <div id="afReportResults" style="text-align:right;"></div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  (function(){
    var modal = document.getElementById('afImgModal');
    var closeBtn = document.getElementById('afImgClose');
    var img = document.getElementById('afImgPreview');

    if(!modal || !img) return;

    function open(src){
      img.src = src;
      modal.classList.add('is-open');
      try{ if(window.__lockScroll) window.__lockScroll(true); }catch(e){}
    }

    function close(){
      modal.classList.remove('is-open');
      img.src = '';
      try{ if(window.__lockScroll) window.__lockScroll(false); }catch(e){}
    }

    document.addEventListener('click', function(ev){
      var btn = ev.target.closest && ev.target.closest('[data-preview-src]');
      if(btn){
        open(btn.getAttribute('data-preview-src'));
        return;
      }
    });

    if(closeBtn){
      closeBtn.addEventListener('click', close);
    }

    modal.addEventListener('click', function(ev){
      if(ev.target === modal) close();
    });

    document.addEventListener('keydown', function(ev){
      if(ev.key === 'Escape' && modal.classList.contains('is-open')) close();
    });
  })();

  // =========================================================
  // منتقي التقارير (تقارير كشواهد)
  // =========================================================
  (function(){
    var modal = document.getElementById('afReportModal');
    var closeBtn = document.getElementById('afReportClose');
    var searchInput = document.getElementById('afReportSearch');
    var reloadBtn = document.getElementById('afReportReload');
    var results = document.getElementById('afReportResults');

    if(!modal || !results) return;

    var currentSectionId = null;
    var pickerUrl = "{% url 'reports:achievement_report_picker' file.pk %}";
    var timer = null;

    function open(sectionId){
      currentSectionId = sectionId;
      modal.classList.add('is-open');
      try{ if(window.__lockScroll) window.__lockScroll(true); }catch(e){}
      if(searchInput) searchInput.value = '';
      load('');
      try{ if(searchInput) searchInput.focus(); }catch(e){}
    }

    function close(){
      modal.classList.remove('is-open');
      results.innerHTML = '';
      currentSectionId = null;
      try{ if(window.__lockScroll) window.__lockScroll(false); }catch(e){}
    }

    function load(q){
      if(!currentSectionId) return;
      results.innerHTML = '<div class="af-muted" style="padding:14px; text-align:center;">جارٍ التحميل...</div>';
      var url = pickerUrl + '?section_id=' + encodeURIComponent(currentSectionId) + '&q=' + encodeURIComponent(q || '');
      fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
        .then(function(r){ return r.text(); })
        .then(function(html){ results.innerHTML = html; })
        .catch(function(){ results.innerHTML = '<div class="af-muted" style="padding:14px; text-align:center;">تعذر تحميل القائمة.</div>'; });
    }

    document.addEventListener('click', function(ev){
      var btn = ev.target.closest && ev.target.closest('[data-open-report-picker]');
      if(btn){
        open(btn.getAttribute('data-section-id'));
        return;
      }
    });

    if(closeBtn){ closeBtn.addEventListener('click', close); }
    modal.addEventListener('click', function(ev){ if(ev.target === modal) close(); });
    document.addEventListener('keydown', function(ev){ if(ev.key === 'Escape' && modal.classList.contains('is-open')) close(); });

    if(searchInput){
      searchInput.addEventListener('input', function(){
        clearTimeout(timer);
        timer = setTimeout(function(){ load(searchInput.value || ''); }, 220);
      });
    }
    if(reloadBtn){
      reloadBtn.addEventListener('click', function(){ load((searchInput && searchInput.value) || ''); });
    }
  })();

  // =========================================================
  // ضغط الصور قبل الرفع (Client-Side Compression)
  // =========================================================
  (function(){
    const MAX_WIDTH = 1600;
    const MAX_HEIGHT = 1600;
    const QUALITY = 0.7;

    async function compressFile(file) {
      // نضغط الصور فقط
      if (!file.type.match(/image.*/)) return file;

      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (event) => {
          const img = new Image();
          img.src = event.target.result;
          img.onload = () => {
            let width = img.width;
            let height = img.height;

            // الحفاظ على الأبعاد النسبية
            if (width > MAX_WIDTH || height > MAX_HEIGHT) {
              if (width > height) {
                height = Math.round((height * MAX_WIDTH) / width);
                width = MAX_WIDTH;
              } else {
                width = Math.round((width * MAX_HEIGHT) / height);
                height = MAX_HEIGHT;
              }
            }

            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);

            // التحويل إلى Blob (JPEG)
            canvas.toBlob((blob) => {
              if (!blob) {
                resolve(file); // فشل الضغط، نعيد الملف الأصلي
                return;
              }
              // إنشاء ملف جديد من الـ Blob
              const newFile = new File([blob], file.name, {
                type: 'image/jpeg',
                lastModified: Date.now(),
              });
              resolve(newFile);
            }, 'image/jpeg', QUALITY);
          };
          img.onerror = () => resolve(file);
        };
        reader.onerror = () => resolve(file);
      });
    }

    // البحث عن جميع نماذج رفع الشواهد
    const forms = document.querySelectorAll('form');
    forms.forEach((form) => {
      // نتأكد أن الفورم هو فورم رفع شواهد (action=upload_evidence)
      const actionInput = form.querySelector('input[name="action"][value="upload_evidence"]');
      if (!actionInput) return;

      form.addEventListener('submit', async function(e) {
        const fileInput = form.querySelector('input[type="file"]');
        if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
          return; // لا توجد ملفات، اترك الفورم يرسل بشكل طبيعي (أو يظهر خطأ)
        }

        // إذا تم الضغط مسبقاً، لا تكرر العملية
        if (form.dataset.processed === "true") return;

        e.preventDefault(); // إيقاف الإرسال مؤقتاً

        // تحديث واجهة الزر
        const btn = form.querySelector('button[type="submit"]');
        const originalContent = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> جاري ضغط الصور...';

        try {
          const dataTransfer = new DataTransfer();
          const files = Array.from(fileInput.files);

          // ضغط كل ملف
          for (const file of files) {
            const compressed = await compressFile(file);
            dataTransfer.items.add(compressed);
          }

          // استبدال الملفات في الـ Input
          fileInput.files = dataTransfer.files;

          // وضع علامة وإعادة الإرسال
          form.dataset.processed = "true";
          form.submit();

        } catch (err) {
          console.error("Compression error:", err);
          // في حال حدوث خطأ، نحاول الإرسال بالملفات الأصلية
          form.dataset.processed = "true";
          form.submit();
        }
      });
    });
  })();
</script>
{% endblock %}
