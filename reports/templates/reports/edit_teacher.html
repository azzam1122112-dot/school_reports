{# templates/reports/teacher_edit.html (أو اسم ملفك الحالي) #}
{% extends "base.html" %}
{% block title %}تعديل بيانات المعلم{% endblock %}

{% block head %}
<style>
  /* =========================================================
     TEACHER EDIT (page-only, scoped)
     - بدون إعادة تعريف .btn / .card
     - Dark mode عبر html[data-theme="dark"]
     ========================================================= */

  .teacher-edit-scope{
    --te-ink: var(--ink, #0f172a);
    --te-muted: var(--muted, #6b7280);
    --te-line: var(--line, #e5e7eb);
    --te-card: var(--card, #ffffff);

    --te-brand:#2563eb;
    --te-brand2:#3b82f6;
    --te-danger:#b91c1c;

    --te-radius: 16px;
    --te-shadow: 0 10px 30px rgba(2,6,23,.08);
    --te-ring: 0 0 0 3px rgba(37,99,235,.22);
    --te-tap: 48px;
  }

  html[data-theme="dark"] .teacher-edit-scope{
    --te-ink: var(--ink, #e5e7eb);
    --te-muted: var(--muted, #94a3b8);
    --te-line: var(--line, #1f2937);
    --te-card: var(--card, #0f172a);
    --te-shadow: 0 14px 40px rgba(0,0,0,.45);
  }

  .teacher-edit-scope .te-wrap{
    max-width: 900px;
    margin: 0 auto;
    padding: clamp(10px, 2.5vw, 18px);
  }

  .teacher-edit-scope .te-card{
    background: var(--te-card);
    border: 1px solid var(--te-line);
    border-radius: var(--te-radius);
    box-shadow: var(--te-shadow);
    overflow: hidden;
  }

  .teacher-edit-scope .te-header{
    background: linear-gradient(135deg, #f59e0b, #fb923c);
    color: #111827;
    padding: clamp(18px, 2.2vw, 26px) clamp(18px, 3vw, 30px);
    text-align: center;
  }
  html[data-theme="dark"] .teacher-edit-scope .te-header{ color:#0b1220; }

  .teacher-edit-scope .te-title{
    margin: 0 0 6px;
    font-weight: 950;
    font-size: clamp(1.15rem, 2vw, 1.45rem);
    display: flex;
    gap: 10px;
    align-items: center;
    justify-content: center;
    flex-wrap: wrap;
  }
  .teacher-edit-scope .te-subtitle{
    margin: 0;
    opacity: .95;
    font-weight: 800;
    font-size: .95rem;
  }

  .teacher-edit-scope .te-form{
    padding: clamp(16px, 3vw, 26px);
  }

  .teacher-edit-scope .te-grid{
    display: grid;
    grid-template-columns: repeat(2, minmax(240px, 1fr));
    gap: 16px;
  }
  @media (max-width: 820px){
    .teacher-edit-scope .te-grid{ grid-template-columns: 1fr; }
  }

  .teacher-edit-scope .te-group{ display:block; }
  .teacher-edit-scope .te-label{
    display:flex;
    align-items:center;
    gap:8px;
    margin-bottom: 8px;
    font-weight: 950;
    color: var(--te-ink);
  }
  .teacher-edit-scope .te-icon{
    color: var(--te-brand);
    opacity: .95;
  }
  html[data-theme="dark"] .teacher-edit-scope .te-icon{ color:#93c5fd; }

  .teacher-edit-scope .te-control{
    width: 100%;
    min-height: var(--te-tap);
    padding: 12px 14px;
    border: 1px solid var(--te-line);
    border-radius: 12px;
    background: var(--te-card);
    background: color-mix(in srgb, var(--te-card) 92%, #f8fafc 8%);
    color: var(--te-ink);
    font-size: 1rem;
    transition: box-shadow .18s ease, border-color .18s ease, transform .12s ease;
  }
  .teacher-edit-scope .te-control:focus{
    outline: none;
    border-color: var(--te-brand);
    box-shadow: var(--te-ring);
  }
  html[data-theme="dark"] .teacher-edit-scope .te-control{
    background: #0b1220;
    color: var(--te-ink);
  }

  .teacher-edit-scope .te-field-error{
    color: var(--te-danger);
    font-size: .92rem;
    margin-top: 6px;
    font-weight: 850;
  }
  .teacher-edit-scope .te-hint{
    color: var(--te-muted);
    font-size: .86rem;
    margin-top: 6px;
    font-weight: 800;
  }

  /* Password */
  .teacher-edit-scope .te-password-wrap{
    position: relative;
    display:flex;
    align-items:center;
  }
  .teacher-edit-scope .te-password-wrap .te-control{ padding-inline-end: 46px; }

  .teacher-edit-scope .te-toggle{
    position:absolute;
    inset-inline-end: 10px;
    top: 50%;
    transform: translateY(-50%);
    width: 36px;
    height: 36px;
    border: 1px solid var(--te-line);
    border-radius: 10px;
    background: var(--te-card);
    background: color-mix(in srgb, var(--te-card) 92%, #f8fafc 8%);
    color: var(--te-muted);
    cursor: pointer;
    display: grid;
    place-items: center;
  }
  .teacher-edit-scope .te-toggle:focus-visible{
    outline: 2px solid var(--te-brand);
    outline-offset: 2px;
  }
  html[data-theme="dark"] .teacher-edit-scope .te-toggle{ background:#0b1220; }

  /* Switch */
  .teacher-edit-scope .te-switch-row{
    display:flex;
    align-items:center;
    gap: 12px;
    margin-top: 6px;
  }
  .teacher-edit-scope .te-switch{
    position: relative;
    display: inline-block;
    width: 54px;
    height: 30px;
    flex: 0 0 auto;
  }
  .teacher-edit-scope .te-switch input{
    opacity: 0;
    width: 0;
    height: 0;
  }
  .teacher-edit-scope .te-slider{
    position: absolute;
    cursor: pointer;
    inset: 0;
    background: #cbd5e1;
    border-radius: 999px;
    transition: .25s;
  }
  .teacher-edit-scope .te-slider:before{
    content:"";
    position:absolute;
    height: 22px;
    width: 22px;
    inset-inline-start: 4px;
    top: 4px;
    background:#fff;
    border-radius: 50%;
    transition: .25s;
  }
  .teacher-edit-scope .te-switch input:checked + .te-slider{ background: var(--te-brand); }
  .teacher-edit-scope .te-switch input:checked + .te-slider:before{ transform: translateX(-24px); }

  .teacher-edit-scope .te-switch-text{ flex: 1; }
  .teacher-edit-scope .te-switch-text .te-hint{ margin-top: 4px; }

  /* Alerts */
  .teacher-edit-scope .te-alert{
    padding: 12px 14px;
    border-radius: 12px;
    margin-bottom: 10px;
    border: 1px solid var(--te-line);
    background: var(--te-card);
    background: color-mix(in srgb, var(--te-card) 92%, #eff6ff 8%);
    color: var(--te-ink);
    font-weight: 850;
  }
  .teacher-edit-scope .te-alert.success{ background:#ecfdf5; color:#065f46; border-color: color-mix(in srgb,#16a34a 25%, var(--te-line)); }
  .teacher-edit-scope .te-alert.error{ background:#fef2f2; color:#991b1b; border-color:#fecaca; }
  .teacher-edit-scope .te-alert.warning{ background:#fffbeb; color:#92400e; border-color:#fde68a; }
  .teacher-edit-scope .te-alert.info{ background:#eff6ff; color:#1e40af; border-color:#bfdbfe; }

  html[data-theme="dark"] .teacher-edit-scope .te-alert{ background:#0b1220; }
  html[data-theme="dark"] .teacher-edit-scope .te-alert.error{ background:#2a0f14; color:#fecaca; border-color:#7f1d1d; }

  /* Actions */
  .teacher-edit-scope .te-actions{
    display:flex;
    gap: 12px;
    justify-content: center;
    flex-wrap: wrap;
    margin-top: 18px;
    padding-top: 16px;
    border-top: 1px solid var(--te-line);
  }

  .teacher-edit-scope .te-btn{
    display:inline-flex;
    align-items:center;
    gap: 10px;
    justify-content:center;
    min-height: var(--te-tap);
    padding: 10px 16px;
    border-radius: 12px;
    border: 1px solid var(--te-line);
    background: var(--te-card);
    background: color-mix(in srgb, var(--te-card) 92%, #f8fafc 8%);
    font-weight: 950;
    cursor: pointer;
    text-decoration: none;
    color: var(--te-ink);
    transition: transform .12s ease, filter .12s ease, opacity .12s ease;
  }
  .teacher-edit-scope .te-btn:hover{ transform: translateY(-1px); }
  .teacher-edit-scope .te-btn:focus-visible{ outline: 2px solid var(--te-brand); outline-offset: 2px; }

  .teacher-edit-scope .te-btn-primary{
    background: linear-gradient(135deg, var(--te-brand), var(--te-brand2));
    border-color: transparent;
    color: #fff;
  }
  .teacher-edit-scope .te-btn-primary:hover{ filter: brightness(1.03); }

  .teacher-edit-scope .te-btn-outline{ background: transparent; }

  html[data-theme="dark"] .teacher-edit-scope .te-btn{ background:#0b1220; color: var(--te-ink); }
  html[data-theme="dark"] .teacher-edit-scope .te-btn-outline{ background: transparent; }

  @media (max-width: 560px){
    .teacher-edit-scope .te-form{ padding: 16px; }
    .teacher-edit-scope .te-actions{ flex-direction: column; }
    .teacher-edit-scope .te-btn{ width: 100%; }
  }
</style>
{% endblock %}

{% block content %}
<div class="teacher-edit-scope">
  <div class="te-wrap" dir="rtl">
    <div class="te-card">
      <div class="te-header">
        <h2 class="te-title">
          <i class="fa-solid fa-user-pen" aria-hidden="true"></i>
          تعديل بيانات المعلم
        </h2>
        <p class="te-subtitle">
          قم بتعديل البيانات الخاصة بالمعلم
          {% firstof teacher.name form.initial.name "" %}
        </p>
      </div>

      <form method="post" class="te-form" novalidate id="teacherEditForm">
        {% csrf_token %}

        {% if messages %}
          <div id="flash">
            {% for m in messages %}
              <div class="te-alert {{ m.tags }}">{{ m }}</div>
            {% endfor %}
          </div>
        {% endif %}

        {% if form.non_field_errors %}
          <div class="te-alert error" role="alert">
            {% for e in form.non_field_errors %}{{ e }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
          </div>
        {% endif %}

        <div class="te-grid">
          <div class="te-group">
            <label class="te-label" for="{{ form.name.id_for_label }}">
              <i class="fa-solid fa-user te-icon" aria-hidden="true"></i>
              اسم المعلم
            </label>
            {{ form.name }}
            {% for e in form.name.errors %}<div class="te-field-error">{{ e }}</div>{% endfor %}
            <div class="te-hint">الاسم الكامل للمعلم</div>
          </div>

          <div class="te-group">
            <label class="te-label" for="{{ form.national_id.id_for_label }}">
              <i class="fa-solid fa-id-card te-icon" aria-hidden="true"></i>
              رقم الهوية
            </label>
            {{ form.national_id }}
            {% for e in form.national_id.errors %}<div class="te-field-error">{{ e }}</div>{% endfor %}
            <div class="te-hint">رقم الهوية الوطنية مكوّن من 10 أرقام (اختياري)</div>
          </div>

          <div class="te-group">
            <label class="te-label" for="{{ form.phone.id_for_label }}">
              <i class="fa-solid fa-phone te-icon" aria-hidden="true"></i>
              رقم الجوال
            </label>
            {{ form.phone }}
            {% for e in form.phone.errors %}<div class="te-field-error">{{ e }}</div>{% endfor %}
            <div class="te-hint">يبدأ بـ 05 ويحتوي على 10 أرقام</div>
          </div>

          {% if form.job_title %}
          <div class="te-group">
            <label class="te-label" for="{{ form.job_title.id_for_label }}">
              <i class="fa-solid fa-user-tag te-icon" aria-hidden="true"></i>
              الدور
            </label>
            {{ form.job_title }}
            {% for e in form.job_title.errors %}<div class="te-field-error">{{ e }}</div>{% endfor %}
            <div class="te-hint">اختر (معلم / موظف إداري / محضر مختبر) — بنفس الصلاحيات</div>
          </div>
          {% endif %}

          <div class="te-group">
            <label class="te-label" for="{{ form.password.id_for_label }}">
              <i class="fa-solid fa-key te-icon" aria-hidden="true"></i>
              كلمة المرور
            </label>
            <div class="te-password-wrap">
              {{ form.password }}
              <button type="button" class="te-toggle" id="togglePassword" aria-label="إظهار/إخفاء كلمة المرور">
                <i class="fa-solid fa-eye" aria-hidden="true"></i>
              </button>
            </div>
            {% for e in form.password.errors %}<div class="te-field-error">{{ e }}</div>{% endfor %}
            <div class="te-hint">اترك الحقل فارغًا للحفاظ على كلمة المرور الحالية</div>
          </div>

          <div class="te-group" style="grid-column: 1 / -1;">
            <div class="te-switch-row">
              <label class="te-switch" aria-label="تفعيل/تعطيل">
                {{ form.is_active }}
                <span class="te-slider"></span>
              </label>

              <div class="te-switch-text">
                <div style="display:flex;align-items:center;gap:8px;font-weight:950;color:var(--te-ink)">
                  <i class="fa-solid fa-toggle-on te-icon" aria-hidden="true"></i>
                  نشط
                </div>
                <div class="te-hint">تفعيل أو إلغاء تفعيل حساب المعلم</div>
                {% for e in form.is_active.errors %}<div class="te-field-error">{{ e }}</div>{% endfor %}
              </div>
            </div>
          </div>
        </div>

        {% if request.GET.next %}
          <input type="hidden" name="next" value="{{ request.GET.next }}">
        {% endif %}

        <div class="te-actions">
          <button type="submit" class="te-btn te-btn-primary" id="saveBtn">
            <i class="fa-solid fa-floppy-disk" aria-hidden="true"></i>
            <span data-label>حفظ التعديلات</span>
          </button>

          {% if request.GET.next %}
            <a href="{{ request.GET.next }}" class="te-btn te-btn-outline">
              <i class="fa-solid fa-arrow-right" aria-hidden="true"></i>
              رجوع
            </a>
          {% else %}
            <a href="{% url 'reports:manage_teachers' %}" class="te-btn te-btn-outline">
              <i class="fa-solid fa-arrow-right" aria-hidden="true"></i>
              رجوع للقائمة
            </a>
          {% endif %}
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script nonce="{{ CSP_NONCE|default:'' }}">
  (function(){
    var form = document.getElementById('teacherEditForm');
    if(!form) return;

    // أضف class te-control لجميع الحقول (بدون checkbox)
    form.querySelectorAll('input:not([type="checkbox"]), select, textarea').forEach(function(el){
      if(!el.classList.contains('te-control')) el.classList.add('te-control');
    });

    // تحسين إدخال الهوية والجوال + محاذاة LTR
    var national = document.getElementById('{{ form.national_id.id_for_label }}') || document.getElementById('id_national_id');
    var phone = document.getElementById('{{ form.phone.id_for_label }}') || document.getElementById('id_phone');

    if(national){
      national.setAttribute('inputmode','numeric');
      national.setAttribute('pattern','\\d{10}');
      national.setAttribute('maxlength','10');
      national.setAttribute('autocomplete','off');
      national.dir = 'ltr';
      national.style.textAlign = 'left';
    }

    if(phone){
      phone.setAttribute('inputmode','tel');
      phone.setAttribute('pattern','05\\d{8}');
      phone.setAttribute('maxlength','10');
      phone.setAttribute('autocomplete','tel');
      phone.dir = 'ltr';
      phone.style.textAlign = 'left';
    }

    // كلمة المرور: autocomplete جديد
    var password = document.getElementById('{{ form.password.id_for_label }}')
      || document.getElementById('id_password')
      || form.querySelector('input[name="password"]');

    if(password){
      password.setAttribute('autocomplete','new-password');
    }

    // إظهار/إخفاء كلمة المرور
    var toggle = document.getElementById('togglePassword');
    if(toggle && password){
      toggle.addEventListener('click', function(){
        var isPw = password.getAttribute('type') === 'password';
        password.setAttribute('type', isPw ? 'text' : 'password');

        var ic = toggle.querySelector('i');
        if(ic){
          ic.classList.toggle('fa-eye', !isPw);
          ic.classList.toggle('fa-eye-slash', isPw);
        }
      });
    }

    // إخفاء رسائل الفلاش غير الخطأ بعد 3 ثوانٍ
    var flash = document.getElementById('flash');
    if(flash){
      window.setTimeout(function(){
        flash.querySelectorAll('.te-alert').forEach(function(a){
          if(!a.classList.contains('error')){
            a.style.display = 'none';
          }
        });
      }, 3000);
    }

    // منع الإرسال المزدوج
    form.addEventListener('submit', function(){
      var btn = document.getElementById('saveBtn');
      if(!btn) return;

      btn.disabled = true;
      btn.setAttribute('aria-busy', 'true');
      btn.style.opacity = '.75';

      var lbl = btn.querySelector('[data-label]');
      if(lbl) lbl.textContent = 'جارٍ الحفظ...';
    });
  })();
</script>
{% endblock %}
