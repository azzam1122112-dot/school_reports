{% load static %}
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>تقرير تواقيع: {{ n.title|default:"تعميم" }}</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />

  <style>
    :root {
      --font-main: 'Tajawal', sans-serif;
      --ink: #0f172a;
      --muted: #64748b;
      --line: #000;
      --shade: #f8fafc;
      --brand: #2563eb;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: var(--font-main);
      background: #f1f5f9;
      color: var(--ink);
      -webkit-font-smoothing: antialiased;
    }

    /* Screen Toolbar */
    .toolbar {
      position: sticky;
      top: 0;
      z-index: 1000;
      background: rgba(15, 23, 42, 0.9);
      backdrop-filter: blur(10px);
      color: #fff;
      padding: 12px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    .toolbar-title { font-weight: 800; font-size: 1.1rem; display: flex; align-items: center; gap: 10px; }
    .toolbar-actions { display: flex; gap: 12px; }
    
    .btn {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 10px 20px; border-radius: 99px;
      font-weight: 700; font-size: 0.9rem;
      cursor: pointer; transition: all 0.3s ease;
      text-decoration: none; border: none;
    }
    .btn-white { background: #fff; color: var(--ink); }
    .btn-primary { background: var(--brand); color: #fff; box-shadow: 0 4px 12px rgba(37,99,235,0.3); }
    .btn:hover { transform: translateY(-2px); opacity: 0.9; }

    /* A4 Canvas Look */
    .page {
      width: 210mm;
      min-height: 297mm;
      margin: 30px auto;
      background: #fff;
      padding: 15mm 15mm;
      position: relative;
      box-shadow: 0 0 40px rgba(0,0,0,0.1);
    }

    @page { size: A4; margin: 0; }
    @media print {
      body { background: #fff; }
      .page {
        width: 100%;
        margin: 0;
        padding: 15mm 15mm;
        box-shadow: none;
      }
      .no-print { display: none !important; }
      * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    }

    /* Official Header */
    .official-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      border-bottom: 2px solid var(--line);
      padding-bottom: 15px;
      margin-bottom: 25px;
    }
    .header-block { font-size: 13px; line-height: 1.8; font-weight: 700; }
    .header-logo { height: 80px; width: auto; }
    .header-center { text-align: center; }

    /* Report Content */
    .report-title {
      text-align: center;
      font-size: 1.6rem;
      font-weight: 900;
      margin-bottom: 5px;
      color: #000;
    }
    .report-subtitle {
      text-align: center;
      font-size: 1rem;
      color: var(--muted);
      margin-bottom: 25px;
      font-weight: 700;
    }

    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-bottom: 25px;
    }
    .stat-card {
      border: 1px solid var(--line);
      padding: 12px;
      text-align: center;
    }
    .stat-val { font-size: 1.4rem; font-weight: 900; display: block; }
    .stat-lbl { font-size: 0.85rem; font-weight: 700; color: var(--muted); }

    /* Table Styling */
    .official-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 30px;
    }
    .official-table th, .official-table td {
      border: 1px solid var(--line);
      padding: 10px 12px;
      text-align: right;
      font-size: 14px;
    }
    .official-table th {
      background: #f3f4f6;
      font-weight: 900;
      white-space: nowrap;
    }
    .official-table td { font-weight: 700; }

    .status-pill {
      padding: 3px 10px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 900;
      display: inline-block;
      border: 1px solid #000;
    }
    .status-signed { background: #dcfce7; color: #166534; }
    .status-pending { background: #fee2e2; color: #991b1b; }

    .ack-box {
      border: 1px solid var(--line);
      padding: 15px;
      margin-bottom: 25px;
      background: #fdfdfd;
    }
    .ack-title { font-weight: 900; margin-bottom: 8px; font-size: 14px; text-decoration: underline; }
    .ack-text { font-size: 14px; line-height: 1.7; text-align: justify; }

    /* Signature Section at Footer */
    .signatures-footer {
      margin-top: 50px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
      text-align: center;
      max-width: 420px;
    }
    .sig-block { font-weight: 900; }
    .sig-space { height: 60px; }

    .footer-meta {
      position: absolute;
      bottom: 15mm;
      left: 15mm;
      right: 15mm;
      font-size: 10px;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      border-top: 1px solid #eee;
      padding-top: 10px;
    }
  </style>
</head>
<body>

  <!-- Screen Toolbar -->
  <div class="toolbar no-print">
    <div class="toolbar-title">
      <i class="fa-solid fa-file-invoice" style="font-size: 1.4rem; color: var(--brand);"></i>
      <span>معاينة تقرير التواقيع الرسمي</span>
    </div>
    <div class="toolbar-actions">
      <a href="{% url 'reports:notification_detail' n.id %}" class="btn btn-white">
        <i class="fa-solid fa-arrow-right"></i> عودة
      </a>

      <button onclick="window.print()" class="btn btn-primary">
        <i class="fa-solid fa-print"></i> طباعة التقرير
      </button>
    </div>
  </div>

  <div class="page">
    <!-- Header -->
    <header class="official-header">
      <div class="header-block">
        <div>المملكة العربية السعودية</div>
        <div>وزارة التعليم</div>
        <div>{% firstof SCHOOL_NAME "المدرسة النشطة" %}</div>
      </div>
      
      <div class="header-center">
        <img src="{% static 'img/UntiTtled-1.png' %}" alt="Logo" class="header-logo" style="margin-bottom: 5px;">
      </div>

      <div class="header-block" style="text-align: left; direction: ltr;">
        <div>Date: {% now "Y/m/d" %}</div>
        <div>No: CIR-{{ n.id }}</div>
      </div>
    </header>

    <!-- Title Area -->
    <div class="report-subtitle">{{ n.title }}</div>

    <!-- Stats -->
    <div class="stats-grid">
      <div class="stat-card">
        <span class="stat-val">{{ stats.total }}</span>
        <span class="stat-lbl">إجمالي المستلمين</span>
      </div>
      <div class="stat-card" style="border-color: #166534;">
        <span class="stat-val" style="color: #166534;">{{ stats.signed }}</span>
        <span class="stat-lbl">تم التوقيع</span>
      </div>
      <div class="stat-card" style="border-color: #991b1b;">
        <span class="stat-val" style="color: #991b1b;">{{ stats.unsigned }}</span>
        <span class="stat-lbl">انتظار التوقيع</span>
      </div>
    </div>

    <!-- Details Box -->
    <table class="official-table" style="margin-bottom: 20px;">
      <tr>
        <th style="width: 20%;">تاريخ الإصدار</th>
        <td>{{ n.created_at|date:"Y-m-d H:i" }}</td>
        <th style="width: 20%;">الموعد النهائي</th>
        <td>{% if n.signature_deadline_at %}{{ n.signature_deadline_at|date:"Y-m-d H:i" }}{% else %}مفتوح{% endif %}</td>
      </tr>
      <tr>
        <th>حالة التواقيع</th>
        <td colspan="3">
          {% if stats.unsigned == 0 %}اكتمل التوقيع من جميع الأطراف{% else %}جاري جمع التواقيع...{% endif %}
        </td>
      </tr>
    </table>



    <!-- Items Table -->
    <table class="official-table">
      <thead>
        <tr>
          <th style="width: 5%;">#</th>
          <th>اسم المعلم / الموظف</th>
          <th style="width: 15%;">الدور</th>
          <th style="width: 15%;">الحالة</th>
          <th style="width: 20%;">تاريخ التوقيع</th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
        <tr>
          <td style="text-align: center;">{{ forloop.counter }}</td>
          <td>{{ r.name }}</td>
          <td>{{ r.role }}</td>
          <td style="text-align: center;">
            {% if r.signed %}
            <span class="status-pill status-signed">موقّع</span>
            {% else %}
            <span class="status-pill status-pending">انتظار</span>
            {% endif %}
          </td>
          <td>{% if r.signed_at %}{{ r.signed_at|date:"Y-m-d H:i" }}{% else %}—{% endif %}</td>
        </tr>
        {% empty %}
        <tr><td colspan="5" style="text-align: center; height: 100px;">لا توجد سجلات حالياً</td></tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- Bottom Signatures -->

    <div class="footer-meta">
      <span>نظام توثيق التقارير الذكي 2026 — تم إنشاؤه بواسطة {{ request.user.name|default:request.user.phone }}</span>
      <span>صفحة 1 من 1</span>
    </div>
  </div>

  <script>
    function goBack() {
      window.history.back();
    }
    // Auto print if URL has print=1
    if (window.location.search.includes('print=1')) {
      window.print();
    }
  </script>
</body>
</html>
