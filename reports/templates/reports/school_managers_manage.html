{% extends "base.html" %}
{% block title %}إدارة مدراء المدرسة{% endblock %}

{% block content %}
<div class="container" dir="rtl">
  <div class="page-head" style="max-width:900px;margin-inline:auto">
    <div>
      <h1 class="page-title">إدارة مدراء المدرسة</h1>
      <p class="page-subtitle">إضافة أو إزالة المدراء لهذه المدرسة.</p>
    </div>
    <a href="{% url 'reports:schools_admin_list' %}" class="btn btn-outline">عودة لقائمة المدارس</a>
  </div>

  <div style="max-width:900px;margin-inline:auto">
    <div class="card">
      <div style="margin-bottom:12px">
        <span class="badge info">المدرسة: {{ school.name }} — الكود: {{ school.code }}</span>
      </div>

      <div class="section-title">المدراء الحاليون</div>
      {% if managers %}
        <div class="table-responsive">
          <table class="rtable">
            <thead>
              <tr>
                <th>المدير</th>
                <th>إجراء</th>
              </tr>
            </thead>
            <tbody>
              {% for m in managers %}
              <tr>
                <td data-label="المدير"><b>{{ m.name }}</b></td>
                <td data-label="إجراء">
                  <form method="post" style="margin:0" class="js-once">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="remove">
                    <input type="hidden" name="teacher_id" value="{{ m.id }}">
                    <input type="hidden" name="next" value="{{ request.get_full_path }}">
                    <button type="submit" class="btn btn-danger" style="padding:8px 10px" onclick="return confirm('هل تريد إزالة هذا المدير من المدرسة؟');">
                      إزالة من المدراء
                    </button>
                  </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="muted" style="font-weight:900">لا يوجد مدراء معيّنون لهذه المدرسة بعد.</div>
      {% endif %}

      <div style="height:12px"></div>

      <div class="section-title">إضافة مدير جديد</div>
      <form method="post" class="form-grid js-once" id="addManagerForm">
        {% csrf_token %}
        <input type="hidden" name="action" value="add">
        <input type="hidden" name="next" value="{{ request.get_full_path }}">

        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
          <div style="flex:1;min-width:220px">
            <input type="search" id="managerSearch" class="input" placeholder="ابحث باسم المدير" autocomplete="off" spellcheck="false">
          </div>
          <div style="flex:2;min-width:260px">
            <select name="teacher_id" id="managerSelect" class="input" required>
              <option value="" disabled selected>اختر المعلّم ليصبح مديراً...</option>
              {% for t in teachers %}
                <option value="{{ t.id }}">{{ t.name }}</option>
              {% endfor %}
            </select>
            <div class="muted" style="font-weight:850;margin-top:6px">نصيحة: اكتب جزءًا من الاسم لتصفية القائمة.</div>
          </div>
          <button type="submit" class="btn btn-primary">إضافة كمدير</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
  (function(){
    const input = document.getElementById('managerSearch');
    const select = document.getElementById('managerSelect');
    if (!input || !select) return;

    // خذ نسخة ثابتة من الخيارات (باستثناء placeholder)
    const originalOptions = Array.from(select.options).slice(1).map(o => ({
      value: o.value,
      text: o.textContent || ''
    }));

    function rebuildOptions(query){
      const current = select.value;
      const q = (query || '').trim().toLowerCase();

      // placeholder
      select.innerHTML = '';
      const ph = document.createElement('option');
      ph.value = '';
      ph.disabled = true;
      ph.selected = true;
      ph.textContent = 'اختر المعلّم ليصبح مديراً...';
      select.appendChild(ph);

      let firstMatchValue = null;

      originalOptions.forEach(opt => {
        const txt = (opt.text || '').toLowerCase();
        if (!q || txt.includes(q)){
          const o = document.createElement('option');
          o.value = opt.value;
          o.textContent = opt.text;

          // Hook: هنا تقدر تعطل خيارات المدراء الحاليين لو مرّرت قائمة ids من الـview
          // مثال: لو عندك manager_ids في السياق
          // const isManager = (window.managerIds || []).includes(String(opt.value));
          // if (isManager) { o.disabled = true; o.textContent = opt.text + ' (مدير حالياً)'; }

          select.appendChild(o);
          if (!firstMatchValue) firstMatchValue = opt.value;
        }
      });

      // حافظ على الاختيار إن كان ما زال موجودًا
      const stillExists = Array.from(select.options).some(o => o.value === current && !o.disabled);
      if (stillExists) {
        select.value = current;
      } else {
        // لا تغيّر شيء؛ خلّه على placeholder
        select.value = '';
      }
    }

    input.addEventListener('input', function(){
      rebuildOptions(this.value);
    });
  })();

  // منع double submit (إضافة/إزالة)
  (function(){
    document.querySelectorAll('form.js-once').forEach(form => {
      form.addEventListener('submit', function(){
        const btn = form.querySelector('button[type="submit"]');
        if (btn) {
          btn.disabled = true;
          btn.style.opacity = '0.8';
        }
      }, {once:true});
    });
  })();
</script>
{% endblock %}
