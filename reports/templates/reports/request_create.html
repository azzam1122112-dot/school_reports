{% extends "base.html" %}
{% load static %}

{% block title %}Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ | Ø§Ù„Ù…Ù†ØµØ©{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
<style>
    /* 
       DESIGN SYSTEM 2026 
       Theme: Neo-Professional (Clean, Trustworthy, Global)
    */
    :root {
        --font-primary: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        
        /* Modern Blue Palette */
        --c-brand: #3b82f6;
        --c-brand-dark: #1d4ed8;
        --c-brand-light: #eff6ff;
        --c-accent: #6366f1;
        
        /* Neutrals */
        --c-text-main: #0f172a;
        --c-text-muted: #64748b;
        --c-text-light: #94a3b8;
        --c-border: #e2e8f0;
        --c-bg: #f8fafc;
        --c-surface: #ffffff;
        
        /* Status */
        --c-success: #10b981;
        --c-danger: #ef4444;
        
        /* Effects */
        --radius-xl: 16px;
        --radius-lg: 12px;
        --radius-md: 8px;
        --shadow-xs: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        --shadow-sm: 0 4px 6px -1px rgb(0 0 0 / 0.05);
        --shadow-md: 0 10px 15px -3px rgb(0 0 0 / 0.05);
        --shadow-glow: 0 0 0 4px rgba(59, 130, 246, 0.15);
        --ease: cubic-bezier(0.16, 1, 0.3, 1);
    }

    body {
        background-color: var(--c-bg);
        color: var(--c-text-main);
        font-family: var(--font-primary);
        -webkit-font-smoothing: antialiased;
    }

    /* Container & Layout */
    .ticket-page {
        max-width: 1200px;
        margin: 0 auto;
        padding: 40px 20px;
        direction: rtl;
    }
    
    .layout-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 32px;
        animation: fadeIn 0.6s var(--ease);
    }

    @media (min-width: 1024px) {
        .layout-grid {
            grid-template-columns: minmax(0, 7fr) minmax(0, 4fr);
            align-items: start;
        }
    }

    /* Typography & Header */
    .page-header {
        margin-bottom: 32px;
        text-align: right;
    }
    
    .page-title {
        font-size: 2rem;
        font-weight: 800;
        letter-spacing: -0.025em;
        background: linear-gradient(135deg, var(--c-text-main), var(--c-brand));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 8px;
        display: inline-block;
    }
    
    .page-desc {
        font-size: 1.05rem;
        color: var(--c-text-muted);
        max-width: 600px;
        line-height: 1.6;
    }

    /* Cards */
    .modern-card {
        background: var(--c-surface);
        border: 1px solid var(--c-border);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-sm);
        padding: 32px;
        transition: box-shadow 0.3s var(--ease);
    }
    
    .modern-card:hover {
        box-shadow: var(--shadow-md);
    }
    
    .is-sticky {
        position: sticky;
        top: 24px;
        z-index: 20;
    }

    /* Forms */
    .form-section-title {
        font-size: 1.25rem;
        font-weight: 700;
        margin-bottom: 24px;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--c-border);
        color: var(--c-text-main);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .form-group {
        margin-bottom: 24px;
    }

    .form-label {
        display: block;
        font-weight: 600;
        margin-bottom: 8px;
        color: var(--c-text-main);
        font-size: 0.95rem;
    }
    
    .form-label .req { color: var(--c-danger); }

    /* Inputs styled via JS classes .tk-input/.tk-textarea but we override here */
    .field-input, .tk-input, .tk-select, .tk-textarea, .recipients-search {
        width: 100%;
        padding: 14px 16px;
        border: 1px solid var(--c-border);
        border-radius: var(--radius-lg);
        background: var(--c-bg); /* Slight background */
        font-size: 1rem;
        color: var(--c-text-main);
        transition: all 0.2s var(--ease);
        font-family: inherit;
    }

    .field-input:focus, .tk-input:focus, .tk-select:focus, .recipients-search:focus {
        outline: none;
        border-color: var(--c-brand);
        background: var(--c-surface);
        box-shadow: var(--shadow-glow);
    }

    .tk-textarea {
        min-height: 240px;
        line-height: 1.6;
        resize: vertical;
    }

    select.tk-select {
        appearance: none;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2364748b' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        background-position: left 1rem center;
        background-repeat: no-repeat;
        background-size: 1.25em;
        cursor: pointer;
    }

    /* Helper & Error Text */
    .field-help {
        font-size: 0.85rem;
        color: var(--c-text-muted);
        margin-top: 6px;
    }
    
    .field-error {
        margin-top: 6px;
        padding: 8px 12px;
        background: #fef2f2;
        border: 1px solid #fecaca;
        border-radius: var(--radius-md);
        color: #b91c1c;
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    /* Dynamic JS Components Styling */
    /* Recipients Dropdown */
    .recipients-dd {
        border: 1px solid var(--c-border);
        border-radius: var(--radius-lg);
        background: var(--c-surface);
        overflow: hidden;
    }
    
    .recipients-dd[open] {
        border-color: var(--c-brand);
        box-shadow: var(--shadow-glow);
    }

    .recipients-dd > summary {
        padding: 14px 16px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--c-bg);
        font-weight: 500;
        transition: background 0.2s;
    }
    
    .recipients-dd > summary::-webkit-details-marker { display:none; }
    
    .recipients-panel {
        padding: 12px;
        border-top: 1px solid var(--c-border);
    }

    .recipients-scroll {
        max-height: 250px;
        overflow-y: auto;
        padding-top: 8px;
    }

    .recipients-grid {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .rcpt {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 12px;
        border-radius: var(--radius-md);
        cursor: pointer;
        transition: 0.1s;
    }
    
    .rcpt:hover { background: var(--c-bg); }
    
    .rcpt.selected {
        background: var(--c-brand-light);
        color: var(--c-brand-dark);
        font-weight: 600;
    }
    
    .rcpt input { accent-color: var(--c-brand); width: 18px; height: 18px; cursor: pointer; }

    /* Upload Zone */
    .upload-box {
        border: 2px dashed var(--c-border);
        border-radius: var(--radius-lg);
        padding: 32px 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
        background: var(--c-bg);
    }
    
    .upload-box:hover {
        border-color: var(--c-brand);
        background: var(--c-brand-light);
    }

    .upload-icon {
        font-size: 2rem;
        color: var(--c-text-light);
        margin-bottom: 8px;
        display: block;
    }

    .previews-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(64px, 1fr));
        gap: 8px;
        margin-top: 16px;
    }
    
    .thumb {
        aspect-ratio: 1;
        border-radius: var(--radius-md);
        overflow: hidden;
        border: 1px solid var(--c-border);
        position: relative;
    }
    
    .thumb img { width: 100%; height: 100%; object-fit: cover; }
    
    .thumb .badge {
        position: absolute;
        top: 2px; right: 2px;
        background: rgba(0,0,0,0.6);
        color: #fff;
        font-size: 0.65rem;
        padding: 1px 5px;
        border-radius: 99px;
    }

    /* Buttons */
    .submit-btn {
        width: 100%;
        background: linear-gradient(135deg, var(--c-brand), var(--c-brand-dark));
        color: white;
        font-weight: 700;
        font-size: 1.05rem;
        padding: 16px;
        border: none;
        border-radius: var(--radius-lg);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        transition: transform 0.2s, box-shadow 0.2s;
        box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.4);
    }
    
    .submit-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.5);
    }
    
    .submit-btn:disabled { opacity: 0.7; cursor: not-allowed; transform: none; }

    .cancel-btn {
        display: block;
        text-align: center;
        padding: 12px;
        color: var(--c-text-muted);
        font-weight: 600;
        text-decoration: none;
        border-radius: var(--radius-lg);
        margin-top: 8px;
        transition: color 0.2s;
    }
    
    .cancel-btn:hover { color: var(--c-text-main); background: var(--c-bg); }

    /* Badge/Info Box */
    .info-box {
        background: var(--c-brand-light);
        border: 1px solid rgba(59, 130, 246, 0.2);
        color: var(--c-brand-dark);
        padding: 16px;
        border-radius: var(--radius-lg);
        font-size: 0.9rem;
        line-height: 1.5;
        margin-bottom: 24px;
        display: flex;
        gap: 12px;
    }

    /* Anim */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

</link>
{% endblock %}

{% block content %}
<div class="ticket-page" dir="rtl">
    
    <div class="page-header">
        <h1 class="page-title">Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</h1>
        <p class="page-desc">Ù†Ø­Ù† Ù‡Ù†Ø§ Ù„Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ. Ù‚Ù… Ø¨Ù…Ù„Ø¡ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…ÙØµÙ„ Ø£Ø¯Ù†Ø§Ù‡ Ù„ÙŠØªÙ… ØªÙˆØ¬ÙŠÙ‡ Ø·Ù„Ø¨Ùƒ Ù„Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ù…Ø®ØªØµ Ø¨Ø£Ø³Ø±Ø¹ ÙˆÙ‚Øª.</p>
    </div>

    <form method="post" enctype="multipart/form-data" id="ticket-form" novalidate>
        {% csrf_token %}
        
        <div class="layout-grid">
            
            <!-- Main Content -->
            <div class="main-col">
                <div class="modern-card">
                    <div class="form-section-title">
                        <span>ğŸ“„</span> ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨
                    </div>

                    <div class="info-box">
                        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        <div>
                            <strong>Ù†ØµØ§Ø¦Ø­ Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©:</strong><br>
                            Ø§ÙƒØªØ¨ Ø¹Ù†ÙˆØ§Ù†Ø§Ù‹ Ø¯Ù‚ÙŠÙ‚Ø§Ù‹ (Ù…Ø«Ø§Ù„: Ø¹Ø·Ù„ ÙÙŠ Ø§Ù„Ø·Ø§Ø¨Ø¹Ø© HP Ø¨Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø«Ø§Ù†ÙŠ)ØŒ ÙˆØ§Ø´Ø±Ø­ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø¨Ø§Ù„ØªÙØµÙŠÙ„ ÙÙŠ Ø§Ù„ÙˆØµÙ.
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="{{ form.title.id_for_label }}" class="form-label">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø·Ù„Ø¨ <span class="req">*</span></label>
                        {{ form.title }}
                        {% for e in form.title.errors %}<div class="field-error">âš ï¸ {{ e }}</div>{% endfor %}
                    </div>

                    <div class="form-group">
                        <label for="{{ form.body.id_for_label }}" class="form-label">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© <span class="req">*</span></label>
                        {{ form.body }}
                        <div class="field-help">ÙŠØ±Ø¬Ù‰ ØªÙˆØ¶ÙŠØ­ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©ØŒ Ø§Ù„Ù…ÙƒØ§Ù†ØŒ ÙˆØ£ÙŠ Ø®Ø·ÙˆØ§Øª Ù‚Ù…Øª Ø¨Ù…Ø­Ø§ÙˆÙ„ØªÙ‡Ø§.</div>
                        {% for e in form.body.errors %}<div class="field-error">âš ï¸ {{ e }}</div>{% endfor %}
                    </div>
                </div>
            </div>

            <!-- Side Panel -->
            <div class="side-col">
                <div class="modern-card is-sticky">
                    
                    <div class="form-section-title">
                        <span>ğŸ¯</span> Ø§Ù„ØªÙˆØ¬ÙŠÙ‡
                    </div>

                    {% if form.non_field_errors %}
                        <div class="field-error" style="margin-bottom:16px">
                            {% for e in form.non_field_errors %}{{ e }}<br>{% endfor %}
                        </div>
                    {% endif %}

                    <div class="form-group">
                        <label class="form-label">Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø®ØªØµ <span class="req">*</span></label>
                        <select id="{{ form.department.id_for_label }}" name="{{ form.department.html_name }}" class="tk-select" required>
                            <option value="" selected hidden>â€” Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… â€”</option>
                            {% for d in form.fields.department.queryset %}
                              {% with v=d.slug %}
                                <option value="{{ v }}"
                                  {% if form.is_bound %}
                                    {% if form.data.department == v %}selected{% endif %}
                                  {% else %}
                                    {% if form.initial.department == v %}selected{% endif %}
                                  {% endif %}
                                >{{ d.name }}</option>
                              {% endwith %}
                            {% endfor %}
                        </select>
                        {% for e in form.department.errors %}<div class="field-error">âš ï¸ {{ e }}</div>{% endfor %}
                    </div>

                    <div class="form-group">
                        <label class="form-label">Ø§Ù„Ù…Ø³ØªÙ„Ù…ÙˆÙ† <span class="req">*</span></label>
                        <div id="id_recipients" class="recipients-box" aria-label="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªÙ„Ù…ÙŠÙ†"
                            {% if selected_recipient_ids %}
                                data-selected="{% for rid in selected_recipient_ids %}{{ rid }}{% if not forloop.last %},{% endif %}{% endfor %}"
                            {% endif %}
                        >
                            <div class="field-help">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø³Ù… Ø£ÙˆÙ„Ø§Ù‹.</div>
                        </div>
                        {% for e in form.recipients.errors %}<div class="field-error">âš ï¸ {{ e }}</div>{% endfor %}
                    </div>

                    <hr style="border:0; border-top:1px solid var(--c-border); margin: 24px 0;">

                    <div class="form-group">
                        <label class="form-label">Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                        <input id="id_images" name="images" type="file" accept="image/*" multiple hidden>
                        <label for="id_images" class="upload-box">
                            <span class="upload-icon">ğŸ“·</span>
                            <div style="font-weight:600; font-size:0.9rem">Ø§Ø±ÙØ§Ù‚ ØµÙˆØ±</div>
                            <div class="field-help" style="margin-top:4px">Max 4 images</div>
                        </label>
                         {% if form.errors.images %}<div class="field-error">{{ form.errors.images.0 }}</div>{% endif %}
                        <div class="previews-grid" id="previews"></div>
                    </div>

                    <div id="dynamic-msg" class="status-msg" aria-live="polite" style="margin: 16px 0; text-align: center; font-weight: 600;"></div>

                    <button type="submit" class="submit-btn" id="submitBtn">
                        <span>Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</span>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                    </button>
                    <a href="{% url 'reports:my_requests' %}" class="cancel-btn">Ø¥Ù„ØºØ§Ø¡</a>

                </div>
            </div>

        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script nonce="{{ CSP_NONCE }}">
(function(){
  // --- Add CSS Classes to Django Rendered Inputs ---
  document.querySelectorAll('.ticket-page input[type="text"], .ticket-page textarea').forEach(el => {
    if(el.tagName === 'TEXTAREA') el.classList.add('tk-textarea');
    else el.classList.add('tk-input');
    
    // Placeholder enhancements
    if(el.name === 'title' && !el.placeholder) el.placeholder = 'Ù…Ø«Ø§Ù„: Ø¹Ø·Ù„ ÙÙŠ Ø¬Ù‡Ø§Ø² Ø§Ù„Ø¹Ø±Ø¶ Ø¨Ø§Ù„Ù…Ø¹Ù…Ù„ Ø±Ù‚Ù… 3';
    if(el.name === 'body' && !el.placeholder) el.placeholder = 'Ø§Ù„Ù…ÙƒØ§Ù†/Ø§Ù„ÙØµÙ„: ...\nÙˆØµÙ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©: ...\nÙˆÙ‚Øª Ø­Ø¯ÙˆØ«Ù‡Ø§: ...\nØ¥Ø¬Ø±Ø§Ø¡Ø§Øª ØªÙ… ØªØ¬Ø±Ø¨ØªÙ‡Ø§: ...\nÙ…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©: ...';
  });

  // --- Logic Preservation ---
  const form = document.getElementById('ticket-form');
  const dept = document.getElementById('{{ form.department.id_for_label }}');
  const recipientsBox = document.getElementById('id_recipients');
  const msg = document.getElementById('dynamic-msg');
  const input = document.getElementById('id_images');
  const previews = document.getElementById('previews');
  const submitBtn = document.getElementById('submitBtn');

  const MAX_FILES = 4;
  const MAX_FILE_MB = 6;
  const MAX_FILE_BYTES = MAX_FILE_MB * 1024 * 1024;

  const CSRF = (window.getCsrfToken ? window.getCsrfToken() : (window.csrfToken || ''));

  function setMsg(text, type){
    if(!msg) return;
    msg.textContent = text || '';
    if(type === 'error') msg.style.color = '#e11d48';
    else if(type === 'ok') msg.style.color = '#059669';
    else msg.style.color = 'var(--ink-light)';
  }

  function setLoading(isLoading, text){
    if(submitBtn){
      submitBtn.disabled = !!isLoading;
      const originalText = submitBtn.querySelector('span');
      if(isLoading){
        submitBtn.style.opacity = '0.7';
        if(originalText) originalText.dataset.original = originalText.textContent;
        if(originalText) originalText.textContent = text || 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...';
      } else {
        submitBtn.style.opacity = '1';
        if(originalText && originalText.dataset.original) originalText.textContent = originalText.dataset.original;
      }
    }
  }

  function setRecipientsDisabled(disabled){
    if(!recipientsBox) return;
    recipientsBox.classList.toggle('disabled', disabled);
    recipientsBox.dataset.disabled = disabled ? '1' : '0';
    if(disabled){
      recipientsBox.innerHTML = '<div class="help-text">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†.</div>';
    }
  }

  function parseSelectedIds(){
    if(!recipientsBox) return [];
    const raw = recipientsBox.getAttribute('data-selected') || '';
    if(!raw) return [];
    return raw.split(',').map(s => (s || '').trim()).filter(Boolean);
  }

  function getSelectedRecipientIds(){
    if(!recipientsBox) return [];
    return Array.from(recipientsBox.querySelectorAll('input[type="checkbox"][name="recipients"]:checked'))
      .map(el => String(el.value));
  }

  function updateRecipientsSummary(){
    if(!recipientsBox) return;
    const details = recipientsBox.querySelector('details.recipients-dd');
    if(!details) return;

    const countEl = details.querySelector('.recipients-dd-title .count');
    const txtEl = details.querySelector('.recipients-dd-title .txt');
    if(!countEl || !txtEl) return;

    const selected = Array.from(details.querySelectorAll('input[type="checkbox"][name="recipients"]:checked'));
    const n = selected.length;

    if(n === 0){
      txtEl.textContent = 'Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙ„Ù…ÙŠÙ†';
      countEl.textContent = '';
      return;
    }

    if(n === 1){
      const label = selected[0].closest('label');
      const name = label ? (label.textContent || '').trim() : '';
      txtEl.textContent = name || 'ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ø³ØªÙ„Ù…';
      countEl.textContent = '(1)';
      return;
    }

    txtEl.textContent = 'ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ø³ØªÙ„Ù…ÙŠÙ†';
    countEl.textContent = '(' + n + ')';
  }

  function renderRecipients(list){
    if(!recipientsBox) return;

    if(!Array.isArray(list) || list.length === 0){
      recipientsBox.innerHTML = '<div class="help-text">âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙˆÙ† Ù…Ø³Ø¬Ù„ÙˆÙ† ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ø­Ø§Ù„ÙŠØ§Ù‹.</div>';
      return;
    }

    recipientsBox.innerHTML = '';

    const details = document.createElement('details');
    details.className = 'recipients-dd';
    details.open = true; // Open by default for better visibility in sidebar? No, maybe collapsed is cleaner. Let's keep closed.
    // Actually in the sidebar it might be better to be collapsible.

    const summary = document.createElement('summary');
    const title = document.createElement('div');
    title.className = 'recipients-dd-title';
    title.style.display = 'flex';
    title.style.gap = '8px';
    title.style.alignItems = 'center';
    
    title.innerHTML = '<span class="txt">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙ„Ù…ÙŠÙ†</span><span class="count" style="color:var(--brand-600);font-weight:700"></span>';

    const caret = document.createElement('span');
    caret.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>';

    summary.appendChild(title);
    summary.appendChild(caret);

    const panel = document.createElement('div');
    panel.className = 'recipients-panel';

    const searchInput = document.createElement('input');
    searchInput.type = 'text';
    searchInput.placeholder = 'Ø¨Ø­Ø« Ø¹Ù† Ù…ÙˆØ¸Ù...';
    searchInput.className = 'recipients-search';

    const scroll = document.createElement('div');
    scroll.className = 'recipients-scroll';

    const grid = document.createElement('div');
    grid.className = 'recipients-grid';

    // Restore Pre-selection if any
    const preSelected = new Set(parseSelectedIds());

    let searchTimer = null;
    searchInput.addEventListener('input', (e) => {
      const val = (e.target.value || '').toLowerCase();
      if(searchTimer) window.clearTimeout(searchTimer);
      searchTimer = window.setTimeout(() => {
        const labels = grid.querySelectorAll('.rcpt');
        labels.forEach(lbl => {
          const name = (lbl.textContent || '').toLowerCase();
          lbl.style.display = name.includes(val) ? 'flex' : 'none';
        });
      }, 60);
    });

    list.forEach(u => {
      const label = document.createElement('label');
      label.className = 'rcpt';

      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.name = 'recipients';
      cb.value = String(u.id);

      if(preSelected.has(String(u.id))){
        cb.checked = true;
        label.classList.add('selected');
      }

      cb.addEventListener('change', () => {
        if(cb.checked) label.classList.add('selected');
        else label.classList.remove('selected');
        updateRecipientsSummary();
      });

      const text = document.createElement('span');
      text.textContent = u.name;

      label.appendChild(cb);
      label.appendChild(text);
      grid.appendChild(label);
    });

    scroll.appendChild(grid);
    panel.appendChild(searchInput);
    panel.appendChild(scroll);

    details.appendChild(summary);
    details.appendChild(panel);

    recipientsBox.appendChild(details);

    updateRecipientsSummary();
  }

  async function loadMembers(deptSlug){
    if(!recipientsBox) return;

    setRecipientsDisabled(true);
    // Show spinner in box
    recipientsBox.innerHTML = '<div style="padding:10px;text-align:center;color:var(--ink-light)">...Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</div>';

    try{
      const baseUrl = "{% url 'reports:api_department_members' %}";
      const url = baseUrl + "?department=" + encodeURIComponent(deptSlug);

      const res = await fetch(url, {
        method: 'GET',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': CSRF
        },
        credentials: 'same-origin'
      });

      if(!res.ok) throw new Error('HTTP ' + res.status);

      const data = await res.json();
      const list = Array.isArray(data.results) ? data.results : [];

      renderRecipients(list);
      setRecipientsDisabled(false);

      // Auto-select if only 1
      const preSelected = parseSelectedIds();
      if(list.length === 1 && preSelected.length === 0){
        const first = recipientsBox.querySelector('input[type="checkbox"][name="recipients"]');
        if(first){
          first.checked = true;
          const lbl = first.closest('label');
          if(lbl) lbl.classList.add('selected');
        }
        updateRecipientsSummary();
        setMsg('ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„ÙˆØ­ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§', 'ok');
        return;
      }
      
      setMsg('', 'ok'); // Clear msg

    } catch(err){
      console.error(err);
      recipientsBox.innerHTML = '<div class="error-text">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†.</div>';
      setMsg('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', 'error');
    }
  }

  // Event Listeners
  if(dept && recipientsBox){
    dept.addEventListener('change', (e) => {
      const slug = (e.target.value || '').trim();
      recipientsBox.removeAttribute('data-selected'); // Clear preserved selection on change

      if(!slug){
        setRecipientsDisabled(true);
        setMsg('Ø§Ø®ØªØ± Ù‚Ø³Ù…Ù‹Ø§ Ø£ÙˆÙ„Ø§Ù‹');
        return;
      }
      loadMembers(slug);
    });

    // On Load
    {% if form.is_bound %}
      if(dept.value){ loadMembers(dept.value); }
      else { setRecipientsDisabled(true); setMsg('Ø§Ø®ØªØ± Ù‚Ø³Ù…Ù‹Ø§ Ø£ÙˆÙ„Ø§Ù‹'); }
    {% else %}
      if(dept.value){ loadMembers(dept.value); }
      else { setRecipientsDisabled(true); }
    {% endif %}
  }

  function clearPreviews(){
    if(previews) previews.innerHTML = '';
  }

  function renderPreviews(files){
    clearPreviews();
    files.forEach((f, idx) => {
      const url = URL.createObjectURL(f);
      const box = document.createElement('div');
      box.className = 'thumb';
      box.innerHTML = '<span class="badge">' + (idx + 1) + '</span><img src="' + url + '" alt="preview">';
      previews.appendChild(box);

      const img = box.querySelector('img');
      if(img){
        img.addEventListener('load', () => {
          try{ URL.revokeObjectURL(url); }catch(e){}
        }, {once:true});
      }
    });
  }

  function validateFiles(files){
    if(files.length > MAX_FILES){
      setMsg('ÙŠÙ…ÙƒÙ† Ø±ÙØ¹ ' + MAX_FILES + ' ØµÙˆØ± ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰.', 'error');
      return false;
    }

    for(const f of files){
      const name = (f.name || '').toLowerCase();
      const type = (f.type || '').toLowerCase();
      
      if(!type.startsWith('image/')){
        setMsg('ÙŠØ³Ù…Ø­ ÙÙ‚Ø· Ø¨Ù…Ù„ÙØ§Øª Ø§Ù„ØµÙˆØ±.', 'error');
        return false;
      }
      if(f.size > MAX_FILE_BYTES){
        setMsg('Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹ (Max ' + MAX_FILE_MB + 'MB).', 'error');
        return false;
      }
    }
    return true;
  }

  if(input){
    input.addEventListener('change', () => {
      setMsg('');
      const files = Array.from(input.files || []);
      if(!files.length){ clearPreviews(); return; }
      if(!validateFiles(files)){ input.value=''; clearPreviews(); return; }
      renderPreviews(files);
    });
  }

  // Compression Logic
  async function compressImage(file, opts){
    const maxW = opts.maxW || 1600;
    const maxH = opts.maxH || 1600;
    const quality = typeof opts.quality === 'number' ? opts.quality : 0.82;
    const format = opts.format || 'image/webp';

    const img = document.createElement('img');
    const src = URL.createObjectURL(file);

    await new Promise((res, rej) => {
      img.onload = res;
      img.onerror = rej;
      img.src = src;
    });

    const w = img.naturalWidth || 1;
    const h = img.naturalHeight || 1;
    const r = Math.min(maxW / w, maxH / h, 1);
    const tw = Math.max(1, Math.round(w * r));
    const th = Math.max(1, Math.round(h * r));

    const canvas = document.createElement('canvas');
    canvas.width = tw;
    canvas.height = th;

    const ctx = canvas.getContext('2d');
    if(!ctx) return file;

    ctx.drawImage(img, 0, 0, tw, th);
    
    const blob = await new Promise(resolve => {
        canvas.toBlob(resolve, format, quality);
    });

    try{ URL.revokeObjectURL(src); }catch(e){}
    if(!blob) return file;

    const ext = blob.type === 'image/webp' ? '.webp' : '.jpg';
    const base = (file.name || 'image').replace(/\.\w+$/, '');
    return new File([blob], base + ext, { type: blob.type });
  }

  async function replaceWithCompressed(files){
    const dt = new DataTransfer();
    for(const f of files){
      const c1 = await compressImage(f, { maxW:1600, maxH:1600, quality:0.82 });
      dt.items.add(c1);
    }
    input.files = dt.files;
  }

  if(form){
    form.addEventListener('submit', async (e) => {
      
      // Basic Validation
      if(dept && !dept.value){
        e.preventDefault();
        setMsg('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø³Ù…', 'error');
        dept.focus();
        return;
      }
      
      // Check recipients
      if(recipientsBox && getSelectedRecipientIds().length === 0){
        e.preventDefault();
        setMsg('ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø³ØªÙ„Ù… ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'error');
        recipientsBox.scrollIntoView();
        // Shake animation
        recipientsBox.animate([
           { transform: 'translateX(0)' }, 
           { transform: 'translateX(-5px)' }, 
           { transform: 'translateX(5px)' }, 
           { transform: 'translateX(0)' }
        ], { duration: 300 });
        return;
      }

      // Images Compression
      if(input){
        const files = Array.from(input.files || []);
        if(files.length){
          if(!validateFiles(files)){ e.preventDefault(); return; }
          
          e.preventDefault();
          setLoading(true, 'Ø¬Ø§Ø±ÙŠ Ø¶ØºØ· Ø§Ù„ØµÙˆØ±...');
          try{
            await replaceWithCompressed(files);
            setLoading(false);
            form.submit();
          }catch(err){
            console.error(err);
            setLoading(false);
            setMsg('ÙØ´Ù„ Ø¶ØºØ· Ø§Ù„ØµÙˆØ±ØŒ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹ Ø¨Ø¯ÙˆÙ† Ø¶ØºØ·...', 'error');
            // Allow fallback
            form.submit();
          }
        }
      }
    });
  }

})();
</script>
{% endblock %}
