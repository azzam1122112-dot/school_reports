{% extends "base.html" %}
{% load static %}

{% block title %}Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ | Ø§Ù„Ù…Ù†ØµØ©{% endblock %}

{% block head %}
<style>
  /* =========================================================
     Request Create 2026 â€” Modern & Professional
     ========================================================= */
  .ticket-page {
    --gap: 24px;
    --radius-lg: 24px;
    --radius-md: 16px;
    --radius-sm: 12px;
    --ease-out: cubic-bezier(0.16, 1, 0.3, 1);
  }

  .ticket-wrap {
    max-width: 1440px;
    margin: 0 auto;
    padding: var(--gap);
    display: grid;
    grid-template-columns: 1fr;
    gap: var(--gap);
    animation: fade-up 0.6s var(--ease-out);
  }

  @media (min-width: 1024px) {
    .ticket-wrap {
      grid-template-columns: minmax(0, 7fr) minmax(0, 4fr);
      align-items: start;
    }
  }

  /* Cards */
  .tk-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-sm);
    padding: 32px;
    position: relative;
    overflow: hidden;
  }
  
  .tk-card.is-sticky {
    position: sticky;
    top: 24px;
    z-index: 10;
  }

  /* Header & Titles */
  .tk-header {
    margin-bottom: 32px;
    padding-bottom: 24px;
    border-bottom: 1px solid var(--border);
  }

  .tk-title {
    font-size: 1.8rem;
    font-weight: 800;
    color: var(--ink);
    letter-spacing: -0.02em;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .tk-title-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 48px;
    height: 48px;
    background: var(--brand-500-10);
    color: var(--brand-600);
    border-radius: var(--radius-md);
    font-size: 1.5rem;
  }

  .tk-subtitle {
     font-size: 1rem;
     color: var(--ink-light);
     line-height: 1.5;
  }

  /* Form Elements */
  .tk-form-group {
    margin-bottom: 24px;
  }
  
  .tk-label {
    display: block;
    font-size: 0.95rem;
    font-weight: 700;
    color: var(--ink);
    margin-bottom: 10px;
  }
  
  .tk-label span.req { color: var(--danger-500); margin-right: 4px; }

  .tk-input, .tk-select, .tk-textarea {
    width: 100%;
    padding: 16px;
    border-radius: var(--radius-md);
    border: 1px solid var(--border);
    background: var(--surface-alt);
    color: var(--ink);
    font-size: 1rem;
    font-family: inherit;
    transition: all 0.2s var(--ease-out);
  }
  
  .tk-input:focus, .tk-select:focus, .tk-textarea:focus {
    outline: none;
    border-color: var(--brand-500);
    box-shadow: 0 0 0 4px var(--brand-500-20);
    background: var(--surface);
  }

  .tk-textarea {
    min-height: 400px;
    line-height: 1.7;
    resize: vertical;
  }
  
  .tk-select {
    cursor: pointer;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748b'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: left 1rem center;
    background-size: 1.25em;
  }

  /* Recipients Styling (Matches JS structure) */
  .recipients-dd {
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    background: var(--surface);
    overflow: hidden;
    transition: box-shadow 0.2s;
  }
  .recipients-dd[open] {
    box-shadow: var(--shadow-md);
    border-color: var(--brand-500);
  }
  
  .recipients-dd > summary {
    list-style: none;
    padding: 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    font-weight: 600;
    background: var(--surface-alt);
    color: var(--ink);
    transition: background 0.2s;
  }
  
  .recipients-dd > summary:hover,
  .recipients-dd[open] > summary {
    background: var(--surface);
  }
  
  .recipients-dd[open] > summary {
    border-bottom: 1px solid var(--border);
  }
  
  /* Hide standard details marker */
  .recipients-dd > summary::-webkit-details-marker { display:none; }

  .recipients-panel { padding: 12px; }
  
  .recipients-search {
    width: 100%;
    padding: 12px;
    margin-bottom: 12px;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    font-size: 0.9rem;
    background: var(--surface-alt);
    color: var(--ink);
  }
  
  .recipients-scroll {
    max-height: 280px;
    overflow-y: auto;
    padding-left: 8px; /* For scrollbar space RTL */
  }
  
  /* Scrollbar */
  .recipients-scroll::-webkit-scrollbar { width: 6px; }
  .recipients-scroll::-webkit-scrollbar-track { background: transparent; }
  .recipients-scroll::-webkit-scrollbar-thumb { background: var(--border); border-radius: 99px; }
  .recipients-scroll::-webkit-scrollbar-thumb:hover { background: var(--ink-lighter); }

  .recipients-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 8px;
  }
  
  .rcpt {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 12px;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
    cursor: pointer;
    transition: all 0.15s;
    user-select: none;
    font-size: 0.95rem;
    color: var(--ink-soft);
    background: transparent;
  }
  
  .rcpt:hover {
    background: var(--surface-alt);
    border-color: var(--brand-300);
  }
  
  .rcpt.selected {
    background: var(--brand-500-10);
    border-color: var(--brand-500);
    color: var(--brand-700);
    font-weight: 600;
  }

  .rcpt input { 
    accent-color: var(--brand-600); 
    width: 18px; 
    height: 18px; 
    cursor: pointer;
  }

  /* File Upload */
  .tk-upload-container {
      margin-top: 10px;
  }

  .tk-upload-label {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 32px;
    border: 2px dashed var(--border);
    border-radius: var(--radius-md);
    background: var(--surface-alt);
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
  }
  
  .tk-upload-label:hover {
    border-color: var(--brand-400);
    background: var(--brand-500-05);
  }
  
  .tk-upload-icon {
    font-size: 2.5rem;
    margin-bottom: 12px;
    color: var(--brand-500);
    opacity: 0.8;
  }
  
  .tk-upload-text {
    font-weight: 700;
    color: var(--ink);
    margin-bottom: 4px;
  }
  
  .tk-upload-hint {
    font-size: 0.85rem;
    color: var(--ink-light);
  }

  /* Image Previews */
  .previews-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
    gap: 12px;
    margin-top: 16px;
  }
  
  .thumb {
    position: relative;
    aspect-ratio: 1;
    border-radius: var(--radius-sm);
    overflow: hidden;
    border: 1px solid var(--border);
    background: var(--surface-alt);
  }
  
  .thumb img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .thumb .badge {
    position: absolute;
    top: 4px;
    right: 4px; /* RTL flip check? No, absolute positioning */
    background: rgba(0,0,0,0.6);
    color: white;
    font-size: 0.7rem;
    padding: 2px 6px;
    border-radius: 99px;
    backdrop-filter: blur(4px);
  }

  /* Actions */
  .tk-actions {
    display: grid;
    gap: 16px;
    margin-top: 32px;
    padding-top: 24px;
    border-top: 1px solid var(--border);
  }
  
  .btn-submit {
    background: #007bff; /* Fallback */
    background: linear-gradient(135deg, #1a56db, #3f83f8);
    color: #ffffff !important;
    font-weight: 700;
    padding: 16px;
    border-radius: var(--radius-md);
    border: none;
    cursor: pointer;
    font-size: 1.1rem;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 12px;
    transition: all 0.2s;
    box-shadow: 0 10px 15px -3px rgba(31, 88, 222, 0.3);
  }
  
  .btn-submit svg {
    filter: drop-shadow(0 0 2px rgba(0,0,0,0.1));
  }

  .btn-submit:hover {
    transform: translateY(-2px);
    box-shadow: 0 20px 25px -5px rgba(31, 88, 222, 0.4);
    filter: brightness(1.1);
  }
  
  .btn-submit:active { transform: translateY(0); }
  
  .btn-cancel {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 14px;
    border-radius: var(--radius-md);
    color: var(--ink-light);
    font-weight: 600;
    text-decoration: none;
    transition: color 0.2s;
  }
  
  .btn-cancel:hover { color: var(--ink); background: var(--surface-alt); }

  /* Utilities */
  .help-text {
    font-size: 0.85rem;
    color: var(--ink-lighter);
    margin-top: 8px;
    line-height: 1.4;
  }
  
  .error-text {
    color: var(--danger-600);
    background: var(--danger-500-10);
    padding: 10px 14px;
    border-radius: var(--radius-sm);
    font-size: 0.9rem;
    margin-top: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .status-msg {
    margin-top: 16px;
    text-align: center;
    font-weight: 600;
    min-height: 24px;
  }

  @keyframes fade-up {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  @media (max-width: 768px) {
    .tk-title { font-size: 1.4rem; }
    .tk-card { padding: 20px; }
  }
</style>
{% endblock %}

{% block content %}
<div class="ticket-page" dir="rtl">
  
  <form method="post" enctype="multipart/form-data" id="ticket-form" novalidate>
    {% csrf_token %}
    
    <div class="ticket-wrap">
      
      <!-- MAIN COLUMN: Content (Title, Body) -->
      <section class="tk-column-main">
        <div class="tk-card">
          <div class="tk-header">
            <h1 class="tk-title">
              <span class="tk-title-icon">ğŸ“</span>
              Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
            </h1>
            <p class="tk-subtitle">Ù‚Ù… Ø¨ØªØ¹Ø¨Ø¦Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø¯Ù‚Ø© Ù„Ø¶Ù…Ø§Ù† Ù…Ø¹Ø§Ù„Ø¬ØªÙ‡ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø®ØªØµ ÙÙŠ Ø£Ø³Ø±Ø¹ ÙˆÙ‚Øª.</p>
          </div>

          <!-- Title -->
          <div class="tk-form-group">
            <label for="{{ form.title.id_for_label }}" class="tk-label">
              Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø·Ù„Ø¨ <span class="req">*</span>
            </label>
            {{ form.title }} 
            <!-- Django usually renders input class via attrs, but if not we can assume default styling or JS enhancement -->
            <!-- We will rely on CSS selectors targeting inputs inside .ticket-page -->
            {% for e in form.title.errors %}<div class="error-text">âš ï¸ {{ e }}</div>{% endfor %}
          </div>

          <!-- Body -->
          <div class="tk-form-group">
            <label for="{{ form.body.id_for_label }}" class="tk-label">
              ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ <span class="req">*</span>
            </label>
            <div class="help-text" style="margin-bottom:8px">Ø§Ø´Ø±Ø­ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø£Ùˆ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø§Ù„ØªÙØµÙŠÙ„.</div>
            {{ form.body }}
            {% for e in form.body.errors %}<div class="error-text">âš ï¸ {{ e }}</div>{% endfor %}
          </div>
          
        </div>
      </section>

      <!-- SIDE COLUMN: Routing (Dept, Recipients) & Attachments & Actions -->
      <aside class="tk-column-side">
        <div class="tk-card is-sticky">
          
          {% if form.non_field_errors %}
            <div class="error-text" style="margin-bottom:20px">
              {% for e in form.non_field_errors %}âš ï¸ {{ e }}<br>{% endfor %}
            </div>
          {% endif %}

          <div class="tk-form-group">
            <label for="{{ form.department.id_for_label }}" class="tk-label">
              Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø®ØªØµ <span class="req">*</span>
            </label>
            <select id="{{ form.department.id_for_label }}" name="{{ form.department.html_name }}" class="tk-select" required>
              <option value="" selected hidden>â€” Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… â€”</option>
              {% for d in form.fields.department.queryset %}
                {% with v=d.slug %}
                  <option value="{{ v }}"
                    {% if form.is_bound %}
                      {% if form.data.department == v %}selected{% endif %}
                    {% else %}
                      {% if form.initial.department == v %}selected{% endif %}
                    {% endif %}
                  >{{ d.name }}</option>
                {% endwith %}
              {% endfor %}
            </select>
            {% for e in form.department.errors %}<div class="error-text">âš ï¸ {{ e }}</div>{% endfor %}
          </div>

          <div class="tk-form-group">
            <label class="tk-label">
              Ø§Ù„Ù…Ø³ØªÙ„Ù…ÙˆÙ† <span class="req">*</span>
            </label>
            <div
              id="id_recipients"
              class="recipients-box"
              aria-label="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªÙ„Ù…ÙŠÙ†"
              {% if selected_recipient_ids %}
                data-selected="{% for rid in selected_recipient_ids %}{{ rid }}{% if not forloop.last %},{% endif %}{% endfor %}"
              {% endif %}
            >
             <div class="help-text">ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø³Ù… Ø£ÙˆÙ„Ø§Ù‹.</div>
            </div>
            
            {% for e in form.recipients.errors %}<div class="error-text">âš ï¸ {{ e }}</div>{% endfor %}
          </div>

          <hr style="border:0; border-top:1px solid var(--border); margin: 24px 0;">

          <!-- Attachments -->
          <div class="tk-form-group">
            <label class="tk-label">Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª (ØµÙˆØ± ÙÙ‚Ø·)</label>
            
            <div class="tk-upload-container">
              <input id="id_images" name="images" type="file" accept="image/*" multiple hidden>
              <label for="id_images" class="tk-upload-label">
                <span class="tk-upload-icon">ğŸ“·</span>
                <span class="tk-upload-text">Ø§Ø¶ØºØ· Ù„Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±</span>
                <span class="tk-upload-hint">JPG, PNG, WebP (Max 4)</span>
              </label>
            </div>
            
            <!-- Error container for images -->
            {% if form.errors and form.errors.images %}
               <div class="error-text">âš ï¸ {{ form.errors.images.0 }}</div>
            {% endif %}

            <div class="previews-grid" id="previews"></div>
          </div>
          
          <div id="dynamic-msg" class="status-msg" aria-live="polite"></div>

          <div class="tk-actions">
            <button class="btn-submit" type="submit" id="submitBtn">
              <span>Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†</span>
              <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
            </button>
            <a class="btn-cancel" href="{% url 'reports:my_requests' %}">Ø¥Ù„ØºØ§Ø¡ ÙˆØ§Ù„Ø¹ÙˆØ¯Ø©</a>
          </div>

        </div>
      </aside>

    </div>
  </form>
</div>
{% endblock %}

{% block scripts %}
<script nonce="{{ CSP_NONCE }}">
(function(){
  // --- Add CSS Classes to Django Rendered Inputs ---
  document.querySelectorAll('.ticket-page input[type="text"], .ticket-page textarea').forEach(el => {
    if(el.tagName === 'TEXTAREA') el.classList.add('tk-textarea');
    else el.classList.add('tk-input');
    
    // Placeholder enhancements
    if(el.name === 'title' && !el.placeholder) el.placeholder = 'Ù…Ø«Ø§Ù„: Ø¹Ø·Ù„ ÙÙŠ Ø¬Ù‡Ø§Ø² Ø§Ù„Ø¹Ø±Ø¶ Ø¨Ø§Ù„Ù…Ø¹Ù…Ù„ Ø±Ù‚Ù… 3...';
    if(el.name === 'body' && !el.placeholder) el.placeholder = 'Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ù‡Ù†Ø§...';
  });

  // --- Logic Preservation ---
  const form = document.getElementById('ticket-form');
  const dept = document.getElementById('{{ form.department.id_for_label }}');
  const recipientsBox = document.getElementById('id_recipients');
  const msg = document.getElementById('dynamic-msg');
  const input = document.getElementById('id_images');
  const previews = document.getElementById('previews');
  const submitBtn = document.getElementById('submitBtn');

  const MAX_FILES = 4;
  const MAX_FILE_MB = 6;
  const MAX_FILE_BYTES = MAX_FILE_MB * 1024 * 1024;

  const CSRF = (window.getCsrfToken ? window.getCsrfToken() : (window.csrfToken || ''));

  function setMsg(text, type){
    if(!msg) return;
    msg.textContent = text || '';
    if(type === 'error') msg.style.color = '#e11d48';
    else if(type === 'ok') msg.style.color = '#059669';
    else msg.style.color = 'var(--ink-light)';
  }

  function setLoading(isLoading, text){
    if(submitBtn){
      submitBtn.disabled = !!isLoading;
      const originalText = submitBtn.querySelector('span');
      if(isLoading){
        submitBtn.style.opacity = '0.7';
        if(originalText) originalText.dataset.original = originalText.textContent;
        if(originalText) originalText.textContent = text || 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...';
      } else {
        submitBtn.style.opacity = '1';
        if(originalText && originalText.dataset.original) originalText.textContent = originalText.dataset.original;
      }
    }
  }

  function setRecipientsDisabled(disabled){
    if(!recipientsBox) return;
    recipientsBox.classList.toggle('disabled', disabled);
    recipientsBox.dataset.disabled = disabled ? '1' : '0';
    if(disabled){
      recipientsBox.innerHTML = '<div class="help-text">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†.</div>';
    }
  }

  function parseSelectedIds(){
    if(!recipientsBox) return [];
    const raw = recipientsBox.getAttribute('data-selected') || '';
    if(!raw) return [];
    return raw.split(',').map(s => (s || '').trim()).filter(Boolean);
  }

  function getSelectedRecipientIds(){
    if(!recipientsBox) return [];
    return Array.from(recipientsBox.querySelectorAll('input[type="checkbox"][name="recipients"]:checked'))
      .map(el => String(el.value));
  }

  function updateRecipientsSummary(){
    if(!recipientsBox) return;
    const details = recipientsBox.querySelector('details.recipients-dd');
    if(!details) return;

    const countEl = details.querySelector('.recipients-dd-title .count');
    const txtEl = details.querySelector('.recipients-dd-title .txt');
    if(!countEl || !txtEl) return;

    const selected = Array.from(details.querySelectorAll('input[type="checkbox"][name="recipients"]:checked'));
    const n = selected.length;

    if(n === 0){
      txtEl.textContent = 'Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙ„Ù…ÙŠÙ†';
      countEl.textContent = '';
      return;
    }

    if(n === 1){
      const label = selected[0].closest('label');
      const name = label ? (label.textContent || '').trim() : '';
      txtEl.textContent = name || 'ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ø³ØªÙ„Ù…';
      countEl.textContent = '(1)';
      return;
    }

    txtEl.textContent = 'ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ø³ØªÙ„Ù…ÙŠÙ†';
    countEl.textContent = '(' + n + ')';
  }

  function renderRecipients(list){
    if(!recipientsBox) return;

    if(!Array.isArray(list) || list.length === 0){
      recipientsBox.innerHTML = '<div class="help-text">âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙˆÙ† Ù…Ø³Ø¬Ù„ÙˆÙ† ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ø­Ø§Ù„ÙŠØ§Ù‹.</div>';
      return;
    }

    recipientsBox.innerHTML = '';

    const details = document.createElement('details');
    details.className = 'recipients-dd';
    details.open = true; // Open by default for better visibility in sidebar? No, maybe collapsed is cleaner. Let's keep closed.
    // Actually in the sidebar it might be better to be collapsible.

    const summary = document.createElement('summary');
    const title = document.createElement('div');
    title.className = 'recipients-dd-title';
    title.style.display = 'flex';
    title.style.gap = '8px';
    title.style.alignItems = 'center';
    
    title.innerHTML = '<span class="txt">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙ„Ù…ÙŠÙ†</span><span class="count" style="color:var(--brand-600);font-weight:700"></span>';

    const caret = document.createElement('span');
    caret.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>';

    summary.appendChild(title);
    summary.appendChild(caret);

    const panel = document.createElement('div');
    panel.className = 'recipients-panel';

    const searchInput = document.createElement('input');
    searchInput.type = 'text';
    searchInput.placeholder = 'Ø¨Ø­Ø« Ø¹Ù† Ù…ÙˆØ¸Ù...';
    searchInput.className = 'recipients-search';

    const scroll = document.createElement('div');
    scroll.className = 'recipients-scroll';

    const grid = document.createElement('div');
    grid.className = 'recipients-grid';

    // Restore Pre-selection if any
    const preSelected = new Set(parseSelectedIds());

    let searchTimer = null;
    searchInput.addEventListener('input', (e) => {
      const val = (e.target.value || '').toLowerCase();
      if(searchTimer) window.clearTimeout(searchTimer);
      searchTimer = window.setTimeout(() => {
        const labels = grid.querySelectorAll('.rcpt');
        labels.forEach(lbl => {
          const name = (lbl.textContent || '').toLowerCase();
          lbl.style.display = name.includes(val) ? 'flex' : 'none';
        });
      }, 60);
    });

    list.forEach(u => {
      const label = document.createElement('label');
      label.className = 'rcpt';

      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.name = 'recipients';
      cb.value = String(u.id);

      if(preSelected.has(String(u.id))){
        cb.checked = true;
        label.classList.add('selected');
      }

      cb.addEventListener('change', () => {
        if(cb.checked) label.classList.add('selected');
        else label.classList.remove('selected');
        updateRecipientsSummary();
      });

      const text = document.createElement('span');
      text.textContent = u.name;

      label.appendChild(cb);
      label.appendChild(text);
      grid.appendChild(label);
    });

    scroll.appendChild(grid);
    panel.appendChild(searchInput);
    panel.appendChild(scroll);

    details.appendChild(summary);
    details.appendChild(panel);

    recipientsBox.appendChild(details);

    updateRecipientsSummary();
  }

  async function loadMembers(deptSlug){
    if(!recipientsBox) return;

    setRecipientsDisabled(true);
    // Show spinner in box
    recipientsBox.innerHTML = '<div style="padding:10px;text-align:center;color:var(--ink-light)">...Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</div>';

    try{
      const baseUrl = "{% url 'reports:api_department_members' %}";
      const url = baseUrl + "?department=" + encodeURIComponent(deptSlug);

      const res = await fetch(url, {
        method: 'GET',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': CSRF
        },
        credentials: 'same-origin'
      });

      if(!res.ok) throw new Error('HTTP ' + res.status);

      const data = await res.json();
      const list = Array.isArray(data.results) ? data.results : [];

      renderRecipients(list);
      setRecipientsDisabled(false);

      // Auto-select if only 1
      const preSelected = parseSelectedIds();
      if(list.length === 1 && preSelected.length === 0){
        const first = recipientsBox.querySelector('input[type="checkbox"][name="recipients"]');
        if(first){
          first.checked = true;
          const lbl = first.closest('label');
          if(lbl) lbl.classList.add('selected');
        }
        updateRecipientsSummary();
        setMsg('ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„ÙˆØ­ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§', 'ok');
        return;
      }
      
      setMsg('', 'ok'); // Clear msg

    } catch(err){
      console.error(err);
      recipientsBox.innerHTML = '<div class="error-text">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†.</div>';
      setMsg('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', 'error');
    }
  }

  // Event Listeners
  if(dept && recipientsBox){
    dept.addEventListener('change', (e) => {
      const slug = (e.target.value || '').trim();
      recipientsBox.removeAttribute('data-selected'); // Clear preserved selection on change

      if(!slug){
        setRecipientsDisabled(true);
        setMsg('Ø§Ø®ØªØ± Ù‚Ø³Ù…Ù‹Ø§ Ø£ÙˆÙ„Ø§Ù‹');
        return;
      }
      loadMembers(slug);
    });

    // On Load
    {% if form.is_bound %}
      if(dept.value){ loadMembers(dept.value); }
      else { setRecipientsDisabled(true); setMsg('Ø§Ø®ØªØ± Ù‚Ø³Ù…Ù‹Ø§ Ø£ÙˆÙ„Ø§Ù‹'); }
    {% else %}
      if(dept.value){ loadMembers(dept.value); }
      else { setRecipientsDisabled(true); }
    {% endif %}
  }

  function clearPreviews(){
    if(previews) previews.innerHTML = '';
  }

  function renderPreviews(files){
    clearPreviews();
    files.forEach((f, idx) => {
      const url = URL.createObjectURL(f);
      const box = document.createElement('div');
      box.className = 'thumb';
      box.innerHTML = '<span class="badge">' + (idx + 1) + '</span><img src="' + url + '" alt="preview">';
      previews.appendChild(box);

      const img = box.querySelector('img');
      if(img){
        img.addEventListener('load', () => {
          try{ URL.revokeObjectURL(url); }catch(e){}
        }, {once:true});
      }
    });
  }

  function validateFiles(files){
    if(files.length > MAX_FILES){
      setMsg('ÙŠÙ…ÙƒÙ† Ø±ÙØ¹ ' + MAX_FILES + ' ØµÙˆØ± ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰.', 'error');
      return false;
    }

    for(const f of files){
      const name = (f.name || '').toLowerCase();
      const type = (f.type || '').toLowerCase();
      
      if(!type.startsWith('image/')){
        setMsg('ÙŠØ³Ù…Ø­ ÙÙ‚Ø· Ø¨Ù…Ù„ÙØ§Øª Ø§Ù„ØµÙˆØ±.', 'error');
        return false;
      }
      if(f.size > MAX_FILE_BYTES){
        setMsg('Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹ (Max ' + MAX_FILE_MB + 'MB).', 'error');
        return false;
      }
    }
    return true;
  }

  if(input){
    input.addEventListener('change', () => {
      setMsg('');
      const files = Array.from(input.files || []);
      if(!files.length){ clearPreviews(); return; }
      if(!validateFiles(files)){ input.value=''; clearPreviews(); return; }
      renderPreviews(files);
    });
  }

  // Compression Logic
  async function compressImage(file, opts){
    const maxW = opts.maxW || 1600;
    const maxH = opts.maxH || 1600;
    const quality = typeof opts.quality === 'number' ? opts.quality : 0.82;
    const format = opts.format || 'image/webp';

    const img = document.createElement('img');
    const src = URL.createObjectURL(file);

    await new Promise((res, rej) => {
      img.onload = res;
      img.onerror = rej;
      img.src = src;
    });

    const w = img.naturalWidth || 1;
    const h = img.naturalHeight || 1;
    const r = Math.min(maxW / w, maxH / h, 1);
    const tw = Math.max(1, Math.round(w * r));
    const th = Math.max(1, Math.round(h * r));

    const canvas = document.createElement('canvas');
    canvas.width = tw;
    canvas.height = th;

    const ctx = canvas.getContext('2d');
    if(!ctx) return file;

    ctx.drawImage(img, 0, 0, tw, th);
    
    const blob = await new Promise(resolve => {
        canvas.toBlob(resolve, format, quality);
    });

    try{ URL.revokeObjectURL(src); }catch(e){}
    if(!blob) return file;

    const ext = blob.type === 'image/webp' ? '.webp' : '.jpg';
    const base = (file.name || 'image').replace(/\.\w+$/, '');
    return new File([blob], base + ext, { type: blob.type });
  }

  async function replaceWithCompressed(files){
    const dt = new DataTransfer();
    for(const f of files){
      const c1 = await compressImage(f, { maxW:1600, maxH:1600, quality:0.82 });
      dt.items.add(c1);
    }
    input.files = dt.files;
  }

  if(form){
    form.addEventListener('submit', async (e) => {
      
      // Basic Validation
      if(dept && !dept.value){
        e.preventDefault();
        setMsg('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø³Ù…', 'error');
        dept.focus();
        return;
      }
      
      // Check recipients
      if(recipientsBox && getSelectedRecipientIds().length === 0){
        e.preventDefault();
        setMsg('ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø³ØªÙ„Ù… ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'error');
        recipientsBox.scrollIntoView();
        // Shake animation
        recipientsBox.animate([
           { transform: 'translateX(0)' }, 
           { transform: 'translateX(-5px)' }, 
           { transform: 'translateX(5px)' }, 
           { transform: 'translateX(0)' }
        ], { duration: 300 });
        return;
      }

      // Images Compression
      if(input){
        const files = Array.from(input.files || []);
        if(files.length){
          if(!validateFiles(files)){ e.preventDefault(); return; }
          
          e.preventDefault();
          setLoading(true, 'Ø¬Ø§Ø±ÙŠ Ø¶ØºØ· Ø§Ù„ØµÙˆØ±...');
          try{
            await replaceWithCompressed(files);
            setLoading(false);
            form.submit();
          }catch(err){
            console.error(err);
            setLoading(false);
            setMsg('ÙØ´Ù„ Ø¶ØºØ· Ø§Ù„ØµÙˆØ±ØŒ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹ Ø¨Ø¯ÙˆÙ† Ø¶ØºØ·...', 'error');
            // Allow fallback
            form.submit();
          }
        }
      }
    });
  }

})();
</script>
{% endblock %}
