{# reports/templates/reports/ticket_create.html (Ø£Ùˆ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø°ÙŠ ØªØ³ØªØ®Ø¯Ù…Ù‡) #}
{% extends "base.html" %}
{% load static %}

{% block title %}Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯{% endblock %}

{% block head %}
<style>
  /* =========================================================
     Ticket Create â€” scoped Ø¯Ø§Ø®Ù„ .ticket-page ÙÙ‚Ø·
     - Ø¨Ø¯ÙˆÙ† Ù„Ù…Ø³ Ø£Ù†Ù…Ø§Ø· base Ø§Ù„Ø¹Ø§Ù…Ø© Ø®Ø§Ø±Ø¬ Ø§Ù„ØµÙØ­Ø©
     - Ù…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ data-theme (dark/light)
     ========================================================= */
  .ticket-page{
    --ink:#0f172a;
    --ink-soft:#1f2937;
    --muted:#64748b;
    --line:#e5e7eb;

    --brand:#2563eb;
    --brand-light:#3b82f6;

    --accent:#059669;
    --accent-light:#10b981;

    --card:#ffffff;
    --bg:#f8fafc;

    --error:#ef4444;
    --error-bg:#fef2f2;

    --radius:16px;
    --rsm:12px;
    --shadow:0 10px 30px rgba(2,6,23,.08);

    /* Ù„Ùˆ base ÙÙŠÙ‡ --t-fast Ø¨Ù†Ø³ØªÙÙŠØ¯ Ù…Ù†Ù‡ */
    --t: var(--t-fast);
  }

  html[data-theme="dark"] .ticket-page{
    --ink:#e5e7eb;
    --ink-soft:#f1f5f9;
    --muted:#94a3b8;
    --line:#1f2a44;

    --card:#0b1220;
    --bg:#070b14;

    --error-bg: rgba(239,68,68,.10);
    --shadow:0 14px 42px rgba(0,0,0,.35);
  }

  .ticket-page{
    background: transparent;
    color: var(--ink);
  }

  .ticket-page .ticket-container{
    max-width: 900px;
    margin: 0 auto;
    padding: 18px;
  }

  .ticket-page .ticket-card{
    background: var(--card);
    border: 1px solid var(--line);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 22px;
    overflow: hidden;
  }

  .ticket-page .section-title{
    font-size: 1.35rem;
    font-weight: 950;
    color: var(--ink-soft);
    display:flex;
    gap:10px;
    align-items:center;
    margin:0 0 16px;
  }

  .ticket-page .form-grid{display:grid;gap:18px}
  .ticket-page .form-row{display:grid;gap:16px}
  @media(min-width:720px){
    .ticket-page .form-row{grid-template-columns:1fr 1fr}
  }

  .ticket-page .form-group{display:flex;flex-direction:column;gap:8px}
  .ticket-page label{font-weight:900;color:var(--ink-soft)}

  .ticket-page input[type="text"],
  .ticket-page select,
  .ticket-page textarea{
    width:100%;
    padding:14px 16px;
    border:1px solid var(--line);
    border-radius: var(--rsm);
    font:inherit;
    background: var(--card);
    color: var(--ink);
    transition: var(--t);
  }

  .ticket-page select:disabled{
    opacity:.85;
    cursor:not-allowed;
  }

  .ticket-page input:focus,
  .ticket-page select:focus,
  .ticket-page textarea:focus{
    outline:none;
    border-color: var(--brand-light);
    box-shadow: 0 0 0 3px rgba(59,130,246,.18);
  }

  .ticket-page textarea{min-height:140px;resize:vertical}

  .ticket-page .help{
    font-size:.92rem;
    color: var(--muted);
    font-weight: 850;
    line-height:1.55;
  }

  .ticket-page .field-error{
    color: var(--error);
    background: var(--error-bg);
    border: 1px solid rgba(239,68,68,.25);
    padding:10px 12px;
    border-radius: var(--rsm);
    font-size:.92rem;
    font-weight: 950;
  }

  /* Ù…Ø³ØªÙ„Ù…ÙˆÙ† (Dropdown + Search + Checkboxes) */
  .ticket-page .recipients-box{
    border:0;
    padding:0;
    background:transparent;
    min-height:52px;
  }

  .ticket-page .recipients-dd{
    width:100%;
    border:1px solid var(--line);
    border-radius: var(--rsm);
    background: var(--card);
    overflow:hidden;
  }

  .ticket-page .recipients-dd > summary{
    list-style:none;
    cursor:pointer;
    padding:12px 14px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    font-weight: 950;
    color: var(--ink-soft);
    user-select:none;
  }

  .ticket-page .recipients-dd > summary::-webkit-details-marker{display:none}
  .ticket-page .recipients-dd > summary:focus{outline:none}
  .ticket-page .recipients-dd[open] > summary{
    border-bottom:1px solid var(--line);
    background: rgba(148,163,184,.10);
  }

  .ticket-page .recipients-dd-title{
    display:flex;
    align-items:center;
    gap:10px;
    min-width:0;
  }
  .ticket-page .recipients-dd-title .txt{
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .ticket-page .recipients-dd-title .count{
    font-size:.85rem;
    color: var(--muted);
    font-weight: 950;
    flex:0 0 auto;
  }
  .ticket-page .recipients-dd-caret{
    color: var(--muted);
    font-size: 1rem;
    flex:0 0 auto;
  }

  .ticket-page .recipients-panel{padding:10px 12px}

  .ticket-page .recipients-search{
    width:100%;
    padding:10px 12px;
    border:1px solid var(--line);
    border-radius: 10px;
    font-size:.95rem;
    background: var(--card);
    color: var(--ink);
  }

  .ticket-page .recipients-scroll{
    margin-top:10px;
    max-height:320px;
    overflow-y:auto;
    padding-inline-end:4px;
  }

  .ticket-page .recipients-grid{
    display:grid;
    gap:10px;
    grid-template-columns:1fr;
  }

  .ticket-page .rcpt{
    display:flex;
    align-items:center;
    gap:10px;
    padding:10px 12px;
    border:1px solid var(--line);
    border-radius: 12px;
    background: rgba(148,163,184,.10);
    font-weight: 950;
    color: var(--ink-soft);
    cursor:pointer;
    transition: var(--t);
  }

  .ticket-page .rcpt:hover{
    border-color: rgba(59,130,246,.55);
    background: rgba(59,130,246,.10);
  }

  .ticket-page .rcpt.selected{
    background: rgba(37,99,235,.12);
    border-color: rgba(37,99,235,.75);
    color: var(--brand);
    box-shadow: 0 0 0 1px rgba(37,99,235,.35);
  }

  .ticket-page .rcpt input{
    width:20px;
    height:20px;
    accent-color: var(--brand);
    cursor:pointer;
    flex:0 0 auto;
  }

  /* Ù…Ø¹Ø§ÙŠÙ†Ø§Øª Ø§Ù„ØµÙˆØ± */
  .ticket-page .previews{
    display:grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap:10px;
    margin-top:8px;
  }
  .ticket-page .thumb{
    position:relative;
    border:1px solid var(--line);
    border-radius: 12px;
    overflow:hidden;
    background: var(--card);
  }
  .ticket-page .thumb img{
    display:block;
    width:100%;
    height:100%;
    object-fit:cover;
    aspect-ratio: 4 / 3;
  }
  .ticket-page .thumb .badge{
    position:absolute;
    top:6px;
    left:6px;
    background: rgba(15,23,42,.75);
    color:#fff;
    font-size:.78rem;
    padding:2px 6px;
    border-radius: 999px;
  }
  html[data-theme="dark"] .ticket-page .thumb .badge{
    background: rgba(0,0,0,.55);
  }

  /* Actions */
  .ticket-page .form-actions{
    display:grid;
    gap:12px;
  }
  @media(min-width:560px){
    .ticket-page .form-actions{grid-template-columns:1fr 1fr}
  }

  .ticket-page .btn{
    padding:14px 18px;
    border:0;
    border-radius: 12px;
    font-weight: 950;
    cursor:pointer;
    transition: var(--t);
    display:inline-flex;
    justify-content:center;
    align-items:center;
    gap:8px;
    text-decoration:none;
  }

  .ticket-page .btn:disabled{
    opacity:.75;
    cursor:not-allowed;
    transform:none !important;
  }

  .ticket-page .btn-accent{
    background: linear-gradient(135deg, var(--accent), var(--accent-light));
    color:#fff;
  }
  .ticket-page .btn-accent:hover{transform: translateY(-2px)}
  .ticket-page .btn-outline{
    background: transparent;
    border:1px solid var(--line);
    color: var(--ink-soft);
  }
  .ticket-page .btn-outline:hover{
    background: rgba(148,163,184,.10);
  }

  .ticket-page #dynamic-msg{min-height:22px}

  @media(max-width:520px){
    .ticket-page .ticket-container{padding:14px 12px}
    .ticket-page .ticket-card{padding:16px}
    .ticket-page .section-title{font-size:1.18rem}
    .ticket-page input[type="text"], .ticket-page select, .ticket-page textarea{font-size:16px}
    .ticket-page .form-actions{grid-template-columns:1fr}
    .ticket-page .btn{width:100%}
  }

  @media (prefers-reduced-motion: reduce){
    .ticket-page *{transition:none !important}
    .ticket-page .btn-accent:hover{transform:none !important}
  }
</style>
{% endblock %}

{% block content %}
<div class="ticket-page" dir="rtl">
  <div class="ticket-container">
    <div class="ticket-card">
      <h2 class="section-title">ğŸ“ Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</h2>

      {% if form.non_field_errors %}
        <div class="field-error" style="margin-bottom:12px">
          {% for e in form.non_field_errors %}â€¢ {{ e }}<br>{% endfor %}
        </div>
      {% endif %}

      <form method="post" enctype="multipart/form-data" class="form-grid" id="ticket-form" novalidate>
        {% csrf_token %}

        <div class="form-row">
          <div class="form-group">
            <label for="{{ form.department.id_for_label }}">Ø§Ù„Ù‚Ø³Ù… <span aria-hidden="true" style="color:#ef4444">*</span></label>

            <select id="{{ form.department.id_for_label }}" name="{{ form.department.html_name }}" required>
              <option value="" selected hidden>â€” Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… â€”</option>
              {% for d in form.fields.department.queryset %}
                {% with v=d.slug %}
                  <option value="{{ v }}"
                    {% if form.is_bound %}
                      {% if form.data.department == v %}selected{% endif %}
                    {% else %}
                      {% if form.initial.department == v %}selected{% endif %}
                    {% endif %}
                  >{{ d.name }}</option>
                {% endwith %}
              {% endfor %}
            </select>

            {% for e in form.department.errors %}<div class="field-error">â€¢ {{ e }}</div>{% endfor %}
            <div class="help">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… Ø£ÙˆÙ„Ù‹Ø§ Ù„ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.</div>
          </div>

          <div class="form-group">
            <label for="{{ form.recipients.id_for_label }}">Ø§Ù„Ù…Ø³ØªÙ„Ù…ÙˆÙ† <span aria-hidden="true" style="color:#ef4444">*</span></label>

            {# ÙŠÙ…ÙƒÙ† ØªÙ…Ø±ÙŠØ± selected_recipient_ids Ù…Ù† Ø§Ù„Ù€View (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø¨Ø¹Ø¯ ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ #}
            <div
              id="id_recipients"
              class="recipients-box"
              aria-label="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªÙ„Ù…ÙŠÙ†"
              {% if selected_recipient_ids %}
                data-selected="{% for rid in selected_recipient_ids %}{{ rid }}{% if not forloop.last %},{% endif %}{% endfor %}"
              {% endif %}
            ></div>

            <div class="help" id="recipientsHelp">Ø§Ø®ØªØ± Ù…Ø³ØªÙ„Ù…Ù‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.</div>
            {% for e in form.recipients.errors %}<div class="field-error">â€¢ {{ e }}</div>{% endfor %}
          </div>
        </div>

        <div class="form-group">
          <label for="{{ form.title.id_for_label }}">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø·Ù„Ø¨ <span aria-hidden="true" style="color:#ef4444">*</span></label>
          {{ form.title }}
          {% for e in form.title.errors %}<div class="field-error">â€¢ {{ e }}</div>{% endfor %}
        </div>

        <div class="form-group">
          <label for="{{ form.body.id_for_label }}">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</label>
          {{ form.body }}
          {% for e in form.body.errors %}<div class="field-error">â€¢ {{ e }}</div>{% endfor %}
          <div class="help">Ø§ÙƒØªØ¨ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø¨Ø´ÙƒÙ„ ÙˆØ§Ø¶Ø­ØŒ ÙˆÙŠÙ…ÙƒÙ† Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ± Ù„ØªÙˆØ¶ÙŠØ­ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©.</div>
        </div>

        <div class="form-group">
          <label for="id_images">Ø§Ù„ØµÙˆØ± (Ø­ØªÙ‰ 4)</label>
          <input id="id_images" name="images" type="file" accept="image/*" capture="environment" multiple>
          <div class="help">Ø§Ù„Ù…Ø³Ù…ÙˆØ­: JPG / PNG / WebP â€” Ø³ÙŠØªÙ… Ø¶ØºØ· Ø§Ù„ØµÙˆØ± ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 4 ØµÙˆØ±.</div>

          {# Ø¹Ø±Ø¶ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„ØµÙˆØ± Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù† Ø­ØªÙ‰ Ù„Ùˆ Ø§Ù„Ø­Ù‚Ù„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù€Form #}
          {% if form.errors %}
            {% if 'images' in form.errors %}
              <div class="field-error" style="margin-top:8px">â€¢ {{ form.errors.images.0 }}</div>
            {% endif %}
          {% endif %}

          <div class="previews" id="previews"></div>
        </div>

        <div id="dynamic-msg" class="help" aria-live="polite"></div>

        <div class="form-actions">
          <button class="btn btn-accent" type="submit" id="submitBtn">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
          <a class="btn btn-outline" href="{% url 'reports:my_requests' %}">Ø¹Ø±Ø¶ Ø·Ù„Ø¨Ø§ØªÙŠ</a>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script nonce="{{ CSP_NONCE }}">
(function(){
  const form = document.getElementById('ticket-form');
  const dept = document.getElementById('{{ form.department.id_for_label }}');
  const recipientsBox = document.getElementById('id_recipients');
  const msg = document.getElementById('dynamic-msg');
  const input = document.getElementById('id_images');
  const previews = document.getElementById('previews');
  const submitBtn = document.getElementById('submitBtn');

  const MAX_FILES = 4;
  const MAX_FILE_MB = 6; // Ù‚Ø¨Ù„ Ø§Ù„Ø¶ØºØ·
  const MAX_FILE_BYTES = MAX_FILE_MB * 1024 * 1024;

  const CSRF = (window.getCsrfToken ? window.getCsrfToken() : (window.csrfToken || ''));

  function setMsg(text, type){
    if(!msg) return;
    msg.textContent = text || '';
    if(type === 'error') msg.style.color = '#b91c1c';
    else if(type === 'ok') msg.style.color = '#065f46';
    else msg.style.color = '';
  }

  function setLoading(isLoading, text){
    if(submitBtn){
      submitBtn.disabled = !!isLoading;
      submitBtn.setAttribute('aria-busy', isLoading ? 'true' : 'false');
    }
    if(isLoading) setMsg(text || '...Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©');
  }

  function setRecipientsDisabled(disabled){
    if(!recipientsBox) return;
    recipientsBox.dataset.disabled = disabled ? '1' : '0';
    if(disabled){
      recipientsBox.innerHTML = '';
    }
  }

  function parseSelectedIds(){
    if(!recipientsBox) return [];
    const raw = recipientsBox.getAttribute('data-selected') || '';
    if(!raw) return [];
    return raw.split(',').map(s => (s || '').trim()).filter(Boolean);
  }

  function getSelectedRecipientIds(){
    if(!recipientsBox) return [];
    return Array.from(recipientsBox.querySelectorAll('input[type="checkbox"][name="recipients"]:checked'))
      .map(el => String(el.value));
  }

  function updateRecipientsSummary(){
    if(!recipientsBox) return;
    const details = recipientsBox.querySelector('details.recipients-dd');
    if(!details) return;

    const countEl = details.querySelector('.recipients-dd-title .count');
    const txtEl = details.querySelector('.recipients-dd-title .txt');
    if(!countEl || !txtEl) return;

    const selected = Array.from(details.querySelectorAll('input[type="checkbox"][name="recipients"]:checked'));
    const n = selected.length;

    if(n === 0){
      txtEl.textContent = 'Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙ„Ù…ÙŠÙ†';
      countEl.textContent = 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
      return;
    }

    if(n === 1){
      const label = selected[0].closest('label');
      const name = label ? (label.textContent || '').trim() : '';
      txtEl.textContent = name || 'ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ø³ØªÙ„Ù…';
      countEl.textContent = '1 Ù…Ø®ØªØ§Ø±';
      return;
    }

    txtEl.textContent = 'ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ø³ØªÙ„Ù…ÙŠÙ†';
    countEl.textContent = n + ' Ù…Ø®ØªØ§Ø±';
  }

  function renderRecipients(list){
    if(!recipientsBox) return;

    if(!Array.isArray(list) || list.length === 0){
      recipientsBox.innerHTML = '<div class="help">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙˆÙ† Ù„Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…</div>';
      return;
    }

    recipientsBox.innerHTML = '';

    const details = document.createElement('details');
    details.className = 'recipients-dd';
    details.open = false;

    const summary = document.createElement('summary');

    const title = document.createElement('div');
    title.className = 'recipients-dd-title';
    title.innerHTML = '<span class="txt">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙ„Ù…ÙŠÙ†</span><span class="count">ØºÙŠØ± Ù…Ø­Ø¯Ø¯</span>';

    const caret = document.createElement('span');
    caret.className = 'recipients-dd-caret';
    caret.textContent = 'â–¾';

    summary.appendChild(title);
    summary.appendChild(caret);

    const panel = document.createElement('div');
    panel.className = 'recipients-panel';

    const searchInput = document.createElement('input');
    searchInput.type = 'text';
    searchInput.placeholder = 'Ø¨Ø­Ø« Ø¹Ù† Ù…ÙˆØ¸Ù...';
    searchInput.className = 'recipients-search';

    const scroll = document.createElement('div');
    scroll.className = 'recipients-scroll';

    const grid = document.createElement('div');
    grid.className = 'recipients-grid';

    // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø¥Ù† ØªÙˆÙØ± (Ø¨Ø¹Ø¯ ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù…Ø«Ù„Ø§Ù‹)
    const preSelected = new Set(parseSelectedIds());

    let searchTimer = null;
    searchInput.addEventListener('input', (e) => {
      const val = (e.target.value || '').toLowerCase();
      if(searchTimer) window.clearTimeout(searchTimer);
      searchTimer = window.setTimeout(() => {
        const labels = grid.querySelectorAll('.rcpt');
        labels.forEach(lbl => {
          const name = (lbl.textContent || '').toLowerCase();
          lbl.style.display = name.includes(val) ? 'flex' : 'none';
        });
      }, 60);
    });

    list.forEach(u => {
      const label = document.createElement('label');
      label.className = 'rcpt';

      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.name = 'recipients';
      cb.value = String(u.id);

      // restore
      if(preSelected.has(String(u.id))){
        cb.checked = true;
        label.classList.add('selected');
      }

      cb.addEventListener('change', () => {
        if(cb.checked) label.classList.add('selected');
        else label.classList.remove('selected');
        updateRecipientsSummary();
      });

      const text = document.createElement('span');
      text.textContent = u.name;

      label.appendChild(cb);
      label.appendChild(text);
      grid.appendChild(label);
    });

    scroll.appendChild(grid);
    panel.appendChild(searchInput);
    panel.appendChild(scroll);

    details.appendChild(summary);
    details.appendChild(panel);

    recipientsBox.appendChild(details);

    updateRecipientsSummary();
  }

  async function loadMembers(deptSlug){
    if(!recipientsBox) return;

    setRecipientsDisabled(true);
    setMsg('...Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†');

    try{
      const baseUrl = "{% url 'reports:api_department_members' %}";
      const url = baseUrl + "?department=" + encodeURIComponent(deptSlug);

      const res = await fetch(url, {
        method: 'GET',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': CSRF
        },
        credentials: 'same-origin'
      });

      if(!res.ok) throw new Error('HTTP ' + res.status);

      const data = await res.json();
      const list = Array.isArray(data.results) ? data.results : [];

      renderRecipients(list);
      setRecipientsDisabled(false);

      // Ù„Ùˆ ÙÙŠÙ‡ Ù…ÙˆØ¸Ù ÙˆØ§Ø­Ø¯: Ù†Ø®ØªØ§Ø±Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ (Ù…Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ ØªØ­Ø¯ÙŠØ¯ Ù…ÙØ³Ø¨Ù‚)
      const preSelected = parseSelectedIds();
      if(list.length === 1 && preSelected.length === 0){
        const first = recipientsBox.querySelector('input[type="checkbox"][name="recipients"]');
        if(first){
          first.checked = true;
          const lbl = first.closest('label');
          if(lbl) lbl.classList.add('selected');
        }
        updateRecipientsSummary();
        setMsg('ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ¸Ù ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù„Ø£Ù† Ø§Ù„Ù‚Ø³Ù… ÙŠØ­ØªÙˆÙŠ Ù…ÙˆØ¸ÙÙ‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§', 'ok');
        return;
      }

      if(list.length){
        setMsg('ØªÙ… ØªØ­Ù…ÙŠÙ„ ' + list.length + ' Ù…ÙˆØ¸Ù. Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙ„Ù…ÙŠÙ† Ø«Ù… Ø£Ø±Ø³Ù„ Ø§Ù„Ø·Ù„Ø¨.', 'ok');
      } else {
        setMsg('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙˆÙ† Ù„Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…');
      }

    } catch(err){
      console.error(err);
      setMsg('ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†. Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ù‹Ø§.', 'error');
      setRecipientsDisabled(true);
    }
  }

  // ØªØºÙŠÙŠØ± Ø§Ù„Ù‚Ø³Ù…
  if(dept && recipientsBox){
    dept.addEventListener('change', (e) => {
      const slug = (e.target.value || '').trim();
      // Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù‚Ø³Ù…: Ù†Ù„ØºÙŠ Ø£ÙŠ data-selected Ù‚Ø¯ÙŠÙ… Ø­ØªÙ‰ Ù„Ø§ ÙŠÙØ¹Ø§Ø¯ ØªØ·Ø¨ÙŠÙ‚Ù‡ Ø¹Ù„Ù‰ Ù‚Ø³Ù… Ø¢Ø®Ø±
      recipientsBox.removeAttribute('data-selected');

      if(!slug){
        setRecipientsDisabled(true);
        setMsg('Ø§Ø®ØªØ± Ù‚Ø³Ù…Ù‹Ø§ Ø£ÙˆÙ„Ø§Ù‹');
        return;
      }
      loadMembers(slug);
    });

    // Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©: Ù„Ùˆ ÙÙŠÙ‡ Ù‚ÙŠÙ…Ø© Ù…Ø³Ø¨Ù‚Ø©
    {% if form.is_bound %}
      if(dept.value){
        loadMembers(dept.value);
        setMsg('ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù‚ÙŠÙ… Ù…Ù† Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©', 'ok');
      } else {
        setRecipientsDisabled(true);
        setMsg('Ø§Ø®ØªØ± Ù‚Ø³Ù…Ù‹Ø§ Ø£ÙˆÙ„Ø§Ù‹');
      }
    {% else %}
      if(dept.value){ loadMembers(dept.value); }
      else { setRecipientsDisabled(true); setMsg('Ø§Ø®ØªØ± Ù‚Ø³Ù…Ù‹Ø§ Ø£ÙˆÙ„Ø§Ù‹'); }
    {% endif %}
  }

  function clearPreviews(){
    if(previews) previews.innerHTML = '';
  }

  function renderPreviews(files){
    clearPreviews();
    files.forEach((f, idx) => {
      const url = URL.createObjectURL(f);
      const box = document.createElement('div');
      box.className = 'thumb';
      box.innerHTML = '<span class="badge">#' + (idx + 1) + '</span><img src="' + url + '" alt="preview">';
      previews.appendChild(box);

      const img = box.querySelector('img');
      if(img){
        img.addEventListener('load', () => {
          try{ URL.revokeObjectURL(url); }catch(e){}
        }, {once:true});
      }
    });
  }

  function validateFiles(files){
    if(files.length > MAX_FILES){
      setMsg('ÙŠÙ…ÙƒÙ† Ø±ÙØ¹ ' + MAX_FILES + ' ØµÙˆØ± ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰.', 'error');
      return false;
    }

    for(const f of files){
      const name = (f.name || '').toLowerCase();
      const type = (f.type || '').toLowerCase();

      const isImage = type.startsWith('image/');
      const okExt = name.endsWith('.jpg') || name.endsWith('.jpeg') || name.endsWith('.png') || name.endsWith('.webp');

      if(!isImage){
        setMsg('Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† ØµÙˆØ±Ù‹Ø§ ÙÙ‚Ø·.', 'error');
        return false;
      }
      if(!okExt){
        setMsg('ÙŠÙØ³Ù…Ø­ ÙÙ‚Ø· Ø¨ØµÙˆØ± JPG/PNG/WebP.', 'error');
        return false;
      }
      if(f.size > MAX_FILE_BYTES){
        setMsg('Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ±. Ø§Ù„Ø­Ø¯ Ù‚Ø¨Ù„ Ø§Ù„Ø¶ØºØ·: ' + MAX_FILE_MB + 'MB Ù„ÙƒÙ„ ØµÙˆØ±Ø©.', 'error');
        return false;
      }
    }
    return true;
  }

  if(input){
    input.addEventListener('change', () => {
      setMsg('');
      const files = Array.from(input.files || []);
      if(!files.length){ clearPreviews(); return; }
      if(!validateFiles(files)){ input.value=''; clearPreviews(); return; }
      renderPreviews(files);
    });
  }

  async function compressImage(file, opts){
    const maxW = opts.maxW || 1600;
    const maxH = opts.maxH || 1600;
    const quality = typeof opts.quality === 'number' ? opts.quality : 0.82;
    const format = opts.format || 'image/webp';

    const img = document.createElement('img');
    const src = URL.createObjectURL(file);

    await new Promise((res, rej) => {
      img.onload = res;
      img.onerror = rej;
      img.src = src;
    });

    const w = img.naturalWidth || 1;
    const h = img.naturalHeight || 1;
    const r = Math.min(maxW / w, maxH / h, 1);

    const tw = Math.max(1, Math.round(w * r));
    const th = Math.max(1, Math.round(h * r));

    const canvas = document.createElement('canvas');
    canvas.width = tw;
    canvas.height = th;

    const ctx = canvas.getContext('2d');
    if(!ctx){
      try{ URL.revokeObjectURL(src); }catch(e){}
      return file;
    }

    ctx.drawImage(img, 0, 0, tw, th);

    const blob = await new Promise(resolve => {
      try{
        canvas.toBlob(resolve, format, quality);
      }catch(e){
        resolve(null);
      }
    });

    try{ URL.revokeObjectURL(src); }catch(e){}

    if(!blob) return file;

    const ext = blob.type === 'image/webp' ? '.webp' : '.jpg';
    const base = (file.name || 'image').replace(/\.\w+$/, '');
    return new File([blob], base + ext, { type: blob.type });
  }

  async function replaceWithCompressed(files){
    const dt = new DataTransfer();

    for(const f of files){
      const c1 = await compressImage(f, { maxW:1600, maxH:1600, quality:0.82, format:'image/webp' });

      if(c1.size > 1.2 * 1024 * 1024){
        const c2 = await compressImage(f, { maxW:1600, maxH:1600, quality:0.70, format:'image/webp' });
        dt.items.add(c2);
      } else {
        dt.items.add(c1);
      }
    }

    input.files = dt.files;
  }

  if(form){
    form.addEventListener('submit', async (e) => {
      // ØªØ­Ù‚Ù‚ Ø³Ø±ÙŠØ¹ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
      if(dept && !dept.value){
        e.preventDefault();
        setMsg('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø³Ù….', 'error');
        dept.focus();
        return;
      }

      if(recipientsBox && recipientsBox.dataset.disabled === '1'){
        e.preventDefault();
        setMsg('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†.', 'error');
        return;
      }

      if(recipientsBox && getSelectedRecipientIds().length === 0){
        e.preventDefault();
        setMsg('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø³ØªÙ„Ù… ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.', 'error');
        recipientsBox.scrollIntoView({behavior:'smooth', block:'center'});
        return;
      }

      // Ø¶ØºØ· Ø§Ù„ØµÙˆØ± Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
      if(input){
        const files = Array.from(input.files || []);
        if(files.length){
          if(!validateFiles(files)){
            e.preventDefault();
            return;
          }

          e.preventDefault();
          setLoading(true, '...Ø¬Ø§Ø±ÙŠ Ø¶ØºØ· Ø§Ù„ØµÙˆØ±');

          try{
            await replaceWithCompressed(files);
            setLoading(false, '');
            form.submit();
          }catch(err){
            console.error(err);
            setLoading(false, '');
            setMsg('ØªØ¹Ø°Ø± Ø¶ØºØ· Ø§Ù„ØµÙˆØ±. Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ù‹Ø§ Ø£Ùˆ Ø§Ø±ÙØ¹ ØµÙˆØ±Ù‹Ø§ Ø£ØµØºØ±.', 'error');
          }
        }
      }
    });
  }
})();
</script>
{% endblock %}
