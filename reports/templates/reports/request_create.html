{% extends "base.html" %}
{% load static %}
{% block title %}Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯{% endblock %}

{% block head %}
<style>
  .ticket-page{
    --ink:#0f172a;--ink-soft:#1f2937;--muted:#64748b;--line:#e5e7eb;
    --brand:#2563eb;--brand-light:#3b82f6;--accent:#059669;--accent-light:#10b981;
    --card:#fff;--bg:#f8fafc;--error:#ef4444;--error-bg:#fef2f2;
    --radius:16px;--rsm:10px;--shadow:0 6px 20px rgba(2,6,23,.08);--t:all .2s ease;
  }
  .ticket-page .ticket-container{max-width:900px;margin:0 auto;padding:18px}
  .ticket-page .ticket-card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:22px}
  .ticket-page .section-title{font-size:1.35rem;font-weight:900;color:var(--ink-soft);display:flex;gap:10px;align-items:center;margin:0 0 16px}

  .ticket-page .form-grid{display:grid;gap:18px}
  .ticket-page .form-row{display:grid;gap:16px}
  @media(min-width:720px){ .ticket-page .form-row{grid-template-columns:1fr 1fr} }

  .ticket-page .form-group{display:flex;flex-direction:column;gap:8px}
  .ticket-page label{font-weight:800;color:var(--ink-soft)}
  .ticket-page input[type="text"], .ticket-page select, .ticket-page textarea{
    width:100%;padding:14px 16px;border:1px solid var(--line);border-radius:var(--rsm);font:inherit;background:#fff;transition:var(--t)
  }
  .ticket-page select:disabled{background:#f3f4f6;color:#9ca3af;cursor:not-allowed}
  .ticket-page input:focus,.ticket-page select:focus,.ticket-page textarea:focus{outline:none;border-color:var(--brand-light);box-shadow:0 0 0 3px rgba(59,130,246,.15)}
  .ticket-page textarea{min-height:140px;resize:vertical}
  .ticket-page .help{font-size:.9rem;color:var(--muted);font-weight:850;line-height:1.45}
  .ticket-page .field-error{color:var(--error);background:var(--error-bg);border:1px solid #fecaca;padding:10px 12px;border-radius:var(--rsm);font-size:.92rem;font-weight:900}

  /* Ù…Ø¹Ø§ÙŠÙ†Ø§Øª Ø§Ù„ØµÙˆØ± */
  .ticket-page .previews{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px;margin-top:8px}
  .ticket-page .thumb{position:relative;border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#fff}
  .ticket-page .thumb img{display:block;width:100%;height:100%;object-fit:cover;aspect-ratio:4/3}
  .ticket-page .thumb .badge{position:absolute;top:6px;left:6px;background:rgba(15,23,42,.75);color:#fff;font-size:.78rem;padding:2px 6px;border-radius:999px}

  .ticket-page .form-actions{display:grid;gap:12px}
  @media(min-width:560px){ .ticket-page .form-actions{grid-template-columns:1fr 1fr} }
  .ticket-page .btn{padding:14px 18px;border:0;border-radius:12px;font-weight:900;cursor:pointer;transition:var(--t);display:inline-flex;justify-content:center;align-items:center;gap:8px;text-decoration:none}
  .ticket-page .btn-accent{background:linear-gradient(135deg,var(--accent),var(--accent-light));color:#fff}
  .ticket-page .btn-accent:hover{transform:translateY(-2px)}
  .ticket-page .btn-outline{background:#fff;border:1px solid var(--line);color:var(--ink-soft)}
  .ticket-page .btn-outline:hover{background:#f8fafc}

  .ticket-page #dynamic-msg{min-height:22px}

  @media(max-width:520px){
    .ticket-page .ticket-container{padding:14px 12px}
    .ticket-page .ticket-card{padding:16px}
    .ticket-page .section-title{font-size:1.18rem}
    .ticket-page input[type="text"], .ticket-page select, .ticket-page textarea{font-size:16px}
    .ticket-page .form-actions{grid-template-columns:1fr}
    .ticket-page .btn{width:100%}
  }
</style>
{% endblock %}

{% block content %}
<div class="ticket-page" dir="rtl">
  <div class="ticket-container">
    <div class="ticket-card">
      <h2 class="section-title">ğŸ“ Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</h2>

      {% if form.non_field_errors %}
        <div class="field-error" style="margin-bottom:12px">
          {% for e in form.non_field_errors %}â€¢ {{ e }}<br>{% endfor %}
        </div>
      {% endif %}

      <form method="post" enctype="multipart/form-data" class="form-grid" id="ticket-form" novalidate>
        {% csrf_token %}

        <div class="form-row">
          <div class="form-group">
            <label for="{{ form.department.id_for_label }}">Ø§Ù„Ù‚Ø³Ù… <span aria-hidden="true" style="color:#ef4444">*</span></label>
            <select id="{{ form.department.id_for_label }}" name="{{ form.department.html_name }}" required>
              <option value="" selected hidden>â€” Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… â€”</option>
              {% for d in form.fields.department.queryset %}
                {% with v=d.slug %}
                  <option value="{{ v }}"
                    {% if form.is_bound %}
                      {% if form.data.department == v %}selected{% endif %}
                    {% else %}
                      {% if form.initial.department == v %}selected{% endif %}
                    {% endif %}
                  >{{ d.name }}</option>
                {% endwith %}
              {% endfor %}
            </select>
            {% for e in form.department.errors %}<div class="field-error">â€¢ {{ e }}</div>{% endfor %}
          </div>

          <div class="form-group">
            <label for="{{ form.assignee.id_for_label }}">Ø§Ù„Ù…Ø³ØªÙ„Ù… <span aria-hidden="true" style="color:#ef4444">*</span></label>
            <select id="{{ form.assignee.id_for_label }}" name="{{ form.assignee.html_name }}" required disabled>
              <option value="" selected>â€” Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸Ù â€”</option>

              {% if form.is_bound and form.fields.assignee.queryset %}
                {% for u in form.fields.assignee.queryset %}
                  <option value="{{ u.pk }}"
                    {% if form.data.assignee|stringformat:"s" == u.pk|stringformat:"s" %}selected{% endif %}
                  >{{ u.name }}</option>
                {% endfor %}
              {% endif %}
            </select>
            <div class="help">Ø³ÙŠØ¸Ù‡Ø± Ø§Ù„Ù…ÙˆØ¸ÙÙˆÙ† Ø¨Ø¹Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø³Ù…. Ø¥Ù† ÙˆÙØ¬Ø¯ Ù…ÙˆØ¸Ù ÙˆØ§Ø­Ø¯ Ø³ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø±Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.</div>
            {% for e in form.assignee.errors %}<div class="field-error">â€¢ {{ e }}</div>{% endfor %}
          </div>
        </div>

        <div class="form-group">
          <label for="{{ form.title.id_for_label }}">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø·Ù„Ø¨ <span aria-hidden="true" style="color:#ef4444">*</span></label>
          {{ form.title }}
          {% for e in form.title.errors %}<div class="field-error">â€¢ {{ e }}</div>{% endfor %}
        </div>

        <div class="form-group">
          <label for="{{ form.body.id_for_label }}">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</label>
          {{ form.body }}
          {% for e in form.body.errors %}<div class="field-error">â€¢ {{ e }}</div>{% endfor %}
        </div>

        <div class="form-group">
          <label for="id_images">Ø§Ù„ØµÙˆØ± (Ø­ØªÙ‰ 4)</label>
          <input id="id_images" name="images" type="file" accept="image/*" multiple>
          <div class="help">Ø§Ù„Ù…Ø³Ù…ÙˆØ­: JPG / PNG / WebP â€” Ø³ÙŠØªÙ… Ø¶ØºØ· Ø§Ù„ØµÙˆØ± ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 4 ØµÙˆØ±.</div>

          {# Ø¹Ø±Ø¶ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„ØµÙˆØ± Ø¨Ø´ÙƒÙ„ Ø¢Ù…Ù† Ø­ØªÙ‰ Ù„Ùˆ Ø§Ù„Ø­Ù‚Ù„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù€Form #}
          {% if form.errors %}
            {% if 'images' in form.errors %}
              <div class="field-error" style="margin-top:8px">â€¢ {{ form.errors.images.0 }}</div>
            {% endif %}
          {% endif %}

          <div class="previews" id="previews"></div>
        </div>

        <div id="dynamic-msg" class="help" aria-live="polite"></div>

        <div class="form-actions">
          <button class="btn btn-accent" type="submit">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
          <a class="btn btn-outline" href="{% url 'reports:my_requests' %}">Ø¹Ø±Ø¶ Ø·Ù„Ø¨Ø§ØªÙŠ</a>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
(function(){
  const form = document.getElementById('ticket-form');
  const dept = document.getElementById('{{ form.department.id_for_label }}');
  const assignee = document.getElementById('{{ form.assignee.id_for_label }}');
  const msg = document.getElementById('dynamic-msg');
  const input = document.getElementById('id_images');
  const previews = document.getElementById('previews');

  const MAX_FILES = 4;
  const MAX_FILE_MB = 6; // Ù‚Ø¨Ù„ Ø§Ù„Ø¶ØºØ·
  const MAX_FILE_BYTES = MAX_FILE_MB * 1024 * 1024;

  function getCookie(name){
    const v = `; ${document.cookie}`.split(`; ${name}=`);
    if (v.length===2) return decodeURIComponent(v.pop().split(';').shift());
  }
  const CSRF = window.csrfToken || getCookie('csrftoken') || '';

  function setMsg(text, type){
    if(!msg) return;
    msg.textContent = text || '';
    if(type === 'error') msg.style.color = '#b91c1c';
    if(type === 'ok') msg.style.color = '#065f46';
    if(!type) msg.style.color = '#64748b';
  }

  function setAssigneeDisabled(disabled){
    if(!assignee) return;
    assignee.disabled = !!disabled;
    if(disabled){
      assignee.innerHTML = '<option value="" selected>â€” Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸Ù â€”</option>';
    }
  }

  async function loadMembers(deptSlug){
    if(!assignee) return;
    setAssigneeDisabled(true);
    setMsg('...Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†');

    try{
      const baseUrl = "{% url 'reports:api_department_members' %}";
      const url = baseUrl + "?department=" + encodeURIComponent(deptSlug);

      const res = await fetch(url, {
        method: 'GET',
        headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': CSRF },
        credentials: 'same-origin'
      });

      if(!res.ok) throw new Error('HTTP ' + res.status);
      const data = await res.json();

      const list = Array.isArray(data.results) ? data.results : [];
      assignee.innerHTML = '<option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸Ù â€”</option>';

      list.forEach(u=>{
        const opt = document.createElement('option');
        opt.value = String(u.id);
        opt.textContent = u.name;
        assignee.appendChild(opt);
      });

      setAssigneeDisabled(false);

      if(list.length === 1){
        assignee.value = String(list[0].id);
        setMsg('ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ¸Ù ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù„Ø£Ù† Ø§Ù„Ù‚Ø³Ù… ÙŠØ­ØªÙˆÙŠ Ù…ÙˆØ¸ÙÙ‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§', 'ok');
        return;
      }

      if(list.length){
        setMsg('ØªÙ… ØªØ­Ù…ÙŠÙ„ ' + list.length + ' Ù…ÙˆØ¸Ù', 'ok');
      } else {
        setMsg('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙˆÙ† Ù„Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…');
      }
    } catch(err){
      console.error(err);
      setMsg('ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†. Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ù‹Ø§.', 'error');
      setAssigneeDisabled(true);
    }
  }

  // ØªØºÙŠÙŠØ± Ø§Ù„Ù‚Ø³Ù…
  if(dept && assignee){
    dept.addEventListener('change', (e)=>{
      const slug = (e.target.value || '').trim();
      if(!slug){
        setAssigneeDisabled(true);
        setMsg('Ø§Ø®ØªØ± Ù‚Ø³Ù…Ù‹Ø§ Ø£ÙˆÙ„Ø§Ù‹');
        return;
      }
      loadMembers(slug);
    });

    // Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©: Ù„Ùˆ ÙÙŠ Ù‚ÙŠÙ…Ø© Ù…Ø³Ø¨Ù‚Ø©
    {% if form.is_bound and form.fields.assignee.queryset %}
      setAssigneeDisabled(false);
      setMsg('ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù‚ÙŠÙ… Ù…Ù† Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©', 'ok');
    {% else %}
      if(dept.value){ loadMembers(dept.value); }
      else { setAssigneeDisabled(true); }
    {% endif %}
  }

  function clearPreviews(){
    if(previews) previews.innerHTML = '';
  }

  function renderPreviews(files){
    clearPreviews();
    files.forEach((f, idx) => {
      const url = URL.createObjectURL(f);
      const box = document.createElement('div');
      box.className = 'thumb';
      box.innerHTML = '<span class="badge">#' + (idx+1) + '</span><img src="' + url + '" alt="preview">';
      previews.appendChild(box);
      box.querySelector('img').addEventListener('load', ()=>URL.revokeObjectURL(url), {once:true});
    });
  }

  function validateFiles(files){
    if(files.length > MAX_FILES){
      setMsg('ÙŠÙ…ÙƒÙ† Ø±ÙØ¹ ' + MAX_FILES + ' ØµÙˆØ± ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰.', 'error');
      return false;
    }

    for(const f of files){
      const name = (f.name || '').toLowerCase();
      const type = (f.type || '').toLowerCase();

      const isImage = type.startsWith('image/');
      const okExt = name.endsWith('.jpg') || name.endsWith('.jpeg') || name.endsWith('.png') || name.endsWith('.webp');

      if(!isImage){
        setMsg('Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† ØµÙˆØ±Ù‹Ø§ ÙÙ‚Ø·.', 'error');
        return false;
      }
      if(!okExt){
        setMsg('ÙŠÙØ³Ù…Ø­ ÙÙ‚Ø· Ø¨ØµÙˆØ± JPG/PNG/WebP.', 'error');
        return false;
      }
      if(f.size > MAX_FILE_BYTES){
        setMsg('Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ±. Ø§Ù„Ø­Ø¯ Ù‚Ø¨Ù„ Ø§Ù„Ø¶ØºØ·: ' + MAX_FILE_MB + 'MB Ù„ÙƒÙ„ ØµÙˆØ±Ø©.', 'error');
        return false;
      }
    }

    return true;
  }

  if(input){
    input.addEventListener('change', ()=>{
      setMsg('');
      const files = Array.from(input.files || []);
      if(!files.length){ clearPreviews(); return; }
      if(!validateFiles(files)){ input.value=''; clearPreviews(); return; }
      renderPreviews(files);
    });
  }

  async function compressImage(file, opts){
    const maxW = opts.maxW || 1600;
    const maxH = opts.maxH || 1600;
    const quality = opts.quality || 0.82;
    const format = opts.format || 'image/webp';

    const img = document.createElement('img');
    const src = URL.createObjectURL(file);

    await new Promise((res, rej)=>{
      img.onload = res;
      img.onerror = rej;
      img.src = src;
    });

    const w = img.naturalWidth || 1;
    const h = img.naturalHeight || 1;
    const r = Math.min(maxW / w, maxH / h, 1);

    const tw = Math.max(1, Math.round(w * r));
    const th = Math.max(1, Math.round(h * r));

    const canvas = document.createElement('canvas');
    canvas.width = tw;
    canvas.height = th;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0, tw, th);

    const blob = await new Promise(resolve => canvas.toBlob(resolve, format, quality));
    URL.revokeObjectURL(src);

    if(!blob) return file;

    const ext = blob.type === 'image/webp' ? '.webp' : '.jpg';
    const base = (file.name || 'image').replace(/\.\w+$/, '');
    return new File([blob], base + ext, {type: blob.type});
  }

  async function replaceWithCompressed(files){
    const dt = new DataTransfer();
    for(const f of files){
      const c1 = await compressImage(f, {maxW:1600, maxH:1600, quality:0.82, format:'image/webp'});
      if(c1.size > 1.2 * 1024 * 1024){
        const c2 = await compressImage(f, {maxW:1600, maxH:1600, quality:0.70, format:'image/webp'});
        dt.items.add(c2);
      } else {
        dt.items.add(c1);
      }
    }
    input.files = dt.files;
  }

  form.addEventListener('submit', async (e)=>{
    if(dept && !dept.value){
      e.preventDefault();
      setMsg('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø³Ù….', 'error');
      dept.focus();
      return;
    }
    if(assignee && assignee.disabled){
      e.preventDefault();
      setMsg('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†.', 'error');
      return;
    }
    if(assignee && !assignee.value){
      e.preventDefault();
      setMsg('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ¸Ù.', 'error');
      assignee.focus();
      return;
    }

    if(input){
      const files = Array.from(input.files || []);
      if(files.length){
        if(!validateFiles(files)){
          e.preventDefault();
          return;
        }
        e.preventDefault();
        setMsg('...Ø¬Ø§Ø±ÙŠ Ø¶ØºØ· Ø§Ù„ØµÙˆØ±');
        try{
          await replaceWithCompressed(files);
          setMsg('');
          form.submit();
        }catch(err){
          console.error(err);
          setMsg('ØªØ¹Ø°Ø± Ø¶ØºØ· Ø§Ù„ØµÙˆØ±. Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ù‹Ø§ Ø£Ùˆ Ø§Ø±ÙØ¹ ØµÙˆØ±Ù‹Ø§ Ø£ØµØºØ±.', 'error');
        }
      }
    }
  });
})();
</script>
{% endblock %}
