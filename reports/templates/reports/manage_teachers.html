{# templates/reports/manage_teachers.html #}
{% extends "base.html" %}
{% block title %}إدارة المعلمين{% endblock %}

{% block content %}
<div class="admin-scope" dir="rtl">
  <div class="admin-container">
    <div class="admin-header">
      <div class="header-content">
        <h1 class="admin-title">
          <i class="fas fa-chalkboard-teacher"></i>
          إدارة المعلمين
        </h1>
        <p class="admin-subtitle">عرض وإدارة جميع المعلمين في النظام</p>
      </div>

      <div class="header-actions">
        <form method="get" action="" class="search-form" role="search">
          <label class="sr-only" for="q">بحث</label>
          <input id="q" type="search" name="q" value="{{ term }}" placeholder="بحث: الاسم/الجوال/الهوية" autocomplete="off" spellcheck="false">
          <button class="btn btn-primary" type="submit">بحث</button>
        </form>

        <a class="btn btn-outline-primary btn-add" href="{% url 'reports:bulk_import_teachers' %}">
          <i class="fas fa-file-excel"></i>
          استيراد جماعي
        </a>

        <a class="btn btn-primary btn-add" href="{% url 'reports:add_teacher' %}">
          <i class="fas fa-plus-circle"></i>
          إضافة معلم جديد
        </a>
      </div>
    </div>

    <div class="admin-card">
      {% if teachers_page and teachers_page.object_list %}
        <div class="meta-bar">
          <div class="muted">
            العدد المعروض: <b id="rowsCount">{{ teachers_page.object_list|length }}</b>
          </div>
          <div class="muted">
            الإجمالي: <b>{{ teachers_page.paginator.count }}</b>
          </div>
        </div>

        <div class="table-responsive" role="region" aria-label="جدول المعلمين">
          <table class="teachers-table">
            <thead>
              <tr>
                <th class="text-right">المعلم</th>
                <th class="text-right">رقم الهوية</th>
                <th class="text-right">رقم الجوال</th>
                <th class="text-center">القسم / الدور</th>
                <th class="text-center">الحالة</th>
                <th class="text-center">الإجراءات</th>
              </tr>
            </thead>
            <tbody>
              {% for t in teachers_page.object_list %}
              <tr>
                <td data-label="المعلم">
                  <div class="teacher-info">
                    <div class="teacher-avatar" aria-hidden="true"><i class="fas fa-user"></i></div>
                    <div class="teacher-details">
                      <div class="teacher-name">{{ t.name }}</div>
                      <div class="teacher-sub muted">
                        {% if t.phone %}{{ t.phone }}{% endif %}
                      </div>
                    </div>
                  </div>
                </td>

                <td data-label="رقم الهوية">{{ t.national_id|default:"-" }}</td>
                <td data-label="رقم الجوال">{{ t.phone }}</td>

                {# ===== عمود القسم/الدور (بدون N+1 + بدون t.role.slug داخل القالب) ===== #}
                <td data-label="القسم / الدور" class="text-center">
                  {% with memberships=t.dept_memberships.all %}
                    {% if memberships %}
                      <div class="chips">
                        {% for m in memberships %}
                          {% with dep=m.department rt=m.role_type|stringformat:"s"|lower %}
                            <span class="chip chip-dept" data-slug="{{ dep.slug|default_if_none:''|lower }}">
                              <i class="fas fa-building"></i>
                              {{ dep.name|default:dep.slug }}
                              <span class="chip-role {% if rt == 'officer' or rt == '1' %}role-officer{% else %}role-employee{% endif %}">
                                {% if rt == 'officer' or rt == '1' %}
                                  <i class="fas fa-user-shield"></i> مسؤول
                                {% else %}
                                  <i class="fas fa-id-badge"></i> موظف
                                {% endif %}
                              </span>
                            </span>
                          {% endwith %}
                        {% endfor %}
                      </div>
                    {% else %}
                      {% with slug=t.role_slug|default_if_none:''|lower %}
                        {% if slug == 'manager' %}
                          <span class="chip chip-role role-manager"><i class="fas fa-crown"></i> مدير</span>
                        {% elif slug == 'teacher' %}
                          <span class="chip chip-role role-teacher"><i class="fas fa-user-graduate"></i> معلم</span>
                        {% elif slug %}
                          <span class="chip chip-dept" data-slug="{{ slug }}">
                            <i class="fas fa-building"></i>
                            {{ t.role_label|default:t.role_dept_name|default:slug }}
                            <span class="chip-role role-employee"><i class="fas fa-id-badge"></i> موظف</span>
                          </span>
                        {% else %}
                          <span class="badge-muted">—</span>
                        {% endif %}
                      {% endwith %}
                    {% endif %}
                  {% endwith %}
                </td>
                {# ===================================== #}

                <td data-label="الحالة" class="text-center">
                  {% if t.is_active %}
                    <span class="status-badge status-active"><i class="fas fa-check-circle"></i> نشط</span>
                  {% else %}
                    <span class="status-badge status-inactive"><i class="fas fa-times-circle"></i> معطل</span>
                  {% endif %}
                </td>

                <td data-label="الإجراءات" class="text-center">
                  {% with nxt=request.get_full_path %}
                    <div class="action-buttons">
                      <a href="{% url 'reports:edit_teacher' pk=t.id %}?next={{ nxt|urlencode }}"
                         class="btn btn-icon btn-edit" title="تعديل" aria-label="تعديل">
                        <i class="fas fa-edit"></i>
                      </a>

                      <form method="post"
                            action="{% url 'reports:delete_teacher' pk=t.id %}?next={{ nxt|urlencode }}"
                            style="display:inline">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-icon btn-delete" title="حذف" aria-label="حذف"
                                onclick="return confirm('هل أنت متأكد من حذف هذا المعلم؟')">
                          <i class="fas fa-trash-alt"></i>
                        </button>
                      </form>
                    </div>
                  {% endwith %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="pager">
          {% if teachers_page.has_previous %}
            <a class="btn btn-outline" href="?page={{ teachers_page.previous_page_number }}&q={{ term|urlencode }}">السابق</a>
          {% endif %}
          <span class="btn btn-outline">صفحة {{ teachers_page.number }} / {{ teachers_page.paginator.num_pages }}</span>
          {% if teachers_page.has_next %}
            <a class="btn btn-outline" href="?page={{ teachers_page.next_page_number }}&q={{ term|urlencode }}">التالي</a>
          {% endif %}
        </div>

      {% else %}
        <div class="empty-state">
          <div class="empty-icon"><i class="fas fa-users-slash"></i></div>
          <h3>لا يوجد معلمين</h3>
          <p>لم يتم العثور على نتائج{% if term %} لبحثك عن "<strong>{{ term }}</strong>"{% endif %}</p>
          <a href="{% url 'reports:add_teacher' %}" class="btn btn-primary">
            <i class="fas fa-plus"></i> إضافة معلم جديد
          </a>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<style>
  /* A11y */
  .sr-only{
    position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0
  }

  /* التنسيقات العامة */
  .admin-scope{--ink:#0f172a;--muted:#64748b;--line:#e2e8f0;--card:#ffffff;--bg:#f8fafc}
  .admin-container{padding:20px;max-width:1400px;margin:0 auto}
  .admin-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;flex-wrap:wrap;gap:16px}
  .header-content{flex:1}
  .admin-title{font-size:22px;font-weight:900;color:#1e293b;margin:0 0 6px;display:flex;align-items:center;gap:10px}
  .admin-subtitle{color:var(--muted);font-size:14px;margin:0}

  .header-actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .search-form{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .search-form input[type="search"]{
    padding:10px 14px;border:1px solid var(--line);border-radius:10px;min-width:240px;outline:none
  }
  .search-form input[type="search"]:focus{border-color:#2563eb;box-shadow:0 0 0 3px rgba(37,99,235,.12)}

  .admin-card{background:var(--card);border-radius:16px;box-shadow:0 4px 16px rgba(15,23,42,.06);padding:18px;overflow:hidden}

  .meta-bar{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:flex-end;margin-bottom:10px}
  .muted{color:var(--muted);font-weight:800}

  /* الأزرار (تعتمد على app.css أساسًا) */
  .btn-primary{background-color:#2563eb;color:#fff}
  .btn-primary:hover{background-color:#1d4ed8;transform:translateY(-1px);box-shadow:0 6px 18px rgba(37,99,235,.25)}
  .btn-add{padding:12px 20px;font-size:15px}
  .btn-outline{background:#fff;border:1px solid var(--line);color:#1e293b}
  .btn-outline:hover{background:#f8fafc}

  .btn-icon{padding:8px 12px;border-radius:8px}
  .btn-edit{background-color:#f59e0b;color:#fff}
  .btn-edit:hover{background-color:#d97706}
  .btn-delete{background-color:#ef4444;color:#fff}
  .btn-delete:hover{background-color:#dc2626}

  /* الجدول */
  .table-responsive{overflow-x:auto;border-radius:12px;border:1px solid var(--line)}
  .teachers-table{width:100%;border-collapse:collapse;min-width:920px}
  .teachers-table th{background-color:#f8fafc;padding:16px;font-weight:900;color:#475569;text-align:right;border-bottom:1px solid var(--line)}
  .teachers-table td{padding:16px;border-bottom:1px solid var(--line);color:#334155}
  .teachers-table tr:last-child td{border-bottom:none}
  .teachers-table tr:hover{background-color:#f8fafc}

  .text-right{text-align:right}
  .text-center{text-align:center}

  /* معلومات المعلم */
  .teacher-info{display:flex;align-items:center;gap:12px}
  .teacher-avatar{width:40px;height:40px;border-radius:50%;background-color:#e0f2fe;color:#0ea5e9;display:flex;align-items:center;justify-content:center;font-size:18px}
  .teacher-details{display:flex;flex-direction:column}
  .teacher-name{font-weight:900;color:#1e293b}
  .teacher-sub{font-size:.86rem}

  /* الشرائح (chips) */
  .chips{display:flex;flex-wrap:wrap;gap:6px;justify-content:center}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:9999px;font-size:12px;font-weight:900;line-height:1;border:1px solid rgba(0,0,0,.06)}
  .chip-dept{background:#f1f5f9;color:#334155}

  /* ألوان الأقسام (حسب slug ثابت) */
  .chip-dept[data-slug="activity"]  {background:#dbeafe;color:#1d4ed8}
  .chip-dept[data-slug="volunteer"] {background:#dcfce7;color:#166534}
  .chip-dept[data-slug="school"]    {background:#fef3c7;color:#92400e}
  .chip-dept[data-slug="admin"]     {background:#fee2e2;color:#b91c1c}
  .chip-dept[data-slug="teachers"]  {background:#ede9fe;color:#6d28d9}
  .chip-dept[data-slug="affairs"]   {background:#e0e7ff;color:#3730a3}

  /* شريحة الدور داخل القسم */
  .chip-role{display:inline-flex;align-items:center;gap:4px;padding:4px 8px;border-radius:9999px;font-weight:900;margin-right:6px;border:1px dashed rgba(0,0,0,.10)}
  .role-officer{background:#eef2ff;color:#3730a3}
  .role-employee{background:#ecfeff;color:#155e75}

  /* أدوار عامة */
  .chip-role.role-manager{background:#ffe4e6;color:#be123c}
  .chip-role.role-teacher{background:#e9d5ff;color:#6d28d9}

  /* بادجات الحالة */
  .status-badge{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:20px;font-size:13px;font-weight:900}
  .status-active{background-color:#f0fdf4;color:#166534}
  .status-inactive{background-color:#fef2f2;color:#dc2626}

  /* أزرار الإجراءات */
  .action-buttons{display:flex;gap:8px;justify-content:center}

  /* صفحات */
  .pager{display:flex;gap:8px;justify-content:center;align-items:center;margin-top:16px;flex-wrap:wrap}

  /* Empty */
  .empty-state{padding:60px 20px;text-align:center;color:#94a3b8}
  .empty-icon{font-size:64px;margin-bottom:16px;opacity:.5}
  .empty-state h3{margin:0 0 8px 0;color:#64748b;font-weight:900;font-size:20px}
  .empty-state p{margin:0 0 24px 0;font-size:15px}

  /* التجاوب */
  @media (max-width: 992px){
    .admin-container{padding:16px}
    .admin-header{flex-direction:column;align-items:flex-start}
    .admin-card{padding:18px}
    .teachers-table{min-width:100%}
    .teachers-table thead{display:none}
    .teachers-table tr{display:block;margin-bottom:16px;border:1px solid var(--line);border-radius:12px}
    .teachers-table td{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid var(--line);text-align:left}
    .teachers-table td:last-child{border-bottom:none}
    .teachers-table td::before{content:attr(data-label);font-weight:900;color:#475569;margin-left:12px}
    .teacher-info{flex-direction:column;align-items:flex-start;gap:8px}
    .action-buttons{justify-content:flex-end}
  }

  @media (max-width: 520px){
    .search-form input[type="search"]{min-width:220px;width:100%}
  }
</style>
{% endblock %}
