{# templates/reports/manage_teachers.html #}
{% extends "base.html" %}
{% block title %}إدارة المعلمين{% endblock %}

{% block content %}
<div class="admin-scope" dir="rtl">
  <div class="admin-container">
    <div class="admin-header">
      <div class="header-content">
        <h1 class="admin-title">
          <i class="fas fa-chalkboard-teacher"></i>
          إدارة المعلمين
        </h1>
        <p class="admin-subtitle">عرض وإدارة جميع المعلمين في النظام</p>
      </div>

      <div class="header-actions">
        <form method="get" action="" class="search-form" role="search">
          <label class="sr-only" for="q">بحث</label>
          <input
            id="q"
            type="search"
            name="q"
            value="{{ term }}"
            placeholder="بحث: الاسم/الجوال/الهوية"
            autocomplete="off"
            spellcheck="false"
          >
          <button class="btn btn-primary" type="submit">بحث</button>
        </form>

        <a class="btn btn-outline-primary btn-add" href="{% url 'reports:bulk_import_teachers' %}">
          <i class="fas fa-file-excel"></i>
          استيراد جماعي
        </a>

        <a class="btn btn-primary btn-add" href="{% url 'reports:add_teacher' %}">
          <i class="fas fa-plus-circle"></i>
          إضافة معلم جديد
        </a>
      </div>
    </div>

    <div class="admin-card">
      {% if teachers_page and teachers_page.object_list %}
        <div class="meta-bar" aria-label="إحصاءات الجدول">
          <div class="muted">
            العدد المعروض: <b id="rowsCount">{{ teachers_page.object_list|length }}</b>
          </div>
          <div class="muted">
            الإجمالي: <b>{{ teachers_page.paginator.count }}</b>
          </div>
        </div>

        <div class="table-responsive" role="region" aria-label="جدول المعلمين">
          <table class="teachers-table">
            <thead>
              <tr>
                <th class="text-right">المعلم</th>
                <th class="text-right">رقم الهوية</th>
                <th class="text-right">رقم الجوال</th>
                <th class="text-center">القسم / الدور</th>
                <th class="text-center">الحالة</th>
                <th class="text-center">الإجراءات</th>
              </tr>
            </thead>
            <tbody>
              {% for t in teachers_page.object_list %}
              <tr>
                <td data-label="المعلم">
                  <div class="teacher-info">
                    <div class="teacher-avatar" aria-hidden="true"><i class="fas fa-user"></i></div>
                    <div class="teacher-details">
                      <div class="teacher-name">{{ t.name }}</div>
                      <div class="teacher-sub muted">
                        {% if t.phone %}{{ t.phone }}{% endif %}
                      </div>
                    </div>
                  </div>
                </td>

                <td data-label="رقم الهوية">{{ t.national_id|default:"-" }}</td>
                <td data-label="رقم الجوال">{{ t.phone }}</td>

                {# ===== عمود القسم/الدور (بدون استدعاء role.slug داخل القالب) ===== #}
                <td data-label="القسم / الدور" class="text-center">
                  {% with memberships=t.dept_memberships.all %}
                    {% if memberships %}
                      <div class="chips">
                        {% for m in memberships %}
                          {% with dep=m.department rt=m.role_type|stringformat:"s"|lower %}
                            <span class="chip chip-dept" data-slug="{{ dep.slug|default_if_none:''|lower }}">
                              <i class="fas fa-building"></i>
                              {{ dep.name|default:dep.slug }}
                              <span class="chip-role {% if rt == 'officer' or rt == '1' %}role-officer{% else %}role-employee{% endif %}">
                                {% if rt == 'officer' or rt == '1' %}
                                  <i class="fas fa-user-shield"></i> مسؤول
                                {% else %}
                                  <i class="fas fa-id-badge"></i> موظف
                                {% endif %}
                              </span>
                            </span>
                          {% endwith %}
                        {% endfor %}
                      </div>
                    {% else %}
                      {% with slug=t.role_slug|default_if_none:''|lower %}
                        {% if slug == 'manager' %}
                          <span class="chip chip-role role-manager"><i class="fas fa-crown"></i> مدير</span>
                        {% elif slug == 'teacher' %}
                          <span class="chip chip-role role-teacher"><i class="fas fa-user-graduate"></i> معلم</span>
                        {% elif slug %}
                          <span class="chip chip-dept" data-slug="{{ slug }}">
                            <i class="fas fa-building"></i>
                            {{ t.role_label|default:t.role_dept_name|default:slug }}
                            <span class="chip-role role-employee"><i class="fas fa-id-badge"></i> موظف</span>
                          </span>
                        {% else %}
                          <span class="badge-muted">—</span>
                        {% endif %}
                      {% endwith %}
                    {% endif %}
                  {% endwith %}
                </td>
                {# ===================================== #}

                <td data-label="الحالة" class="text-center">
                  {% if t.is_active %}
                    <span class="status-badge status-active"><i class="fas fa-check-circle"></i> نشط</span>
                  {% else %}
                    <span class="status-badge status-inactive"><i class="fas fa-times-circle"></i> معطل</span>
                  {% endif %}
                </td>

                <td data-label="الإجراءات" class="text-center">
                  {% with nxt=request.get_full_path %}
                    <div class="action-buttons">
                      <a
                        href="{% url 'reports:edit_teacher' pk=t.id %}?next={{ nxt|urlencode }}"
                        class="btn btn-icon btn-edit"
                        title="تعديل"
                        aria-label="تعديل"
                      >
                        <i class="fas fa-edit"></i>
                      </a>

                      <form
                        method="post"
                        action="{% url 'reports:delete_teacher' pk=t.id %}?next={{ nxt|urlencode }}"
                        style="display:inline"
                      >
                        {% csrf_token %}
                        <button
                          type="submit"
                          class="btn btn-icon btn-delete"
                          title="حذف"
                          aria-label="حذف"
                          onclick="return confirm('هل أنت متأكد من حذف هذا المعلم؟')"
                        >
                          <i class="fas fa-trash-alt"></i>
                        </button>
                      </form>
                    </div>
                  {% endwith %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="pager" aria-label="التنقل بين الصفحات">
          {% if teachers_page.has_previous %}
            <a class="btn btn-outline" href="?page={{ teachers_page.previous_page_number }}&q={{ term|urlencode }}">السابق</a>
          {% endif %}
          <span class="btn btn-outline">صفحة {{ teachers_page.number }} / {{ teachers_page.paginator.num_pages }}</span>
          {% if teachers_page.has_next %}
            <a class="btn btn-outline" href="?page={{ teachers_page.next_page_number }}&q={{ term|urlencode }}">التالي</a>
          {% endif %}
        </div>

      {% else %}
        <div class="empty-state">
          <div class="empty-icon"><i class="fas fa-users-slash"></i></div>
          <h3>لا يوجد معلمين</h3>
          <p>لم يتم العثور على نتائج{% if term %} لبحثك عن "<strong>{{ term }}</strong>"{% endif %}</p>
          <a href="{% url 'reports:add_teacher' %}" class="btn btn-primary">
            <i class="fas fa-plus"></i> إضافة معلم جديد
          </a>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<style>
  /* =========================================================
     Manage Teachers (scoped) — بدون كسر app.css
     - دعم data-theme للوضع الداكن/الفاتح
     - تقليل التعارض بتغليف كل شيء داخل .admin-scope
     ========================================================= */

  /* A11y */
  .admin-scope .sr-only{
    position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0
  }

  /* Tokens (محلية) */
  .admin-scope{
    --ink: var(--ink, #0f172a);
    --muted: var(--muted, #64748b);
    --line: var(--line, #e2e8f0);
    --line-2: var(--line-2, #f1f5f9);
    --card: var(--card, #ffffff);
    --bg: var(--bg, #f8fafc);
    --t: var(--t-fast, 180ms ease);
  }

  /* Container */
  .admin-scope .admin-container{padding:20px;max-width:1400px;margin:0 auto}
  .admin-scope .admin-header{
    display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;flex-wrap:wrap;gap:14px
  }
  .admin-scope .header-content{flex:1;min-width:260px}
  .admin-scope .admin-title{
    font-size:22px;font-weight:950;color:var(--ink);margin:0 0 6px;display:flex;align-items:center;gap:10px
  }
  .admin-scope .admin-subtitle{color:var(--muted);font-size:14px;margin:0;font-weight:800}

  /* Actions */
  .admin-scope .header-actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .admin-scope .search-form{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .admin-scope .search-form input[type="search"]{
    padding:10px 14px;border:1px solid var(--line);border-radius:12px;min-width:260px;outline:none;
    background: var(--card);
    color: var(--ink);
    transition: var(--t);
  }
  .admin-scope .search-form input[type="search"]::placeholder{color: rgba(100,116,139,.85)}
  .admin-scope .search-form input[type="search"]:focus{
    border-color:#2563eb;
    box-shadow:0 0 0 3px rgba(37,99,235,.12)
  }

  .admin-scope .btn-add{padding:12px 18px;font-weight:900}

  /* Card */
  .admin-scope .admin-card{
    background:var(--card);
    border-radius:16px;
    border: 1px solid var(--line);
    box-shadow:0 10px 28px rgba(15,23,42,.06);
    padding:18px;
    overflow:hidden
  }

  .admin-scope .meta-bar{
    display:flex;gap:14px;flex-wrap:wrap;align-items:center;justify-content:flex-end;margin-bottom:12px
  }
  .admin-scope .muted{color:var(--muted);font-weight:900}

  /* Table */
  .admin-scope .table-responsive{
    overflow-x:auto;
    border-radius:14px;
    border:1px solid var(--line)
  }
  .admin-scope .teachers-table{
    width:100%;
    border-collapse:separate;
    border-spacing:0;
    min-width:920px;
    background: var(--card);
  }
  .admin-scope .teachers-table th{
    background: linear-gradient(180deg, var(--line-2), var(--card));
    padding:16px;
    font-weight:950;
    color:#475569;
    text-align:right;
    border-bottom:1px solid var(--line);
    white-space:nowrap;
  }
  .admin-scope .teachers-table td{
    padding:16px;
    border-bottom:1px solid var(--line);
    color:#334155;
    vertical-align:middle;
  }
  .admin-scope .teachers-table tr:last-child td{border-bottom:none}
  .admin-scope .teachers-table tbody tr{
    transition: var(--t);
  }
  .admin-scope .teachers-table tbody tr:hover{
    background: rgba(241,245,249,.75);
  }

  .admin-scope .text-right{text-align:right}
  .admin-scope .text-center{text-align:center}

  /* Teacher info */
  .admin-scope .teacher-info{display:flex;align-items:center;gap:12px}
  .admin-scope .teacher-avatar{
    width:42px;height:42px;border-radius:50%;
    background: rgba(37,99,235,.10);
    color: rgba(37,99,235,.95);
    display:flex;align-items:center;justify-content:center;font-size:18px;
    border: 1px solid rgba(37,99,235,.15);
  }
  .admin-scope .teacher-details{display:flex;flex-direction:column}
  .admin-scope .teacher-name{font-weight:950;color:var(--ink)}
  .admin-scope .teacher-sub{font-size:.88rem}

  /* Chips */
  .admin-scope .chips{display:flex;flex-wrap:wrap;gap:6px;justify-content:center}
  .admin-scope .chip{
    display:inline-flex;align-items:center;gap:6px;
    padding:7px 10px;border-radius:9999px;
    font-size:12px;font-weight:950;line-height:1;
    border:1px solid rgba(0,0,0,.06);
    white-space:nowrap;
  }
  .admin-scope .chip-dept{background:#f1f5f9;color:#334155}

  /* Dept colors */
  .admin-scope .chip-dept[data-slug="activity"]  {background:#dbeafe;color:#1d4ed8}
  .admin-scope .chip-dept[data-slug="volunteer"] {background:#dcfce7;color:#166534}
  .admin-scope .chip-dept[data-slug="school"]    {background:#fef3c7;color:#92400e}
  .admin-scope .chip-dept[data-slug="admin"]     {background:#fee2e2;color:#b91c1c}
  .admin-scope .chip-dept[data-slug="teachers"]  {background:#ede9fe;color:#6d28d9}
  .admin-scope .chip-dept[data-slug="affairs"]   {background:#e0e7ff;color:#3730a3}

  /* Role inside dept */
  .admin-scope .chip-role{
    display:inline-flex;align-items:center;gap:4px;
    padding:5px 8px;border-radius:9999px;
    font-weight:950;margin-right:6px;
    border:1px dashed rgba(0,0,0,.10)
  }
  .admin-scope .role-officer{background:#eef2ff;color:#3730a3}
  .admin-scope .role-employee{background:#ecfeff;color:#155e75}

  /* Global roles */
  .admin-scope .chip-role.role-manager{background:#ffe4e6;color:#be123c}
  .admin-scope .chip-role.role-teacher{background:#e9d5ff;color:#6d28d9}

  /* Status */
  .admin-scope .status-badge{
    display:inline-flex;align-items:center;gap:6px;
    padding:7px 12px;border-radius:999px;
    font-size:13px;font-weight:950;
    border: 1px solid rgba(0,0,0,.05);
  }
  .admin-scope .status-active{background:#f0fdf4;color:#166534}
  .admin-scope .status-inactive{background:#fef2f2;color:#dc2626}

  /* Action buttons */
  .admin-scope .action-buttons{display:flex;gap:8px;justify-content:center}

  /* Icons buttons (avoid overriding app.css too much) */
  .admin-scope .btn-icon{padding:9px 12px;border-radius:10px}
  .admin-scope .btn-edit{background:#f59e0b;color:#fff}
  .admin-scope .btn-edit:hover{background:#d97706}
  .admin-scope .btn-delete{background:#ef4444;color:#fff}
  .admin-scope .btn-delete:hover{background:#dc2626}
  .admin-scope .btn-outline{background:#fff;border:1px solid var(--line);color:#1e293b}
  .admin-scope .btn-outline:hover{background: var(--line-2)}

  /* Pager */
  .admin-scope .pager{
    display:flex;gap:8px;justify-content:center;align-items:center;margin-top:16px;flex-wrap:wrap
  }

  /* Empty */
  .admin-scope .empty-state{padding:60px 20px;text-align:center;color:#94a3b8}
  .admin-scope .empty-icon{font-size:64px;margin-bottom:16px;opacity:.5}
  .admin-scope .empty-state h3{margin:0 0 8px 0;color:#64748b;font-weight:950;font-size:20px}
  .admin-scope .empty-state p{margin:0 0 24px 0;font-size:15px}

  /* Dark mode via data-theme */
  html[data-theme="dark"] .admin-scope{
    --line: #1b2744;
    --line-2: rgba(20,35,73,.45);
  }
  html[data-theme="dark"] .admin-scope .admin-card{
    box-shadow:0 18px 45px rgba(2,6,23,.35);
  }
  html[data-theme="dark"] .admin-scope .teachers-table th{
    color: rgba(226,232,240,.92);
  }
  html[data-theme="dark"] .admin-scope .teachers-table td{
    color: rgba(226,232,240,.92);
  }
  html[data-theme="dark"] .admin-scope .teachers-table tbody tr:hover{
    background: rgba(26,44,83,.55);
  }
  html[data-theme="dark"] .admin-scope .btn-outline{
    background: rgba(15,22,41,.6);
    border-color: #1b2744;
    color: rgba(226,232,240,.92);
  }
  html[data-theme="dark"] .admin-scope .btn-outline:hover{
    background: rgba(26,44,83,.65);
  }
  html[data-theme="dark"] .admin-scope .search-form input[type="search"]{
    background: rgba(15,22,41,.55);
    border-color: #1b2744;
    color: rgba(226,232,240,.95);
  }
  html[data-theme="dark"] .admin-scope .search-form input[type="search"]::placeholder{
    color: rgba(148,163,184,.85);
  }

  /* Responsive cards (mobile) */
  @media (max-width: 992px){
    .admin-scope .admin-container{padding:16px}
    .admin-scope .admin-header{flex-direction:column;align-items:flex-start}
    .admin-scope .teachers-table{min-width:100%}
    .admin-scope .teachers-table thead{display:none}
    .admin-scope .teachers-table tr{
      display:block;
      margin-bottom:14px;
      border:1px solid var(--line);
      border-radius:14px;
      overflow:hidden;
      background: var(--card);
    }
    .admin-scope .teachers-table td{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      text-align:left;
      gap: 10px;
    }
    .admin-scope .teachers-table td:last-child{border-bottom:none}
    .admin-scope .teachers-table td::before{
      content:attr(data-label);
      font-weight:950;
      color:#475569;
      margin-left:12px;
      flex: 0 0 auto;
    }
    html[data-theme="dark"] .admin-scope .teachers-table td::before{
      color: rgba(226,232,240,.80);
    }
    .admin-scope .teacher-info{flex-direction:column;align-items:flex-start;gap:8px}
    .admin-scope .action-buttons{justify-content:flex-end}
  }

  @media (max-width: 520px){
    .admin-scope .search-form input[type="search"]{min-width:220px;width:100%}
  }
</style>
{% endblock %}
