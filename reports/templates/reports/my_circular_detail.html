{% extends "base.html" %}
{% load static %}

{% block title %}تفاصيل التعميم{% endblock %}

{% block head %}
<style>
  .nd-scope{
    --nd-ink: var(--ink, #0f172a);
    --nd-muted: var(--muted, #64748b);
    --nd-line: var(--line, #e5e7eb);
    --nd-card: var(--card, #ffffff);
    --nd-soft: var(--line-2, #f1f5f9);
    --nd-shadow: 0 12px 30px rgba(2,6,23,.08);
    --nd-brand: var(--brand, #2563eb);
    --nd-t: var(--t-fast, .18s ease);
  }

  .nd-scope .nd-wrap{max-width:1100px;margin:0 auto;padding:18px}
  .nd-scope .nd-head{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:14px;flex-wrap:wrap}
  .nd-scope .nd-title{margin:0;font-weight:950;color:var(--nd-ink)}
  .nd-scope .nd-hint{color:var(--nd-muted);font-weight:850}

  .nd-scope .nd-card{background:var(--nd-card);border:1px solid var(--nd-line);border-radius:16px;box-shadow:var(--nd-shadow);overflow:hidden}
  .nd-scope .nd-card-hd{padding:14px 16px;border-bottom:1px solid var(--nd-line);display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;background:linear-gradient(180deg,var(--nd-soft),var(--nd-card))}
  .nd-scope .nd-card-bd{padding:16px}
  .nd-scope .nd-meta-row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .nd-scope .nd-when{color:var(--nd-muted);font-weight:900}

  .nd-scope .nd-pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--nd-line);background:var(--nd-soft);color:var(--nd-ink);border-radius:999px;font-weight:950;font-size:.86rem;white-space:nowrap}
  .nd-scope .nd-pill.danger{background:rgba(239,68,68,.08);border-color:rgba(239,68,68,.18);color:#b91c1c}
  .nd-scope .nd-pill.success{background:rgba(16,185,129,.10);border-color:rgba(16,185,129,.20);color:#166534}

  .nd-scope .nd-body{line-height:1.95;color:var(--nd-ink);font-weight:850;background:linear-gradient(180deg,var(--nd-card),rgba(248,250,252,.55));border:1px solid var(--nd-line);border-radius:14px;padding:14px}
  .nd-scope .nd-note{color:var(--nd-muted);font-weight:850;line-height:1.85}
  .nd-scope .nd-error{margin-top:6px;color:#b91c1c;font-weight:900;display:none}

  .nd-scope .nd-input{width:100%;min-height:44px;border:1px solid var(--nd-line);border-radius:12px;padding:10px 12px;font:inherit;background:var(--nd-card);color:var(--nd-ink);font-weight:850;outline:none}
  .nd-scope .nd-input:focus{border-color: rgba(37,99,235,.35);box-shadow:0 0 0 4px rgba(37,99,235,.12)}

  .nd-scope .nd-btn{padding:10px 12px;border-radius:12px;border:1px solid var(--nd-line);background:var(--nd-card);font-weight:950;text-decoration:none;color:var(--nd-ink);display:inline-flex;align-items:center;gap:8px;cursor:pointer;min-height:44px;transition: transform var(--nd-t), box-shadow var(--nd-t), border-color var(--nd-t), background var(--nd-t)}
  .nd-scope .nd-btn:hover{transform:translateY(-1px);box-shadow:0 14px 26px rgba(2,6,23,.10);border-color:rgba(37,99,235,.25);background:rgba(248,250,252,.80)}
  .nd-scope .nd-btn[disabled]{opacity:.55;cursor:not-allowed;filter:saturate(.8)}

  .nd-scope .ack-row{display:flex;gap:10px;align-items:flex-start;padding:10px 12px;border:1px solid var(--nd-line);border-radius:12px;background:var(--nd-soft)}
  .nd-scope .ack-row:hover{border-color: rgba(37,99,235,.25)}
  .nd-scope .nd-switch{position:relative;display:inline-flex;align-items:center;flex:0 0 auto}
  .nd-scope .nd-switch input{position:absolute;opacity:0;inline-size:1px;block-size:1px}
  .nd-scope .nd-slider{inline-size:46px;block-size:26px;background:rgba(100,116,139,.25);border:1px solid rgba(100,116,139,.25);border-radius:999px;display:inline-block;position:relative;transition: background var(--nd-t), border-color var(--nd-t)}
  .nd-scope .nd-slider:before{content:"";position:absolute;inline-size:22px;block-size:22px;inset-block-start:1px;inset-inline-start:2px;background:#fff;border-radius:999px;box-shadow:0 8px 16px rgba(2,6,23,.10);transition: transform var(--nd-t)}
  .nd-scope .nd-switch input:checked + .nd-slider{background:rgba(37,99,235,.95);border-color:rgba(37,99,235,.95)}
  .nd-scope .nd-switch input:checked + .nd-slider:before{transform: translateX(20px)}
  .nd-scope .nd-switch input:focus-visible + .nd-slider{box-shadow:0 0 0 4px rgba(37,99,235,.16)}

  html[data-theme="dark"] .nd-scope{--nd-shadow: 0 18px 46px rgba(0,0,0,.45)}
  html[data-theme="dark"] .nd-scope .nd-body{background:linear-gradient(180deg,var(--nd-card),rgba(2,6,23,.25))}

  @media (prefers-reduced-motion: reduce){
    .nd-scope .nd-btn{transition:none !important;}
    .nd-scope .nd-btn:hover{transform:none !important;}
    .nd-scope .nd-slider,.nd-scope .nd-slider:before{transition:none !important;}
  }
</style>
{% endblock %}

{% block content %}
<div class="nd-scope">
  <div class="nd-wrap" dir="rtl">
    <header class="nd-head">
      <div>
        <h1 class="nd-title">تفاصيل التعميم</h1>
        <div class="nd-hint">عرض التعميم وتأكيد الاستلام بالتوقيع</div>
      </div>
      <a class="nd-btn" href="{% url 'reports:my_circulars' %}">
        <i class="fa-solid fa-arrow-right" aria-hidden="true"></i>
        رجوع إلى التعاميم
      </a>
    </header>

    <section class="nd-card" aria-label="التعميم">
      <div class="nd-card-hd">
        <div class="nd-meta-row">
          <strong style="font-weight:950">{{ n.title|default:"تعميم" }}</strong>
          {% if r.is_signed %}
            <span class="nd-pill success"><i class="fa-solid fa-pen-to-square" aria-hidden="true"></i> تم التوقيع</span>
          {% else %}
            <span class="nd-pill danger"><i class="fa-solid fa-pen-to-square" aria-hidden="true"></i> يتطلب توقيع</span>
          {% endif %}
        </div>
        <div class="nd-when">{% if r.created_at %}{{ r.created_at|date:"Y-m-d H:i" }}{% endif %}</div>
      </div>

      <div class="nd-card-bd">
        {% if body %}
          <div class="nd-body">{{ body|linebreaksbr }}</div>
        {% else %}
          <div class="nd-note">لا يوجد محتوى نصي.</div>
        {% endif %}

        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px">
          <span class="nd-pill">
            المرسِل:
            {% if n.created_by %}
              {% firstof n.created_by.name n.created_by.phone n.created_by.username "الإدارة" %}
              {% if n.created_by.role %} — {% firstof n.created_by.role.name n.created_by.role.slug %}{% endif %}
            {% else %}
              الإدارة
            {% endif %}
          </span>
          {% if r.is_read %}<span class="nd-pill">الحالة: مقروء</span>{% else %}<span class="nd-pill">الحالة: غير مقروء</span>{% endif %}
          {% if r.read_at %}<span class="nd-pill">وقت القراءة: {{ r.read_at|date:"Y-m-d H:i" }}</span>{% endif %}
          {% if r.is_signed %}
            {% if r.signed_at %}<span class="nd-pill">وقت التوقيع: {{ r.signed_at|date:"Y-m-d H:i" }}</span>{% endif %}
          {% endif %}
        </div>

        {% if n.attachment %}
          <div style="margin-top:12px">
            <a class="nd-btn" href="{{ n.attachment.url }}" target="_blank" rel="noopener">
              <i class="fa-solid fa-paperclip" aria-hidden="true"></i>
              فتح/تحميل المرفق
            </a>
          </div>
        {% endif %}
      </div>
    </section>

    {% if not r.is_signed %}
      <div style="height:12px"></div>
      <section class="nd-card" aria-label="التوقيع على التعميم">
        <div class="nd-card-hd">
          <div class="nd-meta-row">
            <strong style="font-weight:950">التوقيع على التعميم</strong>
            <span class="nd-pill">توثيق رسمي</span>
          </div>
          <div class="nd-when">لأمان أعلى: إدخال الجوال + إقرار</div>
        </div>
        <div class="nd-card-bd">
          <div class="nd-body" style="margin-bottom:10px">
            {% if n.signature_ack_text %}
              {{ n.signature_ack_text|linebreaksbr }}
            {% else %}
              أقرّ بأنني اطلعت على هذا التعميم وفهمت ما ورد فيه وأتعهد بالالتزام به.
            {% endif %}
          </div>

          <form id="sigForm" method="post" action="{% url 'reports:circular_sign' r.pk %}" novalidate>
            {% csrf_token %}

            <div>
              <label style="font-weight:950;display:block;margin-bottom:6px" for="sig_phone">رقم الجوال المسجل</label>
              <input class="nd-input" id="sig_phone" name="phone" type="tel" inputmode="numeric" autocomplete="tel" placeholder="مثال: 05xxxxxxxx" required>
              <div class="nd-note" style="margin-top:6px">اكتب الرقم كما هو مسجل في حسابك (10 أرقام يبدأ بـ 05).</div>
              <div class="nd-error" id="sig_phone_error" aria-live="polite"></div>
            </div>

            <div style="height:10px"></div>

            <label class="ack-row" for="sig_ack" style="cursor:pointer">
              <span class="nd-switch">
                <input id="sig_ack" name="ack" type="checkbox" required>
                <span class="nd-slider" aria-hidden="true"></span>
              </span>
              <span style="font-weight:900">أوافق على الإقرار أعلاه وأقرّ بصحة البيانات.</span>
            </label>
            <div class="nd-note" style="margin-top:6px">لن يتم اعتماد التوقيع إلا بعد تفعيل الإقرار وإدخال رقم جوال صحيح.</div>

            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px">
              <button id="sigSubmit" class="nd-btn" type="submit" disabled style="background: var(--nd-brand);border-color: var(--nd-brand);color:#fff;">
                <i class="fa-solid fa-pen-to-square" aria-hidden="true"></i>
                اعتماد التوقيع
              </button>
              <a class="nd-btn" href="{% url 'reports:my_circulars' %}">
                <i class="fa-solid fa-arrow-right" aria-hidden="true"></i>
                لاحقاً
              </a>
            </div>
            <div class="nd-note" id="sigSubmitHint" style="margin-top:8px">بالضغط على "اعتماد التوقيع" سيتم تسجيل إقرارك ووقت التوقيع.</div>
          </form>
        </div>
      </section>
    {% endif %}
  </div>
</div>

<script>
  (function(){
    const form = document.getElementById('sigForm');
    const phoneInput = document.getElementById('sig_phone');
    const ackInput = document.getElementById('sig_ack');
    const submitBtn = document.getElementById('sigSubmit');
    const phoneError = document.getElementById('sig_phone_error');

    if (!form || !phoneInput || !ackInput || !submitBtn) return;

    function digitsOnly(value){
      return String(value || '').replace(/\D+/g, '');
    }
    function normalizePhone(raw){
      const d = digitsOnly(raw);
      if (d.startsWith('9665') && d.length === 12) return '0' + d.slice(3);
      return d;
    }
    function isValidPhone(value){
      return /^05\d{8}$/.test(value);
    }
    function setPhoneError(message){
      if (!phoneError) return;
      if (!message) {
        phoneError.style.display = 'none';
        phoneError.textContent = '';
        return;
      }
      phoneError.style.display = 'block';
      phoneError.textContent = message;
    }
    function updateState(){
      const normalized = normalizePhone(phoneInput.value);
      const okPhone = isValidPhone(normalized);
      const okAck = !!ackInput.checked;
      submitBtn.disabled = !(okPhone && okAck) || submitBtn.dataset.busy === '1';
      if (phoneInput.value && !okPhone) setPhoneError('رقم الجوال غير صحيح. أدخل 10 أرقام تبدأ بـ 05.');
      else setPhoneError('');
    }

    phoneInput.addEventListener('input', function(){
      const normalized = normalizePhone(phoneInput.value);
      if (normalized && normalized !== phoneInput.value.replace(/\s+/g, '')) phoneInput.value = normalized;
      updateState();
    });
    ackInput.addEventListener('change', updateState);

    form.addEventListener('submit', function(e){
      updateState();
      if (submitBtn.disabled) {
        e.preventDefault();
        return;
      }
      const ok = window.confirm('تأكيد: سيتم تسجيل إقرارك واعتماد توقيعك الآن.');
      if (!ok) {
        e.preventDefault();
        return;
      }
      submitBtn.dataset.busy = '1';
      submitBtn.disabled = true;
      submitBtn.innerHTML = 'جارٍ اعتماد التوقيع...';
    });

    updateState();
  })();
</script>
{% endblock %}
