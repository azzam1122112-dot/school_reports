{# templates/reports/my_notifications.html #}
{% extends "base.html" %}
{% load static %}

{% block title %}إشعاراتي{% endblock %}

{% block head %}
<style nonce="{{ CSP_NONCE }}">
  /* =========================================================
     Premium Notifications Design System - 2026
     Elegant, Modern, Fully Responsive
     ========================================================= */
  :root {
    --notif-primary: #2563eb;
    --notif-primary-dark: #1e40af;
    --notif-gradient: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
    --notif-success: #10b981;
    --notif-success-dark: #059669;
    --notif-warning: #f59e0b;
    --notif-danger: #ef4444;
    --notif-danger-dark: #dc2626;
    --notif-surface: #ffffff;
    --notif-background: #f8fafc;
    --notif-border: #e2e8f0;
    --notif-border-light: #f1f5f9;
    --notif-text: #0f172a;
    --notif-text-soft: #64748b;
    --notif-shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --notif-shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    --notif-shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    --notif-shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    --notif-radius-sm: 8px;
    --notif-radius-md: 12px;
    --notif-radius-lg: 16px;
    --notif-radius-xl: 24px;
    --notif-radius-full: 9999px;
  }

  html[data-theme="dark"] {
    --notif-surface: rgba(15, 23, 42, 0.55);
    --notif-background: rgba(15, 23, 42, 0.35);
    --notif-border: #1b2744;
    --notif-border-light: #1e293b;
    --notif-text: #e5e7eb;
    --notif-text-soft: #94a3b8;
    --notif-shadow-md: 0 10px 28px rgba(0, 0, 0, 0.35);
    --notif-shadow-xl: 0 25px 50px rgba(0, 0, 0, 0.5);
  }

  /* Page Layout */
  .notif-scope {
    background: var(--notif-background);
    min-height: calc(100vh - 120px);
    padding: 32px 20px 60px;
  }

  .notif-scope .notif-container {
    max-width: 1000px;
    margin: 0 auto;
  }

  /* Header Section */
  .notif-scope .page-head {
    margin-bottom: 32px;
    padding: 32px 28px;
    background: var(--notif-surface);
    border: 2px solid var(--notif-border);
    border-radius: var(--notif-radius-xl);
    box-shadow: var(--notif-shadow-md);
    position: relative;
    overflow: hidden;
  }

  .notif-scope .page-head::before {
    content: '';
    position: absolute;
    inset: 0;
    background: var(--notif-gradient);
    opacity: 0.03;
  }

  .notif-scope .page-title {
    margin: 0 0 20px;
    font-weight: 900;
    font-size: clamp(1.5rem, 4vw, 2.25rem);
    background: var(--notif-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
    position: relative;
  }

  .notif-scope .head-actions {
    display: flex;
    gap: 16px;
    align-items: center;
    flex-wrap: wrap;
    position: relative;
  }

  /* Toggle Switch */
  .notif-scope .toggle {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 700;
    font-size: 0.95rem;
    color: var(--notif-text);
    cursor: pointer;
    user-select: none;
  }

  .notif-scope .toggle input[type="checkbox"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
    accent-color: var(--notif-primary);
  }

  /* Buttons */
  .notif-scope .btn-outline {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 12px 24px;
    border-radius: var(--notif-radius-md);
    font-weight: 800;
    font-size: 0.95rem;
    border: 2px solid var(--notif-border);
    background: transparent;
    color: var(--notif-text-soft);
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    min-height: 44px;
  }

  .notif-scope .btn-outline:hover {
    background: var(--notif-primary);
    color: white;
    border-color: var(--notif-primary);
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(37, 99, 235, 0.3);
  }

  .notif-scope .btn-sm {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 8px 16px;
    border-radius: var(--notif-radius-md);
    font-weight: 700;
    font-size: 0.85rem;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
  }

  .notif-scope .btn-sm.primary {
    background: var(--notif-gradient);
    color: white;
    box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
  }

  .notif-scope .btn-sm.primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
  }

  .notif-scope .btn-sm.success {
    background: linear-gradient(135deg, var(--notif-success), var(--notif-success-dark));
    color: white;
    pointer-events: none;
  }

  .notif-scope .btn-sm.ghost {
    background: var(--notif-border-light);
    color: var(--notif-text);
    border: 2px solid var(--notif-border);
  }

  .notif-scope .btn-sm.ghost:hover {
    background: var(--notif-primary);
    color: white;
    border-color: var(--notif-primary);
  }

  /* Chips/Badges */
  .notif-scope .chip {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 14px;
    border-radius: var(--notif-radius-full);
    font-size: 0.8rem;
    font-weight: 800;
    letter-spacing: 0.3px;
  }

  .notif-scope .chip.success {
    background: rgba(16, 185, 129, 0.1);
    border: 2px solid rgba(16, 185, 129, 0.3);
    color: #166534;
  }

  .notif-scope .chip.info {
    background: rgba(37, 99, 235, 0.1);
    border: 2px solid rgba(37, 99, 235, 0.3);
    color: #1e40af;
  }

  .notif-scope .chip.danger {
    background: rgba(239, 68, 68, 0.1);
    border: 2px solid rgba(239, 68, 68, 0.3);
    color: #991b1b;
    font-weight: 900;
  }

  .notif-scope .chip.muted {
    background: var(--notif-border-light);
    border: 2px solid var(--notif-border);
    color: var(--notif-text-soft);
  }

  /* Cards Container */
  .notif-scope .cards {
    display: grid;
    gap: 20px;
  }

  /* Notification Card */
  .notif-scope .n-card {
    background: linear-gradient(135deg, var(--notif-surface) 0%, var(--notif-background) 100%);
    border: 2px solid var(--notif-border);
    border-radius: var(--notif-radius-xl);
    padding: 24px;
    box-shadow: var(--notif-shadow-md);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
  }

  .notif-scope .n-card::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 5px;
    background: var(--notif-gradient);
    transform: translateX(-100%);
    transition: transform 0.3s ease;
  }

  .notif-scope .n-card:not(.read)::before {
    transform: translateX(0);
  }

  .notif-scope .n-card:hover {
    transform: translateY(-3px);
    box-shadow: var(--notif-shadow-xl);
    border-color: var(--notif-primary);
  }

  .notif-scope .n-card.read {
    opacity: 0.7;
  }

  /* Card Header */
  .notif-scope .n-head {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 16px;
    margin-bottom: 16px;
    flex-wrap: wrap;
  }

  .notif-scope .n-title {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 900;
    color: var(--notif-text);
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
    flex: 1;
  }

  .notif-scope .n-time {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--notif-text-soft);
    display: flex;
    align-items: center;
    gap: 6px;
    white-space: nowrap;
  }

  /* Card Body */
  .notif-scope .n-body {
    margin: 16px 0;
    padding: 16px;
    background: linear-gradient(135deg, var(--notif-border-light), var(--notif-background));
    border: 2px solid var(--notif-border);
    border-radius: var(--notif-radius-lg);
    font-size: 0.95rem;
    line-height: 1.8;
    color: var(--notif-text);
    font-weight: 600;
  }

  /* Sender Info */
  .notif-scope .sender {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 16px 0;
    padding: 12px 16px;
    background: var(--notif-background);
    border-radius: var(--notif-radius-md);
    font-size: 0.9rem;
  }

  .notif-scope .avatar-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: var(--notif-primary);
    flex-shrink: 0;
  }

  .notif-scope .sender-name {
    font-weight: 800;
    color: var(--notif-text);
  }

  .notif-scope .sender-role {
    font-weight: 600;
    color: var(--notif-text-soft);
  }

  /* Card Actions */
  .notif-scope .n-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 16px;
    margin-top: 20px;
    padding-top: 16px;
    border-top: 2px solid var(--notif-border-light);
    flex-wrap: wrap;
  }

  .notif-scope .n-actions .left,
  .notif-scope .n-actions .right {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
  }

  .notif-scope .time-badge {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    background: var(--notif-border-light);
    border-radius: var(--notif-radius-md);
    font-size: 0.8rem;
    font-weight: 700;
    color: var(--notif-text-soft);
  }

  .notif-scope .mark-one-form {
    display: inline-block;
    margin: 0;
  }

  /* Empty State */
  .notif-scope .empty {
    padding: 80px 20px;
    text-align: center;
    color: var(--notif-text-soft);
    font-size: 1.25rem;
    font-weight: 700;
  }

  .notif-scope .empty i {
    font-size: 4rem;
    margin-bottom: 20px;
    opacity: 0.3;
    display: block;
  }

  /* Pagination */
  .notif-scope .pager {
    display: flex;
    gap: 12px;
    align-items: center;
    justify-content: center;
    margin-top: 32px;
    padding-top: 24px;
    border-top: 2px solid var(--notif-border-light);
    flex-wrap: wrap;
  }

  .notif-scope .pager a {
    padding: 10px 20px;
    border: 2px solid var(--notif-border);
    border-radius: var(--notif-radius-md);
    background: var(--notif-surface);
    color: var(--notif-text);
    text-decoration: none;
    font-weight: 800;
    font-size: 0.9rem;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .notif-scope .pager a:hover {
    background: var(--notif-primary);
    color: white;
    border-color: var(--notif-primary);
    transform: translateY(-2px);
  }

  .notif-scope .pager .on {
    color: var(--notif-text-soft);
    font-weight: 700;
    font-size: 0.95rem;
  }

  /* Responsive Design */
  @media(max-width: 768px) {
    .notif-scope {
      padding: 20px 12px 50px;
    }

    .notif-scope .page-head {
      padding: 24px 20px;
    }

    .notif-scope .page-title {
      font-size: 1.5rem;
    }

    .notif-scope .head-actions {
      flex-direction: column;
      align-items: stretch;
    }

    .notif-scope .btn-outline {
      width: 100%;
      justify-content: center;
    }

    .notif-scope .n-card {
      padding: 20px 16px;
    }

    .notif-scope .n-head {
      flex-direction: column;
      align-items: flex-start;
    }

    .notif-scope .n-actions {
      flex-direction: column;
      align-items: stretch;
    }

    .notif-scope .n-actions .left,
    .notif-scope .n-actions .right {
      width: 100%;
      justify-content: center;
    }
  }

  /* Accessibility */
  @media (prefers-reduced-motion: reduce) {
    .notif-scope .n-card,
    .notif-scope .btn-outline,
    .notif-scope .btn-sm,
    .notif-scope .pager a {
      transition: none !important;
    }

    .notif-scope .n-card:hover,
    .notif-scope .btn-outline:hover,
    .notif-scope .btn-sm:hover,
    .notif-scope .pager a:hover {
      transform: none !important;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="notif-scope">
  <div class="notif-container" dir="rtl">

    <header class="page-head">
      <h1 class="page-title">
        <i class="fa-solid fa-bell" aria-hidden="true"></i>
        إشعاراتي

        {% with unread=NAV_NOTIFICATIONS_UNREAD|default_if_none:"0"|add:"0" %}
          <span class="chip" id="unreadCount" aria-live="polite" {% if unread == 0 %}style="display:none"{% endif %} data-initial="{{ unread }}">
            <i class="fa-solid fa-envelope" aria-hidden="true"></i>
            <span id="unreadCountNum">{{ unread }}</span>
            غير مقروءة
          </span>
        {% endwith %}
      </h1>

      <div class="head-actions">
        <label class="toggle" for="onlyUnread">
          <input type="checkbox" id="onlyUnread">
          إظهار غير المقروء فقط
        </label>

        <form class="head-actions mark-all" method="post" action="{% url 'reports:notifications_mark_all_read' %}">
          {% csrf_token %}
          <input type="hidden" name="next" value="{% url 'reports:my_notifications' %}">
          <button class="btn-outline" type="submit" id="markAllBtn">
            <i class="fa-solid fa-check-double" aria-hidden="true"></i>
            تحديد الكل كمقروء
          </button>
        </form>
      </div>
    </header>

    {% if page_obj and page_obj.object_list %}
      <section class="cards" id="cards">
        {% for r in page_obj %}
          {% with n=r.notification %}
          <article class="n-card {% if r.is_read %}read{% endif %}" data-read="{% if r.is_read %}1{% else %}0{% endif %}">
            <div class="n-head">
              <h3 class="n-title">
                {% if n.is_important %}
                  <span class="chip danger"><i class="fa-solid fa-triangle-exclamation" aria-hidden="true"></i> هام</span>
                {% endif %}
                {{ n.title|default:"رسالة من الإدارة" }}
              </h3>

              <time class="n-time" datetime="{{ r.created_at|date:'c' }}">
                <i class="fa-regular fa-clock" aria-hidden="true"></i>
                {{ r.created_at|date:"Y-m-d H:i" }}
              </time>
            </div>

            {% firstof n.message n.body n.content n.text n.details as body %}
            {% if body %}
              <div class="n-body">{{ body|linebreaksbr }}</div>
            {% endif %}

            <div class="sender" aria-label="المرسِل">
              <span class="avatar-dot" aria-hidden="true"></span>

              <span class="sender-name">
                {% firstof r.sender_name "الإدارة" %}
              </span>

              <span class="sender-role">
                {% if r.sender_role_label %}— {{ r.sender_role_label }}{% endif %}
              </span>
            </div>

            <div class="n-actions">
              <div class="left">
                <span class="time-badge">
                  <i class="fa-regular fa-clock" aria-hidden="true"></i>
                  {{ r.created_at|date:"Y-m-d H:i" }}
                </span>

                <a
                  class="btn-sm ghost"
                  aria-label="عرض الإشعار كاملًا"
                  href="{% url 'reports:my_notification_detail' r.pk %}"
                  target="_blank"
                  rel="noopener"
                >
                  <i class="fa-regular fa-eye" aria-hidden="true"></i>
                  عرض
                </a>
              </div>

              <div class="right">
                {% if r.is_read %}
                  <span class="btn-sm success">
                    <i class="fa-solid fa-circle-check" aria-hidden="true"></i>
                    مقروء
                  </span>
                  {% if r.read_at %}
                    <span class="chip muted">
                      <i class="fa-regular fa-clock" aria-hidden="true"></i>
                      {{ r.read_at|date:"Y-m-d H:i" }}
                    </span>
                  {% endif %}
                {% else %}
                  <form method="post" action="{% url 'reports:notification_mark_read' r.pk %}" class="mark-one-form">
                    {% csrf_token %}
                    <button class="btn-sm primary mark-one" type="submit">
                      <i class="fa-solid fa-check" aria-hidden="true"></i>
                      تمت القراءة
                    </button>
                  </form>
                {% endif %}
              </div>
            </div>
          </article>
          {% endwith %}
        {% endfor %}
      </section>

      {% if page_obj.paginator.num_pages > 1 %}
        <nav class="pager" aria-label="التنقل بين الصفحات">
          {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}">
              <i class="fa-solid fa-arrow-right" aria-hidden="true"></i>
              السابق
            </a>
          {% endif %}

          <span class="on">صفحة {{ page_obj.number }} من {{ page_obj.paginator.num_pages }}</span>

          {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}">
              التالي
              <i class="fa-solid fa-arrow-left" aria-hidden="true"></i>
            </a>
          {% endif %}
        </nav>
      {% endif %}

    {% else %}
      <div class="empty">
        <i class="fa-regular fa-bell" aria-hidden="true"></i>
        لا توجد إشعارات حتى الآن.
      </div>
    {% endif %}
  </div>

</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script{% if CSP_NONCE %} nonce="{{ CSP_NONCE }}"{% endif %}>
document.addEventListener('DOMContentLoaded', function(){
  const $  = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));

  const LS_ONLY_KEY = 'notif_only_unread_v1';

  const unreadCountEl = $('#unreadCount');
  const unreadNumEl   = $('#unreadCountNum');

  function countUnread(){
    return $$('.n-card').filter(c => !c.classList.contains('read')).length;
  }

  function renderUnread(){
    if(!unreadCountEl || !unreadNumEl) return;
    const n = countUnread();
    unreadNumEl.textContent = String(n);
    unreadCountEl.style.display = (n > 0) ? '' : 'none';
  }

  const onlyUnread = $('#onlyUnread');

  function applyFilters(){
    const only = !!(onlyUnread && onlyUnread.checked);
    $$('.n-card').forEach(c=>{
      const isRead = c.classList.contains('read');
      const passUnread = !only || !isRead;
      c.style.display = (passUnread) ? '' : 'none';
    });
  }

  if(onlyUnread){
    try{
      const saved = localStorage.getItem(LS_ONLY_KEY);
      if(saved === '1') onlyUnread.checked = true;
    }catch(e){
      // ignore
    }

    onlyUnread.addEventListener('change', function(){
      try{ localStorage.setItem(LS_ONLY_KEY, onlyUnread.checked ? '1' : '0'); }catch(e){}
      applyFilters();
    });
  }

  // زر "تحديد الكل" — UI optimistic
  const markAllForm = document.querySelector('form.mark-all');
  const markAllBtn  = $('#markAllBtn');
  if(markAllForm && markAllBtn){
    markAllForm.addEventListener('submit', function(){
      markAllBtn.disabled = true;
      markAllBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin" aria-hidden="true"></i> جاري المعالجة...';
      $$('.n-card').forEach(c => c.classList.add('read'));
      renderUnread();
      applyFilters();
    });
  }

  // وسم إشعار واحد محليًا + منع النقر المزدوج
  $$('.mark-one-form').forEach(function(f){
    f.addEventListener('submit', function(){
      const btn = f.querySelector('.mark-one');
      if(btn){
        btn.disabled = true;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin" aria-hidden="true"></i> جاري المعالجة...';
      }
      const card = f.closest('.n-card');
      if(card) card.classList.add('read');
      renderUnread();
      applyFilters();
    });
  });

  renderUnread();
  applyFilters();
});
</script>
{% endblock %}
