{# reports/templates/reports/ticket_detail.html #}
{% extends "base.html" %}
{% load static ticket_notes %}

{% block title %}
  {% if t.is_platform %}دعم فني #{{ t.id }} - {{ t.title }}{% else %}طلب #{{ t.id }} - {{ t.title }}{% endif %}
{% endblock %}

{% block head %}
<style>
/* =========================================================
   Neo-Professional 2026 Ticket Detail System
   - Luxuriously clean, distinct, and unambiguous.
   ========================================================= */

:root {
  /* Unified Palette */
  --c-brand: #2563eb;       /* Brand Blue */
  --c-brand-rgb: 37, 99, 235;
  --c-text: #0f172a;        /* Slate 900 */
  --c-text-muted: #64748b;  /* Slate 500 */
  --c-surface: #ffffff;
  --c-surface-alt: #f8fafc; /* Slate 50 */
  --c-border: #e2e8f0;      /* Slate 200 */
  
  /* Type Specific Colors (Crucial for distinction) */
  --c-platform: #7c3aed;    /* Violet for Tech Support */
  --c-platform-bg: #f5f3ff;
  --c-request: #0ea5e9;     /* Sky for Requests */
  --c-request-bg: #f0f9ff;

  /* Status Colors */
  --s-new: #3b82f6; --s-new-bg: #eff6ff;
  --s-pro: #8b5cf6; --s-pro-bg: #f5f3ff;
  --s-don: #10b981; --s-don-bg: #ecfdf5;
  --s-rej: #ef4444; --s-rej-bg: #fef2f2;
}

.ticket-wrapper {
  max-width: 1200px;
  margin: 0 auto;
  font-family: 'Tajawal', sans-serif;
  color: var(--c-text);
  padding-bottom: 60px;
}

/* 1. Header Hero Section */
.hero-header {
  background: var(--c-surface);
  border: 1px solid var(--c-border);
  border-radius: 16px;
  box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
  margin-bottom: 24px;
  overflow: hidden;
  position: relative;
}

/* Distinct Top Stripe */
.hero-stripe {
  height: 6px;
  width: 100%;
  background: var(--c-request); /* Default */
}
.hero-stripe.is-platform { background: var(--c-platform); }

.hero-body {
  padding: 24px 32px;
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  flex-wrap: wrap;
  gap: 20px;
}

.hero-main {
  flex: 1;
  min-width: 300px;
}

.ticket-badges {
  display: flex;
  gap: 8px;
  margin-bottom: 12px;
  align-items: center;
}

.badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 10px;
  border-radius: 6px;
  font-size: 0.8rem;
  font-weight: 700;
  letter-spacing: 0.02em;
}

.badge-id {
  background: var(--c-surface-alt);
  color: var(--c-text-muted);
  border: 1px solid var(--c-border);
  font-family: 'Fira Code', monospace;
}

.badge-type {
  background: var(--c-request-bg);
  color: var(--c-request);
  border: 1px solid rgba(14, 165, 233, 0.2);
}
.badge-type.platform {
  background: var(--c-platform-bg);
  color: var(--c-platform);
  border-color: rgba(124, 58, 237, 0.2);
}

.hero-title {
  margin: 0 0 8px 0;
  font-size: 1.75rem;
  font-weight: 800;
  line-height: 1.3;
  color: var(--c-text);
}

.hero-meta {
  display: flex;
  gap: 16px;
  color: var(--c-text-muted);
  font-size: 0.9rem;
  font-weight: 500;
  flex-wrap: wrap;
}
.hero-meta span { display: flex; align-items: center; gap: 6px; }

/* Status Pill */
.status-pill {
  padding: 8px 16px;
  border-radius: 99px;
  font-weight: 700;
  font-size: 0.9rem;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  border: 1px solid transparent;
}
.st-open { background: var(--s-new-bg); color: var(--s-new); border-color: rgba(59,130,246,0.2); }
.st-in_progress { background: var(--s-pro-bg); color: var(--s-pro); border-color: rgba(139,92,246,0.2); }
.st-done { background: var(--s-don-bg); color: var(--s-don); border-color: rgba(16,185,129,0.2); }
.st-rejected { background: var(--s-rej-bg); color: var(--s-rej); border-color: rgba(239,68,68,0.2); }

/* 2. Grid Layout */
.layout-grid {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: 24px;
}
@media (max-width: 900px) {
  .layout-grid { grid-template-columns: 1fr; }
}

/* 3. Cards */
.lux-card {
  background: var(--c-surface);
  border: 1px solid var(--c-border);
  border-radius: 12px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.02);
  margin-bottom: 24px;
  overflow: hidden;
}
.lux-card-header {
  padding: 16px 20px;
  border-bottom: 1px solid var(--c-border);
  background: var(--c-surface-alt);
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.lux-card-title {
  margin: 0;
  font-size: 1.05rem;
  font-weight: 700;
  color: var(--c-text);
  display: flex;
  align-items: center;
  gap: 10px;
}
.lux-card-body {
  padding: 24px;
}

/* Details List */
.details-list {
  display: flex;
  flex-direction: column;
  gap: 16px;
}
.dl-item {
  display: grid;
  grid-template-columns: 140px 1fr;
  gap: 16px;
  align-items: baseline;
}
@media (max-width: 600px) { .dl-item { grid-template-columns: 1fr; gap: 4px; } }

.dl-label {
  font-size: 0.9rem;
  font-weight: 600;
  color: var(--c-text-muted);
}
.dl-value {
  font-size: 1rem;
  font-weight: 500;
  color: var(--c-text);
  line-height: 1.6;
}
.dl-value.pre {
  white-space: pre-wrap;
  background: var(--c-surface-alt);
  padding: 12px;
  border-radius: 8px;
  border: 1px solid var(--c-border);
  font-size: 0.95rem;
}

/* Actions Buttons in Sidebar */
.action-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  width: 100%;
  padding: 12px;
  border-radius: 8px;
  font-weight: 600;
  text-decoration: none;
  transition: all 0.2s;
  border: 1px solid var(--c-border);
  background: var(--c-surface);
  color: var(--c-text);
  cursor: pointer;
  margin-bottom: 8px;
}
.action-btn:hover { background: var(--c-surface-alt); border-color: #cbd5e1; }
.action-btn.primary {
  background: var(--c-brand);
  color: #fff;
  border-color: var(--c-brand);
  box-shadow: 0 4px 6px rgba(37,99,235,0.2);
}
.action-btn.primary:hover {
  background: #1d4ed8;
  transform: translateY(-1px);
}

/* Notes Feed */
.notes-feed {
  display: flex;
  flex-direction: column;
  gap: 16px;
}
.note-bubble {
  border: 1px solid var(--c-border);
  border-radius: 12px;
  padding: 16px;
  background: var(--c-surface);
  position: relative;
}
.note-bubble.is-mine {
  background: #eff6ff; /* Light Blue tint */
  border-color: #bfdbfe;
}
.note-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 8px;
  font-size: 0.85rem;
  color: var(--c-text-muted);
}
.note-author {
  font-weight: 700;
  color: var(--c-text);
}
.note-content {
  line-height: 1.6;
  white-space: pre-wrap;
}

/* Inputs */
.lux-input, .lux-select, .lux-textarea {
  width: 100%;
  padding: 12px;
  border: 1px solid #cbd5e1;
  border-radius: 8px;
  font-family: inherit;
  font-size: 0.95rem;
  transition: border 0.2s;
}
.lux-input:focus, .lux-select:focus, .lux-textarea:focus {
  outline: none;
  border-color: var(--c-brand);
  box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
}

/* Gallery */
.gallery-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
  gap: 12px;
  margin-top: 8px;
}
.gallery-item {
  aspect-ratio: 1;
  border-radius: 8px;
  overflow: hidden;
  border: 1px solid var(--c-border);
  position: relative;
  transition: transform 0.2s;
}
.gallery-item:hover { transform: scale(1.02); shadow: 0 4px 6px rgba(0,0,0,0.1); }
.gallery-item img {
  width: 100%; height: 100%; object-fit: cover;
}

/* Lightbox Styles (inline for reliability) */
.lb-overlay {
  position: fixed; inset: 0; z-index: 9999;
  background: rgba(15, 23, 42, 0.9);
  display: none; place-items: center;
  backdrop-filter: blur(4px);
}
.lb-overlay.active { display: grid; }
.lb-img { max-width: 90vw; max-height: 85vh; border-radius: 8px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }
.lb-close {
  position: absolute; top: 20px; right: 20px;
  color: #fff; font-size: 2rem; cursor: pointer; background: none; border: none;
}
</style>
{% endblock %}

{% block content %}
<div class="ticket-wrapper" dir="rtl">

  <!-- 1. HEADER (HERO) -->
  <header class="hero-header">
    <div class="hero-stripe {% if t.is_platform %}is-platform{% endif %}"></div>
    <div class="hero-body">
      <div class="hero-main">
        <div class="ticket-badges">
          <span class="badge badge-id">#{{ t.id }}</span>
          {% if t.is_platform %}
            <span class="badge badge-type platform">
              <i class="fa-solid fa-server"></i> طلب دعم فني (المنصة)
            </span>
          {% else %}
            <span class="badge badge-type">
              <i class="fa-solid fa-file-signature"></i> طلب إداري
            </span>
          {% endif %}
        </div>
        
        <h1 class="hero-title">{{ t.title|default:"(بدون عنوان)" }}</h1>
        
        <div class="hero-meta">
          <span><i class="fa-regular fa-calendar"></i> {{ t.created_at|date:"Y-m-d H:i" }}</span>
          <span><i class="fa-regular fa-user"></i> {{ t.creator.name|default:"غير معروف" }}</span>
          {% if not t.is_platform %}
            <span><i class="fa-solid fa-building-columns"></i> {{ t.department.name|default:"—" }}</span>
          {% endif %}
        </div>
      </div>

      <div class="hero-status">
        <span class="status-pill {% if t.status == 'open' %}st-open{% elif t.status == 'in_progress' %}st-in_progress{% elif t.status == 'done' %}st-done{% else %}st-rejected{% endif %}">
          {% if t.status == 'open' %}<i class="fa-regular fa-circle-dot"></i> جديدة
          {% elif t.status == 'in_progress' %}<i class="fa-solid fa-spinner fa-spin-pulse"></i> قيد التنفيذ
          {% elif t.status == 'done' %}<i class="fa-solid fa-check-circle"></i> مكتملة
          {% else %}<i class="fa-solid fa-ban"></i> {{ t.get_status_display }}{% endif %}
        </span>
      </div>
    </div>
  </header>

  <div class="layout-grid">
    
    <!-- 2. MAIN COLUMN -->
    <main>
      <!-- Description Card -->
      <section class="lux-card">
        <div class="lux-card-header">
          <h3 class="lux-card-title"><i class="fa-solid fa-align-right"></i> تفاصيل الطلب</h3>
        </div>
        <div class="lux-card-body">
          <div class="details-list">
            
            <div class="dl-item">
              <div class="dl-label">نص الطلب:</div>
              <div class="dl-value pre">{{ t.body|default:"—"|linebreaksbr }}</div>
            </div>

            <!-- Attachments -->
            {% if t.attachment or images %}
            <div class="dl-item">
              <div class="dl-label">المرفقات:</div>
              <div class="dl-value">
                <div class="gallery-grid">
                  {% if t.attachment %}
                    {% with att_url=t.attachment.url|lower %}
                      {% if '.jpg' in att_url or '.png' in att_url or '.jpeg' in att_url or '.webp' in att_url %}
                        <a href="{{ t.attachment.url }}" class="gallery-item lightbox-trigger">
                          <img src="{{ t.attachment.url }}" alt="Attachment">
                        </a>
                      {% else %}
                        <a href="{{ t.attachment.url }}" target="_blank" class="gallery-item" style="display:flex;align-items:center;justify-content:center;background:#f1f5f9;color:#64748b;text-decoration:none;">
                          <i class="fa-solid fa-paperclip fa-2x"></i>
                        </a>
                      {% endif %}
                    {% endwith %}
                  {% endif %}
                  
                  {% for im in images %}
                    <a href="{{ im.image.url }}" class="gallery-item lightbox-trigger">
                      <img src="{{ im.image.url }}" alt="Image">
                    </a>
                  {% endfor %}
                </div>
              </div>
            </div>
            {% endif %}

          </div>
        </div>
      </section>

      <!-- Notes / History -->
      <section class="lux-card">
        <div class="lux-card-header">
          <h3 class="lux-card-title"><i class="fa-solid fa-comments"></i> الملاحظات والردود</h3>
        </div>
        <div class="lux-card-body">
          {% if notes %}
            <div class="notes-feed">
              {% for n in notes %}
                <div class="note-bubble {% if n.author_id == request.user.id %}is-mine{% endif %}">
                  <div class="note-header">
                    <span class="note-author">
                      <i class="fa-solid fa-user-circle"></i> {{ n.author.name|default:"مسؤول النظام" }}
                      {% if n.author.display_role_label %}
                        <span style="opacity:0.7;font-weight:400">({{ n.author.display_role_label }})</span>
                      {% endif %}
                    </span>
                    <span>{{ n.created_at|date:"Y-m-d H:i" }}</span>
                  </div>
                  <div class="note-content">{{ n.body|ticket_note_ar|default:""|linebreaksbr }}</div>
                  
                  {% if n.author_id == request.user.id and t.status != 'done' and t.status != 'rejected' %}
                    <div style="margin-top:8px;border-top:1px dashed rgba(0,0,0,0.1);padding-top:4px;text-align:left;">
                        <a href="{% url 'reports:ticket_note_edit' n.id %}?next={{ request.get_full_path|urlencode }}" style="font-size:0.8rem;color:var(--c-brand);text-decoration:none;">
                            <i class="fa-solid fa-pen"></i> تعديل
                        </a>
                    </div>
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div style="text-align:center;padding:20px;color:var(--c-text-muted);">
              <i class="fa-regular fa-comment-dots fa-2x" style="margin-bottom:8px;opacity:0.5"></i>
              <p>لا توجد ملاحظات أو ردود حتى الآن.</p>
            </div>
          {% endif %}
        </div>
      </section>

      <!-- Action Forms -->
      {% if can_act and form %}
        <section class="lux-card" style="border-color:var(--c-brand);">
          <div class="lux-card-header" style="background:var(--c-brand-light);">
            <h3 class="lux-card-title" style="color:var(--c-brand);"><i class="fa-solid fa-gavel"></i> اتخاذ إجراء</h3>
          </div>
          <div class="lux-card-body">
            <form method="post" novalidate>
              {% csrf_token %}
              <div style="margin-bottom:16px;">
                <label class="dl-label" style="display:block;margin-bottom:8px;">تحديث الحالة:</label>
                <select name="status" class="lux-select">
                    {% for value,label in form.fields.status.choices %}
                    <option value="{{ value }}" {% if value == t.status %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
              </div>
              
              <div style="margin-bottom:16px;">
                <label class="dl-label" style="display:block;margin-bottom:8px;">إضافة رد أو ملاحظة:</label>
                {% if t.status == 'done' or t.status == 'rejected' %}
                    <div style="color:red;font-size:0.9rem;">الطلب مغلق (مكتمل أو مرفوض)، لا يمكن إضافة ملاحظات جديدة.</div>
                {% else %}
                    <textarea name="note" class="lux-textarea" rows="4" placeholder="اكتب ردّك هنا..."></textarea>
                {% endif %}
              </div>

              <button type="submit" class="action-btn primary">
                <i class="fa-regular fa-paper-plane"></i> حفظ التحديث
              </button>
            </form>
          </div>
        </section>

      {% elif is_owner and t.status != 'done' and t.status != 'rejected' and not can_act %}
        <section class="lux-card">
            <div class="lux-card-header">
              <h3 class="lux-card-title"><i class="fa-solid fa-reply"></i> إضافة رد</h3>
            </div>
            <div class="lux-card-body">
              <form method="post" novalidate>
                {% csrf_token %}
                <div style="margin-bottom:16px;">
                  <textarea name="note" class="lux-textarea" rows="4" placeholder="هل تود إضافة معلومات أخرى؟"></textarea>
                </div>
                <button type="submit" class="action-btn primary">
                  <i class="fa-solid fa-plus"></i> إضافة الرد
                </button>
              </form>
            </div>
        </section>
      {% endif %}

    </main>

    <!-- 3. SIDEBAR -->
    <aside>
      <!-- Meta Card -->
      <section class="lux-card">
        <div class="lux-card-header">
          <h3 class="lux-card-title"><i class="fa-solid fa-circle-info"></i> معلومات</h3>
        </div>
        <div class="lux-card-body" style="padding:0;">
          <div style="padding:16px; border-bottom:1px solid var(--c-border);">
            <div class="dl-label" style="margin-bottom:4px">الجهة/المدرسة</div>
            <div style="font-weight:600;">
              {% if t.is_platform %}
                <span style="color:var(--c-platform);">إدارة المنصة</span>
              {% else %}
                {{ t.school.name|default:"—" }}
              {% endif %}
            </div>
            {% if t.school.city %}<div style="font-size:0.85rem;color:var(--c-text-muted);">{{ t.school.city }}</div>{% endif %}
          </div>
          
          {% if not t.is_platform %}
          <div style="padding:16px; border-bottom:1px solid var(--c-border);">
             <div class="dl-label" style="margin-bottom:4px">المستلمون</div>
             <div style="font-size:0.9rem;">
                {% if t.recipients.exists %}
                    {% for u in t.recipients.all %}
                    <div style="margin-bottom:2px;"><i class="fa-solid fa-check-double" style="color:var(--s-don);font-size:0.7em;"></i> {{ u.name }}</div>
                    {% endfor %}
                {% else %}
                    {% firstof t.assignee.name t.assignee "—" %}
                {% endif %}
             </div>
          </div>
          {% endif %}
          
          <div style="padding:16px;">
            <div class="dl-label" style="margin-bottom:4px">رابط مباشر</div>
            <input type="text" readonly value="{{ request.build_absolute_uri }}" onclick="this.select()" class="lux-input" style="font-size:0.8rem; color:var(--c-text-muted);">
          </div>
        </div>
      </section>

      <!-- Quick Actions -->
      <section>
        <div style="margin-bottom:8px;font-weight:700;color:var(--c-text-muted);font-size:0.85rem;padding-right:4px;">إجراءات سريعة</div>
        
        <a href="{% url 'reports:ticket_print' t.id %}" target="_blank" class="action-btn">
          <i class="fa-solid fa-print"></i> طباعة الطلب
        </a>

        {% if t.is_platform %}
          <a href="{% url 'reports:my_support_tickets' %}" class="action-btn">
             <i class="fa-solid fa-arrow-right"></i> كل طلبات الدعم
          </a>
        {% elif request.user.is_staff %}
          <a href="{% url 'reports:tickets_inbox' %}" class="action-btn">
             <i class="fa-solid fa-inbox"></i> صندوق الوارد
          </a>
        {% else %}
          <a href="{% url 'reports:my_requests' %}" class="action-btn">
             <i class="fa-solid fa-list-check"></i> طلباتي
          </a>
        {% endif %}
      </section>
    </aside>

  </div>

  <!-- Lightbox Modal -->
  <div class="lb-overlay" id="lightbox">
    <button class="lb-close" id="lb-close">&times;</button>
    <img src="" class="lb-img" id="lb-img">
  </div>

</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const triggers = document.querySelectorAll('.lightbox-trigger');
    const lightbox = document.getElementById('lightbox');
    const lbImg = document.getElementById('lb-img');
    const lbClose = document.getElementById('lb-close');

    triggers.forEach(trig => {
      trig.addEventListener('click', (e) => {
        e.preventDefault();
        const src = trig.getAttribute('href');
        lbImg.src = src;
        lightbox.classList.add('active');
        document.body.style.overflow = 'hidden';
      });
    });

    const closeLb = () => {
        lightbox.classList.remove('active');
        document.body.style.overflow = '';
        setTimeout(() => { lbImg.src = ''; }, 200);
    };

    lbClose.addEventListener('click', closeLb);
    lightbox.addEventListener('click', (e) => {
        if(e.target === lightbox) closeLb();
    });
    document.addEventListener('keydown', (e) => {
        if(e.key === 'Escape' && lightbox.classList.contains('active')) closeLb();
    });
  });
</script>
{% endblock %}
