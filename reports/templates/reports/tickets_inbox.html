{# templates/reports/tickets_inbox.html #}
{% extends "base.html" %}
{% block title %}ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø·Ù„Ø¨Ø§Øª{% endblock %}

{% block head %}
<style>
  .inbox-wrap{max-width:1200px;margin-inline:auto}
  .card{
    background:#fff;border:1px solid #e5e7eb;border-radius:14px;
    box-shadow:0 4px 16px rgba(2,6,23,.06);padding:18px
  }
  .title{margin:0 0 12px;font-weight:900;color:#1f2937}

  /* Filters (use global input/select/button styles) */
  .inbox-filters{display:grid;gap:10px;margin:8px 0 14px}
  .inbox-filters .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;align-items:end}
  .inbox-filters .chk{display:flex;align-items:center;gap:10px;font-weight:900;color:var(--muted)}
  .inbox-filters .actions{display:flex;gap:8px;flex-wrap:wrap}
  @media (max-width:520px){
    .card{padding:14px}
    .inbox-filters .actions .btn{flex:1;justify-content:center}
  }

  /* Ø´Ø§Ø±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© */
  .status-badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;font-size:.8rem;font-weight:900;white-space:nowrap}
  .s-open,.s-new{background:#dcfce7;color:#166534}
  .s-in_progress,.s-pending{background:#ede9fe;color:#5b21b6}
  .s-done{background:#e0f2fe;color:#075985}
  .s-rejected,.s-cancelled{background:#fee2e2;color:#991b1b}

  /* Ø´Ø§Ø±Ø© Ø§Ù„Ù‚Ø³Ù… */
  .dept-chip{display:inline-block;background:#eef2ff;color:#1e40af;border:1px solid #dbeafe;border-radius:999px;padding:3px 10px;font-weight:800;font-size:.8rem}

  /* Ù…ØµØºÙ‘Ø± Ø§Ù„Ù…Ø±ÙÙ‚ (ØµÙˆØ±Ø© ÙÙ‚Ø·) */
  .att-thumb{
    width:42px;height:42px;border-radius:10px;object-fit:cover;
    border:1px solid #e5e7eb; box-shadow:0 2px 10px rgba(2,6,23,.06);
    background:#f8fafc; display:inline-block;
  }
  .att-empty{color:#94a3b8;font-weight:900}

  /* Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
  .tbl{width:100%;border-collapse:collapse;font-size:14px}
  .tbl th,.tbl td{padding:10px;border-bottom:1px solid #f1f5f9;text-align:right;vertical-align:middle}
  .tbl thead th{background:#f9fafb;border-bottom:1px solid #e5e7eb;color:#0f172a;font-weight:900}
  .actions .btn-open{padding:6px 10px;border-radius:8px;background:#10b981;color:#fff;text-decoration:none;display:inline-block}

  /* Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„: Ù†Ù‚Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¥Ù„Ù‰ Ø¨Ø·Ø§Ù‚Ø§Øª */
  @media(max-width:860px){
    .tbl thead{display:none}
    .tbl, .tbl tbody, .tbl tr, .tbl td{display:block;width:100%}
    .tbl tr{border:1px solid #e5e7eb;border-radius:12px;margin:10px 0;background:#fff;overflow:hidden}
    .tbl td{border-bottom:1px dashed #e5e7eb}
    .tbl td:last-child{border-bottom:0}
    .tbl td[data-label]::before{
      content:attr(data-label);
      font-weight:900;color:#1f2937;display:inline-block;margin-inline-start:6px
    }
    .actions{display:flex;justify-content:flex-start;gap:8px}
  }
</style>
{% endblock %}

{% block content %}
<div class="container inbox-wrap" dir="rtl">
  <div class="card">
    <h2 class="title">ğŸ“¥ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h2>

    <form method="get" class="inbox-filters" aria-label="ÙÙ„ØªØ±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª" novalidate>
      <div class="grid">
        <input type="text" name="q" value="{{ q }}" class="input" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†/Ø§Ù„ØªÙØ§ØµÙŠÙ„">
        <select name="status" class="select">
          <option value="">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
          {% for v,lbl in status_choices %}
            <option value="{{ v }}" {% if status == v %}selected{% endif %}>{{ lbl }}</option>
          {% endfor %}
        </select>
        <label class="chk">
          <input type="checkbox" name="mine" value="1" {% if mine %}checked{% endif %}>
          Ø§Ù„Ù…Ø¹ÙŠÙ‘Ù†Ø© Ù„ÙŠ ÙÙ‚Ø·
        </label>
      </div>

      <div class="actions">
        <button class="btn btn-primary" type="submit">ØªØ·Ø¨ÙŠÙ‚</button>
        {% if q or status or mine %}
          <a href="{% url 'reports:tickets_inbox' %}" class="btn btn-outline">Ù…Ø³Ø­</a>
        {% endif %}
      </div>
    </form>

    <div class="table-responsive" style="overflow:auto;">
      <table class="tbl">
        <thead>
          <tr>
            <th>#</th>
            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            <th>Ø§Ù„Ù…Ø±Ø³Ù„</th>
            <th>Ø§Ù„Ù‚Ø³Ù…</th>
            <th>Ø§Ù„Ù…Ø³ØªÙ„Ù…ÙˆÙ†</th>
            <th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
            <th>Ø§Ù„Ù…Ø±ÙÙ‚</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr>
        </thead>

        <tbody>
          {% for t in tickets %}
            <tr>
              <td data-label="#"> {{ t.pk }} </td>
              <td data-label="Ø§Ù„ØªØ§Ø±ÙŠØ®"> {{ t.created_at|date:"Y-m-d H:i" }} </td>
              <td data-label="Ø§Ù„Ù…Ø±Ø³Ù„"> {{ t.creator.name|default:"â€”" }} </td>

              {# âœ… Ø§Ù„Ù‚Ø³Ù…: ÙŠØ¯Ø¹Ù… ForeignKey Ø£Ùˆ choices Ù…Ø¹ Ø¨Ø¯ÙŠÙ„ Ø¢Ù…Ù† #}
              <td data-label="Ø§Ù„Ù‚Ø³Ù…">
                {% if t.department %}
                  <span class="dept-chip">{{ t.department.name|default:t.department }}</span>
                {% else %}
                  <span class="dept-chip">{{ t.get_department_display|default:"â€”" }}</span>
                {% endif %}
              </td>

              <td data-label="Ø§Ù„Ù…Ø³ØªÙ„Ù…ÙˆÙ†">
                {% if t.recipients.exists %}
                  {% for u in t.recipients.all %}
                    {{ u.name|default:u }}{% if not forloop.last %}ØŒ {% endif %}
                  {% endfor %}
                {% else %}
                  {{ t.assignee.name|default:"â€”" }}
                {% endif %}
              </td>
              <td data-label="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†"> {{ t.title }} </td>

              {# âœ… Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª ØµÙˆØ± ÙÙ‚Ø·: Ù†Ø¹Ø±Ø¶ Ù…ØµØºÙ‘Ø± Ù„Ùˆ ÙˆØ¬Ø¯ #}
              <td data-label="Ø§Ù„Ù…Ø±ÙÙ‚">
                {% if t.attachment %}
                  <a href="{{ t.attachment.url }}" target="_blank" rel="noopener" title="ÙØªØ­ Ø§Ù„Ù…Ø±ÙÙ‚">
                    <img class="att-thumb" src="{{ t.attachment.url }}" alt="Ù…Ø±ÙÙ‚ Ø§Ù„Ø·Ù„Ø¨" loading="lazy">
                  </a>
                {% else %}
                  <span class="att-empty">â€”</span>
                {% endif %}
              </td>

              {# âœ… Ø´Ø§Ø±Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù„ÙˆÙ†Ø© #}
              <td data-label="Ø§Ù„Ø­Ø§Ù„Ø©">
                <span class="status-badge s-{{ t.status|default:'open' }}">
                  {{ t.get_status_display|default:t.status }}
                </span>
              </td>

              <td data-label="Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª" class="actions">
                <a href="{% url 'reports:ticket_detail' t.pk %}" class="btn-open">ÙØªØ­</a>
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="9" style="text-align:center;padding:14px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  </div>
</div>
{% endblock %}
