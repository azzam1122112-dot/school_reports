{% extends "base.html" %}
{% block title %}{% if mode == "edit" %}تعديل مدير مدرسة{% else %}إنشاء مدير مدرسة{% endif %}{% endblock %}

{% block head %}
<style>
  .schools-scope .schools-list{
    max-height:240px;
    overflow:auto;
    border: 1px solid var(--line-2);
    border-radius: 14px;
    padding: 10px;
    background: rgba(148,163,184,.10);
  }
  .schools-scope .schools-list label{
    display:flex;align-items:center;gap:10px;
    font-weight:900;margin-bottom:8px;cursor:pointer
  }
  .schools-scope .hint{font-size:.9rem;color:var(--muted);font-weight:850;margin-top:6px}
  .schools-scope .field-error{
    margin-top:8px;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid rgba(239,68,68,.25);
    background: rgba(239,68,68,.08);
    color: var(--danger, #b91c1c);
    font-weight:900;
    font-size:.9rem;
  }
  .schools-scope .schools-actions{
    display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:8px 0 10px
  }
</style>
{% endblock %}

{% block content %}
<div class="container schools-scope" dir="rtl">
  <div class="page-head" style="max-width:780px;margin-inline:auto">
    <div>
      <h1 class="page-title">{% if mode == "edit" %}تعديل مدير مدرسة{% else %}إنشاء مدير مدرسة{% endif %}</h1>
      <p class="page-subtitle">
        {% if mode == "edit" and manager %}
          تحديث بيانات المدير وربطه بالمدارس المناسبة.
        {% else %}
          إنشاء حساب مدير وربطه بمدرسة واحدة على الأقل.
        {% endif %}
      </p>
    </div>
  </div>

  <div style="max-width:780px;margin-inline:auto">
    <div class="card">
      {% if mode == "edit" and manager %}
        <div class="badge info" style="margin-bottom:10px">المدير الحالي: {{ manager.name }}</div>
      {% else %}
        <div class="badge info" style="margin-bottom:10px">يمكن ربط المدير بعدة مدارس.</div>
      {% endif %}

      {% if form.non_field_errors %}
        <div class="msg error" data-autohide="false" style="margin-bottom:10px;">
          {% for err in form.non_field_errors %}{{ err }}<br>{% endfor %}
        </div>
      {% endif %}

      <form method="post" novalidate class="form-grid" id="manager-form">
        {% csrf_token %}

        <div style="display:grid;gap:12px;grid-template-columns:1fr">

          <div style="display:grid;gap:12px;grid-template-columns:1fr">
            <div>
              <label for="{{ form.name.id_for_label }}" style="display:block;font-weight:950;margin-bottom:6px;color:var(--ink)">اسم المدير</label>
              {{ form.name }}
              {% for e in form.name.errors %}<div class="field-error">• {{ e }}</div>{% endfor %}
            </div>

            <div>
              <label for="{{ form.phone.id_for_label }}" style="display:block;font-weight:950;margin-bottom:6px;color:var(--ink)">رقم الجوال (اسم المستخدم)</label>
              {{ form.phone }}
              <div class="hint">سيُستخدم رقم الجوال لتسجيل الدخول.</div>
              {% for e in form.phone.errors %}<div class="field-error">• {{ e }}</div>{% endfor %}
            </div>

            <div>
              <label for="{{ form.national_id.id_for_label }}" style="display:block;font-weight:950;margin-bottom:6px;color:var(--ink)">الهوية الوطنية (اختياري)</label>
              {{ form.national_id }}
              {% for e in form.national_id.errors %}<div class="field-error">• {{ e }}</div>{% endfor %}
            </div>

            <div>
              <label for="{{ form.password.id_for_label }}" style="display:block;font-weight:950;margin-bottom:6px;color:var(--ink)">كلمة المرور</label>
              {{ form.password }}
              {% if mode == "edit" %}
                <div class="hint">اتركها فارغة إذا لا تريد تغيير كلمة المرور.</div>
              {% endif %}
              {% for e in form.password.errors %}<div class="field-error">• {{ e }}</div>{% endfor %}
            </div>

            <div>
              <label for="{{ form.is_active.id_for_label }}" style="display:block;font-weight:950;margin-bottom:6px;color:var(--ink)">حالة الحساب</label>
              {{ form.is_active }}
              {% for e in form.is_active.errors %}<div class="field-error">• {{ e }}</div>{% endfor %}
            </div>
          </div>

          <div>
            <label style="display:block;font-weight:950;margin-bottom:6px;color:var(--ink)">المدارس المرتبطة بالمدير</label>

            <div class="schools-actions">
              <input type="search" id="managerSchoolsSearch" class="input" placeholder="ابحث عن مدرسة..." autocomplete="off" spellcheck="false" style="min-width:240px">
              <button type="button" class="btn btn-outline" id="selectAllSchools" style="padding:8px 10px;min-height:38px">تحديد الكل</button>
              <button type="button" class="btn btn-outline" id="clearAllSchools" style="padding:8px 10px;min-height:38px">مسح</button>
            </div>

            <div class="schools-list" id="schoolsList">
              {% if schools %}
                {% for s in schools %}
                  <label class="school-item">
                    <input type="checkbox" class="school-check" name="schools" value="{{ s.id }}"
                      {% if s.id|stringformat:"s" in selected_ids %}checked{% endif %}>
                    <span>{{ s.name }}</span>
                    {% if s.city %}<span class="hint">- {{ s.city }}</span>{% endif %}
                  </label>
                {% endfor %}
              {% else %}
                <p class="hint">لا توجد مدارس نشطة حتى الآن. قم بإنشاء مدرسة أولاً من "إدارة المدارس".</p>
              {% endif %}
            </div>

            <div class="hint">يجب اختيار مدرسة واحدة على الأقل.</div>
            <div class="field-error" id="schoolsError" style="display:none">• اختر مدرسة واحدة على الأقل.</div>
          </div>

        </div>

        <div>
          <button type="submit" class="btn btn-primary">
            {% if mode == "edit" %}حفظ التعديلات{% else %}حفظ وإنشاء المدير{% endif %}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
(function(){
  const search = document.getElementById('managerSchoolsSearch');
  const items = Array.from(document.querySelectorAll('.schools-list .school-item'));
  const checks = Array.from(document.querySelectorAll('.school-check'));
  const selectAll = document.getElementById('selectAllSchools');
  const clearAll = document.getElementById('clearAllSchools');
  const form = document.getElementById('manager-form');
  const err = document.getElementById('schoolsError');

  if(search){
    search.addEventListener('input', function(){
      const q = (this.value || '').trim().toLowerCase();
      items.forEach(function(el){
        const txt = (el.textContent || '').toLowerCase();
        el.style.display = (!q || txt.includes(q)) ? '' : 'none';
      });
    });
  }

  function setAll(val){
    checks.forEach(c => c.checked = !!val);
  }

  selectAll?.addEventListener('click', () => setAll(true));
  clearAll?.addEventListener('click', () => setAll(false));

  function hasOneSelected(){
    return checks.some(c => c.checked);
  }

  // تحقق سريع قبل الإرسال (لا يغني عن تحقق السيرفر)
  form?.addEventListener('submit', (e) => {
    if(!checks.length) return;
    if(!hasOneSelected()){
      e.preventDefault();
      if(err) err.style.display = 'block';
      document.getElementById('schoolsList')?.scrollIntoView({behavior:'smooth', block:'center'});
    } else {
      if(err) err.style.display = 'none';
    }
  });

  checks.forEach(c => c.addEventListener('change', () => {
    if(err) err.style.display = hasOneSelected() ? 'none' : 'block';
  }));
})();
</script>
{% endblock %}
