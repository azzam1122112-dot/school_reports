{% extends "base.html" %}
{% block title %}{% if mode == "edit" %}تعديل مدير مدرسة{% else %}إنشاء مدير مدرسة{% endif %}{% endblock %}

{% block head %}
<style>
  .schools-scope .schools-list{
    max-height:240px;
    overflow:auto;
    border: 1px solid var(--line-2);
    border-radius: 14px;
    padding: 10px;
    background: rgba(148,163,184,.10);
  }
  .schools-scope .schools-list label{display:flex;align-items:center;gap:10px;font-weight:900;margin-bottom:8px;cursor:pointer}
  .schools-scope .hint{font-size:.9rem;color:var(--muted);font-weight:850;margin-top:6px}
</style>
{% endblock %}

{% block content %}
<div class="container schools-scope" dir="rtl">
  <div class="page-head" style="max-width:780px;margin-inline:auto">
    <div>
      <h1 class="page-title">{% if mode == "edit" %}تعديل مدير مدرسة{% else %}إنشاء مدير مدرسة{% endif %}</h1>
      <p class="page-subtitle">{% if mode == "edit" and manager %}تحديث بيانات المدير وربطه بالمدارس المناسبة.{% else %}إنشاء حساب مدير وربطه بمدرسة واحدة على الأقل.{% endif %}</p>
    </div>
  </div>

  <div style="max-width:780px;margin-inline:auto">
  <div class="card">
    {% if mode == "edit" and manager %}
      <div class="badge info" style="margin-bottom:10px">المدير الحالي: {{ manager.name }}</div>
    {% else %}
      <div class="badge info" style="margin-bottom:10px">يمكن ربط المدير بعدة مدارس.</div>
    {% endif %}

    {# أخطاء عامة للنموذج #}
    {% if form.non_field_errors %}
      <div class="msg error" data-autohide="false" style="margin-bottom:10px;">
        {% for err in form.non_field_errors %}{{ err }}<br>{% endfor %}
      </div>
    {% endif %}

    <form method="post" novalidate class="form-grid">
      {% csrf_token %}

      <div style="display:grid;gap:12px;grid-template-columns:1fr">
        <div style="display:grid;gap:12px;grid-template-columns:1fr">
          <div>
            <label for="id_name" style="display:block;font-weight:950;margin-bottom:6px;color:var(--ink)">اسم المدير</label>
            {{ form.name }}
            {{ form.name.errors }}
          </div>
          <div>
            <label for="id_phone" style="display:block;font-weight:950;margin-bottom:6px;color:var(--ink)">رقم الجوال (اسم المستخدم)</label>
            {{ form.phone }}
            <div class="hint">سيُستخدم رقم الجوال لتسجيل الدخول.</div>
            {{ form.phone.errors }}
          </div>
          <div>
            <label for="id_national_id" style="display:block;font-weight:950;margin-bottom:6px;color:var(--ink)">الهوية الوطنية (اختياري)</label>
            {{ form.national_id }}
            {{ form.national_id.errors }}
          </div>
          <div>
            <label for="id_password" style="display:block;font-weight:950;margin-bottom:6px;color:var(--ink)">كلمة المرور</label>
            {{ form.password }}
            {{ form.password.errors }}
          </div>
          <div>
            <label for="id_is_active" style="display:block;font-weight:950;margin-bottom:6px;color:var(--ink)">حالة الحساب</label>
            {{ form.is_active }}
            {{ form.is_active.errors }}
          </div>
        </div>

        <div>
          <label style="display:block;font-weight:950;margin-bottom:6px;color:var(--ink)">المدارس المرتبطة بالمدير</label>
          <div class="schools-list">
            {% if schools %}
              <input type="search" id="managerSchoolsSearch" placeholder="ابحث عن مدرسة" style="margin-bottom:10px">
              {% for s in schools %}
                <label class="school-item">
                  <input type="checkbox" name="schools" value="{{ s.id }}" {% if s.id|stringformat:"s" in selected_ids %}checked{% endif %}>
                  <span>{{ s.name }}</span>
                  {% if s.city %}<span class="hint">- {{ s.city }}</span>{% endif %}
                </label>
              {% endfor %}
            {% else %}
              <p class="hint">لا توجد مدارس نشطة حتى الآن. قم بإنشاء مدرسة أولاً من "إدارة المدارس".</p>
            {% endif %}
          </div>
          <div class="hint">يجب اختيار مدرسة واحدة على الأقل.</div>
        </div>
      </div>

      <div>
        <button type="submit" class="btn btn-primary">{% if mode == "edit" %}حفظ التعديلات{% else %}حفظ وإنشاء المدير{% endif %}</button>
      </div>
    </form>
  </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
  (function(){
    const input = document.getElementById('managerSchoolsSearch');
    if(!input) return;
    const items = Array.from(document.querySelectorAll('.schools-list .school-item'));
    input.addEventListener('input', function(){
      const q = this.value.trim().toLowerCase();
      items.forEach(function(el){
        const txt = (el.textContent || '').toLowerCase();
        el.style.display = (!q || txt.includes(q)) ? '' : 'none';
      });
    });
  })();
</script>
{% endblock %}
