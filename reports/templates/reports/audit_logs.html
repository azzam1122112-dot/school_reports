{# reports/templates/reports/school_audit_logs.html #}
{% extends "base.html" %}
{% load static %}

{% block title %}ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª - {{ active_school.name }}{% endblock %}

{% block head %}
<style>
  /* =========================================================
     AUDIT LOGS (page-only polish)
     - Scoped Ø¯Ø§Ø®Ù„ .audit-wrap Ù„ØªØ¬Ù†Ø¨ ØªØ¹Ø§Ø±Ø¶Ø§Øª app.css
     - Ù„Ø§ Ù†Ø¹ÙŠØ¯ ØªØ¹Ø±ÙŠÙ .btn / .card Ø§Ù„Ø¹Ø§Ù…Ø©
     - Ù…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ data-theme (ÙØ§ØªØ­/Ø¯Ø§ÙƒÙ†)
     - RTL + Mobile-first + Table scroll
     ========================================================= */

  .audit-wrap{
    --a-brand: #2563eb;
    --a-brand-2: rgba(37,99,235,.10);
    --a-shadow: 0 18px 50px rgba(2,6,23,.10);
    --a-radius: 18px;
    --a-t: var(--t-fast);
  }

  .audit-hero{
    border-radius: var(--a-radius);
    border: 1px solid var(--line);
    background: linear-gradient(180deg, var(--line-2), var(--card));
    box-shadow: var(--a-shadow);
    overflow:hidden;
  }

  .audit-hd{
    padding: 16px 16px;
    display:flex;
    gap:12px;
    align-items:flex-start;
    justify-content:space-between;
    flex-wrap:wrap;
    border-bottom: 1px solid var(--line);
    background:
      radial-gradient(800px 220px at 10% 0%, rgba(37,99,235,.12), transparent 55%),
      radial-gradient(700px 220px at 95% 100%, rgba(16,185,129,.10), transparent 60%),
      linear-gradient(180deg, var(--line-2), var(--card));
  }

  .audit-title{
    margin:0;
    font-weight: 950;
    letter-spacing: -.4px;
    display:flex;
    align-items:center;
    gap:10px;
    color: var(--ink);
    font-size: clamp(1.05rem, 2.2vw, 1.35rem);
  }

  .audit-hint{
    color: var(--muted);
    font-weight: 850;
    font-size: .95rem;
    margin-top: 4px;
  }

  .audit-actions{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    align-items:center;
  }

  /* Filter bar */
  .audit-filter{
    padding: 14px 16px;
    border-bottom: 1px solid var(--line);
    background:
      radial-gradient(600px 200px at 0% 0%, rgba(37,99,235,.10), transparent 60%),
      linear-gradient(180deg, var(--card), var(--line-2));
  }

  .audit-grid{
    display:grid;
    gap:10px;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    align-items:end;
  }

  .ig{ display:flex; flex-direction:column; gap:6px; }
  .ig label{
    font-size: .82rem;
    font-weight: 900;
    color: var(--muted);
  }

  .inp{
    width:100%;
    padding: 10px 12px;
    border-radius: 12px;
    border: 1px solid var(--line);
    background: var(--card);
    color: var(--ink);
    font: inherit;
    font-weight: 850;
    outline: none;
    transition: var(--a-t);
  }
  .inp:focus{
    box-shadow: 0 0 0 4px rgba(37,99,235,.16);
    border-color: rgba(37,99,235,.35);
  }

  .filter-actions{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    align-items:center;
  }

  /* Table */
  .audit-table-wrap{
    overflow:auto;
    -webkit-overflow-scrolling: touch;
  }

  table.audit-table{
    width:100%;
    border-collapse: separate;
    border-spacing: 0;
    min-width: 880px;
    text-align:right;
  }

  .audit-table thead th{
    position: sticky;
    top: 0;
    z-index: 2;
    background: var(--line-2);
    color: var(--muted);
    font-weight: 950;
    font-size: .9rem;
    padding: 12px 12px;
    border-bottom: 1px solid var(--line);
    white-space:nowrap;
  }

  .audit-table tbody td{
    padding: 12px 12px;
    border-bottom: 1px solid var(--line);
    vertical-align: middle;
    font-size: .95rem;
    color: var(--ink);
  }

  .audit-table tbody tr:hover td{
    background: rgba(219,234,254,.45);
  }
  html[data-theme="dark"] .audit-table tbody tr:hover td{
    background: rgba(26,44,83,.45);
  }

  .ts{
    font-weight: 850;
    color: var(--muted);
    font-size: .9rem;
    white-space:nowrap;
  }

  .teacher{
    display:flex;
    align-items:center;
    gap:10px;
    min-width: 180px;
  }
  .avatar{
    width: 32px; height: 32px;
    border-radius: 999px;
    background: rgba(37,99,235,.12);
    border: 1px solid rgba(37,99,235,.18);
    display:grid; place-items:center;
    color: rgba(37,99,235,.95);
    flex: 0 0 auto;
    font-weight: 950;
  }
  .teacher .name{
    font-weight: 950;
    color: var(--ink);
    line-height: 1.2;
  }
  .teacher .sub{
    color: var(--muted);
    font-weight: 850;
    font-size: .82rem;
    margin-top: 2px;
  }

  .badge{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding: 6px 10px;
    border-radius: 999px;
    font-weight: 950;
    font-size: .82rem;
    white-space:nowrap;
    border: 1px solid transparent;
  }
  .b-create{ background: rgba(16,185,129,.12); color:#166534; border-color: rgba(16,185,129,.18); }
  .b-update{ background: rgba(99,102,241,.12); color:#3730a3; border-color: rgba(99,102,241,.20); }
  .b-delete{ background: rgba(239,68,68,.12); color:#991b1b; border-color: rgba(239,68,68,.20); }
  .b-login { background: rgba(245,158,11,.14); color:#854d0e; border-color: rgba(245,158,11,.24); }
  .b-other { background: rgba(100,116,139,.12); color:#334155; border-color: rgba(100,116,139,.20); }

  .model-pill{
    display:inline-flex;
    align-items:center;
    padding: 4px 10px;
    border-radius: 10px;
    background: rgba(37,99,235,.10);
    border: 1px solid rgba(37,99,235,.18);
    color: rgba(30,64,175,.95);
    font-weight: 950;
    font-size: .82rem;
    white-space:nowrap;
  }
  html[data-theme="dark"] .model-pill{
    color: rgba(191,219,254,.95);
    background: rgba(37,99,235,.16);
    border-color: rgba(37,99,235,.25);
  }

  .obj{
    font-weight: 850;
    color: var(--ink);
    max-width: 520px;
    overflow:hidden;
    text-overflow: ellipsis;
    white-space:nowrap;
  }

  .ip{
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size: .85rem;
    color: var(--muted);
    font-weight: 850;
    white-space:nowrap;
  }

  /* Empty */
  .audit-empty{
    padding: 48px 16px;
    text-align:center;
    color: var(--muted);
    font-weight: 900;
  }
  .audit-empty .ico{
    font-size: 2rem;
    opacity: .85;
    margin-bottom: 10px;
  }

  /* Pagination */
  .audit-pg{
    padding: 14px 16px;
    display:flex;
    justify-content:center;
    gap:8px;
    align-items:center;
    flex-wrap:wrap;
    background: linear-gradient(180deg, var(--card), var(--line-2));
  }
  .pg-link{
    padding: 8px 12px;
    border-radius: 12px;
    border: 1px solid var(--line);
    background: var(--card);
    color: var(--ink);
    text-decoration:none;
    font-weight: 950;
    transition: var(--a-t);
  }
  .pg-link:hover{
    transform: translateY(-1px);
    box-shadow: 0 10px 22px rgba(2,6,23,.07);
  }
  .pg-active{
    background: var(--a-brand);
    border-color: var(--a-brand);
    color:#fff;
  }

  /* Reduce motion */
  @media (prefers-reduced-motion: reduce){
    .inp, .pg-link{ transition:none !important; }
    .pg-link:hover{ transform:none !important; }
  }
</style>
{% endblock %}

{% block content %}
<div class="audit-wrap">
  <div class="audit-hero">
    <div class="audit-hd">
      <div>
        <h2 class="audit-title">
          <i class="fa-solid fa-clock-rotate-left" style="opacity:.9"></i>
          Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª: {{ active_school.name }}
        </h2>
        <div class="audit-hint">Ù…Ø±Ø§Ù‚Ø¨Ø© ÙƒØ§ÙØ© Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</div>
      </div>

      <div class="audit-actions">
        <a class="btn btn-ghost" href="{% url 'reports:school_audit_logs' %}">
          <i class="fa-solid fa-rotate-right"></i> ØªØ­Ø¯ÙŠØ«
        </a>
      </div>
    </div>

    <!-- Filters -->
    <form method="get" class="audit-filter">
      <div class="audit-grid">
        <div class="ig">
          <label>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
          <select name="teacher" class="inp">
            <option value="">Ø§Ù„ÙƒÙ„</option>
            {% for t in teachers %}
              <option value="{{ t.id }}" {% if q_teacher == t.id|stringformat:"s" %}selected{% endif %}>{{ t.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="ig">
          <label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</label>
          <select name="action" class="inp">
            <option value="">Ø§Ù„ÙƒÙ„</option>
            {% for val, label in actions %}
              <option value="{{ val }}" {% if q_action == val %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="ig">
          <label>Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
          <input type="date" name="start_date" value="{{ q_start }}" class="inp">
        </div>

        <div class="ig">
          <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
          <input type="date" name="end_date" value="{{ q_end }}" class="inp">
        </div>

        <div class="filter-actions">
          <button type="submit" class="btn btn-primary">
            <i class="fa-solid fa-filter"></i> ØªØµÙÙŠØ©
          </button>
          <a href="{% url 'reports:school_audit_logs' %}" class="btn">
            <i class="fa-solid fa-eraser"></i> Ù…Ø³Ø­
          </a>
        </div>
      </div>
    </form>

    <!-- Table -->
    <div class="audit-table-wrap" role="region" aria-label="Ø¬Ø¯ÙˆÙ„ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª">
      <table class="audit-table">
        <thead>
          <tr>
            <th>Ø§Ù„ÙˆÙ‚Øª</th>
            <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
            <th>Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
            <th>Ø§Ù„Ù†ÙˆØ¹</th>
            <th>Ø§Ù„Ø³Ø¬Ù„</th>
            <th>IP</th>
          </tr>
        </thead>
        <tbody>
          {% for log in logs %}
            <tr>
              <td class="ts">{{ log.timestamp|date:"Y-m-d H:i" }}</td>

              <td>
                <div class="teacher">
                  <div class="avatar" aria-hidden="true">
                    {% if log.teacher and log.teacher.name %}
                      {{ log.teacher.name|slice:":1" }}
                    {% elif log.teacher and log.teacher.username %}
                      {{ log.teacher.username|slice:":1" }}
                    {% else %}
                      ØŸ
                    {% endif %}
                  </div>
                  <div>
                    <div class="name">
                      {% if log.teacher %}
                        {% firstof log.teacher.name log.teacher.username "â€”" %}
                      {% else %}
                        â€”
                      {% endif %}
                    </div>
                    <div class="sub">
                      {% if log.teacher %}
                        {% firstof log.teacher.phone log.teacher.username "" %}
                      {% else %}
                        Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ
                      {% endif %}
                    </div>
                  </div>
                </div>
              </td>

              <td>
                <span class="badge
                  {% if log.action == 'create' %}b-create
                  {% elif log.action == 'update' %}b-update
                  {% elif log.action == 'delete' %}b-delete
                  {% elif log.action == 'login' %}b-login
                  {% else %}b-other
                  {% endif %}">
                  {{ log.get_action_display }}
                </span>
              </td>

              <td>
                <span class="model-pill">{{ log.model_name }}</span>
              </td>

              <td class="obj" title="{{ log.object_repr }}">{{ log.object_repr }}</td>

              <td class="ip">{{ log.ip_address|default:"â€”" }}</td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="6">
                <div class="audit-empty">
                  <div class="ico"><i class="fa-solid fa-circle-info"></i></div>
                  Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¨Ø­Ø«.
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    {% if logs.paginator.num_pages > 1 %}
      <div class="audit-pg" aria-label="ØªØ±Ù‚ÙŠÙ… Ø§Ù„ØµÙØ­Ø§Øª">
        {% if logs.has_previous %}
          <a class="pg-link"
             href="?page={{ logs.previous_page_number }}&teacher={{ q_teacher }}&action={{ q_action }}&start_date={{ q_start }}&end_date={{ q_end }}">
            Ø§Ù„Ø³Ø§Ø¨Ù‚
          </a>
        {% endif %}

        <span class="pg-link pg-active">{{ logs.number }} / {{ logs.paginator.num_pages }}</span>

        {% if logs.has_next %}
          <a class="pg-link"
             href="?page={{ logs.next_page_number }}&teacher={{ q_teacher }}&action={{ q_action }}&start_date={{ q_start }}&end_date={{ q_end }}">
            Ø§Ù„ØªØ§Ù„ÙŠ
          </a>
        {% endif %}
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}
