{% extends "base.html" %}
{% load static %}
{% block title %}ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª - {{ active_school.name }}{% endblock %}

{% block head %}
<style>
  :root{
    --brand:#2563eb; --brand-light:#eff6ff;
    --ink:#0f172a; --muted:#64748b;
    --bg:#f1f5f9; --card:#ffffff; --line:#e2e8f0;
    --radius:16px; --shadow:0 4px 20px rgba(0,0,0,0.05);
  }
  body{background:var(--bg); color:var(--ink)}
  .container{max-width:1200px; margin:0 auto; padding:24px 16px}

  .main-card{
    background:var(--card); border-radius:var(--radius); border:1px solid var(--line);
    box-shadow:var(--shadow); overflow:hidden;
  }
  .card-header{
    padding:20px; border-bottom:1px solid var(--line);
    display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:16px;
  }
  .card-title{ font-size:1.4rem; font-weight:900; margin:0; display:flex; align-items:center; gap:10px }

  /* ===== Filters ===== */
  .filter-bar{
    padding:16px 20px; background:var(--brand-light); border-bottom:1px solid var(--line);
    display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:12px; align-items:flex-end;
  }
  .input-group{ display:flex; flex-direction:column; gap:6px }
  .input-group label{ font-size:0.8rem; font-weight:800; color:var(--muted) }
  .input{ 
    padding:10px 14px; border:1px solid var(--line); border-radius:10px; 
    font-family:inherit; font-size:0.95rem; width:100%;
  }
  .btn{
    padding:10px 20px; border-radius:10px; font-weight:800; cursor:pointer;
    display:inline-flex; align-items:center; gap:8px; border:1px solid transparent;
    transition:0.2s; font-family:inherit;
  }
  .btn-primary{ background:var(--brand); color:#fff }
  .btn-outline{ background:#fff; border-color:var(--line); color:var(--ink) }

  /* ===== Table ===== */
  .table-responsive{ overflow-x:auto }
  table{ width:100%; border-collapse:collapse; text-align:right }
  thead th{ 
    background:#f8fafc; padding:14px; font-weight:900; font-size:0.9rem;
    color:var(--muted); border-bottom:2px solid var(--line);
  }
  tbody td{ padding:14px; border-bottom:1px solid var(--line); vertical-align:middle; font-size:0.95rem }
  
  .action-badge{
    padding:4px 10px; border-radius:99px; font-size:0.75rem; font-weight:800;
  }
  .action-create{ background:#dcfce7; color:#166534 }
  .action-update{ background:#e0e7ff; color:#3730a3 }
  .action-delete{ background:#fee2e2; color:#991b1b }
  .action-login{ background:#fef9c3; color:#854d0e }

  .teacher-info{ display:flex; align-items:center; gap:10px }
  .teacher-info img{ width:32px; height:32px; border-radius:50%; object-fit:cover }

  .timestamp{ font-size:0.85rem; color:var(--muted); font-weight:700 }
  .object-repr{ font-weight:700; color:var(--ink) }
  .model-name{ font-size:0.8rem; color:var(--brand); font-weight:800; background:var(--brand-light); padding:2px 8px; border-radius:6px }

  /* Pagination */
  .pagination{ padding:20px; display:flex; justify-content:center; gap:8px; align-items:center }
  .page-link{ 
    padding:8px 16px; border-radius:8px; border:1px solid var(--line); 
    text-decoration:none; color:var(--ink); font-weight:700;
  }
  .page-link.active{ background:var(--brand); color:#fff; border-color:var(--brand) }
</style>
{% endblock %}

{% block content %}
<div class="container">
  <div class="main-card">
    <div class="card-header">
      <h2 class="card-title"><i class="fas fa-history text-primary"></i> Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª: {{ active_school.name }}</h2>
      <div class="hint" style="color:var(--muted); font-size:0.9rem">Ù…Ø±Ø§Ù‚Ø¨Ø© ÙƒØ§ÙØ© Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</div>
    </div>

    <!-- Filter Bar -->
    <form method="get" class="filter-bar">
      <div class="input-group">
        <label>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
        <select name="teacher" class="input">
          <option value="">Ø§Ù„ÙƒÙ„</option>
          {% for t in teachers %}
            <option value="{{ t.id }}" {% if q_teacher == t.id|stringformat:"s" %}selected{% endif %}>{{ t.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="input-group">
        <label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</label>
        <select name="action" class="input">
          <option value="">Ø§Ù„ÙƒÙ„</option>
          {% for val, label in actions %}
            <option value="{{ val }}" {% if q_action == val %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="input-group">
        <label>Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
        <input type="date" name="start_date" value="{{ q_start }}" class="input">
      </div>
      <div class="input-group">
        <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
        <input type="date" name="end_date" value="{{ q_end }}" class="input">
      </div>
      <div style="display:flex; gap:8px">
        <button type="submit" class="btn btn-primary">ØªØµÙÙŠØ©</button>
        <a href="{% url 'reports:school_audit_logs' %}" class="btn btn-outline">Ù…Ø³Ø­</a>
      </div>
    </form>

    <div class="table-responsive">
      <table>
        <thead>
          <tr>
            <th>Ø§Ù„ÙˆÙ‚Øª</th>
            <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
            <th>Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
            <th>Ø§Ù„Ù†ÙˆØ¹</th>
            <th>Ø§Ù„Ø³Ø¬Ù„</th>
            <th>IP</th>
          </tr>
        </thead>
        <tbody>
          {% for log in logs %}
          <tr>
            <td class="timestamp">{{ log.timestamp|date:"Y-m-d H:i" }}</td>
            <td>
              <div class="teacher-info">
                <span>{{ log.teacher.name|default:log.teacher.username }}</span>
              </div>
            </td>
            <td>
              <span class="action-badge 
                {% if log.action == 'create' %}action-create
                {% elif log.action == 'update' %}action-update
                {% elif log.action == 'delete' %}action-delete
                {% elif log.action == 'login' %}action-login
                {% endif %}">
                {{ log.get_action_display }}
              </span>
            </td>
            <td><span class="model-name">{{ log.model_name }}</span></td>
            <td class="object-repr">{{ log.object_repr }}</td>
            <td style="font-family:monospace; font-size:0.8rem; color:var(--muted)">{{ log.ip_address }}</td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="6" style="padding:60px; text-align:center; color:var(--muted)">
              <i class="fas fa-info-circle" style="font-size:2rem; margin-bottom:10px"></i>
              <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¨Ø­Ø«.</p>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    {% if logs.paginator.num_pages > 1 %}
    <div class="pagination">
      {% if logs.has_previous %}
        <a href="?page={{ logs.previous_page_number }}&teacher={{ q_teacher }}&action={{ q_action }}&start_date={{ q_start }}&end_date={{ q_end }}" class="page-link">Ø§Ù„Ø³Ø§Ø¨Ù‚</a>
      {% endif %}
      
      <span class="page-link active">{{ logs.number }} / {{ logs.paginator.num_pages }}</span>

      {% if logs.has_next %}
        <a href="?page={{ logs.next_page_number }}&teacher={{ q_teacher }}&action={{ q_action }}&start_date={{ q_start }}&end_date={{ q_end }}" class="page-link">Ø§Ù„ØªØ§Ù„ÙŠ</a>
      {% endif %}
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}
