{# reports/templates/reports/assigned_to_me.html (Ø£Ùˆ Ø§Ø³Ù… Ù…Ù„ÙÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠ) #}
{% extends "base.html" %}
{% load static %}

{% block title %}Ø§Ù„ØªØ°Ø§ÙƒØ± Ø§Ù„Ù…Ø¹ÙŠÙ‘Ù†Ø© Ù„ÙŠ{% endblock %}

{% block head %}
<style>
  /* âœ… Scoped ÙÙ‚Ø· Ø¯Ø§Ø®Ù„ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© */
  .assigned-page{
    --ap-brand: var(--brand, #2563eb);
    --ap-accent: var(--accent, #10b981);
    --ap-danger: var(--danger, #ef4444);
    --ap-ink: var(--ink, #0f172a);
    --ap-muted: var(--muted, #64748b);
    --ap-line: var(--line-2, var(--line, #e5e7eb));
    --ap-card: var(--card, #fff);
    --ap-shadow: var(--shadow, 0 14px 36px rgba(2,6,23,.10));
    --t: var(--t-fast);
  }

  /* Hero (Ø¨Ø¯ÙˆÙ† ÙƒØ³Ø± Ù‡ÙˆÙŠØ© Ø§Ù„Ù…Ù†ØµØ©) */
  .assigned-page .page-hero{
    background:
      radial-gradient(900px 240px at 20% 0%, rgba(37,99,235,.22), transparent 55%),
      radial-gradient(700px 260px at 85% 75%, rgba(16,185,129,.16), transparent 60%),
      linear-gradient(135deg, rgba(37,99,235,.95), rgba(14,165,233,.88));
    color:#fff;
    border:none;
  }
  .assigned-page .user-badge{
    background: rgba(255,255,255,.14);
    border: 1px solid rgba(255,255,255,.22);
    padding: 8px 12px;
    border-radius: 999px;
    display:flex;
    align-items:center;
    gap:10px;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  }

  /* Stats */
  .assigned-page .stats-grid{
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 12px;
    margin-bottom: 18px;
  }
  .assigned-page .stat-card{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:16px;
  }
  .assigned-page .stat-icon{
    width:42px;height:42px;border-radius:12px;
    display:grid;place-items:center;
    font-size:1.2rem;
  }
  .assigned-page .st-new{background:#ecfdf5;color:var(--ap-accent)}
  .assigned-page .st-pro{background:#f5f3ff;color:#7c3aed}
  .assigned-page .st-don{background:#e0f2fe;color:var(--ap-brand)}
  .assigned-page .st-rej{background:#fee2e2;color:var(--ap-danger)}

  html[data-theme="dark"] .assigned-page .st-new{background:rgba(16,185,129,.14); color:#34d399}
  html[data-theme="dark"] .assigned-page .st-pro{background:rgba(124,58,237,.14); color:#c4b5fd}
  html[data-theme="dark"] .assigned-page .st-don{background:rgba(37,99,235,.14); color:#93c5fd}
  html[data-theme="dark"] .assigned-page .st-rej{background:rgba(239,68,68,.14); color:#fca5a5}

  /* Filters card tweaks */
  .assigned-page .filters .actions{
    display:flex;
    gap:10px;
    justify-content:flex-end;
    flex-wrap:wrap;
    align-items:center;
  }
  .assigned-page .filters .actions .select{width:auto}

  /* View switch */
  .assigned-page .view-switch{
    margin-top:12px;
    border-top:1px solid var(--ap-line);
    padding-top:12px;
    display:flex;
    justify-content:flex-end;
    gap:8px;
    flex-wrap:wrap;
  }
  .assigned-page .view-btn.active{
    background: var(--ap-brand);
    color:#fff;
    border-color: var(--ap-brand);
  }

  /* List item */
  .assigned-page .ticket-item{
    display:grid;
    grid-template-columns: 1fr auto;
    gap: 16px;
    transition: var(--t);
  }
  @media (max-width:768px){
    .assigned-page .ticket-item{grid-template-columns:1fr}
  }

  /* Meter */
  .assigned-page .meter{
    height:6px;
    width:110px;
    background: var(--ap-line);
    border-radius: 999px;
    overflow:hidden;
    margin-top:8px;
  }
  .assigned-page .meter-fill{height:100%;display:block;border-radius:999px}

  /* Badges (âœ… renamed to avoid conflicts) */
  .assigned-page .ap-badge{
    padding:4px 10px;
    border-radius:10px;
    font-size:.85rem;
    font-weight:900;
    display:inline-flex;
    align-items:center;
    gap:6px;
    border:1px solid transparent;
    white-space:nowrap;
  }
  .assigned-page .ap-bg-new{background:#ecfdf5;color:var(--ap-accent);border-color:rgba(16,185,129,.2)}
  .assigned-page .ap-bg-pro{background:#f5f3ff;color:#7c3aed;border-color:rgba(124,58,237,.2)}
  .assigned-page .ap-bg-don{background:#e0f2fe;color:var(--ap-brand);border-color:rgba(37,99,235,.2)}
  .assigned-page .ap-bg-rej{background:#fee2e2;color:var(--ap-danger);border-color:rgba(239,68,68,.2)}
  .assigned-page .ap-bg-oth{background:#f1f5f9;color:#334155;border-color:rgba(148,163,184,.35)}
  html[data-theme="dark"] .assigned-page .ap-bg-oth{background:rgba(148,163,184,.14); color:#e2e8f0; border-color:rgba(148,163,184,.22)}

  /* Table polish */
  .assigned-page .table-wrap table{width:100%;border-collapse:collapse}
  .assigned-page .table-wrap th,
  .assigned-page .table-wrap td{
    padding:12px;
    border-bottom:1px solid var(--ap-line);
    text-align:center;
    vertical-align:middle;
  }
  .assigned-page .table-wrap th{font-weight:900}
  .assigned-page .table-wrap td.title{text-align:right;font-weight:800}
  .assigned-page .table-wrap tr:hover{background:rgba(37,99,235,.04)}
  html[data-theme="dark"] .assigned-page .table-wrap tr:hover{background:rgba(148,163,184,.08)}

  /* Mobile tweaks */
  @media (max-width:520px){
    .assigned-page .filters > div{grid-column:1 / -1 !important}
    .assigned-page .filters .actions{width:100%;flex-direction:column;align-items:stretch}
    .assigned-page .filters .actions .select,
    .assigned-page .filters .actions .btn{width:100%;justify-content:center}
    .assigned-page .view-switch{width:100%;justify-content:stretch}
    .assigned-page .view-switch .btn{flex:1;justify-content:center}
    .assigned-page .ticket-item > div:last-child{align-items:stretch !important}
    .assigned-page .btn-detail{width:100%;justify-content:center}
  }

  /* Reduce motion */
  @media (prefers-reduced-motion: reduce){
    .assigned-page .ticket-item,
    .assigned-page .view-btn{
      transition:none !important;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="container assigned-page" dir="rtl">

  <section class="card page-hero row-between" style="margin-bottom: 18px;">
    <div>
      <h1 style="margin:0; font-weight:950; font-size:1.45rem;">ğŸŸï¸ Ø§Ù„ØªØ°Ø§ÙƒØ± Ø§Ù„Ù…Ø¹ÙŠÙ‘Ù†Ø© Ù„ÙŠ</h1>
      <div style="margin-top:6px; opacity:.92; font-weight:800">
        ØªØ§Ø¨Ø¹ Ø§Ù„ØªØ°Ø§ÙƒØ± Ø§Ù„Ù…Ø³Ù†Ø¯Ø© Ù„Ùƒ Ø¨Ø³Ø±Ø¹Ø©ØŒ ÙˆÙÙ„ØªØ± Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø© Ø£Ùˆ Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¹Ù†ÙˆØ§Ù†.
      </div>
    </div>

    <div class="user-badge">
      <div style="width:34px;height:34px;background:#fff;color:var(--ap-brand);border-radius:50%;display:grid;place-items:center;">
        <i class="fa-solid fa-user"></i>
      </div>
      <div>
        <div style="font-weight:900; line-height:1;">
          {{ request.user.name|default:"Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" }}
        </div>
        <small style="opacity:.92;">
          {% firstof request.user.role "Ù…Ø³ØªØ®Ø¯Ù…" %}
        </small>
      </div>
    </div>
  </section>

  <div class="card" style="margin-bottom: 16px;">
    <form method="get" class="filters" novalidate>
      {# âœ… Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø±Ø¶ Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø­Ø« #}
      <input type="hidden" name="view" value="{{ view_mode|default:'list' }}">

      <div style="grid-column: span 2;">
        <input type="search"
               name="q"
               class="input"
               placeholder="Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„ØªØ°ÙƒØ±Ø© Ø£Ùˆ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†..."
               value="{{ request.GET.q|default:'' }}">
      </div>

      <div>
        <select name="status" class="select">
          <option value="">-- ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª --</option>
          <option value="open" {% if request.GET.status == "open" %}selected{% endif %}>Ø¬Ø¯ÙŠØ¯Ø©</option>
          <option value="in_progress" {% if request.GET.status == "in_progress" %}selected{% endif %}>Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</option>
          <option value="done" {% if request.GET.status == "done" %}selected{% endif %}>Ù…ÙƒØªÙ…Ù„Ø©</option>
          <option value="rejected" {% if request.GET.status == "rejected" %}selected{% endif %}>Ù…Ø±ÙÙˆØ¶Ø©</option>
        </select>
      </div>

      <div class="actions">
        <select name="order" class="select">
          <option value="-created_at" {% if request.GET.order == "-created_at" or not request.GET.order %}selected{% endif %}>Ø§Ù„Ø£Ø­Ø¯Ø«</option>
          <option value="created_at" {% if request.GET.order == "created_at" %}selected{% endif %}>Ø§Ù„Ø£Ù‚Ø¯Ù…</option>
        </select>

        <button type="submit" class="btn btn-primary">
          <i class="fa-solid fa-magnifying-glass"></i> Ø¨Ø­Ø«
        </button>
      </div>
    </form>

    <div class="view-switch">
      {% with bq=request.GET.q|urlencode bs=request.GET.status bo=request.GET.order %}
        <a href="?{% if bq %}q={{ bq }}&{% endif %}{% if bs %}status={{ bs }}&{% endif %}{% if bo %}order={{ bo }}&{% endif %}view=list"
           class="btn btn-outline view-btn {% if view_mode != 'table' %}active{% endif %}"
           style="min-height:36px; padding:6px 12px;">
          <i class="fa-solid fa-list"></i> Ù‚Ø§Ø¦Ù…Ø©
        </a>

        <a href="?{% if bq %}q={{ bq }}&{% endif %}{% if bs %}status={{ bs }}&{% endif %}{% if bo %}order={{ bo }}&{% endif %}view=table"
           class="btn btn-outline view-btn {% if view_mode == 'table' %}active{% endif %}"
           style="min-height:36px; padding:6px 12px;">
          <i class="fa-solid fa-table"></i> Ø¬Ø¯ÙˆÙ„
        </a>
      {% endwith %}
    </div>
  </div>

  <div class="stats-grid">
    <div class="card stat-card">
      <div>
        <div style="font-size:1.55rem;font-weight:950;color:var(--ap-ink)">{{ stats.open|default:"0" }}</div>
        <div class="muted" style="font-weight:800">Ø¬Ø¯ÙŠØ¯Ø©</div>
      </div>
      <div class="stat-icon st-new"><i class="fa-solid fa-envelope-open-text"></i></div>
    </div>

    <div class="card stat-card">
      <div>
        <div style="font-size:1.55rem;font-weight:950;color:var(--ap-ink)">{{ stats.in_progress|default:"0" }}</div>
        <div class="muted" style="font-weight:800">Ø¬Ø§Ø±ÙŠØ©</div>
      </div>
      <div class="stat-icon st-pro"><i class="fa-solid fa-spinner fa-spin-pulse"></i></div>
    </div>

    <div class="card stat-card">
      <div>
        <div style="font-size:1.55rem;font-weight:950;color:var(--ap-ink)">{{ stats.done|default:"0" }}</div>
        <div class="muted" style="font-weight:800">Ù…ÙƒØªÙ…Ù„Ø©</div>
      </div>
      <div class="stat-icon st-don"><i class="fa-solid fa-check-double"></i></div>
    </div>

    <div class="card stat-card">
      <div>
        <div style="font-size:1.55rem;font-weight:950;color:var(--ap-ink)">{{ stats.rejected|default:"0" }}</div>
        <div class="muted" style="font-weight:800">Ù…Ø±ÙÙˆØ¶Ø©</div>
      </div>
      <div class="stat-icon st-rej"><i class="fa-solid fa-xmark"></i></div>
    </div>
  </div>

  {# ===== Helpers Ø¯Ø§Ø®Ù„ Ø§Ù„Ù‚Ø§Ù„Ø¨ (Ø¨Ø¯ÙˆÙ† Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ get_*_display) ===== #}
  {# status label mapping #}
  {% if view_mode == "table" %}
    <div class="card table-wrap">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th style="text-align:right">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
            <th>Ø§Ù„Ù…Ø±Ø³Ù„</th>
            <th>Ø§Ù„Ù‚Ø³Ù…</th>
            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
          </tr>
        </thead>
        <tbody>
          {% for t in page_obj.object_list %}
            <tr>
              <td style="color:var(--ap-brand);font-weight:900;">#{{ t.id }}</td>

              <td class="title">
                <a href="{% url 'reports:ticket_detail' t.id %}" style="text-decoration:none">
                  {{ t.title|default:"â€”" }}
                </a>
              </td>

              <td>{% firstof t.creator.name t.creator.phone "â€”" %}</td>

              <td>
                {% if t.department %}
                  {% if t.department.name %}{{ t.department.name }}
                  {% elif t.department.title %}{{ t.department.title }}
                  {% else %}{{ t.department }}
                  {% endif %}
                {% else %}
                  â€”
                {% endif %}
              </td>

              <td class="muted">{{ t.created_at|date:"Y-m-d" }}</td>

              <td>
                <span class="ap-badge
                  {% if t.status == 'open' %}ap-bg-new
                  {% elif t.status == 'in_progress' %}ap-bg-pro
                  {% elif t.status == 'done' %}ap-bg-don
                  {% elif t.status == 'rejected' %}ap-bg-rej
                  {% else %}ap-bg-oth{% endif %}">
                  {% if t.status == 'open' %}Ø¬Ø¯ÙŠØ¯Ø©
                  {% elif t.status == 'in_progress' %}Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
                  {% elif t.status == 'done' %}Ù…ÙƒØªÙ…Ù„Ø©
                  {% elif t.status == 'rejected' %}Ù…Ø±ÙÙˆØ¶Ø©
                  {% else %}{{ t.status|default:"â€”" }}
                  {% endif %}
                </span>
              </td>

              <td>
                <a href="{% url 'reports:ticket_detail' t.id %}"
                   class="btn btn-outline"
                   style="min-height:32px;padding:4px 10px;font-size:.85rem;">
                  Ø¹Ø±Ø¶
                </a>
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="7" style="padding:34px;text-align:center" class="muted">
                Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ°Ø§ÙƒØ± Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¨Ø­Ø«.
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  {% else %}
    <div class="cards" style="display:grid; gap:12px;">
      {% for t in page_obj.object_list %}
        <div class="card ticket-item">
          <div>
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;flex-wrap:wrap;">
              <span style="background:var(--ap-line);color:var(--ap-brand);padding:2px 8px;border-radius:8px;font-weight:900;font-size:.82rem;">
                #{{ t.id }}
              </span>
              <h3 style="margin:0;font-size:1.1rem;font-weight:950;">
                <a href="{% url 'reports:ticket_detail' t.id %}" style="text-decoration:none">
                  {{ t.title|default:"Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†" }}
                </a>
              </h3>
            </div>

            <div style="display:flex;flex-wrap:wrap;gap:12px;color:var(--ap-muted);font-size:.92rem;font-weight:800;">
              <span><i class="fa-regular fa-user"></i> {% firstof t.creator.name t.creator.phone "â€”" %}</span>
              <span>
                <i class="fa-solid fa-building"></i>
                {% if t.department %}
                  {% if t.department.name %}{{ t.department.name }}
                  {% elif t.department.title %}{{ t.department.title }}
                  {% else %}{{ t.department }}
                  {% endif %}
                {% else %}
                  â€”
                {% endif %}
              </span>
              <span><i class="fa-regular fa-clock"></i> {{ t.created_at|date:"Y-m-d H:i" }}</span>
            </div>
          </div>

          <div style="display:flex;flex-direction:column;align-items:flex-end;justify-content:center;gap:8px;">
            <span class="ap-badge
              {% if t.status == 'open' %}ap-bg-new
              {% elif t.status == 'in_progress' %}ap-bg-pro
              {% elif t.status == 'done' %}ap-bg-don
              {% elif t.status == 'rejected' %}ap-bg-rej
              {% else %}ap-bg-oth{% endif %}">
              {% if t.status == 'open' %}Ø¬Ø¯ÙŠØ¯Ø©
              {% elif t.status == 'in_progress' %}Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
              {% elif t.status == 'done' %}Ù…ÙƒØªÙ…Ù„Ø©
              {% elif t.status == 'rejected' %}Ù…Ø±ÙÙˆØ¶Ø©
              {% else %}{{ t.status|default:"â€”" }}
              {% endif %}
            </span>

            <div class="meter" aria-hidden="true">
              <span class="meter-fill" style="
                {% if t.status == 'open' %}width:33%; background:var(--ap-accent);
                {% elif t.status == 'in_progress' %}width:66%; background:#7c3aed;
                {% elif t.status == 'done' %}width:100%; background:var(--ap-brand);
                {% elif t.status == 'rejected' %}width:100%; background:var(--ap-danger);
                {% else %}width:50%; background:#94a3b8;{% endif %}
              "></span>
            </div>

            <a href="{% url 'reports:ticket_detail' t.id %}"
               class="btn btn-outline btn-detail"
               style="min-height:36px;padding:6px 12px;font-size:.9rem;">
              Ø§Ù„ØªÙØ§ØµÙŠÙ„ <i class="fa-solid fa-arrow-left"></i>
            </a>
          </div>
        </div>
      {% empty %}
        <div class="card" style="text-align:center;padding:40px;">
          <div style="font-size:3rem;color:var(--ap-line);margin-bottom:10px;">
            <i class="fa-regular fa-folder-open"></i>
          </div>
          <div class="muted" style="font-weight:900">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ°Ø§ÙƒØ± Ø­Ø§Ù„ÙŠØ§Ù‹.</div>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  {% if page_obj.paginator.num_pages > 1 %}
    <div class="pgn">
      {% if page_obj.has_previous %}
        <a href="?page={{ page_obj.previous_page_number }}&view={{ view_mode|default:'list' }}{% if request.GET.q %}&q={{ request.GET.q|urlencode }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status|urlencode }}{% endif %}{% if request.GET.order %}&order={{ request.GET.order|urlencode }}{% endif %}">
          Ø§Ù„Ø³Ø§Ø¨Ù‚
        </a>
      {% endif %}

      <span class="active">{{ page_obj.number }}</span>

      {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}&view={{ view_mode|default:'list' }}{% if request.GET.q %}&q={{ request.GET.q|urlencode }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status|urlencode }}{% endif %}{% if request.GET.order %}&order={{ request.GET.order|urlencode }}{% endif %}">
          Ø§Ù„ØªØ§Ù„ÙŠ
        </a>
      {% endif %}
    </div>
  {% endif %}

</div>
{% endblock %}
