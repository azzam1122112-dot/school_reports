{# reports/templates/reports/my_requests.html (طلباتي) #}
{% extends "base.html" %}
{% load static %}

{% block title %}طلباتي{% endblock %}

{% block head %}
<style>
  /* 
     NEO-PROFESSIONAL 2026 
     Theme: Refined Slate & Royal Blue (Requests List)
  */
  .req-scope {
    --c-brand: #2563eb;
    --c-brand-light: #eff6ff;
    --c-ink: #0f172a;
    --c-muted: #64748b;
    --c-border: #e2e8f0;
    --c-bg: #f8fafc;
    --c-card: #ffffff;
    
    --shadow-soft: 0 4px 6px -1px rgba(0,0,0,0.05);
    --shadow-hard: 0 10px 15px -3px rgba(0,0,0,0.05);
    
    --radius-xl: 16px;
    --radius-lg: 12px;
    
    --ease: cubic-bezier(0.16, 1, 0.3, 1);
  }

  .req-scope .wrap {
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px;
      font-family: system-ui, -apple-system, sans-serif;
  }

  /* Hero Section */
  .hero-card {
      background: linear-gradient(135deg, #1e293b, #0f172a);
      color: white;
      padding: 32px;
      border-radius: var(--radius-xl);
      margin-bottom: 24px;
      box-shadow: var(--shadow-hard);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
      position: relative;
      overflow: hidden;
  }
  
  .hero-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
      opacity: 0.1;
  }

  .hero-content {
      position: relative; 
      z-index: 2;
  }

  .hero-title {
      font-size: 1.8rem;
      font-weight: 800;
      margin: 0 0 8px 0;
      display: flex;
      align-items: center;
      gap: 12px;
  }

  .hero-user {
      display: flex;
      align-items: center;
      gap: 12px;
      background: rgba(255,255,255,0.1);
      padding: 8px 16px;
      border-radius: 99px;
      border: 1px solid rgba(255,255,255,0.2);
  }
  .hero-ava {
      width: 32px; height: 32px;
      background: linear-gradient(135deg, var(--c-brand), #60a5fa);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-weight: 700;
      font-size: 0.9rem;
      border: 2px solid rgba(255,255,255,0.3);
  }

  /* Toolbar */
  .toolbar {
      background: var(--c-card);
      border: 1px solid var(--c-border);
      border-radius: var(--radius-xl);
      padding: 20px;
      margin-bottom: 24px;
      box-shadow: var(--shadow-soft);
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 24px;
      align-items: end;
  }
  
  @media (max-width: 992px) { .toolbar { grid-template-columns: 1fr; } }

  .tb-row {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: center;
  }

  .field-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
  }
  .field-label {
      font-size: 0.85rem;
      font-weight: 700;
      color: var(--c-muted);
  }

  /* Inputs */
  .input-lux {
      background: var(--c-bg);
      border: 1px solid var(--c-border);
      border-radius: var(--radius-lg);
      padding: 10px 14px;
      font-size: 0.95rem;
      min-width: 200px;
      transition: all 0.2s;
  }
  .input-lux:focus {
      background: white;
      border-color: var(--c-brand);
      box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
      outline: none;
  }
  
  .select-lux {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748b'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: left 12px center;
      background-size: 16px;
      padding-left: 36px;
  }

  /* Buttons */
  .btn-lux {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      border-radius: var(--radius-lg);
      font-weight: 600;
      cursor: pointer;
      border: 1px solid transparent;
      transition: all 0.2s;
      text-decoration: none;
      height: 42px;
  }
  
  .btn-primary {
      background: var(--c-brand);
      color: white;
      box-shadow: 0 4px 6px -1px rgba(37,99,235,0.3);
  }
  .btn-primary:hover { background: #1d4ed8; transform: translateY(-1px); }
  
  .btn-ghost {
      background: transparent;
      color: var(--c-muted);
      border: 1px solid var(--c-border);
  }
  .btn-ghost:hover {
      background: var(--c-bg);
      color: var(--c-ink);
      border-color: var(--c-brand);
  }

  /* Stats Grid */
  .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
  }
  
  .stat-card {
      background: var(--c-card);
      border: 1px solid var(--c-border);
      border-radius: var(--radius-xl);
      padding: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: var(--shadow-soft);
  }
  
  .stat-info .num { font-size: 1.8rem; font-weight: 800; color: var(--c-ink); line-height: 1; }
  .stat-info .lbl { font-size: 0.9rem; color: var(--c-muted); margin-top: 4px; font-weight: 600; }
  
  .stat-icon {
      width: 48px; height: 48px;
      border-radius: 12px;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.4rem;
  }
  
  .s-open { background: #eff6ff; color: #2563eb; }
  .s-prog { background: #fff7ed; color: #ea580c; }
  .s-done { background: #f0fdf4; color: #166534; }
  .s-rejected { background: #fef2f2; color: #dc2626; }

  /* Table View */
  .table-card {
      background: var(--c-card);
      border: 1px solid var(--c-border);
      border-radius: var(--radius-xl);
      overflow: hidden;
      box-shadow: var(--shadow-soft);
  }
  
  .data-table { width: 100%; border-collapse: collapse; min-width: 900px; }
  .data-table th {
      background: var(--c-bg);
      text-align: right;
      padding: 16px 20px;
      font-weight: 700;
      color: var(--c-muted);
      font-size: 0.85rem;
      border-bottom: 1px solid var(--c-border);
  }
  .data-table td {
      padding: 16px 20px;
      border-bottom: 1px solid var(--c-border);
      color: var(--c-ink);
      font-size: 0.95rem;
  }
  .data-table tr:hover td { background: rgba(241,245,249,0.5); }

  /* List View */
  .list-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
      gap: 16px;
  }
  
  .list-card {
      background: var(--c-card);
      border: 1px solid var(--c-border);
      border-radius: var(--radius-xl);
      padding: 20px;
      transition: all 0.2s;
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 16px;
  }
  .list-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-hard);
      border-color: var(--c-brand);
  }

  .lc-head { display: flex; justify-content: space-between; align-items: flex-start; }
  .lc-id { font-family: monospace; color: var(--c-muted); font-size: 0.9rem; }
  .lc-title { font-size: 1.1rem; font-weight: 700; color: var(--c-ink); margin: 4px 0 0 0; line-height: 1.4; }
  .lc-title a { text-decoration: none; color: inherit; }
  .lc-title a:hover { color: var(--c-brand); }
  
  .lc-meta {
      display: flex; flex-wrap: wrap; gap: 8px;
      font-size: 0.85rem; color: var(--c-muted);
  }
  .lc-pill {
      background: var(--c-bg);
      padding: 4px 10px;
      border-radius: 6px;
      display: flex; align-items: center; gap: 6px;
  }
  
  .lc-foot {
      margin-top: auto;
      padding-top: 16px;
      border-top: 1px solid var(--c-border);
      display: flex; justify-content: space-between; align-items: center;
  }

  /* Badges */
  .badge {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 4px 12px;
      border-radius: 99px;
      font-size: 0.8rem;
      font-weight: 700;
  }
  .badge.open { background: #eff6ff; color: #2563eb; border: 1px solid #dbeafe; }
  .badge.prog { background: #fff7ed; color: #ea580c; border: 1px solid #ffedd5; }
  .badge.done { background: #f0fdf4; color: #166534; border: 1px solid #dcfce7; }
  .badge.rej { background: #fef2f2; color: #dc2626; border: 1px solid #fee2e2; }

  /* Empty State */
  .empty-state {
      text-align: center;
      padding: 60px 20px;
      background: var(--c-card);
      border-radius: var(--radius-xl);
      border: 2px dashed var(--c-border);
  }
  .empty-icon { font-size: 3rem; color: var(--c-border); margin-bottom: 16px; }

</style>
{% endblock %}

{% block content %}
<div class="req-scope" dir="rtl">
    <div class="wrap">

      <!-- Hero Header -->
      <section class="hero-card">
        <div class="hero-content">
            <h1 class="hero-title">
                <i class="fa-solid fa-layer-group"></i>
                طلباتي
            </h1>
            <p style="opacity:0.9; margin:0">إدارة ومتابعة جميع طلباتك لدى الأقسام المختلفة.</p>
        </div>
        
        <div class="hero-user">
            {% firstof request.user.name request.user.phone "أنا" as display_name %}
            <div class="hero-ava">{{ display_name|slice:":1" }}</div>
            <div>
                 <div style="font-weight:700; font-size:0.95rem">{{ display_name }}</div>
                 <div style="font-size:0.8rem; opacity:0.8; margin-top:2px">صاحب الطلب</div>
            </div>
        </div>
      </section>

      <!-- Stats Overview -->
      <section class="stats-grid">
          <div class="stat-card">
              <div class="stat-info">
                  <div class="num">{{ stats.open|default:0 }}</div>
                  <div class="lbl">طلبات جديدة</div>
              </div>
              <div class="stat-icon s-open"><i class="fa-solid fa-sparkles"></i></div>
          </div>
          <div class="stat-card">
              <div class="stat-info">
                  <div class="num">{{ stats.in_progress|default:0 }}</div>
                  <div class="lbl">قيد المعالجة</div>
              </div>
              <div class="stat-icon s-prog"><i class="fa-solid fa-spinner"></i></div>
          </div>
          <div class="stat-card">
              <div class="stat-info">
                  <div class="num">{{ stats.done|default:0 }}</div>
                  <div class="lbl">مكتملة</div>
              </div>
              <div class="stat-icon s-done"><i class="fa-solid fa-check-circle"></i></div>
          </div>
          <div class="stat-card">
              <div class="stat-info">
                  <div class="num">{{ stats.rejected|default:0 }}</div>
                  <div class="lbl">مرفوضة</div>
              </div>
              <div class="stat-icon s-rejected"><i class="fa-solid fa-times-circle"></i></div>
          </div>
      </section>

      <!-- Advanced Filter Toolbar -->
      <form class="toolbar" method="get">
         <input type="hidden" name="view" value="{{ view_mode|default:'list' }}">
         
         <div class="tb-row" style="flex:1">
             <!-- Search -->
             <div class="field-group" style="flex:1">
                 <label class="field-label">البحث</label>
                 <input class="input-lux" type="search" name="q" placeholder="ابحث برقم الطلب، العنوان..." value="{{ request.GET.q|default_if_none:'' }}">
             </div>
             
             <!-- Status Filter (Corrected Labels) -->
             <div class="field-group">
                 <label class="field-label">حالة الطلب</label>
                 <select class="input-lux select-lux" name="status">
                    <option value="">جميع الحالات</option>
                    <option value="open" {% if request.GET.status == "open" %}selected{% endif %}>جديدة</option>
                    <!-- Removed Duplicate/English Labels -->
                    <option value="in_progress" {% if request.GET.status == "in_progress" %}selected{% endif %}>قيد المعالجة</option>
                    <option value="done" {% if request.GET.status == "done" %}selected{% endif %}>مكتملة</option>
                    <option value="rejected" {% if request.GET.status == "rejected" %}selected{% endif %}>مرفوضة</option>
                 </select>
             </div>

             <!-- Sort -->
             <div class="field-group">
                 <label class="field-label">ترتيب العرض</label>
                 <select class="input-lux select-lux" name="order">
                    <option value="-created_at" {% if request.GET.order|default:"-created_at" == "-created_at" %}selected{% endif %}>الأحدث أولاً</option>
                    <option value="created_at" {% if request.GET.order == "created_at" %}selected{% endif %}>الأقدم أولاً</option>
                 </select>
             </div>

             <div class="field-group" style="justify-content:flex-end">
                <button type="submit" class="btn-lux btn-primary" style="margin-top:24px">
                    <i class="fa-solid fa-filter"></i> تطبيق
                </button>
             </div>
             
             {% if request.GET.q or request.GET.status or request.GET.order %}
             <div class="field-group" style="justify-content:flex-end">
                <a href="?view={{ view_mode|default:'list' }}" class="btn-lux btn-ghost" style="margin-top:24px">
                    مسح
                </a>
             </div>
             {% endif %}
         </div>

         <!-- View Toggles & Actions -->
         <div class="tb-row">
             <div style="border-left:1px solid var(--c-border); padding-left:24px; display:flex; gap:12px; align-items:center;">
                {% with bq=request.GET.q|urlencode bs=request.GET.status bo=request.GET.order %}
                    <a href="?{% if bq %}q={{ bq }}&{% endif %}{% if bs %}status={{ bs }}&{% endif %}{% if bo %}order={{ bo }}&{% endif %}view=list" 
                       class="btn-lux btn-ghost {% if view_mode != 'table' %}btn-active{% endif %}" title="عرض قائمة">
                       <i class="fa-solid fa-grip"></i>
                    </a>
                    <a href="?{% if bq %}q={{ bq }}&{% endif %}{% if bs %}status={{ bs }}&{% endif %}{% if bo %}order={{ bo }}&{% endif %}view=table" 
                       class="btn-lux btn-ghost {% if view_mode == 'table' %}btn-active{% endif %}" title="عرض جدول">
                       <i class="fa-solid fa-table"></i>
                    </a>
                {% endwith %}
                
                <a href="{% url 'reports:request_create' %}" class="btn-lux btn-primary">
                    <i class="fa-solid fa-plus"></i> طلب جديد
                </a>
             </div>
         </div>
      </form>

      <!-- Content Area -->
      {% if view_mode == "table" %}
        <div class="table-card">
          <div style="overflow-x:auto">
            <table class="data-table">
                <thead>
                    <tr>
                        <th width="80">#</th>
                        <th>العنوان</th>
                        <th>القسم</th>
                        <th>التاريخ</th>
                        <th>الحالة</th>
                        <th width="100">إجراء</th>
                    </tr>
                </thead>
                <tbody>
                    {% for t in tickets %}
                    <tr>
                        <td style="font-family:monospace; color:var(--c-muted)">#{{ t.pk }}</td>
                        <td>
                            <div style="font-weight:600">{{ t.title }}</div>
                            <div style="font-size:0.85rem; color:var(--c-muted)">
                                المستلم: {% firstof t.assignee.name t.assignee "—" %}
                            </div>
                        </td>
                        <td>{{ t.get_department_display|default:t.department|default:"—" }}</td>
                        <td style="direction:ltr; text-align:right">{{ t.created_at|date:"Y-m-d H:i" }}</td>
                        <td>
                            {% if t.status == 'open' or t.status == 'new' %}
                                <span class="badge open">جديدة</span>
                            {% elif t.status == 'in_progress' %}
                                <span class="badge prog">قيد المعالجة</span>
                            {% elif t.status == 'done' %}
                                <span class="badge done">مكتملة</span>
                            {% else %}
                                <span class="badge rej">مرفوضة</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{% url 'reports:ticket_detail' t.pk %}" class="btn-lux btn-ghost" style="height:32px; font-size:0.85rem; padding:4px 12px">عرض</a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" style="padding:40px; text-align:center; color:var(--c-muted)">لا توجد طلبات مطابقة للبحث</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
          </div>
        </div>

      {% else %}
        <!-- List View -->
        <div class="list-grid">
            {% for t in tickets %}
            <div class="list-card">
                <div class="lc-head">
                    <div>
                        <div class="lc-id">#{{ t.pk }}</div>
                        <h3 class="lc-title">
                            <a href="{% url 'reports:ticket_detail' t.pk %}">{{ t.title|default:"طلب بدون عنوان" }}</a>
                        </h3>
                    </div>
                    {% if t.status == 'open' or t.status == 'new' %}
                        <span class="badge open">جديدة</span>
                    {% elif t.status == 'in_progress' %}
                        <span class="badge prog">قيد التنفيذ</span>
                    {% elif t.status == 'done' %}
                        <span class="badge done">مكتملة</span>
                    {% else %}
                        <span class="badge rej">مرفوضة</span>
                    {% endif %}
                </div>
                
                <div class="lc-meta">
                    <span class="lc-pill"><i class="fa-solid fa-building-user"></i> {{ t.get_department_display|default:t.department|default:"—" }}</span>
                    <span class="lc-pill"><i class="fa-regular fa-clock"></i> {{ t.created_at|date:"Y-m-d" }}</span>
                </div>
                
                {% if t.pub_notes %}
                <div style="font-size:0.85rem; color: #475569; background:#f1f5f9; padding:10px; border-radius:8px; line-height:1.5">
                    {% for n in t.pub_notes|slice:":1" %}
                       <i class="fa-solid fa-reply" style="color:var(--c-muted)"></i> 
                       <b>{{ n.author.name }}:</b> {{ n.body|default:"—"|truncatechars:60 }}
                    {% endfor %}
                </div>
                {% endif %}
                
                <div class="lc-foot">
                    <div style="font-size:0.85rem; color:var(--c-muted)">
                         إلى: {% firstof t.assignee.name t.assignee.username "غير مسند" %}
                    </div>
                    <a href="{% url 'reports:ticket_detail' t.pk %}" style="text-decoration:none; color:var(--c-brand); font-weight:700; font-size:0.9rem display:flex; align-items:center; gap:4px">
                        التفاصيل <i class="fa-solid fa-arrow-left"></i>
                    </a>
                </div>
            </div>
            {% empty %}
            <div class="empty-state" style="grid-column: 1/-1">
                <div class="empty-icon"><i class="fa-regular fa-folder-open"></i></div>
                <h3>لا توجد طلبات حالياً</h3>
                <p style="color:var(--c-muted)">يمكنك إنشاء طلب جديد للتواصل مع الأقسام المختلفة.</p>
                <br>
                <a href="{% url 'reports:request_create' %}" class="btn-lux btn-primary">إنشاء طلب جديد</a>
            </div>
            {% endfor %}
        </div>
      {% endif %}

      <!-- Pager -->
      {% if tickets.paginator and tickets.paginator.num_pages > 1 %}
      <div style="margin-top:32px; display:flex; justify-content:center; gap:8px">
        {% with bq=request.GET.q|urlencode bs=request.GET.status bo=request.GET.order %}
          {% if tickets.has_previous %}
            <a href="?{% if bq %}q={{ bq }}&{% endif %}{% if bs %}status={{ bs }}&{% endif %}{% if bo %}order={{ bo }}&{% endif %}view={{ view_mode }}&page={{ tickets.previous_page_number }}" class="btn-lux btn-ghost">السابق</a>
          {% endif %}
          
          <span style="display:inline-flex; align-items:center; padding:0 16px; font-weight:700; color:var(--c-muted)">
              {{ tickets.number }} / {{ tickets.paginator.num_pages }}
          </span>

          {% if tickets.has_next %}
            <a href="?{% if bq %}q={{ bq }}&{% endif %}{% if bs %}status={{ bs }}&{% endif %}{% if bo %}order={{ bo }}&{% endif %}view={{ view_mode }}&page={{ tickets.next_page_number }}" class="btn-lux btn-ghost">التالي</a>
          {% endif %}
        {% endwith %}
      </div>
      {% endif %}

    </div>
  </div>
{% endblock %}
