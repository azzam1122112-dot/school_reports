{# reports/templates/reports/my_requests.html (طلباتي) #}
{% extends "base.html" %}
{% load static %}

{% block title %}طلباتي{% endblock %}

{% block head %}
{% endblock %}

{% block content %}
  {{ block.super }}

  <div class="req-scope">
    <div class="wrap">

      <!-- Hero -->
      <section class="hero" aria-label="رأس الصفحة">
        <h1 class="title"><i class="fa-solid fa-inbox"></i> طلباتي</h1>

        <div class="you-chip" title="مستخدم حالي">
          {% firstof request.user.name request.user.phone "أنا" as display_name %}
          <div class="you-ava"><span>{{ display_name|slice:":1" }}</span></div>
          <div>
            <div class="you-name">{{ display_name }}</div>
            <span class="you-role">مرسل الطلبات</span>
          </div>
        </div>
      </section>

      <!-- Toolbar -->
      <form class="toolbar" method="get" aria-label="شريط أدوات">
        {# يحافظ على وضع العرض عند تغيير الفلاتر #}
        <input type="hidden" name="view" value="{{ view_mode|default:'list' }}">

        <div class="tb-group">
          <input class="input" type="search" name="q" placeholder="ابحث في طلباتك…" value="{{ request.GET.q|default_if_none:'' }}">
          <button class="btnx" type="submit"><i class="fa-solid fa-magnifying-glass"></i> بحث</button>

          <a class="btnx primary" href="{% url 'reports:request_create' %}">
            <i class="fa-solid fa-plus"></i> طلب جديد
          </a>

          {% if request.GET.q or request.GET.status or request.GET.order %}
            <a class="btnx" href="?view={{ view_mode|default:'list' }}"><i class="fa-solid fa-rotate-left"></i> مسح</a>
          {% endif %}
        </div>

        <div class="tb-group">
          <label for="status" style="font-weight:950;color:var(--muted)">الحالة:</label>
          <select id="status" class="select" name="status">
            <option value="">جميع الحالات</option>
            <option value="open" {% if request.GET.status == "open" %}selected{% endif %}>جديدة</option>
            <option value="new" {% if request.GET.status == "new" %}selected{% endif %}>جديدة (NEW)</option>
            <option value="in_progress" {% if request.GET.status == "in_progress" %}selected{% endif %}>قيد المعالجة</option>
            <option value="pending" {% if request.GET.status == "pending" %}selected{% endif %}>قيد المعالجة (PENDING)</option>
            <option value="done" {% if request.GET.status == "done" %}selected{% endif %}>مكتملة</option>
            <option value="rejected" {% if request.GET.status == "rejected" %}selected{% endif %}>مرفوضة</option>
          </select>

          <label for="order" style="font-weight:950;color:var(--muted)">الفرز:</label>
          <select id="order" class="select" name="order">
            <option value="-created_at" {% if request.GET.order|default:"-created_at" == "-created_at" %}selected{% endif %}>الأحدث</option>
            <option value="created_at" {% if request.GET.order == "created_at" %}selected{% endif %}>الأقدم</option>
            <option value="-id" {% if request.GET.order == "-id" %}selected{% endif %}>رقم الطلب (تنازلي)</option>
            <option value="id" {% if request.GET.order == "id" %}selected{% endif %}>رقم الطلب (تصاعدي)</option>
          </select>
        </div>

        <div class="view-switch">
          {% with bq=request.GET.q|urlencode bs=request.GET.status bo=request.GET.order %}
            <a
              href="?{% if bq %}q={{ bq }}&{% endif %}{% if bs %}status={{ bs }}&{% endif %}{% if bo %}order={{ bo }}&{% endif %}view=list"
              class="{% if view_mode != 'table' %}active{% endif %}"
            ><i class="fa-solid fa-rectangle-list"></i> قائمة</a>

            <a
              href="?{% if bq %}q={{ bq }}&{% endif %}{% if bs %}status={{ bs }}&{% endif %}{% if bo %}order={{ bo }}&{% endif %}view=table"
              class="{% if view_mode == 'table' %}active{% endif %}"
            ><i class="fa-solid fa-table"></i> جدول</a>
          {% endwith %}
        </div>

        <div class="hintline" aria-label="معلومات">
          <div>
            {% if tickets.paginator %}
              إجمالي النتائج: <b style="color:var(--ink)">{{ tickets.paginator.count }}</b>
            {% else %}
              إجمالي النتائج: <b style="color:var(--ink)">{{ tickets|length }}</b>
            {% endif %}
          </div>
          <div>تلميح: اضغط على عنوان الطلب لعرض التفاصيل وإضافة ملاحظة.</div>
        </div>
      </form>

      <!-- Stats -->
      <section class="stats" aria-label="إحصاءات الطلبات">
        <div class="stat"><div><div class="num">{{ stats.open|default:0 }}</div><div class="lbl">جديدة</div></div><div class="ico o"><i class="fa-solid fa-sparkles"></i></div></div>
        <div class="stat"><div><div class="num">{{ stats.in_progress|default:0 }}</div><div class="lbl">قيد المعالجة</div></div><div class="ico i"><i class="fa-solid fa-spinner"></i></div></div>
        <div class="stat"><div><div class="num">{{ stats.done|default:0 }}</div><div class="lbl">مكتملة</div></div><div class="ico d"><i class="fa-solid fa-circle-check"></i></div></div>
        <div class="stat"><div><div class="num">{{ stats.rejected|default:0 }}</div><div class="lbl">مرفوضة</div></div><div class="ico r"><i class="fa-solid fa-circle-xmark"></i></div></div>
      </section>

      {% if view_mode == "table" %}
        <section class="table-wrap" aria-label="جدول طلباتي">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>التاريخ</th>
                <th>القسم</th>
                <th>المستلمون</th>
                <th>العنوان</th>
                <th>الحالة</th>
                <th>آخر إجراء</th>
                <th>إجراء</th>
              </tr>
            </thead>

            <tbody>
              {% for t in tickets %}
              <tr>
                <td class="tbl-id">#{{ t.pk }}</td>
                <td>{{ t.created_at|date:"Y-m-d H:i" }}</td>
                <td>{{ t.get_department_display|default:t.department|default:"—" }}</td>

                <td>
                  {% for u in t.recipients.all %}
                    {{ u.name|default:u }}{% if not forloop.last %}، {% endif %}
                  {% empty %}
                    {% firstof t.assignee.name t.assignee "—" %}
                  {% endfor %}
                </td>

                <td class="tbl-title">
                  <a href="{% url 'reports:ticket_detail' t.pk %}">
                    {{ t.title|default:"عرض التفاصيل / إضافة ملاحظة" }}
                  </a>
                </td>

                <td>
                  <span class="badge2
                    {% if t.status == 'open' or t.status == 'new' %}b-open
                    {% elif t.status == 'in_progress' or t.status == 'pending' %}b-in
                    {% elif t.status == 'done' %}b-done
                    {% else %}b-rej{% endif %}">
                    {{ t.get_status_display|default:t.status }}
                  </span>
                </td>

                <td style="min-width:260px;max-width:560px;">
                  {% if t.pub_notes %}
                    {% for n in t.pub_notes|slice:":1" %}
                      <div class="note-preview">
                    <b>{% if n.author %}{{ n.author.name|default:"—" }} — {{ n.author.display_role_label }}{% else %}—{% endif %}</b>
                        • {{ n.created_at|date:"Y-m-d H:i" }}
                        — {{ n.body|default:"—"|truncatechars:100 }}
                      </div>
                    {% endfor %}
                  {% else %}
                    —
                  {% endif %}
                </td>

                <td>
                  <a class="btnx sm" href="{% url 'reports:ticket_detail' t.pk %}">عرض</a>
                </td>
              </tr>

              {% empty %}
                <tr>
                  <td colspan="8" style="text-align:center;color:var(--muted);font-weight:950;padding:18px">
                    لا توجد طلبات
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </section>

      {% else %}
        <section class="list" aria-label="قائمة طلباتي">
          {% for t in tickets %}
          <article class="ticket
            {% if t.status == 'open' or t.status == 'new' %}state-open
            {% elif t.status == 'in_progress' or t.status == 'pending' %}state-in
            {% elif t.status == 'done' %}state-done
            {% else %}state-rej{% endif %}">

            <div>
              <div class="t-head">
                <span class="tid">#{{ t.pk }}</span>
                <h3 class="t-title">
                  <a href="{% url 'reports:ticket_detail' t.pk %}">{{ t.title|default:"طلب بدون عنوان" }}</a>
                </h3>
              </div>

              <div class="meta">
                <span class="pill"><span class="dot b"></span> القسم: {{ t.get_department_display|default:t.department|default:"—" }}</span>

                <span class="pill"><span class="dot a"></span>
                  المستلمون:
                  {% for u in t.recipients.all %}
                    {{ u.name|default:u }}{% if not forloop.last %}، {% endif %}
                  {% empty %}
                    {% firstof t.assignee.name t.assignee "—" %}
                  {% endfor %}
                </span>

                <span class="pill"><span class="dot c"></span> {{ t.created_at|date:"Y-m-d H:i" }}</span>
              </div>

              {% if t.pub_notes %}
                {% for n in t.pub_notes|slice:":1" %}
                  <div class="last-note">
                    <b>آخر إجراء:</b>
                {% if n.author %}{{ n.author.name|default:"—" }} — {{ n.author.display_role_label }}{% else %}—{% endif %} • {{ n.created_at|date:"Y-m-d H:i" }} —
                    {{ n.body|default:"—"|truncatechars:120 }}
                  </div>
                {% endfor %}
              {% endif %}
            </div>

            <aside class="aside">
              <span class="badge2
                {% if t.status == 'open' or t.status == 'new' %}b-open
                {% elif t.status == 'in_progress' or t.status == 'pending' %}b-in
                {% elif t.status == 'done' %}b-done
                {% else %}b-rej{% endif %}">
                {{ t.get_status_display|default:t.status }}
              </span>

              <div class="meter
                {% if t.status == 'open' or t.status == 'new' %}m-open
                {% elif t.status == 'in_progress' or t.status == 'pending' %}m-in
                {% elif t.status == 'done' %}m-done
                {% else %}m-rej{% endif %}">
                <span class="fill"></span>
              </div>

              <a class="btnx" href="{% url 'reports:ticket_detail' t.pk %}">
                عرض التفاصيل <i class="fa-solid fa-arrow-left-long" style="transform:rotate(180deg)"></i>
              </a>
            </aside>
          </article>

          {% empty %}
            <div class="empty" role="status" aria-live="polite">
              <div>
                <div class="big">لا توجد طلبات حالياً</div>
                <div class="sub">
                  جرّب إزالة الفلاتر أو اضغط
                  <a href="{% url 'reports:request_create' %}" style="font-weight:950;color:var(--brand);text-decoration:none">طلب جديد</a>
                  لفتح تذكرة.
                </div>
              </div>
              <div class="spark"><i class="fa-solid fa-face-smile"></i></div>
            </div>
          {% endfor %}
        </section>
      {% endif %}

      <!-- Pager -->
      {% if tickets.paginator and tickets.paginator.num_pages > 1 %}
      <nav class="pager" aria-label="ترقيم الصفحات">
        {% with bq=request.GET.q|urlencode bs=request.GET.status bo=request.GET.order %}
          {% if tickets.has_previous %}
            <a href="?{% if bq %}q={{ bq }}&{% endif %}{% if bs %}status={{ bs }}&{% endif %}{% if bo %}order={{ bo }}&{% endif %}view={{ view_mode }}&page={{ tickets.previous_page_number }}">السابق</a>
          {% endif %}

          <span class="current">صفحة {{ tickets.number }} من {{ tickets.paginator.num_pages }}</span>

          {% if tickets.has_next %}
            <a href="?{% if bq %}q={{ bq }}&{% endif %}{% if bs %}status={{ bs }}&{% endif %}{% if bo %}order={{ bo }}&{% endif %}view={{ view_mode }}&page={{ tickets.next_page_number }}">التالي</a>
          {% endif %}
        {% endwith %}
      </nav>
      {% endif %}

    </div>
  </div>
{% endblock %}
