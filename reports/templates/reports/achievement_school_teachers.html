{# reports/templates/reports/achievement_manager_approval.html #}
{% extends "base.html" %}
{% load static %}

{% block title %}ملفات الإنجاز - اعتماد المدير{% endblock %}

{% block head %}
<style>
  /* =========================================================
     Achievement Manager Approval — page-scoped styling
     - بدون إعادة تعريف .btn / .card العامة
     - متوافق مع data-theme
     ========================================================= */

  .aa-page{max-width:1250px;margin:0 auto;padding:clamp(12px,2.4vw,18px)}
  .aa-card{overflow:hidden;border-radius:18px}
  .aa-head{
    padding:16px 18px;
    background:linear-gradient(135deg, rgba(37,99,235,.92), rgba(16,185,129,.78));
    color:#fff;
  }
  .aa-head h1{margin:0;font-weight:950;font-size:1.3rem}
  .aa-head p{margin:6px 0 0;opacity:.95;font-weight:800}
  .aa-body{padding:16px 18px}

  /* Toolbar */
  .aa-toolbar{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:flex-end;
    justify-content:space-between;
  }
  .aa-filter{min-width:280px}
  .aa-label{display:block;margin:0 0 6px;font-weight:900;color:var(--ink)}
  .aa-input,
  .aa-page select,
  .aa-page textarea{
    width:100%;
    min-height:var(--tap, 44px);
    border-radius:14px;
    border:1px solid var(--line);
    padding:12px 14px;
    background:rgba(248,250,252,.85);
    font-weight:800;
    color:var(--ink);
  }
  .aa-page textarea{min-height:92px; resize:vertical}
  html[data-theme="dark"] .aa-input,
  html[data-theme="dark"] .aa-page select,
  html[data-theme="dark"] .aa-page textarea{
    background:rgba(255,255,255,.04);
    border-color:rgba(148,163,184,.16);
  }

  .aa-links{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}

  /* Table */
  .aa-table-wrap{margin-top:14px;overflow:auto}
  .aa-table{width:100%;border-collapse:separate;border-spacing:0 10px;min-width:980px}
  .aa-table th{
    color:var(--muted);
    font-weight:900;
    text-align:right;
    padding:0 10px;
    white-space:nowrap;
  }
  .aa-table td{padding:12px 10px;vertical-align:top}
  .aa-row td{
    background:rgba(255,255,255,.55);
    border-top:1px solid var(--line-2);
    border-bottom:1px solid var(--line-2);
  }
  .aa-row td:first-child{
    border-right:1px solid var(--line-2);
    border-radius:14px 0 0 14px;
  }
  .aa-row td:last-child{
    border-left:1px solid var(--line-2);
    border-radius:0 14px 14px 0;
  }
  html[data-theme="dark"] .aa-row td{
    background:rgba(255,255,255,.03);
    border-color:rgba(148,163,184,.16);
  }
  html[data-theme="dark"] .aa-row td:first-child,
  html[data-theme="dark"] .aa-row td:last-child{
    border-color:rgba(148,163,184,.16);
  }

  .aa-name{font-weight:950;color:var(--ink)}
  .aa-muted{color:var(--muted);font-weight:800}
  .aa-actions{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-start;justify-content:flex-start}
  .aa-note{min-width:280px}

  /* Badges */
  .aa-pill{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    padding:6px 10px;
    border-radius:999px;
    font-weight:950;
    font-size:.85rem;
    white-space:nowrap;
  }
  .aa-pill-blue{background:rgba(37,99,235,.12);border:1px solid rgba(37,99,235,.22);color:var(--ink)}
  .aa-pill-green{background:rgba(16,185,129,.12);border:1px solid rgba(16,185,129,.22);color:var(--ink)}
  .aa-pill-amber{background:rgba(245,158,11,.14);border:1px solid rgba(245,158,11,.26);color:var(--ink)}
  .aa-pill-red{background:rgba(239,68,68,.12);border:1px solid rgba(239,68,68,.22);color:var(--ink)}
  html[data-theme="dark"] .aa-pill{background:rgba(255,255,255,.04)}

  /* Disable helper (بدون تعديل .btn العامة) */
  .aa-disabled{opacity:.55;pointer-events:none}

  /* Mobile: cards layout */
  @media (max-width: 980px){
    .aa-table{min-width:0;border-spacing:0 12px}
    .aa-table thead{display:none}
    .aa-row{display:block}
    .aa-row td{
      display:grid;
      grid-template-columns: 120px 1fr;
      gap:10px;
      border:1px solid var(--line-2);
      border-radius:14px;
      margin-bottom:12px;
      padding:12px 12px;
      background:rgba(255,255,255,.55);
    }
    html[data-theme="dark"] .aa-row td{background:rgba(255,255,255,.03);border-color:rgba(148,163,184,.16)}
    .aa-row td:first-child,
    .aa-row td:last-child{
      border-radius:14px;
      border-right:1px solid var(--line-2);
      border-left:1px solid var(--line-2);
    }
    .aa-row td::before{
      content: attr(data-label);
      color: var(--muted);
      font-weight: 900;
      white-space:nowrap;
    }
    .aa-actions{flex-direction:column;align-items:stretch}
    .aa-note{min-width:0}
    .aa-links{width:100%}
  }

  .aa-help{margin-top:10px;color:var(--muted);font-weight:800}
</style>
{% endblock %}

{% block content %}
<div class="aa-page">
  <div class="card aa-card">
    <div class="aa-head">
      <h1>ملفات الإنجاز — اعتماد مدير المدرسة</h1>
      <p>اختر السنة الدراسية، ثم اعتمد/ارفض ملف كل معلّم مع إدراج ملاحظات.</p>
    </div>

    <div class="aa-body">
      <div class="aa-toolbar">
        <form method="get" class="aa-filter">
          <label class="aa-label">السنة الدراسية (هجري)</label>

          {% if year_choices %}
            <select name="year">
              {% if year and year not in year_choices %}
                <option value="{{ year }}" selected>{{ year }} (جديدة)</option>
              {% endif %}
              {% for y in year_choices %}
                <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
              {% endfor %}
            </select>

            <div style="margin-top:10px">
              <label class="aa-label">سنة جديدة (اختياري)</label>
              <input class="aa-input" name="new_year" value="{{ new_year }}" placeholder="مثال: 1447-1448" />
            </div>
          {% else %}
            <input class="aa-input" name="year" value="{{ year }}" placeholder="مثال: 1447-1448" />
          {% endif %}

          <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn btn-primary" type="submit">
              <i class="fa-solid fa-magnifying-glass" aria-hidden="true"></i>
              عرض
            </button>
          </div>
        </form>

        <div class="aa-links">
          <a class="btn" href="{% url 'reports:admin_dashboard' %}">
            <i class="fa-solid fa-gauge" aria-hidden="true"></i>
            لوحة المدير
          </a>
          <a class="btn" href="{% url 'reports:achievement_school_files' %}">
            <i class="fa-solid fa-folder-open" aria-hidden="true"></i>
            عرض الملفات
          </a>
        </div>
      </div>

      <div class="aa-table-wrap" aria-label="قائمة المعلمين">
        <table class="aa-table">
          <thead>
            <tr>
              <th>المعلّم</th>
              <th>الهاتف</th>
              <th>الحالة</th>
              <th style="text-align:left">إجراء</th>
            </tr>
          </thead>

          <tbody>
            {% for row in rows %}
              <tr class="aa-row">
                <td data-label="المعلّم">
                  <div class="aa-name">{{ row.teacher.name }}</div>
                  <div class="aa-muted">{{ year }} هـ</div>
                </td>

                <td class="aa-muted" data-label="الهاتف">{{ row.teacher.phone }}</td>

                <td class="aa-muted" data-label="الحالة">
                  {% if row.file %}
                    {# عرض الحالة كبادج لطيف #}
                    {% if row.file.status == 'approved' %}
                      <span class="aa-pill aa-pill-green">{{ row.file.get_status_display }}</span>
                    {% elif row.file.status == 'returned' or row.file.status == 'rejected' %}
                      <span class="aa-pill aa-pill-red">{{ row.file.get_status_display }}</span>
                    {% elif row.file.status == 'submitted' %}
                      <span class="aa-pill aa-pill-amber">{{ row.file.get_status_display }}</span>
                    {% else %}
                      <span class="aa-pill aa-pill-blue">{{ row.file.get_status_display }}</span>
                    {% endif %}
                  {% else %}
                    <span class="aa-pill aa-pill-blue">لا يوجد ملف</span>
                  {% endif %}
                </td>

                <td style="text-align:left" data-label="إجراء">
                  {% if row.file %}
                    <div class="aa-actions">
                      <a class="btn" href="{% url 'reports:achievement_file_detail' row.file.pk %}" title="عرض ملف الإنجاز">
                        <i class="fa-solid fa-file-lines" aria-hidden="true"></i>
                        عرض
                      </a>

                      <form method="post" class="aa-act-form" style="display:flex;gap:10px;flex-wrap:wrap;align-items:flex-start;margin:0">
                        {% csrf_token %}
                        <input type="hidden" name="file_id" value="{{ row.file.id }}" />
                        <input type="hidden" name="year" value="{{ year }}" />

                        <textarea
                          class="aa-note"
                          name="manager_notes"
                          placeholder="اكتب شكر/تحفيز عند الاعتماد، أو سبب الرفض عند الرفض…"
                        >{{ row.file.manager_notes }}</textarea>

                        {% if row.file.status == 'submitted' %}
                          <button class="btn btn-primary aa-submit" type="submit" name="action" value="approve">
                            <i class="fa-solid fa-check" aria-hidden="true"></i>
                            اعتماد
                          </button>
                          <button class="btn aa-submit" type="submit" name="action" value="return" data-requires-notes="1">
                            <i class="fa-solid fa-rotate-left" aria-hidden="true"></i>
                            رفض
                          </button>
                        {% else %}
                          <button class="btn btn-primary aa-disabled" type="button" aria-disabled="true">اعتماد</button>
                          <button class="btn aa-disabled" type="button" aria-disabled="true">رفض</button>
                        {% endif %}
                      </form>
                    </div>
                  {% else %}
                    <form method="post" style="margin:0">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="create" />
                      <input type="hidden" name="teacher_id" value="{{ row.teacher.id }}" />
                      <input type="hidden" name="year" value="{{ year }}" />

                      <button class="btn aa-submit" type="submit" title="إنشاء ملف الإنجاز">
                        <i class="fa-solid fa-plus" aria-hidden="true"></i>
                        إنشاء ملف
                      </button>
                    </form>
                  {% endif %}
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="4" class="aa-muted">لا يوجد معلمون في هذه المدرسة.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="aa-help">
        ملاحظة: أزرار الاعتماد/الرفض تعمل فقط عندما تكون حالة الملف "مرسل للاعتماد".
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  (function(){
    // منع النقر المكرر + تحسين بسيط: رفض يتطلب ملاحظة (تنبيه فقط)
    function closest(el, selector){
      while(el && el.nodeType === 1){
        if(el.matches(selector)) return el;
        el = el.parentElement;
      }
      return null;
    }

    document.addEventListener('click', function(ev){
      var btn = ev.target.closest('.aa-submit');
      if(!btn) return;

      var form = closest(btn, 'form');
      if(!form) return;

      // لو زر الرفض وبدون ملاحظات -> تنبيه بسيط (والتحقق الحقيقي يكون سيرفر)
      if(btn.getAttribute('data-requires-notes') === '1'){
        var ta = form.querySelector('textarea[name="manager_notes"]');
        var v = ta ? (ta.value || '').trim() : '';
        if(!v){
          ev.preventDefault();
          alert('فضلاً اكتب سبب الرفض في الملاحظات قبل الإرسال.');
          if(ta) ta.focus();
          return;
        }
      }

      // تعطيل كل أزرار الإرسال داخل نفس النموذج لتفادي الإرسال المكرر
      try{
        var submits = form.querySelectorAll('button[type="submit"]');
        submits.forEach(function(b){
          b.disabled = true;
          b.classList.add('aa-disabled');
        });
      }catch(e){
        // ignore
      }
    });
  })();
</script>
{% endblock %}
