{# reports/templates/reports/achievement_files_school.html #}
{% extends "base.html" %}
{% load static %}

{% block title %}ملفات الإنجاز - المدرسة{% endblock %}

{% block head %}
<style>
  /* =========================================================
     Achievement Files (School) — page-only polish
     - بدون إعادة تعريف .btn / .card العامة
     - Scoped داخل .af-wrap لتجنب التعارض
     ========================================================= */
  .af-wrap{max-width:1150px;margin:0 auto;padding:clamp(12px,2.4vw,18px)}
  .af-card{
    overflow:hidden;
    border-radius:18px;
    border:1px solid var(--line-2);
    box-shadow: var(--shadow);
    background: var(--card);
  }

  .af-head{
    padding:16px 18px;
    background: linear-gradient(135deg, rgba(16,185,129,.90), rgba(37,99,235,.88));
    color:#fff;
  }
  .af-head h1{margin:0;font-weight:950;font-size:1.25rem;letter-spacing:-.2px}
  .af-head p{margin:6px 0 0;opacity:.95;font-weight:850}

  .af-body{padding:16px 18px}

  .af-toolbar{
    display:flex;
    gap:12px;
    flex-wrap:wrap;
    align-items:flex-end;
    justify-content:space-between;
    margin-bottom: 14px;
  }

  .af-form{
    min-width: 290px;
    flex: 1 1 360px;
    max-width: 520px;
  }

  .af-label{
    display:block;
    margin:0 0 6px;
    font-weight:900;
    color: var(--ink);
  }

  .af-input,
  .af-select{
    width:100%;
    min-height: var(--tap);
    border-radius:14px;
    border:1px solid var(--line);
    padding:12px 14px;
    background: rgba(248,250,252,.85);
    font-weight:850;
    color: var(--ink);
    outline: none;
    transition: var(--t-fast);
  }
  .af-input:focus,
  .af-select:focus{
    box-shadow: 0 0 0 4px rgba(37,99,235,.18);
    border-color: rgba(37,99,235,.40);
  }
  html[data-theme="dark"] .af-input,
  html[data-theme="dark"] .af-select{
    background: rgba(255,255,255,.04);
    border-color: rgba(148,163,184,.18);
  }

  .af-side{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:flex-end;
    justify-content:flex-end;
  }

  .af-stats{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    align-items:center;
  }
  .af-chip{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:8px 10px;
    border-radius: 999px;
    border: 1px solid var(--line);
    background: linear-gradient(180deg, var(--line-2), var(--card));
    font-weight: 900;
    color: var(--ink);
    white-space: nowrap;
  }
  .af-chip i{ opacity:.85; }

  .af-list{margin-top: 12px;display:grid;gap:10px}

  .af-item{
    display:flex;
    justify-content:space-between;
    gap:12px;
    align-items:center;
    padding:12px 14px;
    border-radius:14px;
    border:1px solid var(--line-2);
    background: rgba(255,255,255,.55);
  }
  html[data-theme="dark"] .af-item{ background: rgba(255,255,255,.03); }

  .af-meta{display:grid;gap:4px;min-width:0}
  .af-meta b{font-weight:950;color:var(--ink);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .af-meta small{color: var(--muted); font-weight: 850; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

  .af-actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end}

  .af-badge{
    display:inline-flex;
    align-items:center;
    padding:6px 10px;
    border-radius:999px;
    font-weight:950;
    font-size:.85rem;
    color:#fff;
    white-space:nowrap;
  }
  .af-b-blue{ background:#2563eb; }
  .af-b-green{ background:#10b981; }
  .af-b-amber{ background:#f59e0b; }
  .af-b-red{ background:#ef4444; }
  .af-b-gray{ background:#64748b; }

  .af-empty{
    padding:14px;
    border-radius:16px;
    border:1px dashed var(--line);
    background: linear-gradient(180deg, var(--card), var(--line-2));
    color: var(--muted);
    font-weight: 900;
  }
  .af-muted{color: var(--muted); font-weight: 850}

  @media(max-width:860px){
    .af-actions{justify-content:flex-start}
  }

  @media (prefers-reduced-motion: reduce){
    .af-input, .af-select{ transition:none !important; }
  }
</style>
{% endblock %}

{% block content %}
<div class="af-wrap">
  <div class="card af-card">
    <div class="af-head">
      <h1>ملفات الإنجاز - المدرسة</h1>
      <p>عرض ملفات الإنجاز للمدرسة حسب السنة الدراسية</p>
    </div>

    <div class="af-body">
      <div class="af-toolbar">
        <form id="afFilterForm" method="get" class="af-form" aria-label="فلترة" style="max-width: 100%; flex-basis: 100%;">
          <div style="display: flex; flex-wrap: wrap; gap: 16px;">
            <div style="flex: 0 1 250px; min-width: 200px;">
              <label class="af-label">السنة الدراسية (هجري)</label>
              {% if year_choices %}
                <select id="afYearSelect" class="af-select" name="year">
                  {% for y in year_choices %}
                    <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }} هـ</option>
                  {% endfor %}
                </select>
              {% else %}
                <input id="afYearInput" class="af-input" name="year" value="{{ year }}" placeholder="مثال: 1447-1448" autocomplete="off" />
              {% endif %}
            </div>

            <div style="flex: 1 1 250px; min-width: 200px;">
              <label class="af-label">بحث عن معلم</label>
              <div style="position:relative;">
                <input
                  id="afSearchInput"
                  class="af-input"
                  type="search"
                  name="q"
                  value="{{ q }}"
                  placeholder="ابحث باسم المعلم..."
                  autocomplete="off"
                  style="padding-left:42px;"
                />
                <i class="fa-solid fa-magnifying-glass" style="position:absolute; left:14px; top:50%; transform:translateY(-50%); color:var(--text-muted); opacity:0.6; pointer-events:none;"></i>
              </div>
            </div>
          </div>

          <div style="margin-top:14px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
            {% if q %}
              <a class="btn" href="{% url 'reports:achievement_school_files' %}?year={{ year }}" style="color:var(--danger)">
                  <i class="fa-solid fa-times"></i> مسح البحث
              </a>
            {% endif %}

            <div style="flex-grow:1"></div>
          </div>
        </form>

        <div class="af-side">
          <div class="af-stats" aria-label="معلومات سريعة">
            <span class="af-chip">
              <i class="fa-solid fa-calendar-days"></i>
              {% if year %}{{ year }} هـ{% else %}—{% endif %}
            </span>

            <span class="af-chip">
              <i class="fa-solid fa-users"></i>
              <span id="afCount">{{ rows|length }}</span> معلم
            </span>
          </div>

          {% if is_manager %}
            <a class="btn" href="{% url 'reports:admin_dashboard' %}">
              <i class="fa-solid fa-gauge-high"></i> لوحة المدير
            </a>
          {% endif %}
        </div>
      </div>

      <div id="afNoResults" class="af-empty" style="display:none; margin-bottom:12px">
        <b>لا توجد نتائج</b>
        <div class="af-muted" style="margin-top:6px">جرّب كتابة اسم مختلف.</div>
      </div>

      <div id="afList" class="af-list" aria-label="قائمة المعلمين">
        {% for row in rows %}
          <div class="af-item" data-teacher-name="{{ row.teacher.name|default:'' }}" data-teacher-phone="{{ row.teacher.phone|default:'' }}">
            <div class="af-meta">
              <b title="{{ row.teacher.name }}">{{ row.teacher.name }}</b>
              <small dir="ltr">{{ row.teacher.phone }}</small>
              <small>{% if year %}{{ year }} هـ{% endif %}</small>

              <small>
                {% if row.file %}
                  الحالة:
                  {% if row.file.status == "approved" %}
                    <span class="af-badge af-b-green">معتمد</span>
                  {% elif row.file.status == "rejected" %}
                    <span class="af-badge af-b-red">مرفوض</span>
                  {% elif row.file.status == "submitted" %}
                    <span class="af-badge af-b-amber">مُرسل للمراجعة</span>
                  {% elif row.file.status == "draft" %}
                    <span class="af-badge af-b-gray">مسودة</span>
                  {% else %}
                    <span class="af-badge af-b-blue">{{ row.file.get_status_display }}</span>
                  {% endif %}
                {% else %}
                  <span class="af-badge af-b-gray">لا يوجد ملف</span>
                {% endif %}
              </small>
            </div>

            <div class="af-actions">
              {% if row.file %}
                <a class="btn" href="{% url 'reports:achievement_file_detail' row.file.pk %}">
                  <i class="fa-solid fa-folder-open"></i> فتح
                </a>
                <a class="btn" href="{% url 'reports:achievement_file_print' row.file.pk %}" target="_blank" rel="noopener">
                  <i class="fa-solid fa-print"></i> طباعة / حفظ PDF
                </a>
              {% endif %}
            </div>
          </div>
        {% empty %}
          <div class="af-empty">
            <b>لا يوجد معلمون</b>
            <div class="af-muted" style="margin-top:6px">تأكد من ربط المعلمين بمدرسة المدير.</div>
          </div>
        {% endfor %}
      </div>

      <div style="margin-top:12px">
        <small class="af-muted">
          ملاحظة: الاعتماد/الرفض يتم من داخل صفحة الملف بعد فتحه.
        </small>
      </div>
    </div>
  </div>
</div>

<script>
  (function(){
    const form = document.getElementById('afFilterForm');
    const yearSelect = document.getElementById('afYearSelect');
    const yearInput = document.getElementById('afYearInput');

    const input = document.getElementById('afSearchInput');
    const list = document.getElementById('afList');
    const countEl = document.getElementById('afCount');
    const noResults = document.getElementById('afNoResults');
    if (!input || !list) return;

    const items = Array.from(list.querySelectorAll('.af-item'));
    const total = items.length;

    function norm(s){
      return (s || '')
        .toString()
        .toLowerCase()
        .trim();
    }

    function applyFilter(){
      const q = norm(input.value);
      let shown = 0;

      for (const el of items){
        const name = norm(el.getAttribute('data-teacher-name'));
        const phone = norm(el.getAttribute('data-teacher-phone'));
        const ok = !q || name.includes(q) || phone.includes(q);
        el.style.display = ok ? '' : 'none';
        if (ok) shown++;
      }

      if (countEl) countEl.textContent = String(shown);
      if (noResults) noResults.style.display = (shown === 0 && total > 0) ? '' : 'none';
    }

    // Prevent form submit on Enter inside search (dynamic filtering instead)
    input.addEventListener('keydown', function(e){
      if (e.key === 'Enter'){
        e.preventDefault();
      }
    });

    // Auto-apply year filter on change (no need for an "عرض" button)
    if (form && yearSelect){
      yearSelect.addEventListener('change', function(){
        form.submit();
      });
    }
    if (form && yearInput){
      let t;
      yearInput.addEventListener('input', function(){
        window.clearTimeout(t);
        t = window.setTimeout(function(){
          // Submit only if value looks non-empty
          if ((yearInput.value || '').trim().length >= 3){
            form.submit();
          }
        }, 550);
      });
      yearInput.addEventListener('keydown', function(e){
        if (e.key === 'Enter'){
          e.preventDefault();
          form.submit();
        }
      });
      yearInput.addEventListener('blur', function(){
        if ((yearInput.value || '').trim()){
          form.submit();
        }
      });
    }

    input.addEventListener('input', applyFilter);
    // Apply once on load (in case q is present in URL)
    applyFilter();
  })();
</script>
{% endblock %}
