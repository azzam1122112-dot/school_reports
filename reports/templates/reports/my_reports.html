{% extends "base.html" %}
{% load static %}
{% block title %}ğŸ“‹ ØªÙ‚Ø§Ø±ÙŠØ±ÙŠ{% endblock %}

{% block head %}
<style>
  :root{
    --brand:#2563eb; --brand-light:#eff6ff;
    --accent:#059669; --danger:#ef4444;
    --ink:#0f172a; --muted:#64748b;
    --bg:#f1f5f9; --card:#ffffff; --line:#e2e8f0;
    --radius:16px; --shadow:0 4px 20px rgba(0,0,0,0.05);
  }
  body{background:var(--bg); color:var(--ink)}
  .container{max-width:1260px; margin:0 auto; padding:24px 16px}

  /* ===== Stats Header ===== */
  .stats-grid{
    display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap:16px; margin-bottom:24px;
  }
  .stat-card{
    background:var(--card); padding:20px; border-radius:var(--radius);
    border:1px solid var(--line); display:flex; align-items:center; gap:16px;
    box-shadow:var(--shadow);
  }
  .stat-icon{
    width:48px; height:48px; border-radius:12px; display:flex;
    align-items:center; justify-content:center; font-size:1.4rem;
  }
  .stat-info .num{ font-size:1.5rem; font-weight:900; display:block }
  .stat-info .label{ font-size:0.85rem; color:var(--muted); font-weight:700 }

  /* ===== Main Card ===== */
  .main-card{
    background:var(--card); border-radius:var(--radius); border:1px solid var(--line);
    box-shadow:var(--shadow); overflow:hidden;
  }
  .card-header{
    padding:20px; border-bottom:1px solid var(--line);
    display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:16px;
  }
  .card-title{ font-size:1.4rem; font-weight:900; margin:0; display:flex; align-items:center; gap:10px }

  /* ===== Filters ===== */
  .filter-bar{
    padding:16px 20px; background:var(--brand-light); border-bottom:1px solid var(--line);
    display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end;
  }
  .search-box{ flex:1; min-width:250px }
  .input-group{ display:flex; flex-direction:column; gap:6px }
  .input-group label{ font-size:0.8rem; font-weight:800; color:var(--muted) }
  .input{ 
    padding:10px 14px; border:1px solid var(--line); border-radius:10px; 
    font-family:inherit; font-size:0.95rem; width:100%;
  }
  .btn{
    padding:10px 20px; border-radius:10px; font-weight:800; cursor:pointer;
    display:inline-flex; align-items:center; gap:8px; border:1px solid transparent;
    transition:0.2s; font-family:inherit;
  }
  .btn-primary{ background:var(--brand); color:#fff }
  .btn-primary:hover{ background:#1d4ed8; transform:translateY(-1px) }
  .btn-outline{ background:#fff; border-color:var(--line); color:var(--ink) }

  /* ===== Table Desktop ===== */
  .table-responsive{ overflow-x:auto }
  table{ width:100%; border-collapse:collapse; text-align:right }
  thead th{ 
    background:#f8fafc; padding:14px; font-weight:900; font-size:0.9rem;
    color:var(--muted); border-bottom:2px solid var(--line); position:sticky; top:0; z-index:10;
  }
  tbody td{ padding:14px; border-bottom:1px solid var(--line); vertical-align:middle }
  
  .report-title-cell{ display:flex; flex-direction:column; gap:4px }
  .report-title-cell .t{ font-weight:800; color:var(--ink); font-size:1rem }
  .report-title-cell .c{ font-size:0.8rem; color:var(--brand); font-weight:700; background:var(--brand-light); padding:2px 8px; border-radius:99px; width:fit-content }

  .idea-text{ 
    max-width:300px; font-size:0.9rem; color:var(--muted);
    display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;
  }

  .img-stack{ display:flex; gap:4px }
  .img-stack img{ width:40px; height:40px; border-radius:8px; object-fit:cover; border:1px solid var(--line) }

  .status-badge{
    padding:4px 10px; border-radius:99px; font-size:0.75rem; font-weight:800;
    display:inline-flex; align-items:center; gap:5px;
  }
  .status-completed{ background:#dcfce7; color:#166534 }
  .status-pending{ background:#fef9c3; color:#854d0e }

  .actions-cell{ display:flex; gap:6px }
  .btn-icon{ 
    width:36px; height:36px; border-radius:8px; display:flex; align-items:center; 
    justify-content:center; border:1px solid var(--line); background:#fff; color:var(--muted);
  }
  .btn-icon:hover{ border-color:var(--brand); color:var(--brand) }
  .btn-icon.del:hover{ border-color:var(--danger); color:var(--danger) }

  /* ===== Mobile Cards ===== */
  .mobile-list{ display:none; padding:16px; gap:16px; flex-direction:column }
  .m-card{ 
    background:#fff; border:1px solid var(--line); border-radius:16px; 
    padding:16px; display:flex; flex-direction:column; gap:12px;
  }
  .m-header{ display:flex; justify-content:space-between; align-items:flex-start }
  .m-date{ font-size:0.85rem; color:var(--muted); font-weight:700 }
  .m-title{ font-weight:900; font-size:1.1rem; margin:4px 0 }
  .m-body{ font-size:0.9rem; color:var(--muted); line-height:1.5 }
  .m-footer{ 
    margin-top:8px; padding-top:12px; border-top:1px dashed var(--line);
    display:flex; justify-content:space-between; align-items:center;
  }

  /* ===== Pagination ===== */
  .pagination{ padding:20px; display:flex; justify-content:center; gap:8px; align-items:center }
  .page-link{ 
    padding:8px 16px; border-radius:8px; border:1px solid var(--line); 
    text-decoration:none; color:var(--ink); font-weight:700;
  }
  .page-link.active{ background:var(--brand); color:#fff; border-color:var(--brand) }

  @media (max-width: 900px) {
    .table-responsive{ display:none }
    .mobile-list{ display:flex }
    .card-header{ flex-direction:column; align-items:flex-start }
  }
</style>
{% endblock %}

{% block content %}
<div class="container">
  <!-- Stats -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon" style="background:#e0e7ff; color:#4338ca"><i class="fas fa-file-alt"></i></div>
      <div class="stat-info">
        <span class="num">{{ stats.total }}</span>
        <span class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</span>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon" style="background:#dcfce7; color:#15803d"><i class="fas fa-calendar-check"></i></div>
      <div class="stat-info">
        <span class="num">{{ stats.this_month }}</span>
        <span class="label">ØªÙ‚Ø§Ø±ÙŠØ± Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</span>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon" style="background:#fef9c3; color:#a16207"><i class="fas fa-star"></i></div>
      <div class="stat-info">
        <span class="num">{{ reports.paginator.count }}</span>
        <span class="label">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«</span>
      </div>
    </div>
  </div>

  <div class="main-card">
    <div class="card-header">
      <h2 class="card-title"><i class="fas fa-list-ul text-primary"></i> Ø³Ø¬Ù„ ØªÙ‚Ø§Ø±ÙŠØ±ÙŠ</h2>
      <a href="{% url 'reports:add_report' %}" class="btn btn-primary">
        <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© ØªÙ‚Ø±ÙŠØ± Ø¬Ø¯ÙŠØ¯
      </a>
    </div>

    <!-- Filter Bar -->
    <form method="get" class="filter-bar">
      <div class="input-group search-box">
        <label>Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø£Ùˆ Ø§Ù„Ù…Ø­ØªÙˆÙ‰</label>
        <input type="text" name="q" value="{{ q }}" class="input" placeholder="Ø§ÙƒØªØ¨ ÙƒÙ„Ù…Ø§Øª Ù„Ù„Ø¨Ø­Ø«...">
      </div>
      <div class="input-group">
        <label>Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
        <input type="date" name="start_date" value="{{ start_date }}" class="input">
      </div>
      <div class="input-group">
        <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
        <input type="date" name="end_date" value="{{ end_date }}" class="input">
      </div>
      <div style="display:flex; gap:8px">
        <button type="submit" class="btn btn-primary">ØªØµÙÙŠØ©</button>
        {% if q or start_date or end_date %}
          <a href="{% url 'reports:my_reports' %}" class="btn btn-outline">Ù…Ø³Ø­</a>
        {% endif %}
      </div>
    </form>

    <!-- Desktop Table -->
    <div class="table-responsive">
      <table>
        <thead>
          <tr>
            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            <th>Ø§Ù„ØªÙ‚Ø±ÙŠØ±</th>
            <th>Ø§Ù„Ù…Ø³ØªÙÙŠØ¯ÙˆÙ†</th>
            <th>Ø§Ù„ÙˆØµÙ</th>
            <th>Ø§Ù„ØµÙˆØ±</th>
            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr>
        </thead>
        <tbody>
          {% for report in reports %}
          <tr>
            <td>
              <div style="font-weight:800">{{ report.report_date|date:"Y-m-d" }}</div>
              <div style="font-size:0.8rem; color:var(--muted)">{{ report.day_name }}</div>
            </td>
            <td>
              <div class="report-title-cell">
                <span class="t">{{ report.title }}</span>
                <span class="c">{{ report.category.name|default:"Ø¹Ø§Ù…" }}</span>
              </div>
            </td>
            <td style="text-align:center; font-weight:800">{{ report.beneficiaries_count|default:"0" }}</td>
            <td>
              <div class="idea-text" title="{{ report.idea }}">{{ report.idea }}</div>
            </td>
            <td>
              <div class="img-stack js-gallery" data-report="{{ report.pk }}">
                {% if report.image1 %}<img src="{{ report.image1.url }}" data-full="{{ report.image1.url }}" class="zoom-cur">{% endif %}
                {% if report.image2 %}<img src="{{ report.image2.url }}" data-full="{{ report.image2.url }}" class="zoom-cur">{% endif %}
                {% if report.image3 %}<img src="{{ report.image3.url }}" data-full="{{ report.image3.url }}" class="zoom-cur">{% endif %}
                {% if report.image4 %}<img src="{{ report.image4.url }}" data-full="{{ report.image4.url }}" class="zoom-cur">{% endif %}
              </div>
            </td>
            <td>
              <div class="actions-cell">
                <a href="{% url 'reports:edit_my_report' report.pk %}" class="btn-icon" title="ØªØ¹Ø¯ÙŠÙ„"><i class="fas fa-edit"></i></a>
                <a href="{% url 'reports:report_print' report.pk %}" target="_blank" rel="noopener" class="btn-icon" title="Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±"><i class="fas fa-eye"></i></a>
                <form action="{% url 'reports:delete_my_report' report.pk %}" method="post" onsubmit="return confirm('Ø­Ø°Ù Ø§Ù„ØªÙ‚Ø±ÙŠØ±ØŸ')">
                  {% csrf_token %}
                  <button type="submit" class="btn-icon del"><i class="fas fa-trash"></i></button>
                </form>
              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="6" style="padding:60px; text-align:center">
              <div style="font-size:3rem; color:var(--line); margin-bottom:16px"><i class="fas fa-folder-open"></i></div>
              <h3 style="color:var(--muted)">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚Ø§Ø±ÙŠØ± ØªØ·Ø§Ø¨Ù‚ Ø¨Ø­Ø«Ùƒ</h3>
              <p style="color:var(--muted)">Ø¬Ø±Ø¨ ØªØºÙŠÙŠØ± Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„ØªØµÙÙŠØ© Ø£Ùˆ Ø£Ø¶Ù ØªÙ‚Ø±ÙŠØ±Ø§Ù‹ Ø¬Ø¯ÙŠØ¯Ø§Ù‹.</p>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Mobile List -->
    <div class="mobile-list">
      {% for report in reports %}
      <div class="m-card">
        <div class="m-header">
          <span class="m-date">{{ report.report_date|date:"Y-m-d" }} â€¢ {{ report.day_name }}</span>
        </div>
        <h3 class="m-title">{{ report.title }}</h3>
        <div class="m-body">{{ report.idea|truncatechars:100 }}</div>
        
        <div class="m-footer">
          <div class="img-stack js-gallery" data-report="{{ report.pk }}">
            {% if report.image1 %}<img src="{{ report.image1.url }}" data-full="{{ report.image1.url }}">{% endif %}
            {% if report.image2 %}<img src="{{ report.image2.url }}" data-full="{{ report.image2.url }}">{% endif %}
          </div>
          <div class="actions-cell">
            <a href="{% url 'reports:edit_my_report' report.pk %}" class="btn-icon"><i class="fas fa-edit"></i></a>
            <a href="{% url 'reports:report_print' report.pk %}" target="_blank" rel="noopener" class="btn-icon" title="Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±"><i class="fas fa-eye"></i></a>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- Pagination -->
    {% if reports.paginator.num_pages > 1 %}
    <div class="pagination">
      {% if reports.has_previous %}
        <a href="?page={{ reports.previous_page_number }}{% if qs %}&{{ qs }}{% endif %}" class="page-link">Ø§Ù„Ø³Ø§Ø¨Ù‚</a>
      {% endif %}
      
      <span class="page-link active">{{ reports.number }} / {{ reports.paginator.num_pages }}</span>

      {% if reports.has_next %}
        <a href="?page={{ reports.next_page_number }}{% if qs %}&{{ qs }}{% endif %}" class="page-link">Ø§Ù„ØªØ§Ù„ÙŠ</a>
      {% endif %}
    </div>
    {% endif %}
  </div>
</div>

<!-- Modal Gallery -->
<div id="imageModal" style="display:none;position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,.9);place-items:center;padding:20px">
  <button onclick="window.myReportsCloseModal()" style="position:absolute;top:20px;right:20px;background:none;border:none;color:#fff;font-size:2rem;cursor:pointer">&times;</button>
  <img id="modalImage" style="max-width:100%; max-height:90vh; border-radius:12px; box-shadow:0 0 30px rgba(0,0,0,0.5)">
  <div style="position:absolute; bottom:40px; display:flex; gap:20px">
    <button id="prevBtn" class="btn btn-outline" style="border-radius:50%; width:50px; height:50px; padding:0; justify-content:center"><i class="fas fa-chevron-right"></i></button>
    <button id="nextBtn" class="btn btn-outline" style="border-radius:50%; width:50px; height:50px; padding:0; justify-content:center"><i class="fas fa-chevron-left"></i></button>
  </div>
</div>

<script>
  (function(){
    const modal = document.getElementById('imageModal');
    const imgEl = document.getElementById('modalImage');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    let currentList = [];
    let index = 0;

    function show(i){
      index = (i + currentList.length) % currentList.length;
      imgEl.src = currentList[index];
    }

    window.myReportsCloseModal = () => { modal.style.display = 'none'; document.body.style.overflow='auto'; };

    document.querySelectorAll('.js-gallery').forEach(gal => {
      const imgs = Array.from(gal.querySelectorAll('img')).map(i => i.dataset.full);
      gal.querySelectorAll('img').forEach((img, i) => {
        img.onclick = () => {
          currentList = imgs;
          index = i;
          show(index);
          modal.style.display = 'grid';
          document.body.style.overflow='hidden';
        };
      });
    });

    prevBtn.onclick = (e) => { e.stopPropagation(); show(index - 1); };
    nextBtn.onclick = (e) => { e.stopPropagation(); show(index + 1); };
    modal.onclick = () => window.myReportsCloseModal();
    imgEl.onclick = (e) => e.stopPropagation();
  })();
</script>
{% endblock %}
