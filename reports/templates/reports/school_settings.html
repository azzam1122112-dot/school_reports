{% extends "base.html" %}
{% block title %}إعدادات المدرسة{% endblock %}

{% block head %}
<style>
  /* ✅ Scoped only (بدون لمس :root نهائياً) */
  .school-settings{max-width:980px;margin:0 auto;padding:clamp(10px,2.2vw,18px)}
  .ss-shell{
    background:var(--card);
    border:1px solid var(--line-2);
    border-radius:18px;
    box-shadow:var(--shadow);
    overflow:hidden;
  }

  /* Header */
  .ss-head{
    padding:clamp(16px,2.2vw,22px) clamp(16px,3vw,26px);
    background:
      radial-gradient(900px 220px at 18% 0%, rgba(37,99,235,.18), transparent 55%),
      radial-gradient(700px 220px at 85% 90%, rgba(16,185,129,.14), transparent 60%),
      linear-gradient(135deg, rgba(37,99,235,.92), rgba(59,130,246,.86));
    color:#fff;
    position:relative;
  }
  .ss-head-top{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap}
  .ss-title{
    margin:0;
    font-weight:950;
    font-size:clamp(1.15rem,2.4vw,1.6rem);
    display:flex;align-items:center;gap:10px;
  }
  .ss-sub{margin:6px 0 0;opacity:.95;font-weight:850;line-height:1.65}
  .ss-chip{
    display:inline-flex;align-items:center;gap:8px;
    padding:8px 12px;border-radius:999px;
    background:rgba(255,255,255,.14);
    border:1px solid rgba(255,255,255,.22);
    backdrop-filter: blur(10px);
    font-weight:900;
    white-space:nowrap;
  }

  /* Body */
  .ss-body{padding:clamp(14px,2.6vw,22px)}
  .ss-grid{display:grid;grid-template-columns:repeat(2,minmax(280px,1fr));gap:14px}
  @media(max-width:900px){.ss-grid{grid-template-columns:1fr}}

  .ss-group{display:block}
  .ss-label{
    display:flex;align-items:center;gap:10px;
    margin:0 0 8px;
    font-weight:950;
    color:var(--ink);
  }
  .ss-label i{color:rgba(37,99,235,.95)}
  .ss-hint{margin-top:6px;color:var(--muted);font-weight:800;font-size:.88rem;line-height:1.6}

  /* Inputs (نفس روح المنصة) */
  .ss-body input:not([type="checkbox"]):not([type="file"]),
  .ss-body select,
  .ss-body textarea{
    width:100%;
    min-height:var(--tap);
    border-radius:14px;
    border:1px solid var(--line);
    padding:12px 14px;
    background:rgba(248,250,252,.85);
    font-weight:850;
    transition: box-shadow .18s ease, border-color .18s ease, transform .12s ease;
  }
  html[data-theme="dark"] .ss-body input:not([type="checkbox"]):not([type="file"]),
  html[data-theme="dark"] .ss-body select,
  html[data-theme="dark"] .ss-body textarea{
    background: rgba(255,255,255,.04);
    border-color: rgba(148,163,184,.16);
  }
  .ss-body input:not([type="checkbox"]):not([type="file"]):focus,
  .ss-body select:focus,
  .ss-body textarea:focus{
    outline:none;
    border-color:var(--brand);
    box-shadow:var(--ring);
  }

  /* File input */
  .file-wrap{
    border:1px dashed rgba(37,99,235,.35);
    background:rgba(37,99,235,.04);
    border-radius:16px;
    padding:12px;
  }
  html[data-theme="dark"] .file-wrap{background:rgba(37,99,235,.06);border-color:rgba(96,165,250,.25)}
  .ss-body input[type="file"]{
    width:100%;
    padding:10px;
    border-radius:12px;
    border:1px solid var(--line);
    background:var(--card);
    font-weight:850;
  }

  /* Preview */
  .preview{
    margin-top:10px;
    display:flex;
    align-items:center;
    gap:12px;
    padding:10px 12px;
    border-radius:16px;
    border:1px solid var(--line-2);
    background:rgba(248,250,252,.65);
  }
  html[data-theme="dark"] .preview{background:rgba(255,255,255,.03)}
  .preview img{
    width:58px;height:58px;
    border-radius:16px;
    object-fit:contain;
    border:1px solid var(--line-2);
    background:var(--card);
  }
  .preview b{font-weight:950;color:var(--ink)}
  .preview small{display:block;color:var(--muted);font-weight:850;margin-top:2px}

  /* Errors */
  .field-error{margin-top:6px;color:#b91c1c;font-weight:900;font-size:.9rem}
  html[data-theme="dark"] .field-error{color:#fecaca}
  .nferr{
    margin-bottom:12px;
    padding:12px 14px;
    border-radius:16px;
    border:1px solid rgba(254,202,202,.9);
    background:rgba(254,242,242,.92);
    color:#991b1b;
    font-weight:900;
  }

  /* Actions */
  .ss-actions{
    margin-top:16px;
    padding-top:14px;
    border-top:1px solid var(--line-2);
    display:flex;
    gap:12px;
    justify-content:flex-start;
    flex-wrap:wrap;
  }
  .ss-actions .btn{border-radius:14px}
  .ss-actions .btn-primary{min-width:220px}
  @media(max-width:560px){
    .ss-actions{flex-direction:column}
    .ss-actions .btn,
    .ss-actions .btn-primary{width:100%}
  }

  /* Compact: make long fields span full width */
  .span-2{grid-column:1/-1}
</style>
{% endblock %}

{% block content %}
<div class="school-settings" dir="rtl">
  <div class="ss-shell">

    <div class="ss-head">
      <div class="ss-head-top">
        <div>
          <h1 class="ss-title">
            <i class="fa-solid fa-gear" aria-hidden="true"></i>
            إعدادات المدرسة
          </h1>
          <p class="ss-sub">تحديث بيانات المدرسة والشعار، مع الحفاظ على هوية الطباعة الخاصة بكم.</p>
        </div>
        <div class="ss-chip">
          <i class="fa-solid fa-shield-halved" aria-hidden="true"></i>
          <span>حفظ آمن</span>
        </div>
      </div>
    </div>

    <div class="ss-body">
      {% if form.non_field_errors %}
        <div class="nferr" role="alert">
          {% for e in form.non_field_errors %}{{ e }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
        </div>
      {% endif %}

      <form method="post" enctype="multipart/form-data" novalidate>
        {% csrf_token %}

        <div class="ss-grid">
          <!-- اسم المدرسة -->
          <div class="ss-group span-2">
            <label class="ss-label" for="{{ form.name.id_for_label }}">
              <i class="fa-solid fa-school" aria-hidden="true"></i> اسم المدرسة
            </label>
            {{ form.name }}
            {% for e in form.name.errors %}<div class="field-error">{{ e }}</div>{% endfor %}
            <div class="ss-hint">سيظهر الاسم في أعلى النظام وفي القوالب.</div>
          </div>

          <!-- المرحلة -->
          <div class="ss-group">
            <label class="ss-label" for="{{ form.stage.id_for_label }}">
              <i class="fa-solid fa-layer-group" aria-hidden="true"></i> المرحلة
            </label>
            {{ form.stage }}
            {% for e in form.stage.errors %}<div class="field-error">{{ e }}</div>{% endfor %}
          </div>

          <!-- الجنس -->
          <div class="ss-group">
            <label class="ss-label" for="{{ form.gender.id_for_label }}">
              <i class="fa-solid fa-children" aria-hidden="true"></i> بنين / بنات
            </label>
            {{ form.gender }}
            {% for e in form.gender.errors %}<div class="field-error">{{ e }}</div>{% endfor %}
          </div>

          <!-- المدينة -->
          <div class="ss-group">
            <label class="ss-label" for="{{ form.city.id_for_label }}">
              <i class="fa-solid fa-location-dot" aria-hidden="true"></i> المدينة
            </label>
            {{ form.city }}
            {% for e in form.city.errors %}<div class="field-error">{{ e }}</div>{% endfor %}
          </div>

          <!-- الجوال -->
          <div class="ss-group">
            <label class="ss-label" for="{{ form.phone.id_for_label }}">
              <i class="fa-solid fa-phone" aria-hidden="true"></i> رقم الجوال
            </label>
            {{ form.phone }}
            {% for e in form.phone.errors %}<div class="field-error">{{ e }}</div>{% endfor %}
            <div class="ss-hint">يفضّل صيغة 05XXXXXXXX.</div>
          </div>

          <!-- لون الطباعة -->
          <div class="ss-group span-2">
            <label class="ss-label" for="{{ form.print_primary_color.id_for_label }}">
              <i class="fa-solid fa-palette" aria-hidden="true"></i> لون قالب الطباعة
            </label>
            {{ form.print_primary_color }}
            {% for e in form.print_primary_color.errors %}<div class="field-error">{{ e }}</div>{% endfor %}
            <div class="ss-hint">إن تركته فارغًا سيتم استخدام اللون الافتراضي للنظام في ترويسة تقرير الطباعة.</div>
          </div>

          <!-- رفع شعار -->
          <div class="ss-group span-2">
            <label class="ss-label" for="{{ form.logo_file.id_for_label }}">
              <i class="fa-solid fa-image" aria-hidden="true"></i> رفع الشعار (ملف)
            </label>

            <div class="file-wrap">
              {{ form.logo_file }}
              {% for e in form.logo_file.errors %}<div class="field-error">{{ e }}</div>{% endfor %}
              <div class="ss-hint">PNG / JPG / SVG / WEBP — سيتم استخدام المرفوع أولاً إن وُجد.</div>
            </div>
          </div>

          <!-- رابط شعار -->
          <div class="ss-group span-2">
            <label class="ss-label" for="{{ form.logo_url.id_for_label }}">
              <i class="fa-solid fa-link" aria-hidden="true"></i> رابط الشعار (اختياري)
            </label>
            {{ form.logo_url }}
            {% for e in form.logo_url.errors %}<div class="field-error">{{ e }}</div>{% endfor %}
            <div class="ss-hint">يُستخدم إذا لم يتوفر شعار مرفوع.</div>

            {% if school.logo_file %}
              <div class="preview" aria-label="معاينة الشعار الحالي">
                <img src="{{ school.logo_file.url }}" alt="الشعار الحالي">
                <div>
                  <b>معاينة الشعار الحالي</b>
                  <small>المصدر: شعار مرفوع</small>
                </div>
              </div>
            {% elif school.logo_url %}
              <div class="preview" aria-label="معاينة الشعار الحالي">
                <img src="{{ school.logo_url }}" alt="شعار المدرسة الحالي">
                <div>
                  <b>معاينة الشعار الحالي</b>
                  <small>المصدر: رابط</small>
                </div>
              </div>
            {% endif %}
          </div>
        </div>

        <div class="ss-actions">
          <button type="submit" class="btn btn-primary" id="submitBtn">
            <i class="fa-solid fa-floppy-disk" aria-hidden="true"></i>
            حفظ التغييرات
          </button>

          <a href="{% url 'reports:admin_dashboard' %}" class="btn btn-outline">
            <i class="fa-solid fa-arrow-right" aria-hidden="true"></i>
            رجوع
          </a>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // تحسين إدخال الجوال (بدون تعديل Widgets في الفورم)
    const phone = document.getElementById("{{ form.phone.id_for_label }}") || document.getElementById("id_phone");
    if(phone){
      phone.setAttribute("inputmode","tel");
      phone.setAttribute("pattern","05\\d{8}");
      phone.setAttribute("maxlength","10");
      phone.dir="ltr";
      phone.style.textAlign="left";
    }

    // منع الإرسال المزدوج
    const form = document.querySelector(".school-settings form");
    const btn = document.getElementById("submitBtn");
    if(form && btn){
      form.addEventListener("submit", function(){
        btn.disabled = true;
        btn.style.opacity = ".75";
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin" aria-hidden="true"></i> جارٍ الحفظ...';
      });
    }
  });
</script>
{% endblock %}
