{# reports/templates/reports/officer_reports.html (or officer_reports.html) #}
{% extends "base.html" %}
{% load static %}

{% block title %}Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ - ØªÙ‚Ø§Ø±ÙŠØ± Ù‚Ø³Ù…ÙŠ{% endblock %}

{% block head %}
<style>
  /* =========================================================
     Officer Reports (Scoped)
     - Ø¨Ø¯ÙˆÙ† Ù„Ù…Ø³ Ø³ØªØ§ÙŠÙ„Ø§Øª base Ø§Ù„Ø¹Ø§Ù…Ø© Ø®Ø§Ø±Ø¬ .or-scope
     - Ù…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ data-theme Ù„Ù„Ø¯Ø§Ø±Ùƒ/Ù„Ø§ÙŠØª
     ========================================================= */
  .or-scope{
    /* NOTE: do NOT self-reference CSS variables (e.g. var(--ink, ...))
       because that creates a cycle and results in transparent/invalid styles.
       Keep these values self-contained inside the scope. */
    --ink:#0f172a;
    --ink-soft:#334155;
    --muted:#64748b;
    --line:#e5e7eb;
    --card:#ffffff;
    --bg:#f8fafc;
    --brand:#2563eb;
    --accent:#10b981;
    --danger:#ef4444;
    --shadow:0 10px 28px rgba(2,6,23,.08);
    --t:.18s ease;
  }

  html[data-theme="dark"] .or-scope{
    --ink:#e5e7eb;
    --ink-soft:#cbd5e1;
    --muted:#94a3b8;
    --line:#1b2744;
    --card: rgba(15,23,42,.55);
    --bg: rgba(15,23,42,.35);
    --shadow:0 10px 28px rgba(0,0,0,.35);
  }

  .or-scope .wrap{max-width:1400px;margin-inline:auto;padding:18px 14px}
  .or-scope .page-head{margin-bottom:14px}
  .or-scope .title{
    margin:0;
    font-weight:950;
    font-size:1.35rem;
    color:var(--ink);
    display:flex;
    gap:10px;
    align-items:center;
    flex-wrap:wrap;
  }
  .or-scope .subtitle{
    margin:6px 0 0;
    color:var(--muted);
    font-weight:850;
    line-height:1.7;
  }

  /* Card Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙØ­Ø© ÙÙ‚Ø· */
  .or-scope .card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:16px;
    box-shadow:var(--shadow);
    padding:18px;
  }

  /* ===== Filters ===== */
  .or-scope .filters-form{margin-bottom:16px}
  .or-scope .filters-grid{
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
    gap:12px;
  }
  .or-scope .filter-group{display:flex;flex-direction:column;gap:6px}
  .or-scope .filter-group label{font-weight:950;color:var(--muted)}
  .or-scope .filter-input{
    padding:11px 12px;
    border:1px solid var(--line);
    border-radius:12px;
    font:inherit;
    background:#fff;
    color:var(--ink);
    min-height:44px;
    outline:none;
    transition: box-shadow .18s ease, border-color .18s ease;
  }
  .or-scope .filter-input:focus{
    border-color: rgba(37,99,235,.55);
    box-shadow: 0 0 0 4px rgba(37,99,235,.12);
  }
  html[data-theme="dark"] .or-scope .filter-input{
    background: rgba(15,23,42,.55);
    border-color: #1b2744;
  }
  html[data-theme="dark"] .or-scope .filter-input:focus{
    border-color: rgba(96,165,250,.55);
    box-shadow: 0 0 0 4px rgba(96,165,250,.14);
  }

  .or-scope .filter-actions{
    margin-top:12px;
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    justify-content:flex-start;
  }

  /* ===== Buttons (Scoped) ===== */
  .or-scope .btn{
    display:inline-flex;align-items:center;justify-content:center;gap:8px;
    padding:10px 14px;border-radius:12px;
    font-weight:950;text-decoration:none;
    border:1px solid var(--line);
    background:#fff;color:var(--ink);
    cursor:pointer;
    transition:transform .15s ease, filter .15s ease, background .15s ease, box-shadow .15s ease;
    min-height:44px;
    user-select:none;
  }
  .or-scope .btn:hover{transform:translateY(-1px)}
  .or-scope .btn:active{transform:translateY(0)}
  .or-scope .btn-primary{background:var(--brand);border-color:var(--brand);color:#fff}
  .or-scope .btn-outline{background:#fff;border-color:#cbd5e1;color:var(--ink)}
  .or-scope .btn-print{background:var(--accent);border-color:var(--accent);color:#fff}
  .or-scope .btn-danger{background:var(--danger);border-color:var(--danger);color:#fff}
  .or-scope .btn-ico{padding:10px 12px;min-width:44px}

  html[data-theme="dark"] .or-scope .btn-outline{
    background: rgba(15,23,42,.45);
    border-color:#1b2744;
    color: #e5e7eb;
  }

  /* ===== Table ===== */
  .or-scope .table-responsive{
    overflow:auto;
    border:1px solid var(--line);
    border-radius:16px;
    margin-top:10px
  }
  .or-scope table{width:100%;border-collapse:collapse;min-width:1100px;background:#fff}
  html[data-theme="dark"] .or-scope table{background: rgba(15,23,42,.35)}
  .or-scope thead th{
    background:#f8fafc;
    border-bottom:1px solid var(--line);
    padding:12px 10px;
    text-align:right;
    color:var(--ink);
    font-weight:950;
    white-space:nowrap;
  }
  html[data-theme="dark"] .or-scope thead th{
    background: rgba(15,23,42,.55);
    border-color:#1b2744;
    color:#e5e7eb;
  }
  .or-scope tbody td{
    border-bottom:1px solid var(--line);
    padding:12px 10px;
    vertical-align:top;
    color:var(--ink-soft);
    font-weight:850;
  }
  html[data-theme="dark"] .or-scope tbody td{
    border-color:#1b2744;
    color:#cbd5e1;
  }
  .or-scope tbody tr:hover{background:#f8fafc}
  html[data-theme="dark"] .or-scope tbody tr:hover{background: rgba(26,44,83,.35)}

  .or-scope .muted{color:var(--muted);font-weight:850}
  .or-scope .text-center{text-align:center}

  /* Images in table */
  .or-scope .table-images{display:flex;gap:8px;flex-wrap:wrap}
  .or-scope .table-images img{
    width:54px;height:54px;object-fit:cover;border-radius:10px;
    border:1px solid var(--line);
    cursor:zoom-in;
    background:#f8fafc;
  }
  html[data-theme="dark"] .or-scope .table-images img{border-color:#1b2744;background: rgba(15,23,42,.35)}

  /* ===== Mobile Cards ===== */
  .or-scope .cards-view{display:grid;gap:12px;margin-top:10px}
  .or-scope .report-card{
    background:#fff;border:1px solid var(--line);
    border-radius:16px;box-shadow:var(--shadow);
    padding:14px;
    display:grid;
    gap:10px;
  }
  html[data-theme="dark"] .or-scope .report-card{
    background: rgba(15,23,42,.35);
    border-color:#1b2744;
  }
  .or-scope .report-header{
    display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;
    font-weight:950;color:var(--ink);
  }
  html[data-theme="dark"] .or-scope .report-header{color:#e5e7eb}
  .or-scope .report-program{margin:0;color:var(--muted);font-weight:950;line-height:1.7}
  .or-scope .report-idea{margin:0;color:var(--ink-soft);font-weight:850;line-height:1.9}
  html[data-theme="dark"] .or-scope .report-idea{color:#cbd5e1}
  .or-scope .report-images{display:flex;gap:8px;flex-wrap:wrap}
  .or-scope .report-images img{
    width:72px;height:72px;object-fit:cover;border-radius:12px;border:1px solid var(--line);
    cursor:zoom-in;background:#f8fafc
  }
  html[data-theme="dark"] .or-scope .report-images img{border-color:#1b2744;background: rgba(15,23,42,.35)}
  .or-scope .card-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

  /* ===== Pagination ===== */
  .or-scope .pagination{
    display:flex;gap:10px;align-items:center;justify-content:center;
    margin-top:16px;flex-wrap:wrap
  }
  .or-scope .page-btn{
    padding:9px 14px;border:1px solid var(--line);
    border-radius:12px;background:#fff;color:var(--ink);
    text-decoration:none;font-weight:950;
  }
  html[data-theme="dark"] .or-scope .page-btn{background: rgba(15,23,42,.45);border-color:#1b2744;color:#e5e7eb}
  .or-scope .page-current{color:var(--muted);font-weight:950}

  /* ===== Modal ===== */
  .or-scope .modal{
    display:none;
    position:fixed;inset:0;
    background:rgba(0,0,0,.6);
    z-index:2000;
    justify-content:center;align-items:center;
    padding:18px;
    overflow:auto;
  }
  .or-scope .modal.is-open{display:flex}
  .or-scope .modal-dialog{
    width:min(820px, 100%);
    background:var(--card);
    border-radius:18px;
    border:1px solid var(--line);
    box-shadow:0 24px 80px rgba(0,0,0,.35);
    position:relative;
    padding:16px;
  }
  .or-scope .modal-close{
    position:absolute;top:12px;left:12px;
    width:42px;height:42px;border-radius:999px;
    border:1px solid #fecaca;
    background:#fee2e2;color:#991b1b;
    cursor:pointer;font-weight:950;
    display:grid;place-items:center;
  }
  .or-scope .modal-title{margin:0 0 10px 0;font-weight:950;color:var(--ink)}
  .or-scope .modal-idea{
    white-space:pre-line;
    margin:10px 0;
    font-size:15px;
    line-height:1.9;
    color:var(--ink-soft);
    padding:12px;
    background:#f8fafc;
    border:1px solid var(--line);
    border-radius:14px;
    overflow-wrap:anywhere;
  }
  html[data-theme="dark"] .or-scope .modal-idea{
    background: rgba(15,23,42,.45);
    border-color:#1b2744;
    color:#cbd5e1;
  }
  .or-scope .modal-meta{
    display:grid;
    grid-template-columns:1fr;
    gap:6px;
    margin-top:8px;
    color:var(--muted);
    font-weight:950;
  }
  @media(min-width:720px){
    .or-scope .modal-meta{grid-template-columns:1fr 1fr}
  }
  .or-scope .modal-images{
    margin-top:14px;
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(140px,1fr));
    gap:12px;
  }
  .or-scope .modal-images img{
    width:100%;height:140px;object-fit:cover;border-radius:14px;
    border:1px solid var(--line);
    box-shadow:0 6px 16px rgba(0,0,0,.12);
    cursor:zoom-in;
    transition:transform .2s ease;
    background:#f8fafc;
  }
  html[data-theme="dark"] .or-scope .modal-images img{border-color:#1b2744;background: rgba(15,23,42,.35)}
  .or-scope .modal-images img:hover{transform:scale(1.03)}

  /* ===== Responsive: hide/show ===== */
  .or-scope .desktop-only{display:block}
  .or-scope .mobile-only{display:none}
  @media(max-width: 860px){
    .or-scope .desktop-only{display:none}
    .or-scope .mobile-only{display:block}
  }

  @media (prefers-reduced-motion: reduce){
    .or-scope .btn,
    .or-scope .modal-images img{transition:none !important}
    .or-scope .btn:hover,
    .or-scope .modal-images img:hover{transform:none !important}
  }
</style>
{% endblock %}

{% block content %}
<div class="or-scope" dir="rtl">
  <div class="wrap">

    <!-- Header -->
    <header class="page-head">
      <h1 class="title">ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ â€“ ØªÙ‚Ø§Ø±ÙŠØ± Ù‚Ø³Ù…ÙŠ</h1>
      <p class="subtitle">
        Ø¹Ø±Ø¶ ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù‚Ø³Ù…:
        <b>{% if department %}{{ department.name }}{% else %}â€”{% endif %}</b>
      </p>
    </header>

    <div class="card">

      <!-- Filters -->
      <form method="get" class="filters-form" novalidate>
        <div class="filters-grid">

          <div class="filter-group">
            <label for="orStartDate">ğŸ“… Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
            <input id="orStartDate" type="date" name="start_date" value="{{ start_date }}" class="filter-input">
          </div>

          <div class="filter-group">
            <label for="orEndDate">ğŸ“… Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
            <input id="orEndDate" type="date" name="end_date" value="{{ end_date }}" class="filter-input">
          </div>

          <div class="filter-group">
            <label for="orTeacherName">ğŸ‘¨â€ğŸ« Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…</label>
            <input
              id="orTeacherName"
              type="text"
              name="teacher_name"
              value="{{ teacher_name }}"
              placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù… Ø£Ùˆ Ø¬Ø²Ø¡ Ù…Ù†Ù‡"
              class="filter-input"
              autocomplete="off"
            >
          </div>

          {% if categories %}
            <div class="filter-group">
              <label for="orCategory">ğŸ·ï¸ Ø§Ù„ØªØµÙ†ÙŠÙ (Ø®Ø§Øµ Ø¨Ù‚Ø³Ù…ÙŠ)</label>
              <select id="orCategory" name="category" class="filter-input">
                <option value="">ÙƒÙ„ ØªØµÙ†ÙŠÙØ§Øª Ù‚Ø³Ù…ÙŠ</option>
                {% for c_val, c_label in categories %}
                  <option value="{{ c_val }}" {% if category == c_val %}selected{% endif %}>{{ c_label }}</option>
                {% endfor %}
              </select>
            </div>
          {% endif %}
        </div>

        <div class="filter-actions">
          <button class="btn btn-primary" type="submit">âœ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±</button>
          {% if start_date or end_date or teacher_name or category %}
            <a href="{{ request.path }}" class="btn btn-outline">ğŸ§¹ Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±</a>
          {% endif %}
        </div>
      </form>

      {# Ù†Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ querystring Ù„Ù„ØªØ±Ù‚ÙŠÙ… (Ø¨Ø¯ÙˆÙ† Ø§Ø³ØªØ¯Ø¹Ø§Ø¡Ø§Øª Ø¯ÙˆØ§Ù„ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù‚Ø§Ù„Ø¨) #}
      {% with qsp="" %}
        {% if start_date %}{% with qsp=qsp|add:"&start_date="|add:start_date %}{% endwith %}{% endif %}
        {% if end_date %}{% with qsp=qsp|add:"&end_date="|add:end_date %}{% endwith %}{% endif %}
        {% if teacher_name %}{% with qsp=qsp|add:"&teacher_name="|add:teacher_name|urlencode %}{% endwith %}{% endif %}
        {% if category %}{% with qsp=qsp|add:"&category="|add:category %}{% endwith %}{% endif %}

        <!-- Desktop Table -->
        <div class="table-responsive desktop-only">
          <table class="reports-table">
            <thead>
              <tr>
                <th>ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th>ğŸ‘¨â€ğŸ« Ø§Ù„Ù…Ø¹Ù„Ù…</th>
                <th>ğŸ“– Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
                <th>ğŸ·ï¸ Ø§Ù„ØªØµÙ†ÙŠÙ</th>
                <th class="text-center">ğŸ‘¥ Ø§Ù„Ù…Ø³ØªÙÙŠØ¯ÙˆÙ†</th>
                <th>ğŸ’¡ Ø§Ù„ÙÙƒØ±Ø©</th>
                <th>ğŸ–¼ Ø§Ù„ØµÙˆØ±</th>
                <th>âš™ï¸ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
              </tr>
            </thead>
            <tbody>
              {% for r in reports %}
                <tr>
                  <td>
                    {{ r.report_date|date:"Y-m-d" }}<br>
                    <small class="muted">{{ r.day_name|default_if_none:"" }}</small>
                  </td>

                  <td>
                    {% if r.teacher_name %}
                      {{ r.teacher_name }}
                    {% else %}
                      {% if r.teacher and r.teacher.name %}
                        {{ r.teacher.name }}
                      {% else %}
                        â€”
                      {% endif %}
                    {% endif %}
                  </td>

                  <td>{{ r.title|default:"â€”" }}</td>

                  <td>
                    {% if r.category and r.category.name %}
                      {{ r.category.name }}
                    {% else %}
                      {% if r.category %}{{ r.category }}{% else %}â€”{% endif %}
                    {% endif %}
                  </td>

                  <td class="text-center">{{ r.beneficiaries_count|default_if_none:"â€”" }}</td>

                  <td>
                    <textarea id="idea-{{ r.pk }}" style="display:none;">{{ r.idea|default_if_none:''|escape }}</textarea>
                    {{ r.idea|default_if_none:""|truncatewords:12 }}
                  </td>

                  <td>
                    <div class="table-images">
                      {% if r.image1 %}<img src="{{ r.image1.url }}" alt="ØµÙˆØ±Ø©" data-full="{{ r.image1.url }}">{% endif %}
                      {% if r.image2 %}<img src="{{ r.image2.url }}" alt="ØµÙˆØ±Ø©" data-full="{{ r.image2.url }}">{% endif %}
                      {% if r.image3 %}<img src="{{ r.image3.url }}" alt="ØµÙˆØ±Ø©" data-full="{{ r.image3.url }}">{% endif %}
                      {% if r.image4 %}<img src="{{ r.image4.url }}" alt="ØµÙˆØ±Ø©" data-full="{{ r.image4.url }}">{% endif %}
                    </div>
                  </td>

                  <td>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
                      <button
                        class="btn btn-primary js-show"
                        type="button"
                        data-idea-id="idea-{{ r.pk }}"
                        data-teacher="{% if r.teacher_name %}{{ r.teacher_name|escapejs }}{% else %}{% if r.teacher and r.teacher.name %}{{ r.teacher.name|escapejs }}{% endif %}{% endif %}"
                        data-title="{{ r.title|default_if_none:''|escapejs }}"
                        data-date="{{ r.report_date|date:'Y-m-d' }} - {{ r.day_name|default_if_none:''|escapejs }}"
                        data-images="{% if r.image1 %}{{ r.image1.url }}{% endif %}|{% if r.image2 %}{{ r.image2.url }}{% endif %}|{% if r.image3 %}{{ r.image3.url }}{% endif %}|{% if r.image4 %}{{ r.image4.url }}{% endif %}"
                        aria-label="Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„"
                        title="Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„"
                      ><i class="fa-solid fa-eye" aria-hidden="true"></i> Ø¹Ø±Ø¶</button>

                      <a
                        href="{% url 'reports:report_print' r.pk %}?next={{ request.get_full_path|urlencode }}"
                        target="_blank"
                        rel="noopener"
                        class="btn btn-print"
                        aria-label="Ø·Ø¨Ø§Ø¹Ø©"
                        title="Ø·Ø¨Ø§Ø¹Ø©"
                      ><i class="fa-solid fa-print" aria-hidden="true"></i> Ø·Ø¨Ø§Ø¹Ø©</a>

                      {# Ø­Ø³Ø¨ Ø³ÙŠØ§Ø³ØªÙƒ: Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ø±Ø¶/Ø·Ø¨Ø§Ø¹Ø© ÙÙ‚Ø· â€” Ø§Ù„Ø­Ø°Ù ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø¥Ø°Ø§ Ù…Ø±Ø±Øª can_delete=True #}
                      {% if can_delete %}
                        <form method="post" action="{% url 'reports:officer_delete_report' r.pk %}">
                          {% csrf_token %}
                          <input type="hidden" name="next" value="{{ request.get_full_path }}">
                          <button class="btn btn-danger" type="submit" onclick="return confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ');" aria-label="Ø­Ø°Ù" title="Ø­Ø°Ù">
                            <i class="fa-solid fa-trash" aria-hidden="true"></i> Ø­Ø°Ù
                          </button>
                        </form>
                      {% endif %}
                    </div>
                  </td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="8" class="text-center muted" style="padding:18px">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚Ø§Ø±ÙŠØ± Ø¶Ù…Ù† Ù‚Ø³Ù…Ùƒ.</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Mobile Cards -->
        <div class="cards-view mobile-only">
          {% for r in reports %}
            <article class="report-card">
              <div class="report-header">
                <span>ğŸ“… {{ r.report_date|date:"Y-m-d" }} â€“ {{ r.day_name|default_if_none:"" }}</span>
                <span>
                  ğŸ‘¨â€ğŸ«
                  {% if r.teacher_name %}
                    {{ r.teacher_name }}
                  {% else %}
                    {% if r.teacher and r.teacher.name %}
                      {{ r.teacher.name }}
                    {% else %}
                      â€”
                    {% endif %}
                  {% endif %}
                </span>
              </div>

              <p class="report-program">
                ğŸ“– {{ r.title|default:"â€”" }}
                | ğŸ·ï¸ {% if r.category and r.category.name %}{{ r.category.name }}{% else %}{% if r.category %}{{ r.category }}{% else %}â€”{% endif %}{% endif %}
                | ğŸ‘¥ {{ r.beneficiaries_count|default_if_none:"â€”" }}
              </p>

              <textarea id="idea-m-{{ r.pk }}" style="display:none;">{{ r.idea|default_if_none:''|escape }}</textarea>
              <p class="report-idea">{{ r.idea|default_if_none:""|truncatewords:20 }}</p>

              <div class="report-images">
                {% if r.image1 %}<img src="{{ r.image1.url }}" alt="img" data-full="{{ r.image1.url }}">{% endif %}
                {% if r.image2 %}<img src="{{ r.image2.url }}" alt="img" data-full="{{ r.image2.url }}">{% endif %}
                {% if r.image3 %}<img src="{{ r.image3.url }}" alt="img" data-full="{{ r.image3.url }}">{% endif %}
                {% if r.image4 %}<img src="{{ r.image4.url }}" alt="img" data-full="{{ r.image4.url }}">{% endif %}
              </div>

              <div class="card-actions">
                <button
                  class="btn btn-primary js-show"
                  type="button"
                  data-idea-id="idea-m-{{ r.pk }}"
                  data-teacher="{% if r.teacher_name %}{{ r.teacher_name|escapejs }}{% else %}{% if r.teacher and r.teacher.name %}{{ r.teacher.name|escapejs }}{% endif %}{% endif %}"
                  data-title="{{ r.title|default_if_none:''|escapejs }}"
                  data-date="{{ r.report_date|date:'Y-m-d' }} - {{ r.day_name|default_if_none:''|escapejs }}"
                  data-images="{% if r.image1 %}{{ r.image1.url }}{% endif %}|{% if r.image2 %}{{ r.image2.url }}{% endif %}|{% if r.image3 %}{{ r.image3.url }}{% endif %}|{% if r.image4 %}{{ r.image4.url }}{% endif %}"
                >ğŸ‘ Ø¹Ø±Ø¶</button>

                <a href="{% url 'reports:report_print' r.pk %}?next={{ request.get_full_path|urlencode }}" target="_blank" rel="noopener" class="btn btn-print">ğŸ–¨ Ø·Ø¨Ø§Ø¹Ø©</a>

                {% if can_delete %}
                  <form method="post" action="{% url 'reports:officer_delete_report' r.pk %}">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="{{ request.get_full_path }}">
                    <button class="btn btn-danger" type="submit" onclick="return confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ');">ğŸ—‘ Ø­Ø°Ù</button>
                  </form>
                {% endif %}
              </div>
            </article>
          {% empty %}
            <div class="muted" style="text-align:center;padding:18px">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚Ø§Ø±ÙŠØ± Ø¶Ù…Ù† Ù‚Ø³Ù…Ùƒ.</div>
          {% endfor %}
        </div>

        <!-- Pagination -->
        {% if reports.paginator and reports.paginator.num_pages > 1 %}
          <nav class="pagination" aria-label="ØªØ±Ù‚ÙŠÙ… Ø§Ù„ØµÙØ­Ø§Øª">
            {% if reports.has_previous %}
              <a class="page-btn" href="?page={{ reports.previous_page_number }}{{ qsp }}">Ø§Ù„Ø³Ø§Ø¨Ù‚</a>
            {% endif %}
            <span class="page-current">ØµÙØ­Ø© {{ reports.number }} Ù…Ù† {{ reports.paginator.num_pages }}</span>
            {% if reports.has_next %}
              <a class="page-btn" href="?page={{ reports.next_page_number }}{{ qsp }}">Ø§Ù„ØªØ§Ù„ÙŠ</a>
            {% endif %}
          </nav>
        {% endif %}
      {% endwith %}

    </div>
  </div>

  <!-- Modal -->
  <div id="ideaModal" class="modal" aria-hidden="true">
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-label="ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±">
      <button class="modal-close" type="button" aria-label="Ø¥ØºÙ„Ø§Ù‚">âœ•</button>
      <h2 class="modal-title">ğŸ’¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙƒØ§Ù…Ù„</h2>

      <div id="modalIdea" class="modal-idea"></div>

      <div class="modal-meta">
        <div>ğŸ‘¨â€ğŸ« <b>Ø§Ù„Ù…Ø¹Ù„Ù…:</b> <span id="modalTeacher"></span></div>
        <div>ğŸ“– <b>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</b> <span id="modalTitle"></span></div>
        <div>ğŸ“… <b>Ø§Ù„ØªØ§Ø±ÙŠØ®:</b> <span id="modalDate"></span></div>
      </div>

      <div id="modalImages" class="modal-images"></div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script nonce="{{ CSP_NONCE }}">
  (function(){
    var modal = document.getElementById('ideaModal');
    if(!modal) return;

    var closeBtn = modal.querySelector('.modal-close');
    var modalIdea = document.getElementById('modalIdea');
    var modalTeacher = document.getElementById('modalTeacher');
    var modalTitle = document.getElementById('modalTitle');
    var modalDate = document.getElementById('modalDate');
    var modalImages = document.getElementById('modalImages');

    function lockScroll(locked){
      document.body.style.overflow = locked ? 'hidden' : 'auto';
    }

    function setOpen(open){
      if(open){
        modal.classList.add('is-open');
        modal.setAttribute('aria-hidden', 'false');
        lockScroll(true);
        if(closeBtn) closeBtn.focus();
      }else{
        modal.classList.remove('is-open');
        modal.setAttribute('aria-hidden', 'true');
        lockScroll(false);
        if(modalImages) modalImages.innerHTML = '';
      }
    }

    function buildImages(imagesStr){
      if(!modalImages) return;
      modalImages.innerHTML = '';

      var list = (imagesStr || '').split('|').map(function(s){ return (s || '').trim(); }).filter(Boolean);
      list.forEach(function(url){
        var im = document.createElement('img');
        im.src = url;
        im.alt = 'ØµÙˆØ±Ø©';
        im.loading = 'lazy';
        im.setAttribute('data-full', url);
        modalImages.appendChild(im);
      });
    }

    function openFromButton(btn){
      var ideaId = btn.getAttribute('data-idea-id');
      var ta = ideaId ? document.getElementById(ideaId) : null;
      var idea = ta ? ta.value : '';
      idea = (idea || '').replace(/\r/g, '');

      if(modalIdea) modalIdea.textContent = idea;
      if(modalTeacher) modalTeacher.textContent = btn.getAttribute('data-teacher') || '';
      if(modalTitle) modalTitle.textContent = btn.getAttribute('data-title') || '';
      if(modalDate) modalDate.textContent = btn.getAttribute('data-date') || '';

      buildImages(btn.getAttribute('data-images') || '');
      setOpen(true);
    }

    function closeModal(){
      setOpen(false);
    }

    // Event delegation: show modal
    document.addEventListener('click', function(e){
      var btn = e.target && e.target.closest ? e.target.closest('.or-scope .js-show') : null;
      if(btn){
        openFromButton(btn);
        return;
      }

      // Close on backdrop click
      if(e.target === modal){
        closeModal();
        return;
      }
    });

    if(closeBtn){
      closeBtn.addEventListener('click', closeModal);
    }

    // ESC close
    document.addEventListener('keydown', function(e){
      if(modal.classList.contains('is-open') && e.key === 'Escape'){
        closeModal();
      }
    });

    // Lightbox (single function) for thumbs + modal images
    function openLightbox(fullUrl){
      var overlay = document.createElement('div');
      overlay.style.position = 'fixed';
      overlay.style.inset = '0';
      overlay.style.background = 'rgba(0,0,0,0.88)';
      overlay.style.display = 'flex';
      overlay.style.alignItems = 'center';
      overlay.style.justifyContent = 'center';
      overlay.style.zIndex = '3000';

      var img = document.createElement('img');
      img.src = fullUrl;
      img.alt = 'preview';
      img.style.maxWidth = '92%';
      img.style.maxHeight = '92%';
      img.style.borderRadius = '14px';
      img.style.boxShadow = '0 16px 60px rgba(0,0,0,.55)';

      overlay.appendChild(img);

      function kill(){
        overlay.remove();
        document.removeEventListener('keydown', esc);
      }
      function esc(ev){
        if(ev.key === 'Escape') kill();
      }

      overlay.addEventListener('click', kill);
      document.addEventListener('keydown', esc);
      document.body.appendChild(overlay);
    }

    document.addEventListener('click', function(e){
      var img = e.target;
      if(!img) return;

      var isThumb = img.matches && (img.matches('.or-scope .table-images img') || img.matches('.or-scope .report-images img') || img.matches('#modalImages img'));
      if(!isThumb) return;

      var full = img.getAttribute('data-full') || img.src;
      if(full) openLightbox(full);
    });
  })();
</script>
{% endblock %}
