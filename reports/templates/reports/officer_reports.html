{# reports/templates/reports/officer_reports.html #}
{% extends "base.html" %}
{% load static %}

{% block title %}Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ - ØªÙ‚Ø§Ø±ÙŠØ± Ù‚Ø³Ù…ÙŠ{% endblock %}

{% block head %}
<style nonce="{{ CSP_NONCE }}">
  /* =========================================================
     Premium Officer Reports Design System - 2026
     Modern, Elegant, Fully Responsive
     ========================================================= */
  :root {
    --or-primary: #2563eb;
    --or-primary-dark: #1e40af;
    --or-gradient: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
    --or-surface: #ffffff;
    --or-background: #f8fafc;
    --or-border: #e2e8f0;
    --or-border-light: #f1f5f9;
    --or-text: #0f172a;
    --or-text-soft: #64748b;
    --or-success: #10b981;
    --or-warning: #f59e0b;
    --or-danger: #ef4444;
    --or-shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --or-shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    --or-shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    --or-shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    --or-radius-sm: 8px;
    --or-radius-md: 12px;
    --or-radius-lg: 16px;
    --or-radius-xl: 24px;
    --or-radius-full: 9999px;
  }

  html[data-theme="dark"] {
    --or-surface: rgba(15, 23, 42, 0.55);
    --or-background: rgba(15, 23, 42, 0.35);
    --or-border: #1b2744;
    --or-border-light: #1e293b;
    --or-text: #e5e7eb;
    --or-text-soft: #94a3b8;
    --or-shadow-md: 0 10px 28px rgba(0, 0, 0, 0.35);
    --or-shadow-xl: 0 25px 50px rgba(0, 0, 0, 0.5);
  }

  /* Page Layout */
  .or-scope {
    background: var(--or-background);
    min-height: calc(100vh - 120px);
    padding: 32px 20px 60px;
  }

  .or-scope .wrap {
    max-width: 1400px;
    margin: 0 auto;
  }

  /* Header Section */
  .or-scope .page-head {
    margin-bottom: 32px;
    padding: 32px 28px;
    background: var(--or-surface);
    border: 2px solid var(--or-border);
    border-radius: var(--or-radius-xl);
    box-shadow: var(--or-shadow-md);
    position: relative;
    overflow: hidden;
  }

  .or-scope .page-head::before {
    content: '';
    position: absolute;
    inset: 0;
    background: var(--or-gradient);
    opacity: 0.03;
  }

  .or-scope .title {
    margin: 0;
    font-weight: 900;
    font-size: clamp(1.5rem, 3.5vw, 2.25rem);
    background: var(--or-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    display: flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
    position: relative;
  }

  .or-scope .subtitle {
    margin: 12px 0 0;
    color: var(--or-text-soft);
    font-weight: 700;
    font-size: 1.05rem;
    line-height: 1.7;
    position: relative;
  }

  .or-scope .subtitle b {
    color: var(--or-primary);
    font-weight: 900;
  }

  /* Main Card */
  .or-scope .card {
    background: var(--or-surface);
    border: 2px solid var(--or-border);
    border-radius: var(--or-radius-xl);
    box-shadow: var(--or-shadow-md);
    padding: 36px 32px;
  }

  /* Filters Section */
  .or-scope .filters-form {
    margin-bottom: 32px;
    padding: 28px 24px;
    background: linear-gradient(135deg, var(--or-border-light) 0%, var(--or-background) 100%);
    border: 2px solid var(--or-border);
    border-radius: var(--or-radius-lg);
  }

  .or-scope .filters-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 16px;
  }

  .or-scope .filter-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .or-scope .filter-group label {
    font-weight: 700;
    font-size: 0.875rem;
    color: var(--or-text);
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .or-scope .filter-input {
    padding: 12px 16px;
    border: 2px solid var(--or-border);
    border-radius: var(--or-radius-md);
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--or-text);
    background: var(--or-surface);
    min-height: 44px;
    outline: none;
    transition: all 0.2s ease;
  }

  .or-scope .filter-input:focus {
    border-color: var(--or-primary);
    box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
    transform: translateY(-1px);
  }

  .or-scope .filter-actions {
    margin-top: 20px;
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    justify-content: flex-start;
  }

  /* Buttons */
  .or-scope .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 12px 24px;
    border-radius: var(--or-radius-md);
    font-weight: 800;
    font-size: 0.95rem;
    text-decoration: none;
    border: none;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    min-height: 44px;
    user-select: none;
    position: relative;
    overflow: hidden;
  }

  .or-scope .btn::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.3), transparent);
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .or-scope .btn:hover::before {
    opacity: 1;
  }

  .or-scope .btn:hover {
    transform: translateY(-2px);
  }

  .or-scope .btn:active {
    transform: translateY(0);
  }

  .or-scope .btn-primary {
    background: var(--or-gradient);
    color: white;
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
  }

  .or-scope .btn-primary:hover {
    box-shadow: 0 8px 20px rgba(37, 99, 235, 0.4);
  }

  .or-scope .btn-outline {
    background: transparent;
    color: var(--or-text-soft);
    border: 2px solid var(--or-border);
  }

  .or-scope .btn-outline:hover {
    background: var(--or-border-light);
    border-color: var(--or-primary);
    color: var(--or-primary);
  }

  .or-scope .btn-print {
    background: linear-gradient(135deg, var(--or-success), #059669);
    color: white;
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
  }

  .or-scope .btn-print:hover {
    box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
  }

  .or-scope .btn-danger {
    background: linear-gradient(135deg, var(--or-danger), #dc2626);
    color: white;
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
  }

  .or-scope .btn-danger:hover {
    box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4);
  }

  .or-scope .btn-ghost {
    background: var(--or-border-light);
    color: var(--or-text-soft);
    border: 2px solid var(--or-border);
  }

  .or-scope .btn-ghost:hover {
    background: var(--or-primary);
    color: white;
    border-color: var(--or-primary);
  }

  /* Table Section */
  .or-scope .table-responsive {
    overflow: auto;
    border: 2px solid var(--or-border);
    border-radius: var(--or-radius-lg);
    margin-top: 24px;
    box-shadow: var(--or-shadow-sm);
  }

  .or-scope table {
    width: 100%;
    border-collapse: collapse;
    min-width: 1100px;
    background: var(--or-surface);
    font-size: 0.9rem;
  }

  .or-scope thead th {
    background: linear-gradient(135deg, var(--or-border-light) 0%, var(--or-background) 100%);
    border-bottom: 2px solid var(--or-border);
    padding: 18px 14px;
    text-align: right;
    color: var(--or-text);
    font-weight: 900;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    white-space: nowrap;
  }

  .or-scope tbody td {
    border-bottom: 1px solid var(--or-border-light);
    padding: 18px 14px;
    vertical-align: middle;
    color: var(--or-text);
    font-weight: 600;
  }

  .or-scope tbody tr {
    transition: all 0.2s ease;
  }

  .or-scope tbody tr:hover {
    background: linear-gradient(90deg, rgba(37, 99, 235, 0.03), transparent);
  }

  .or-scope tbody tr:last-child td {
    border-bottom: none;
  }

  .or-scope .muted {
    color: var(--or-text-soft);
    font-weight: 600;
    font-size: 0.875rem;
  }

  .or-scope .text-center {
    text-align: center;
    font-weight: 800;
  }

  /* Table Images */
  .or-scope .table-images {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  .or-scope .table-images img {
    width: 56px;
    height: 56px;
    object-fit: cover;
    border-radius: var(--or-radius-md);
    border: 2px solid var(--or-border);
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    background: var(--or-border-light);
    box-shadow: var(--or-shadow-sm);
  }

  .or-scope .table-images img:hover {
    transform: scale(1.15);
    box-shadow: var(--or-shadow-lg);
    border-color: var(--or-primary);
    z-index: 10;
  }

  /* Mobile Cards */
  .or-scope .cards-view {
    display: grid;
    gap: 16px;
    margin-top: 24px;
  }

  .or-scope .report-card {
    background: linear-gradient(135deg, var(--or-surface) 0%, var(--or-background) 100%);
    border: 2px solid var(--or-border);
    border-radius: var(--or-radius-lg);
    box-shadow: var(--or-shadow-md);
    padding: 20px;
    display: grid;
    gap: 14px;
    transition: all 0.3s ease;
  }

  .or-scope .report-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--or-shadow-xl);
    border-color: var(--or-primary);
  }

  .or-scope .report-header {
    display: flex;
    justify-content: space-between;
    gap: 12px;
    flex-wrap: wrap;
    font-weight: 800;
    font-size: 0.9rem;
    color: var(--or-text);
    padding-bottom: 12px;
    border-bottom: 2px solid var(--or-border-light);
  }

  .or-scope .report-program {
    margin: 0;
    color: var(--or-text-soft);
    font-weight: 700;
    font-size: 0.95rem;
    line-height: 1.7;
  }

  .or-scope .report-idea {
    margin: 0;
    color: var(--or-text);
    font-weight: 600;
    line-height: 1.8;
    font-size: 0.95rem;
  }

  .or-scope .report-images {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }

  .or-scope .report-images img {
    width: 72px;
    height: 72px;
    object-fit: cover;
    border-radius: var(--or-radius-md);
    border: 2px solid var(--or-border);
    cursor: pointer;
    background: var(--or-border-light);
    transition: all 0.3s ease;
    box-shadow: var(--or-shadow-sm);
  }

  .or-scope .report-images img:hover {
    transform: scale(1.1);
    box-shadow: var(--or-shadow-md);
    border-color: var(--or-primary);
  }

  .or-scope .card-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    align-items: center;
    padding-top: 12px;
    border-top: 2px solid var(--or-border-light);
  }

  /* Pagination */
  .or-scope .pagination {
    display: flex;
    gap: 12px;
    align-items: center;
    justify-content: center;
    margin-top: 32px;
    padding-top: 24px;
    border-top: 2px solid var(--or-border-light);
    flex-wrap: wrap;
  }

  .or-scope .page-btn {
    padding: 10px 20px;
    border: 2px solid var(--or-border);
    border-radius: var(--or-radius-md);
    background: var(--or-surface);
    color: var(--or-text);
    text-decoration: none;
    font-weight: 800;
    font-size: 0.9rem;
    transition: all 0.2s ease;
  }

  .or-scope .page-btn:hover {
    background: var(--or-primary);
    color: white;
    border-color: var(--or-primary);
    transform: translateY(-2px);
  }

  .or-scope .page-current {
    color: var(--or-text-soft);
    font-weight: 700;
    font-size: 0.95rem;
  }

  /* Modal */
  .or-scope .modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(15, 23, 42, 0.92);
    backdrop-filter: blur(12px);
    z-index: 2000;
    justify-content: center;
    align-items: center;
    padding: 20px;
    overflow: auto;
  }

  .or-scope .modal.is-open {
    display: flex;
    animation: fadeIn 0.3s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  .or-scope .modal-dialog {
    width: min(820px, 100%);
    background: var(--or-surface);
    border-radius: var(--or-radius-xl);
    border: 2px solid var(--or-border);
    box-shadow: 0 25px 60px rgba(0, 0, 0, 0.5);
    position: relative;
    padding: 32px 28px;
    animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
  }

  @keyframes slideUp {
    from {
      opacity: 0;
      transform: translateY(30px) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  .or-scope .modal-close {
    position: absolute;
    top: 16px;
    left: 16px;
    width: 44px;
    height: 44px;
    border-radius: var(--or-radius-full);
    border: 2px solid #fecaca;
    background: linear-gradient(135deg, #fee2e2, #fecaca);
    color: #991b1b;
    cursor: pointer;
    font-weight: 900;
    font-size: 1.25rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
  }

  .or-scope .modal-close:hover {
    background: linear-gradient(135deg, #fecaca, #fca5a5);
    transform: rotate(90deg) scale(1.1);
  }

  .or-scope .modal-title {
    margin: 0 0 16px 0;
    font-weight: 900;
    font-size: 1.5rem;
    color: var(--or-text);
    padding-right: 48px;
  }

  .or-scope .modal-idea {
    white-space: pre-line;
    margin: 16px 0;
    font-size: 0.95rem;
    line-height: 1.8;
    color: var(--or-text);
    font-weight: 600;
    padding: 20px;
    background: linear-gradient(135deg, var(--or-border-light), var(--or-background));
    border: 2px solid var(--or-border);
    border-radius: var(--or-radius-lg);
    overflow-wrap: anywhere;
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
  }

  .or-scope .modal-meta {
    display: grid;
    grid-template-columns: 1fr;
    gap: 12px;
    margin-top: 20px;
    color: var(--or-text-soft);
    font-weight: 700;
    font-size: 0.95rem;
    padding: 16px;
    background: var(--or-background);
    border-radius: var(--or-radius-md);
  }

  @media(min-width:720px) {
    .or-scope .modal-meta {
      grid-template-columns: 1fr 1fr;
    }
  }

  .or-scope .modal-meta b {
    color: var(--or-text);
    font-weight: 900;
  }

  .or-scope .modal-images {
    margin-top: 20px;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 14px;
  }

  .or-scope .modal-images img {
    width: 100%;
    height: 140px;
    object-fit: cover;
    border-radius: var(--or-radius-lg);
    border: 2px solid var(--or-border);
    box-shadow: var(--or-shadow-md);
    cursor: pointer;
    transition: all 0.3s ease;
    background: var(--or-border-light);
  }

  .or-scope .modal-images img:hover {
    transform: scale(1.05);
    box-shadow: var(--or-shadow-xl);
    border-color: var(--or-primary);
  }

  /* Responsive Design */
  .or-scope .desktop-only {
    display: block;
  }

  .or-scope .mobile-only {
    display: none;
  }

  @media(max-width: 860px) {
    .or-scope .desktop-only {
      display: none;
    }

    .or-scope .mobile-only {
      display: block;
    }
  }

  @media(max-width: 768px) {
    .or-scope {
      padding: 20px 12px 50px;
    }

    .or-scope .page-head {
      padding: 24px 20px;
    }

    .or-scope .card {
      padding: 24px 20px;
    }

    .or-scope .filters-form {
      padding: 20px 16px;
    }

    .or-scope .filters-grid {
      grid-template-columns: 1fr;
    }

    .or-scope .modal-dialog {
      padding: 28px 24px;
    }

    .or-scope .modal-images {
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    }
  }

  @media (prefers-reduced-motion: reduce) {
    .or-scope .btn,
    .or-scope .modal-images img,
    .or-scope .report-card,
    .or-scope .table-images img {
      transition: none !important;
    }

    .or-scope .btn:hover,
    .or-scope .modal-images img:hover,
    .or-scope .report-card:hover,
    .or-scope .table-images img:hover {
      transform: none !important;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="or-scope" dir="rtl">
  <div class="wrap">

    <!-- Header -->
    <header class="page-head">
      <h1 class="title">ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ â€“ ØªÙ‚Ø§Ø±ÙŠØ± Ù‚Ø³Ù…ÙŠ</h1>
      <p class="subtitle">
        Ø¹Ø±Ø¶ ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù‚Ø³Ù…:
        <b>{% if department %}{{ department.name }}{% else %}â€”{% endif %}</b>
      </p>
    </header>

    <div class="card">

      <!-- Filters -->
      <form method="get" class="filters-form" novalidate>
        <div class="filters-grid">

          <div class="filter-group">
            <label for="orStartDate">ğŸ“… Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
            <input id="orStartDate" type="date" name="start_date" value="{{ start_date }}" class="filter-input">
          </div>

          <div class="filter-group">
            <label for="orEndDate">ğŸ“… Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
            <input id="orEndDate" type="date" name="end_date" value="{{ end_date }}" class="filter-input">
          </div>

          <div class="filter-group">
            <label for="orTeacherName">ğŸ‘¨â€ğŸ« Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…</label>
            <input
              id="orTeacherName"
              type="text"
              name="teacher_name"
              value="{{ teacher_name }}"
              placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù… Ø£Ùˆ Ø¬Ø²Ø¡ Ù…Ù†Ù‡"
              class="filter-input"
              autocomplete="off"
            >
          </div>

          {% if categories %}
            <div class="filter-group">
              <label for="orCategory">ğŸ·ï¸ Ø§Ù„ØªØµÙ†ÙŠÙ (Ø®Ø§Øµ Ø¨Ù‚Ø³Ù…ÙŠ)</label>
              <select id="orCategory" name="category" class="filter-input">
                <option value="">ÙƒÙ„ ØªØµÙ†ÙŠÙØ§Øª Ù‚Ø³Ù…ÙŠ</option>
                {% for c_val, c_label in categories %}
                  <option value="{{ c_val }}" {% if category == c_val %}selected{% endif %}>{{ c_label }}</option>
                {% endfor %}
              </select>
            </div>
          {% endif %}
        </div>

        <div class="filter-actions">
          <button class="btn btn-primary" type="submit">âœ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±</button>
          {% if start_date or end_date or teacher_name or category %}
            <a href="{{ request.path }}" class="btn btn-outline">ğŸ§¹ Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±</a>
          {% endif %}
        </div>
      </form>

      {# Ù†Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ querystring Ù„Ù„ØªØ±Ù‚ÙŠÙ… (Ø¨Ø¯ÙˆÙ† Ø§Ø³ØªØ¯Ø¹Ø§Ø¡Ø§Øª Ø¯ÙˆØ§Ù„ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù‚Ø§Ù„Ø¨) #}
      {% with qsp="" %}
        {% if start_date %}{% with qsp=qsp|add:"&start_date="|add:start_date %}{% endwith %}{% endif %}
        {% if end_date %}{% with qsp=qsp|add:"&end_date="|add:end_date %}{% endwith %}{% endif %}
        {% if teacher_name %}{% with qsp=qsp|add:"&teacher_name="|add:teacher_name|urlencode %}{% endwith %}{% endif %}
        {% if category %}{% with qsp=qsp|add:"&category="|add:category %}{% endwith %}{% endif %}

        <!-- Desktop Table -->
        <div class="table-responsive desktop-only">
          <table class="reports-table">
            <thead>
              <tr>
                <th>ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                <th>ğŸ‘¨â€ğŸ« Ø§Ù„Ù…Ø¹Ù„Ù…</th>
                <th>ğŸ“– Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
                <th>ğŸ·ï¸ Ø§Ù„ØªØµÙ†ÙŠÙ</th>
                <th class="text-center">ğŸ‘¥ Ø§Ù„Ù…Ø³ØªÙÙŠØ¯ÙˆÙ†</th>
                <th>ğŸ’¡ Ø§Ù„ÙÙƒØ±Ø©</th>
                <th>ğŸ–¼ Ø§Ù„ØµÙˆØ±</th>
                <th>âš™ï¸ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
              </tr>
            </thead>
            <tbody>
              {% for r in reports %}
                <tr>
                  <td>
                    {{ r.report_date|date:"Y-m-d" }}<br>
                    <small class="muted">{{ r.day_name|default_if_none:"" }}</small>
                  </td>

                  <td>
                    {% if r.teacher_name %}
                      {{ r.teacher_name }}
                    {% else %}
                      {% if r.teacher and r.teacher.name %}
                        {{ r.teacher.name }}
                      {% else %}
                        â€”
                      {% endif %}
                    {% endif %}
                  </td>

                  <td>{{ r.title|default:"â€”" }}</td>

                  <td>
                    {% if r.category and r.category.name %}
                      {{ r.category.name }}
                    {% else %}
                      {% if r.category %}{{ r.category }}{% else %}â€”{% endif %}
                    {% endif %}
                  </td>

                  <td class="text-center">{{ r.beneficiaries_count|default_if_none:"â€”" }}</td>

                  <td>
                    <textarea id="idea-{{ r.pk }}" style="display:none;">{{ r.idea|default_if_none:''|escape }}</textarea>
                    {{ r.idea|default_if_none:""|truncatewords:12 }}
                  </td>

                  <td>
                    <div class="table-images">
                      {% if r.image1 %}<img src="{{ r.image1.url }}" alt="ØµÙˆØ±Ø©" data-full="{{ r.image1.url }}">{% endif %}
                      {% if r.image2 %}<img src="{{ r.image2.url }}" alt="ØµÙˆØ±Ø©" data-full="{{ r.image2.url }}">{% endif %}
                      {% if r.image3 %}<img src="{{ r.image3.url }}" alt="ØµÙˆØ±Ø©" data-full="{{ r.image3.url }}">{% endif %}
                      {% if r.image4 %}<img src="{{ r.image4.url }}" alt="ØµÙˆØ±Ø©" data-full="{{ r.image4.url }}">{% endif %}
                    </div>
                  </td>

                  <td>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
                      <button
                        class="btn btn-primary js-show"
                        type="button"
                        data-idea-id="idea-{{ r.pk }}"
                        data-teacher="{% if r.teacher_name %}{{ r.teacher_name|escapejs }}{% else %}{% if r.teacher and r.teacher.name %}{{ r.teacher.name|escapejs }}{% endif %}{% endif %}"
                        data-title="{{ r.title|default_if_none:''|escapejs }}"
                        data-date="{{ r.report_date|date:'Y-m-d' }} - {{ r.day_name|default_if_none:''|escapejs }}"
                        data-images="{% if r.image1 %}{{ r.image1.url }}{% endif %}|{% if r.image2 %}{{ r.image2.url }}{% endif %}|{% if r.image3 %}{{ r.image3.url }}{% endif %}|{% if r.image4 %}{{ r.image4.url }}{% endif %}"
                        aria-label="Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„"
                        title="Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„"
                      ><i class="fa-solid fa-eye" aria-hidden="true"></i> Ø¹Ø±Ø¶</button>

                      <a
                        href="{% url 'reports:report_print' r.pk %}?next={{ request.get_full_path|urlencode }}"
                        target="_blank"
                        rel="noopener"
                        class="btn btn-print"
                        aria-label="Ø·Ø¨Ø§Ø¹Ø©"
                        title="Ø·Ø¨Ø§Ø¹Ø©"
                      ><i class="fa-solid fa-print" aria-hidden="true"></i> Ø·Ø¨Ø§Ø¹Ø©</a>

                      {% if r.user_can_share|default:can_delete %}
                        <a
                          href="{% url 'reports:report_share_manage' r.pk %}"
                          class="btn btn-ghost"
                          aria-label="Ù…Ø´Ø§Ø±ÙƒØ©"
                          title="Ù…Ø´Ø§Ø±ÙƒØ©"
                        ><i class="fa-solid fa-share-nodes" aria-hidden="true"></i> Ù…Ø´Ø§Ø±ÙƒØ©</a>
                      {% endif %}

                      {% if r.user_can_delete|default:can_delete %}
                        <form method="post" action="{% url 'reports:officer_delete_report' r.pk %}">
                          {% csrf_token %}
                          <input type="hidden" name="next" value="{{ request.get_full_path }}">
                          <button class="btn btn-danger" type="submit" onclick="return confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ');" aria-label="Ø­Ø°Ù" title="Ø­Ø°Ù">
                            <i class="fa-solid fa-trash" aria-hidden="true"></i> Ø­Ø°Ù
                          </button>
                        </form>
                      {% endif %}
                    </div>
                  </td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="8" class="text-center muted" style="padding:18px">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚Ø§Ø±ÙŠØ± Ø¶Ù…Ù† Ù‚Ø³Ù…Ùƒ.</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Mobile Cards -->
        <div class="cards-view mobile-only">
          {% for r in reports %}
            <article class="report-card">
              <div class="report-header">
                <span>ğŸ“… {{ r.report_date|date:"Y-m-d" }} â€“ {{ r.day_name|default_if_none:"" }}</span>
                <span>
                  ğŸ‘¨â€ğŸ«
                  {% if r.teacher_name %}
                    {{ r.teacher_name }}
                  {% else %}
                    {% if r.teacher and r.teacher.name %}
                      {{ r.teacher.name }}
                    {% else %}
                      â€”
                    {% endif %}
                  {% endif %}
                </span>
              </div>

              <p class="report-program">
                ğŸ“– {{ r.title|default:"â€”" }}
                | ğŸ·ï¸ {% if r.category and r.category.name %}{{ r.category.name }}{% else %}{% if r.category %}{{ r.category }}{% else %}â€”{% endif %}{% endif %}
                | ğŸ‘¥ {{ r.beneficiaries_count|default_if_none:"â€”" }}
              </p>

              <textarea id="idea-m-{{ r.pk }}" style="display:none;">{{ r.idea|default_if_none:''|escape }}</textarea>
              <p class="report-idea">{{ r.idea|default_if_none:""|truncatewords:20 }}</p>

              <div class="report-images">
                {% if r.image1 %}<img src="{{ r.image1.url }}" alt="img" data-full="{{ r.image1.url }}">{% endif %}
                {% if r.image2 %}<img src="{{ r.image2.url }}" alt="img" data-full="{{ r.image2.url }}">{% endif %}
                {% if r.image3 %}<img src="{{ r.image3.url }}" alt="img" data-full="{{ r.image3.url }}">{% endif %}
                {% if r.image4 %}<img src="{{ r.image4.url }}" alt="img" data-full="{{ r.image4.url }}">{% endif %}
              </div>

              <div class="card-actions">
                <button
                  class="btn btn-primary js-show"
                  type="button"
                  data-idea-id="idea-m-{{ r.pk }}"
                  data-teacher="{% if r.teacher_name %}{{ r.teacher_name|escapejs }}{% else %}{% if r.teacher and r.teacher.name %}{{ r.teacher.name|escapejs }}{% endif %}{% endif %}"
                  data-title="{{ r.title|default_if_none:''|escapejs }}"
                  data-date="{{ r.report_date|date:'Y-m-d' }} - {{ r.day_name|default_if_none:''|escapejs }}"
                  data-images="{% if r.image1 %}{{ r.image1.url }}{% endif %}|{% if r.image2 %}{{ r.image2.url }}{% endif %}|{% if r.image3 %}{{ r.image3.url }}{% endif %}|{% if r.image4 %}{{ r.image4.url }}{% endif %}"
                >ğŸ‘ Ø¹Ø±Ø¶</button>

                <a href="{% url 'reports:report_print' r.pk %}?next={{ request.get_full_path|urlencode }}" target="_blank" rel="noopener" class="btn btn-print">ğŸ–¨ Ø·Ø¨Ø§Ø¹Ø©</a>

                {% if r.user_can_share|default:can_delete %}
                  <a href="{% url 'reports:report_share_manage' r.pk %}" class="btn btn-ghost">ğŸ”— Ù…Ø´Ø§Ø±ÙƒØ©</a>
                {% endif %}

                {% if r.user_can_delete|default:can_delete %}
                  <form method="post" action="{% url 'reports:officer_delete_report' r.pk %}">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="{{ request.get_full_path }}">
                    <button class="btn btn-danger" type="submit" onclick="return confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ');">ğŸ—‘ Ø­Ø°Ù</button>
                  </form>
                {% endif %}
              </div>
            </article>
          {% empty %}
            <div class="muted" style="text-align:center;padding:18px">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚Ø§Ø±ÙŠØ± Ø¶Ù…Ù† Ù‚Ø³Ù…Ùƒ.</div>
          {% endfor %}
        </div>

        <!-- Pagination -->
        {% if reports.paginator and reports.paginator.num_pages > 1 %}
          <nav class="pagination" aria-label="ØªØ±Ù‚ÙŠÙ… Ø§Ù„ØµÙØ­Ø§Øª">
            {% if reports.has_previous %}
              <a class="page-btn" href="?page={{ reports.previous_page_number }}{{ qsp }}">Ø§Ù„Ø³Ø§Ø¨Ù‚</a>
            {% endif %}
            <span class="page-current">ØµÙØ­Ø© {{ reports.number }} Ù…Ù† {{ reports.paginator.num_pages }}</span>
            {% if reports.has_next %}
              <a class="page-btn" href="?page={{ reports.next_page_number }}{{ qsp }}">Ø§Ù„ØªØ§Ù„ÙŠ</a>
            {% endif %}
          </nav>
        {% endif %}
      {% endwith %}

    </div>
  </div>

  <!-- Modal -->
  <div id="ideaModal" class="modal" aria-hidden="true">
    <div class="modal-dialog" role="dialog" aria-modal="true" aria-label="ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±">
      <button class="modal-close" type="button" aria-label="Ø¥ØºÙ„Ø§Ù‚">âœ•</button>
      <h2 class="modal-title">ğŸ’¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙƒØ§Ù…Ù„</h2>

      <div id="modalIdea" class="modal-idea"></div>

      <div class="modal-meta">
        <div>ğŸ‘¨â€ğŸ« <b>Ø§Ù„Ù…Ø¹Ù„Ù…:</b> <span id="modalTeacher"></span></div>
        <div>ğŸ“– <b>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</b> <span id="modalTitle"></span></div>
        <div>ğŸ“… <b>Ø§Ù„ØªØ§Ø±ÙŠØ®:</b> <span id="modalDate"></span></div>
      </div>

      <div id="modalImages" class="modal-images"></div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script nonce="{{ CSP_NONCE }}">
  (function(){
    var modal = document.getElementById('ideaModal');
    if(!modal) return;

    var closeBtn = modal.querySelector('.modal-close');
    var modalIdea = document.getElementById('modalIdea');
    var modalTeacher = document.getElementById('modalTeacher');
    var modalTitle = document.getElementById('modalTitle');
    var modalDate = document.getElementById('modalDate');
    var modalImages = document.getElementById('modalImages');

    function lockScroll(locked){
      document.body.style.overflow = locked ? 'hidden' : 'auto';
    }

    function setOpen(open){
      if(open){
        modal.classList.add('is-open');
        modal.setAttribute('aria-hidden', 'false');
        lockScroll(true);
        if(closeBtn) closeBtn.focus();
      }else{
        modal.classList.remove('is-open');
        modal.setAttribute('aria-hidden', 'true');
        lockScroll(false);
        if(modalImages) modalImages.innerHTML = '';
      }
    }

    function buildImages(imagesStr){
      if(!modalImages) return;
      modalImages.innerHTML = '';

      var list = (imagesStr || '').split('|').map(function(s){ return (s || '').trim(); }).filter(Boolean);
      list.forEach(function(url){
        var im = document.createElement('img');
        im.src = url;
        im.alt = 'ØµÙˆØ±Ø©';
        im.loading = 'lazy';
        im.setAttribute('data-full', url);
        modalImages.appendChild(im);
      });
    }

    function openFromButton(btn){
      var ideaId = btn.getAttribute('data-idea-id');
      var ta = ideaId ? document.getElementById(ideaId) : null;
      var idea = ta ? ta.value : '';
      idea = (idea || '').replace(/\r/g, '');

      if(modalIdea) modalIdea.textContent = idea;
      if(modalTeacher) modalTeacher.textContent = btn.getAttribute('data-teacher') || '';
      if(modalTitle) modalTitle.textContent = btn.getAttribute('data-title') || '';
      if(modalDate) modalDate.textContent = btn.getAttribute('data-date') || '';

      buildImages(btn.getAttribute('data-images') || '');
      setOpen(true);
    }

    function closeModal(){
      setOpen(false);
    }

    // Event delegation: show modal
    document.addEventListener('click', function(e){
      var btn = e.target && e.target.closest ? e.target.closest('.or-scope .js-show') : null;
      if(btn){
        openFromButton(btn);
        return;
      }

      // Close on backdrop click
      if(e.target === modal){
        closeModal();
        return;
      }
    });

    if(closeBtn){
      closeBtn.addEventListener('click', closeModal);
    }

    // ESC close
    document.addEventListener('keydown', function(e){
      if(modal.classList.contains('is-open') && e.key === 'Escape'){
        closeModal();
      }
    });

    // Lightbox (single function) for thumbs + modal images
    function openLightbox(fullUrl){
      var overlay = document.createElement('div');
      overlay.style.position = 'fixed';
      overlay.style.inset = '0';
      overlay.style.background = 'rgba(0,0,0,0.88)';
      overlay.style.display = 'flex';
      overlay.style.alignItems = 'center';
      overlay.style.justifyContent = 'center';
      overlay.style.zIndex = '3000';

      var img = document.createElement('img');
      img.src = fullUrl;
      img.alt = 'preview';
      img.style.maxWidth = '92%';
      img.style.maxHeight = '92%';
      img.style.borderRadius = '14px';
      img.style.boxShadow = '0 16px 60px rgba(0,0,0,.55)';

      overlay.appendChild(img);

      function kill(){
        overlay.remove();
        document.removeEventListener('keydown', esc);
      }
      function esc(ev){
        if(ev.key === 'Escape') kill();
      }

      overlay.addEventListener('click', kill);
      document.addEventListener('keydown', esc);
      document.body.appendChild(overlay);
    }

    document.addEventListener('click', function(e){
      var img = e.target;
      if(!img) return;

      var isThumb = img.matches && (img.matches('.or-scope .table-images img') || img.matches('.or-scope .report-images img') || img.matches('#modalImages img'));
      if(!isThumb) return;

      var full = img.getAttribute('data-full') || img.src;
      if(full) openLightbox(full);
    });
  })();
</script>
{% endblock %}
