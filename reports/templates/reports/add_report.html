{% extends "base.html" %}
{% load static %}
{% block title %}إضافة تقرير{% endblock %}

{% block head %}
<style>
  /* ===== Scoped فقط داخل صفحة إضافة تقرير ===== */
  .add-report{
    --ar-primary: var(--brand, #2563eb);
    --ar-accent: var(--accent, #059669);
    --ar-ink: var(--ink, #0f172a);
    --ar-muted: var(--muted, #64748b);
    --ar-line: var(--line, #e2e8f0);
    --ar-bg: var(--bg, #f5f7fb);
    --ar-card: #fff;
    --ar-shadow: 0 10px 40px rgba(2, 6, 23, 0.08);
    --ar-grad: linear-gradient(135deg, var(--ar-primary) 0%, #4f46e5 60%, var(--ar-accent) 100%);
    min-height: 100dvh;
    background: var(--ar-bg);
    padding: 20px 0;
  }

  .add-report .ar-wrap{max-width:900px;margin:0 auto;padding:0 16px}
  .add-report .ar-card{
    background: var(--ar-card);
    border: 1px solid var(--ar-line);
    border-radius: 20px;
    padding: 26px;
    box-shadow: var(--ar-shadow);
    position: relative;
    overflow: hidden;
  }
  .add-report .ar-card::before{
    content:"";
    position:absolute; inset:0 0 auto 0;
    height:5px;
    background: var(--ar-grad);
    opacity:.95;
  }

  .add-report .ar-title{
    margin: 0 0 18px;
    padding-bottom: 14px;
    border-bottom: 1px solid var(--ar-line);
    display:flex; align-items:center; gap:10px;
    font-weight: 900;
    font-size: 1.55rem;
    background: var(--ar-grad);
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
  }

  .add-report .ar-grid{display:grid;gap:18px}
  .add-report .ar-group{display:flex;flex-direction:column;gap:8px}

  .add-report label{
    font-weight: 900;
    color: var(--ar-ink);
    display:flex; align-items:center; gap:8px;
  }

  .add-report input,
  .add-report textarea,
  .add-report select{
    width:100%;
    padding: 12px 14px;
    border: 1.5px solid var(--ar-line);
    border-radius: 14px;
    background: rgba(248,250,252,.85);
    color: var(--ar-ink);
    font-family: inherit;
    transition: border-color .15s ease, box-shadow .15s ease, background .15s ease;
  }
  .add-report textarea{min-height:140px;resize:vertical;line-height:1.7}
  .add-report input:focus,
  .add-report textarea:focus,
  .add-report select:focus{
    outline:none;
    border-color: var(--ar-primary);
    box-shadow: 0 0 0 3px rgba(37,99,235,.18);
    background:#fff;
  }

  .add-report .ar-help{
    margin-top: 10px;
    padding: 12px 14px;
    border-radius: 14px;
    border: 1px solid var(--ar-line);
    background: rgba(37,99,235,.05);
    color: var(--ar-muted);
    font-weight: 800;
  }

  /* رسائل */
  .add-report .ar-alert{
    border-radius: 14px;
    padding: 12px 14px;
    font-weight: 800;
    border: 1px solid rgba(254,202,202,.95);
    background: rgba(254,242,242,.95);
    color: #b91c1c;
    margin-bottom: 10px;
  }
  .add-report .ar-invalid{
    border-color: rgba(239,68,68,.45) !important;
    box-shadow: 0 0 0 3px rgba(239,68,68,.12) !important;
  }

  /* صور */
  .add-report .ar-img-grid{
    display:grid;
    grid-template-columns: repeat(4, minmax(0,1fr));
    gap: 14px;
    margin-top: 8px;
  }
  .add-report .ar-drop{
    position:relative;
    border: 2px dashed var(--ar-line);
    border-radius: 16px;
    padding: 18px 10px;
    background: rgba(248,250,252,.75);
    text-align:center;
    cursor:pointer;
    transition: transform .12s ease, border-color .12s ease, background .12s ease;
    display:flex; flex-direction:column; align-items:center; justify-content:center; gap:8px;
    min-height: 110px;
  }
  .add-report .ar-drop:hover{
    border-color: rgba(37,99,235,.45);
    background: rgba(37,99,235,.06);
    transform: translateY(-2px);
  }
  .add-report .ar-drop input[type="file"]{
    position:absolute; inset:0;
    width:100%; height:100%;
    opacity:0; cursor:pointer;
  }
  .add-report .ar-drop .ico{font-size:1.9rem;color: var(--ar-muted)}
  .add-report .ar-drop .txt{font-size:.9rem;color: var(--ar-muted);font-weight:800}

  .add-report .ar-previews{
    margin-top: 14px;
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 12px;
  }
  .add-report .ar-prev{
    position:relative;
    height: 120px;
    border-radius: 16px;
    border: 1px solid var(--ar-line);
    background: rgba(248,250,252,.75);
    overflow:hidden;
    display:flex; align-items:center; justify-content:center;
  }
  .add-report .ar-prev img{width:100%;height:100%;object-fit:cover}
  .add-report .ar-x{
    position:absolute; top:8px; right:8px;
    width:28px; height:28px;
    border-radius:999px;
    border:0;
    cursor:pointer;
    background: rgba(239,68,68,.92);
    color:#fff;
    font-weight:900;
    display:grid; place-items:center;
  }
  .add-report .ar-x:hover{background:#ef4444}

  /* أزرار */
  .add-report .ar-actions{display:grid;gap:12px;margin-top: 18px}
  .add-report .ar-btn{
    display:inline-flex; align-items:center; justify-content:center; gap:10px;
    padding: 14px 18px;
    border-radius: 16px;
    font-weight: 900;
    text-decoration:none;
    cursor:pointer;
    border: 1px solid transparent;
    transition: transform .12s ease, box-shadow .12s ease, background .12s ease, border-color .12s ease;
  }
  .add-report .ar-btn-primary{
    background: var(--ar-grad);
    color:#fff;
    box-shadow: 0 12px 26px rgba(37,99,235,.25);
  }
  .add-report .ar-btn-primary:hover{transform: translateY(-2px); box-shadow: 0 16px 32px rgba(37,99,235,.32);}
  .add-report .ar-btn-outline{
    background: transparent;
    border-color: var(--ar-line);
    color: var(--ar-ink);
  }
  .add-report .ar-btn-outline:hover{border-color: rgba(37,99,235,.35); background: rgba(37,99,235,.05);}

  /* Overlay رفع */
  .add-report .ar-overlay{
    position:fixed; inset:0;
    background: rgba(15,23,42,.85);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:9999;
    backdrop-filter: blur(4px);
  }
  .add-report .ar-up{
    width: min(520px, 92vw);
    background: #fff;
    border-radius: 20px;
    padding: 22px;
    border: 1px solid rgba(226,232,240,.9);
    box-shadow: 0 25px 60px rgba(0,0,0,.3);
    text-align:center;
  }
  .add-report .ar-up h3{margin:0 0 8px;font-weight:900}
  .add-report .ar-up p{margin:0 0 14px;color:#475569;font-weight:800}
  .add-report .ar-bar{height:12px;border-radius:999px;background:#eef2ff;overflow:hidden;border:1px solid #e2e8f0}
  .add-report .ar-fill{height:100%;width:0;background: var(--ar-grad);transition: width .25s ease}
  .add-report .ar-mini{display:flex;justify-content:space-between;margin-top:10px;color:#64748b;font-weight:900}

  /* Responsive */
  @media (max-width: 900px){
    .add-report .ar-img-grid{grid-template-columns: repeat(2, minmax(0,1fr));}
  }
  @media (max-width: 520px){
    .add-report .ar-card{padding:18px}
    .add-report .ar-title{font-size:1.25rem}
    .add-report .ar-img-grid{grid-template-columns: 1fr;}
  }
</style>
{% endblock %}

{% block content %}
{{ block.super }}

<div class="add-report">
  <div class="ar-wrap">
    <div class="ar-card">
      <h2 class="ar-title"><i class="fa-solid fa-plus"></i> إضافة تقرير جديد</h2>

      {% if messages %}
        {% for message in messages %}
          <div class="ar-alert">{{ message }}</div>
        {% endfor %}
      {% endif %}

      {% if form.non_field_errors %}
        <div class="ar-alert">
          {% for e in form.non_field_errors %}• {{ e }}<br>{% endfor %}
        </div>
      {% endif %}

      <form id="report-form" method="POST" enctype="multipart/form-data" class="ar-grid" autocomplete="off" novalidate>
        {% csrf_token %}

        <!-- نوع التقرير -->
        <div class="ar-group" data-group="category">
          <label for="{{ form.category.id_for_label }}"><i class="fa-solid fa-tag"></i> نوع التقرير</label>

          <select name="{{ form.category.html_name }}" id="{{ form.category.id_for_label }}" required>
            <option value="" selected hidden>— اختر نوع التقرير —</option>
            {% for value,label in form.fields.category.choices %}
              {% if value != "" %}
                <option value="{{ value }}"
                        {% if form.is_bound and form.data.category == value %}selected{% endif %}
                        {% if not form.is_bound and form.initial.category == value %}selected{% endif %}>
                  {{ label }}
                </option>
              {% endif %}
            {% endfor %}
          </select>

          {% if form.category.errors %}
            <div class="ar-alert">{% for e in form.category.errors %}• {{ e }}<br>{% endfor %}</div>
          {% endif %}
        </div>

        <!-- اسم المعلم -->
        <div class="ar-group" data-group="teacher_name">
          <label for="id_teacher_name"><i class="fa-solid fa-user"></i> اسم المعلم</label>
          <input
            type="text"
            id="id_teacher_name"
            name="teacher_name"
            maxlength="120"
            placeholder="اكتب اسم المعلم"
            value="{{ form.data.teacher_name|default:request.user.name }}"
            required
          >
        </div>

        <!-- العنوان -->
        <div class="ar-group" data-group="title">
          <label for="{{ form.title.id_for_label }}"><i class="fa-solid fa-heading"></i> العنوان</label>
          {{ form.title }}
          {% if form.title.errors %}
            <div class="ar-alert">{% for e in form.title.errors %}• {{ e }}<br>{% endfor %}</div>
          {% endif %}
        </div>

        <!-- التاريخ -->
        <div class="ar-group" data-group="report_date">
          <label for="{{ form.report_date.id_for_label }}"><i class="fa-solid fa-calendar"></i> اختر التاريخ</label>
          {{ form.report_date }}
          <div class="ar-alert" id="futureDateErr" style="display:none">لا يُسمح بتاريخ مستقبلي. اختر تاريخ اليوم أو سابقًا.</div>
          {% if form.report_date.errors %}
            <div class="ar-alert">{% for e in form.report_date.errors %}• {{ e }}<br>{% endfor %}</div>
          {% endif %}
        </div>

        <!-- اليوم -->
        <div class="ar-group">
          <label for="{{ form.day_name.id_for_label }}"><i class="fa-solid fa-calendar-day"></i> اليوم</label>
          {{ form.day_name }}
        </div>

        <!-- عدد المستفيدين -->
        <div class="ar-group">
          <label for="{{ form.beneficiaries_count.id_for_label }}"><i class="fa-solid fa-users"></i> عدد المستفيدين</label>
          {{ form.beneficiaries_count }}
        </div>

        <!-- الوصف -->
        <div class="ar-group" data-group="idea">
          <label for="{{ form.idea.id_for_label }}"><i class="fa-solid fa-file-lines"></i> الوصف</label>
          {{ form.idea }}
          {% if form.idea.errors %}
            <div class="ar-alert">{% for e in form.idea.errors %}• {{ e }}<br>{% endfor %}</div>
          {% endif %}
        </div>

        <!-- الصور -->
        <div class="ar-group">
          <label><i class="fa-solid fa-images"></i> الصور (اختياري)</label>

          <div class="ar-img-grid">
            <div class="ar-drop">
              <div class="ico"><i class="fa-solid fa-camera"></i></div>
              <div class="txt">صورة 1</div>
              {{ form.image1 }}
            </div>
            <div class="ar-drop">
              <div class="ico"><i class="fa-solid fa-camera"></i></div>
              <div class="txt">صورة 2</div>
              {{ form.image2 }}
            </div>
            <div class="ar-drop">
              <div class="ico"><i class="fa-solid fa-camera"></i></div>
              <div class="txt">صورة 3</div>
              {{ form.image3 }}
            </div>
            <div class="ar-drop">
              <div class="ico"><i class="fa-solid fa-camera"></i></div>
              <div class="txt">صورة 4</div>
              {{ form.image4 }}
            </div>
          </div>

          <div class="ar-previews" id="preview-container"></div>
          <div class="ar-help">سيتم ضغط الصور تلقائيًا قبل الرفع لتسريع العملية.</div>
        </div>

        <div class="ar-actions">
          <button id="submitBtn" type="submit" class="ar-btn ar-btn-primary">
            <i class="fa-solid fa-floppy-disk"></i> حفظ التقرير
          </button>

          <a class="ar-btn ar-btn-outline" href="{% url 'reports:home' %}">
            <i class="fa-solid fa-arrow-right"></i> العودة للرئيسية
          </a>
        </div>
      </form>
    </div>
  </div>

  <!-- Overlay -->
  <div class="ar-overlay" id="uploadOverlay" aria-hidden="true">
    <div class="ar-up">
      <h3><i class="fa-solid fa-cloud-arrow-up"></i> يتم رفع الصور…</h3>
      <p>يرجى الانتظار وعدم إغلاق الصفحة.</p>
      <div class="ar-bar"><div class="ar-fill" id="upFill"></div></div>
      <div class="ar-mini"><span id="upLabel">تحضير…</span><span id="upPct">0%</span></div>
    </div>
  </div>
</div>

<script>
  function todayYYYYMMDD(){
    const t = new Date(); t.setHours(0,0,0,0);
    const y = t.getFullYear();
    const m = String(t.getMonth()+1).padStart(2,'0');
    const d = String(t.getDate()).padStart(2,'0');
    return `${y}-${m}-${d}`;
  }
  function parseDateInput(val){
    const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(val || "");
    if(!m) return null;
    const dt = new Date(Number(m[1]), Number(m[2])-1, Number(m[3]));
    dt.setHours(0,0,0,0);
    return isNaN(dt) ? null : dt;
  }

  // منع التاريخ المستقبلي + توليد اسم اليوم
  (function(){
    const d = document.getElementById("id_report_date");
    const day = document.getElementById("id_day_name");
    const err = document.getElementById("futureDateErr");

    if(d){
      d.setAttribute("max", todayYYYYMMDD());
      if(!d.value){ d.value = todayYYYYMMDD(); }

      d.addEventListener("change", function(){
        err.style.display = "none";
        d.classList.remove("ar-invalid");

        const dt = parseDateInput(this.value);
        if(!dt){ if(day) day.value=""; return; }

        const now = parseDateInput(todayYYYYMMDD());
        if(dt.getTime() > now.getTime()){
          err.style.display = "block";
          d.classList.add("ar-invalid");
          if(day) day.value = "";
          return;
        }

        if(day){
          const days = ["الأحد","الاثنين","الثلاثاء","الأربعاء","الخميس","الجمعة","السبت"];
          day.value = days[dt.getDay()];
        }
      });
    }
  })();

  // مدخلات الصور: accept + (capture اختياري)
  (function(){
    const ids = ["id_image1","id_image2","id_image3","id_image4"];
    ids.forEach((id)=>{
      const inp = document.getElementById(id);
      if(!inp) return;
      inp.setAttribute("accept","image/*");

      // إذا تبي تفرض فتح الكاميرا في الجوال فعل السطر التالي:
      // inp.setAttribute("capture","environment");
    });
  })();

  // معاينة صور: استبدال المعاينة الخاصة بكل خانة بدل التكرار
  (function(){
    const slots = [
      {id:"id_image1", slot:"1"},
      {id:"id_image2", slot:"2"},
      {id:"id_image3", slot:"3"},
      {id:"id_image4", slot:"4"},
    ];
    const previewContainer = document.getElementById("preview-container");
    if(!previewContainer) return;

    function upsertPreview(slotKey, dataUrl, inputEl){
      const existing = previewContainer.querySelector(`[data-slot="${slotKey}"]`);
      const wrap = existing || document.createElement("div");
      wrap.className = "ar-prev";
      wrap.dataset.slot = slotKey;

      wrap.innerHTML = "";
      const img = document.createElement("img");
      img.src = dataUrl;

      const x = document.createElement("button");
      x.type = "button";
      x.className = "ar-x";
      x.setAttribute("aria-label", "حذف الصورة");
      x.textContent = "×";
      x.addEventListener("click", function(){
        inputEl.value = "";
        wrap.remove();
      });

      wrap.appendChild(img);
      wrap.appendChild(x);

      if(!existing) previewContainer.appendChild(wrap);
    }

    slots.forEach(({id, slot})=>{
      const input = document.getElementById(id);
      if(!input) return;

      input.addEventListener("change", function(e){
        const file = e.target.files && e.target.files[0];
        if(!file) return;

        const reader = new FileReader();
        reader.onload = function(ev){
          upsertPreview(slot, ev.target.result, input);
        };
        reader.readAsDataURL(file);
      });
    });
  })();

  // Validation helpers
  function clearClientErrors(form){
    form.querySelectorAll('.ar-alert[data-gen="1"]').forEach(e=>e.remove());
    form.querySelectorAll('.ar-invalid').forEach(e=>e.classList.remove('ar-invalid'));
  }
  function addError(groupEl, inputEl, msg){
    if(inputEl) inputEl.classList.add('ar-invalid');
    const box = document.createElement('div');
    box.className = 'ar-alert';
    box.dataset.gen = '1';
    box.textContent = msg;
    groupEl.appendChild(box);
  }

  function validateForm(form){
    clearClientErrors(form);
    let firstBad = null;

    const gCat = form.querySelector('[data-group="category"]');
    const sel = gCat && gCat.querySelector('select');
    if(sel && !sel.value){ addError(gCat, sel, 'فضلاً اختر نوع التقرير.'); firstBad = firstBad || sel; }

    const gName = form.querySelector('[data-group="teacher_name"]');
    const nameInput = gName && gName.querySelector('input[name="teacher_name"]');
    if(nameInput && !nameInput.value.trim()){ addError(gName, nameInput, 'اكتب اسم المعلم.'); firstBad = firstBad || nameInput; }

    const gTitle = form.querySelector('[data-group="title"]');
    const titleEl = gTitle && gTitle.querySelector('input,textarea,select');
    if(titleEl && !titleEl.value.trim()){ addError(gTitle, titleEl, 'اكتب عنوان التقرير.'); firstBad = firstBad || titleEl; }

    const gDate = form.querySelector('[data-group="report_date"]');
    const dateEl = document.getElementById('id_report_date');
    if(dateEl){
      if(!dateEl.value){ addError(gDate, dateEl, 'اختر تاريخ التقرير.'); firstBad = firstBad || dateEl; }
      else{
        const picked = parseDateInput(dateEl.value);
        const today  = parseDateInput(todayYYYYMMDD());
        if(!picked){ addError(gDate, dateEl, 'تاريخ غير صالح.'); firstBad = firstBad || dateEl; }
        else if(picked.getTime() > today.getTime()){
          addError(gDate, dateEl, 'لا يُسمح بتاريخ مستقبلي.');
          firstBad = firstBad || dateEl;
        }
      }
    }

    const gIdea = form.querySelector('[data-group="idea"]');
    const ideaEl = gIdea && (gIdea.querySelector('textarea') || gIdea.querySelector('input'));
    if(ideaEl && !ideaEl.value.trim()){ addError(gIdea, ideaEl, 'اكتب وصف/فكرة التقرير.'); firstBad = firstBad || ideaEl; }

    if(firstBad){
      firstBad.scrollIntoView({behavior:'smooth', block:'center'});
      firstBad.focus();
      return false;
    }
    return true;
  }

  // Compress + Upload progress
  (function(){
    const form = document.getElementById('report-form');
    const overlay = document.getElementById('uploadOverlay');
    const fill = document.getElementById('upFill');
    const label = document.getElementById('upLabel');
    const pctEl = document.getElementById('upPct');
    const submitBtn = document.getElementById('submitBtn');

    const MAX_DIM = 1600;
    const JPEG_QUALITY = 0.82;

    function compressImage(file){
      return new Promise((resolve)=>{
        try{
          if(!file || !file.type || !file.type.startsWith('image/')) return resolve(file);

          const img = new Image();
          const objUrl = URL.createObjectURL(file);

          img.onload = ()=>{
            try{
              const canvas = document.createElement('canvas');
              let width = img.width;
              let height = img.height;

              if(width > height && width > MAX_DIM){
                height = Math.round(height * (MAX_DIM / width));
                width = MAX_DIM;
              } else if(height >= width && height > MAX_DIM){
                width = Math.round(width * (MAX_DIM / height));
                height = MAX_DIM;
              }

              canvas.width = width;
              canvas.height = height;

              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0, width, height);

              canvas.toBlob((blob)=>{
                URL.revokeObjectURL(objUrl);
                if(blob){
                  const newName = file.name.replace(/\.(heic|heif|png|webp)$/i, '.jpg');
                  resolve(new File([blob], newName, {type:'image/jpeg', lastModified: Date.now()}));
                } else {
                  resolve(file);
                }
              }, 'image/jpeg', JPEG_QUALITY);
            }catch(e){
              URL.revokeObjectURL(objUrl);
              resolve(file);
            }
          };

          img.onerror = ()=>{
            URL.revokeObjectURL(objUrl);
            resolve(file);
          };

          img.src = objUrl;
        }catch(e){
          resolve(file);
        }
      });
    }

    async function buildCompressedFormData(formEl){
      const fd = new FormData();
      for (const el of formEl.elements){
        if(!el.name || el.disabled) continue;
        if(el.type === 'file') continue;
        if((el.type === 'checkbox' || el.type === 'radio') && !el.checked) continue;
        fd.append(el.name, el.value);
      }

      const names = ['image1','image2','image3','image4'];
      for (const n of names){
        const input = formEl.querySelector(`[name="${n}"]`);
        if(input && input.files && input.files[0]){
          const c = await compressImage(input.files[0]);
          fd.append(n, c, c.name);
        }
      }
      return fd;
    }

    if(!form) return;

    form.addEventListener('submit', async function(ev){
      ev.preventDefault();
      if(!validateForm(form)) return;

      overlay.style.display = 'flex';
      overlay.setAttribute('aria-hidden', 'false');
      fill.style.width = '0%';
      pctEl.textContent = '0%';
      label.textContent = 'تحضير الملفات…';

      if(submitBtn){
        submitBtn.disabled = true;
        submitBtn.style.opacity = '.75';
        submitBtn.style.cursor = 'not-allowed';
      }

      try{
        const fd = await buildCompressedFormData(form);
        const csrf = form.querySelector('input[name="csrfmiddlewaretoken"]')?.value;

        const xhr = new XMLHttpRequest();
        xhr.open('POST', form.action || window.location.href, true);
        if (csrf) xhr.setRequestHeader('X-CSRFToken', csrf);
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');

        xhr.upload.onprogress = function(e){
          if(e.lengthComputable){
            const p = Math.round((e.loaded / e.total) * 100);
            fill.style.width = p + '%';
            pctEl.textContent = p + '%';
            label.textContent = p < 100 ? 'جاري الرفع…' : 'معالجة الطلب…';
          }
        };

        xhr.onreadystatechange = function(){
          if(xhr.readyState === 4){
            if(xhr.status >= 200 && xhr.status < 400){
              if(xhr.responseURL && xhr.responseURL !== window.location.href){
                window.location.href = xhr.responseURL;
              } else {
                window.location.href = "{% url 'reports:my_reports' %}";
              }
              return;
            }

            overlay.style.display = 'none';
            overlay.setAttribute('aria-hidden', 'true');

            if(submitBtn){
              submitBtn.disabled = false;
              submitBtn.style.opacity = '';
              submitBtn.style.cursor = '';
            }

            alert('تعذّر إكمال الرفع. حاول لاحقًا.');
          }
        };

        xhr.onerror = function(){
          overlay.style.display = 'none';
          overlay.setAttribute('aria-hidden', 'true');

          if(submitBtn){
            submitBtn.disabled = false;
            submitBtn.style.opacity = '';
            submitBtn.style.cursor = '';
          }

          alert('حدث خطأ بالشبكة أثناء الرفع.');
        };

        xhr.send(fd);
      }catch(e){
        overlay.style.display = 'none';
        overlay.setAttribute('aria-hidden', 'true');

        if(submitBtn){
          submitBtn.disabled = false;
          submitBtn.style.opacity = '';
          submitBtn.style.cursor = '';
        }

        alert('تعذّر ضغط/رفع الصور. حاول مجددًا.');
      }
    });
  })();
</script>
{% endblock %}
