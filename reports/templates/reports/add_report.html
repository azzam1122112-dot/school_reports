{# reports/templates/reports/report_form.html (أو add_report.html حسب مشروعك) #}
{% extends "base.html" %}
{% load static %}
{% block title %}إضافة تقرير{% endblock %}

{% block head %}
<style>
  /* ===== Scoped فقط داخل صفحة إضافة تقرير ===== */
  .add-report{
    --ar-primary: var(--brand, #2563eb);
    --ar-accent: var(--accent, #059669);
    --ar-ink: var(--ink, #0f172a);
    --ar-muted: var(--muted, #64748b);
    --ar-line: var(--line-2, #e2e8f0);
    --ar-bg: var(--bg, #f5f7fb);
    --ar-card: var(--card, #fff);
    --ar-shadow: 0 10px 40px rgba(2, 6, 23, 0.08);
    --ar-grad: linear-gradient(135deg, var(--ar-primary) 0%, #4f46e5 60%, var(--ar-accent) 100%);
    min-height: 100dvh;
    background: var(--ar-bg);
    padding: 20px 0;
  }

  .add-report .ar-wrap{max-width:900px;margin:0 auto;padding:0 16px}
  .add-report .ar-card{
    background: var(--ar-card);
    border: 1px solid var(--ar-line);
    border-radius: 20px;
    padding: 26px;
    box-shadow: var(--ar-shadow);
    position: relative;
    overflow: hidden;
  }
  .add-report .ar-card::before{
    content:"";
    position:absolute; inset:0 0 auto 0;
    height:5px;
    background: var(--ar-grad);
    opacity:.95;
  }

  .add-report .ar-title{
    margin: 0 0 18px;
    padding-bottom: 14px;
    border-bottom: 1px solid var(--ar-line);
    display:flex; align-items:center; gap:10px;
    font-weight: 900;
    font-size: 1.55rem;
    background: var(--ar-grad);
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
  }

  .add-report .ar-grid{display:grid;gap:18px}
  .add-report .ar-group{display:flex;flex-direction:column;gap:8px}

  .add-report label{
    font-weight: 900;
    color: var(--ar-ink);
    display:flex; align-items:center; gap:8px;
  }

  .add-report input,
  .add-report textarea,
  .add-report select{
    width:100%;
    padding: 12px 14px;
    border: 1.5px solid var(--ar-line);
    border-radius: 14px;
    background: rgba(248,250,252,.85);
    color: var(--ar-ink);
    font-family: inherit;
    transition: border-color .15s ease, box-shadow .15s ease, background .15s ease;
  }
  html[data-theme="dark"] .add-report input,
  html[data-theme="dark"] .add-report textarea,
  html[data-theme="dark"] .add-report select{
    background: rgba(11,18,32,.65);
  }
  .add-report textarea{min-height:140px;resize:vertical;line-height:1.7}
  .add-report input:focus,
  .add-report textarea:focus,
  .add-report select:focus{
    outline:none;
    border-color: var(--ar-primary);
    box-shadow: 0 0 0 3px rgba(37,99,235,.18);
    background:#fff;
  }
  html[data-theme="dark"] .add-report input:focus,
  html[data-theme="dark"] .add-report textarea:focus,
  html[data-theme="dark"] .add-report select:focus{
    background: rgba(15,22,41,.75);
  }

  .add-report .ar-help{
    margin-top: 10px;
    padding: 12px 14px;
    border-radius: 14px;
    border: 1px solid var(--ar-line);
    background: rgba(37,99,235,.05);
    color: var(--ar-muted);
    font-weight: 800;
  }

  /* أخطاء */
  .add-report .ar-alert{
    border-radius: 14px;
    padding: 12px 14px;
    font-weight: 800;
    border: 1px solid rgba(254,202,202,.95);
    background: rgba(254,242,242,.95);
    color: #b91c1c;
    margin-bottom: 10px;
    white-space: pre-line;
  }
  html[data-theme="dark"] .add-report .ar-alert{
    background: rgba(127,29,29,.22);
    border-color: rgba(239,68,68,.22);
    color: #fecaca;
  }
  .add-report .ar-invalid{
    border-color: rgba(239,68,68,.45) !important;
    box-shadow: 0 0 0 3px rgba(239,68,68,.12) !important;
  }

  /* صور */
  .add-report .ar-img-grid{
    display:grid;
    grid-template-columns: repeat(4, minmax(0,1fr));
    gap: 14px;
    margin-top: 8px;
  }
  .add-report .ar-drop{
    position:relative;
    border: 2px dashed var(--ar-line);
    border-radius: 16px;
    padding: 18px 10px;
    background: rgba(248,250,252,.75);
    text-align:center;
    cursor:pointer;
    transition: transform .12s ease, border-color .12s ease, background .12s ease;
    display:flex; flex-direction:column; align-items:center; justify-content:center; gap:8px;
    min-height: 110px;
  }
  html[data-theme="dark"] .add-report .ar-drop{background: rgba(11,18,32,.55)}
  .add-report .ar-drop:hover{
    border-color: rgba(37,99,235,.45);
    background: rgba(37,99,235,.06);
    transform: translateY(-2px);
  }
  .add-report .ar-drop input[type="file"]{
    position:absolute; inset:0;
    width:100%; height:100%;
    opacity:0; cursor:pointer;
  }
  .add-report .ar-drop .ico{font-size:1.9rem;color: var(--ar-muted)}
  .add-report .ar-drop .txt{font-size:.9rem;color: var(--ar-muted);font-weight:800}

  .add-report .ar-previews{
    margin-top: 14px;
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 12px;
  }
  .add-report .ar-prev{
    position:relative;
    height: 120px;
    border-radius: 16px;
    border: 1px solid var(--ar-line);
    background: rgba(248,250,252,.75);
    overflow:hidden;
    display:flex; align-items:center; justify-content:center;
  }
  html[data-theme="dark"] .add-report .ar-prev{background: rgba(11,18,32,.55)}
  .add-report .ar-prev img{width:100%;height:100%;object-fit:cover}
  .add-report .ar-x{
    position:absolute; top:8px; right:8px;
    width:28px; height:28px;
    border-radius:999px;
    border:0;
    cursor:pointer;
    background: rgba(239,68,68,.92);
    color:#fff;
    font-weight:900;
    display:grid; place-items:center;
  }
  .add-report .ar-x:hover{background:#ef4444}

  /* أزرار */
  .add-report .ar-actions{display:grid;gap:12px;margin-top: 18px}
  .add-report .ar-btn{
    display:inline-flex; align-items:center; justify-content:center; gap:10px;
    padding: 14px 18px;
    border-radius: 16px;
    font-weight: 900;
    text-decoration:none;
    cursor:pointer;
    border: 1px solid transparent;
    transition: transform .12s ease, box-shadow .12s ease, background .12s ease, border-color .12s ease, opacity .12s ease;
  }
  .add-report .ar-btn-primary{
    background: var(--ar-grad);
    color:#fff;
    box-shadow: 0 12px 26px rgba(37,99,235,.25);
  }
  .add-report .ar-btn-primary:hover{transform: translateY(-2px); box-shadow: 0 16px 32px rgba(37,99,235,.32);}
  .add-report .ar-btn-outline{
    background: transparent;
    border-color: var(--ar-line);
    color: var(--ar-ink);
  }
  .add-report .ar-btn-outline:hover{border-color: rgba(37,99,235,.35); background: rgba(37,99,235,.05);}

  /* Overlay رفع */
  .add-report .ar-overlay{
    position:fixed; inset:0;
    background: rgba(15,23,42,.85);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:9999;
    backdrop-filter: blur(4px);
  }
  .add-report .ar-up{
    width: min(520px, 92vw);
    background: #fff;
    border-radius: 20px;
    padding: 22px;
    border: 1px solid rgba(226,232,240,.9);
    box-shadow: 0 25px 60px rgba(0,0,0,.3);
    text-align:center;
  }
  html[data-theme="dark"] .add-report .ar-up{
    background: #0f1629;
    border-color: rgba(27,39,68,.7);
    color: #e6ebff;
  }
  .add-report .ar-up h3{margin:0 0 8px;font-weight:900}
  .add-report .ar-up p{margin:0 0 14px;color:#475569;font-weight:800}
  html[data-theme="dark"] .add-report .ar-up p{color:#a9b8de}
  .add-report .ar-bar{height:12px;border-radius:999px;background:#eef2ff;overflow:hidden;border:1px solid #e2e8f0}
  html[data-theme="dark"] .add-report .ar-bar{background:#0b1220;border-color:rgba(27,39,68,.7)}
  .add-report .ar-fill{height:100%;width:0;background: var(--ar-grad);transition: width .25s ease}
  .add-report .ar-mini{display:flex;justify-content:space-between;margin-top:10px;color:#64748b;font-weight:900}
  html[data-theme="dark"] .add-report .ar-mini{color:#a9b8de}

  /* Responsive */
  @media (max-width: 900px){
    .add-report .ar-img-grid{grid-template-columns: repeat(2, minmax(0,1fr));}
  }
  @media (max-width: 520px){
    .add-report .ar-card{padding:18px}
    .add-report .ar-title{font-size:1.25rem}
    .add-report .ar-img-grid{grid-template-columns: 1fr;}
  }
</style>
{% endblock %}

{% block content %}
<div class="add-report">
  <div class="ar-wrap">
    <div class="ar-card">
      <h2 class="ar-title"><i class="fa-solid fa-plus"></i> إضافة تقرير جديد</h2>

      {% if form.non_field_errors %}
        <div class="ar-alert">
          {% for e in form.non_field_errors %}• {{ e }}{% if not forloop.last %}&#10;{% endif %}{% endfor %}
        </div>
      {% endif %}

      <form id="report-form" method="POST" enctype="multipart/form-data" class="ar-grid" autocomplete="off" novalidate>
        {% csrf_token %}

        <!-- نوع التقرير -->
        <div class="ar-group" data-group="category">
          <label for="{{ form.category.id_for_label }}"><i class="fa-solid fa-tag"></i> نوع التقرير</label>

          <select name="{{ form.category.html_name }}" id="{{ form.category.id_for_label }}" required>
            <option value="" selected hidden>— اختر نوع التقرير —</option>
            {% for value,label in form.fields.category.choices %}
              {% if value %}
                <option value="{{ value }}"
                        {% if form.is_bound and form.data.category == value %}selected{% endif %}
                        {% if not form.is_bound and form.initial.category == value %}selected{% endif %}>
                  {{ label }}
                </option>
              {% endif %}
            {% endfor %}
          </select>

          {% if form.category.errors %}
            <div class="ar-alert">{% for e in form.category.errors %}• {{ e }}{% if not forloop.last %}&#10;{% endif %}{% endfor %}</div>
          {% endif %}
        </div>

        <!-- اسم المعلم (اختياري عند وجوده في الفورم/الموديل) -->
        <div class="ar-group" data-group="teacher_name">
          <label for="id_teacher_name"><i class="fa-solid fa-user"></i> اسم المعلم</label>
          <input
            type="text"
            id="id_teacher_name"
            name="teacher_name"
            maxlength="120"
            placeholder="اكتب اسم المعلم"
            value="{% if form.data.teacher_name %}{{ form.data.teacher_name }}{% else %}{{ request.user.name|default:'' }}{% endif %}"
            required
          >
        </div>

        <!-- العنوان -->
        <div class="ar-group" data-group="title">
          <label for="{{ form.title.id_for_label }}"><i class="fa-solid fa-heading"></i> العنوان</label>
          {{ form.title }}
          {% if form.title.errors %}
            <div class="ar-alert">{% for e in form.title.errors %}• {{ e }}{% if not forloop.last %}&#10;{% endif %}{% endfor %}</div>
          {% endif %}
        </div>

        <!-- التاريخ -->
        <div class="ar-group" data-group="report_date">
          <label for="{{ form.report_date.id_for_label }}"><i class="fa-solid fa-calendar"></i> اختر التاريخ</label>
          {{ form.report_date }}
          <div class="ar-alert" id="futureDateErr" style="display:none">لا يُسمح بتاريخ مستقبلي. اختر تاريخ اليوم أو سابقًا.</div>
          {% if form.report_date.errors %}
            <div class="ar-alert">{% for e in form.report_date.errors %}• {{ e }}{% if not forloop.last %}&#10;{% endif %}{% endfor %}</div>
          {% endif %}
        </div>

        <!-- اليوم -->
        <div class="ar-group">
          <label for="{{ form.day_name.id_for_label }}"><i class="fa-solid fa-calendar-day"></i> اليوم</label>
          {{ form.day_name }}
        </div>

        <!-- عدد المستفيدين -->
        <div class="ar-group">
          <label for="{{ form.beneficiaries_count.id_for_label }}"><i class="fa-solid fa-users"></i> عدد المستفيدين</label>
          {{ form.beneficiaries_count }}
        </div>

        <!-- الوصف -->
        <div class="ar-group" data-group="idea">
          <label for="{{ form.idea.id_for_label }}"><i class="fa-solid fa-file-lines"></i> الوصف</label>
          {{ form.idea }}
          {% if form.idea.errors %}
            <div class="ar-alert">{% for e in form.idea.errors %}• {{ e }}{% if not forloop.last %}&#10;{% endif %}{% endfor %}</div>
          {% endif %}
        </div>

        <!-- الصور -->
        <div class="ar-group">
          <label><i class="fa-solid fa-images"></i> الصور (اختياري)</label>

          <div class="ar-img-grid">
            <div class="ar-drop">
              <div class="ico"><i class="fa-solid fa-camera"></i></div>
              <div class="txt">صورة 1</div>
              {{ form.image1 }}
            </div>
            <div class="ar-drop">
              <div class="ico"><i class="fa-solid fa-camera"></i></div>
              <div class="txt">صورة 2</div>
              {{ form.image2 }}
            </div>
            <div class="ar-drop">
              <div class="ico"><i class="fa-solid fa-camera"></i></div>
              <div class="txt">صورة 3</div>
              {{ form.image3 }}
            </div>
            <div class="ar-drop">
              <div class="ico"><i class="fa-solid fa-camera"></i></div>
              <div class="txt">صورة 4</div>
              {{ form.image4 }}
            </div>
          </div>

          <div class="ar-previews" id="preview-container"></div>
          <div class="ar-help">سيتم ضغط الصور تلقائيًا قبل الرفع لتسريع العملية.</div>
        </div>

        <div class="ar-actions">
          <button id="submitBtn" type="submit" class="ar-btn ar-btn-primary">
            <i class="fa-solid fa-floppy-disk"></i> حفظ التقرير
          </button>

          <a class="ar-btn ar-btn-outline" href="{% url 'reports:home' %}">
            <i class="fa-solid fa-arrow-right"></i> العودة للرئيسية
          </a>
        </div>
      </form>
    </div>
  </div>

  <!-- Overlay -->
  <div class="ar-overlay" id="uploadOverlay" aria-hidden="true" role="dialog" aria-modal="true" aria-label="جاري رفع الصور">
    <div class="ar-up">
      <h3><i class="fa-solid fa-cloud-arrow-up"></i> يتم رفع الصور…</h3>
      <p>يرجى الانتظار وعدم إغلاق الصفحة.</p>
      <div class="ar-bar"><div class="ar-fill" id="upFill"></div></div>
      <div class="ar-mini"><span id="upLabel">تحضير…</span><span id="upPct">0%</span></div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script nonce="{{ CSP_NONCE }}">
  function todayYYYYMMDD(){
    var t = new Date(); t.setHours(0,0,0,0);
    var y = t.getFullYear();
    var m = String(t.getMonth()+1).padStart(2,'0');
    var d = String(t.getDate()).padStart(2,'0');
    return y + "-" + m + "-" + d;
  }

  function parseDateInput(val){
    var m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(val || "");
    if(!m) return null;
    var dt = new Date(Number(m[1]), Number(m[2])-1, Number(m[3]));
    dt.setHours(0,0,0,0);
    return isNaN(dt) ? null : dt;
  }

  // منع التاريخ المستقبلي + توليد اسم اليوم + جعل day_name readonly
  (function(){
    var d = document.getElementById("id_report_date");
    var day = document.getElementById("id_day_name");
    var err = document.getElementById("futureDateErr");

    if(day){
      day.setAttribute('readonly', 'readonly');
      day.setAttribute('tabindex', '-1');
    }

    if(d){
      d.setAttribute("max", todayYYYYMMDD());
      if(!d.value){ d.value = todayYYYYMMDD(); }

      var applyDay = function(){
        if(!day) return;
        var dt = parseDateInput(d.value);
        if(!dt){ day.value=""; return; }
        var days = ["الأحد","الاثنين","الثلاثاء","الأربعاء","الخميس","الجمعة","السبت"];
        day.value = days[dt.getDay()];
      };

      d.addEventListener("change", function(){
        if(err) err.style.display = "none";
        d.classList.remove("ar-invalid");

        var dt = parseDateInput(this.value);
        if(!dt){ if(day) day.value=""; return; }

        var now = parseDateInput(todayYYYYMMDD());
        if(dt.getTime() > now.getTime()){
          if(err) err.style.display = "block";
          d.classList.add("ar-invalid");
          if(day) day.value = "";
          return;
        }

        applyDay();
      });

      d.dispatchEvent(new Event('change'));
    }
  })();

  // مدخلات الصور: accept + capture للجوال
  (function(){
    var ids = ["id_image1","id_image2","id_image3","id_image4"];
    for(var i=0;i<ids.length;i++){
      var inp = document.getElementById(ids[i]);
      if(!inp) continue;
      inp.setAttribute("accept","image/*");
      inp.setAttribute("capture","environment");
    }
  })();

  // معاينات الصور (استبدال حسب slot)
  (function(){
    var slots = [
      {id:"id_image1", slot:"1"},
      {id:"id_image2", slot:"2"},
      {id:"id_image3", slot:"3"},
      {id:"id_image4", slot:"4"}
    ];
    var previewContainer = document.getElementById("preview-container");
    if(!previewContainer) return;

    function upsertPreview(slotKey, dataUrl, inputEl){
      var existing = previewContainer.querySelector('[data-slot="' + slotKey + '"]');
      var wrap = existing || document.createElement("div");
      wrap.className = "ar-prev";
      wrap.dataset.slot = slotKey;

      wrap.innerHTML = "";
      var img = document.createElement("img");
      img.src = dataUrl;

      var x = document.createElement("button");
      x.type = "button";
      x.className = "ar-x";
      x.setAttribute("aria-label", "حذف الصورة");
      x.textContent = "×";
      x.addEventListener("click", function(){
        inputEl.value = "";
        wrap.remove();
      });

      wrap.appendChild(img);
      wrap.appendChild(x);

      if(!existing) previewContainer.appendChild(wrap);
    }

    slots.forEach(function(it){
      var input = document.getElementById(it.id);
      if(!input) return;

      input.addEventListener("change", function(e){
        var file = e.target.files && e.target.files[0];
        if(!file) return;

        var reader = new FileReader();
        reader.onload = function(ev){
          upsertPreview(it.slot, ev.target.result, input);
        };
        reader.readAsDataURL(file);
      });
    });
  })();

  // Validation helpers
  function clearClientErrors(form){
    form.querySelectorAll('.ar-alert[data-gen="1"]').forEach(function(e){ e.remove(); });
    form.querySelectorAll('.ar-invalid').forEach(function(e){ e.classList.remove('ar-invalid'); });
  }
  function addError(groupEl, inputEl, msg){
    if(inputEl) inputEl.classList.add('ar-invalid');
    var box = document.createElement('div');
    box.className = 'ar-alert';
    box.dataset.gen = '1';
    box.textContent = msg;
    groupEl.appendChild(box);
  }

  function validateForm(form){
    clearClientErrors(form);
    var firstBad = null;

    var gCat = form.querySelector('[data-group="category"]');
    var sel = gCat && gCat.querySelector('select');
    if(sel && !sel.value){
      addError(gCat, sel, 'فضلاً اختر نوع التقرير.');
      firstBad = firstBad || sel;
    }

    var gName = form.querySelector('[data-group="teacher_name"]');
    var nameInput = gName && gName.querySelector('input[name="teacher_name"]');
    if(nameInput && !nameInput.value.trim()){
      addError(gName, nameInput, 'اكتب اسم المعلم.');
      firstBad = firstBad || nameInput;
    }

    var gTitle = form.querySelector('[data-group="title"]');
    var titleEl = gTitle && gTitle.querySelector('input,textarea,select');
    if(titleEl && !titleEl.value.trim()){
      addError(gTitle, titleEl, 'اكتب عنوان التقرير.');
      firstBad = firstBad || titleEl;
    }

    var gDate = form.querySelector('[data-group="report_date"]');
    var dateEl = document.getElementById('id_report_date');
    if(dateEl){
      if(!dateEl.value){
        addError(gDate, dateEl, 'اختر تاريخ التقرير.');
        firstBad = firstBad || dateEl;
      }else{
        var picked = parseDateInput(dateEl.value);
        var today  = parseDateInput(todayYYYYMMDD());
        if(!picked){
          addError(gDate, dateEl, 'تاريخ غير صالح.');
          firstBad = firstBad || dateEl;
        }else if(picked.getTime() > today.getTime()){
          addError(gDate, dateEl, 'لا يُسمح بتاريخ مستقبلي.');
          firstBad = firstBad || dateEl;
        }
      }
    }

    var gIdea = form.querySelector('[data-group="idea"]');
    var ideaEl = gIdea && (gIdea.querySelector('textarea') || gIdea.querySelector('input'));
    if(ideaEl && !ideaEl.value.trim()){
      addError(gIdea, ideaEl, 'اكتب وصف/فكرة التقرير.');
      firstBad = firstBad || ideaEl;
    }

    if(firstBad){
      firstBad.scrollIntoView({behavior:'smooth', block:'center'});
      firstBad.focus();
      return false;
    }
    return true;
  }

  // Compress + Upload progress + عرض HTML عند فشل 400
  (function(){
    var form = document.getElementById('report-form');
    var overlay = document.getElementById('uploadOverlay');
    var fill = document.getElementById('upFill');
    var label = document.getElementById('upLabel');
    var pctEl = document.getElementById('upPct');
    var submitBtn = document.getElementById('submitBtn');

    var MAX_DIM = 1600;
    var JPEG_QUALITY = 0.82;

    function setOverlay(on){
      if(!overlay) return;
      overlay.style.display = on ? 'flex' : 'none';
      overlay.setAttribute('aria-hidden', on ? 'false' : 'true');
      try{
        if(window.__lockScroll) window.__lockScroll(on);
      }catch(e){
        // ignore
      }
    }

    function compressImage(file){
      return new Promise(function(resolve){
        try{
          if(!file || !file.type || !file.type.startsWith('image/')) return resolve(file);

          var img = new Image();
          var objUrl = URL.createObjectURL(file);

          img.onload = function(){
            try{
              var canvas = document.createElement('canvas');
              var width = img.width;
              var height = img.height;

              if(width > height && width > MAX_DIM){
                height = Math.round(height * (MAX_DIM / width));
                width = MAX_DIM;
              } else if(height >= width && height > MAX_DIM){
                width = Math.round(width * (MAX_DIM / height));
                height = MAX_DIM;
              }

              canvas.width = width;
              canvas.height = height;

              var ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0, width, height);

              canvas.toBlob(function(blob){
                URL.revokeObjectURL(objUrl);
                if(blob){
                  var newName = file.name.replace(/\.(heic|heif|png|webp)$/i, '.jpg');
                  resolve(new File([blob], newName, {type:'image/jpeg', lastModified: Date.now()}));
                } else {
                  resolve(file);
                }
              }, 'image/jpeg', JPEG_QUALITY);
            }catch(e){
              URL.revokeObjectURL(objUrl);
              resolve(file);
            }
          };

          img.onerror = function(){
            URL.revokeObjectURL(objUrl);
            resolve(file);
          };

          img.src = objUrl;
        }catch(e){
          resolve(file);
        }
      });
    }

    async function buildCompressedFormData(formEl){
      var fd = new FormData();

      for (var i=0;i<formEl.elements.length;i++){
        var el = formEl.elements[i];
        if(!el.name || el.disabled) continue;
        if(el.type === 'file') continue;
        if((el.type === 'checkbox' || el.type === 'radio') && !el.checked) continue;
        fd.append(el.name, el.value);
      }

      var names = ['image1','image2','image3','image4'];
      for (var j=0;j<names.length;j++){
        var n = names[j];
        var input = formEl.querySelector('[name="' + n + '"]');
        if(input && input.files && input.files[0]){
          if(label) label.textContent = 'ضغط الصور…';
          var c = await compressImage(input.files[0]);
          fd.append(n, c, c.name);
        }
      }
      return fd;
    }

    if(!form) return;

    form.addEventListener('submit', async function(ev){
      ev.preventDefault();
      if(!validateForm(form)) return;

      setOverlay(true);
      if(fill) fill.style.width = '0%';
      if(pctEl) pctEl.textContent = '0%';
      if(label) label.textContent = 'تحضير الملفات…';

      if(submitBtn){
        submitBtn.disabled = true;
        submitBtn.style.opacity = '.75';
        submitBtn.style.cursor = 'not-allowed';
      }

      try{
        var fd = await buildCompressedFormData(form);
        var csrf = form.querySelector('input[name="csrfmiddlewaretoken"]');
        var csrfVal = csrf ? csrf.value : '';

        var xhr = new XMLHttpRequest();
        xhr.open('POST', form.action || window.location.href, true);
        if (csrfVal) xhr.setRequestHeader('X-CSRFToken', csrfVal);
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');

        xhr.upload.onprogress = function(e){
          if(e.lengthComputable){
            var p = Math.round((e.loaded / e.total) * 100);
            if(fill) fill.style.width = p + '%';
            if(pctEl) pctEl.textContent = p + '%';
            if(label) label.textContent = p < 100 ? 'جاري الرفع…' : 'معالجة الطلب…';
          }
        };

        xhr.onreadystatechange = function(){
          if(xhr.readyState !== 4) return;

          // نجاح
          if(xhr.status >= 200 && xhr.status < 400){
            if(xhr.responseURL && xhr.responseURL !== window.location.href){
              window.location.href = xhr.responseURL;
            } else {
              window.location.href = "{% url 'reports:my_reports' %}";
            }
            return;
          }

          // فشل: لو السيرفر رجّع HTML (عادة صفحة النموذج مع الأخطاء) اعرضه مباشرة
          var ct = (xhr.getResponseHeader('Content-Type') || '').toLowerCase();
          if(ct.includes('text/html') && xhr.responseText){
            document.open();
            document.write(xhr.responseText);
            document.close();
            return;
          }

          setOverlay(false);
          if(submitBtn){
            submitBtn.disabled = false;
            submitBtn.style.opacity = '';
            submitBtn.style.cursor = '';
          }
          alert('تعذّر إكمال الحفظ. تأكد من الحقول ثم حاول مجددًا.');
        };

        xhr.onerror = function(){
          setOverlay(false);
          if(submitBtn){
            submitBtn.disabled = false;
            submitBtn.style.opacity = '';
            submitBtn.style.cursor = '';
          }
          alert('حدث خطأ بالشبكة أثناء الرفع.');
        };

        xhr.send(fd);
      }catch(e){
        setOverlay(false);
        if(submitBtn){
          submitBtn.disabled = false;
          submitBtn.style.opacity = '';
          submitBtn.style.cursor = '';
        }
        alert('تعذّر ضغط/رفع الصور. حاول مجددًا.');
      }
    });
  })();
</script>
{% endblock %}
