{% load static %}
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>تقرير: {% firstof r.title "بدون عنوان" %}</title>
  
  {% if not for_pdf %}
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  {% endif %}

  <style>
    :root {
      --font-body: 'Tajawal', system-ui, sans-serif;
      --color-black: #000000;
      --color-gray: #4b5563;
      --color-border: #000000; /* Official reports often use strong borders */
    }

    * { box-sizing: border-box; }
    
    body {
      margin: 0;
      padding: 0;
      font-family: var(--font-body);
      background: #e5e5e5; /* Grey background for screen preview */
      color: var(--color-black);
      -webkit-font-smoothing: antialiased;
    }

    /* A4 Container */
    .page {
      width: 210mm;
      min-height: 297mm;
      margin: 20px auto;
      background: white;
      padding: 20mm 20mm; /* Standard margin */
      position: relative;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
      overflow: hidden; /* Ensure content stays within */
    }

    /* Print Settings */
    @media print {
      body {
        margin: 0;
        background: white;
      }
      .page {
        margin: 0;
        width: 100%;
        min-height: 297mm;
        border: none;
        box-shadow: none;
        padding: 10mm 15mm;
        position: relative;
        overflow: visible; /* Allow content to flow across pages if needed */
      }
      .no-print { display: none !important; }
      
      @page {
        size: A4;
        margin: 10mm; /* Printer margin */
      }
    }

    /* Toolbar for Screen */
    .toolbar {
      position: sticky;
      top: 0;
      z-index: 100;
      background: #333;
      color: white;
      padding: 10px;
      text-align: center;
      display: flex;
      gap: 10px;
      justify-content: center;
      align-items: center;
    }
    .btn {
      background: white;
      color: #333;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-family: inherit;
      font-weight: bold;
      text-decoration: none;
      font-size: 14px;
    }
    .btn:hover { background: #f0f0f0; }
    .btn-print { background: #2563eb; color: white; }
    .btn-print:hover { background: #1d4ed8; }

    /* --- OFFICIAL HEADER --- */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      border-bottom: 2px solid var(--color-black);
      padding-bottom: 15px;
      margin-bottom: 30px;
    }

    .header-col {
      flex: 1;
      text-align: center;
    }

    .header-right {
      text-align: right;
      font-size: 14px;
      line-height: 1.6;
      font-weight: 700;
    }
    
    .header-left {
      text-align: left;
      font-size: 14px;
      line-height: 1.6;
      font-weight: 700;
    }
    
    .header-center {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .logo-img {
      height: 90px;
      width: auto;
      object-fit: contain;
    }

    /* --- CONTENT --- */
    .report-title-box {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .report-title {
      font-size: 24px;
      font-weight: 800;
      text-decoration: underline;
      text-underline-offset: 8px;
      margin: 0;
    }
    
    .report-meta {
      font-size: 14px;
      color: var(--color-gray);
      margin-top: 8px;
    }

    /* Meta Table - Official Grid Style */
    .meta-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 30px;
      font-size: 15px;
    }
    
    .meta-table th, .meta-table td {
      border: 1px solid #000;
      padding: 10px 12px;
      text-align: right;
    }
    
    .meta-table th {
      background-color: #f3f3f3; /* Light grey for headers */
      font-weight: 800;
      width: 150px;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }

    /* Main Body Text */
    .content-section {
      margin-bottom: 30px;
      font-size: 16px;
      line-height: 2;
      border: 1px solid #000;
      padding: 15px;
      min-height: 150px;
    }

    .section-label {
      font-size: 18px;
      font-weight: 800;
      margin-bottom: 15px;
      display: inline-block;
      border-bottom: 2px solid #ccc;
      padding-bottom: 5px;
    }

    /* Images Grid */
    .images-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-top: 20px;
      page-break-inside: avoid;
    }
    
    .img-box {
      border: 1px solid #ccc;
      padding: 5px;
      background: #fff;
      text-align: center;
    }
    
    .img-box img {
      max-width: 100%;
      height: 200px;
      object-fit: contain;
      display: block;
      margin: 0 auto;
    }
    
    .img-caption {
      font-size: 12px;
      margin-top: 5px;
      color: #666;
    }

    /* Achievements / Table Data */
    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 14px;
    }
    .data-table th, .data-table td {
      border: 1px solid #000;
      padding: 8px;
      text-align: center;
    }
    .data-table th {
      background: #eee;
      font-weight: bold;
    }

    /* Watermark for draft/unofficial if needed */
    .watermark {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(-45deg);
      font-size: 100px;
      opacity: 0.05;
      font-weight: 900;
      pointer-events: none;
      z-index: 0;
    }
    
    .page-number {
      position: absolute;
      bottom: 10mm;
      left: 0;
      right: 0;
      text-align: center;
      font-size: 11px;
      color: #666;
    }

    /* Print specific footer repetition */
    @media print {
      .page-number {
        position: fixed;
        bottom: 5mm;
        left: 0;
        right: 0;
        background: rgba(255, 255, 255, 0.9);
        padding: 5px 0;
        border-top: 1px solid #eee; /* Optional subtle line */
      }
      
      /* Add padding to the page to prevent content overlapping fixed footer */
      .page {
        padding-bottom: 20mm !important; 
      }
    }

  </style>
</head>
<body>

  <!-- Screen Toolbar -->
  <div class="toolbar no-print">
    <span>معاينة الطباعة (A4)</span>
    <button onclick="window.print()" class="btn btn-print">
      <i class="fas fa-print"></i> طباعة / حفظ كـ 
    </button>
    <button onclick="goBack()" class="btn">
      <i class="fas fa-arrow-right"></i> عودة
    </button>
  </div>

  <div class="page">
    
    <!-- HEADER -->
    <header class="header">
      <div class="header-col header-right">
        <div>المملكة العربية السعودية</div>
        <div>وزارة التعليم</div>
         <div>مدرسة: {{ r.school.name|default:"غير محدد" }}</div>
      </div>
      
      <div class="header-col header-center">
        <!-- Default Logo or Specific -->
        {% if r.school.logo_file %}
          <img src="{{ r.school.logo_file.url }}" alt="Logo" class="logo-img">
        {% else %}
           <!-- Fallback Ministry Logo placeholder or text -->
           <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/18/Ministry_of_Education_%28Saudi_Arabia%29.svg/1200px-Ministry_of_Education_%28Saudi_Arabia%29.svg.png" alt="MOE" class="logo-img" style="opacity:0.8; height:80px;">
        {% endif %}
      </div>
      
      <div class="header-col header-left">
        <div>التاريخ: {{ r.created_at|date:"Y/m/d" }}</div>
        <div>رقم التقرير: #{{ r.id }}</div>
        {% if r.category %}
        <div>نوع التقرير: {{ r.category.name }}</div>
        {% endif %}
      </div>
    </header>

    <!-- CONTENT -->
    <div class="report-title-box">
      <h1 class="report-title">عنوان التقرير: {{ r.title }}</h1>
    </div>

    <!-- Info Table -->
    <table class="meta-table">
      <tr>
        <th>المسؤول (معد التقرير)</th>
        <td>{{ r.teacher_display_name }}</td>
        <th>القسم / المجال</th>
        <td>{{ r.category.name|default:"عام" }}</td>
      </tr>
      <tr>
        <th>الفترة / التاريخ</th>
        <td>{{ r.created_at|date:"l d F Y" }}</td>
        <th>حالة التقرير</th>
        <td>
          {% if r.is_draft %}مسودة{% else %}معتمد{% endif %}
        </td>
      </tr>
    </table>

    <div class="content-section">
      <div class="section-label">1. تفاصيل التقرير / الإنجاز:</div>
      <div style="white-space: pre-wrap; text-align: justify;">{{ r.description|default:r.idea|default:"لا يوجد تفاصيل إضافية." }}</div>
    </div>
    
    {% if r.image1 or r.image2 or r.image3 or r.image4 %}
    <div class="content-section" style="border:none; padding:0;">
      <div class="section-label">2. المرفقات و الشواهد المصورة:</div>
      <div class="images-grid">
        {% if r.image1 %}
        <div class="img-box">
           <img src="{{ r.image1.url }}" alt="Attachment 1">
        </div>
        {% endif %}
        {% if r.image2 %}
        <div class="img-box">
           <img src="{{ r.image2.url }}" alt="Attachment 2">
        </div>
        {% endif %}
        {% if r.image3 %}
        <div class="img-box">
           <img src="{{ r.image3.url }}" alt="Attachment 3">
        </div>
        {% endif %}
        {% if r.image4 %}
        <div class="img-box">
           <img src="{{ r.image4.url }}" alt="Attachment 4">
        </div>
        {% endif %}
      </div>
    </div>
    {% endif %}
    
    <div class="page-number">
       تم استخراج هذا التقرير آلياً من منصة توثـيق
    </div>

  </div>

  <script>
    function goBack() {
      if (window.history.length > 1) {
        window.history.back();
      } else {
        // Safe fallback if opened in a new tab
        window.location.href = "{% url 'reports:my_reports' %}";
      }
    }

    // Auto print if ?print=true (optional)
    if(window.location.search.includes('print=true')){
      window.print();
    }
  </script>
</body>
</html>
