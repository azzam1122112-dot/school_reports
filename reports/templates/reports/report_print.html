{% load static %}
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light" />
  <title>تقرير {% firstof r.title "بدون عنوان" %}</title>

  {% if not for_pdf %}
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800;900&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  {% endif %}

  <style>
    :root{
      --ink:#0f172a;
      --muted:#64748b;
      --line:#e2e8f0;
      --brand:#2563eb;
      --bg:#f8fafc;
      --card:#ffffff;
      --radius:12px;
      --print-margin:15mm;
    }

    *{ box-sizing:border-box }
    html,body{ margin:0; padding:0 }
    body{
      font-family: {% if not for_pdf %}'Tajawal',{% endif %} system-ui,-apple-system,"Segoe UI",Arial,sans-serif;
      color:var(--ink);
      background:#fff;
      line-height:1.65;
      text-align:right;
    }
    img{ max-width:100%; height:auto; display:block }

    /* ===== شريط الأدوات (لا يُطبع) ===== */
    .toolbar{
      display:flex;
      gap:12px;
      justify-content:center;
      align-items:center;
      padding:15px;
      background:#fff;
      border-bottom:1px solid var(--line);
      z-index:99;
    }
    .btn{
      padding:10px 18px;
      border-radius:10px;
      border:1px solid #cbd5e1;
      background:#fff;
      cursor:pointer;
      font-weight:900;
      display:inline-flex;
      align-items:center;
      gap:8px;
      text-decoration:none;
      color:var(--ink);
      transition: .15s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:hover{ transform: translateY(-1px) }
    .btn-primary{ background:var(--brand); color:#fff; border-color:var(--brand) }
    .hint{ font-size:.9rem; color:var(--muted); font-weight:800 }

    /* ===== حاوية التقرير ===== */
    .report-wrapper{
      max-width:210mm;
      margin:0 auto;
      background:#fff;
    }

    @media screen{
      body{ background:#f1f5f9; padding:20px 0 }
      .report-wrapper{
        padding:var(--print-margin);
        min-height:297mm;
        box-shadow:0 0 20px rgba(0,0,0,.10);
        border-radius:14px;
      }
      .toolbar{
        position:sticky;
        top:0;
        margin-bottom:20px;
        box-shadow:0 2px 10px rgba(0,0,0,.05);
      }
    }

    /* ===== Header ===== */
    .hero{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      padding:18px;
      border-radius:var(--radius);
      margin-bottom:18px;
      background: linear-gradient(135deg, rgba(37,99,235,.92), rgba(16,185,129,.78));
      color:#fff;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }

    .hero-side{ flex:1; min-width:0 }
    .hero-right{ text-align:right }
    .hero-left{ text-align:left }
    .hero-center{ flex:0 0 auto; display:flex; align-items:center; justify-content:center }

    .ministry-logo{
      width:74px;
      height:74px;
      object-fit:contain;
      background:#fff;
      border-radius:14px;
      padding:8px;
      border:1px solid rgba(255,255,255,.22);
    }

    .hero-school{
      margin:0;
      font-weight:950;
      font-size:1.15rem;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .hero-stage{
      margin-top:6px;
      opacity:.95;
      font-weight:850;
      font-size:.95rem;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .hero-type-label{ opacity:.92; font-weight:850; font-size:.9rem }
    .hero-type{
      margin-top:6px;
      font-weight:950;
      font-size:1.15rem;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* ===== Cards ===== */
    .details-grid{
      display:grid;
      grid-template-columns:repeat(2, 1fr);
      gap:12px;
      margin-bottom:16px;
    }
    .info-card--wide{ grid-column:span 2 }
    .info-card{
      padding:12px 14px;
      border:1px solid var(--line);
      border-radius:12px;
      background:var(--bg);
      display:flex;
      flex-direction:column;
      gap:6px;
      break-inside:avoid;
      page-break-inside:avoid;
    }
    .info-card .label{ color:var(--muted); font-size:.85rem; font-weight:900 }
    .info-card .value{ font-weight:950; font-size:1rem }

    .section-header{
      display:flex;
      align-items:center;
      gap:10px;
      margin:18px 0 10px;
      color:var(--brand);
      font-weight:950;
      font-size:1.08rem;
      border-bottom:2px solid #dbeafe;
      padding-bottom:8px;
    }

    .description-box{
      padding:14px;
      border:1px solid var(--line);
      border-radius:12px;
      background:#fff;
      white-space:pre-wrap;
      font-size:1rem;
      color:#0f172a;
      line-height:1.9;
      word-break:break-word;
      margin-bottom:14px;
      break-inside:auto;
      page-break-inside:auto;
    }

    /* ===== Media Block (الصور) ===== */
    .media-block{
      margin-top:12px;
      break-inside:avoid;
      page-break-inside:avoid;
    }
    .media-block--newpage{
      page-break-before:always;
      break-before:page;
    }

    /* ===== Photos ===== */
    .photos-grid{
      display:grid;
      grid-template-columns:repeat(2, 1fr);
      gap:14px;
      margin-top:12px;
    }
    .photo-item{
      border:1px solid var(--line);
      border-radius:12px;
      overflow:hidden;
      background:#fff;
      display:flex;
      flex-direction:column;
      break-inside:avoid;
      page-break-inside:avoid;
    }
    .photo-item img{
      width:100%;
      height:220px;
      object-fit:contain;
      object-position:center;
      background:#fff;
    }
    .photo-caption{
      padding:8px;
      font-size:.85rem;
      text-align:center;
      background:var(--bg);
      border-top:1px solid var(--line);
      color:var(--muted);
      font-weight:900;
    }

    .photos-grid--4{ grid-template-columns:repeat(4, 1fr) }
    .photos-grid--4 .photo-item img{ height:110px }
    .photos-grid--1{ grid-template-columns:1fr }
    .photos-grid--1 .photo-item img{ height:260px }

    /* ===== Print rules ===== */
    @media print{
      @page{ size:A4; margin:10mm; }
      *{ -webkit-print-color-adjust: exact; print-color-adjust: exact; }

      .toolbar{ display:none !important; }
      body{ background:#fff; }

      .report-wrapper{
        padding:0 !important;
        box-shadow:none !important;
        border-radius:0 !important;
      }

      .for-pdf .report-wrapper{
        padding: var(--print-margin) !important;
      }

      .for-screen .hero,
      .for-pdf .hero{
        background: linear-gradient(135deg, rgba(37,99,235,.92), rgba(16,185,129,.78)) !important;
        color:#fff !important;
        border:none !important;
        padding:18px !important;
        margin-bottom:18px !important;
      }

      .ministry-logo{
        width:64px;
        height:64px;
        padding:6px;
        border:1px solid var(--line);
      }

      .hero-school,.hero-type{ font-size:1.05rem; }
      .hero-stage,.hero-type-label{ font-size:.9rem; }

      .for-pdf .details-grid{ gap:9px; margin-bottom:12px; }
      .for-pdf .section-header{ margin:12px 0 8px; }
      .for-pdf .description-box{ padding:10px; margin-bottom:10px; font-size:.95rem; }

      /* تجنب مشاكل Grid في طباعة Chrome -> Flex */
      .photos-grid{
        display:flex;
        flex-wrap:wrap;
        gap:10px;
      }
      .photo-item{ width: calc(50% - 5px); }
      .photo-item img{ height:140px; object-fit:contain; background:#fff; }

      .photos-grid--4 .photo-item{ width: calc(25% - 8px); }
      .photos-grid--4 .photo-item img{ height:95px; }

      .photos-grid--1 .photo-item{ width: 100%; }
      .photos-grid--1 .photo-item img{ height:165px; }

      .photo-caption{ padding:6px 8px; font-size:.76rem; }
      .info-card{ background:#fff; border:1px solid var(--line); }
      .info-card .value{ font-size:.92rem; }
      .section-header{ font-size:1rem; border-bottom-color:var(--line); }
    }

    @media (max-width: 720px){
      .details-grid{ grid-template-columns:1fr; }
      .info-card--wide{ grid-column:auto; }
      .hero{ padding:14px; }
      .ministry-logo{ width:62px; height:62px; }
    }
  </style>
</head>

<body class="{% if for_pdf %}for-pdf{% else %}for-screen{% endif %}">

{% if not for_pdf %}
  <div class="toolbar">
    <a href="{% url 'reports:my_reports' %}" class="btn">
      <i class="fas fa-arrow-right"></i> رجوع
    </a>
    <button class="btn btn-primary" type="button" id="printBtn">
      <i class="fas fa-print"></i> طباعة
    </button>
    <span class="hint">من نافذة الطباعة اختر “Save as PDF” وألغِ “Headers and footers” لنتيجة مطابقة</span>
  </div>
{% endif %}

<div class="report-wrapper">
  <header class="hero">
    <div class="hero-side hero-right">
      <div class="hero-school">
        {% if SCHOOL_NAME %}{{ SCHOOL_NAME }}{% else %}نظام التقارير المدرسية{% endif %}
      </div>
      {% if SCHOOL_STAGE %}
        <div class="hero-stage">{{ SCHOOL_STAGE }}</div>
      {% endif %}
    </div>

    <div class="hero-center">
      <img class="ministry-logo" src="{% static 'img/UntiTtled-1.png' %}" alt="شعار الوزارة" />
    </div>

    <div class="hero-side hero-left">
      <div class="hero-type-label">نوع التقرير</div>
      <div class="hero-type">
        {% if r.category and r.category.name %}{{ r.category.name }}{% else %}عام{% endif %}
      </div>
    </div>
  </header>

  <main class="main-content">

    <div class="details-grid">
      <div class="info-card">
        <span class="label">عنوان التقرير</span>
        <span class="value">{% firstof r.title "—" %}</span>
      </div>

      <div class="info-card">
        <span class="label">التاريخ واليوم</span>
        <span class="value">{{ r.report_date|date:"Y-m-d" }}{% if r.day_name %} - {{ r.day_name }}{% endif %}</span>
      </div>

      <div class="info-card">
        <span class="label">معد التقرير</span>
        <span class="value">{% firstof r.teacher_display_name "—" %}</span>
      </div>

      <div class="info-card">
        <span class="label">عدد المستفيدين</span>
        <span class="value">{{ r.beneficiaries_count|default:"0" }}</span>
      </div>

      {% if r.department %}
        <div class="info-card info-card--wide">
          <span class="label">القسم / الجهة</span>
          <span class="value">{{ r.department.name }}</span>
        </div>
      {% endif %}
    </div>

    <div class="section-header">
      {% if not for_pdf %}<i class="fa-solid fa-file-lines"></i>{% endif %}
      تفاصيل ومحتوى التقرير
    </div>

    {% with idea_text=r.idea|default:"" %}
      {% with idea_len=idea_text|length %}
        <div class="description-box">{{ idea_text|default:"لا يوجد وصف مضاف." }}</div>

        <div class="media-block
          {% if idea_len > 850 %} media-block--newpage{% endif %}
          {% if idea_len > 520 %}
            {% if r.image1 and r.image2 and r.image3 %} media-block--newpage{% endif %}
          {% endif %}
        ">

          {% if r.image1 or r.image2 or r.image3 or r.image4 %}
            <div class="section-header">
              {% if not for_pdf %}<i class="fa-solid fa-images"></i>{% endif %}
              الصور المرفقة
            </div>

            <div class="photos-grid
              {% if r.image1 and r.image2 and r.image3 and r.image4 %} photos-grid--4{% endif %}
              {% if r.image1 and not r.image2 and not r.image3 and not r.image4 %} photos-grid--1{% endif %}
              {% if not r.image1 and r.image2 and not r.image3 and not r.image4 %} photos-grid--1{% endif %}
              {% if not r.image1 and not r.image2 and r.image3 and not r.image4 %} photos-grid--1{% endif %}
              {% if not r.image1 and not r.image2 and not r.image3 and r.image4 %} photos-grid--1{% endif %}
            ">

              {% if r.image1 %}
                <div class="photo-item">
                  <img
                    src="{{ r.image1.url }}"
                    alt="صورة توثيقية 1"
                    {% if not for_pdf %}loading="lazy"{% endif %}
                  />
                  <div class="photo-caption">صورة توثيقية (1)</div>
                </div>
              {% endif %}

              {% if r.image2 %}
                <div class="photo-item">
                  <img
                    src="{{ r.image2.url }}"
                    alt="صورة توثيقية 2"
                    {% if not for_pdf %}loading="lazy"{% endif %}
                  />
                  <div class="photo-caption">صورة توثيقية (2)</div>
                </div>
              {% endif %}

              {% if r.image3 %}
                <div class="photo-item">
                  <img
                    src="{{ r.image3.url }}"
                    alt="صورة توثيقية 3"
                    {% if not for_pdf %}loading="lazy"{% endif %}
                  />
                  <div class="photo-caption">صورة توثيقية (3)</div>
                </div>
              {% endif %}

              {% if r.image4 %}
                <div class="photo-item">
                  <img
                    src="{{ r.image4.url }}"
                    alt="صورة توثيقية 4"
                    {% if not for_pdf %}loading="lazy"{% endif %}
                  />
                  <div class="photo-caption">صورة توثيقية (4)</div>
                </div>
              {% endif %}

            </div>
          {% endif %}

        </div>
      {% endwith %}
    {% endwith %}

  </main>
</div>

{% if not for_pdf %}
  <script nonce="{{ CSP_NONCE }}">
    (function(){
      var btn = document.getElementById('printBtn');
      if(btn) btn.addEventListener('click', function(){ window.print(); });
    })();
  </script>
{% endif %}

</body>
</html>
