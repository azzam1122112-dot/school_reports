{% load static %}
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>تقرير: {% firstof r.title "بدون عنوان" %}</title>
  
  {% if not for_pdf %}
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  {% endif %}

  <style>
    :root {
      --font-body: 'Tajawal', Tahoma, Arial, sans-serif;
      --ink: #111;
      --muted: #444;
      --line: #000;
      --shade: #f3f3f3;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: var(--font-body);
      background: #e5e5e5; /* معاينة فقط */
      color: var(--ink);
      -webkit-font-smoothing: antialiased;
    }

    /* A4 canvas */
    .page {
      width: 210mm;
      min-height: 297mm;
      margin: 18px auto;
      background: #fff;
      padding: 14mm 12mm 18mm;
      position: relative;
      box-shadow: 0 0 14px rgba(0,0,0,0.10);
    }

    @page { size: A4; margin: 14mm 12mm; }
    @media print {
      body { background: #fff; }
      .page {
        width: auto;
        min-height: auto;
        margin: 0;
        padding: 0;
        box-shadow: none;
      }
      .no-print { display: none !important; }
      * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    }

    /* Toolbar (screen only) */
    .toolbar {
      position: sticky;
      top: 0;
      z-index: 100;
      background: #111;
      color: #fff;
      padding: 10px;
      text-align: center;
      display: flex;
      gap: 10px;
      justify-content: center;
      align-items: center;
      font-weight: 800;
    }
    .btn {
      background: #fff;
      color: #111;
      border: 1px solid rgba(0,0,0,0.15);
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-family: inherit;
      font-weight: 900;
      text-decoration: none;
      font-size: 14px;
    }
    .btn-print { background: #2563eb; color: #fff; border-color: #2563eb; }

    /* Official header */
    .header {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 10px;
      align-items: start;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--line);
    }
    .hdr-block {
      font-size: 13px;
      line-height: 1.7;
      font-weight: 800;
    }
    .hdr-center { text-align: center; }
    .hdr-right { text-align: right; }
    .hdr-left { text-align: left; direction: ltr; }
    .logo {
      height: 78px;
      width: auto;
      object-fit: contain;
      display: block;
      margin: 0 auto;
    }
    .logo-box {
      height: 78px;
      width: 120px;
      border: 1px solid var(--line);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto;
      font-weight: 900;
      color: var(--muted);
      font-size: 12px;
    }

    .title {
      text-align: center;
      margin: 14px 0 10px;
      font-weight: 1000;
      font-size: 20px;
      letter-spacing: 0;
    }
    .subtitle {
      text-align: center;
      margin: 0 0 14px;
      color: var(--muted);
      font-weight: 800;
      font-size: 13px;
    }

    .meta-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      margin: 0 0 14px;
    }
    .meta-table th, .meta-table td {
      border: 1px solid var(--line);
      padding: 9px 10px;
      vertical-align: middle;
    }
    .meta-table th {
      background: var(--shade);
      font-weight: 900;
      width: 22%;
      white-space: nowrap;
      text-align: right;
    }
    .meta-table td { text-align: right; }

    .section {
      border: 1px solid var(--line);
      padding: 10px;
      margin: 0 0 14px;
    }
    .section-h {
      font-weight: 1000;
      font-size: 15px;
      margin: 0 0 8px;
    }
    .section-body {
      font-size: 15px;
      line-height: 2;
      white-space: pre-wrap;
      text-align: justify;
      min-height: 90px;
    }

    .images-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }
    .img-box {
      border: 1px solid var(--line);
      padding: 6px;
      text-align: center;
      page-break-inside: avoid;
    }
    .img-box img {
      width: 100%;
      height: 180px;
      object-fit: contain;
      display: block;
    }
    .img-cap {
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
    }

    .signatures {
      border: 1px solid var(--line);
      padding: 8px;
      display: grid;
      gap: 8px;
      margin: 12px 0 0;
      page-break-inside: avoid;
    }
    .signatures.two-sigs {
      grid-template-columns: 1fr 1fr;
    }
    .signatures.one-sig {
      grid-template-columns: 1fr;
      max-width: 45%;
      margin-right: auto;
    }
    .sig {
      border: 1px solid var(--line);
      padding: 8px;
      min-height: 70px;
      display: flex;
      flex-direction: column;
    }
    .sig h4 {
      margin: 0 0 6px;
      font-size: 13px;
      font-weight: 1000;
      text-align: center;
    }
    .sig .sig-space {
      flex: 1;
      min-height: 30px;
    }
    .sig .sig-line {
      margin-top: auto;
      border-top: 1px solid var(--line);
      padding-top: 5px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
      text-align: center;
    }
    .sig-label {
      display: inline;
      font-size: 11px;
      color: var(--muted);
      margin-left: 4px;
    }

    .footer {
      margin-top: 12px;
      border-top: 1px solid var(--line);
      padding-top: 8px;
      font-size: 11px;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }
  </style>
</head>
<body>

  <!-- Screen Toolbar -->
  <div class="toolbar no-print">
    <span>معاينة الطباعة (A4)</span>
    <button onclick="window.print()" class="btn btn-print">
      <i class="fas fa-print"></i> طباعة / حفظ كـ 
    </button>
    <button onclick="goBack()" class="btn">
      <i class="fas fa-arrow-right"></i> عودة
    </button>
  </div>

  <div class="page">
    <header class="header">
      <div class="hdr-block hdr-right">
        <div>المملكة العربية السعودية</div>
        <div>وزارة التعليم</div>
        <div>{% firstof SCHOOL_NAME "المدرسة" %}</div>
       </div>

      <div class="hdr-center">
        <img
          src="{% if MOE_LOGO_URL %}{{ MOE_LOGO_URL }}{% else %}{% static 'img/UntiTtled-1.png' %}{% endif %}"
          alt="شعار وزارة التعليم"
          class="logo"
        />
      </div>

      <div class="hdr-block hdr-left">
        <div>التاريخ: {{ r.report_date|date:"Y/m/d" }}</div>
        {% if r.day_name %}<div>اليوم: {{ r.day_name }}</div>{% endif %}
        <div>رقم التقرير: {{ r.id }}</div>
      </div>
    </header>

    <div class="title">تقرير تنفيذ برنامج / نشاط</div>
    <div class="subtitle">عنوان البرنامج: {% firstof r.title "—" %}</div>

    <table class="meta-table">
      <tr>
        <th>التصنيف</th>
        <td>{% if r.category %}{{ r.category.name }}{% else %}عام{% endif %}</td>
        <th>تاريخ التنفيذ</th>
        <td>{{ r.report_date|date:"Y/m/d" }}</td>
      </tr>
      <tr>
        <th>عدد المستفيدين</th>
        <td>{% if r.beneficiaries_count %}{{ r.beneficiaries_count }}{% else %}—{% endif %}</td>
        <th>رقم التقرير</th>
        <td>{{ r.id }}</td>
      </tr>
    </table>

    <section class="section">
      <div class="section-h">أولاً: وصف النشاط / البرنامج</div>
      <div class="section-body">{{ r.idea|default:"—" }}</div>
    </section>
    
    {% if r.image1 or r.image2 or r.image3 or r.image4 %}
    <section class="section" style="border:1px solid var(--line);">
      <div class="section-h">ثانياً: المرفقات والشواهد</div>
      <div class="images-grid">
        {% if r.image1 %}
        <div class="img-box">
           <img src="{{ r.image1.url }}" alt="مرفق 1">
           <div class="img-cap">مرفق (1)</div>
        </div>
        {% endif %}
        
        {% if r.image2 %}
        <div class="img-box">
           <img src="{{ r.image2.url }}" alt="مرفق 2">
           <div class="img-cap">مرفق (2)</div>
        </div>
        {% endif %}
        
        {% if r.image3 %}
        <div class="img-box">
           <img src="{{ r.image3.url }}" alt="مرفق 3">
           <div class="img-cap">مرفق (3)</div>
        </div>
        {% endif %}
        
        {% if r.image4 %}
        <div class="img-box">
           <img src="{{ r.image4.url }}" alt="مرفق 4">
           <div class="img-cap">مرفق (4)</div>
        </div>
        {% endif %}
      </div>
    </section>
    {% endif %}

    {% comment %}
    ============================================
    قسم التوقيعات
    - إذا كان التقرير مرتبط بقسم: عرض توقيعين (رئيس القسم + مدير المدرسة)
    - إذا لم يكن مرتبط بقسم: عرض توقيع واحد (مدير المدرسة فقط)
    ============================================
    {% endcomment %}
    {% if head_decision and not head_decision.no_render %}
      {# التقرير مرتبط بقسم → توقيعان #}
      <div class="signatures two-sigs">
        <div class="sig">
          <h4>رئيس القسم</h4>
          <div class="sig-space"></div>
          <div class="sig-line">
            <span class="sig-label">الاسم:</span>
            {% if head_decision.single %}
              {{ head_decision.name }}
            {% elif head_decision.multi_dept %}
              {{ head_decision.dept_name }}
            {% else %}
              ........................
            {% endif %}
          </div>
        </div>

        <div class="sig">
          <h4>مدير المدرسة</h4>
          <div class="sig-space"></div>
          <div class="sig-line">
            <span class="sig-label">الاسم:</span>
            {% if SCHOOL_PRINCIPAL %}{{ SCHOOL_PRINCIPAL }}{% else %}........................{% endif %}
          </div>
        </div>
      </div>
    {% else %}
      {# التقرير غير مرتبط بقسم → توقيع واحد فقط (مدير المدرسة) #}
      <div class="signatures one-sig">
        <div class="sig">
          <h4>مدير المدرسة</h4>
          <div class="sig-space"></div>
          <div class="sig-line">
            <span class="sig-label">الاسم:</span>
            {% if SCHOOL_PRINCIPAL %}{{ SCHOOL_PRINCIPAL }}{% else %}........................{% endif %}
          </div>
        </div>
      </div>
    {% endif %}

    {% if show_comments %}
      <section class="section no-print" style="border:1px solid var(--line);">
        <div class="section-h">ملاحظات وتعليقات خاصة</div>

        <div style="color:var(--muted);font-weight:800;margin:-2px 0 10px;">
          لا تظهر في الطباعة أو المشاركة.
        </div>

        {% if private_comments %}
          <div style="display:flex;flex-direction:column;gap:10px;">
            {% for c in private_comments %}
              <div style="border:1px solid var(--line);padding:10px 12px;background:#fff;">
                <div style="font-weight:900;margin-bottom:6px;">
                  {{ c.created_by.name|default:"" }}{% if c.created_by_role_label %} ({{ c.created_by_role_label }}){% endif %}
                  <span style="font-weight:700;color:var(--muted);">— {{ c.created_at|date:"Y/m/d H:i" }}</span>
                </div>
                <div style="white-space:pre-line;">{{ c.body }}</div>

                {% if can_add_private_comment and current_user_id %}
                  <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;align-items:flex-start;">
                    {% if c.created_by_id == current_user_id %}
                      <details>
                        <summary class="btn" style="cursor:pointer;">تعديل</summary>
                        <form method="post" style="margin-top:10px;min-width:240px;">
                          {% csrf_token %}
                          <input type="hidden" name="action" value="private_comment_update" />
                          <input type="hidden" name="comment_id" value="{{ c.id }}" />
                          <textarea name="body" rows="3" style="width:100%;border:1px solid var(--line);padding:8px 10px;">{{ c.body }}</textarea>
                          <div style="margin-top:8px;">
                            <button type="submit" class="btn btn-print">حفظ</button>
                          </div>
                        </form>
                      </details>
                    {% endif %}

                    {% if c.created_by_id == current_user_id or is_superuser %}
                      <form method="post" onsubmit="return confirm('حذف التعليق نهائيًا؟');" style="display:inline;">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="private_comment_delete" />
                        <input type="hidden" name="comment_id" value="{{ c.id }}" />
                        <button type="submit" class="btn" style="border-color:#b91c1c;color:#b91c1c;">حذف</button>
                      </form>
                    {% endif %}
                  </div>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div style="color:var(--muted);font-weight:800;">لا توجد ملاحظات خاصة على هذا التقرير.</div>
        {% endif %}

        {% if can_add_private_comment and comment_form %}
          <form method="post" style="margin-top:12px;">
            {% csrf_token %}
            <input type="hidden" name="action" value="private_comment_create" />
            <div style="font-weight:900;margin-bottom:6px;">إضافة تعليق خاص للمعلم</div>
            <div>{{ comment_form.body }}</div>
            {% if comment_form.body.errors %}
              <div style="color:#b91c1c;font-weight:900;margin-top:6px;">{{ comment_form.body.errors.0 }}</div>
            {% endif %}
            <div style="margin-top:10px;">
              <button type="submit" class="btn btn-print">حفظ التعليق</button>
            </div>
          </form>
        {% endif %}
      </section>
    {% endif %}

    <div class="footer">
      <div>تم إصدار التقرير إلكترونيًا — {% now "Y/m/d H:i" %}</div>
      <div>منصة توثيق التقارير المدرسية</div>
    </div>

  </div>

  <script nonce="{{ CSP_NONCE }}">
    function goBack() {
      // Prefer an explicit next= (works even when opened in a new tab)
      try {
        var params = new URLSearchParams(window.location.search || '');
        var next = (params.get('next') || '').trim();
        if (next) {
          var nextUrl = new URL(next, window.location.origin);
          if (nextUrl.origin === window.location.origin) {
            window.location.href = nextUrl.href;
            return;
          }
        }
      } catch (e) {}

      // Smart back URL based on user role
      {% if back_url %}
      window.location.href = "{% url back_url %}";
      {% else %}
      window.location.href = "{% url 'reports:my_reports' %}";
      {% endif %}
    }

    // Auto print if ?print=true (optional)
    if(window.location.search.includes('print=true')){
      window.print();
    }
  </script>
</body>
</html>
