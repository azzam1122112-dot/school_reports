{% extends "base.html" %}
{% block title %}مدراء المدارس{% endblock %}

{% block content %}
<div class="container" dir="rtl">
  <div class="page-head" style="max-width:980px;margin-inline:auto">
    <div>
      <h1 class="page-title">مدراء المدارس</h1>
      <p class="page-subtitle">قائمة بجميع مدراء المدارس والمدارس المرتبطة بكل مدير.</p>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <a class="btn btn-primary" href="{% url 'reports:school_manager_create' %}">+ إنشاء مدير مدرسة جديد</a>
      <a class="btn btn-outline" href="{% url 'reports:schools_admin_list' %}">إدارة المدارس</a>
    </div>
  </div>

  <div style="max-width:980px;margin-inline:auto">
    <div class="card">
      <div class="section-title">قائمة المدراء</div>

      {% if managers %}
      <div style="display:flex;gap:10px;align-items:end;flex-wrap:wrap;margin-top:10px">
        <div style="flex:1 1 320px;min-width:240px">
          <label class="muted" for="managerSearch" style="display:block;font-weight:900;margin-bottom:6px">بحث</label>
          <input id="managerSearch" class="input" type="search" placeholder="ابحث باسم المدير / الجوال / اسم المدرسة…" autocomplete="off" spellcheck="false">
        </div>
        <div class="muted" style="font-weight:900;white-space:nowrap">
          <span id="managerCount">{{ managers|length }}</span>
          مدير
        </div>
      </div>
      <div id="managerNoResults" class="card" style="display:none;margin-top:12px;padding:14px;text-align:center">
        <span class="muted" style="font-weight:900">لا توجد نتائج مطابقة.</span>
      </div>
      {% endif %}

      {% if managers %}
      <div class="table-responsive">
        <table class="rtable">
          <thead>
            <tr>
              <th>المدير</th>
              <th>رقم الجوال</th>
              <th>الحالة</th>
              <th>المدارس المرتبطة</th>
              <th>إجراءات</th>
            </tr>
          </thead>
          <tbody>
            {% for item in managers %}
              {% with m=item.manager schools=item.schools %}
              <tr data-search="{{ m.name|lower }} {{ m.phone|lower }}{% for s in schools %} {{ s.name|lower }} {{ s.code|lower }}{% endfor %}">
                <td data-label="المدير"><b>{{ m.name }}</b></td>
                <td data-label="رقم الجوال">{{ m.phone }}</td>
                <td data-label="الحالة">
                  {% if m.is_active %}
                    <span class="badge success">نشط</span>
                  {% else %}
                    <span class="badge danger">موقوف</span>
                  {% endif %}
                </td>
                <td data-label="المدارس المرتبطة">
                  {% if schools %}
                    {% for s in schools %}
                      {{ s.name }}{% if not forloop.last %}، {% endif %}
                    {% endfor %}
                  {% else %}
                    <span class="muted" style="font-weight:900">لا توجد مدارس مرتبطة</span>
                  {% endif %}
                </td>
                <td data-label="إجراءات">
                  <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-start">
                    <a class="btn btn-outline" href="{% url 'reports:school_manager_update' m.id %}" style="padding:8px 10px">تعديل المدير</a>
                    <a class="btn btn-outline" href="{% url 'reports:manage_teachers' %}" style="padding:8px 10px">قائمة المعلّمين</a>
                    <form method="post" action="{% url 'reports:school_manager_delete' m.id %}" style="display:inline" onsubmit="return confirm('هل أنت متأكد من حذف هذا المدير؟ سيتم إيقاف حسابه وإلغاء صلاحياته.');">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-danger" style="padding:8px 10px">حذف المدير</button>
                    </form>
                  </div>
                </td>
              </tr>
              {% endwith %}
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
        <div class="muted" style="font-weight:900">لا يوجد أي مدير مدرسة بعد.</div>
      {% endif %}
    </div>
  </div>
</div>

<script>
  (function(){
    const input = document.getElementById('managerSearch');
    const rows = Array.from(document.querySelectorAll('table.rtable tbody tr'));
    const count = document.getElementById('managerCount');
    const empty = document.getElementById('managerNoResults');

    function applyFilter(){
      if(!input) return;
      const q = (input.value || '').trim().toLowerCase();
      let visible = 0;
      rows.forEach((row)=>{
        const hay = (row.getAttribute('data-search') || '').toLowerCase();
        const ok = !q || hay.includes(q);
        row.style.display = ok ? '' : 'none';
        if(ok) visible += 1;
      });
      if(count) count.textContent = String(visible);
      if(empty) empty.style.display = visible === 0 ? 'block' : 'none';
    }

    if(input){
      input.addEventListener('input', applyFilter);
      applyFilter();
    }
  })();
</script>
{% endblock %}
