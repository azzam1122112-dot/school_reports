{% extends "base.html" %}
{% load static %}

{% block title %}Ø§Ø´ØªØ±Ø§ÙƒÙŠ{% endblock %}

{% block head %}
<style>
  :root {
    --ink:#0f172a; --ink-soft:#1f2937; --muted:#6b7280; --line:#e5e7eb;
    --card:#ffffff; --bg:#f8fafc; --brand:#2563eb; --accent:#10b981; --danger:#ef4444;
    --shadow:0 10px 26px rgba(2,6,23,.08);
    --radius:14px;
  }

  .wrap { max-width:1100px; margin:auto; padding:18px; }
  .grid { display:grid; gap:20px; }
  @media(min-width:900px){ .grid{ grid-template-columns:1fr 1fr; } }

  .card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:var(--radius);
    padding:24px;
    box-shadow:var(--shadow);
  }
  .title{ font-weight:900; margin:0 0 16px 0; color:var(--ink-soft); font-size:1.25rem; }

  .stat-box{
    background:#f8fafc;
    border-radius:12px;
    padding:16px;
    text-align:center;
    border:1px solid var(--line);
  }
  .stat-val{ font-size:1.8rem; font-weight:900; color:var(--brand); }
  .stat-lbl{ font-size:.9rem; color:var(--muted); font-weight:700; margin-top:4px; }

  .status-badge{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    padding:6px 12px;
    border-radius:999px;
    font-weight:900;
    font-size:.85rem;
    gap:6px;
  }
  .st-active{ background:#dcfce7; color:#166534; }
  .st-expired{ background:#fee2e2; color:#991b1b; }
  .st-pending{ background:#fef3c7; color:#92400e; }

  .form-group{ margin-bottom:16px; }
  .label{ display:block; font-weight:900; margin-bottom:8px; color:var(--ink); }
  .input,.select,.textarea{
    width:100%;
    padding:12px;
    border:1px solid var(--line);
    border-radius:10px;
    font:inherit;
    background:#fff;
  }
  .help{ font-size:.85rem; color:var(--muted); margin-top:6px; font-weight:700; }

  .table-wrap{ overflow-x:auto; }
  table{ width:100%; border-collapse:collapse; min-width:600px; }
  th{
    text-align:right;
    padding:12px;
    border-bottom:2px solid var(--line);
    color:var(--muted);
    font-size:.9rem;
    font-weight:900;
    white-space:nowrap;
  }
  td{
    padding:12px;
    border-bottom:1px solid var(--line);
    color:var(--ink);
    vertical-align:top;
  }

  .btn{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    padding:12px 20px;
    border-radius:10px;
    font-weight:900;
    text-decoration:none;
    cursor:pointer;
    border:1px solid var(--line);
    transition:all .18s ease;
    gap:8px;
  }
  .btn:hover{ transform:translateY(-1px); }
  .btn-primary{
    background:var(--brand);
    color:#fff;
    width:100%;
    border-color:var(--brand);
  }
  .btn-primary:hover{ filter:brightness(.95); }
  .btn-outline{ background:#fff; color:var(--ink); }

  /* Receipt preview */
  .preview{
    display:none;
    margin-top:10px;
    border:1px solid var(--line);
    border-radius:12px;
    overflow:hidden;
    background:#fff;
  }
  .preview img{
    width:100%;
    max-height:280px;
    object-fit:contain;
    display:block;
    background:#0b1220;
  }
  .preview .meta{
    padding:10px 12px;
    color:var(--muted);
    font-weight:800;
    font-size:.9rem;
    background:#f8fafc;
    border-top:1px solid var(--line);
  }
</style>
{% endblock %}

{% block content %}
<div class="wrap" dir="rtl">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;gap:12px;flex-wrap:wrap">
    <div>
      <h1 style="font-size:1.8rem;font-weight:900;margin:0;color:var(--ink)">Ø¥Ø¯Ø§Ø±Ø© Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</h1>
      <div style="color:var(--muted);font-weight:800;margin-top:4px">{{ school.name }}</div>
    </div>
    <a href="{% url 'reports:admin_dashboard' %}" class="btn btn-outline">Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
  </div>

  <div class="grid">
    <!-- Status Card -->
    <div class="card">
      <h2 class="title">Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ</h2>

      {% if subscription %}
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;background:#eff6ff;padding:16px;border-radius:12px;border:1px solid #dbeafe">
          <div style="font-size:24px">ğŸ’</div>
          <div>
            <div style="font-weight:900;color:#1e40af">Ø§Ù„Ø¨Ø§Ù‚Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: {{ subscription.plan.name }}</div>
            <div style="font-size:.9rem;color:#1e3a8a;font-weight:800">
              ÙŠÙ†ØªÙ‡ÙŠ ÙÙŠ: <span dir="ltr">{{ subscription.end_date|date:"Y-m-d" }}</span>
            </div>
          </div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px">
          <div class="stat-box">
            <div class="stat-val">
              {% if subscription.days_remaining > 0 %}{{ subscription.days_remaining }}{% else %}0{% endif %}
            </div>
            <div class="stat-lbl">Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</div>
          </div>

          <div class="stat-box">
            <div class="stat-val" style="font-size:1.1rem;display:flex;align-items:center;justify-content:center;height:100%">
              {% if subscription.is_expired %}
                <span class="status-badge st-expired">â›” Ù…Ù†ØªÙ‡ÙŠ</span>
              {% else %}
                <span class="status-badge st-active">âœ… Ù†Ø´Ø·</span>
              {% endif %}
            </div>
            <div class="stat-lbl">Ø§Ù„Ø­Ø§Ù„Ø©</div>
          </div>
        </div>

        <div style="text-align:center;margin-top:20px;padding-top:20px;border-top:1px solid var(--line)">
          <a href="{% url 'reports:support_ticket_create' %}" style="color:var(--brand);font-weight:900;text-decoration:none">
            Ù‡Ù„ ØªÙˆØ§Ø¬Ù‡ Ù…Ø´ÙƒÙ„Ø©ØŸ ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ
          </a>
        </div>
      {% else %}
        <div style="text-align:center;padding:40px 0;color:var(--muted);font-weight:900">
          <div style="font-size:40px;margin-bottom:10px">ğŸš«</div>
          <h3 style="margin:0;color:var(--ink);font-weight:900">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§Ø´ØªØ±Ø§Ùƒ Ù†Ø´Ø·</h3>
          <p style="margin:10px 0 0;font-weight:800">ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø¨Ø§Ù‚Ø© ÙˆØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ.</p>
        </div>
      {% endif %}
    </div>

    <!-- Renewal Form -->
    <div class="card">
      <h2 class="title">ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ / Ø±ÙØ¹ Ø¥ÙŠØµØ§Ù„</h2>

      <form action="{% url 'reports:payment_create' %}" method="POST" enctype="multipart/form-data" id="renewForm" novalidate>
        {% csrf_token %}

        <div class="form-group">
          <label class="label" for="plan_select">Ø§Ø®ØªØ± Ø§Ù„Ø¨Ø§Ù‚Ø©</label>
          <select id="plan_select" class="select" name="plan" required>
            <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø¨Ø§Ù‚Ø© --</option>
            {% for plan in plans %}
              <option value="{{ plan.pk }}" data-price="{{ plan.price }}">
                {{ plan.name }} - {{ plan.price }} Ø±ÙŠØ§Ù„
              </option>
            {% endfor %}
          </select>
          <div class="help">Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù…Ø¨Ù„Øº ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø­Ø³Ø¨ Ø§Ù„Ø¨Ø§Ù‚Ø© (ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„Ù‡ Ø¥Ø°Ø§ Ù„Ø²Ù…).</div>
        </div>

        <div class="form-group">
          <label class="label" for="amount">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø­ÙˆÙ„ (Ø±ÙŠØ§Ù„)</label>
          <input type="number" name="amount" id="amount" required step="0.01" min="0" class="input" placeholder="0.00" inputmode="decimal">
        </div>

        <div class="form-group">
          <label class="label" for="receipt_image">ØµÙˆØ±Ø© Ø§Ù„Ø¥ÙŠØµØ§Ù„</label>
          <input type="file" name="receipt_image" id="receipt_image" class="input" required accept="image/*">
          <div class="help">ÙŠØ±Ø¬Ù‰ Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø© ÙˆØ§Ø¶Ø­Ø© Ù„Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨Ù†ÙƒÙŠ (ÙŠÙØ¶Ù‘Ù„ JPG/PNG) â€” Ø­Ø¯ Ø£Ù‚ØµÙ‰ 10MB.</div>

          <div class="preview" id="receiptPreview" aria-live="polite">
            <img id="receiptImg" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¥ÙŠØµØ§Ù„">
            <div class="meta" id="receiptMeta">â€”</div>
          </div>
        </div>

        <div class="form-group">
          <label class="label" for="notes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</label>
          <textarea name="notes" id="notes" rows="2" class="textarea" placeholder="Ù…Ø«Ø§Ù„: Ø±Ù‚Ù… Ø§Ù„Ø­ÙˆØ§Ù„Ø© Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ù…Ø­ÙˆÙ„..."></textarea>
        </div>

        <button type="submit" class="btn btn-primary" id="submitBtn">Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªØ¬Ø¯ÙŠØ¯</button>
      </form>
    </div>
  </div>

  <!-- Payments History -->
  <div class="card" style="margin-top:24px">
    <h2 class="title">Ø¢Ø®Ø± Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¯ÙØ¹</h2>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
          </tr>
        </thead>
        <tbody>
          {% for payment in payments %}
          <tr>
            <td><span dir="ltr">{{ payment.created_at|date:"Y-m-d" }}</span></td>
            <td style="font-weight:900">{{ payment.amount }} Ø±ÙŠØ§Ù„</td>
            <td>
              {% if payment.status == 'approved' %}
                <span class="status-badge st-active">âœ… Ù…Ù‚Ø¨ÙˆÙ„</span>
              {% elif payment.status == 'rejected' %}
                <span class="status-badge st-expired">â›” Ù…Ø±ÙÙˆØ¶</span>
              {% else %}
                <span class="status-badge st-pending">â³ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</span>
              {% endif %}
            </td>
            <td style="color:var(--muted);font-weight:800">{{ payment.notes|default:"-" }}</td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="4" style="text-align:center;padding:30px;color:var(--muted);font-weight:900">
              Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø¯ÙØ¹ Ø³Ø§Ø¨Ù‚Ø©
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const planSelect = document.getElementById('plan_select');
  const amountEl   = document.getElementById('amount');
  const fileEl     = document.getElementById('receipt_image');

  const prevBox  = document.getElementById('receiptPreview');
  const prevImg  = document.getElementById('receiptImg');
  const prevMeta = document.getElementById('receiptMeta');

  const form     = document.getElementById('renewForm');
  const submitBtn= document.getElementById('submitBtn');

  const MAX_MB = 10;
  const MAX_BYTES = MAX_MB * 1024 * 1024;

  // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù…Ø¨Ù„Øº Ø­Ø³Ø¨ Ø§Ù„Ø¨Ø§Ù‚Ø©
  if(planSelect && amountEl){
    planSelect.addEventListener('change', function(){
      const opt = planSelect.options[planSelect.selectedIndex];
      const price = opt ? opt.getAttribute('data-price') : '';
      if(price){ amountEl.value = price; }
    });
  }

  // Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¥ÙŠØµØ§Ù„ + ØªØ­Ù‚Ù‚ Ø¨Ø³ÙŠØ· (Ø¹Ù„Ù‰ Ø§Ù„Ù…ØªØµÙØ­ ÙÙ‚Ø·)
  if(fileEl){
    fileEl.addEventListener('change', function(){
      const f = fileEl.files && fileEl.files[0] ? fileEl.files[0] : null;
      if(!f){
        prevBox.style.display = 'none';
        prevImg.removeAttribute('src');
        prevMeta.textContent = 'â€”';
        return;
      }

      const isImage = f.type && f.type.startsWith('image/');
      if(!isImage){
        alert('Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±ÙÙ‚ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† ØµÙˆØ±Ø©.');
        fileEl.value = '';
        prevBox.style.display = 'none';
        return;
      }

      if(f.size > MAX_BYTES){
        alert('Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ±. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ ' + MAX_MB + 'MB.');
        fileEl.value = '';
        prevBox.style.display = 'none';
        return;
      }

      const url = URL.createObjectURL(f);
      prevImg.src = url;
      prevMeta.textContent = f.name + ' â€” ' + Math.round(f.size / 1024) + 'KB';
      prevBox.style.display = 'block';
    });
  }

  // Ù…Ù†Ø¹ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬
  if(form && submitBtn){
    form.addEventListener('submit', function(){
      submitBtn.disabled = true;
      submitBtn.style.opacity = '0.8';
      submitBtn.textContent = 'Ø¬Ø§Ø±Ù Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';
    });
  }
});
</script>
{% endblock %}
