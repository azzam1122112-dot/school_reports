{# reports/templates/reports/my_subscription.html #}
{% extends "base.html" %}
{% load static %}

{% block title %}Ø§Ø´ØªØ±Ø§ÙƒÙŠ{% endblock %}

    background: var(--card);
  }
  .rprev img{
    width:100%;
    max-height: 280px;
    object-fit: contain;
    display:block;
    background: #0b1220;
  }
  .rprev .meta{
    padding: 10px 12px;
    background: var(--line-2);
    border-top: 1px solid var(--line);
    color: var(--muted);
    font-weight: 850;
    font-size: .92rem;
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
    justify-content:space-between;
  }

  /* Table */
  .twrap{ overflow-x:auto; }
  .tbl{
    width:100%;
    border-collapse:collapse;
    min-width: 680px;
  }
  .tbl th{
    text-align:right;
    padding: 12px;
    border-bottom: 2px solid var(--line);
    color: var(--muted);
    font-weight: 950;
    font-size: .92rem;
    white-space: nowrap;
  }
  .tbl td{
    padding: 12px;
    border-bottom: 1px solid var(--line);
    color: var(--ink);
    vertical-align: top;
  }

  /* Mobile table -> cards */
  @media(max-width: 720px){
    .twrap{ overflow: visible; }
    .tbl{ min-width: 0; border-collapse: separate; border-spacing: 0 10px; }
    .tbl thead{ display:none; }
    .tbl tr{
      display:block;
      border: 1px solid var(--line);
      border-radius: 16px;
      background: linear-gradient(180deg, var(--line-2), var(--card));
      overflow:hidden;
    }
    html[data-theme="dark"] .tbl tr{
      background: rgba(20,35,73,.35);
      border-color: #1b2744;
    }
    .tbl td{
      display:flex;
      justify-content:space-between;
      gap:12px;
      border-bottom: 1px solid var(--line);
      padding: 10px 12px;
    }
    .tbl td:last-child{ border-bottom:none; }
    .tbl td::before{
      content: attr(data-label);
      color: var(--muted);
      font-weight: 950;
      white-space: nowrap;
    }
  }

  /* Empty state */
  .empty{
    padding: 18px;
    border-radius: 16px;
    border: 1px dashed var(--line);
    background: linear-gradient(180deg, var(--card), var(--line-2));
    color: var(--muted);
    font-weight: 900;
    text-align:center;
  }
  .empty .ico{ font-size: 40px; margin-bottom: 8px; }

  @media (prefers-reduced-motion: reduce){
    .sub-wrap *{ transition:none !important; }
  }
</style>
{% endblock %}

{% block content %}
<div class="sub-wrap" dir="rtl">

  <!-- Header -->
  <div class="sub-header">
    <div class="sub-top">
      <div>
        <h1 class="sub-h1">Ø¥Ø¯Ø§Ø±Ø© Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</h1>
        <div class="sub-school">{{ school.name }}</div>
        <div class="sub-sub">Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ù…ØªØ§Ø¨Ø¹Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙˆØ±ÙØ¹ Ø¥Ø«Ø¨Ø§Øª Ø§Ù„Ø¯ÙØ¹ Ù„ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø¨Ø§Ù‚Ø©.</div>
      </div>

      <a href="{% url 'reports:admin_dashboard' %}" class="btn btn-ghost">
        <i class="fa-solid fa-arrow-right"></i> Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
      </a>
    </div>
  </div>

  <div class="sub-grid">

    <!-- Status Card -->
    <div class="card sub-card">
      <div class="sub-body">
        <h2 class="sub-title"><i class="fa-solid fa-gem" style="opacity:.85"></i> Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ</h2>

        {% if subscription %}
          <div class="plan-hero">
            <div class="icon">ğŸ’</div>
            <div style="flex:1">
              <div class="name">Ø§Ù„Ø¨Ø§Ù‚Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: {{ subscription.plan.name }}</div>
              <div class="meta">
                ÙŠÙ†ØªÙ‡ÙŠ ÙÙŠ: <span dir="ltr">{{ subscription.end_date|date:"Y-m-d" }}</span>
              </div>
            </div>
            <div>
              {% if subscription.is_expired %}
                <span class="sbadge sb-expired">â›” Ù…Ù†ØªÙ‡ÙŠ</span>
              {% else %}
                <span class="sbadge sb-active">âœ… Ù†Ø´Ø·</span>
              {% endif %}
            </div>
          </div>

          <div class="stats">
            <div class="stat">
              <div class="v">
                {% if subscription.days_remaining > 0 %}{{ subscription.days_remaining }}{% else %}0{% endif %}
              </div>
              <div class="l">Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</div>
            </div>

            <div class="stat">
              <div class="v" style="font-size:1.05rem">
                {% if subscription.updated_at %}
                  <span dir="ltr">{{ subscription.updated_at|date:"Y-m-d H:i" }}</span>
                {% else %}
                  â€”
                {% endif %}
              </div>
              <div class="l">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«</div>
            </div>
          </div>

          <div class="sub-divider"></div>

          <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between">
            <div class="note-dim">Ù‡Ù„ ØªØ­ØªØ§Ø¬ Ù…Ø³Ø§Ø¹Ø¯Ø©ØŸ</div>
            <a href="{% url 'reports:support_ticket_create' %}" class="btn btn-ghost">
              <i class="fa-solid fa-headset"></i> ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ
            </a>
          </div>

        {% else %}
          <div class="empty">
            <div class="ico">ğŸš«</div>
            <div style="color:var(--ink); font-weight:950; font-size:1.05rem; margin-bottom:4px;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§Ø´ØªØ±Ø§Ùƒ Ù†Ø´Ø·</div>
            <div style="font-weight:850">ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø¨Ø§Ù‚Ø© ÙˆØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ.</div>
          </div>
        {% endif %}
      </div>
    </div>

    <!-- Renewal Form -->
    <div class="card sub-card">
      <div class="sub-body">
        <h2 class="sub-title"><i class="fa-solid fa-receipt" style="opacity:.85"></i> ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø£Ùˆ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø¨Ø§Ù‚Ø© Ø£Ø®Ø±Ù‰</h2>

        <details class="bank-details" open>
          <summary>
            <span class="sum-left">
              <i class="fa-solid fa-building-columns" style="opacity:.85"></i>
              Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨Ù†ÙƒÙŠ
              <span class="sum-pill">Ù…ØµØ±Ù Ø§Ù„Ø±Ø§Ø¬Ø­ÙŠ</span>
            </span>
            <span class="note-dim">Ø§Ø¶ØºØ· Ù„Ù„Ø·ÙŠ/Ø§Ù„ÙØªØ­</span>
          </summary>

          <div class="bank-content" aria-label="Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨Ù†ÙƒÙŠ">
            <div class="bank-grid">
              <div class="bank-item">
                <div>
                  <div class="bank-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙÙŠØ¯</div>
                  <div class="bank-value">Ù…Ù†ØµÙˆØ± Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø­Ø§Ù…Ø¯ Ø§Ù„ØºØ§Ù…Ø¯ÙŠ Ø¨Ø±Ù…Ø¬Ø© Ùˆ ØªØ·ÙˆÙŠØ±</div>
                </div>
                <button type="button" class="btn btn-ghost copy-btn" data-copy="Ù…Ù†ØµÙˆØ± Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø­Ø§Ù…Ø¯ Ø§Ù„ØºØ§Ù…Ø¯ÙŠ Ø¨Ø±Ù…Ø¬Ø© Ùˆ ØªØ·ÙˆÙŠØ±">
                  <i class="fa-regular fa-copy"></i> <span class="txt">Ù†Ø³Ø®</span>
                </button>
              </div>

              <div class="bank-item">
                <div>
                  <div class="bank-label">Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨</div>
                  <div class="bank-value bank-mono" dir="ltr">660000010006086220957</div>
                </div>
                <button type="button" class="btn btn-ghost copy-btn" data-copy="660000010006086220957">
                  <i class="fa-regular fa-copy"></i> <span class="txt">Ù†Ø³Ø®</span>
                </button>
              </div>

              <div class="bank-item">
                <div>
                  <div class="bank-label">Ø§Ù„Ø¢ÙŠØ¨Ø§Ù†</div>
                  <div class="bank-value bank-mono" dir="ltr">SA8580000660608016220957</div>
                </div>
                <button type="button" class="btn btn-ghost copy-btn" data-copy="SA8580000660608016220957">
                  <i class="fa-regular fa-copy"></i> <span class="txt">Ù†Ø³Ø®</span>
                </button>
              </div>

              <div class="bank-item">
                <div>
                  <div class="bank-label">ÙƒÙˆØ¯ Ø³ÙˆÙŠÙØª</div>
                  <div class="bank-value bank-mono" dir="ltr">RJHISARI</div>
                </div>
                <button type="button" class="btn btn-ghost copy-btn" data-copy="RJHISARI">
                  <i class="fa-regular fa-copy"></i> <span class="txt">Ù†Ø³Ø®</span>
                </button>
              </div>
            </div>

            <div class="bank-note">
              ÙØ¶Ù„Ø§Ù‹ Ø§ÙƒØªØ¨ ÙÙŠ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­ÙˆØ§Ù„Ø©: <b>Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</b> + <b>Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ù‚Ø©</b> + <b>Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø§Ù„Ù…Ø¯ÙŠØ±</b> (Ù„ØªØ³Ø±ÙŠØ¹ Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ).
            </div>
          </div>
        </details>

        <div class="sub-divider"></div>

        <form
          action="{% url 'reports:payment_create' %}"
          method="POST"
          enctype="multipart/form-data"
          id="renewForm"
          novalidate
        >
          {% csrf_token %}

          <div class="fg-grid">
            <div class="fg">
              <label class="lbl" for="plan_select">Ø§Ø®ØªØ± Ø§Ù„Ø¨Ø§Ù‚Ø©</label>
              <select id="plan_select" class="sel" name="plan" required>
                <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø¨Ø§Ù‚Ø© --</option>
                {% for plan in plans %}
                  <option
                    value="{{ plan.pk }}"
                    data-price="{{ plan.price }}"
                    {% if subscription and subscription.plan_id == plan.id %}selected{% endif %}
                    {% if not plan.is_active %}disabled{% endif %}
                  >
                    {{ plan.name }} - {{ plan.price }} Ø±ÙŠØ§Ù„{% if not plan.is_active %} (ØºÙŠØ± Ù†Ø´Ø·Ø©){% endif %}
                  </option>
                {% endfor %}
              </select>
              <div class="help">Ø§Ø®ØªØ± Ù†ÙØ³ Ø§Ù„Ø¨Ø§Ù‚Ø© Ù„Ù„ØªØ¬Ø¯ÙŠØ¯ØŒ Ø£Ùˆ Ø§Ø®ØªØ± Ø¨Ø§Ù‚Ø© Ø£Ø®Ø±Ù‰ Ù„Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø¨Ù‡Ø§.</div>
            </div>

            <div class="fg">
              <label class="lbl" for="amount">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø­ÙˆÙ„ (Ø±ÙŠØ§Ù„)</label>
              <input
                type="number"
                name="amount"
                id="amount"
                required
                step="0.01"
                min="0"
                class="in"
                placeholder="0.00"
                inputmode="decimal"
              >
              <div class="help">Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† Ø³Ø¹Ø± Ø§Ù„Ø¨Ø§Ù‚Ø© (ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„Ù‡ Ø¥Ø°Ø§ Ù„Ø²Ù…).</div>
            </div>
          </div>

          <div class="fg">
            <label class="lbl" for="receipt_image">ØµÙˆØ±Ø© Ø§Ù„Ø¥ÙŠØµØ§Ù„</label>
            <input
              type="file"
              name="receipt_image"
              id="receipt_image"
              class="in"
              required
              accept="image/*"
              capture="environment"
            >
            <div class="help">ÙŠØ±Ø¬Ù‰ Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø© ÙˆØ§Ø¶Ø­Ø© Ù„Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨Ù†ÙƒÙŠ (JPG/PNG) â€” Ø­Ø¯ Ø£Ù‚ØµÙ‰ 10MB.</div>

            <div class="rprev" id="receiptPreview" aria-live="polite">
              <img id="receiptImg" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¥ÙŠØµØ§Ù„">
              <div class="meta">
                <span id="receiptMeta">â€”</span>
                <button type="button" class="btn btn-ghost" id="receiptClearBtn" style="min-height:40px">
                  <i class="fa-solid fa-trash"></i> Ø¥Ø²Ø§Ù„Ø©
                </button>
              </div>
            </div>
          </div>

          <div class="fg">
            <label class="lbl" for="notes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</label>
            <textarea
              name="notes"
              id="notes"
              rows="2"
              class="ta"
              placeholder="Ù…Ø«Ø§Ù„: Ø±Ù‚Ù… Ø§Ù„Ø­ÙˆØ§Ù„Ø© Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ù…Ø­ÙˆÙ„..."
            ></textarea>
          </div>

          <div class="sub-actions">
            <button type="submit" class="btn btn-primary" id="submitBtn" style="flex:1">
              <i class="fa-solid fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨
            </button>
          </div>
        </form>
      </div>
    </div>

  </div>

  <!-- Payments History -->
  <div class="card sub-card" style="margin-top:14px">
    <div class="sub-body">
      <h2 class="sub-title"><i class="fa-solid fa-clock-rotate-left" style="opacity:.85"></i> Ø¢Ø®Ø± Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¯ÙØ¹</h2>

      <div class="twrap">
        <table class="tbl" aria-label="Ø³Ø¬Ù„ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¯ÙØ¹">
          <thead>
            <tr>
              <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              <th>Ø§Ù„Ø¨Ø§Ù‚Ø©</th>
              <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
              <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
              <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
            </tr>
          </thead>
          <tbody>
            {% for payment in payments %}
              <tr>
                <td data-label="Ø§Ù„ØªØ§Ø±ÙŠØ®"><span dir="ltr">{{ payment.created_at|date:"Y-m-d" }}</span></td>
                <td data-label="Ø§Ù„Ø¨Ø§Ù‚Ø©" style="font-weight:850">{% if payment.requested_plan %}{{ payment.requested_plan.name }}{% else %}â€”{% endif %}</td>
                <td data-label="Ø§Ù„Ù…Ø¨Ù„Øº" style="font-weight:950">{{ payment.amount }} Ø±ÙŠØ§Ù„</td>
                <td data-label="Ø§Ù„Ø­Ø§Ù„Ø©">
                  {% if payment.status == 'approved' %}
                    <span class="sbadge sb-active">âœ… Ù…Ù‚Ø¨ÙˆÙ„</span>
                  {% elif payment.status == 'rejected' %}
                    <span class="sbadge sb-expired">â›” Ù…Ø±ÙÙˆØ¶</span>
                  {% else %}
                    <span class="sbadge sb-pending">â³ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</span>
                  {% endif %}
                </td>
                <td data-label="Ù…Ù„Ø§Ø­Ø¸Ø§Øª" class="note-dim">{{ payment.notes|default:"-" }}</td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="5">
                  <div class="empty" style="margin: 6px 0">
                    <div class="ico">ğŸ§¾</div>
                    Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø¯ÙØ¹ Ø³Ø§Ø¨Ù‚Ø©
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>
{% endblock %}

{% block scripts %}
<script nonce="{{ CSP_NONCE }}">
  (function(){
    var planSelect = document.getElementById('plan_select');
    var amountEl   = document.getElementById('amount');
    var fileEl     = document.getElementById('receipt_image');

    var prevBox  = document.getElementById('receiptPreview');
    var prevImg  = document.getElementById('receiptImg');
    var prevMeta = document.getElementById('receiptMeta');
    var clearBtn = document.getElementById('receiptClearBtn');

    var form     = document.getElementById('renewForm');
    var submitBtn= document.getElementById('submitBtn');

    var MAX_MB = 10;
    var MAX_BYTES = MAX_MB * 1024 * 1024;

    var currentObjectUrl = null;

    function toast(msg, type){
      if(window.showToast){
        window.showToast(msg, type || 'warning');
        return;
      }
      alert(msg);
    }

    function setCopyBtnState(btn, text){
      if(!btn) return;
      var span = btn.querySelector('.txt');
      if(span) span.textContent = text;
      setTimeout(function(){
        if(span) span.textContent = 'Ù†Ø³Ø®';
      }, 1200);
    }

    function copyText(text, btn){
      if(!text) return;
      if(navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(text).then(function(){
          toast('ØªÙ… Ø§Ù„Ù†Ø³Ø®', 'success');
          setCopyBtnState(btn, 'ØªÙ… Ø§Ù„Ù†Ø³Ø®');
        }).catch(function(){
          fallbackCopy(text, btn);
        });
        return;
      }
      fallbackCopy(text, btn);
    }

    function fallbackCopy(text, btn){
      try{
        var ta = document.createElement('textarea');
        ta.value = text;
        ta.setAttribute('readonly', 'readonly');
        ta.style.position = 'fixed';
        ta.style.top = '-1000px';
        ta.style.left = '-1000px';
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        toast('ØªÙ… Ø§Ù„Ù†Ø³Ø®', 'success');
        setCopyBtnState(btn, 'ØªÙ… Ø§Ù„Ù†Ø³Ø®');
      }catch(e){
        toast('ØªØ¹Ø°Ø± Ø§Ù„Ù†Ø³Ø®ØŒ Ø§Ù†Ø³Ø®Ù‡Ø§ ÙŠØ¯ÙˆÙŠÙ‹Ø§.', 'warning');
      }
    }

    // Ø£Ø²Ø±Ø§Ø± Ù†Ø³Ø® Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ­ÙˆÙŠÙ„
    var copyBtns = document.querySelectorAll('[data-copy].copy-btn');
    if(copyBtns && copyBtns.length){
      copyBtns.forEach(function(btn){
        btn.addEventListener('click', function(){
          var t = btn.getAttribute('data-copy') || '';
          copyText(t, btn);
        });
      });
    }

    function syncAmountFromPlan(force){
      if(!planSelect || !amountEl) return;

      var opt = planSelect.options[planSelect.selectedIndex];
      var price = opt ? opt.getAttribute('data-price') : '';

      if(!planSelect.value || !price){
        if(force) amountEl.value = '';
        return;
      }

      if(force || !String(amountEl.value || '').trim()){
        amountEl.value = price;
      }
    }

    if(planSelect && amountEl){
      planSelect.addEventListener('change', function(){
        syncAmountFromPlan(true);
      });
      syncAmountFromPlan(false);
    }

    function revokePreviewUrl(){
      if(currentObjectUrl){
        try{ URL.revokeObjectURL(currentObjectUrl); }catch(e){}
        currentObjectUrl = null;
      }
    }

    function clearPreview(){
      if(prevBox) prevBox.style.display = 'none';
      if(prevImg) prevImg.removeAttribute('src');
      if(prevMeta) prevMeta.textContent = 'â€”';
      revokePreviewUrl();
    }

    function clearFile(){
      if(fileEl) fileEl.value = '';
      clearPreview();
    }

    if(fileEl){
      fileEl.addEventListener('change', function(){
        var f = (fileEl.files && fileEl.files[0]) ? fileEl.files[0] : null;

        if(!f){
          clearPreview();
          return;
        }

        var isImage = f.type && f.type.indexOf('image/') === 0;
        if(!isImage){
          toast('Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±ÙÙ‚ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† ØµÙˆØ±Ø©.', 'warning');
          clearFile();
          return;
        }

        if(f.size > MAX_BYTES){
          toast('Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ±. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ ' + MAX_MB + 'MB.', 'warning');
          clearFile();
          return;
        }

        revokePreviewUrl();
        currentObjectUrl = URL.createObjectURL(f);

        prevImg.src = currentObjectUrl;
        prevMeta.textContent = f.name + ' â€” ' + Math.round(f.size / 1024) + 'KB';
        prevBox.style.display = 'block';
      });
    }

    if(clearBtn){
      clearBtn.addEventListener('click', function(){
        clearFile();
      });
    }

    if(form && submitBtn){
      form.addEventListener('submit', function(ev){
        if(planSelect && !planSelect.value){
          ev.preventDefault();
          toast('ÙØ¶Ù„Ø§Ù‹ Ø§Ø®ØªØ± Ø§Ù„Ø¨Ø§Ù‚Ø©.', 'warning');
          return;
        }
        if(amountEl && !String(amountEl.value || '').trim()){
          ev.preventDefault();
          toast('ÙØ¶Ù„Ø§Ù‹ Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº Ø§Ù„ØªØ­ÙˆÙŠÙ„.', 'warning');
          return;
        }
        if(fileEl && (!fileEl.files || !fileEl.files[0])){
          ev.preventDefault();
          toast('ÙØ¶Ù„Ø§Ù‹ Ø£Ø±ÙÙ‚ ØµÙˆØ±Ø© Ø§Ù„Ø¥ÙŠØµØ§Ù„.', 'warning');
          return;
        }

        submitBtn.disabled = true;
        submitBtn.style.opacity = '0.85';
        submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Ø¬Ø§Ø±Ù Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';
      });
    }
  })();
</script>
{% endblock %}
