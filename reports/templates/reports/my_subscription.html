{# reports/templates/reports/my_subscription.html (or your path) #}
{% extends "base.html" %}
{% load static %}

{% block title %}Ø§Ø´ØªØ±Ø§ÙƒÙŠ{% endblock %}

{% block head %}
<style>
  /* =========================================================
     Subscription (page-only polish)
     - Scoped Ø¯Ø§Ø®Ù„ .sub-wrap Ù„ØªØ¬Ù†Ø¨ ØªØ¹Ø§Ø±Ø¶Ø§Øª base/app.css
     - Ø¨Ø¯ÙˆÙ† Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹Ø±ÙŠÙ .btn / .card Ø§Ù„Ø¹Ø§Ù…Ø©
     - Ø¯Ø¹Ù… Ø§Ù„Ø«ÙŠÙ… Ø¹Ø¨Ø± html[data-theme="dark"]
     ========================================================= */

  .sub-wrap{
    --s-radius: 16px;
    --s-shadow: 0 16px 40px rgba(2,6,23,.10);
    --s-ring: 0 0 0 4px rgba(37,99,235,.18);
    --t: var(--t-fast);

    max-width: 1100px;
    margin: 0 auto;
    padding: 18px;
  }

  .sub-top{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:12px;
    flex-wrap:wrap;
    margin-bottom: 18px;
  }

  .sub-h1{
    margin:0;
    font-weight: 950;
    font-size: clamp(1.35rem, 2.6vw, 1.9rem);
    color: var(--ink);
    letter-spacing: -.3px;
  }
  .sub-school{
    margin-top: 6px;
    color: var(--muted);
    font-weight: 850;
  }

  .sub-grid{
    display:grid;
    gap: 14px;
  }
  @media(min-width: 980px){
    .sub-grid{ grid-template-columns: 1fr 1fr; align-items:start; }
  }

  /* Card helpers (Ù…Ø¹ Ø¨Ù‚Ø§Ø¡ .card Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù…Ù† base) */
  .sub-card{
    border-radius: var(--s-radius);
    box-shadow: var(--s-shadow);
  }
  html[data-theme="dark"] .sub-card{
    box-shadow: 0 18px 50px rgba(0,0,0,.35);
  }

  .sub-title{
    margin:0 0 12px 0;
    font-weight: 950;
    color: var(--ink);
    display:flex;
    gap:10px;
    align-items:center;
  }

  /* Plan hero */
  .plan-hero{
    display:flex;
    gap:12px;
    align-items:center;
    padding: 14px;
    border-radius: 14px;
    background: rgba(219,234,254,.65);
    border: 1px solid rgba(59,130,246,.25);
  }
  html[data-theme="dark"] .plan-hero{
    background: rgba(30,58,138,.22);
    border-color: rgba(59,130,246,.25);
  }
  .plan-hero .icon{
    width: 44px; height: 44px;
    border-radius: 14px;
    display:grid; place-items:center;
    background: rgba(37,99,235,.14);
    border: 1px solid rgba(37,99,235,.22);
    color: rgba(37,99,235,.95);
    font-size: 20px;
    flex: 0 0 auto;
  }
  .plan-hero .name{
    font-weight: 950;
    color: #1e40af;
  }
  html[data-theme="dark"] .plan-hero .name{
    color: #bfdbfe;
  }
  .plan-hero .meta{
    margin-top: 4px;
    font-weight: 850;
    color: rgba(30,58,138,.90);
    font-size: .95rem;
  }
  html[data-theme="dark"] .plan-hero .meta{
    color: rgba(191,219,254,.85);
  }

  /* Stats */
  .stats{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-top: 12px;
  }
  .stat{
    padding: 14px;
    border-radius: 14px;
    border: 1px solid var(--line);
    background: linear-gradient(180deg, var(--line-2), var(--card));
    text-align:center;
  }
  html[data-theme="dark"] .stat{
    background: rgba(20,35,73,.35);
    border-color: #1b2744;
  }
  .stat .v{
    font-weight: 950;
    font-size: 1.55rem;
    color: var(--ink);
    line-height: 1.1;
  }
  .stat .l{
    margin-top: 6px;
    font-weight: 850;
    color: var(--muted);
    font-size: .95rem;
  }

  /* Badges */
  .sbadge{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:8px;
    padding: 7px 12px;
    border-radius: 999px;
    font-weight: 950;
    font-size: .86rem;
    white-space:nowrap;
  }
  .sb-active{ background: rgba(16,185,129,.14); border: 1px solid rgba(16,185,129,.25); color: rgba(16,185,129,.98); }
  .sb-expired{ background: rgba(239,68,68,.14); border: 1px solid rgba(239,68,68,.25); color: rgba(239,68,68,.98); }
  .sb-pending{ background: rgba(245,158,11,.16); border: 1px solid rgba(245,158,11,.25); color: rgba(245,158,11,.98); }

  /* Form */
  .fg{ margin-bottom: 14px; }
  .lbl{
    display:block;
    font-weight: 950;
    margin-bottom: 8px;
    color: var(--ink);
  }
  .in, .sel, .ta{
    width:100%;
    padding: 12px 12px;
    border: 1px solid var(--line);
    border-radius: 12px;
    background: var(--card);
    color: var(--ink);
    font: inherit;
    outline: none;
    transition: var(--t);
  }
  .in:focus, .sel:focus, .ta:focus{
    border-color: rgba(37,99,235,.45);
    box-shadow: var(--s-ring);
  }
  .help{
    margin-top: 6px;
    font-weight: 850;
    font-size: .9rem;
    color: var(--muted);
  }

  .sub-actions{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    margin-top: 10px;
  }
  .sub-actions .btn{ min-height: 44px; }

  /* Receipt preview */
  .rprev{
    display:none;
    margin-top: 10px;
    border: 1px solid var(--line);
    border-radius: 14px;
    overflow:hidden;
    background: var(--card);
  }
  .rprev img{
    width:100%;
    max-height: 280px;
    object-fit: contain;
    display:block;
    background: #0b1220;
  }
  .rprev .meta{
    padding: 10px 12px;
    background: var(--line-2);
    border-top: 1px solid var(--line);
    color: var(--muted);
    font-weight: 850;
    font-size: .92rem;
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
    justify-content:space-between;
  }

  /* Table */
  .twrap{ overflow-x:auto; }
  .tbl{
    width:100%;
    border-collapse:collapse;
    min-width: 640px;
  }
  .tbl th{
    text-align:right;
    padding: 12px;
    border-bottom: 2px solid var(--line);
    color: var(--muted);
    font-weight: 950;
    font-size: .92rem;
    white-space: nowrap;
  }
  .tbl td{
    padding: 12px;
    border-bottom: 1px solid var(--line);
    color: var(--ink);
    vertical-align: top;
  }

  .note-dim{ color: var(--muted); font-weight: 850; }

  /* Empty state */
  .empty{
    padding: 18px;
    border-radius: 16px;
    border: 1px dashed var(--line);
    background: linear-gradient(180deg, var(--card), var(--line-2));
    color: var(--muted);
    font-weight: 900;
    text-align:center;
  }
  .empty .ico{ font-size: 40px; margin-bottom: 8px; }

  @media (prefers-reduced-motion: reduce){
    .sub-wrap *{ transition:none !important; }
  }
</style>
{% endblock %}

{% block content %}
<div class="sub-wrap" dir="rtl">
  <div class="sub-top">
    <div>
      <h1 class="sub-h1">Ø¥Ø¯Ø§Ø±Ø© Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</h1>
      <div class="sub-school">{{ school.name }}</div>
    </div>

    <a href="{% url 'reports:admin_dashboard' %}" class="btn btn-ghost">
      <i class="fa-solid fa-arrow-right"></i> Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
    </a>
  </div>

  <div class="sub-grid">
    <!-- Status Card -->
    <div class="card sub-card">
      <h2 class="sub-title"><i class="fa-solid fa-gem" style="opacity:.85"></i> Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ</h2>

      {% if subscription %}
        <div class="plan-hero">
          <div class="icon">ğŸ’</div>
          <div>
            <div class="name">Ø§Ù„Ø¨Ø§Ù‚Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: {{ subscription.plan.name }}</div>
            <div class="meta">
              ÙŠÙ†ØªÙ‡ÙŠ ÙÙŠ: <span dir="ltr">{{ subscription.end_date|date:"Y-m-d" }}</span>
            </div>
          </div>
        </div>

        <div class="stats">
          <div class="stat">
            <div class="v">
              {% if subscription.days_remaining > 0 %}{{ subscription.days_remaining }}{% else %}0{% endif %}
            </div>
            <div class="l">Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</div>
          </div>

          <div class="stat">
            <div class="v" style="font-size:1.1rem">
              {% if subscription.is_expired %}
                <span class="sbadge sb-expired">â›” Ù…Ù†ØªÙ‡ÙŠ</span>
              {% else %}
                <span class="sbadge sb-active">âœ… Ù†Ø´Ø·</span>
              {% endif %}
            </div>
            <div class="l">Ø§Ù„Ø­Ø§Ù„Ø©</div>
          </div>
        </div>

        <div style="margin-top:14px; padding-top:14px; border-top:1px solid var(--line); display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between">
          <div class="note-dim">
            Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: {% if subscription.updated_at %}<span dir="ltr">{{ subscription.updated_at|date:"Y-m-d H:i" }}</span>{% else %}â€”{% endif %}
          </div>

          <a href="{% url 'reports:support_ticket_create' %}" class="btn btn-ghost">
            <i class="fa-solid fa-headset"></i> ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ
          </a>
        </div>
      {% else %}
        <div class="empty">
          <div class="ico">ğŸš«</div>
          <div style="color:var(--ink); font-weight:950; font-size:1.05rem; margin-bottom:4px;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§Ø´ØªØ±Ø§Ùƒ Ù†Ø´Ø·</div>
          <div style="font-weight:850">ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø¨Ø§Ù‚Ø© ÙˆØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ.</div>
        </div>
      {% endif %}
    </div>

    <!-- Renewal Form -->
    <div class="card sub-card">
      <h2 class="sub-title"><i class="fa-solid fa-receipt" style="opacity:.85"></i> Ø±ÙØ¹ Ø¥ÙŠØµØ§Ù„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</h2>

      <form
        action="{% url 'reports:payment_create' %}"
        method="POST"
        enctype="multipart/form-data"
        id="renewForm"
        novalidate
      >
        {% csrf_token %}

        <div class="fg">
          <label class="lbl" for="plan_select">Ø§Ø®ØªØ± Ø§Ù„Ø¨Ø§Ù‚Ø©</label>
          <select id="plan_select" class="sel" name="plan" required>
            <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø¨Ø§Ù‚Ø© --</option>
            {% for plan in plans %}
              <option
                value="{{ plan.pk }}"
                data-price="{{ plan.price }}"
                {% if not plan.is_active %}disabled{% endif %}
              >
                {{ plan.name }} - {{ plan.price }} Ø±ÙŠØ§Ù„{% if not plan.is_active %} (ØºÙŠØ± Ù†Ø´Ø·Ø©){% endif %}
              </option>
            {% endfor %}
          </select>
          <div class="help">Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù…Ø¨Ù„Øº ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø­Ø³Ø¨ Ø§Ù„Ø¨Ø§Ù‚Ø© (ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„Ù‡ Ø¥Ø°Ø§ Ù„Ø²Ù…).</div>
        </div>

        <div class="fg">
          <label class="lbl" for="amount">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø­ÙˆÙ„ (Ø±ÙŠØ§Ù„)</label>
          <input
            type="number"
            name="amount"
            id="amount"
            required
            step="0.01"
            min="0"
            class="in"
            placeholder="0.00"
            inputmode="decimal"
          >
        </div>

        <div class="fg">
          <label class="lbl" for="receipt_image">ØµÙˆØ±Ø© Ø§Ù„Ø¥ÙŠØµØ§Ù„</label>
          <input
            type="file"
            name="receipt_image"
            id="receipt_image"
            class="in"
            required
            accept="image/*"
            capture="environment"
          >
          <div class="help">ÙŠØ±Ø¬Ù‰ Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø© ÙˆØ§Ø¶Ø­Ø© Ù„Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨Ù†ÙƒÙŠ (JPG/PNG) â€” Ø­Ø¯ Ø£Ù‚ØµÙ‰ 10MB.</div>

          <div class="rprev" id="receiptPreview" aria-live="polite">
            <img id="receiptImg" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¥ÙŠØµØ§Ù„">
            <div class="meta">
              <span id="receiptMeta">â€”</span>
              <button type="button" class="btn btn-ghost" id="receiptClearBtn" style="min-height:40px">
                <i class="fa-solid fa-trash"></i> Ø¥Ø²Ø§Ù„Ø©
              </button>
            </div>
          </div>
        </div>

        <div class="fg">
          <label class="lbl" for="notes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</label>
          <textarea
            name="notes"
            id="notes"
            rows="2"
            class="ta"
            placeholder="Ù…Ø«Ø§Ù„: Ø±Ù‚Ù… Ø§Ù„Ø­ÙˆØ§Ù„Ø© Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ù…Ø­ÙˆÙ„..."
          ></textarea>
        </div>

        <div class="sub-actions">
          <button type="submit" class="btn btn-primary" id="submitBtn" style="flex:1">
            <i class="fa-solid fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Payments History -->
  <div class="card sub-card" style="margin-top:14px">
    <h2 class="sub-title"><i class="fa-solid fa-clock-rotate-left" style="opacity:.85"></i> Ø¢Ø®Ø± Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¯ÙØ¹</h2>

    <div class="twrap">
      <table class="tbl">
        <thead>
          <tr>
            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            <th>Ø§Ù„Ø¨Ø§Ù‚Ø©</th>
            <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
          </tr>
        </thead>
        <tbody>
          {% for payment in payments %}
            <tr>
              <td><span dir="ltr">{{ payment.created_at|date:"Y-m-d" }}</span></td>
              <td style="font-weight:850">{% if payment.requested_plan %}{{ payment.requested_plan.name }}{% else %}â€”{% endif %}</td>
              <td style="font-weight:950">{{ payment.amount }} Ø±ÙŠØ§Ù„</td>
              <td>
                {% if payment.status == 'approved' %}
                  <span class="sbadge sb-active">âœ… Ù…Ù‚Ø¨ÙˆÙ„</span>
                {% elif payment.status == 'rejected' %}
                  <span class="sbadge sb-expired">â›” Ù…Ø±ÙÙˆØ¶</span>
                {% else %}
                  <span class="sbadge sb-pending">â³ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</span>
                {% endif %}
              </td>
              <td class="note-dim">{{ payment.notes|default:"-" }}</td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="5">
                <div class="empty" style="margin: 6px 0">
                  <div class="ico">ğŸ§¾</div>
                  Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø¯ÙØ¹ Ø³Ø§Ø¨Ù‚Ø©
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script nonce="{{ CSP_NONCE }}">
  (function(){
    var planSelect = document.getElementById('plan_select');
    var amountEl   = document.getElementById('amount');
    var fileEl     = document.getElementById('receipt_image');

    var prevBox  = document.getElementById('receiptPreview');
    var prevImg  = document.getElementById('receiptImg');
    var prevMeta = document.getElementById('receiptMeta');
    var clearBtn = document.getElementById('receiptClearBtn');

    var form     = document.getElementById('renewForm');
    var submitBtn= document.getElementById('submitBtn');

    var MAX_MB = 10;
    var MAX_BYTES = MAX_MB * 1024 * 1024;

    function toast(msg){
      // Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ Ù†Ø¸Ø§Ù… Toast ÙÙŠ base.html ÙŠÙØ¶Ù‘Ù„ Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡
      if(window.showToast){
        window.showToast(msg, 'warning');
        return;
      }
      alert(msg);
    }

    // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù…Ø¨Ù„Øº Ø­Ø³Ø¨ Ø§Ù„Ø¨Ø§Ù‚Ø©
    if(planSelect && amountEl){
      planSelect.addEventListener('change', function(){
        var opt = planSelect.options[planSelect.selectedIndex];
        var price = opt ? opt.getAttribute('data-price') : '';
        if(price){
          amountEl.value = price;
        }
      });
    }

    function clearPreview(){
      if(prevBox) prevBox.style.display = 'none';
      if(prevImg) prevImg.removeAttribute('src');
      if(prevMeta) prevMeta.textContent = 'â€”';
    }

    function clearFile(){
      if(fileEl) fileEl.value = '';
      clearPreview();
    }

    // Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¥ÙŠØµØ§Ù„ + ØªØ­Ù‚Ù‚ Ø¨Ø³ÙŠØ· (Ù…ØªØµÙØ­ ÙÙ‚Ø·)
    if(fileEl){
      fileEl.addEventListener('change', function(){
        var f = (fileEl.files && fileEl.files[0]) ? fileEl.files[0] : null;

        if(!f){
          clearPreview();
          return;
        }

        var isImage = f.type && f.type.indexOf('image/') === 0;
        if(!isImage){
          toast('Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±ÙÙ‚ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† ØµÙˆØ±Ø©.');
          clearFile();
          return;
        }

        if(f.size > MAX_BYTES){
          toast('Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ±. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ ' + MAX_MB + 'MB.');
          clearFile();
          return;
        }

        var url = URL.createObjectURL(f);
        prevImg.src = url;
        prevMeta.textContent = f.name + ' â€” ' + Math.round(f.size / 1024) + 'KB';
        prevBox.style.display = 'block';
      });
    }

    if(clearBtn){
      clearBtn.addEventListener('click', function(){
        clearFile();
      });
    }

    // Ù…Ù†Ø¹ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬ + ØªØ­Ù‚Ù‚ Ø³Ø±ÙŠØ¹ Ù‚Ø¨Ù„ Ø§Ù„ØªØ¹Ø·ÙŠÙ„
    if(form && submitBtn){
      form.addEventListener('submit', function(ev){
        // ØªØ­Ù‚Ù‚ Ø¨Ø³ÙŠØ· Ù‚Ø¨Ù„ ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø²Ø±
        if(planSelect && !planSelect.value){
          ev.preventDefault();
          toast('ÙØ¶Ù„Ø§Ù‹ Ø§Ø®ØªØ± Ø§Ù„Ø¨Ø§Ù‚Ø©.');
          return;
        }
        if(amountEl && !amountEl.value){
          ev.preventDefault();
          toast('ÙØ¶Ù„Ø§Ù‹ Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº Ø§Ù„ØªØ­ÙˆÙŠÙ„.');
          return;
        }
        if(fileEl && (!fileEl.files || !fileEl.files[0])){
          ev.preventDefault();
          toast('ÙØ¶Ù„Ø§Ù‹ Ø£Ø±ÙÙ‚ ØµÙˆØ±Ø© Ø§Ù„Ø¥ÙŠØµØ§Ù„.');
          return;
        }

        submitBtn.disabled = true;
        submitBtn.style.opacity = '0.85';
        submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Ø¬Ø§Ø±Ù Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';
      });
    }
  })();
</script>
{% endblock %}
