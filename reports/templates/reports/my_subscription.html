{# reports/templates/reports/my_subscription.html #}
{% extends "base.html" %}
{% load static %}

{% block title %}إدارة الاشتراك{% endblock %}

{% block extra_css %}
<style>
  /* =========================================
     2026 FUTURE UI - MANSOUR DESIGN
     ========================================= */
  @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap');

  :root {
    --primary-gradient: linear-gradient(135deg, #4f46e5, #ec4899);
    --glass-surface: rgba(255, 255, 255, 0.7);
    --glass-border: rgba(255, 255, 255, 0.5);
    --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
    --dark-surface: #0f172a;
    --text-main: #1e293b;
    --text-muted: #64748b;
  }

  [data-theme="dark"] {
    --glass-surface: rgba(30, 41, 59, 0.6);
    --glass-border: rgba(255, 255, 255, 0.1);
    --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
    --text-main: #f1f5f9;
    --text-muted: #94a3b8;
  }

  body { font-family: 'Tajawal', sans-serif; }

  /* Animated Background Blob */
  .page-bg-accent {
    position: fixed; top: -100px; left: -100px; width: 600px; height: 600px;
    background: radial-gradient(circle, rgba(79, 70, 229, 0.15), transparent 70%);
    z-index: -1; pointer-events: none; filter: blur(60px);
  }

  /* Layout Wrapper */
  .sub-wrapper {
    max-width: 1200px;
    margin: 40px auto;
    padding: 0 20px;
    animation: fadeIn 0.6s ease-out;
  }

  /* Header Section */
  .sub-header {
    display: flex; justify-content: space-between; align-items: flex-end;
    margin-bottom: 40px; padding-bottom: 20px;
    border-bottom: 2px solid var(--glass-border);
  }
  .sub-title h1 {
    font-size: 2.5rem; font-weight: 900; margin: 0;
    background: -webkit-linear-gradient(0deg, #3b82f6, #8b5cf6);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  .sub-subtitle {
    font-size: 1.1rem; color: var(--text-muted); font-weight: 500; margin-top: 5px;
    display: flex; align-items: center; gap: 8px;
  }
  
  .btn-back-pulse {
    background: var(--glass-surface);
    border: 1px solid var(--glass-border);
    padding: 12px 24px;
    border-radius: 50px;
    color: var(--text-main);
    text-decoration: none;
    font-weight: 700;
    transition: 0.3s;
    display: inline-flex; align-items: center; gap: 8px;
    box-shadow: var(--glass-shadow);
  }
  .btn-back-pulse:hover {
    transform: translateX(5px);
    background: #fff;
    color: #4f46e5;
  }

  /* Main Grid */
  .sub-grid {
    display: grid;
    grid-template-columns: 350px 1fr;
    gap: 30px;
  }
  
  /* Left Panel: Status */
  .status-panel {
    background: var(--glass-surface);
    backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    border-radius: 30px;
    padding: 30px;
    height: fit-content;
    text-align: center;
    position: relative; overflow: hidden;
  }
  .status-ring-container {
    width: 200px; height: 200px; margin: 0 auto 20px; position: relative;
  }
  .status-ring-svg {
    transform: rotate(-90deg); width: 100%; height: 100%;
  }
  .ring-circle-bg { fill: none; stroke: var(--glass-border); stroke-width: 10; }
  .ring-circle-val {
    fill: none; stroke: #10b981; stroke-width: 10; stroke-linecap: round;
    stroke-dasharray: 565; stroke-dashoffset: 565; /* Full circle approx 2*PI*90 = 565 */
    transition: stroke-dashoffset 1.5s ease-out;
  }
  .ring-content {
    position: absolute; top:0; left:0; width:100%; height:100%;
    display:flex; flex-direction:column; justify-content:center; align-items:center;
  }
  .ring-days { font-size: 3rem; font-weight: 900; line-height: 1; color: var(--text-main); }
  .ring-label { font-size: 0.9rem; color: var(--text-muted); }

  .current-plan-badge {
    background: linear-gradient(135deg, #e0f2fe, #bae6fd);
    color: #0369a1; padding: 8px 20px; border-radius: 20px; font-weight: 800;
    display: inline-block; margin-bottom: 20px;
  }
  [data-theme="dark"] .current-plan-badge {
    background: rgba(56, 189, 248, 0.15); color: #38bdf8;
  }

  /* Right Panel: Actions */
  .action-panel {
    display: flex; flex-direction: column; gap: 30px;
  }

  /* Section Title */
  .panel-h2 { font-size: 1.5rem; font-weight: 800; color: var(--text-main); margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
  .panel-h2 i { color: #8b5cf6; }

  /* Plan Selection Cards */
  .plans-container {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;
  }
  .plan-card-radio { display: none; }
  .plan-card-label {
    background: var(--glass-surface);
    border: 2px solid transparent;
    border-radius: 20px;
    padding: 20px;
    cursor: pointer;
    transition: 0.3s;
    position: relative;
    border: 1px solid var(--glass-border);
  }
  .plan-card-label:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
  
  /* Selected State */
  .plan-card-radio:checked + .plan-card-label {
    border-color: #6366f1;
    background: linear-gradient(to bottom right, rgba(99, 102, 241, 0.05), rgba(168, 85, 247, 0.05));
    box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
  }
  .plan-card-radio:checked + .plan-card-label::after {
    content: '\f00c'; font-family: 'Font Awesome 6 Free'; font-weight:900;
    position: absolute; top: -10px; left: -10px;
    background: #6366f1; color: white; width: 26px; height: 26px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center; font-size: 0.8rem;
  }
  
  .pc-name { font-size: 1.1rem; font-weight: 800; margin-bottom: 5px; color: var(--text-main); }
  .pc-price { font-size: 1.3rem; font-weight: 700; color: #4f46e5; }
  .pc-period { font-size: 0.8rem; color: var(--text-muted); }

  /* Payment Form Container */
  .payment-box {
    background: var(--glass-surface);
    padding: 30px; border-radius: 30px;
    border: 1px solid var(--glass-border);
  }

  /* Bank New Card */
  .neon-bank {
    background: linear-gradient(135deg, #1e293b, #0f172a);
    color: #fff;
    border-radius: 24px;
    padding: 25px;
    margin-bottom: 30px;
    position: relative;
    overflow: hidden;
    box-shadow: 0 20px 40px -10px rgba(15, 23, 42, 0.6);
  }
  .neon-bank::before {
    content:''; position:absolute; top: -50%; right: -20%; width: 300px; height: 300px;
    background: radial-gradient(#6366f1, transparent 60%); opacity: 0.3;
  }
  .bank-details-grid {
    display: grid; grid-template-columns: 1fr auto; gap: 20px; align-items: center;
    position: relative; z-index: 2;
  }
  .bd-acc { font-family: 'Courier New', monospace; font-size: 1.3rem; letter-spacing: 1px; margin: 5px 0; font-weight: 600; text-shadow:0 2px 4px rgba(0,0,0,0.5); }
  .copy-pill {
    background: rgba(255,255,255,0.1); padding: 6px 14px; border-radius: 20px; font-size: 0.8rem; cursor: pointer; transition: 0.2s;
    display: inline-flex; align-items: center; gap: 6px; border: 1px solid rgba(255,255,255,0.1);
  }
  .copy-pill:hover { background: rgba(255,255,255,0.25); }

  /* Form Elements */
  .f-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
  .f-group { display: flex; flex-direction: column; gap: 8px; }
  .f-label { font-weight: 700; font-size: 0.9rem; color: var(--text-main); }
  
  .magic-input {
    background: var(--glass-surface);
    border: 2px solid var(--glass-border);
    padding: 16px; border-radius: 16px; width: 100%;
    font-family: inherit; font-size: 1rem; color: var(--text-main);
    transition: 0.3s;
  }
  .magic-input:focus { border-color: #6366f1; outline: none; box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1); }
  .magic-input[readonly] { background: rgba(0,0,0,0.02); color: #6366f1; font-weight: 800; }

  /* Upload */
  .upload-area {
    border: 2px dashed #cbd5e1; border-radius: 16px; padding: 30px;
    text-align: center; cursor: pointer; transition: 0.3s;
    background: rgba(255,255,255,0.01);
  }
  .upload-area:hover { border-color: #6366f1; background: rgba(99, 102, 241, 0.02); }
  
  .btn-submit-hero {
    width: 100%;
    background: var(--primary-gradient);
    color: white;
    border: none;
    padding: 20px;
    border-radius: 18px;
    font-size: 1.1rem; font-weight: 800;
    cursor: pointer;
    box-shadow: 0 10px 25px rgba(79, 70, 229, 0.4);
    transition: 0.3s;
  }
  .btn-submit-hero:hover { transform: translateY(-3px); box-shadow: 0 15px 35px rgba(79, 70, 229, 0.5); }
  
  /* History Table */
  .history-section { margin-top: 50px; }
  .h-table { width: 100%; border-collapse: separate; border-spacing: 0 10px; }
  .h-table th { padding: 15px 20px; text-align: right; color: var(--text-muted); font-weight: 600; font-size: 0.9rem; }
  .h-table td { background: var(--glass-surface); padding: 20px; color: var(--text-main); font-weight: 600; border:1px solid var(--glass-border); }
  .h-table tr td:first-child { border-top-right-radius: 16px; border-bottom-right-radius: 16px; border-right: 1px solid var(--glass-border); }
  .h-table tr td:last-child { border-top-left-radius: 16px; border-bottom-left-radius: 16px; border-left: 1px solid var(--glass-border); }
  .h-table tr { transition: 0.2s; }
  .h-table tr:hover { transform: scale(1.01); }

  @media (max-width: 900px) {
    .sub-grid { grid-template-columns: 1fr; }
    .status-panel { display: flex; align-items: center; justify-content: space-around; text-align: left; }
    .status-ring-container { margin: 0; width: 120px; height: 120px; }
    .f-row { grid-template-columns: 1fr; }
  }
  
  @keyframes fadeIn { from{opacity:0; transform:translateY(20px);} to{opacity:1; transform:translateY(0);} }
</style>
{% endblock %}

{% block content %}
<div class="page-bg-accent"></div>

<div class="sub-wrapper" dir="rtl">
  
  <!-- Header -->
  <header class="sub-header">
    <div class="sub-title">
      <h1>إدارة الاشتراك والمدفوعات</h1>
      <div class="sub-subtitle">
        <i class="fa-solid fa-school"></i> {{ school.name }}
      </div>
    </div>
    <a href="{% url 'reports:admin_dashboard' %}" class="btn-back-pulse">
      <i class="fa-solid fa-arrow-right"></i> لوحة التحكم
    </a>
  </header>

  <div class="sub-grid">
    
    <!-- LEFT: Status Card -->
    <div class="status-panel">
      
      <div class="current-plan-badge">
        <i class="fa-solid fa-star"></i> الباقة الحالية: {{ subscription.plan.name|default:"غير مشترك" }}
      </div>

      <div class="status-ring-container">
        <svg class="status-ring-svg" viewBox="0 0 200 200">
          <circle class="ring-circle-bg" cx="100" cy="100" r="90"></circle>
          <circle class="ring-circle-val" cx="100" cy="100" r="90" id="daysRing"></circle>
        </svg>
        <div class="ring-content">
          <div class="ring-days">{% if subscription.days_remaining > 0 %}{{ subscription.days_remaining }}{% else %}0{% endif %}</div>
          <div class="ring-label">يوم متبقي</div>
        </div>
      </div>
      
      <div style="font-size:0.9rem; color:var(--text-muted); margin-top:20px;">
        <div>تاريخ الانتهاء: <span dir="ltr" style="font-weight:700; color:var(--text-main)">{{ subscription.end_date|date:"Y-m-d"|default:"-" }}</span></div>
        <div style="margin-top:10px;">
            {% if subscription.is_expired %}
              <span style="color:#ef4444; font-weight:800"><i class="fa-solid fa-triangle-exclamation"></i> الاشتراك منتهي</span>
            {% else %}
              <span style="color:#10b981; font-weight:800"><i class="fa-solid fa-check-circle"></i> الاشتراك نشط</span>
            {% endif %}
        </div>
      </div>

      <div style="margin-top:20px; padding-top:20px; border-top:1px solid rgba(0,0,0,0.1)">
         <a href="https://wa.me/966500000000" target="_blank" style="color:#3b82f6; text-decoration:none; font-size:0.9rem; font-weight:600">
           <i class="fa-brands fa-whatsapp"></i> تواصل مع الدعم الفني
         </a>
      </div>
    </div>

    <!-- RIGHT: Upgrade & Payment -->
    <div class="action-panel">
      
      <!-- Plans Selector -->
      <div>
        <h2 class="panel-h2"><i class="fa-solid fa-layer-group"></i> اختر الباقة</h2>
        <div class="plans-container">
          {% for plan in plans %}
          <div class="plan-item">
            <input type="radio" name="plan_visual" id="p_{{ plan.id }}" class="plan-card-radio" 
                   value="{{ plan.id }}" data-price="{{ plan.price|stringformat:'f' }}"
                   {% if subscription and subscription.plan_id == plan.id %}checked{% endif %}>
            <label for="p_{{ plan.id }}" class="plan-card-label">
              <div class="pc-name">{{ plan.name }}</div>
              <div class="pc-price">{{ plan.price }} <span style="font-size:0.8rem; color:var(--text-muted)">ريال</span></div>
              <div class="pc-period">سنوياً</div>
              {% if plan.days > 365 %}<div style="color:#10b981; font-size:0.75rem; font-weight:700; margin-top:5px;">قيمة افضل</div>{% endif %}
            </label>
          </div>
          {% endfor %}
        </div>
      </div>

      <!-- Payment Form -->
      <div class="payment-box">
        <h2 class="panel-h2"><i class="fa-solid fa-credit-card"></i> بيانات الدفع</h2>
        
        <!-- Bank Info Card -->
        <div class="neon-bank">
          <div style="display:flex; justify-content:space-between; margin-bottom:20px; opacity:0.8">
            <span>Al Rajhi Bank</span>
            <span style="letter-spacing:2px">PRO</span>
          </div>
          
          <div class="bank-details-grid">
            <div>
              <div style="font-size:0.8rem; opacity:0.6; text-transform:uppercase">IBAN</div>
              <div class="bd-acc" dir="ltr">SA85 8000 0660 6080 1622 0957</div>
            </div>
            <div class="copy-pill" onclick="copyToClip('SA8580000660608016220957')">
              <i class="fa-regular fa-copy"></i> نسخ
            </div>
          </div>

          <div class="bank-details-grid" style="margin-top:10px;">
            <div>
               <div style="font-size:0.8rem; opacity:0.6; text-transform:uppercase">Account Name</div>
               <div style="font-weight:700; font-size:1.1rem">Mansour Al-Ghamdi</div>
            </div>
          </div>
        </div>

        <!-- Actual Form -->
        <form action="{% url 'reports:payment_create' %}" method="POST" enctype="multipart/form-data" id="mainForm">
          {% csrf_token %}
          <!-- Hidden input synced with radio buttons -->
          <input type="hidden" name="plan" id="hidden_plan_id" required>

          <div class="f-row">
            <div class="f-group">
              <label class="f-label">المبلغ المطلوب (ريال)</label>
              <input type="text" name="amount" id="amount_field" class="magic-input" readonly placeholder="0.00">
            </div>
            <div class="f-group">
               <label class="f-label">ملاحظات التحويل</label>
               <input type="text" name="notes" class="magic-input" placeholder="اسم المحول، التاريخ...">
            </div>
          </div>

          <div class="f-group" style="margin-bottom:25px;">
             <label class="f-label">صورة الإيصال البنكي</label>
             <label for="receipt" class="upload-area" id="dropZone">
                <i class="fa-solid fa-cloud-arrow-up" style="font-size:2rem; color:#6366f1; margin-bottom:10px;"></i>
                <div style="font-weight:700; color:var(--text-main)">اضغط لرفع الصورة</div>
                <div style="font-size:0.85rem; color:var(--text-muted)" id="fileName">JPG, PNG - Max 10MB</div>
                <input type="file" name="receipt_image" id="receipt" style="display:none" accept="image/*" required>
             </label>
          </div>

          <button type="submit" class="btn-submit-hero">
            <i class="fa-solid fa-check"></i> تأكيد وإرسال الطلب
          </button>
        </form>

      </div>
    </div>

  </div>

  <!-- History Section -->
  <div class="history-section">
    <h2 class="panel-h2"><i class="fa-solid fa-clock-rotate-left"></i> سجل العمليات السابقة</h2>
    <table class="h-table">
       <thead>
         <tr>
           <th>التاريخ</th>
           <th>الباقة</th>
           <th>المبلغ</th>
           <th>الحالة</th>
           <th>ملاحظات</th>
         </tr>
       </thead>
       <tbody>
         {% for payment in payments %}
         <tr>
           <td><span dir="ltr">{{ payment.created_at|date:"Y-m-d" }}</span></td>
           <td>{{ payment.requested_plan.name|default:"-" }}</td>
           <td style="font-family:'Courier New'; font-weight:700">{{ payment.amount }} SAR</td>
           <td>
              {% if payment.status == 'approved' %}
                <span style="color:#10b981"><i class="fa-solid fa-check"></i> تم التفعيل</span>
              {% elif payment.status == 'rejected' %}
                <span style="color:#ef4444"><i class="fa-solid fa-xmark"></i> مرفوض</span>
              {% else %}
                <span style="color:#f59e0b"><i class="fa-solid fa-clock"></i> قيد المراجعة</span>
              {% endif %}
           </td>
           <td style="color:var(--text-muted); font-size:0.9rem">{{ payment.notes|truncatechars:30 }}</td>
         </tr>
         {% empty %}
         <tr>
           <td colspan="5" style="text-align:center; padding:40px; color:var(--text-muted);">
             لا يوجد سجلات سابقة للعرض.
           </td>
         </tr>
         {% endfor %}
       </tbody>
    </table>
  </div>

</div>
{% endblock %}

{% block scripts %}
<script nonce="{{ CSP_NONCE }}">
  document.addEventListener('DOMContentLoaded', () => {
     // 1. Ring Progress Animation
     const days = {{ subscription.days_remaining|default:0 }};
     const maxDays = 365;
     const circle = document.querySelector('.ring-circle-val');
     if(circle) {
         const radius = circle.r.baseVal.value;
         const circumference = radius * 2 * Math.PI;
         circle.style.strokeDasharray = `${circumference} ${circumference}`;
         
         const percent = Math.min(Math.max(days / maxDays, 0), 1);
         const offset = circumference - (percent * circumference);
         
         // Animate after small delay
         setTimeout(() => {
             circle.style.strokeDashoffset = offset;
             // Color logic
             if(days < 10) circle.style.stroke = '#ef4444'; 
             else if(days < 30) circle.style.stroke = '#f59e0b';
         }, 500);
     }

     // 2. Plan Selection Logic
     const radios = document.querySelectorAll('input[name="plan_visual"]');
     const hiddenInput = document.getElementById('hidden_plan_id');
     const amountDisplay = document.getElementById('amount_field');
     
     radios.forEach(r => {
        r.addEventListener('change', function(){
           if(this.checked){
              hiddenInput.value = this.value;
              // Format price
              const rawPrice = parseFloat(this.getAttribute('data-price') || 0);
              amountDisplay.value = rawPrice.toFixed(2);
              
              // Visual Bounce
              amountDisplay.style.transform = "scale(1.05)";
              setTimeout(() => amountDisplay.style.transform = "scale(1)", 200);
           }
        });
     });

     // Select default if exists
     const checkedRadio = document.querySelector('input[name="plan_visual"]:checked');
     if(checkedRadio) {
        checkedRadio.dispatchEvent(new Event('change'));
     } else if(radios.length > 0) {
        // Auto select first one if none selected? Optional.
     }

     // 3. File Upload Preview Text
     const fileInput = document.getElementById('receipt');
     const fileName = document.getElementById('fileName');
     const dropZone = document.getElementById('dropZone');
     
     fileInput.addEventListener('change', function(){
        if(this.files && this.files[0]){
           fileName.textContent = this.files[0].name;
           fileName.style.color = '#10b981';
           fileName.style.fontWeight = 'bold';
           dropZone.style.borderColor = '#10b981';
           dropZone.style.background = 'rgba(16, 185, 129, 0.05)';
        }
     });

  });

  // Global Copy Helper
  window.copyToClip = function(text) {
     navigator.clipboard.writeText(text).then(() => {
        // Simple toast
        const div = document.createElement('div');
        div.textContent = 'تم نسخ النص بنجاح ✅';
        div.style.cssText = 'position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#10b981; color:white; padding:10px 20px; border-radius:30px; z-index:9999; font-weight:bold; box-shadow:0 10px 20px rgba(0,0,0,0.2); animation: fadeInUp 0.3s ease-out;';
        document.body.appendChild(div);
        setTimeout(() => div.remove(), 2500);
     }).catch(err => alert('Copied: ' + text));
  }
</script>
{% endblock %}
