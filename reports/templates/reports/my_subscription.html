{# reports/templates/reports/my_subscription.html #}
{% extends "base.html" %}
{% load static %}

{% block title %}Ø§Ø´ØªØ±Ø§ÙƒÙŠ{% endblock %}

{% block extra_css %}
<style>
  :root {
    --glass-bg: rgba(255, 255, 255, 0.8);
    --primary-gradient: linear-gradient(135deg, #2563eb, #1d4ed8);
    --success-gradient: linear-gradient(135deg, #10b981, #059669);
    --surface-1: #ffffff;
    --surface-2: #f8fafc;
    --border-color: #e2e8f0;
  }
  
  [data-theme="dark"] {
    --glass-bg: rgba(30, 41, 59, 0.8);
    --surface-1: #1e293b;
    --surface-2: #0f172a;
    --border-color: #334155;
  }

  /* Layout & Typography */
  .sub-wrap {
    max-width: 1100px;
    margin: 0 auto;
    padding: 20px;
    font-family: 'Tajawal', sans-serif;
  }

  /* 2026 Header */
  .sub-header {
    margin-bottom: 30px;
    padding: 30px;
    background: var(--surface-1);
    border-radius: 24px;
    box-shadow: 0 4px 20px -5px rgba(0,0,0,0.05);
    border: 1px solid var(--border-color);
    position: relative;
    overflow: hidden;
  }
  .sub-header::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0; height: 4px;
    background: var(--primary-gradient);
  }
  .sub-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 20px;
  }
  .sub-h1 {
    font-size: 2rem;
    font-weight: 900;
    margin: 0;
    background: var(--primary-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  
  /* Smart Back Button */
  .btn-smart-back {
    background: var(--surface-2);
    color: var(--ink);
    border: 1px solid var(--border-color);
    border-radius: 50px;
    padding: 10px 24px;
    font-weight: 700;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    text-decoration: none;
    cursor: pointer;
  }
  .btn-smart-back:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    background: var(--surface-1);
    color: var(--primary);
  }

  /* Grid Layout */
  .sub-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
    gap: 24px;
    margin-bottom: 30px;
  }

  /* Modern Cards */
  .modern-card {
    background: var(--surface-1);
    border-radius: 24px;
    border: 1px solid var(--border-color);
    box-shadow: 0 10px 30px -10px rgba(0,0,0,0.05);
    padding: 25px;
    height: 100%;
    display: flex;
    flex-direction: column;
    transition: transform 0.3s ease;
  }
  .modern-card:hover {
    transform: translateY(-5px);
  }
  .card-head {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 24px;
    padding-bottom: 15px;
    border-bottom: 1px solid var(--border-color);
  }
  .card-head h2 { font-size: 1.25rem; font-weight: 800; margin: 0; color: var(--ink); }
  .card-head i { color: #3b82f6; font-size: 1.2rem; }

  /* Status Section */
  .status-hero {
    background: linear-gradient(135deg, var(--surface-2), var(--surface-1));
    border-radius: 16px;
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 16px;
    border: 1px solid var(--border-color);
    margin-bottom: 20px;
  }
  .status-icon {
    width: 50px; height: 50px;
    display: flex; align-items: center; justify-content: center;
    background: #eff6ff;
    border-radius: 12px;
    font-size: 1.5rem;
  }
  [data-theme="dark"] .status-icon { background: #1e3a8a; }

  .prog-wrap { margin-top: 20px; }
  .prog-bar {
    height: 8px;
    background: var(--surface-2);
    border-radius: 4px;
    overflow: hidden;
    margin: 8px 0;
    border: 1px solid var(--border-color);
  }
  .prog-fill {
    height: 100%;
    background: var(--success-gradient);
    border-radius: 4px;
    transition: width 1s ease;
  }
  .prog-stats {
    display: flex;
    justify-content: space-between;
    font-size: 0.85rem;
    font-weight: 700;
    color: var(--muted);
  }

    /* Bank Details */
    .bank-card-container {
        background: linear-gradient(135deg, #1e293b, #0f172a);
        border-radius: 20px;
        padding: 24px;
        color: white;
        position: relative;
        overflow: hidden;
        margin-bottom: 24px;
        box-shadow: 0 12px 24px -8px rgba(15, 23, 42, 0.4);
    }
    .bank-card-container::before {
        content: '';
        position: absolute;
        top: -50px; right: -50px;
        width: 150px; height: 150px;
        background: rgba(255,255,255,0.05);
        border-radius: 50%;
    }
    .bank-card-container::after {
        content: '';
        position: absolute;
        bottom: -30px; left: -30px;
        width: 120px; height: 120px;
        background: rgba(255,255,255,0.03);
        border-radius: 50%;
    }
    
    .bank-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        position: relative;
        z-index: 1;
    }
    .bank-logo { font-size: 1.5rem; font-weight: 900; letter-spacing: 1px; }
    .bank-chip { 
        width: 40px; height: 28px; 
        background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%); 
        border-radius: 6px; 
        position: relative;
        overflow: hidden;
    }
    .bank-chip::before {
        content: ''; position: absolute; top: 50%; left: 0; right: 0; height: 1px; background: rgba(0,0,0,0.2);
    }

    .bank-row {
        margin-bottom: 16px;
        position: relative;
        z-index: 1;
    }
    .bank-label-sm { font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-bottom: 4px; }
    .bank-value-lg { 
        font-family: 'Courier New', monospace; 
        font-size: 1.15rem; 
        font-weight: 700; 
        letter-spacing: 1px;
        display: flex; align-items: center; gap: 8px;
    }
    .bank-copy-icon {
        font-size: 0.9rem;
        color: rgba(255,255,255,0.6);
        cursor: pointer;
        transition: color 0.2s;
    }
    .bank-copy-icon:hover { color: #fff; }

    .bank-footer {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        margin-top: 10px;
        position: relative;
        z-index: 1;
    }
    
    .bank-note {
        font-size: 0.75rem;
        color: rgba(255,255,255,0.5);
        margin-top: 12px;
        border-top: 1px solid rgba(255,255,255,0.1);
        padding-top: 8px;
    }

  /* Form */
  .modern-input-group { margin-bottom: 20px; }
  .modern-label { display: block; margin-bottom: 8px; font-weight: 700; font-size: 0.95rem; }
  .modern-input, .modern-select, .modern-textarea {
    width: 100%;
    padding: 14px;
    border-radius: 12px;
    border: 2px solid var(--border-color);
    background: var(--surface-1);
    color: var(--ink);
    font-family: inherit;
    transition: all 0.2s;
  }
  .modern-input:focus, .modern-select:focus, .modern-textarea:focus {
    border-color: #3b82f6;
    outline: none;
    box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
  }

  .file-drop-zone {
    border: 2px dashed var(--border-color);
    border-radius: 16px;
    padding: 25px;
    text-align: center;
    cursor: pointer;
    background: var(--surface-2);
    transition: all 0.3s;
    display: block;
  }
  .file-drop-zone:hover {
    border-color: #3b82f6;
    background: rgba(59, 130, 246, 0.05);
  }
  
  .btn-submit {
    width: 100%;
    background: var(--primary-gradient);
    color: white;
    padding: 16px;
    border-radius: 14px;
    border: none;
    font-weight: 800;
    font-size: 1rem;
    cursor: pointer;
    transition: opacity 0.2s;
    display: flex; justify-content: center; align-items: center; gap: 10px;
  }
  .btn-submit:hover { opacity: 0.9; }
  .btn-submit:disabled { opacity: 0.7; cursor: not-allowed; }

  /* History Table */
  .history-box { overflow-x: auto; }
  .t-modern { width: 100%; border-collapse: collapse; min-width: 650px; }
  .t-modern th {
    text-align: right;
    padding: 16px;
    color: var(--muted);
    font-weight: 800;
    font-size: 0.85rem;
    border-bottom: 2px solid var(--border-color);
  }
  .t-modern td {
    padding: 16px;
    border-bottom: 1px solid var(--border-color);
    color: var(--ink);
    font-weight: 600;
  }
  .t-modern tr:last-child td { border-bottom: none; }

  /* Mobile Responsive */
  @media (max-width: 768px) {
    .sub-top { flex-direction: column; align-items: flex-start; }
    .btn-smart-back { width: 100%; justify-content: center; }
    
    .t-modern thead { display: none; }
    .t-modern tr {
      display: block;
      margin-bottom: 15px;
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 12px;
      background: var(--surface-1);
    }
    .t-modern td {
      display: flex;
      justify-content: space-between;
      border-bottom: 1px dashed var(--border-color);
      padding: 10px 0;
    }
    .t-modern td:last-child { border: none; }
    .t-modern td::before {
      content: attr(data-label);
      color: var(--muted);
      font-weight: 700;
    }
  }

  /* Utility */
  .sbadge { padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; display: inline-flex; align-items: center; gap:4px; }
  .sb-active { background: #dcfce7; color: #166534; }
  .sb-pending { background: #fef9c3; color: #854d0e; }
  .sb-expired { background: #fee2e2; color: #991b1b; }
  [data-theme="dark"] .sb-active { background: rgba(22, 101, 52, 0.4); color: #86efac; }
  [data-theme="dark"] .sb-pending { background: rgba(161, 98, 7, 0.4); color: #fde047; }
  [data-theme="dark"] .sb-expired { background: rgba(153, 27, 27, 0.4); color: #fca5a5; }
  
  .rprev { background: #1e293b; border-radius: 12px; overflow: hidden; margin-top:10px; display:none; }
  .rprev img { width: 100%; max-height: 200px; object-fit: contain; display: block; }
  .rprev .meta { padding: 8px; background: rgba(0,0,0,0.5); color: white; display:flex; justify-content:space-between; align-items:center; }

</style>
{% endblock %}

{% block content %}
<div class="sub-wrap" dir="rtl">

  <!-- Header -->
  <header class="sub-header">
    <div class="sub-top">
      <div>
        <h1 class="sub-h1">Ø¥Ø¯Ø§Ø±Ø© Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</h1>
        <div style="font-size:1.1rem; color:var(--muted); font-weight:600; margin-top:5px;">
          <i class="fa-solid fa-school"></i> {{ school.name }}
        </div>
      </div>
      
      <!-- Smart Back Button -->
      <button 
        onclick="window.smartBack('{% url 'reports:admin_dashboard' %}')" 
        class="btn-smart-back"
        data-smart-back="1"
      >
        <i class="fa-solid fa-arrow-right"></i> Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
      </button>
    </div>
  </header>

  <div class="sub-grid">
    
    <!-- Left Column: Status -->
    <div class="modern-card">
      <div class="card-head">
        <i class="fa-solid fa-gem"></i>
        <h2>Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</h2>
      </div>

      {% if subscription %}
        <div class="status-hero">
          <div class="status-icon">ğŸ’</div>
          <div style="flex:1">
            <div style="font-size:1.1rem; font-weight:800">{{ subscription.plan.name }}</div>
            <div style="font-size:0.9rem; color:var(--muted)">ÙŠÙ†ØªÙ‡ÙŠ: <span dir="ltr">{{ subscription.end_date|date:"Y-m-d" }}</span></div>
          </div>
          <div>
            {% if subscription.is_expired %}
              <span class="sbadge sb-expired"><i class="fa-solid fa-circle-xmark"></i> Ù…Ù†ØªÙ‡ÙŠ</span>
            {% else %}
              <span class="sbadge sb-active"><i class="fa-solid fa-circle-check"></i> Ù†Ø´Ø·</span>
            {% endif %}
          </div>
        </div>

        <!-- Days Remaining Progress (Visual) -->
        <div class="prog-wrap">
          <div class="prog-stats">
            <span>Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</span>
            <span>{% if subscription.days_remaining > 0 %}{{ subscription.days_remaining }}{% else %}0{% endif %} ÙŠÙˆÙ…</span>
          </div>
          <div class="prog-bar">
            {% comment %} Calculate simple percentage {% endcomment %}
            <div class="prog-fill" style="width: {% if subscription.days_remaining > 365 %}100%{% elif subscription.days_remaining <= 0 %}0%{% else %}{{ subscription.days_remaining|add:0|floatformat:0 }}%{% endif %} /* Simplified fallback; ideally math ratio */ ; width: 75%;"></div> 
          </div>
          <script nonce="{{ CSP_NONCE }}">
             // Quick fix for progress bar width since Django math in templates is limited without custom tags
             document.addEventListener('DOMContentLoaded', function(){
                var d = {{ subscription.days_remaining|default:0 }};
                var p = (d > 365) ? 100 : Math.max(0, (d/365)*100);
                var el = document.querySelector('.prog-fill');
                if(el) el.style.width = p + '%';
             });
          </script>
        </div>

        <div style="margin-top:auto; padding-top:20px; border-top:1px solid var(--border-color)">
           <a href="{% url 'reports:support_ticket_create' %}" style="display:flex; align-items:center; gap:8px; color:var(--muted); text-decoration:none; font-size:0.9rem;">
             <i class="fa-solid fa-headset"></i> Ù‡Ù„ ØªØ­ØªØ§Ø¬ Ù…Ø³Ø§Ø¹Ø¯Ø©ØŸ ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§
           </a>
        </div>

      {% else %}
        <div style="text-align:center; padding:40px 20px;">
          <div style="font-size:3rem; margin-bottom:15px">ğŸš«</div>
          <h3 style="margin:0; color:var(--ink)">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§Ø´ØªØ±Ø§Ùƒ Ù†Ø´Ø·</h3>
          <p style="color:var(--muted)">ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø¨Ø§Ù‚Ø© ÙˆØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù„Ù„Ø¥Ø³ØªÙØ§Ø¯Ø© Ù…Ù† Ø§Ù„Ø®Ø¯Ù…Ø§Øª.</p>
        </div>
      {% endif %}
    </div>

    <!-- Right Column: Renewal Form -->
    <div class="modern-card">
      <div class="card-head">
        <i class="fa-solid fa-file-invoice-dollar"></i>
        <h2>ØªØ¬Ø¯ÙŠØ¯ / Ø§Ø´ØªØ±Ø§Ùƒ Ø¬Ø¯ÙŠØ¯</h2>
      </div>

      <div class="bank-card-container">
        <div class="bank-header">
           <div class="bank-chip"></div>
           <div class="bank-logo">alrajhi bank</div>
        </div>

        <div class="bank-row">
           <div class="bank-label-sm">Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ (Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙÙŠØ¯)</div>
           <div class="bank-value-lg">
             Ù…Ù†ØµÙˆØ± Ø§Ù„ØºØ§Ù…Ø¯ÙŠ 
             <i class="fa-regular fa-copy bank-copy-icon copy-btn" data-copy="Ù…Ù†ØµÙˆØ± Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø­Ø§Ù…Ø¯ Ø§Ù„ØºØ§Ù…Ø¯ÙŠ" title="Ù†Ø³Ø®"></i>
           </div>
        </div>

        <div class="bank-row">
           <div class="bank-label-sm">Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨</div>
           <div class="bank-value-lg" dir="ltr">
             6600 0001 0006 0862 2095 7
             <i class="fa-regular fa-copy bank-copy-icon copy-btn" data-copy="660000010006086220957" title="Ù†Ø³Ø®"></i>
           </div>
        </div>

        <div class="bank-footer">
           <div style="flex:1">
             <div class="bank-label-sm">IBAN</div>
             <div class="bank-value-lg" style="font-size:0.95rem" dir="ltr">
               SA85 8000 0660 6080 1622 0957
               <i class="fa-regular fa-copy bank-copy-icon copy-btn" data-copy="SA8580000660608016220957" title="Ù†Ø³Ø®"></i>
             </div>
           </div>
           <div>
             <img src="https://companieslogo.com/img/orig/1120.SR-d7293521.png?t=1720244494" alt="Al Rajhi" style="height:30px; filter: brightness(0) invert(1);">
           </div>
        </div>

        <div class="bank-note">
           * Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø© ÙÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø­ÙˆØ§Ù„Ø© Ø§Ù„Ø¨Ù†ÙƒÙŠØ© Ù„Ø³Ù‡ÙˆÙ„Ø© Ø§Ù„ØªØ­Ù‚Ù‚.
        </div>
      </div>

      <form action="{% url 'reports:payment_create' %}" method="POST" enctype="multipart/form-data" id="renewForm" novalidate class="modern-form">
        {% csrf_token %}
        
        <div class="modern-input-group">
          <label class="modern-label" for="plan_select">Ø§Ù„Ø¨Ø§Ù‚Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</label>
          <select id="plan_select" class="modern-select" name="plan" required>
            <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø¨Ø§Ù‚Ø© --</option>
            {% for plan in plans %}
              <option value="{{ plan.pk }}" data-price="{{ plan.price }}" {% if subscription and subscription.plan_id == plan.id %}selected{% endif %} {% if not plan.is_active %}disabled{% endif %}>
                {{ plan.name }} - {{ plan.price }} Ø±ÙŠØ§Ù„
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="modern-input-group">
          <label class="modern-label" for="amount">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ (Ø±ÙŠØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ)</label>
          <div style="position:relative">
            <input type="number" name="amount" id="amount" required step="0.01" class="modern-input" placeholder="0.00" readonly style="background-color: var(--surface-2); cursor: not-allowed; font-weight:800; color:var(--brand-700);">
            <div style="position:absolute; left:12px; top:50%; transform:translateY(-50%); color:var(--muted); font-size:0.9rem; font-weight:700">SAR</div>
          </div>
          <div style="font-size:0.8rem; color:var(--muted); margin-top:4px">
            <i class="fa-solid fa-circle-info"></i> ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù…Ø¨Ù„Øº ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø§Ù‚Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©.
          </div>
        </div>

        <!-- Modern File Upload -->
        <div class="modern-input-group">
          <label class="modern-label">ØµÙˆØ±Ø© Ø§Ù„Ø¥ÙŠØµØ§Ù„ (JPG/PNG)</label>
          <label for="receipt_image" class="file-drop-zone">
             <i class="fa-solid fa-cloud-arrow-up" style="font-size:2rem; color:#3b82f6; margin-bottom:10px"></i>
             <div style="font-weight:700">Ø§Ø¶ØºØ· Ù„Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©</div>
             <div style="font-size:0.8rem; color:var(--muted)">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 10MB</div>
             <input type="file" name="receipt_image" id="receipt_image" style="display:none" required accept="image/*">
          </label>
          
          <div class="rprev" id="receiptPreview">
            <img id="receiptImg" alt="Ù…Ø¹Ø§ÙŠÙ†Ø©">
            <div class="meta">
               <span id="receiptMeta"></span>
               <button type="button" id="receiptClearBtn" style="background:none; border:none; color:white; cursor:pointer"><i class="fa-solid fa-trash"></i></button>
            </div>
          </div>
        </div>

        <div class="modern-input-group">
          <label class="modern-label" for="notes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <textarea name="notes" id="notes" class="modern-textarea" rows="2" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø­ÙˆÙ„ØŒ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­ÙˆÙŠÙ„..."></textarea>
        </div>

        <button type="submit" class="btn-submit" id="submitBtn">
          <i class="fa-solid fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªØ¬Ø¯ÙŠØ¯
        </button>

      </form>
    </div>
  </div>

  <!-- History Section -->
  <div class="modern-card">
    <div class="card-head">
      <i class="fa-solid fa-clock-rotate-left"></i>
      <h2>Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª ÙˆØ§Ù„Ø·Ù„Ø¨Ø§Øª</h2>
    </div>
    
    <div class="history-box">
      <table class="t-modern">
        <thead>
          <tr>
            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            <th>Ø§Ù„Ø¨Ø§Ù‚Ø©</th>
            <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
          </tr>
        </thead>
        <tbody>
          {% for payment in payments %}
          <tr>
            <td data-label="Ø§Ù„ØªØ§Ø±ÙŠØ®"><span dir="ltr">{{ payment.created_at|date:"Y-m-d" }}</span></td>
            <td data-label="Ø§Ù„Ø¨Ø§Ù‚Ø©">{% if payment.requested_plan %}{{ payment.requested_plan.name }}{% else %}â€”{% endif %}</td>
            <td data-label="Ø§Ù„Ù…Ø¨Ù„Øº">{{ payment.amount }} Ø±ÙŠØ§Ù„</td>
            <td data-label="Ø§Ù„Ø­Ø§Ù„Ø©">
              {% if payment.status == 'approved' %}
                <span class="sbadge sb-active"><i class="fa-solid fa-check"></i> Ù…Ù‚Ø¨ÙˆÙ„</span>
              {% elif payment.status == 'rejected' %}
                <span class="sbadge sb-expired"><i class="fa-solid fa-xmark"></i> Ù…Ø±ÙÙˆØ¶</span>
              {% else %}
                <span class="sbadge sb-pending"><i class="fa-solid fa-hourglass"></i> Ù…Ø±Ø§Ø¬Ø¹Ø©</span>
              {% endif %}
            </td>
            <td data-label="Ù…Ù„Ø§Ø­Ø¸Ø§Øª" style="color:var(--muted)">{{ payment.notes|default:"-" }}</td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="5" style="text-align:center; padding:30px; color:var(--muted)">
               <i class="fa-solid fa-receipt" style="font-size:1.5rem; display:block; margin-bottom:10px; opacity:0.5"></i>
               Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø³Ø§Ø¨Ù‚Ø©.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

</div>
{% endblock %}

{% block scripts %}
<script nonce="{{ CSP_NONCE }}">
  (function(){
    // Re-bind Logic matching new IDs and classes
    var planSelect = document.getElementById('plan_select');
    var amountEl   = document.getElementById('amount');
    var fileEl     = document.getElementById('receipt_image');

    var prevBox  = document.getElementById('receiptPreview');
    var prevImg  = document.getElementById('receiptImg');
    var prevMeta = document.getElementById('receiptMeta');
    var clearBtn = document.getElementById('receiptClearBtn');

    var form     = document.getElementById('renewForm');
    var submitBtn= document.getElementById('submitBtn');

    var MAX_MB = 10;
    var MAX_BYTES = MAX_MB * 1024 * 1024;
    var currentObjectUrl = null;

    function toast(msg, type){
      if(window.showToast) { window.showToast(msg, type||'warning'); return; }
      alert(msg);
    }

    // Copy to clipboard logic
    function setCopyBtnState(btn, text){
        // Mini animation for icon
        var originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fa-solid fa-check"></i>';
        setTimeout(function(){
            btn.innerHTML = originalHTML;
        }, 1500);
    }

    function copyText(text, btn){
      if(!text) return;
      if(navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(text).then(function(){
          toast('ØªÙ… Ø§Ù„Ù†Ø³Ø®', 'success');
          setCopyBtnState(btn, 'ØªÙ… Ø§Ù„Ù†Ø³Ø®');
        }).catch(function(){ fallbackCopy(text, btn); });
        return;
      }
      fallbackCopy(text, btn);
    }
    
    function fallbackCopy(text, btn){
      try {
        var ta = document.createElement('textarea');
        ta.value = text;
        ta.style.position='fixed'; ta.style.left='-9999px';
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        toast('ØªÙ… Ø§Ù„Ù†Ø³Ø®', 'success');
        setCopyBtnState(btn);
      } catch(e){
        toast('ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù†Ø³Ø® ÙŠØ¯ÙˆÙŠØ§Ù‹', 'warning');
      }
    }

    var copyBtns = document.querySelectorAll('.copy-btn');
    copyBtns.forEach(function(btn){
      btn.addEventListener('click', function(){
        copyText(btn.getAttribute('data-copy'), btn);
      });
    });

    // Auto-fill price
    function syncAmount(){
      if(!planSelect || !amountEl) return;
      var opt = planSelect.options[planSelect.selectedIndex];
      if(opt && opt.getAttribute('data-price')){
        // Only if amount is empty or was auto-filled
        amountEl.value = opt.getAttribute('data-price');
      } else {
        amountEl.value = '';
      }
    }
    if(planSelect) planSelect.addEventListener('change', syncAmount);
    // Init check (if reloaded with value)
    if(planSelect && !amountEl.value) syncAmount();


    // Image Preview
    function clearPreview(){
       if(prevBox) prevBox.style.display='none';
       if(fileEl) fileEl.value = '';
       if(currentObjectUrl) URL.revokeObjectURL(currentObjectUrl);
    }

    if(fileEl){
      fileEl.addEventListener('change', function(){
        var f = fileEl.files[0];
        if(!f){ clearPreview(); return; }
        if(f.size > MAX_BYTES){
           toast('Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹', 'warning');
           clearPreview();
           return;
        }
        if(currentObjectUrl) URL.revokeObjectURL(currentObjectUrl);
        currentObjectUrl = URL.createObjectURL(f);
        if(prevImg) prevImg.src = currentObjectUrl;
        if(prevMeta) prevMeta.textContent = (f.size/1024).toFixed(1) + ' KB';
        if(prevBox) prevBox.style.display = 'block';
      });
    }
    if(clearBtn) clearBtn.addEventListener('click', clearPreview);

    // Form Submit
    if(form){
      form.addEventListener('submit', function(e){
         if(!planSelect.value){
            e.preventDefault(); toast('Ø§Ø®ØªØ± Ø§Ù„Ø¨Ø§Ù‚Ø©', 'warning'); return;
         }
         if(!amountEl.value){
            e.preventDefault(); toast('Ø­Ø¯Ø¯ Ø§Ù„Ù…Ø¨Ù„Øº', 'warning'); return;
         }
         if(!fileEl.files[0]){
            e.preventDefault(); toast('Ø§Ø±ÙÙ‚ Ø§Ù„Ø¥ÙŠØµØ§Ù„', 'warning'); return;
         }
         if(submitBtn){
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Ø¬Ø§Ø± Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...';
         }
      });
    }

  })();
</script>
{% endblock %}
