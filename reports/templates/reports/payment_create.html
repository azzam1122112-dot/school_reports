{# reports/templates/reports/upload_payment_receipt.html (مثال اسم) #}
{% extends "base.html" %}
{% load static %}

{% block title %}رفع إيصال دفع{% endblock %}

{% block head %}
<style>
  /* ✅ Scoped styles (بدون لمس :root) */
  .payup-scope{max-width:980px;margin-inline:auto;padding:clamp(10px,2.2vw,18px)}
  .payup-shell{
    background:var(--card);
    border:1px solid var(--line-2);
    border-radius:18px;
    box-shadow:var(--shadow);
    overflow:hidden;
  }

  /* Hero */
  .payup-hero{
    padding:clamp(14px,2.2vw,20px) clamp(14px,3vw,24px);
    background:
      radial-gradient(900px 200px at 20% 0%, rgba(37,99,235,.18), transparent 55%),
      radial-gradient(700px 220px at 85% 80%, rgba(16,185,129,.14), transparent 60%),
      linear-gradient(135deg, rgba(37,99,235,.92), rgba(59,130,246,.86));
    color:#fff;
  }
  .payup-hero-top{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap}
  .payup-title{margin:0;font-weight:950;font-size:clamp(1.15rem,2.4vw,1.55rem);display:flex;align-items:center;gap:10px}
  .payup-sub{margin:6px 0 0;opacity:.95;font-weight:850;line-height:1.6}
  .payup-chip{
    display:inline-flex;align-items:center;gap:8px;
    padding:8px 12px;border-radius:999px;
    background:rgba(255,255,255,.14);
    border:1px solid rgba(255,255,255,.22);
    backdrop-filter: blur(10px);
    font-weight:900;
    white-space:nowrap;
    text-decoration:none;
    color:#fff;
  }
  .payup-chip:hover{background:rgba(255,255,255,.18)}

  /* Body */
  .payup-body{padding:clamp(14px,2.6vw,22px)}
  .payup-grid{display:grid;gap:14px}
  .group{display:block}
  .label{
    display:flex;align-items:center;gap:10px;
    margin:0 0 8px;
    font-weight:900;
    color:var(--ink);
  }
  .label i{color:rgba(37,99,235,.95)}
  .hint{margin-top:6px;color:var(--muted);font-weight:800;font-size:.88rem}

  /* Inputs aligned with app.css feel */
  .payup-body input,
  .payup-body textarea{
    width:100%;
    min-height:var(--tap);
    border-radius:14px;
    border:1px solid var(--line);
    padding:12px 14px;
    background:rgba(248,250,252,.85);
    font-weight:800;
    transition: box-shadow .18s ease, border-color .18s ease;
  }
  html[data-theme="dark"] .payup-body input,
  html[data-theme="dark"] .payup-body textarea{
    background: rgba(255,255,255,.04);
    border-color: rgba(148,163,184,.16);
  }
  .payup-body input:focus,
  .payup-body textarea:focus{
    outline:none;
    border-color:var(--brand);
    box-shadow:var(--ring);
  }

  /* Django errors */
  .field-error{margin-top:6px;color:#b91c1c;font-weight:900;font-size:.9rem}
  html[data-theme="dark"] .field-error{color:#fecaca}

  /* File preview */
  .preview{
    display:none;
    margin-top:10px;
    border:1px solid var(--line-2);
    border-radius:14px;
    overflow:hidden;
    background:rgba(248,250,252,.5);
  }
  .preview img{
    display:block;
    width:100%;
    max-height:320px;
    object-fit:contain;
    background:#fff;
  }
  html[data-theme="dark"] .preview img{background:rgba(255,255,255,.02)}
  .preview-meta{
    padding:10px 12px;
    display:flex;
    justify-content:space-between;
    gap:10px;
    flex-wrap:wrap;
    color:var(--muted);
    font-weight:850;
    font-size:.88rem;
  }

  /* Actions */
  .actions{
    margin-top:16px;
    padding-top:14px;
    border-top:1px solid var(--line-2);
    display:flex;
    gap:10px;
    flex-wrap:wrap;
  }
  .actions .btn{border-radius:14px}
  .actions .btn-primary{min-width:220px}
  @media(max-width:560px){
    .actions{flex-direction:column}
    .actions .btn,
    .actions .btn-primary{width:100%}
  }
</style>
{% endblock %}

{% block content %}
<div class="payup-scope" dir="rtl">
  <div class="payup-shell">
    <div class="payup-hero">
      <div class="payup-hero-top">
        <div>
          <h1 class="payup-title">
            <i class="fa-solid fa-receipt" aria-hidden="true"></i>
            رفع إيصال دفع / تجديد اشتراك
          </h1>
          <p class="payup-sub">ارفع صورة واضحة للإيصال مع مبلغ التحويل لتتم مراجعة الطلب واعتماده.</p>
        </div>

        <a href="{% url 'reports:my_subscription' %}" class="payup-chip">
          <i class="fa-solid fa-arrow-right" aria-hidden="true"></i>
          إلغاء والعودة
        </a>
      </div>
    </div>

    <div class="payup-body">
      <form method="post" enctype="multipart/form-data" novalidate>
        {% csrf_token %}

        <div class="payup-grid">
          <div class="group">
            <label class="label" for="id_amount">
              <i class="fa-solid fa-coins" aria-hidden="true"></i>
              المبلغ المحول (ريال)
            </label>

            <input
              id="id_amount"
              type="number"
              name="amount"
              step="0.01"
              min="0"
              inputmode="decimal"
              required
              value="{{ form.amount.value|default_if_none:'' }}"
              autocomplete="off"
            >

            {% if form and form.amount and form.amount.errors %}
              <div class="field-error">
                {% for e in form.amount.errors %}{{ e }}{% endfor %}
              </div>
            {% endif %}

            <div class="hint">اكتب مبلغ التحويل كما هو في الإيصال.</div>
          </div>

          <div class="group">
            <label class="label" for="id_receipt">
              <i class="fa-solid fa-image" aria-hidden="true"></i>
              صورة الإيصال
            </label>

            <input
              id="id_receipt"
              type="file"
              name="receipt_image"
              accept="image/*"
              {% if not form or not form.receipt_image.value %}required{% endif %}
            >

            {% if form and form.receipt_image and form.receipt_image.errors %}
              <div class="field-error">
                {% for e in form.receipt_image.errors %}{{ e }}{% endfor %}
              </div>
            {% endif %}

            <div class="hint">يفضّل صورة واضحة. (صور فقط)</div>

            <div class="preview" id="previewBox" aria-live="polite">
              <img id="previewImg" alt="معاينة الإيصال">
              <div class="preview-meta">
                <span id="previewName">—</span>
                <span id="previewSize">—</span>
              </div>
            </div>
          </div>

          <div class="group">
            <label class="label" for="id_notes">
              <i class="fa-regular fa-note-sticky" aria-hidden="true"></i>
              ملاحظات (اختياري)
            </label>

            <textarea
              id="id_notes"
              name="notes"
              rows="3"
              placeholder="أي تفاصيل إضافية..."
            >{{ form.notes.value|default_if_none:'' }}</textarea>

            {% if form and form.notes and form.notes.errors %}
              <div class="field-error">
                {% for e in form.notes.errors %}{{ e }}{% endfor %}
              </div>
            {% endif %}
          </div>
        </div>

        <div class="actions">
          <button type="submit" class="btn btn-primary" id="submitBtn" style="flex:1">
            <i class="fa-solid fa-paper-plane" aria-hidden="true"></i>
            إرسال الطلب
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script nonce="{{ CSP_NONCE }}">
(function(){
  const fileInput = document.getElementById('id_receipt');
  const box = document.getElementById('previewBox');
  const img = document.getElementById('previewImg');
  const nameEl = document.getElementById('previewName');
  const sizeEl = document.getElementById('previewSize');

  function prettySize(bytes){
    if(bytes === null || bytes === undefined) return '—';
    const units = ['B','KB','MB','GB'];
    let i = 0, n = bytes;
    while(n >= 1024 && i < units.length-1){ n = n/1024; i++; }
    return (i === 0 ? n.toFixed(0) : n.toFixed(1)) + ' ' + units[i];
  }

  function resetPreview(){
    if(box) box.style.display = 'none';
    if(img) img.removeAttribute('src');
    if(nameEl) nameEl.textContent = '—';
    if(sizeEl) sizeEl.textContent = '—';
  }

  if(fileInput){
    fileInput.addEventListener('change', function(){
      const f = this.files && this.files[0];
      if(!f){ resetPreview(); return; }

      nameEl.textContent = f.name || '—';
      sizeEl.textContent = prettySize(f.size);

      if(f.type && f.type.startsWith('image/')){
        const url = URL.createObjectURL(f);
        img.src = url;
        box.style.display = 'block';
        img.onload = function(){ URL.revokeObjectURL(url); };
      }else{
        resetPreview();
      }
    });
  }

  // منع الإرسال المزدوج (بدون كسر الرجوع عند أخطاء السيرفر)
  const form = document.querySelector('.payup-body form');
  const btn = document.getElementById('submitBtn');

  if(form && btn){
    form.addEventListener('submit', function(){
      btn.disabled = true;
      btn.style.opacity = ".78";
      btn.setAttribute('data-old-html', btn.innerHTML);
      btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin" aria-hidden="true"></i> جارٍ الإرسال...';
    });
  }

  // لو رجعت الصفحة بأخطاء Django (form.errors) نعيد تفعيل الزر
  try{
    const hasErrors = {{ form.errors|yesno:"true,false" }};
    if(hasErrors && btn){
      btn.disabled = false;
      btn.style.opacity = "1";
      const old = btn.getAttribute('data-old-html');
      if(old) btn.innerHTML = old;
      else btn.innerHTML = '<i class="fa-solid fa-paper-plane" aria-hidden="true"></i> إرسال الطلب';
    }
  }catch(e){
    // ignore
  }
})();
</script>
{% endblock %}
