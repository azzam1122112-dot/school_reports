{# templates/reports/department_form.html #}
{% extends "base.html" %}

{% block title %}{% if form.instance.pk %}ØªØ¹Ø¯ÙŠÙ„ Ù‚Ø³Ù…{% else %}Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù…{% endif %}{% endblock %}

{% block head %}
<style>
  /* =========================================================
     Department Form (page-only polish)
     - Scoped Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø¯Ø§Ø®Ù„ .dept-wrap Ù„ØªØ¬Ù†Ù‘Ø¨ ØªØ¹Ø§Ø±Ø¶Ø§Øª base/app.css
     - Ø¨Ø¯ÙˆÙ† Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹Ø±ÙŠÙ .card / .btn Ø§Ù„Ø¹Ø§Ù…Ø© (ÙÙ‚Ø· ØªØ®ØµÙŠØµ Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙØ­Ø©)
     - Ø¯Ø¹Ù… Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ† Ø¹Ø¨Ø± html[data-theme="dark"]
     ========================================================= */

  .dept-wrap{
    --d-radius: 18px;
    --d-shadow: 0 12px 34px rgba(2,6,23,.08);
    --t: var(--t-fast);
    max-width: 980px;
    margin: 24px auto;
    padding: 0 16px;
  }

  .dept-crumbs{
    color: var(--muted);
    font-weight: 800;
    font-size: .92rem;
    margin-bottom: 10px;
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    align-items:center;
  }
  .dept-crumbs a{
    color: inherit;
    text-decoration:none;
  }
  .dept-crumbs a:hover{ text-decoration: underline; }

  .dept-card{
    border-radius: var(--d-radius);
    box-shadow: var(--d-shadow);
    padding: 18px;
  }
  @media(min-width: 720px){
    .dept-card{ padding: 22px; }
  }

  .dept-title{
    display:flex;
    align-items:center;
    gap:10px;
    font-weight: 950;
    font-size: 1.18rem;
    margin: 0 0 6px;
    color: var(--ink);
  }

  .dept-sub{
    color: var(--muted);
    font-weight: 800;
    font-size: .93rem;
    margin-bottom: 12px;
    line-height: 1.8;
  }

  .dept-grid{ display:grid; gap:16px; }
  .dept-row{ display:grid; gap:14px; }
  @media(min-width:780px){
    .dept-row{ grid-template-columns: 1fr 1fr; }
  }

  .dept-label{
    font-weight: 900;
    margin-bottom: 6px;
    display:block;
    color: var(--ink);
  }

  .dept-help{
    color: var(--muted);
    font-size: .88rem;
    font-weight: 800;
    margin-top: 6px;
    line-height: 1.7;
  }

  /* Ù…Ø¯Ø®Ù„Ø§Øª: Ù†Ø¹ØªÙ…Ø¯ class=control Ù…Ù† base (ÙˆÙ†Ø¶ÙŠÙÙ‡Ø§ JS) */
  .dept-wrap .control{
    width:100%;
    border-radius: 12px;
    transition: var(--t);
  }
  .dept-wrap .control[readonly]{
    opacity:.9;
    background: rgba(148,163,184,.10);
  }
  html[data-theme="dark"] .dept-wrap .control[readonly]{
    background: rgba(148,163,184,.08);
  }

  textarea.control{ min-height: 110px; resize: vertical; }

  .dept-switch{
    display:flex;
    gap:10px;
    align-items:center;
    user-select:none;
    font-weight: 850;
    color: var(--ink);
  }
  .dept-switch input{ transform: translateY(1px); }

  /* Ø±Ø³Ø§Ø¦Ù„ Ø£Ø®Ø·Ø§Ø¡ */
  .dept-errors{
    border: 1px solid rgba(239,68,68,.25);
    background: rgba(239,68,68,.10);
    color: var(--ink);
    border-radius: 14px;
    padding: 12px;
    margin-bottom: 12px;
    font-weight: 850;
    line-height: 1.8;
  }
  .dept-err{
    color: rgba(239,68,68,.95);
    background: rgba(239,68,68,.08);
    border: 1px solid rgba(239,68,68,.22);
    border-radius: 12px;
    padding: 8px 10px;
    margin-top: 6px;
    font-weight: 850;
    font-size: .92rem;
  }

  /* Ù…Ù„Ø§Ø­Ø¸Ø§Øª */
  .dept-note{
    border: 1px solid rgba(37,99,235,.22);
    background: rgba(37,99,235,.10);
    border-radius: 14px;
    padding: 12px;
    margin-bottom: 12px;
    font-weight: 850;
    line-height: 1.8;
    color: var(--ink);
  }
  .dept-note.warn{
    border-color: rgba(217,119,6,.26);
    background: rgba(217,119,6,.10);
  }
  .dept-note.ok{
    border-color: rgba(22,163,74,.22);
    background: rgba(22,163,74,.10);
  }

  /* Ø´Ø§Ø±Ø§Øª/Ù…Ø¹Ø§ÙŠÙ†Ø© */
  .dept-kbd{
    font: 800 .84rem ui-monospace,SFMono-Regular,Menlo,monospace;
    background: rgba(148,163,184,.12);
    border: 1px solid var(--line);
    border-radius: 10px;
    padding: 2px 8px;
  }

  .dept-preview{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    margin-top: 8px;
  }
  .dept-pill{
    display:inline-flex;
    align-items:center;
    gap:10px;
    border: 1px solid var(--line);
    border-radius: 999px;
    padding: 8px 12px;
    background: var(--card);
    font-weight: 900;
    color: var(--ink);
  }
  .dept-pill.role{
    background: rgba(37,99,235,.10);
    border-color: rgba(37,99,235,.22);
  }

  /* reporttypes widget */
  .rt-box{ display:grid; gap:10px; }
  .rt-actions{
    display:grid;
    gap:10px;
  }
  @media(min-width: 720px){
    .rt-actions{
      grid-template-columns: 1fr auto auto auto;
      align-items:center;
    }
  }
  .rt-actions .btn{
    min-height: 44px;
    border-radius: 12px;
  }

  .dept-badge{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:8px;
    padding: 8px 12px;
    border-radius: 999px;
    background: rgba(37,99,235,.10);
    border: 1px solid rgba(37,99,235,.22);
    font-weight: 950;
    color: var(--ink);
    white-space: nowrap;
  }
  .dept-muted{ color: var(--muted); font-weight: 850; font-size: .9rem; line-height: 1.7; }

  /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØµÙØ­Ø© (Ø¶Ù…Ù†ÙŠØ© Ø¯Ø§Ø®Ù„ wrap ÙÙ‚Ø·) */
  .dept-actions{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    margin-top: 18px;
    align-items:center;
  }
  .dept-wrap .btn{
    border-radius: 12px;
    min-height: 44px;
    transition: var(--t);
  }
  .dept-wrap .btn:hover{ transform: translateY(-1px); }

  /* Ø²Ø± Ø§Ù„Ø­Ø°Ù: Ø§Ø¹ØªÙ…ÙØ¯ btn-danger Ø¥Ù† ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ØŒ ÙˆØ¥Ù„Ø§ Ø­Ø³Ù‘Ù†Ù‡ Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙØ­Ø© */
  .dept-wrap .btn.btn-danger{
    background: #b91c1c;
    border-color: transparent;
    color: #fff;
  }
  .dept-wrap .btn.btn-danger:hover{
    background: #991b1b;
  }

  @media (prefers-reduced-motion: reduce){
    .dept-wrap .btn{ transition:none !important; }
    .dept-wrap .btn:hover{ transform:none !important; }
  }
</style>
{% endblock head %}

{% block content %}
<div class="dept-wrap" dir="rtl">
  <div class="dept-crumbs">
    <a href="{% url 'reports:admin_dashboard' %}">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±</a>
    <span>Â·</span>
    <a href="{% url 'reports:departments_list' %}">Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</a>
    <span>Â·</span>
    <span>{% if form.instance.pk %}ØªØ¹Ø¯ÙŠÙ„ Ù‚Ø³Ù…{% else %}Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù…{% endif %}</span>
  </div>

  <div class="card dept-card">
    <h2 class="dept-title">
      {% if form.instance.pk %}âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ù‚Ø³Ù…{% else %}â• Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù…{% endif %}
    </h2>

    <div class="dept-sub">
      Ø³ÙŠØ¸Ù‡Ø± Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… ÙƒÙ€ <em>Ø¯ÙˆØ±</em> ÙÙŠ Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ù…Ø¹Ù„Ù‘Ù…ÙŠÙ† Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… <strong>Ø§Ù„ÙƒÙˆØ¯ (slug)</strong> ÙƒÙ‚ÙŠÙ…Ø©ØŒ
      ÙˆÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø­ÙØ¸ Ø³Ø±ÙŠØ¹Ù‹Ø§ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… <span class="dept-kbd">Ctrl/âŒ˜ + S</span>.
    </div>

    {% if form.non_field_errors %}
      <div class="dept-errors" role="alert" aria-live="polite">
        {% for e in form.non_field_errors %}â€¢ {{ e }}<br>{% endfor %}
      </div>
    {% endif %}

    {# Ø´Ø§Ø±Ø© Ø­Ø§Ù„Ø© Ø®Ø§ØµØ© Ù„Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø­Ø¬ÙˆØ²Ø© #}
    {% with current_slug=form.slug.value|default:form.instance.slug %}
      {% if current_slug == "manager" %}
        <div class="dept-note ok">
          <strong>Ù‚Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¯Ø§Ø¦Ù…</strong> â€” Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ù…Ø­Ø¬ÙˆØ² Ø¨Ù€ <code>slug=manager</code> ÙˆÙŠØªÙ…ØªØ¹ Ø¨ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø¯ÙŠØ±.
          Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ± ÙƒÙˆØ¯Ù‡ØŒ ÙˆÙŠÙ…ÙƒÙ†Ùƒ ÙÙ‚Ø· Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸ÙÙŠÙ† Ù„Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡.
        </div>
      {% elif current_slug == "teachers" %}
        <div class="dept-note warn">
          <strong>Ù‚Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù‘Ù…ÙŠÙ†</strong> â€” Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ù…Ø®ØµØµ Ù„Ø­Ø³Ø§Ø¨Ø§Øª "Ù…Ø¹Ù„Ù…". ÙŠÙØ¶Ù‘Ù„ Ø¹Ø¯Ù… ØªØºÙŠÙŠØ± ÙƒÙˆØ¯Ù‡ Ø­ØªÙ‰ Ù„Ø§ ØªØªØ£Ø«Ø± Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª.
        </div>
      {% endif %}
    {% endwith %}

    <form method="post" class="dept-grid" novalidate id="deptForm">
      {% csrf_token %}

      <div class="dept-row">
        <div>
          <label class="dept-label" for="{{ form.name.id_for_label }}">Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…</label>
          {{ form.name }}
          {% if form.name.help_text %}<div class="dept-help">{{ form.name.help_text }}</div>{% endif %}
          {% for e in form.name.errors %}<div class="dept-err">â€¢ {{ e }}</div>{% endfor %}
        </div>

        <div>
          <label class="dept-label" for="{{ form.slug.id_for_label }}">Ø§Ù„ÙƒÙˆØ¯ (slug)</label>
          {{ form.slug }}
          {% for e in form.slug.errors %}<div class="dept-err">â€¢ {{ e }}</div>{% endfor %}
          <div class="dept-help">Ù‚ØµÙŠØ± ÙˆÙØ±ÙŠØ¯ (Ù…Ø«Ø§Ù„: <b>activity</b>). ÙŠÙØ³ØªØ®Ø¯Ù… Ø£ÙŠØ¶Ù‹Ø§ ÙƒÙ‚ÙŠÙ…Ø© â€œØ§Ù„Ø¯ÙˆØ±â€.</div>

          <label class="dept-switch" style="margin-top:10px">
            <input type="checkbox" id="autoSlug" checked>
            ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† Ø§Ù„Ø§Ø³Ù… (Ù…Ø¹ Ø®Ø±Ø§Ø¦Ø· Ø®Ø§ØµØ© Ù„Ù„Ù…Ù†ØµØ©)
          </label>
        </div>
      </div>

      {% if form.description %}
        <div>
          <label class="dept-label" for="{{ form.description.id_for_label }}">Ø§Ù„ÙˆØµÙ</label>
          {{ form.description }}
          {% for e in form.description.errors %}<div class="dept-err">â€¢ {{ e }}</div>{% endfor %}
        </div>
      {% endif %}

      <div>
        <label class="dept-switch">
          {{ form.is_active }} Ù†Ø´Ø·
        </label>
        {% for e in form.is_active.errors %}<div class="dept-err">â€¢ {{ e }}</div>{% endfor %}
      </div>

      {% if form.reporttypes %}
        <div>
          <label class="dept-label" for="{{ form.reporttypes.id_for_label }}">Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©</label>

          <div class="rt-box">
            <div class="rt-actions">
              <input
                id="rtSearch"
                type="search"
                class="control"
                placeholder="Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹..."
                aria-label="Ø¨Ø­Ø« ÙÙŠ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±"
              >
              <button type="button" class="btn" id="rtSelectAll">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¸Ø§Ù‡Ø±Ø©</button>
              <button type="button" class="btn" id="rtClearAll">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙƒÙ„</button>
              <span class="dept-badge"><span id="rtCount">0</span> Ù…Ø®ØªØ§Ø±Ø©</span>
            </div>

            <div class="dept-muted">
              Ø§Ø®ØªÙŠØ§Ø±Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… ØªÙØ²Ø§Ù…ÙÙ† ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ø¹ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ù…ÙˆØ§Ø²ÙŠ.
            </div>

            {{ form.reporttypes }}

            {% if form.reporttypes.help_text %}<div class="dept-help">{{ form.reporttypes.help_text }}</div>{% endif %}
            {% for e in form.reporttypes.errors %}<div class="dept-err">â€¢ {{ e }}</div>{% endfor %}
          </div>
        </div>
      {% endif %}

      <div>
        <div class="dept-help">Ù…Ø¹Ø§ÙŠÙ†Ø© ÙƒÙŠÙ Ø³ÙŠØ¸Ù‡Ø± Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… ÙƒØ®ÙŠØ§Ø± â€œØ¯ÙˆØ±â€:</div>
        <div class="dept-preview" id="rolePreview">
          <span class="dept-pill role" title="Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¯ÙˆØ± (slug)">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M3 6h18M3 12h12M3 18h8" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
            </svg>
            <span id="pvCode">â€”</span>
          </span>

          <span class="dept-pill" title="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M12 6v12M6 12h12" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/>
            </svg>
            <span id="pvLabel">â€”</span>
          </span>
        </div>
      </div>

      {% for h in form.hidden_fields %}{{ h }}{% endfor %}

      <div class="dept-actions">
        <button class="btn btn-primary" type="submit">ğŸ’¾ Ø­ÙØ¸</button>
        <a class="btn btn-ghost" href="{% url 'reports:departments_list' %}">â†©ï¸ Ø±Ø¬ÙˆØ¹</a>
      </div>
    </form>

    {# Ù…Ù‡Ù…: Ù„Ø§ ØªØ¶Ø¹ form Ø¯Ø§Ø®Ù„ form #}
    {% if form.instance.pk %}
      <form method="post"
            action="{% url 'reports:department_delete' code=form.instance.slug %}"
            style="margin-top:12px"
            onsubmit="return confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ØŸ');">
        {% csrf_token %}
        <button class="btn btn-danger" type="submit">ğŸ—‘ Ø­Ø°Ù</button>
      </form>
    {% endif %}
  </div>
</div>
{% endblock content %}

{% block scripts %}
<script nonce="{{ CSP_NONCE }}">
  // Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù .control Ù„ÙƒÙ„ Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ (Ù…Ø¯Ø®Ù„Ø§Øª Ù†Øµ/ØªØ­Ø¯ÙŠØ¯ ÙÙ‚Ø·)
  (function(){
    var form = document.getElementById('deptForm');
    if(!form) return;
    var sel = 'input[type=text], input[type=url], input[type=email], input[type=search], textarea, select';
    form.querySelectorAll(sel).forEach(function(el){
      if(!el.classList.contains('control')) el.classList.add('control');
    });
  })();

  // Ø®Ø±Ø§Ø¦Ø· Ø§Ù„Ù…Ù†ØµØ© Ù„Ù„Ø£Ø³Ù…Ø§Ø¡ â†’ slug
  var ALIASES = {
    "Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©":"manager","Ø§Ù„Ø§Ø¯Ø§Ø±Ø©":"manager","Ù…Ø¯ÙŠØ±":"manager",
    "Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†":"teachers","Ù…Ø¹Ù„Ù…ÙŠÙ†":"teachers",
    "Ø§Ù„Ù†Ø´Ø§Ø·":"activity",
    "Ø§Ù„ØªØ·ÙˆØ¹":"volunteer",
    "Ø§Ù„Ø´Ø¤ÙˆÙ† Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØ©":"affairs",
    "Ø§Ù„Ø´Ø¤ÙˆÙ† Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©":"admin","Ø§Ù„Ø´Ø¤ÙˆÙ† Ø§Ù„Ø§Ø¯Ø§Ø±ÙŠØ©":"admin"
  };

  function normArabicDigits(s){
    return (s || '').replace(/[Ù -Ù©]/g, function(d){
      return String("Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©".indexOf(d));
    });
  }

  function translitArabic(s){
    var map = {
      'Ø§':'a','Ø£':'a','Ø¥':'i','Ø¢':'a','Ø¡':'','Ø¤':'w','Ø¦':'y','Ø¨':'b','Øª':'t','Ø«':'th','Ø¬':'j','Ø­':'h','Ø®':'kh',
      'Ø¯':'d','Ø°':'dh','Ø±':'r','Ø²':'z','Ø³':'s','Ø´':'sh','Øµ':'s','Ø¶':'d','Ø·':'t','Ø¸':'z','Ø¹':'a','Øº':'gh',
      'Ù':'f','Ù‚':'q','Ùƒ':'k','Ù„':'l','Ù…':'m','Ù†':'n','Ù‡':'h','Ø©':'h','Ùˆ':'w','ÙŠ':'y','Ù‰':'a','ï»»':'la','Ù„Ø§':'la'
    };
    return (s || '')
      .replace(/[\u064B-\u065F]/g,'')
      .split('')
      .map(function(ch){
        return (map[ch] !== undefined) ? map[ch] : ch;
      })
      .join('');
  }

  function slugifyAscii(s){
    s = (s || '').trim();
    if(ALIASES[s]) return ALIASES[s];

    s = normArabicDigits(s);
    s = translitArabic(s);

    try{ s = s.normalize('NFKD'); }catch(e){}

    s = s.replace(/[\u064B-\u065F]/g,'');
    s = s.replace(/[\s_]+/g,'-');
    s = s.replace(/[^a-zA-Z0-9-]/g,'');
    s = s.toLowerCase().replace(/-+/g,'-').replace(/^-+|-+$/g,'');

    return s;
  }

  (function(){
    var name = document.getElementById("{{ form.name.id_for_label }}");
    var slug = document.getElementById("{{ form.slug.id_for_label }}");
    var auto = document.getElementById("autoSlug");
    var pvCode = document.getElementById("pvCode");
    var pvLabel = document.getElementById("pvLabel");
    var formEl = document.getElementById("deptForm");

    var isEdit = "{{ form.instance.pk|yesno:'1,0' }}" === "1";
    var initialSlug = (slug && slug.value) ? slug.value.trim() : "";

    if(isEdit && initialSlug){
      slug.dataset.touched = "1";
    }

    function updatePreview(){
      pvCode.textContent = (slug && slug.value) ? slug.value : "â€”";
      pvLabel.textContent = (name && name.value) ? name.value : "â€”";
    }

    function lockReserved(){
      if(!slug || !name) return;
      var v = (slug.value || "").toLowerCase();

      if(v === "manager"){
        name.readOnly = true;
        slug.readOnly = true;
        if(auto){
          auto.checked = false;
          auto.disabled = true;
        }
        return;
      }

      if(v === "teachers"){
        slug.readOnly = true;
        if(auto){
          auto.checked = false;
          auto.disabled = true;
        }
        name.readOnly = false;
        return;
      }

      name.readOnly = false;
      slug.readOnly = false;
      if(auto) auto.disabled = false;
    }

    function syncSlug(){
      if(!name || !slug) return;
      if(auto && !auto.checked) return;

      var generated = slugifyAscii(name.value);
      if(!generated) {
        updatePreview();
        lockReserved();
        return;
      }

      if(isEdit){
        if(!slug.value.trim()){
          slug.value = generated;
        }
      } else {
        if(!slug.dataset.touched || !slug.value.trim()){
          slug.value = generated;
        }
      }

      updatePreview();
      lockReserved();
    }

    if(name && slug){
      name.addEventListener("input", syncSlug);
      name.addEventListener("blur", syncSlug);

      if(auto){
        auto.addEventListener("change", function(){
          syncSlug();
        });
      }

      slug.addEventListener("input", function(){
        slug.dataset.touched = "1";
        updatePreview();
        lockReserved();
      });

      updatePreview();
      lockReserved();
      syncSlug();
    }

    // Ø­ÙØ¸ Ø³Ø±ÙŠØ¹: Ctrl/Cmd + S
    document.addEventListener("keydown", function(e){
      if((e.ctrlKey || e.metaKey) && String(e.key || '').toLowerCase() === "s"){
        e.preventDefault();
        if(formEl){
          if(formEl.requestSubmit){
            formEl.requestSubmit();
          } else {
            formEl.submit();
          }
        }
      }
    });
  })();

  // Ø£Ø¯ÙˆØ§Øª reporttypes: ÙŠØ¯Ø¹Ù… SelectMultiple Ø£Ùˆ CheckboxSelectMultiple
  (function(){
    var box = document.getElementById('rtSearch') ? document.getElementById('rtSearch').closest('.rt-box') : null;
    if(!box) return;

    var search  = document.getElementById('rtSearch');
    var btnAll  = document.getElementById('rtSelectAll');
    var btnClr  = document.getElementById('rtClearAll');
    var counter = document.getElementById('rtCount');

    var selectEl = box.querySelector('select[multiple][name="{{ form.reporttypes.html_name }}"]');
    var checkboxEls = Array.prototype.slice.call(
      box.querySelectorAll('input[type="checkbox"][name="{{ form.reporttypes.html_name }}"]')
    );

    function getLabelNode(cb){
      return cb.closest('label') || cb.closest('li') || cb.parentElement;
    }

    function updateCount(){
      var c = 0;
      if(selectEl){
        Array.prototype.slice.call(selectEl.options).forEach(function(o){
          if(o.selected) c += 1;
        });
      } else {
        checkboxEls.forEach(function(cb){
          if(cb.checked) c += 1;
        });
      }
      if(counter) counter.textContent = String(c);
    }

    function applyFilter(){
      var q = (search && search.value) ? search.value.trim().toLowerCase() : "";

      if(selectEl){
        Array.prototype.slice.call(selectEl.options).forEach(function(o){
          var txt = (o.text || '').toLowerCase();
          o.hidden = !!q && !txt.includes(q);
        });
      } else {
        checkboxEls.forEach(function(cb){
          var node = getLabelNode(cb);
          var txt = (node && node.textContent) ? node.textContent.toLowerCase() : "";
          if(node) node.style.display = (!q || txt.includes(q)) ? '' : 'none';
        });
      }
    }

    if(btnAll){
      btnAll.addEventListener('click', function(){
        var q = (search && search.value) ? search.value.trim().toLowerCase() : "";

        if(selectEl){
          Array.prototype.slice.call(selectEl.options).forEach(function(o){
            var txt = (o.text || '').toLowerCase();
            if(!q || txt.includes(q)) o.selected = true;
          });
        } else {
          checkboxEls.forEach(function(cb){
            var node = getLabelNode(cb);
            var visible = !node || node.style.display !== 'none';
            var txt = (node && node.textContent) ? node.textContent.toLowerCase() : "";
            if(visible && (!q || txt.includes(q))) cb.checked = true;
          });
        }
        updateCount();
      });
    }

    if(btnClr){
      btnClr.addEventListener('click', function(){
        if(selectEl){
          Array.prototype.slice.call(selectEl.options).forEach(function(o){ o.selected = false; });
        } else {
          checkboxEls.forEach(function(cb){ cb.checked = false; });
        }
        updateCount();
      });
    }

    if(search){
      search.addEventListener('input', applyFilter);
      search.addEventListener('keydown', function(e){
        if(e.key === 'Enter') e.preventDefault();
      });
    }

    if(selectEl){
      selectEl.addEventListener('change', updateCount);
    } else {
      checkboxEls.forEach(function(cb){
        cb.addEventListener('change', updateCount);
      });
    }

    applyFilter();
    updateCount();
  })();
</script>
{% endblock scripts %}
