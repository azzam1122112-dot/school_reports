{# reports/templates/reports/circular_detail.html #}
{% extends "base.html" %}
{% load static %}

{% block title %}تفاصيل التعميم{% endblock %}

{% block head %}
<style>
  /* =========================================================
     Circular Detail (Admin) — 2026 UI
     - Modern, responsive, dark-mode friendly
     - Clear toggle (checkbox) + search + recipients filters
     ========================================================= */

  .cd-scope{
    --cd-ink: var(--ink, #0f172a);
    --cd-muted: var(--muted, #64748b);
    --cd-line: var(--line, #e5e7eb);
    --cd-card: var(--card, #ffffff);
    --cd-soft: var(--line-2, #f1f5f9);
    --cd-shadow: 0 16px 42px rgba(2,6,23,.10);
    --cd-brand: var(--brand, #2563eb);
    --cd-brand2: #7c3aed;
    --cd-brand-ghost: rgba(37,99,235,.10);
    --cd-danger: #ef4444;
    --cd-success: #10b981;
    --cd-warn: #f59e0b;
    --cd-t: var(--t-fast, .18s ease);
  }

  .cd-scope .cd-wrap{max-width:1180px;margin:0 auto;padding:18px}

  .cd-scope .cd-hero{
    border-radius:18px;
    border:1px solid rgba(148,163,184,.35);
    background:
      radial-gradient(1200px 300px at 100% 0%, rgba(37,99,235,.12), transparent 60%),
      radial-gradient(900px 300px at 0% 0%, rgba(124,58,237,.10), transparent 60%),
      linear-gradient(180deg, var(--cd-soft), var(--cd-card));
    box-shadow: var(--cd-shadow);
    overflow:hidden;
  }
  html[data-theme="dark"] .cd-scope .cd-hero{
    box-shadow: 0 22px 64px rgba(0,0,0,.45);
    border-color: rgba(148,163,184,.25);
  }

  .cd-scope .cd-head{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap;padding:16px}
  .cd-scope .cd-title{margin:0;font-weight:1000;letter-spacing:-.2px;color:var(--cd-ink)}
  .cd-scope .cd-sub{color:var(--cd-muted);font-weight:850;margin-top:4px}

  .cd-scope .cd-actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .cd-scope .cd-btn{
    display:inline-flex;align-items:center;gap:8px;
    padding:10px 14px;border-radius:14px;
    border:1px solid var(--cd-line);
    background: var(--cd-card);
    color: var(--cd-ink);
    font-weight:950;text-decoration:none;
    transition: transform var(--cd-t), box-shadow var(--cd-t), border-color var(--cd-t), background var(--cd-t);
    min-height:44px;
  }
  .cd-scope .cd-btn:hover{transform:translateY(-1px);box-shadow: 0 14px 28px rgba(2,6,23,.10);border-color: rgba(37,99,235,.25)}
  .cd-scope .cd-btn.primary{background: linear-gradient(135deg, var(--cd-brand), var(--cd-brand2));border-color: transparent;color:#fff}
  .cd-scope .cd-btn.primary:hover{box-shadow: 0 18px 34px rgba(37,99,235,.22)}
  html[data-theme="dark"] .cd-scope .cd-btn{background: rgba(255,255,255,.06)}

  .cd-scope .cd-pills{display:flex;gap:8px;flex-wrap:wrap;align-items:center;padding:0 16px 14px}
  .cd-scope .pill{
    display:inline-flex;align-items:center;gap:6px;
    padding:7px 10px;border-radius:999px;
    border:1px solid rgba(148,163,184,.35);
    background: rgba(248,250,252,.75);
    color: var(--cd-ink);
    font-weight:950;font-size:.86rem;
    white-space:nowrap;
  }
  html[data-theme="dark"] .cd-scope .pill{background: rgba(2,6,23,.20)}
  .cd-scope .pill.important{background: rgba(239,68,68,.10);border-color: rgba(239,68,68,.22);color:#b91c1c}
  .cd-scope .pill.blue{background: rgba(37,99,235,.10);border-color: rgba(37,99,235,.22);color:#1e40af}
  .cd-scope .pill.success{background: rgba(16,185,129,.12);border-color: rgba(16,185,129,.22);color:#166534}
  .cd-scope .pill.warn{background: rgba(245,158,11,.14);border-color: rgba(245,158,11,.22);color:#92400e}

  .cd-scope .cd-grid{display:grid;gap:14px;margin-top:14px}
  @media(min-width: 1050px){.cd-scope .cd-grid{grid-template-columns:1.2fr .8fr}}

  .cd-scope .card{background: var(--cd-card);border:1px solid var(--cd-line);border-radius:18px;box-shadow: var(--cd-shadow);overflow:hidden}
  .cd-scope .card-hd{padding:14px 16px;border-bottom:1px solid var(--cd-line);display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;background:linear-gradient(180deg,var(--cd-soft),var(--cd-card))}
  .cd-scope .card-bd{padding:16px}

  .cd-scope .doc{line-height:1.95;color:var(--cd-ink);font-weight:850}
  .cd-scope .doc-box{
    border:1px solid rgba(148,163,184,.35);
    border-radius:16px;
    padding:14px;
    background: linear-gradient(180deg, var(--cd-card), rgba(248,250,252,.60));
  }
  html[data-theme="dark"] .cd-scope .doc-box{background: linear-gradient(180deg, var(--cd-card), rgba(2,6,23,.22))}

  .cd-scope .kpi{display:grid;gap:10px;grid-template-columns:repeat(3,minmax(0,1fr))}
  @media(max-width: 520px){.cd-scope .kpi{grid-template-columns:1fr}}
  .cd-scope .kpi .k{
    border:1px solid rgba(148,163,184,.35);
    background: rgba(248,250,252,.75);
    border-radius:16px;
    padding:12px;
  }
  html[data-theme="dark"] .cd-scope .kpi .k{background: rgba(2,6,23,.18)}
  .cd-scope .k .lbl{color:var(--cd-muted);font-weight:900;font-size:.88rem}
  .cd-scope .k .val{font-weight:1000;font-size:1.35rem;color:var(--cd-ink);margin-top:2px}

  .cd-scope .field-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .cd-scope .search{
    flex:1;
    min-width:220px;
    border:1px solid var(--cd-line);
    border-radius:14px;
    padding:10px 12px;
    font:inherit;
    min-height:44px;
    background: var(--cd-card);
    color: var(--cd-ink);
    outline:none;
    font-weight:850;
  }
  .cd-scope .search:focus{border-color: rgba(37,99,235,.35);box-shadow: 0 0 0 4px rgba(37,99,235,.12)}

  .cd-scope .toggle{
    display:inline-flex;
    align-items:center;
    gap:10px;
    padding:9px 12px;
    border-radius:14px;
    border:1px solid var(--cd-line);
    background: var(--cd-card);
    user-select:none;
    cursor:pointer;
    min-height:44px;
    font-weight:950;
    color: var(--cd-ink);
  }
  .cd-scope .toggle input{position:absolute;opacity:0;pointer-events:none}
  .cd-scope .switch{
    width:44px;height:26px;border-radius:999px;
    background: rgba(100,116,139,.25);
    border:1px solid rgba(148,163,184,.45);
    position:relative;
    transition: background var(--cd-t), border-color var(--cd-t);
    flex:0 0 auto;
  }
  .cd-scope .switch::after{
    content:"";
    width:20px;height:20px;border-radius:999px;
    background: var(--cd-card);
    border:1px solid rgba(148,163,184,.45);
    position:absolute;top:2px;right:2px;
    transition: transform var(--cd-t);
    box-shadow: 0 6px 14px rgba(2,6,23,.18);
  }
  .cd-scope .toggle input:checked + .switch{background: rgba(16,185,129,.22);border-color: rgba(16,185,129,.35)}
  .cd-scope .toggle input:checked + .switch::after{transform: translateX(-18px)}

  .cd-scope .table-wrap{overflow:auto;border-radius:18px;border:1px solid var(--cd-line)}
  .cd-scope table{width:100%;border-collapse:separate;border-spacing:0;background: var(--cd-card)}
  .cd-scope thead th{
    position:sticky;top:0;z-index:1;
    background: linear-gradient(180deg, var(--cd-soft), var(--cd-card));
    padding:11px 12px;
    border-bottom:1px solid var(--cd-line);
    text-align:right;
    font-weight:1000;
    color: var(--cd-ink);
    white-space:nowrap;
  }
  .cd-scope tbody td{padding:11px 12px;border-bottom:1px solid var(--cd-line);text-align:right;font-weight:850;color:var(--cd-ink);white-space:nowrap}
  .cd-scope tbody tr:nth-child(even){background: rgba(248,250,252,.55)}
  html[data-theme="dark"] .cd-scope tbody tr:nth-child(even){background: rgba(2,6,23,.18)}
  .cd-scope tbody tr:last-child td{border-bottom:none}

  .cd-scope .badge{
    display:inline-flex;align-items:center;gap:6px;
    padding:6px 10px;border-radius:999px;
    font-weight:1000;font-size:.86rem;
    border:1px solid transparent;
  }
  .cd-scope .badge.yes{background: rgba(16,185,129,.12);border-color: rgba(16,185,129,.22);color:#166534}
  .cd-scope .badge.no{background: rgba(239,68,68,.10);border-color: rgba(239,68,68,.22);color:#b91c1c}

  @media (prefers-reduced-motion: reduce){
    .cd-scope .cd-btn, .cd-scope .switch, .cd-scope .switch::after{transition:none !important;}
    .cd-scope .cd-btn:hover{transform:none !important;}
  }
</style>
{% endblock %}

{% block content %}
<div class="cd-scope" dir="rtl">
  <div class="cd-wrap">

    <section class="cd-hero" aria-label="معلومات التعميم">
      <header class="cd-head">
        <div>
          <h1 class="cd-title">تفاصيل التعميم</h1>
          <div class="cd-sub">عرض الرسالة + حالة وصولها للمستلمين + حالة التوقيع بشكل احترافي</div>
        </div>

        <div class="cd-actions">
          <a class="cd-btn" href="{% url 'reports:circulars_sent' %}">
            <i class="fa-solid fa-arrow-right" aria-hidden="true"></i>
            رجوع إلى التعاميم
          </a>
          <a class="cd-btn primary" href="{% url 'reports:notification_signatures_print' n.pk %}">
            <i class="fa-solid fa-print" aria-hidden="true"></i>
            طباعة التواقيع
          </a>
          <a class="cd-btn" href="{% url 'reports:notification_signatures_csv' n.pk %}">
            <i class="fa-solid fa-file-csv" aria-hidden="true"></i>
            CSV
          </a>
        </div>
      </header>

      <div class="cd-pills">
        <span class="pill blue"><i class="fa-solid fa-pen-to-square" aria-hidden="true"></i> تعميم بتوقيع</span>
        {% if n.is_important %}<span class="pill important"><i class="fa-solid fa-circle-exclamation" aria-hidden="true"></i> هام</span>{% endif %}
        {% if n.is_broadcast %}<span class="pill blue"><i class="fa-solid fa-bullhorn" aria-hidden="true"></i> للجميع</span>{% endif %}
        {% if n.created_at %}<span class="pill"><i class="fa-regular fa-clock" aria-hidden="true"></i> {{ n.created_at|date:"Y-m-d H:i" }}</span>{% endif %}
        {% if n.attachment %}
          <a class="pill" href="{{ n.attachment.url }}" target="_blank" rel="noopener" style="text-decoration:none">
            <i class="fa-solid fa-paperclip" aria-hidden="true"></i> مرفق
          </a>
        {% endif %}
      </div>
    </section>

    <div class="cd-grid">
      <!-- Left: Document body -->
      <section class="card" aria-label="نص التعميم">
        <div class="card-hd">
          <strong style="font-weight:1000">{{ n.title|default:"تعميم" }}</strong>
          {% if signature_stats %}
            <span class="pill warn" id="cdShownCount">{{ signature_stats.unsigned }} بانتظار التوقيع</span>
          {% endif %}
        </div>
        <div class="card-bd">
          {% if body %}
            <div class="doc-box">
              <div class="doc">{{ body|linebreaksbr }}</div>
            </div>
          {% else %}
            <div class="cd-sub">لا يوجد محتوى نصي.</div>
          {% endif %}

          <div style="margin-top:14px;display:grid;gap:12px">
            {% if signature_stats %}
              <div class="kpi" aria-label="إحصائيات التوقيع">
                <div class="k">
                  <div class="lbl">الإجمالي</div>
                  <div class="val">{{ signature_stats.total }}</div>
                </div>
                <div class="k">
                  <div class="lbl">الموقّع</div>
                  <div class="val" style="color:#166534">{{ signature_stats.signed }}</div>
                </div>
                <div class="k">
                  <div class="lbl">غير الموقّع</div>
                  <div class="val" style="color:#b91c1c">{{ signature_stats.unsigned }}</div>
                </div>
              </div>
            {% endif %}

            {% if n.signature_deadline_at or n.signature_ack_text %}
              <div class="doc-box" aria-label="متطلبات الإقرار">
                <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px">
                  <span class="pill blue"><i class="fa-solid fa-file-contract" aria-hidden="true"></i> متطلبات الإقرار</span>
                  {% if n.signature_deadline_at %}
                    <span class="pill warn"><i class="fa-regular fa-clock" aria-hidden="true"></i> ينتهي: {{ n.signature_deadline_at|date:"Y-m-d H:i" }}</span>
                  {% endif %}
                </div>
                {% if n.signature_ack_text %}
                  <div class="doc" style="background:rgba(37,99,235,.06);border:1px dashed rgba(37,99,235,.25);border-radius:14px;padding:12px">
                    <div style="color:var(--cd-muted);font-weight:950;margin-bottom:6px">نص الإقرار الذي يراه المعلم:</div>
                    {{ n.signature_ack_text|linebreaksbr }}
                  </div>
                {% else %}
                  <div class="cd-sub">لا يوجد نص إقرار مخصص.</div>
                {% endif %}
              </div>
            {% endif %}
          </div>
        </div>
      </section>

      <!-- Right: Recipients -->
      <section class="card" aria-label="حالة المستلمين">
        <div class="card-hd">
          <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
            <strong style="font-weight:1000">حالة المستلمين</strong>
            <span class="pill" id="cdTotal">{{ recipients|length }} مستلم</span>
            <span class="pill success" id="cdVisible" style="display:none"></span>
          </div>
          <span class="pill" style="opacity:.9">فلترة وبحث</span>
        </div>
        <div class="card-bd">
          <div class="field-row" style="margin-bottom:12px">
            <input id="cdSearch" class="search" type="search" placeholder="ابحث بالاسم أو الدور...">

            <label class="toggle" for="cdOnlyUnsigned" title="إظهار غير الموقّعين فقط">
              <input id="cdOnlyUnsigned" type="checkbox">
              <span class="switch" aria-hidden="true"></span>
              إظهار غير الموقّعين فقط
            </label>
          </div>

          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>الاسم</th>
                  <th>الدور</th>
                  <th>مقروء</th>
                  <th>وقت القراءة</th>
                  <th>موقّع</th>
                  <th>وقت التوقيع</th>
                </tr>
              </thead>
              <tbody id="cdRows">
                {% for r in recipients %}
                  <tr data-name="{{ r.name|default:'' }}" data-role="{{ r.role|default:'' }}" data-signed="{% if r.signed %}1{% else %}0{% endif %}">
                    <td>{{ r.name }}</td>
                    <td>{{ r.role }}</td>
                    <td>
                      {% if r.read %}
                        <span class="badge yes"><i class="fa-solid fa-circle-check" aria-hidden="true"></i> نعم</span>
                      {% else %}
                        <span class="badge no"><i class="fa-regular fa-circle" aria-hidden="true"></i> لا</span>
                      {% endif %}
                    </td>
                    <td>{{ r.read_at|default:"-" }}</td>
                    <td>
                      {% if r.signed %}
                        <span class="badge yes"><i class="fa-solid fa-pen-to-square" aria-hidden="true"></i> نعم</span>
                      {% else %}
                        <span class="badge no"><i class="fa-solid fa-pen-to-square" aria-hidden="true"></i> لا</span>
                      {% endif %}
                    </td>
                    <td>{{ r.signed_at|default:"-" }}</td>
                  </tr>
                {% empty %}
                  <tr><td colspan="6" style="text-align:center;color:var(--cd-muted)">لا يوجد مستلمون</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script{% if CSP_NONCE %} nonce="{{ CSP_NONCE }}"{% endif %}>
(function(){
  const search = document.getElementById('cdSearch');
  const onlyUnsigned = document.getElementById('cdOnlyUnsigned');
  const rowsWrap = document.getElementById('cdRows');
  const visiblePill = document.getElementById('cdVisible');
  const shownCountPill = document.getElementById('cdShownCount');

  if(!rowsWrap) return;

  function norm(s){
    return String(s || '').toLowerCase().trim();
  }

  function apply(){
    const q = norm(search ? search.value : '');
    const onlyU = !!(onlyUnsigned && onlyUnsigned.checked);

    const rows = Array.from(rowsWrap.querySelectorAll('tr[data-signed]'));
    let visible = 0;

    rows.forEach(tr => {
      const name = norm(tr.getAttribute('data-name'));
      const role = norm(tr.getAttribute('data-role'));
      const signed = (tr.getAttribute('data-signed') || '0') === '1';

      const passSigned = !onlyU || !signed;
      const passQuery = !q || name.includes(q) || role.includes(q);

      const ok = passSigned && passQuery;
      tr.style.display = ok ? '' : 'none';
      if(ok) visible++;
    });

    if(visiblePill){
      visiblePill.style.display = '';
      visiblePill.textContent = 'المعروض: ' + String(visible);
    }
    if(shownCountPill && onlyU){
      shownCountPill.textContent = String(visible) + ' بانتظار التوقيع';
    }
  }

  if(search){
    search.addEventListener('input', apply);
  }
  if(onlyUnsigned){
    onlyUnsigned.addEventListener('change', apply);
  }
  apply();
})();
</script>
{% endblock %}
