{% load static %}
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ملف الإنجاز - {{ file.teacher_name }} - {{ file.academic_year }}</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet" />

  <style>
    @page { size: A4; margin: 14mm 12mm; }

    :root {
      --font-body: 'Tajawal', DejaVu Sans, Tahoma, Arial, sans-serif;
      --ink: #111;
      --muted: #444;
      --line: #000;
      --shade: #f3f3f3;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: var(--font-body);
      background: #e5e5e5; /* معاينة فقط */
      color: var(--ink);
      -webkit-font-smoothing: antialiased;
    }

    /* A4 canvas */
    .page {
      width: 210mm;
      min-height: 297mm;
      margin: 18px auto;
      background: #fff;
      padding: 14mm 12mm 18mm;
      position: relative;
      box-shadow: 0 0 14px rgba(0,0,0,0.10);
    }

    @media print {
      body { background: #fff; }
      .page {
        width: auto;
        min-height: auto;
        margin: 0;
        padding: 0;
        box-shadow: none;
      }
      .no-print { display: none !important; }
      * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    }

    /* Toolbar (screen only) */
    .toolbar {
      position: sticky;
      top: 0;
      z-index: 100;
      background: #111;
      color: #fff;
      padding: 10px;
      text-align: center;
      display: flex;
      gap: 10px;
      justify-content: center;
      align-items: center;
      font-weight: 800;
    }

    .btn {
      background: #fff;
      color: #111;
      border: 1px solid rgba(0,0,0,0.15);
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-family: inherit;
      font-weight: 900;
      text-decoration: none;
      font-size: 14px;
    }
    .btn-print { background: #2563eb; color: #fff; border-color: #2563eb; }

    /* Official header */
    .header {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 10px;
      align-items: start;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--line);
    }
    .hdr-block {
      font-size: 13px;
      line-height: 1.7;
      font-weight: 800;
    }
    .hdr-center { text-align: center; }
    .hdr-right { text-align: right; }
    .hdr-left { text-align: left; direction: ltr; }
    .logo {
      height: 78px;
      width: auto;
      object-fit: contain;
      display: block;
      margin: 0 auto;
    }

    .title {
      text-align: center;
      margin: 14px 0 10px;
      font-weight: 1000;
      font-size: 20px;
    }
    .subtitle {
      text-align: center;
      margin: 0 0 14px;
      color: var(--muted);
      font-weight: 800;
      font-size: 13px;
    }

    .meta-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      margin: 0 0 14px;
    }
    .meta-table th, .meta-table td {
      border: 1px solid var(--line);
      padding: 9px 10px;
      vertical-align: top;
    }
    .meta-table th {
      background: var(--shade);
      font-weight: 900;
      width: 22%;
      white-space: nowrap;
      text-align: right;
    }
    .meta-table td { text-align: right; }

    .section {
      border: 1px solid var(--line);
      padding: 10px;
      margin: 0 0 14px;
      page-break-inside: avoid;
      break-inside: avoid;
    }
    .section-h {
      font-weight: 1000;
      font-size: 15px;
      margin: 0 0 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    .badge {
      display: inline-block;
      padding: 3px 8px;
      border: 1px solid var(--line);
      background: var(--shade);
      font-size: 12px;
      font-weight: 900;
      white-space: nowrap;
    }
    .section-body {
      font-size: 15px;
      line-height: 2;
      white-space: pre-wrap;
      text-align: justify;
    }

    .images-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }
    .images-grid-4 { grid-template-columns: repeat(4, 1fr); }

    .img-box {
      border: 1px solid var(--line);
      padding: 6px;
      text-align: center;
      page-break-inside: avoid;
      break-inside: avoid;
    }
    .img-box img {
      width: 100%;
      height: 180px;
      object-fit: contain;
      display: block;
      background: #fff;
    }
    .images-grid-4 .img-box img { height: 120px; }

    .img-cap {
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
    }

    .footer {
      margin-top: 12px;
      border-top: 1px solid var(--line);
      padding-top: 8px;
      font-size: 11px;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }
  </style>
</head>

<body>
  <div class="toolbar no-print">
    <span>معاينة الطباعة (A4)</span>
    <button type="button" id="achievementPrintBtn" class="btn btn-print">طباعة / حفظ كـ PDF</button>
    <a href="{% url 'reports:achievement_file_detail' file.pk %}" class="btn">عودة</a>
  </div>

  <script nonce="{{ CSP_NONCE }}">
    (function(){
      var btn = document.getElementById('achievementPrintBtn');
      if(btn) btn.addEventListener('click', function(){ window.print(); });
    })();
  </script>

  <div class="page">
    <header class="header">
      <div class="hdr-block hdr-right">
        <div>المملكة العربية السعودية</div>
        <div>وزارة التعليم</div>
        <div>{{ school.name|default:"المدرسة" }}</div>
      </div>

      <div class="hdr-center">
        <img src="{% static 'img/UntiTtled-1.png' %}" alt="شعار وزارة التعليم" class="logo" />
      </div>

      <div class="hdr-block hdr-left">
        <div>التاريخ: {{ now|date:"Y/m/d" }}</div>
        <div>رقم الملف: {{ file.id }}</div>
        <div>العام: {{ file.academic_year }} هـ</div>
      </div>
    </header>

    <div class="title">ملف الإنجاز</div>
    <div class="subtitle">اسم المعلّم/ة: {{ file.teacher_name }} — المرحلة: {{ school.get_stage_display }}</div>

    <table class="meta-table">
      <tr>
        <th>حالة الملف</th>
        <td>{{ file.get_status_display|default:"—" }}</td>
        <th>العام الدراسي</th>
        <td>{{ file.academic_year }} هـ</td>
      </tr>
      <tr>
        <th>التخصص</th>
        <td>{{ file.specialization|default:"—" }}</td>
        <th>نصاب الحصص</th>
        <td>{{ file.teaching_load|default:"—" }}</td>
      </tr>
    </table>

    <section class="section">
      <div class="section-h">أولاً: البيانات العامة</div>
      <table class="meta-table" style="margin:0;">
        <tr>
          <th>المؤهلات</th>
          <td>{{ file.qualifications|default:"—" }}</td>
          <th>مواد التدريس</th>
          <td>{{ file.subjects_taught|default:"—" }}</td>
        </tr>
        <tr>
          <th>الخبرات المهنية</th>
          <td>{{ file.professional_experience|default:"—" }}</td>
          <th>بيانات التواصل</th>
          <td>{{ file.contact_info|default:"—" }}</td>
        </tr>
      </table>
    </section>

    {% if file.manager_notes %}
      <section class="section">
        <div class="section-h">ثانياً: ملاحظات المدير</div>
        <div class="section-body">{{ file.manager_notes|default:"—" }}</div>
      </section>
    {% endif %}

    {% for s in sections %}
      <section class="section">
        <div class="section-h">
          <span>{{ s.get_code_display }}</span>
          {% if s.is_completed %}<span class="badge">مكتمل</span>{% endif %}
        </div>

        <div class="section-body">{{ s.teacher_notes|default:"—" }}</div>

        {% with imgs=s.evidence_images.all %}
          {% if imgs %}
            <div style="margin-top:10px;font-weight:1000;">الشواهد (حتى 8)</div>
            <div class="images-grid images-grid-4" style="margin-top:8px;">
              {% for img in imgs|slice:":8" %}
                <div class="img-box">
                  <img src="{{ img.image.url }}" alt="شاهد" />
                  <div class="img-cap">شاهد ({{ forloop.counter }})</div>
                </div>
              {% endfor %}
            </div>
          {% endif %}
        {% endwith %}
      </section>
    {% endfor %}

    <div class="footer">
      <div>تم توليد هذا الملف آليًا من النظام</div>
      <div>{{ now|date:"Y-m-d H:i" }}</div>
    </div>
  </div>
</body>
</html>
