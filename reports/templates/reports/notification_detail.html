{# reports/templates/reports/notification_detail.html #}
{% extends "base.html" %}
{% load static %}

{% block title %}تفاصيل الإشعار{% endblock %}

{% block head %}
<style>
  /* =========================================================
     Notification Detail (page-only, scoped)
     - بدون إعادة تعريف .btn / .card العامة
     - يدعم data-theme="dark"
     ========================================================= */

  .nd-scope{
    --nd-ink: var(--ink, #0f172a);
    --nd-muted: var(--muted, #64748b);
    --nd-line: var(--line, #e5e7eb);
    --nd-card: var(--card, #ffffff);
    --nd-soft: var(--line-2, #f1f5f9);
    --nd-shadow: 0 12px 30px rgba(2,6,23,.08);
    --nd-brand: var(--brand, #2563eb);
    --nd-brand-ghost: rgba(37,99,235,.10);
    --nd-danger: #ef4444;
    --nd-t: var(--t-fast, .18s ease);
  }

  .nd-scope .nd-wrap{max-width:1100px;margin:0 auto;padding:18px}

  .nd-scope .nd-head{
    display:flex;align-items:flex-start;justify-content:space-between;
    gap:12px;margin-bottom:14px;flex-wrap:wrap
  }
  .nd-scope .nd-title{margin:0;font-weight:950;color:var(--nd-ink)}
  .nd-scope .nd-hint{color:var(--nd-muted);font-weight:850}

  .nd-scope .nd-grid{display:grid;gap:18px}
  @media(min-width:1000px){.nd-scope .nd-grid{grid-template-columns:1.1fr .9fr}}

  .nd-scope .nd-card{
    background:var(--nd-card);
    border:1px solid var(--nd-line);
    border-radius:16px;
    box-shadow:var(--nd-shadow);
    overflow:hidden;
  }
  .nd-scope .nd-card-hd{
    padding:14px 16px;border-bottom:1px solid var(--nd-line);
    display:flex;align-items:center;justify-content:space-between;
    gap:10px;flex-wrap:wrap;
    background: linear-gradient(180deg, var(--nd-soft), var(--nd-card));
  }
  .nd-scope .nd-card-bd{padding:16px}

  .nd-scope .nd-meta-row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .nd-scope .nd-when{color:var(--nd-muted);font-weight:900}

  .nd-scope .nd-pill{
    display:inline-flex;align-items:center;gap:6px;
    padding:6px 10px;border:1px solid var(--nd-line);
    background: var(--nd-soft);
    color: var(--nd-ink);
    border-radius:999px;font-weight:950;font-size:.86rem;
    white-space:nowrap;
  }
  .nd-scope .nd-pill.important{background: rgba(239,68,68,.08); border-color: rgba(239,68,68,.20); color: #b91c1c;}
  .nd-scope .nd-pill.blue{background: var(--nd-brand-ghost); border-color: rgba(37,99,235,.20); color:#1e40af;}

  .nd-scope .nd-body{
    line-height:1.95;
    color: var(--nd-ink);
    font-weight:850;
    background: linear-gradient(180deg, var(--nd-card), rgba(248,250,252,.55));
    border:1px solid var(--nd-line);
    border-radius:14px;
    padding:14px;
  }

  .nd-scope .nd-tools{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}

  .nd-scope .nd-btn{
    padding:10px 12px;border-radius:12px;border:1px solid var(--nd-line);
    background: var(--nd-card);
    font-weight:950;text-decoration:none;color:var(--nd-ink);
    display:inline-flex;align-items:center;gap:8px;cursor:pointer;
    transition: transform var(--nd-t), box-shadow var(--nd-t), border-color var(--nd-t), background var(--nd-t);
    min-height:44px;
  }
  .nd-scope .nd-btn:hover{
    transform:translateY(-1px);
    box-shadow: 0 14px 26px rgba(2,6,23,.10);
    border-color: rgba(37,99,235,.25);
    background: rgba(248,250,252,.80);
  }
  .nd-scope .nd-btn.primary{
    background: var(--nd-brand);
    border-color: var(--nd-brand);
    color:#fff;
  }
  .nd-scope .nd-btn.primary:hover{
    background: #1d4ed8;
    border-color: #1d4ed8;
  }
  .nd-scope .nd-btn.danger{
    background: rgba(239,68,68,.08);
    border-color: rgba(239,68,68,.22);
    color:#b91c1c;
  }

  .nd-scope .nd-table-wrap{overflow:auto}
  .nd-scope table{
    width:100%;
    border-collapse:separate;border-spacing:0;
    border:1px solid var(--nd-line);
    border-radius:14px;
    overflow:hidden;
    background: var(--nd-card);
  }
  .nd-scope thead th{
    background: linear-gradient(180deg, var(--nd-soft), var(--nd-card));
    color: var(--nd-ink);
    font-weight:950;
    text-align:right;
    padding:10px;
    border-bottom:1px solid var(--nd-line);
    white-space:nowrap;
  }
  .nd-scope tbody td{
    padding:10px;
    border-bottom:1px solid var(--nd-line);
    color: var(--nd-ink);
    font-weight:850;
    white-space:nowrap;
  }
  .nd-scope tbody tr:nth-child(even){background: rgba(248,250,252,.55);}

  .nd-scope .nd-chip{
    display:inline-flex;align-items:center;gap:6px;
    padding:6px 10px;border-radius:999px;font-weight:950;
    border:1px solid transparent;
    white-space:nowrap;
  }
  .nd-scope .nd-chip.read{background: rgba(16,185,129,.10); border-color: rgba(16,185,129,.22); color:#166534;}
  .nd-scope .nd-chip.unread{background: rgba(100,116,139,.10); border-color: rgba(100,116,139,.18); color:#334155;}

  .nd-scope .nd-toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
  .nd-scope .nd-toolbar input[type="search"]{
    border:1px solid var(--nd-line);
    border-radius:12px;
    padding:10px 12px;
    font:inherit;
    width:100%;
    min-height:44px;
    background: var(--nd-card);
    color: var(--nd-ink);
    font-weight:850;
    outline: none;
  }
  .nd-scope .nd-toolbar input[type="search"]:focus{
    border-color: rgba(37,99,235,.35);
    box-shadow: 0 0 0 4px rgba(37,99,235,.12);
  }

  .nd-scope .nd-toggle{
    display:inline-flex;
    border:1px solid var(--nd-line);
    border-radius:12px;
    overflow:hidden;
    background: var(--nd-card);
  }
  .nd-scope .nd-toggle button{
    padding:10px 12px;
    border:0;
    background: transparent;
    font-weight:950;
    cursor:pointer;
    min-height:44px;
    color: var(--nd-ink);
    transition: background var(--nd-t), color var(--nd-t);
  }
  .nd-scope .nd-toggle button.on{
    background: var(--nd-brand-ghost);
    color: var(--nd-brand);
  }

  /* Dark tweaks (when base sets html[data-theme="dark"]) */
  html[data-theme="dark"] .nd-scope{
    --nd-shadow: 0 18px 46px rgba(0,0,0,.45);
  }
  html[data-theme="dark"] .nd-scope .nd-body{
    background: linear-gradient(180deg, var(--nd-card), rgba(2,6,23,.25));
  }
  html[data-theme="dark"] .nd-scope tbody tr:nth-child(even){
    background: rgba(2,6,23,.22);
  }

  @media (prefers-reduced-motion: reduce){
    .nd-scope .nd-btn{transition:none !important;}
    .nd-scope .nd-btn:hover{transform:none !important;}
  }
</style>
{% endblock %}

{% block content %}
<div class="nd-scope">
  <div class="nd-wrap" dir="rtl">
    <header class="nd-head">
      <div>
        <h1 class="nd-title">{% if n.requires_signature %}تفاصيل التعميم{% else %}تفاصيل الإشعار{% endif %}</h1>
        <div class="nd-hint">عرض الرسالة + حالة وصولها للمستلمين</div>
      </div>
      {% if n.requires_signature %}
        <a class="nd-btn" href="{% url 'reports:circulars_sent' %}">
          <i class="fa-solid fa-arrow-right" aria-hidden="true"></i> رجوع إلى التعاميم
        </a>
      {% else %}
        <a class="nd-btn" href="{% url 'reports:notifications_sent' %}">
          <i class="fa-solid fa-arrow-right" aria-hidden="true"></i> رجوع إلى الإشعارات
        </a>
      {% endif %}
    </header>

    <div class="nd-grid">

      <!-- بطاقة الإشعار -->
      <section class="nd-card" aria-label="الإشعار">
        <div class="nd-card-hd">
          <div class="nd-meta-row">
            <strong style="font-weight:950">{{ n.title|default:"رسالة" }}</strong>
            {% if n.is_important %}<span class="nd-pill important">هام</span>{% endif %}
            {% if n.is_broadcast %}<span class="nd-pill blue">للجميع</span>{% endif %}
            {% if n.requires_signature %}<span class="nd-pill blue"><i class="fa-solid fa-pen-to-square" aria-hidden="true"></i> تعميم بتوقيع</span>{% endif %}
          </div>
          <div class="nd-when">{% if n.created_at %}{{ n.created_at|date:"Y-m-d H:i" }}{% endif %}</div>
        </div>

        <div class="nd-card-bd">
          {% if body %}
            <div class="nd-body">{{ body|linebreaksbr }}</div>
          {% else %}
            <div class="nd-hint">لا يوجد محتوى نصي.</div>
          {% endif %}

          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px">
            {% if n.expires_at %}<span class="nd-pill">ينتهي: {{ n.expires_at|date:"Y-m-d H:i" }}</span>{% endif %}
            {% if n.created_by and n.created_by.name %}
              <span class="nd-pill">المرسِل: {{ n.created_by.name }} — {{ n.created_by.display_role_label }}</span>
            {% endif %}
          </div>

          <div class="nd-tools">
            {% if n.action_url %}
              <a class="nd-btn primary" href="{{ n.action_url }}" rel="noopener">
                <i class="fa-solid fa-up-right-from-square" aria-hidden="true"></i> فتح الرابط
              </a>
            {% endif %}

            {% if n.requires_signature %}
              <a class="nd-btn" href="{% url 'reports:notification_signatures_print' n.id %}">
                <i class="fa-solid fa-print" aria-hidden="true"></i> طباعة تقرير التواقيع
              </a>

            {% endif %}

            {% if n.id %}
              <form method="post" action="{% url 'reports:notification_delete' n.id %}" id="deleteNotifForm">
                {% csrf_token %}
                <button class="nd-btn danger" type="submit">
                  <i class="fa-solid fa-trash" aria-hidden="true"></i> حذف
                </button>
              </form>
            {% endif %}
          </div>
        </div>
      </section>

      <!-- بطاقة المستلمين -->
      <aside class="nd-card" aria-label="المستلمون">
        <div class="nd-card-hd">
          <strong style="font-weight:950">المستلمون</strong>
          <span class="nd-hint">الاسم — الدور — الحالة</span>
        </div>

        <div class="nd-card-bd">
          {% if recipients %}
            <div class="nd-toolbar">
              <input type="search" id="recSearch" placeholder="ابحث بالاسم أو الدور…" aria-label="بحث بالمستلمين">
              <div class="nd-toggle" role="tablist" aria-label="تصفية">
                <button id="toggleAll" class="on" type="button" aria-pressed="true">الكل</button>
                <button id="toggleUnread" type="button" aria-pressed="false">غير المقروء فقط</button>
                {% if n.requires_signature %}
                  <button id="toggleUnsigned" type="button" aria-pressed="false">غير الموقّع فقط</button>
                {% endif %}
              </div>
            </div>

            {% if n.requires_signature and signature_stats %}
              <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px">
                <span class="nd-pill">الإجمالي: {{ signature_stats.total }}</span>
                <span class="nd-pill" style="background:rgba(16,185,129,.10);border-color:rgba(16,185,129,.22);color:#166534;">موقّع: {{ signature_stats.signed }}</span>
                <span class="nd-pill" style="background:rgba(239,68,68,.08);border-color:rgba(239,68,68,.22);color:#b91c1c;">غير موقّع: {{ signature_stats.unsigned }}</span>
                {% if n.signature_deadline_at %}<span class="nd-pill">آخر موعد للتوقيع: {{ n.signature_deadline_at|date:"Y-m-d H:i" }}</span>{% endif %}
              </div>
            {% endif %}

            <div class="nd-table-wrap">
              <table id="recTable" aria-label="جدول المستلمين">
                <thead>
                  <tr>
                    <th style="width:45%">الاسم</th>
                    <th style="width:25%">الدور</th>
                    <th style="width:30%">الحالة</th>
                    {% if n.requires_signature %}<th style="width:22%">التوقيع</th>{% endif %}
                  </tr>
                </thead>
                <tbody>
                  {% for r in recipients %}
                    <tr data-read="{{ r.read|yesno:'1,0' }}" data-signed="{{ r.signed|yesno:'1,0' }}">
                      <td>{{ r.name }}</td>
                      <td>{{ r.role }}</td>
                      <td>
                        {% if r.read %}
                          <span class="nd-chip read" title="{% if r.read_at %}{{ r.read_at|date:'Y-m-d H:i' }}{% else %}مقروء{% endif %}">مقروء</span>
                        {% else %}
                          <span class="nd-chip unread" title="غير مقروء">غير مقروء</span>
                        {% endif %}
                      </td>
                      {% if n.requires_signature %}
                        <td>
                          {% if r.signed %}
                            <span class="nd-chip read" title="{% if r.signed_at %}{{ r.signed_at|date:'Y-m-d H:i' }}{% else %}تم التوقيع{% endif %}">موقّع</span>
                          {% else %}
                            <span class="nd-chip unread" title="غير موقّع">غير موقّع</span>
                          {% endif %}
                        </td>
                      {% endif %}
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            {% if n.is_broadcast %}
              <div class="nd-hint">هذا الإشعار مُرسل للجميع.</div>
            {% else %}
              <div class="nd-hint">لا يوجد مستلمون مسجّلون.</div>
            {% endif %}
          {% endif %}
        </div>
      </aside>

    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script nonce="{{ CSP_NONCE }}">
  (function(){
    'use strict';

    var q = document.getElementById('recSearch');
    var tbl = document.getElementById('recTable');
    var btnAll = document.getElementById('toggleAll');
    var btnUn  = document.getElementById('toggleUnread');
    var btnUns = document.getElementById('toggleUnsigned');
    if(!tbl) return;

    var rows = Array.prototype.slice.call(tbl.querySelectorAll('tbody tr'));

    function setPressed(){
      if(!btnAll || !btnUn) return;
      btnAll.setAttribute('aria-pressed', btnAll.classList.contains('on') ? 'true' : 'false');
      btnUn.setAttribute('aria-pressed', btnUn.classList.contains('on') ? 'true' : 'false');
      if(btnUns){
        btnUns.setAttribute('aria-pressed', btnUns.classList.contains('on') ? 'true' : 'false');
      }
    }

    function applyFilter(){
      var term = (q && q.value ? q.value : '').trim().toLowerCase();
      var unreadOnly = btnUn && btnUn.classList.contains('on');
      var unsignedOnly = btnUns && btnUns.classList.contains('on');

      rows.forEach(function(tr){
        var txt = (tr.textContent || '').toLowerCase();
        var isRead = tr.getAttribute('data-read') === '1';
        var isSigned = tr.getAttribute('data-signed') === '1';
        var match = !term || txt.indexOf(term) !== -1;
        var pass  = !unreadOnly || !isRead;
        var pass2 = !unsignedOnly || !isSigned;
        tr.style.display = (match && pass && pass2) ? '' : 'none';
      });

      setPressed();
    }

    if(q){
      q.addEventListener('input', applyFilter);
    }

    if(btnAll && btnUn){
      btnAll.addEventListener('click', function(){
        btnAll.classList.add('on');
        btnUn.classList.remove('on');
        if(btnUns) btnUns.classList.remove('on');
        applyFilter();
      });

      btnUn.addEventListener('click', function(){
        btnUn.classList.add('on');
        btnAll.classList.remove('on');
        if(btnUns) btnUns.classList.remove('on');
        applyFilter();
      });
    }

    if(btnUns){
      btnUns.addEventListener('click', function(){
        btnUns.classList.add('on');
        if(btnAll) btnAll.classList.remove('on');
        if(btnUn) btnUn.classList.remove('on');
        applyFilter();
      });
    }

    // Confirm delete (CSP-safe)
    var delForm = document.getElementById('deleteNotifForm');
    if(delForm){
      delForm.addEventListener('submit', function(e){
        try{
          var ok = window.confirm('حذف الإشعار نهائيًا؟');
          if(!ok){ e.preventDefault(); }
        }catch(err){}
      });
    }

    applyFilter();
  })();
</script>
{% endblock %}
