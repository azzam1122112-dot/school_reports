
{# reports/templates/reports/send_circular.html #}
{% extends "base.html" %}
{% load static %}

{% block title %}إرسال تعميم رسمي{% endblock %}

{% block head %}
<style>
  :root {
    --c-primary: #2563eb;
    --c-primary-light: #60a5fa;
    --c-primary-dark: #1d4ed8;
    --c-success: #10b981;
    --c-bg: #f8fafc;
    --c-card: #ffffff;
    --c-border: #e2e8f0;
    --c-text-main: #0f172a;
    --c-text-muted: #64748b;
    --radius-lg: 24px;
    --radius-md: 16px;
    --shadow-elegant: 0 10px 30px -10px rgba(0,0,0,0.08);
  }

  html[data-theme="dark"] {
    --c-bg: #020617;
    --c-card: #0f172a;
    --c-border: #1e293b;
    --c-text-main: #f8fafc;
    --c-text-muted: #94a3b8;
  }

  .circular-page {
    background: var(--c-bg);
    min-height: 100vh;
    padding: 3rem 0;
    font-family: 'Tajawal', sans-serif;
  }

  .circular-container {
    max-width: 1440px;
    margin: 0 auto;
    padding: 0 2rem;
  }

  /* Header Section */
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 3rem;
  }
  .header-content h1 {
    font-size: 2.5rem;
    font-weight: 900;
    background: linear-gradient(135deg, var(--c-primary), #8b5cf6);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 1rem;
  }
  .header-subtitle {
    margin-top: 0.75rem;
    color: var(--c-text-muted);
    font-size: 1.1rem;
    font-weight: 500;
  }

  /* App Card Polish */
  .app-card {
    background: var(--c-card);
    border-radius: var(--radius-lg);
    border: 1px solid var(--c-border);
    box-shadow: var(--shadow-elegant);
    overflow: hidden;
    transition: transform 0.3s ease;
  }
  .app-card-header {
    padding: 2rem;
    background: rgba(255,255,255,0.01);
    border-bottom: 1px solid var(--c-border);
  }
  .app-card-header h2 {
    font-size: 1.5rem;
    font-weight: 800;
    color: var(--c-text-main);
  }

  /* Form Elements 2026 */
  .form-control {
    border-radius: 12px;
    padding: 1rem 1.25rem;
    border: 1.5px solid var(--c-border);
    background: var(--c-bg);
    font-weight: 500;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  .form-control:focus {
    border-color: var(--c-primary);
    background: var(--c-card);
    box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
  }

  .btn-submit {
    background: linear-gradient(135deg, var(--c-primary), var(--c-primary-dark));
    color: white;
    padding: 1.25rem 3rem;
    border-radius: 99px;
    font-weight: 800;
    font-size: 1.2rem;
    box-shadow: 0 20px 40px -10px rgba(37, 99, 235, 0.4);
    transition: all 0.3s ease;
  }
  .btn-submit:hover {
    transform: translateY(-4px);
    box-shadow: 0 25px 50px -12px rgba(37, 99, 235, 0.5);
  }

  /* Teacher Selection specific */
  .teacher-selector {
    border: 1px solid var(--c-border);
    border-radius: var(--radius);
    background-color: var(--c-w-bg);
    padding: 1rem;
    box-shadow: inset 0 2px 4px 0 rgba(0,0,0,0.03);
  }
  .teacher-tools {
    display: flex;
    gap: 0.75rem;
    margin-bottom: 1rem;
    align-items: center;
  }
  .teacher-search {
    flex: 1;
    padding: 0.6rem 1rem;
    border-radius: 99px;
    border: 1px solid var(--c-border);
    background: var(--c-card);
    font-size: 0.9rem;
    transition: all 0.3s ease;
  }
  .teacher-search:focus {
    border-color: var(--c-primary);
    box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
    outline: none;
  }
  .teacher-list-container {
    max-height: 350px;
    overflow-y: auto;
    padding-right: 0.5rem;
    scrollbar-width: thin;
    scrollbar-color: var(--c-border) transparent;
  }
  .teacher-list-container::-webkit-scrollbar { width: 6px; }
  .teacher-list-container::-webkit-scrollbar-thumb { background: var(--c-border); border-radius: 10px; }

  .teacher-list-container ul {
    list-style: none;
    padding: 0;
    margin: 0;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 0.75rem;
  }
  
  .teacher-item, #teacherList li {
    list-style: none;
  }

  .teacher-item label, #teacherList label {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    border-radius: 10px;
    cursor: pointer;
    border: 1px solid var(--c-border);
    background: var(--c-card);
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    font-size: 0.95rem;
    font-weight: 600;
    position: relative;
    user-select: none;
  }
  
  .teacher-item label:hover, #teacherList label:hover {
    background-color: var(--c-w-bg);
    border-color: var(--c-primary);
    transform: translateY(-2px);
    box-shadow: var(--shadow-sm);
  }

  /* Checked state highlight - THE CORE FIX */
  .teacher-item input:checked + span, 
  #teacherList input:checked + span,
  .teacher-item label:has(input:checked),
  #teacherList label:has(input:checked) {
    background-color: var(--c-primary);
    color: #ffffff !important;
    border-color: var(--c-primary-dark);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.25);
  }

  #teacherList label:has(input:checked) span {
    color: #ffffff !important;
  }

  /* Custom Checkbox within item */
  .teacher-item input[type="checkbox"], 
  #teacherList input[type="checkbox"] {
    width: 1.2rem;
    height: 1.2rem;
    margin: 0;
    cursor: pointer;
  }

  /* Signature Box */
  .sig-settings-box {
    background: linear-gradient(to bottom right, rgba(59, 130, 246, 0.03), rgba(168, 85, 247, 0.03));
    border: 1px dashed var(--c-primary);
    border-radius: var(--radius);
    padding: 1.5rem;
    position: relative;
    margin-top: 0.5rem;
  }
  .sig-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1rem;
    color: var(--c-primary-dark);
    font-weight: 700;
  }
  .sig-badge {
    background-color: var(--c-primary);
    color: #fff;
    font-size: 0.7rem;
    padding: 0.2rem 0.6rem;
    border-radius: 9999px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  /* Actions */
  .form-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--c-border);
  }
  .btn-submit {
    background: linear-gradient(135deg, var(--c-primary) 0%, var(--c-primary-dark) 100%);
    color: #fff;
    border: none;
    padding: 0.75rem 2rem;
    border-radius: 8px;
    font-weight: 700;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.4);
    transition: transform 0.2s, box-shadow 0.2s;
  }
  .btn-submit:hover {
    transform: translateY(-1px);
    box-shadow: 0 6px 8px -2px rgba(59, 130, 246, 0.5);
  }
  .btn-cancel {
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    border: 1px solid var(--c-border);
    background: transparent;
    color: var(--c-text);
    font-weight: 600;
    cursor: pointer;
    text-decoration: none;
    transition: background 0.1s;
  }
  .btn-cancel:hover {
    background-color: var(--c-border);
  }

  /* Preview Styles */
  .preview-col {
    position: sticky;
    top: 2rem;
  }
  .doc-preview {
    background: #fff;
    color: #1e293b; /* Always dark text on paper style */
    border: 1px solid #e2e8f0;
    min-height: 400px;
    display: flex;
    flex-direction: column;
    position: relative;
  }
  html[data-theme="dark"] .doc-preview {
    background: #e2e8f0; /* Slightly dimmed paper in dark mode but still light */
    color: #0f172a;
  }
  
  .doc-header {
    border-bottom: 2px solid #0f172a;
    padding-bottom: 1rem;
    margin-bottom: 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
  }
  .doc-brand {
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-weight: 800;
    opacity: 0.6;
  }
  .doc-title {
    font-family: 'Amiri', serif; /* Use serif for official feel if available */
    font-size: 1.5rem;
    font-weight: 800;
    color: #000;
  }
  .doc-meta {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    font-size: 0.8rem;
    color: #64748b;
  }
  .doc-tag {
    background: #f1f5f9;
    padding: 0.2rem 0.6rem;
    border-radius: 4px;
    border: 1px solid #cbd5e1;
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
  }
  .doc-body {
    font-size: 1rem;
    line-height: 1.8;
    white-space: pre-wrap;
    flex: 1;
  }
  .doc-footer {
    margin-top: 2rem;
    padding-top: 1rem;
    border-top: 1px solid #cbd5e1;
    display: flex;
    justify-content: space-between;
    font-size: 0.8rem;
    color: #64748b;
  }
  
  /* Utilities */
  .hidden { display: none !important; }
  .text-sm { font-size: 0.85rem; }
  .text-red { color: #dc2626; }
</style>
{% endblock %}

{% block content %}
<div class="circular-page" dir="rtl">
  <div class="circular-container">

    <!-- HEADER -->
    <header class="page-header">
      <div class="header-content">
        <h1>
          <i class="fa-solid fa-file-signature" style="color:var(--c-primary)"></i>
          <span>إرسال تعميم رسمي</span>
        </h1>
        <div class="header-subtitle">
          التعميم هو مستند رسمي يتطلب توقيع وإقرار بالاطلاع من قبل المستلمين
        </div>
      </div>
      <div class="header-actions">
        <a href="{% url 'reports:circulars_sent' %}" class="btn-link">
          <i class="fa-solid fa-list-check"></i>
          الأرشيف والمرسلة
        </a>
      </div>
    </header>

    <div class="main-grid">

      <!-- LEFT: FORM SECTION -->
      <section>
        <div class="app-card">
          <div class="app-card-header">
            <h2>
              <i class="fa-solid fa-pen-nib"></i>
              بيانات التعميم
            </h2>
            <span class="text-sm form-hint">الحقول بعلامة <span class="text-red">*</span> مطلوبة</span>
          </div>

          <div class="app-card-body">
            {% if form %}
              <form method="post" enctype="multipart/form-data" id="notifyForm" novalidate>
                {% csrf_token %}

                <!-- Hidden/System Fields -->
                {% if form.requires_signature %}
                  <div class="hidden">{{ form.requires_signature }}</div>
                {% endif %}
                
                {% if form.non_field_errors %}
                  <div class="error-list" style="margin-bottom:1rem;padding:1rem;background:#fee2e2;border-radius:8px;border:1px solid #fecaca">
                    {{ form.non_field_errors }}
                  </div>
                {% endif %}

                <div class="form-grid">

                  <!-- Title: Full Width -->
                  <div class="full-width form-group">
                    <label class="form-label" for="{{ form.title.id_for_label }}">{{ form.title.label }} <span class="text-red">*</span></label>
                    {{ form.title }}
                    {% if form.title.errors %}<div class="error-list">{{ form.title.errors }}</div>{% endif %}
                  </div>

                  <!-- Body: Full Width -->
                  <div class="full-width form-group">
                    <label class="form-label" for="{{ form.message.id_for_label }}">{{ form.message.label }} <span class="text-red">*</span></label>
                    {{ form.message }}
                    {% if form.message.errors %}<div class="error-list">{{ form.message.errors }}</div>{% endif %}
                  </div>

                  <!-- Target Departments (if applicable) -->
                  {% if form.target_department %}
                    <div class="form-group">
                        <label class="form-label" for="{{ form.target_department.id_for_label }}">{{ form.target_department.label }}</label>
                        {{ form.target_department }}
                        {% if form.target_department.errors %}<div class="error-list">{{ form.target_department.errors }}</div>{% endif %}
                    </div>
                  {% endif %}
                  
                  <!-- Attachment -->
                  {% if form.attachment %}
                    <div class="form-group">
                        <label class="form-label" for="{{ form.attachment.id_for_label }}">{{ form.attachment.label }}</label>
                        {{ form.attachment }}
                        <div class="form-hint">يسمح بـ PDF / Word / صور — حد أقصى 5MB</div>
                        {% if form.attachment.errors %}<div class="error-list">{{ form.attachment.errors }}</div>{% endif %}
                    </div>
                  {% endif %}

                  <!-- Priority / Switch Toggles -->
                  <div class="full-width" style="display:flex;gap:1.5rem;margin-block:0.5rem">
                    {% if form.is_important %}
                      <label class="form-label" style="justify-content:flex-start;gap:0.5rem;cursor:pointer">
                         {{ form.is_important }}
                         <span style="font-weight:normal">تعميم هام وعاجل <i class="fa-solid fa-circle-exclamation text-red"></i></span>
                      </label>
                    {% endif %}
                  </div>

                  <!-- RECIPIENTS SECTION -->
                  {% if form.teachers %}
                  <div class="full-width field" data-name="teachers">
                     <div class="form-group">
                        <label class="form-label" style="margin-bottom: 0.5rem; font-size: 1rem; border-bottom: 2px solid var(--c-primary); display: inline-block; padding-bottom: 4px; width: fit-content;">
                           {{ form.teachers.label }} <span class="text-red">*</span>
                        </label>
                        
                        <div class="teacher-selector">
                           <div class="teacher-tools">
                              <div style="position: relative; flex: 1;">
                                <i class="fa-solid fa-magnifying-glass" style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); opacity: 0.5;"></i>
                                <input type="search" id="teacherSearch" class="teacher-search" placeholder="ابحث عن اسم المعلم..." style="padding-right: 40px;">
                              </div>
                              <div class="flex items-center" style="gap: 8px;">
                                 <button type="button" id="selectAllTeachers" class="btn-cancel" style="padding: 6px 16px; font-size: 0.85rem; border-color: var(--c-primary); color: var(--c-primary);">تحديد الكل</button>
                                 <button type="button" id="clearAllTeachers" class="btn-cancel" style="padding: 6px 16px; font-size: 0.85rem;">إلغاء التحديد</button>
                              </div>
                           </div>
                           <div style="margin-bottom: 12px; font-size: 0.85rem; color: var(--c-text); display: flex; align-items: center; gap: 8px;">
                              <i class="fa-solid fa-users-check" style="color: var(--c-primary);"></i>
                              <span>عدد المستلمين المختارين حالياً: <b id="selCount" style="color: var(--c-primary); font-size: 1rem;">0</b></span>
                           </div>
                           <div class="teacher-list-container" id="teacherList">
                              {{ form.teachers }}
                           </div>
                        </div>
                        {% if form.teachers.errors %}<div class="error-list">{{ form.teachers.errors }}</div>{% endif %}
                     </div>
                  </div>
                  {% endif %}

                  <!-- SIGNATURE SETTINGS BLOCK -->
                  <div class="full-width sig-settings-box">
                    <div class="sig-header">
                       <i class="fa-solid fa-file-contract"></i>
                       إعدادات التوقيع والإقرار
                       <span class="sig-badge">إلزامي</span>
                    </div>

                    <div class="form-grid">
                      <!-- Deadline -->
                      {% if form.signature_deadline_at %}
                        <div class="form-group">
                          <label class="form-label" for="{{ form.signature_deadline_at.id_for_label }}">{{ form.signature_deadline_at.label }}</label>
                          {{ form.signature_deadline_at }}
                          {% if form.signature_deadline_at.errors %}<div class="error-list">{{ form.signature_deadline_at.errors }}</div>{% endif %}
                        </div>
                      {% endif %}

                      <!-- Action URL -->
                      {% if form.action_url %}
                        <div class="form-group">
                          <label class="form-label" for="{{ form.action_url.id_for_label }}">{{ form.action_url.label }}</label>
                          {{ form.action_url }}
                          {% if form.action_url.errors %}<div class="error-list">{{ form.action_url.errors }}</div>{% endif %}
                        </div>
                      {% endif %}

                      <!-- Acknowledgement Text -->
                      {% if form.signature_ack_text %}
                        <div class="full-width form-group">
                          <label class="form-label" for="{{ form.signature_ack_text.id_for_label }}">{{ form.signature_ack_text.label }}</label>
                          {{ form.signature_ack_text }}
                          {% if form.signature_ack_text.errors %}<div class="error-list">{{ form.signature_ack_text.errors }}</div>{% endif %}
                        </div>
                      {% endif %}
                    </div>
                  </div>

                </div>

                <!-- Submit Area -->
                <div class="form-actions">
                  <button type="submit" class="btn-submit">
                    <i class="fa-solid fa-paper-plane"></i>
                    اعتماد وإرسال التعميم
                  </button>
                  <a href="{% url 'reports:home' %}" class="btn-cancel">إلغاء</a>
                </div>

              </form>
            {% else %}
               <p class="error-list">خطأ: لم يتم تحميل النموذج بشكل صحيح.</p>
            {% endif %}
          </div>
        </div>
      </section>

      <!-- RIGHT: PREVIEW SECTION -->
      <aside class="preview-col">
          <div class="app-card doc-preview">
             <div class="app-card-body" style="height:100%;display:flex;flex-direction:column">
                <div class="doc-header">
                  <div>
                    <div class="doc-brand">نظام التقارير المدرسية</div>
                    <div class="doc-title" id="pv_title">عنوان التعميم</div>
                  </div>
                  <div style="text-align:left">
                    <i class="fa-solid fa-school fa-2x" style="opacity:0.1"></i>
                  </div>
                </div>

                <div class="doc-meta">
                   <span class="doc-tag">
                     <i class="fa-solid fa-user"></i>
                     <span>من: {% firstof request.user.name request.user.first_name "الإدارة" %}</span>
                   </span>
                   <span class="doc-tag" id="pv_att" style="display:none">
                     <i class="fa-solid fa-paperclip"></i> مرفق
                   </span>
                   <span class="doc-tag" id="pv_imp" style="display:none;color:#dc2626;border-color:#fecaca;background:#fef2f2">
                     <i class="fa-solid fa-circle-exclamation"></i> هام
                   </span>
                   <span class="doc-tag">
                     <i class="fa-solid fa-signature"></i> توقيع إلزامي
                   </span>
                </div>

                <div class="doc-body" id="pv_body">
                  نص التعميم سيظهر هنا كما يراه المعلم...
                </div>

                <div class="doc-footer">
                   <div>
                     <span id="pv_deadline_box" style="display:none">
                       ينتهي التوقيع: <b id="pv_deadline">--</b>
                     </span>
                   </div>
                   <div>
                     <i class="fa-solid fa-qrcode"></i> وثيقة رسمية
                   </div>
                </div>
             </div>
          </div>
          <div style="text-align:center;margin-top:1rem;color:var(--c-text);opacity:0.6;font-size:0.85rem">
            هذه معاينة تقريبية لكيفية ظهور التعميم
          </div>
      </aside>

    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script nonce="{{ CSP_NONCE }}">
(function(){
  const $ = s => document.querySelector(s);

  // Force requires_signature
  const rs = document.getElementById('id_requires_signature');
  if(rs){ rs.checked = true; }

  // Live Preview Logic
  const titleInput = document.getElementById("id_title");
  const msgInput = document.getElementById("id_message");
  const impInput = document.getElementById("id_is_important");
  const dlineInput = document.getElementById("id_signature_deadline_at");
  const attInput = document.getElementById("id_attachment");

  const pvTitle = $("#pv_title");
  const pvBody  = $("#pv_body");
  const pvImp   = $("#pv_imp");
  const pvAtt   = $("#pv_att");
  const pvDeadlineBox = $("#pv_deadline_box");
  const pvDeadlineVal = $("#pv_deadline");

  function updatePreview(){
    if(pvTitle && titleInput) pvTitle.textContent = titleInput.value || 'عنوان التعميم';
    if(pvBody && msgInput) pvBody.textContent = msgInput.value || 'نص التعميم...';
    if(pvImp && impInput) pvImp.style.display = impInput.checked ? 'inline-flex' : 'none';

    if(pvAtt && attInput){
      pvAtt.style.display = (attInput.files && attInput.files.length) ? 'inline-flex' : 'none';
    }
    
    if(pvDeadlineBox && dlineInput){
        if(dlineInput.value){
           pvDeadlineBox.style.display = 'inline';
           pvDeadlineVal.textContent = dlineInput.value.replace('T', ' ');
        } else {
           pvDeadlineBox.style.display = 'none';
        }
    }
  }

  [titleInput, msgInput, impInput, dlineInput, attInput].forEach(el => {
     if(el){
       el.addEventListener('input', updatePreview);
       el.addEventListener('change', updatePreview);
     }
  });

  // ========== TEACHER LIST LOGIC (Restoring Filter/AJAX capabilities) ==========
  const teacherField = document.querySelector('.field[data-name="teachers"]');
  const teacherListBox = document.getElementById('teacherList');
  const searchInput = document.getElementById('teacherSearch');
  const countDisplay = document.getElementById('selCount');
  const btnSelectAll = document.getElementById('selectAllTeachers');
  const btnClearAll = document.getElementById('clearAllTeachers');

  // Helper to find inputs
  function getCheckboxes(){
     if(!teacherListBox) return [];
     return Array.from(teacherListBox.querySelectorAll('input[type="checkbox"]'));
  }

  function updateCount(){
     const checks = getCheckboxes();
     const c = checks.filter(cb => cb.checked).length;
     if(countDisplay) countDisplay.textContent = c;
  }

  function filterTeachers(term){
     const checks = getCheckboxes();
     const q = term.toLowerCase();
     checks.forEach(cb => {
        const span = cb.nextElementSibling; // Usually <span>Name</span>
        const label = cb.closest('label'); // or parent li
        const li = cb.closest('li');
        
        let txt = "";
        if(span) txt = span.textContent;
        else if(label) txt = label.textContent;
        
        const match = txt.toLowerCase().includes(q);
        if(li) li.style.display = match ? '' : 'none';
     });
  }

  if(searchInput){
     searchInput.addEventListener('input', e => filterTeachers(e.target.value));
  }

  if(btnSelectAll){
     btnSelectAll.addEventListener('click', e => {
        e.preventDefault(); 
        console.log("Selecting all visible teachers...");
        getCheckboxes().forEach(cb => {
            const li = cb.closest('li') || cb.closest('.teacher-item');
            if(li && li.style.display !== 'none') {
                cb.checked = true;
                // Dispatch change event to trigger highlight or other listeners
                cb.dispatchEvent(new Event('change', { bubbles: true }));
            }
        });
        updateCount();
     });
  }

  if(btnClearAll){
     btnClearAll.addEventListener('click', e => {
        e.preventDefault();
        getCheckboxes().forEach(cb => {
            cb.checked = false;
            cb.dispatchEvent(new Event('change', { bubbles: true }));
        });
        updateCount();
     });
  }

  if(teacherListBox){
     teacherListBox.addEventListener('change', updateCount);
  }
  
  // Initialize count
  updateCount();


  // ========== AJAX RELOAD LOGIC (If needed by backend logic) ==========
  // The original code had logic to reload teachers if Dept/School/Scope changes.
  // We must preserve it if those fields exist. 
  
  const scopeSel = document.getElementById('id_audience_scope'); // If user sends to admins
  const schoolSel = document.getElementById('id_target_school');
  const deptSel = document.getElementById('id_target_department');
  
  let isLoading = false;

  async function refreshTeachers(){
      if(isLoading) return;
      // If we don't have these selectors, we assume static list for manager -> teachers
      if(!scopeSel && !schoolSel && !deptSel) return; 

      // Build Params
      const params = new URLSearchParams();
      params.set('mode', 'circular'); // Force mode
      if(scopeSel) params.set('audience_scope', scopeSel.value);
      if(schoolSel) params.set('target_school', schoolSel.value);
      if(deptSel) params.set('target_department', deptSel.value);

      const url = '{% url "reports:api_notification_teachers" %}?' + params.toString();
      
      isLoading = true;
      const prevContent = teacherListBox.innerHTML;
      teacherListBox.innerHTML = '<div style="padding:10px;text-align:center;color:#64748b">جارٍ التحديث...</div>';
      
      try {
         const res = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
         const data = await res.json();
         const results = data.results || [];
         
         if(results.length === 0){
            teacherListBox.innerHTML = '<div style="padding:10px;text-align:center;color:#64748b">لا يوجد مستلمون.</div>';
         } else {
            let html = '<ul>';
            // Determine field name from existing or default 'teachers'
            const fieldName = 'teachers'; // simplified assumption
            results.forEach(t => {
                html += `<li><label><input type="checkbox" name="${fieldName}" value="${t.id}"> <span>${t.name}</span></label></li>`;
            });
            html += '</ul>';
            teacherListBox.innerHTML = html;
         }
         updateCount();
         if(searchInput) filterTeachers(searchInput.value); // Re-apply filter
         
      } catch(e){
         console.error(e);
         teacherListBox.innerHTML = prevContent; // Revert on error
      } finally {
         isLoading = false;
      }
  }

  if(deptSel) deptSel.addEventListener('change', refreshTeachers);
  if(scopeSel) scopeSel.addEventListener('change', refreshTeachers);
  if(schoolSel) schoolSel.addEventListener('change', refreshTeachers);


  // ========== PREVENT DOUBLE SUBMIT ==========
  const form = document.getElementById('notifyForm');
  if(form){
    form.addEventListener('submit', function(){
      const btn = form.querySelector('button[type="submit"]');
      if(btn){
        btn.disabled = true;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> جارٍ الإرسال...';
      }
    });
  }

})();
</script>
{% endblock %}
