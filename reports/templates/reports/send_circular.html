
{# reports/templates/reports/send_circular.html #}
{% extends "base.html" %}
{% load static %}

{% block title %}إرسال تعميم رسمي{% endblock %}

{% block head %}
<style>
  :root {
    --c-primary: #3b82f6; /* Blue 500 */
    --c-primary-dark: #2563eb; /* Blue 600 */
    --c-secondary: #0f172a; /* Slate 900 */
    --c-bg: #f1f5f9; /* Slate 100 */
    --c-card: #ffffff;
    --c-border: #e2e8f0; /* Slate 200 */
    --c-text: #334155; /* Slate 700 */
    --c-text-head: #0f172a; /* Slate 900 */
    --c-w-bg: #f8fafc; /* For input backgrounds */
    --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
    --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.05), 0 4px 6px -4px rgb(0 0 0 / 0.05);
    --radius: 12px;
  }
  html[data-theme="dark"] {
    --c-primary: #3b82f6;
    --c-primary-dark: #60a5fa;
    --c-secondary: #f8fafc;
    --c-bg: #0f172a;
    --c-card: #1e293b;
    --c-border: #334155;
    --c-text: #cbd5e1;
    --c-text-head: #f8fafc;
    --c-w-bg: #1e293b;
    --shadow-sm: none;
    --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.3);
    --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.4);
  }

  .circular-page {
    background-color: var(--c-bg);
    min-height: 100vh;
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
    color: var(--c-text);
    padding-block: 2rem;
  }

  .circular-container {
    max-width: 1400px;
    margin-inline: auto;
    padding-inline: 1.5rem;
  }

  /* Header Section */
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    flex-wrap: wrap;
    gap: 1rem;
  }
  .header-content h1 {
    font-size: 1.875rem;
    font-weight: 800;
    color: var(--c-text-head);
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }
  .header-subtitle {
    margin-top: 0.5rem;
    color: var(--c-text);
    opacity: 0.8;
    font-size: 0.95rem;
  }
  .header-actions .btn-link {
    color: var(--c-primary);
    text-decoration: none;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: var(--radius);
    transition: background-color 0.2s;
  }
  .header-actions .btn-link:hover {
    background-color: rgba(59, 130, 246, 0.1);
  }

  /* Grid Layout Main */
  .main-grid {
    display: grid;
    grid-template-columns: 1.4fr 1fr;
    gap: 2rem;
    align-items: start;
  }
  @media (max-width: 1024px) {
    .main-grid {
      grid-template-columns: 1fr;
    }
    .preview-col {
        display: none; /* Consider hiding or moving below on mobile if too cramped */
    }
  }

  /* Cards */
  .app-card {
    background-color: var(--c-card);
    border-radius: var(--radius); /* Start bigger radius */
    box-shadow: var(--shadow-md);
    border: 1px solid var(--c-border);
    overflow: hidden;
  }
  .app-card-header {
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid var(--c-border);
    background-color: rgba(255,255,255,0.02);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .app-card-header h2 {
    font-size: 1.125rem;
    font-weight: 700;
    margin: 0;
    color: var(--c-text-head);
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .app-card-body {
    padding: 1.5rem;
  }

  /* Form Elements */
  .form-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.25rem;
  }
  .form-grid .full-width {
    grid-column: 1 / -1;
  }
  @media (max-width: 640px) {
    .form-grid { grid-template-columns: 1fr; }
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  .form-label {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--c-text-head);
    display: flex;
    justify-content: space-between;
  }
  .form-control {
    width: 100%;
    padding: 0.75rem 1rem;
    border-radius: 8px; /* Slightly tighter elements */
    border: 1px solid var(--c-border);
    background-color: var(--c-w-bg);
    color: var(--c-text-head);
    font-size: 0.95rem;
    transition: all 0.2s;
  }
  .form-control:focus {
    outline: none;
    border-color: var(--c-primary);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
  }
  textarea.form-control {
    min-height: 120px;
    resize: vertical;
    line-height: 1.6;
  }
  .form-hint {
    font-size: 0.8rem;
    color: var(--c-text);
    opacity: 0.7;
    margin-top: 0.25rem;
  }
  .error-list {
    color: #ef4444;
    font-size: 0.85rem;
    font-weight: 600;
    margin-top: 0.25rem;
  }

  /* Custom Checkboxes/Radios */
  input[type="checkbox"] {
    accent-color: var(--c-primary);
    width: 1.1em;
    height: 1.1em;
  }

  /* Teacher Selection specific */
  .teacher-selector {
    border: 1px solid var(--c-border);
    border-radius: 8px;
    background-color: var(--c-w-bg);
    padding: 0.75rem;
  }
  .teacher-tools {
    display: flex;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
  }
  .teacher-search {
    flex: 1;
    padding: 0.5rem;
    border-radius: 6px;
    border: 1px solid var(--c-border);
    font-size: 0.9rem;
  }
  .teacher-list-container {
    max-height: 250px;
    overflow-y: auto;
    padding-right: 0.25rem;
  }
  .teacher-list-container ul {
    list-style: none;
    padding: 0;
    margin: 0;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 0.5rem;
  }
  .teacher-item label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.1s;
    font-size: 0.9rem;
  }
  .teacher-item label:hover {
    background-color: rgba(0,0,0,0.05);
  }
  html[data-theme="dark"] .teacher-item label:hover {
    background-color: rgba(255,255,255,0.05);
  }

  /* Signature Box */
  .sig-settings-box {
    background: linear-gradient(to bottom right, rgba(59, 130, 246, 0.03), rgba(168, 85, 247, 0.03));
    border: 1px dashed var(--c-primary);
    border-radius: var(--radius);
    padding: 1.5rem;
    position: relative;
    margin-top: 0.5rem;
  }
  .sig-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1rem;
    color: var(--c-primary-dark);
    font-weight: 700;
  }
  .sig-badge {
    background-color: var(--c-primary);
    color: #fff;
    font-size: 0.7rem;
    padding: 0.2rem 0.6rem;
    border-radius: 9999px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  /* Actions */
  .form-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--c-border);
  }
  .btn-submit {
    background: linear-gradient(135deg, var(--c-primary) 0%, var(--c-primary-dark) 100%);
    color: #fff;
    border: none;
    padding: 0.75rem 2rem;
    border-radius: 8px;
    font-weight: 700;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.4);
    transition: transform 0.2s, box-shadow 0.2s;
  }
  .btn-submit:hover {
    transform: translateY(-1px);
    box-shadow: 0 6px 8px -2px rgba(59, 130, 246, 0.5);
  }
  .btn-cancel {
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    border: 1px solid var(--c-border);
    background: transparent;
    color: var(--c-text);
    font-weight: 600;
    cursor: pointer;
    text-decoration: none;
    transition: background 0.1s;
  }
  .btn-cancel:hover {
    background-color: var(--c-border);
  }

  /* Preview Styles */
  .preview-col {
    position: sticky;
    top: 2rem;
  }
  .doc-preview {
    background: #fff;
    color: #1e293b; /* Always dark text on paper style */
    border: 1px solid #e2e8f0;
    min-height: 400px;
    display: flex;
    flex-direction: column;
    position: relative;
  }
  html[data-theme="dark"] .doc-preview {
    background: #e2e8f0; /* Slightly dimmed paper in dark mode but still light */
    color: #0f172a;
  }
  
  .doc-header {
    border-bottom: 2px solid #0f172a;
    padding-bottom: 1rem;
    margin-bottom: 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
  }
  .doc-brand {
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-weight: 800;
    opacity: 0.6;
  }
  .doc-title {
    font-family: 'Amiri', serif; /* Use serif for official feel if available */
    font-size: 1.5rem;
    font-weight: 800;
    color: #000;
  }
  .doc-meta {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    font-size: 0.8rem;
    color: #64748b;
  }
  .doc-tag {
    background: #f1f5f9;
    padding: 0.2rem 0.6rem;
    border-radius: 4px;
    border: 1px solid #cbd5e1;
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
  }
  .doc-body {
    font-size: 1rem;
    line-height: 1.8;
    white-space: pre-wrap;
    flex: 1;
  }
  .doc-footer {
    margin-top: 2rem;
    padding-top: 1rem;
    border-top: 1px solid #cbd5e1;
    display: flex;
    justify-content: space-between;
    font-size: 0.8rem;
    color: #64748b;
  }
  
  /* Utilities */
  .hidden { display: none !important; }
  .text-sm { font-size: 0.85rem; }
  .text-red { color: #dc2626; }
</style>
{% endblock %}

{% block content %}
<div class="circular-page" dir="rtl">
  <div class="circular-container">

    <!-- HEADER -->
    <header class="page-header">
      <div class="header-content">
        <h1>
          <i class="fa-solid fa-file-signature" style="color:var(--c-primary)"></i>
          <span>إرسال تعميم رسمي</span>
        </h1>
        <div class="header-subtitle">
          التعميم هو مستند رسمي يتطلب توقيع وإقرار بالاطلاع من قبل المستلمين
        </div>
      </div>
      <div class="header-actions">
        <a href="{% url 'reports:circulars_sent' %}" class="btn-link">
          <i class="fa-solid fa-list-check"></i>
          الأرشيف والمرسلة
        </a>
      </div>
    </header>

    <div class="main-grid">

      <!-- LEFT: FORM SECTION -->
      <section>
        <div class="app-card">
          <div class="app-card-header">
            <h2>
              <i class="fa-solid fa-pen-nib"></i>
              بيانات التعميم
            </h2>
            <span class="text-sm form-hint">الحقول بعلامة <span class="text-red">*</span> مطلوبة</span>
          </div>

          <div class="app-card-body">
            {% if form %}
              <form method="post" enctype="multipart/form-data" id="notifyForm" novalidate>
                {% csrf_token %}

                <!-- Hidden/System Fields -->
                {% if form.requires_signature %}
                  <div class="hidden">{{ form.requires_signature }}</div>
                {% endif %}
                
                {% if form.non_field_errors %}
                  <div class="error-list" style="margin-bottom:1rem;padding:1rem;background:#fee2e2;border-radius:8px;border:1px solid #fecaca">
                    {{ form.non_field_errors }}
                  </div>
                {% endif %}

                <div class="form-grid">

                  <!-- Title: Full Width -->
                  <div class="full-width form-group">
                    <label class="form-label" for="{{ form.title.id_for_label }}">{{ form.title.label }} <span class="text-red">*</span></label>
                    {{ form.title }}
                    {% if form.title.errors %}<div class="error-list">{{ form.title.errors }}</div>{% endif %}
                  </div>

                  <!-- Body: Full Width -->
                  <div class="full-width form-group">
                    <label class="form-label" for="{{ form.message.id_for_label }}">{{ form.message.label }} <span class="text-red">*</span></label>
                    {{ form.message }}
                    {% if form.message.errors %}<div class="error-list">{{ form.message.errors }}</div>{% endif %}
                  </div>

                  <!-- Target Departments (if applicable) -->
                  {% if form.target_department %}
                    <div class="form-group">
                        <label class="form-label" for="{{ form.target_department.id_for_label }}">{{ form.target_department.label }}</label>
                        {{ form.target_department }}
                        {% if form.target_department.errors %}<div class="error-list">{{ form.target_department.errors }}</div>{% endif %}
                    </div>
                  {% endif %}
                  
                   <!-- Image / Attachment -->
                  {% if form.image %}
                    <div class="form-group">
                        <label class="form-label" for="{{ form.image.id_for_label }}">{{ form.image.label }}</label>
                        {{ form.image }}
                        {% if form.image.errors %}<div class="error-list">{{ form.image.errors }}</div>{% endif %}
                    </div>
                  {% endif %}

                  <!-- Priority / Switch Toggles -->
                  <div class="full-width" style="display:flex;gap:1.5rem;margin-block:0.5rem">
                    {% if form.is_important %}
                      <label class="form-label" style="justify-content:flex-start;gap:0.5rem;cursor:pointer">
                         {{ form.is_important }}
                         <span style="font-weight:normal">تعميم هام وعاجل <i class="fa-solid fa-circle-exclamation text-red"></i></span>
                      </label>
                    {% endif %}
                  </div>

                  <!-- RECIPIENTS SECTION -->
                  {% if form.teachers %}
                  <div class="full-width field" data-name="teachers">
                     <div class="form-group">
                        <label class="form-label">
                           {{ form.teachers.label }} <span class="text-red">*</span>
                           <div class="text-sm" style="font-weight:400">
                             <button type="button" id="selectAllTeachers" class="btn-link" style="padding:0;background:none;border:none">تحديد الكل</button> | 
                             <button type="button" id="clearAllTeachers" class="btn-link" style="padding:0;color:var(--c-text);background:none;border:none">إلغاء</button>
                           </div>
                        </label>
                        <div class="teacher-selector">
                           <div class="teacher-tools">
                              <input type="search" id="teacherSearch" class="teacher-search" placeholder="ابحث عن الاسم...">
                              <span class="form-hint" style="align-self:center">المختار: <b id="selCount">0</b></span>
                           </div>
                           <div class="teacher-list-container" id="teacherList">
                              {{ form.teachers }}
                           </div>
                        </div>
                        {% if form.teachers.errors %}<div class="error-list">{{ form.teachers.errors }}</div>{% endif %}
                     </div>
                  </div>
                  {% endif %}

                  <!-- SIGNATURE SETTINGS BLOCK -->
                  <div class="full-width sig-settings-box">
                    <div class="sig-header">
                       <i class="fa-solid fa-file-contract"></i>
                       إعدادات التوقيع والإقرار
                       <span class="sig-badge">إلزامي</span>
                    </div>

                    <div class="form-grid">
                      <!-- Deadline -->
                      {% if form.signature_deadline_at %}
                        <div class="form-group">
                          <label class="form-label" for="{{ form.signature_deadline_at.id_for_label }}">{{ form.signature_deadline_at.label }}</label>
                          {{ form.signature_deadline_at }}
                          {% if form.signature_deadline_at.errors %}<div class="error-list">{{ form.signature_deadline_at.errors }}</div>{% endif %}
                        </div>
                      {% endif %}

                      <!-- Action URL -->
                      {% if form.action_url %}
                        <div class="form-group">
                          <label class="form-label" for="{{ form.action_url.id_for_label }}">{{ form.action_url.label }}</label>
                          {{ form.action_url }}
                          {% if form.action_url.errors %}<div class="error-list">{{ form.action_url.errors }}</div>{% endif %}
                        </div>
                      {% endif %}

                      <!-- Acknowledgement Text -->
                      {% if form.signature_ack_text %}
                        <div class="full-width form-group">
                          <label class="form-label" for="{{ form.signature_ack_text.id_for_label }}">{{ form.signature_ack_text.label }}</label>
                          {{ form.signature_ack_text }}
                          {% if form.signature_ack_text.errors %}<div class="error-list">{{ form.signature_ack_text.errors }}</div>{% endif %}
                        </div>
                      {% endif %}
                    </div>
                  </div>

                </div>

                <!-- Submit Area -->
                <div class="form-actions">
                  <button type="submit" class="btn-submit">
                    <i class="fa-solid fa-paper-plane"></i>
                    اعتماد وإرسال التعميم
                  </button>
                  <a href="{% url 'reports:home' %}" class="btn-cancel">إلغاء</a>
                </div>

              </form>
            {% else %}
               <p class="error-list">خطأ: لم يتم تحميل النموذج بشكل صحيح.</p>
            {% endif %}
          </div>
        </div>
      </section>

      <!-- RIGHT: PREVIEW SECTION -->
      <aside class="preview-col">
          <div class="app-card doc-preview">
             <div class="app-card-body" style="height:100%;display:flex;flex-direction:column">
                <div class="doc-header">
                  <div>
                    <div class="doc-brand">نظام التقارير المدرسية</div>
                    <div class="doc-title" id="pv_title">عنوان التعميم</div>
                  </div>
                  <div style="text-align:left">
                    <i class="fa-solid fa-school fa-2x" style="opacity:0.1"></i>
                  </div>
                </div>

                <div class="doc-meta">
                   <span class="doc-tag">
                     <i class="fa-solid fa-user"></i>
                     <span>من: {% firstof request.user.name request.user.first_name "الإدارة" %}</span>
                   </span>
                   <span class="doc-tag" id="pv_imp" style="display:none;color:#dc2626;border-color:#fecaca;background:#fef2f2">
                     <i class="fa-solid fa-circle-exclamation"></i> هام
                   </span>
                   <span class="doc-tag">
                     <i class="fa-solid fa-signature"></i> توقيع إلزامي
                   </span>
                </div>

                <div class="doc-body" id="pv_body">
                  نص التعميم سيظهر هنا كما يراه المعلم...
                </div>

                <div class="doc-footer">
                   <div>
                     <span id="pv_deadline_box" style="display:none">
                       ينتهي التوقيع: <b id="pv_deadline">--</b>
                     </span>
                   </div>
                   <div>
                     <i class="fa-solid fa-qrcode"></i> وثيقة رسمية
                   </div>
                </div>
             </div>
          </div>
          <div style="text-align:center;margin-top:1rem;color:var(--c-text);opacity:0.6;font-size:0.85rem">
            هذه معاينة تقريبية لكيفية ظهور التعميم
          </div>
      </aside>

    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script nonce="{{ CSP_NONCE }}">
(function(){
  const $ = s => document.querySelector(s);

  // Force requires_signature
  const rs = document.getElementById('id_requires_signature');
  if(rs){ rs.checked = true; }

  // Live Preview Logic
  const titleInput = document.getElementById("id_title");
  const msgInput = document.getElementById("id_message");
  const impInput = document.getElementById("id_is_important");
  const dlineInput = document.getElementById("id_signature_deadline_at");

  const pvTitle = $("#pv_title");
  const pvBody  = $("#pv_body");
  const pvImp   = $("#pv_imp");
  const pvDeadlineBox = $("#pv_deadline_box");
  const pvDeadlineVal = $("#pv_deadline");

  function updatePreview(){
    if(pvTitle && titleInput) pvTitle.textContent = titleInput.value || 'عنوان التعميم';
    if(pvBody && msgInput) pvBody.textContent = msgInput.value || 'نص التعميم...';
    if(pvImp && impInput) pvImp.style.display = impInput.checked ? 'inline-flex' : 'none';
    
    if(pvDeadlineBox && dlineInput){
        if(dlineInput.value){
           pvDeadlineBox.style.display = 'inline';
           pvDeadlineVal.textContent = dlineInput.value.replace('T', ' ');
        } else {
           pvDeadlineBox.style.display = 'none';
        }
    }
  }

  [titleInput, msgInput, impInput, dlineInput].forEach(el => {
     if(el){
       el.addEventListener('input', updatePreview);
       el.addEventListener('change', updatePreview);
     }
  });

  // ========== TEACHER LIST LOGIC (Restoring Filter/AJAX capabilities) ==========
  const teacherField = document.querySelector('.field[data-name="teachers"]');
  const teacherListBox = document.getElementById('teacherList');
  const searchInput = document.getElementById('teacherSearch');
  const countDisplay = document.getElementById('selCount');
  const btnSelectAll = document.getElementById('selectAllTeachers');
  const btnClearAll = document.getElementById('clearAllTeachers');

  // Helper to find inputs
  function getCheckboxes(){
     if(!teacherListBox) return [];
     return Array.from(teacherListBox.querySelectorAll('input[type="checkbox"]'));
  }

  function updateCount(){
     const checks = getCheckboxes();
     const c = checks.filter(cb => cb.checked).length;
     if(countDisplay) countDisplay.textContent = c;
  }

  function filterTeachers(term){
     const checks = getCheckboxes();
     const q = term.toLowerCase();
     checks.forEach(cb => {
        const span = cb.nextElementSibling; // Usually <span>Name</span>
        const label = cb.closest('label'); // or parent li
        const li = cb.closest('li');
        
        let txt = "";
        if(span) txt = span.textContent;
        else if(label) txt = label.textContent;
        
        const match = txt.toLowerCase().includes(q);
        if(li) li.style.display = match ? '' : 'none';
     });
  }

  if(searchInput){
     searchInput.addEventListener('input', e => filterTeachers(e.target.value));
  }

  if(btnSelectAll){
     btnSelectAll.addEventListener('click', e => {
        // e.preventDefault(); // removed preventDefault if it's button type=button
        getCheckboxes().forEach(cb => {
            if(cb.closest('li').style.display !== 'none') cb.checked = true;
        });
        updateCount();
     });
  }

  if(btnClearAll){
     btnClearAll.addEventListener('click', e => {
        // e.preventDefault();
        getCheckboxes().forEach(cb => {
            if(cb.closest('li').style.display !== 'none') cb.checked = false;
        });
        updateCount();
     });
  }

  if(teacherListBox){
     teacherListBox.addEventListener('change', updateCount);
  }
  
  // Initialize count
  updateCount();


  // ========== AJAX RELOAD LOGIC (If needed by backend logic) ==========
  // The original code had logic to reload teachers if Dept/School/Scope changes.
  // We must preserve it if those fields exist. 
  
  const scopeSel = document.getElementById('id_audience_scope'); // If user sends to admins
  const schoolSel = document.getElementById('id_target_school');
  const deptSel = document.getElementById('id_target_department');
  
  let isLoading = false;

  async function refreshTeachers(){
      if(isLoading) return;
      // If we don't have these selectors, we assume static list for manager -> teachers
      if(!scopeSel && !schoolSel && !deptSel) return; 

      // Build Params
      const params = new URLSearchParams();
      params.set('mode', 'circular'); // Force mode
      if(scopeSel) params.set('audience_scope', scopeSel.value);
      if(schoolSel) params.set('target_school', schoolSel.value);
      if(deptSel) params.set('target_department', deptSel.value);

      const url = '{% url "reports:api_notification_teachers" %}?' + params.toString();
      
      isLoading = true;
      const prevContent = teacherListBox.innerHTML;
      teacherListBox.innerHTML = '<div style="padding:10px;text-align:center;color:#64748b">جارٍ التحديث...</div>';
      
      try {
         const res = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
         const data = await res.json();
         const results = data.results || [];
         
         if(results.length === 0){
            teacherListBox.innerHTML = '<div style="padding:10px;text-align:center;color:#64748b">لا يوجد مستلمون.</div>';
         } else {
            let html = '<ul>';
            // Determine field name from existing or default 'teachers'
            const fieldName = 'teachers'; // simplified assumption
            results.forEach(t => {
                html += `<li><label><input type="checkbox" name="${fieldName}" value="${t.id}"> <span>${t.name}</span></label></li>`;
            });
            html += '</ul>';
            teacherListBox.innerHTML = html;
         }
         updateCount();
         if(searchInput) filterTeachers(searchInput.value); // Re-apply filter
         
      } catch(e){
         console.error(e);
         teacherListBox.innerHTML = prevContent; // Revert on error
      } finally {
         isLoading = false;
      }
  }

  if(deptSel) deptSel.addEventListener('change', refreshTeachers);
  if(scopeSel) scopeSel.addEventListener('change', refreshTeachers);
  if(schoolSel) schoolSel.addEventListener('change', refreshTeachers);


  // ========== PREVENT DOUBLE SUBMIT ==========
  const form = document.getElementById('notifyForm');
  if(form){
    form.addEventListener('submit', function(){
      const btn = form.querySelector('button[type="submit"]');
      if(btn){
        btn.disabled = true;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> جارٍ الإرسال...';
      }
    });
  }

})();
</script>
{% endblock %}
