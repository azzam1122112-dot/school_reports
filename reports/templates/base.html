{% load static %}
<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#2563eb" />
  <meta name="color-scheme" content="light dark" />

  <!-- Favicon (Ù…Ù‡Ù… Ù„ØªÙØ§Ø¯ÙŠ Ø·Ù„Ø¨ /favicon.ico Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ) -->
  <link rel="icon" href="{% static 'img/logo1.png' %}">
  <link rel="apple-touch-icon" href="{% static 'img/logo1.png' %}">

  <!-- PWA -->
  <link rel="manifest" href="{% static 'manifest.json' %}">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="ØªÙˆØ«ÙŠÙ‚">

  <title>{% block title %}Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±{% endblock %}</title>

  <!-- Theme: apply BEFORE CSS to avoid flash -->
  <script nonce="{{ CSP_NONCE }}">
    (function(){
      try{
        var m = document.cookie.match(/(?:^|; )theme=([^;]+)/);
        var theme = m ? decodeURIComponent(m[1]) : '';
        if(theme === 'dark' || theme === 'light'){
          document.documentElement.setAttribute('data-theme', theme);
          document.documentElement.style.colorScheme = theme;
        }
      }catch(e){}
    })();
  </script>

  <!-- Performance -->
  <link rel="preload" href="{% static 'css/app.css' %}" as="style">
  <link rel="stylesheet" href="{% static 'css/app.css' %}" />

  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">

  <style>
    /* 
       NEO-PROFESSIONAL THEME 2026 
       Global Design System Overlay
    */
    :root {
      --font-base: 'Tajawal', system-ui, -apple-system, sans-serif;
      
      /* Palette */
      --brand: #1e293b;       /* Slate 900 (Professional Dark) */
      --brand-alpha: rgba(30, 41, 59, 0.95);
      --accent: #2563eb;      /* Royal Blue */
      --accent-hover: #1d4ed8;
      
      --surface: #ffffff;
      --bg-body: #f8fafc;     /* Slate 50 */
      --bg-sub: #f1f5f9;      /* Slate 100 */
      
      --text-main: #0f172a;   /* Slate 900 */
      --text-muted: #64748b;  /* Slate 500 */
      --text-light: #94a3b8;  /* Slate 400 */
      
      --border-light: #e2e8f0;
      --border-focus: #cbd5e1;
      
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      
      /* Elevations */
      --shadow-xs: 0 1px 2px 0 rgba(0,0,0,0.05);
      --shadow-sm: 0 4px 6px -1px rgba(0,0,0,0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0,0,0,0.05), 0 8px 10px -6px rgba(0,0,0,0.01);
      --shadow-glass: 0 8px 32px 0 rgba(31, 38, 135, 0.05);
      
      /* Radii */
      --r-sm: 6px;
      --r-md: 10px;
      --r-lg: 16px;
      --r-full: 9999px;
      
      /* Transitions */
      --ease-out: cubic-bezier(0.16, 1, 0.3, 1);
      --ease-feedback: cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    body {
      font-family: var(--font-base);
      background-color: var(--bg-body);
      color: var(--text-main);
      -webkit-font-smoothing: antialiased;
      line-height: 1.6;
    }

    /* --- NEW HEADER (Glassmorphism Premium) --- */
    .site-header {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      border-bottom: 1px solid rgba(226, 232, 240, 0.6);
      position: sticky;
      top: 0;
      z-index: 1000;
      height: 72px;
      display: flex;
      align-items: center;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      transition: all 0.3s var(--ease-out);
    }
    
    .site-header.scrolled {
      background: rgba(255, 255, 255, 0.98);
      box-shadow: 0 8px 32px rgba(0,0,0,0.08);
      height: 64px;
    }

    .hdr {
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 100%;
      width: 100%;
      max-width: 1400px; /* Wider Global Layout */
      margin: 0 auto;
      padding: 0 24px;
    }

    /* Brand */
    .hdr-brand {
      display: flex;
      align-items: center;
      gap: 12px;
      text-decoration: none;
      color: var(--brand);
      transition: all 0.3s var(--ease-out);
      position: relative;
    }
    
    .hdr-brand::before {
      content: '';
      position: absolute;
      inset: -8px;
      border-radius: 12px;
      background: var(--bg-sub);
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .hdr-brand:hover::before {
      opacity: 1;
    }
    
    .hdr-brand > * {
      position: relative;
      z-index: 1;
    }
    
    .hdr-brand:hover { transform: translateY(-1px); }
    .hdr-brand img { 
      border-radius: 10px; 
      box-shadow: var(--shadow-sm);
    }
    .hdr-brand-name {
      font-weight: 800;
      font-size: 1.1rem;
      line-height: 1.2;
    }
    .hdr-brand-sub {
      font-size: 0.85rem;
      color: var(--text-muted);
      font-weight: 500;
    }

    /* Navigation Tabs (Modern Pill/Underline) */
    .hdr-nav {
      display: flex;
      gap: 6px;
      background: var(--bg-sub);
      padding: 4px;
      border-radius: var(--r-full);
      border: 1px solid var(--border-light);
    }
    
    @media (max-width: 991px) { .hdr-nav { display: none; } } /* Hide on Mobile */

    .hdr-nav .tab {
      padding: 6px 16px;
      border-radius: var(--r-full);
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-muted);
      text-decoration: none;
      transition: all 0.2s var(--ease-out);
      position: relative;
    }
    
    .hdr-nav .tab:hover {
      color: var(--text-main);
      background: rgba(255,255,255,0.5);
    }
    
    .hdr-nav .tab.is-active {
      background: var(--surface);
      color: var(--accent);
      box-shadow: var(--shadow-sm);
    }
    .hdr-nav .tab .pill {
      background: var(--danger);
      color: white;
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 99px;
      margin-inline-start: 6px;
    }

    /* Actions Area */
    .hdr-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .icon-btn {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      color: var(--text-muted);
      background: transparent;
      border: 1px solid transparent;
      transition: all 0.2s;
      cursor: pointer;
      position: relative;
      text-decoration: none;
    }
    .icon-btn:hover {
      background: var(--bg-sub);
      color: var(--accent);
      border-color: var(--border-light);
    }
    .icon-btn .dot {
      position: absolute;
      top: -2px; right: -2px;
      background: var(--danger);
      color: white;
      font-size: 0.7rem;
      font-weight: 800;
      min-width: 18px;
      height: 18px;
      border-radius: 99px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid var(--surface);
    }

    /* User Avatar */
    .userbox { position: relative; }
    .avatar {
      width: 40px; height: 40px;
      border-radius: 12px;
      background: linear-gradient(135deg, var(--brand), var(--accent));
      color: white;
      font-weight: 700;
      font-size: 1.1rem;
      border: 2px solid rgba(255,255,255,0.2);
      cursor: pointer;
      transition: transform 0.2s var(--ease-feedback);
      display: flex; align-items: center; justify-content: center;
    }
    .avatar:hover { transform: scale(1.05) rotate(3deg); box-shadow: 0 0 0 3px var(--bg-sub); }
    
    .userbox .menu {
      position: absolute;
      top: 120%;
      left: 0; /* RTL adjusted */
      min-width: 220px;
      background: var(--surface);
      border: 1px solid var(--border-light);
      border-radius: var(--r-lg);
      box-shadow: var(--shadow-xl);
      padding: 8px;
      opacity: 0;
      visibility: hidden;
      transform: translateY(10px);
      transition: all 0.2s var(--ease-out);
      z-index: 1001;
    }
    .userbox .menu[aria-expanded="true"], .userbox:focus-within .menu, .userbox:hover .menu {
      opacity: 1; visibility: visible; transform: translateY(0);
    }
    
    .mi {
      display: flex; align-items: center; gap: 10px;
      padding: 10px 12px;
      border-radius: var(--r-md);
      color: var(--text-main);
      text-decoration: none;
      font-size: 0.92rem;
      font-weight: 500;
    }
    .mi:hover { background: var(--bg-sub); color: var(--accent); }
    .mi i { width: 20px; text-align: center; color: var(--text-muted); }
    .mi:hover i { color: var(--accent); }
    .mi .meta { font-size: 0.8rem; color: var(--text-muted); font-weight: normal; }

    /* --- TOAST MESSAGES (Luxury) --- */
    .messages {
      position: fixed;
      top: 24px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 12px;
      pointer-events: none;
      width: 100%;
      max-width: 420px;
      padding: 20px;
    }

    /* Mobile: keep toasts at very top (avoid mid-screen on phones) */
    @media (max-width: 768px) {
      .messages {
        inset-inline: 12px;
        top: calc(12px + var(--safe-top));
        left: auto;
        transform: none;
        display: grid;
        width: auto;
        max-width: 520px;
        margin-inline: auto;
        padding: 0;
      }
    }
    
    .msg {
      pointer-events: auto;
      background: var(--surface);
      border-radius: var(--r-lg);
      padding: 16px 20px;
      box-shadow: var(--shadow-glass), var(--shadow-xl);
      display: flex;
      align-items: flex-start;
      gap: 12px;
      animation: msgSlideIn 0.5s var(--ease-out) forwards;
      transition: opacity 0.25s ease, transform 0.25s ease;
      border-right: 4px solid var(--accent); /* RTL indicator */
      position: relative;
      overflow: hidden;
    }

    .msg.is-hiding {
      opacity: 0;
      transform: translateY(-10px) scale(0.98);
    }
    
    @keyframes msgSlideIn {
      from { 
        opacity: 0; 
        transform: translateY(-30px) scale(0.92);
      }
      to { 
        opacity: 1; 
        transform: translateY(0) scale(1);
      }
    }
    
    .msg.success { 
      border-color: var(--success);
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.02) 0%, var(--surface) 100%);
    }
    .msg.error { 
      border-color: var(--danger);
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.02) 0%, var(--surface) 100%);
    }
    .msg.warning { 
      border-color: var(--warning);
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.02) 0%, var(--surface) 100%);
    }
    
    .msg-icon { font-size: 1.2rem; margin-top: 2px; }
    .msg.success .msg-icon { color: var(--success); }
    .msg.error .msg-icon { color: var(--danger); }
    
    .msg-content { flex: 1; font-weight: 600; font-size: 0.95rem; }
    .msg-close {
      background: transparent; border: none; color: var(--text-muted);
      cursor: pointer; padding: 4px; border-radius: 4px;
    }
    .msg-close:hover { background: var(--bg-sub); color: var(--text-main); }
    
    /* --- FOOTER (Professional Premium) --- */
    .site-footer {
      background: linear-gradient(180deg, var(--surface) 0%, #fafbfc 50%, var(--bg-sub) 100%);
      border-top: 1px solid var(--border-light);
      margin-top: 32px;
      padding: 24px 0 16px;
      position: relative;
    }
    
    .site-footer::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, 
        transparent 0%, 
        var(--accent) 20%, 
        #60a5fa 50%, 
        var(--accent) 80%, 
        transparent 100%
      );
      opacity: 0.7;
      animation: shimmerLine 3s ease-in-out infinite;
    }
    
    @keyframes shimmerLine {
      0%, 100% { opacity: 0.5; }
      50% { opacity: 0.9; }
    }
    
    .footer-grid {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr 1fr;
      gap: 24px;
      margin-bottom: 20px;
    }
    
    @media (max-width: 992px) {
      .footer-grid { grid-template-columns: 1fr 1fr; gap: 20px; }
    }
    
    @media (max-width: 640px) {
      .site-footer { display: none !important; }
      .footer-grid { grid-template-columns: 1fr; gap: 24px; }
      .footer-col { text-align: center; }
      .footer-col h4 { justify-content: center; }
      .footer-logo { justify-content: center; }
      .footer-links li { justify-content: center; }
      .footer-contact-item { justify-content: center; }
      .footer-social { justify-content: center; }
      .footer-auth-brands { justify-content: center; }
    }
    
    .footer-col h4 {
      font-size: 0.9rem;
      font-weight: 900;
      margin: 0 0 10px;
      color: var(--text-main);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .footer-col h4 i {
      color: var(--accent);
      font-size: 1.1rem;
    }
    
    .footer-about {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .footer-logo {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 6px;
    }
    
    .footer-logo img {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      border: 1px solid var(--border-light);
      background: var(--surface);
      box-shadow: var(--shadow-xs);
    }
    
    .footer-logo-text h3 {
      margin: 0;
      font-size: 1.1rem;
      font-weight: 950;
      color: var(--text-main);
    }
    
    .footer-logo-text p {
      margin: 2px 0 0;
      font-size: 0.75rem;
      font-weight: 700;
      color: var(--text-muted);
    }
    
    .footer-desc {
      font-size: 0.82rem;
      line-height: 1.5;
      color: var(--text-muted);
      font-weight: 600;
    }
    
    .footer-links {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    
    .footer-links li {
      display: flex;
      align-items: center;
    }
    
    .footer-links a {
      color: var(--text-muted);
      text-decoration: none;
      font-weight: 700;
      font-size: 0.82rem;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .footer-links a:hover {
      color: var(--accent);
      transform: translateX(-4px);
    }
    
    .footer-links a i {
      font-size: 0.75rem;
      opacity: 0.6;
    }
    
    .footer-social {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }
    
    .footer-social a {
      width: 36px;
      height: 36px;
      border-radius: var(--r-md);
      background: var(--surface);
      border: 1px solid var(--border-light);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      transition: all 0.2s;
      font-size: 1rem;
    }
    
    .footer-social a:hover {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
      transform: translateY(-2px);
      box-shadow: var(--shadow-sm);
    }
    
    .footer-contact {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .footer-contact-item {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      font-size: 0.8rem;
      color: var(--text-muted);
      font-weight: 600;
    }
    
    .footer-contact-item i {
      color: var(--accent);
      margin-top: 2px;
      font-size: 0.95rem;
    }
    
    .footer-bottom {
      padding-top: 16px;
      border-top: 1px solid var(--border-light);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 16px;
    }
    
    @media (max-width: 640px) {
      .footer-bottom {
        flex-direction: column;
        text-align: center;
      }
      .footer-badges {
        justify-content: center;
      }
    }

    .footer-copyright {
      font-size: 0.8rem;
      color: var(--text-muted);
      font-weight: 700;
    }
    
    .footer-copyright i {
      color: var(--danger);
      font-size: 0.75rem;
    }
    
    .footer-badges {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .footer-badge {
      padding: 4px 10px;
      border-radius: var(--r-sm);
      background: var(--surface);
      border: 1px solid var(--border-light);
      font-size: 0.7rem;
      font-weight: 800;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .footer-badge i {
      color: var(--accent);
      font-size: 0.85rem;
    }

    /* Container */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 24px;
    }
    
    @media (max-width: 768px) {
      .hdr-brand-name { display: none; } /* Simpler mobile brand */
      .hdr { padding: 0 16px; }
      .container { padding: 0 16px; }
    }

    /* --- GLOBAL COMPONENT OVERRIDES --- */
    
    /* Buttons */
    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 8px 16px;
        border-radius: var(--r-md);
        font-weight: 600;
        transition: all 0.2s;
        cursor: pointer;
        text-decoration: none;
        border: 1px solid transparent;
        line-height: 1.5;
    }
    .btn-sm { font-size: 0.85rem; padding: 6px 12px; }
    
    .btn-outline {
        background: transparent;
        border: 1px solid var(--border-light);
        color: var(--text-main);
    }
    .btn-outline:hover {
        border-color: var(--accent);
        color: var(--accent);
        background: var(--bg-sub);
    }
    
    .btn-primary {
        background: var(--accent);
        color: white;
        box-shadow: 0 2px 4px rgba(37,99,235,0.2);
    }
    .btn-primary:hover {
        background: var(--accent-hover);
        transform: translateY(-1px);
    }

    /* Mobile Drawer (Glass) */
    .drawer {
        background: rgba(255, 255, 255, 0.95) !important;
        backdrop-filter: blur(20px);
        width: 300px;
        max-width: 85vw;
        box-shadow: var(--shadow-xl);
    }
    
    .drawer-nav a {
        border-radius: var(--r-md);
        margin-bottom: 4px;
        color: var(--text-muted);
        font-weight: 600;
    }
    .drawer-nav a:hover, .drawer-nav a.is-active {
        background: var(--bg-sub);
        color: var(--accent);
    }

    /* Modals (School Switcher) */
    .school-panel {
        border-radius: var(--r-lg);
        box-shadow: var(--shadow-xl), var(--shadow-glass);
        background: var(--surface);
        border: 1px solid var(--border-light);
        max-width: 500px;
    }
    .school-list li button {
        border-radius: var(--r-md);
        transition: 0.1s;
    }
    .school-list li button:hover {
        background: var(--bg-sub);
        transform: translateX(-4px); /* RTL Slide */
    }

    /* Footer */
    .site-footer { margin-top: auto; }
    
    /* Scroll Progress */
    .progress-bar {
        background: linear-gradient(90deg, var(--accent), #60a5fa);
        height: 3px;
        box-shadow: 0 1px 2px rgba(37,99,235,0.3);
    }
  </style>

  <!-- Icons (Ù…Ø­Ù„ÙŠÙ‹Ø§ Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ±Ù‡Ø§ Ø¨Ø§Ù„Ø¬ÙˆØ§Ù„ Ø­ØªÙ‰ Ù„Ùˆ ØªØ¹Ø·Ù„ CDN) -->
  <link rel="stylesheet" href="{% static 'vendor/fontawesome/css/all.min.css' %}">
  <link rel="stylesheet" href="{% static 'vendor/fontawesome/css/v4-shims.min.css' %}">

  {% block head %}{% endblock %}
</head>

<body class="page">
  {% if SUBSCRIPTION_WARNING %}
    <div class="sub-banner" role="status" aria-live="polite">
      <div class="container">
        <i class="fas fa-exclamation-triangle" style="margin-inline-end:8px"></i>
        ØªÙ†Ø¨ÙŠÙ‡: Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ù…Ø¯Ø±Ø³Ø© ÙŠÙ†ØªÙ‡ÙŠ Ø®Ù„Ø§Ù„ {{ SUBSCRIPTION_DAYS_LEFT }} ÙŠÙˆÙ….
        <a href="{% url 'reports:my_subscription' %}">ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø¢Ù†</a>
      </div>
    </div>
  {% endif %}

  <a class="skip-link" href="#mainContent">ØªØ®Ø·ÙŠ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø­ØªÙˆÙ‰</a>
  <div class="progress-bar" id="scrollProgress"></div>

  <form id="__csrf" hidden aria-hidden="true">{% csrf_token %}</form>

  <header class="site-header" id="siteHeader">
    <div class="container hdr">

      <button class="hamburger" id="hamburger" aria-label="ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©" aria-controls="mobileDrawer" aria-expanded="false">
        <span></span><span></span><span></span>
      </button>

      <a class="hdr-brand" href="{% if IS_REPORT_VIEWER %}{% url 'reports:school_reports_readonly' %}{% elif request.user.is_platform_admin and not request.user.is_superuser %}{% if SCHOOL_ID %}{% url 'reports:platform_school_dashboard' %}{% else %}{% url 'reports:platform_schools_directory' %}{% endif %}{% else %}{% url 'reports:home' %}{% endif %}">
        <img src="{% if SCHOOL_LOGO_URL %}{{ SCHOOL_LOGO_URL }}{% else %}{% static 'img/logo1.png' %}{% endif %}" alt="Ø§Ù„Ø´Ø¹Ø§Ø±" width="42" height="42" loading="eager" decoding="async">
        <div class="hdr-brand-txt">
          <div class="hdr-brand-name">{% if SCHOOL_NAME %}{{ SCHOOL_NAME }}{% else %}Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±{% endif %}</div>
          <div class="hdr-brand-sub"> Ù…Ù†ØµØ© ØªÙˆØ«ÙŠÙ‚</div>
        </div>
      </a>

      {% with active=request.resolver_match.url_name %}
      <nav class="hdr-nav" aria-label="Ø±ÙˆØ§Ø¨Ø·">
        {% if request.user.is_authenticated %}
          {% if IS_REPORT_VIEWER %}
            <a class="tab {% if active == 'school_reports_readonly' %}is-active{% endif %}" href="{% url 'reports:school_reports_readonly' %}">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</a>
            <a class="tab {% if active == 'achievement_school_files' or active == 'achievement_school_teachers' or active == 'achievement_file_detail' %}is-active{% endif %}" href="{% url 'reports:achievement_school_files' %}">Ù…Ù„ÙØ§Øª Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</a>
          {% elif request.user.is_platform_admin and not request.user.is_superuser %}
            <a class="tab {% if active == 'home' or active == 'platform_school_dashboard' or active == 'platform_schools_directory' %}is-active{% endif %}" href="{% if SCHOOL_ID %}{% url 'reports:platform_school_dashboard' %}{% else %}{% url 'reports:platform_schools_directory' %}{% endif %}">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
            <a class="tab {% if active == 'platform_schools_directory' %}is-active{% endif %}" href="{% url 'reports:platform_schools_directory' %}">Ø§Ù„Ù…Ø¯Ø§Ø±Ø³</a>
            <a class="tab {% if active == 'circulars_sent' or active == 'notifications_create' or active == 'notification_detail' %}is-active{% endif %}" href="{% url 'reports:circulars_sent' %}">Ø§Ù„ØªØ¹Ø§Ù…ÙŠÙ…</a>
            <a class="tab {% if active == 'notifications_sent' %}is-active{% endif %}" href="{% url 'reports:notifications_sent' %}">Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</a>
            {% if SCHOOL_ID %}
              <a class="tab {% if active == 'platform_school_reports' %}is-active{% endif %}" href="{% url 'reports:platform_school_reports' %}">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</a>
              <a class="tab {% if active == 'platform_school_tickets' or active == 'ticket_detail' %}is-active{% endif %}" href="{% url 'reports:platform_school_tickets' %}">Ø§Ù„ØªØ°Ø§ÙƒØ±</a>
              <a class="tab {% if active == 'achievement_school_files' or active == 'achievement_school_teachers' or active == 'achievement_file_detail' %}is-active{% endif %}" href="{% url 'reports:achievement_school_files' %}">Ù…Ù„ÙØ§Øª Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</a>
            {% endif %}
          {% else %}
            <a class="tab {% if active == 'home' %}is-active{% endif %}" href="{% url 'reports:home' %}">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>

            {% url 'reports:assigned_to_me' as inboxUrl %}
            {% if inboxUrl %}
              <a class="tab {% if active == 'assigned_to_me' %}is-active{% endif %}" href="{{ inboxUrl }}">
                Ø§Ù„ÙˆØ§Ø±Ø¯
                {% if NAV_ASSIGNED_TO_ME %}<span class="pill">{{ NAV_ASSIGNED_TO_ME }}</span>{% endif %}
              </a>
            {% endif %}

            {% if SHOW_SCHOOL_REPORTS_LINK %}
              <a class="tab {% if active == 'admin_reports' %}is-active{% endif %}" href="{% url 'reports:admin_reports' %}">ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</a>
            {% elif SHOW_DEPARTMENT_REPORTS_LINK and DEPARTMENT_REPORTS_URLNAME %}
              <a class="tab {% if active == 'officer_reports' or active == 'department_reports' %}is-active{% endif %}" href="{% url DEPARTMENT_REPORTS_URLNAME %}">ØªÙ‚Ø§Ø±ÙŠØ± Ù‚Ø³Ù…ÙŠ</a>
            {% endif %}

            {% if request.user.is_superuser %}
              <a class="tab {% if active == 'platform_admin_dashboard' %}is-active{% endif %}" href="{% url 'reports:platform_admin_dashboard' %}">Ù„ÙˆØ­Ø© Ø§Ù„Ø¢Ø¯Ù…Ù†</a>
            {% elif SHOW_ADMIN_DASHBOARD_LINK %}
              <a class="tab {% if active == 'admin_dashboard' %}is-active{% endif %}" href="{% url 'reports:admin_dashboard' %}">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±</a>
            {% endif %}
          {% endif %}
        {% else %}
          <a class="tab is-active" href="{% url 'reports:login' %}">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>
        {% endif %}
      </nav>
      {% endwith %}

      <div class="hdr-actions">
        {% if request.user.is_authenticated %}

          {% if USER_SCHOOLS|length > 1 %}
            {% if not request.user.is_platform_admin or request.user.is_superuser %}
              <button type="button" class="btn btn-outline btn-sm" id="openSchoolModal" aria-haspopup="dialog" aria-controls="schoolModal" aria-expanded="false">
                <i class="fa-solid fa-school" aria-hidden="true"></i>
                <span style="font-weight:950;max-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">
                  {% if SCHOOL_NAME %}{{ SCHOOL_NAME }}{% else %}Ø§Ø®ØªØ± Ù…Ø¯Ø±Ø³Ø©{% endif %}
                </span>
                <i class="fa-solid fa-chevron-down" aria-hidden="true"></i>
              </button>
            {% endif %}
          {% endif %}

          {% if not IS_REPORT_VIEWER %}
            {% if not request.user.is_platform_admin or request.user.is_superuser %}
              {% url 'reports:my_notifications' as myNotificationsUrl %}
              {% if myNotificationsUrl %}
                <a class="icon-btn" href="{{ myNotificationsUrl }}" aria-label="Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª" id="notifBell">
                  <i class="fa-solid fa-bell"></i>
                  {% with unread=NAV_NOTIFICATIONS_UNREAD|default_if_none:"0"|add:"0" %}
                    <span class="dot" id="notifDot" {% if unread == 0 %}style="display:none"{% endif %}>{{ unread }}</span>
                  {% endwith %}
                </a>
              {% endif %}

              {% url 'reports:my_circulars' as myCircularsUrl %}
              {% if myCircularsUrl %}
                <a class="icon-btn" href="{{ myCircularsUrl }}" aria-label="Ø§Ù„ØªØ¹Ø§Ù…ÙŠÙ…" id="circBell" title="Ø§Ù„ØªØ¹Ø§Ù…ÙŠÙ…">
                  <i class="fa-solid fa-pen-to-square"></i>
                  {% with pending=NAV_SIGNATURES_PENDING|default_if_none:"0"|add:"0" %}
                    <span class="dot" id="circDot" {% if pending == 0 %}style="display:none"{% endif %}>{{ pending }}</span>
                  {% endwith %}
                </a>
              {% endif %}

              {% if CAN_SEND_NOTIFICATIONS and SEND_NOTIFICATION_URL %}
                <a class="icon-btn" href="{{ SEND_NOTIFICATION_URL }}" aria-label="Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±" title="Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±">
                  <i class="fa-solid fa-paper-plane" aria-hidden="true"></i>
                </a>
              {% endif %}

              <button class="icon-btn theme-toggle" id="themeToggle" type="button" aria-label="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø«ÙŠÙ…" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø«ÙŠÙ…">
                <i class="fa-solid fa-moon"></i>
              </button>
            {% endif %}
          {% endif %}

          <div class="userbox">
            {% firstof request.user.name request.user.phone request.user.national_id "Ø­Ø³Ø§Ø¨ÙŠ" as display_name %}
            <button class="avatar" id="userAvatar" type="button" aria-haspopup="menu" aria-expanded="false" title="{{ display_name }}">
              {{ display_name|slice:":1" }}
            </button>
            <div class="menu" id="userMenu" role="menu" aria-label="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
              <div class="mi" tabindex="0" style="cursor:default">
                <div>
                  <div style="font-weight:950">{{ display_name }}</div>
                  <div class="meta">Ù…Ø±Ø­Ø¨Ø§Ù‹ ğŸ‘‹</div>
                </div>
              </div>

              {% if IS_REPORT_VIEWER %}
                <a href="{% url 'reports:school_reports_readonly' %}" class="mi" role="menuitem">
                  <i class="fa-solid fa-file-lines" aria-hidden="true"></i>
                  Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
                </a>
                <a href="{% url 'reports:achievement_school_files' %}" class="mi" role="menuitem">
                  <i class="fa-solid fa-file-lines" aria-hidden="true"></i>
                  Ù…Ù„ÙØ§Øª Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²
                </a>
              {% else %}
                {% if request.user.is_platform_admin and not request.user.is_superuser %}
                  {% if SCHOOL_ID %}
                    <a href="{% url 'reports:platform_school_reports' %}" class="mi" role="menuitem">
                      <i class="fa-solid fa-file-lines" aria-hidden="true"></i>
                      Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
                    </a>
                    <a href="{% url 'reports:platform_school_tickets' %}" class="mi" role="menuitem">
                      <i class="fa-solid fa-ticket" aria-hidden="true"></i>
                      Ø§Ù„ØªØ°Ø§ÙƒØ±
                    </a>
                  {% else %}
                    <a href="{% url 'reports:platform_schools_directory' %}" class="mi" role="menuitem">
                      <i class="fa-solid fa-school" aria-hidden="true"></i>
                      Ø§Ù„Ù…Ø¯Ø§Ø±Ø³
                    </a>
                  {% endif %}

                  <a href="{% url 'reports:achievement_school_files' %}" class="mi" role="menuitem">
                    <i class="fa-solid fa-file-lines" aria-hidden="true"></i>
                    Ù…Ù„ÙØ§Øª Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²
                  </a>

                {% elif request.user.is_superuser or SHOW_ADMIN_DASHBOARD_LINK %}
                  <a href="{% url 'reports:achievement_school_files' %}" class="mi" role="menuitem">
                    <i class="fa-solid fa-file-lines" aria-hidden="true"></i>
                    Ù…Ù„ÙØ§Øª Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²
                  </a>
                {% else %}
                  <a href="{% url 'reports:achievement_my_files' %}" class="mi" role="menuitem">
                    <i class="fa-solid fa-file-lines" aria-hidden="true"></i>
                    Ù…Ù„Ù Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²
                  </a>
                {% endif %}

                <a href="{% url 'reports:my_profile' %}" class="mi" role="menuitem">
                  <i class="fa-solid fa-user" aria-hidden="true"></i>
                  Ø­Ø³Ø§Ø¨ÙŠ
                </a>
              {% endif %}

              <a href="{% url 'reports:logout' %}" class="mi" role="menuitem">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
            </div>
          </div>

        {% else %}
          <a class="tab is-active" href="{% url 'reports:login' %}">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>
        {% endif %}
      </div>
    </div>
  </header>

  <div class="drawer-overlay" id="drawerOverlay" aria-hidden="true"></div>
  <aside class="drawer" id="mobileDrawer" aria-hidden="true" aria-labelledby="drawerTitle">
    <div class="drawer-head">
      <div id="drawerTitle" class="drawer-title">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</div>
      <button class="btn btn-sm" id="drawerClose" aria-label="Ø¥ØºÙ„Ø§Ù‚">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>

    {% if request.user.is_authenticated and not IS_REPORT_VIEWER %}
      {% if not request.user.is_platform_admin or request.user.is_superuser %}
        <div class="drawer-actions">
          {% url 'reports:my_notifications' as myNotificationsUrlMobile %}
          {% if myNotificationsUrlMobile %}
            <a class="icon-btn" href="{{ myNotificationsUrlMobile }}" aria-label="Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª" id="notifBellMobile">
              <i class="fa-solid fa-bell"></i>
              {% with unread=NAV_NOTIFICATIONS_UNREAD|default_if_none:"0"|add:"0" %}
                <span class="dot" id="notifDotMobile" {% if unread == 0 %}style="display:none"{% endif %}>{{ unread }}</span>
              {% endwith %}
            </a>
          {% endif %}

          {% url 'reports:my_circulars' as myCircularsUrlMobile %}
          {% if myCircularsUrlMobile %}
            <a class="icon-btn" href="{{ myCircularsUrlMobile }}" aria-label="Ø§Ù„ØªØ¹Ø§Ù…ÙŠÙ…" id="circBellMobile" title="Ø§Ù„ØªØ¹Ø§Ù…ÙŠÙ…">
              <i class="fa-solid fa-pen-to-square"></i>
              {% with pending=NAV_SIGNATURES_PENDING|default_if_none:"0"|add:"0" %}
                <span class="dot" id="circDotMobile" {% if pending == 0 %}style="display:none"{% endif %}>{{ pending }}</span>
              {% endwith %}
            </a>
          {% endif %}

          {% if CAN_SEND_NOTIFICATIONS and SEND_NOTIFICATION_URL %}
            <a class="icon-btn" href="{{ SEND_NOTIFICATION_URL }}" aria-label="Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±" title="Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±">
              <i class="fa-solid fa-paper-plane" aria-hidden="true"></i>
            </a>
          {% endif %}

          <button class="icon-btn theme-toggle" type="button" aria-label="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø«ÙŠÙ…" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø«ÙŠÙ…">
            <i class="fa-solid fa-moon"></i>
          </button>
        </div>
      {% endif %}
    {% endif %}

    {% with active=request.resolver_match.url_name %}
    <nav class="drawer-nav" aria-label="Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©">
      {% if request.user.is_authenticated %}

        {% if IS_REPORT_VIEWER %}
          <a class="{% if active == 'school_reports_readonly' %}is-active{% endif %}" href="{% url 'reports:school_reports_readonly' %}">
            <span>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</span>
            <i class="fa-solid fa-file-lines"></i>
          </a>
          <a class="{% if active == 'achievement_school_files' or active == 'achievement_school_teachers' or active == 'achievement_file_detail' %}is-active{% endif %}" href="{% url 'reports:achievement_school_files' %}">
            <span>Ù…Ù„ÙØ§Øª Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</span>
            <i class="fa-solid fa-file-lines"></i>
          </a>
          <a href="{% url 'reports:logout' %}">
            <span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span>
            <i class="fa-solid fa-right-to-bracket"></i>
          </a>
        {% elif request.user.is_platform_admin and not request.user.is_superuser %}

        <a class="{% if active == 'home' or active == 'platform_school_dashboard' or active == 'platform_schools_directory' %}is-active{% endif %}" href="{% if SCHOOL_ID %}{% url 'reports:platform_school_dashboard' %}{% else %}{% url 'reports:platform_schools_directory' %}{% endif %}">
          <span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
          <i class="fa-solid fa-house"></i>
        </a>

        <a class="{% if active == 'platform_schools_directory' %}is-active{% endif %}" href="{% url 'reports:platform_schools_directory' %}">
          <span>Ø§Ù„Ù…Ø¯Ø§Ø±Ø³</span>
          <i class="fa-solid fa-school"></i>
        </a>

        {% if SCHOOL_ID %}
          <a class="{% if active == 'platform_school_reports' %}is-active{% endif %}" href="{% url 'reports:platform_school_reports' %}">
            <span>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</span>
            <i class="fa-solid fa-file-lines"></i>
          </a>
          <a class="{% if active == 'platform_school_tickets' or active == 'ticket_detail' %}is-active{% endif %}" href="{% url 'reports:platform_school_tickets' %}">
            <span>Ø§Ù„ØªØ°Ø§ÙƒØ±</span>
            <i class="fa-solid fa-ticket"></i>
          </a>
          <a class="{% if active == 'achievement_school_files' or active == 'achievement_school_teachers' or active == 'achievement_file_detail' %}is-active{% endif %}" href="{% url 'reports:achievement_school_files' %}">
            <span>Ù…Ù„ÙØ§Øª Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</span>
            <i class="fa-solid fa-file-lines"></i>
          </a>
        {% endif %}

        <a class="{% if active == 'my_profile' %}is-active{% endif %}" href="{% url 'reports:my_profile' %}">
          <span>Ø­Ø³Ø§Ø¨ÙŠ</span>
          <i class="fa-solid fa-user"></i>
        </a>

        <div class="drawer-footer">
          <a class="btn btn-outline btn-block" href="{% url 'reports:logout' %}">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
        </div>

        {% else %}

        <a class="{% if active == 'home' %}is-active{% endif %}" href="{% url 'reports:home' %}">
          <span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
          <i class="fa-solid fa-house"></i>
        </a>

        {% url 'reports:assigned_to_me' as inboxUrl2 %}
        {% if inboxUrl2 %}
          <a class="{% if active == 'assigned_to_me' %}is-active{% endif %}" href="{{ inboxUrl2 }}">
            <span>Ø§Ù„ÙˆØ§Ø±Ø¯</span>
            <span>{% if NAV_ASSIGNED_TO_ME %}<span class="pill">{{ NAV_ASSIGNED_TO_ME }}</span>{% endif %}</span>
          </a>
        {% endif %}

        {% if SHOW_DEPARTMENT_REPORTS_LINK and DEPARTMENT_REPORTS_URLNAME %}
          <a class="{% if active == 'officer_reports' or active == 'department_reports' %}is-active{% endif %}" href="{% url DEPARTMENT_REPORTS_URLNAME %}">
            <span>ØªÙ‚Ø§Ø±ÙŠØ± Ù‚Ø³Ù…ÙŠ</span>
            <i class="fa-solid fa-layer-group"></i>
          </a>
        {% endif %}

        {% if SHOW_ADMIN_DASHBOARD_LINK %}
          {% if request.user.is_superuser %}
            <a class="{% if active == 'platform_admin_dashboard' %}is-active{% endif %}" href="{% url 'reports:platform_admin_dashboard' %}">
              <span>Ù„ÙˆØ­Ø© Ø§Ù„Ø¢Ø¯Ù…Ù†</span>
              <i class="fa-solid fa-gauge-high"></i>
            </a>
          {% else %}
            <a class="{% if active == 'admin_dashboard' %}is-active{% endif %}" href="{% url 'reports:admin_dashboard' %}">
              <span>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±</span>
              <i class="fa-solid fa-gauge"></i>
            </a>
          {% endif %}
        {% endif %}

        {% if request.user.is_superuser or SHOW_ADMIN_DASHBOARD_LINK %}
          <a class="{% if active == 'achievement_school_files' or active == 'achievement_school_teachers' %}is-active{% endif %}" href="{% url 'reports:achievement_school_files' %}">
            <span>Ù…Ù„ÙØ§Øª Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</span>
            <i class="fa-solid fa-file-lines"></i>
          </a>
        {% else %}
          <a class="{% if active == 'achievement_my_files' %}is-active{% endif %}" href="{% url 'reports:achievement_my_files' %}">
            <span>Ù…Ù„Ù Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</span>
            <i class="fa-solid fa-file-lines"></i>
          </a>
        {% endif %}

        <a class="{% if active == 'my_profile' %}is-active{% endif %}" href="{% url 'reports:my_profile' %}">
          <span>Ø­Ø³Ø§Ø¨ÙŠ</span>
          <i class="fa-solid fa-user"></i>
        </a>

        <div class="drawer-footer">
          {% if USER_SCHOOLS|length > 1 %}
            <button type="button" class="btn btn-primary btn-block" id="openSchoolModalMobile">
              <i class="fa-solid fa-school" style="margin-inline-end:8px"></i>
              ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©
            </button>
          {% endif %}
          <a class="btn btn-outline btn-block" href="{% url 'reports:logout' %}">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
        </div>

        {% endif %}

      {% else %}
        <a class="{% if active == 'login' %}is-active{% endif %}" href="{% url 'reports:login' %}">
          <span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</span>
          <i class="fa-solid fa-right-to-bracket"></i>
        </a>
      {% endif %}
    </nav>
    {% endwith %}
  </aside>

  {% if messages %}
    <div class="messages" id="messages-container" aria-live="polite" aria-atomic="true">
      {% for message in messages %}
        <div class="msg {% if message.tags %}{{ message.tags }}{% else %}info{% endif %}" role="alert" data-autohide="true">
          <div class="msg-icon">
             {% if 'success' in message.tags %}
               <i class="fa-solid fa-check-circle"></i>
             {% elif 'error' in message.tags or 'danger' in message.tags %}
               <i class="fa-solid fa-circle-exclamation"></i>
             {% elif 'warning' in message.tags %}
               <i class="fa-solid fa-triangle-exclamation"></i>
             {% else %}
               <i class="fa-solid fa-circle-info"></i>
             {% endif %}
          </div>
          <div class="msg-content">{{ message }}</div>
          <button class="msg-close" aria-label="Ø¥ØºÙ„Ø§Ù‚" type="button"><i class="fa-solid fa-xmark"></i></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <main class="container page-main" id="mainContent">
    {% block content %}{% endblock %}
  </main>

  <footer class="site-footer" aria-label="ØªØ°ÙŠÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…">
    <div class="container">
      <div class="footer-grid">
        
        {# About Section #}
        <div class="footer-col footer-about">
          <div class="footer-logo">
            <img src="{% if SCHOOL_LOGO_URL %}{{ SCHOOL_LOGO_URL }}{% else %}{% static 'img/logo1.png' %}{% endif %}" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù…">
            <div class="footer-logo-text">
              <h3>{% if SCHOOL_NAME %}{{ SCHOOL_NAME }}{% else %}ØªÙˆØ«ÙŠÙ‚{% endif %}</h3>
              <p>Ù…Ù†ØµØ© ØªÙ€Ù€ÙˆØ«ÙŠÙ‚ </p>
            </div>
          </div>
          <p class="footer-desc">
            Ù†Ø¸Ø§Ù… Ù…ØªÙƒØ§Ù…Ù„ Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆØ§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙˆÙ…Ù„ÙØ§Øª Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²ØŒ Ù…ØµÙ…Ù… Ø®ØµÙŠØµØ§Ù‹ Ù„Ù„Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©.
          </p>
        </div>

        {# Quick Links #}
        <div class="footer-col">
          <h4><i class="fa-solid fa-link"></i> Ø±ÙˆØ§Ø¨Ø· Ø³Ø±ÙŠØ¹Ø©</h4>
          <ul class="footer-links">
            {% if request.user.is_authenticated %}
              {% if IS_REPORT_VIEWER %}
                <li><a href="{% url 'reports:school_reports_readonly' %}"><i class="fa-solid fa-chevron-left"></i> Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</a></li>
                <li><a href="{% url 'reports:achievement_school_files' %}"><i class="fa-solid fa-chevron-left"></i> Ù…Ù„ÙØ§Øª Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</a></li>
              {% else %}
                <li><a href="{% url 'reports:home' %}"><i class="fa-solid fa-chevron-left"></i> Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
                <li><a href="{% url 'reports:my_reports' %}"><i class="fa-solid fa-chevron-left"></i> ØªÙ‚Ø§Ø±ÙŠØ±ÙŠ</a></li>
                <li><a href="{% url 'reports:my_requests' %}"><i class="fa-solid fa-chevron-left"></i> Ø·Ù„Ø¨Ø§ØªÙŠ</a></li>
                <li><a href="{% url 'reports:my_notifications' %}"><i class="fa-solid fa-chevron-left"></i> Ø¥Ø´Ø¹Ø§Ø±Ø§ØªÙŠ</a></li>
              {% endif %}
            {% else %}
              <li><a href="{% url 'reports:landing' %}"><i class="fa-solid fa-chevron-left"></i> Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
              <li><a href="{% url 'reports:login' %}"><i class="fa-solid fa-chevron-left"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a></li>
            {% endif %}
          </ul>
        </div>

        {# Resources #}
        <div class="footer-col">
          <h4><i class="fa-solid fa-book"></i> Ø§Ù„Ù…ÙˆØ§Ø±Ø¯</h4>
          <ul class="footer-links">
            <li><a href="{% url 'reports:user_guide' %}"><i class="fa-solid fa-chevron-left"></i> Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</a></li>
            <li><a href="{% url 'reports:faq' %}"><i class="fa-solid fa-chevron-left"></i> Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©</a></li>
            <li><a href="{% url 'reports:support_ticket_create' %}"><i class="fa-solid fa-chevron-left"></i> Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ</a></li>
            <li><a href="{% url 'reports:privacy_policy' %}"><i class="fa-solid fa-chevron-left"></i> Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©</a></li>
          </ul>
        </div>

        {# Contact #}
        <div class="footer-col">
          <h4><i class="fa-solid fa-phone"></i> ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§</h4>
          <div class="footer-contact">
            <div class="footer-contact-item">
              <i class="fa-solid fa-envelope"></i>
              <span>xmansx1122@gmail.com</span>
            </div>
            <div class="footer-contact-item">
              <i class="fa-brands fa-whatsapp"></i>
              <span>+966 537720207</span>
            </div>
            <div class="footer-contact-item">
              <i class="fa-solid fa-location-dot"></i>
              <span>Ø§Ù„Ø±ÙŠØ§Ø¶ØŒ Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©</span>
            </div>
          </div>
        </div>

      </div>

      {# Bottom Bar #}
      <div class="footer-bottom">
        <div class="footer-copyright">
          Â© {% now "Y" %} Ù…Ù†ØµØ© ØªÙˆØ«ÙŠÙ‚. Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.  <i class="fa-solid fa-heart"></i> 
        </div>
        <div class="footer-badges">
          <span class="footer-badge">
            <i class="fa-solid fa-shield-halved"></i>
            Ø¢Ù…Ù† ÙˆÙ…Ø´ÙØ±
          </span>
          <span class="footer-badge">
            <i class="fa-solid fa-mobile-screen-button"></i>
            Ù…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ø¬ÙˆØ§Ù„
          </span>
          <span class="footer-badge">
            <i class="fa-solid fa-bolt"></i>
            Ø³Ø±ÙŠØ¹ ÙˆÙ…ÙˆØ«ÙˆÙ‚
          </span>
        </div>
      </div>
    </div>
  </footer>

  <button class="to-top" id="toTop" aria-label="Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø£Ø¹Ù„Ù‰">
    <i class="fa-solid fa-arrow-left-long" style="transform:rotate(90deg)"></i>
  </button>

  {% if request.user.is_authenticated %}
    {% if USER_SCHOOLS|length > 1 %}
      <div class="school-modal" id="schoolModal" aria-hidden="true">
        <div class="school-panel" role="dialog" aria-modal="true" aria-labelledby="schoolModalTitle" tabindex="-1">
          <div class="school-panel-h">
            <div>
              <b id="schoolModalTitle">Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„Ù…Ø¯Ø§Ø±Ø³</b>
              <div class="muted" style="font-weight:900;font-size:.9rem;margin-top:2px">Ø§Ø¨Ø­Ø« Ø«Ù… Ø§Ø®ØªØ± Ù…Ø¯Ø±Ø³Ø© Ù„Ù„ØªØ¨Ø¯ÙŠÙ„ ÙÙˆØ±Ø§Ù‹</div>
            </div>
            <button type="button" class="school-panel-close" id="closeSchoolModal" aria-label="Ø¥ØºÙ„Ø§Ù‚">
              <i class="fa-solid fa-xmark"></i>
            </button>
          </div>

          <div class="school-panel-b">
            <input type="search" class="input school-search" id="schoolSearch" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ù„Ù„Ø¨Ø­Ø«..." aria-label="Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¯Ø±Ø³Ø©">

            <form method="post" action="{% url 'reports:switch_school' %}" id="schoolSwitchForm">
              {% csrf_token %}
              <input type="hidden" name="next" value="{{ request.path }}">
              <input type="hidden" name="school_id" id="schoolIdField">

              <ul class="school-list" id="schoolList">
                {% for s in USER_SCHOOLS %}
                  <li>
                    <button type="button"
                      class="school-item {% if SCHOOL_ID and s.id == SCHOOL_ID %}current-school{% endif %}"
                      data-school-id="{{ s.id }}"
                      data-school-name="{{ s.name }}"
                    >
                      <div class="school-item-text">
                        <b>{{ s.name }}</b>
                        <small>{% if s.id == SCHOOL_ID %}Ù‡Ø°Ù‡ Ù‡ÙŠ Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©{% else %}Ø§Ø¶ØºØ· Ù„Ù„ØªØ¨Ø¯ÙŠÙ„{% endif %}</small>
                      </div>
                      <span class="tag">
                        {% if s.id == SCHOOL_ID %}Ø§Ù„Ø­Ø§Ù„ÙŠØ©{% else %}ØªØ¨Ø¯ÙŠÙ„{% endif %}
                      </span>
                    </button>
                  </li>
                {% endfor %}
              </ul>

              <noscript>
                <div class="stack" style="margin-top:10px">
                  <select name="school_id" class="select" style="min-height:48px;font-weight:900">
                    {% for s in USER_SCHOOLS %}
                      <option value="{{ s.id }}" {% if SCHOOL_ID and s.id == SCHOOL_ID %}selected{% endif %}>{{ s.name }}</option>
                    {% endfor %}
                  </select>
                  <button class="btn btn-primary btn-block" type="submit">ØªØ¨Ø¯ÙŠÙ„</button>
                </div>
              </noscript>
            </form>
          </div>
        </div>
      </div>
    {% endif %}
  {% endif %}

  <script nonce="{{ CSP_NONCE }}">
    // ===== Cookies (SameSite=Lax + Secure on https) =====
    (function(){
      window.getCookie = function(name){
        const parts = document.cookie ? document.cookie.split('; ') : [];
        for(const p of parts){
          const i = p.indexOf('=');
          const k = i > -1 ? p.slice(0,i) : p;
          if(k === name) return i > -1 ? decodeURIComponent(p.slice(i+1)) : '';
        }
        return null;
      };
      window.setCookie = function(name, value, days){
        const d = new Date(Date.now() + (days||365)*864e5);
        const secure = location.protocol === 'https:' ? '; Secure' : '';
        document.cookie = name + '=' + encodeURIComponent(value) + '; path=/; expires=' + d.toUTCString() + '; SameSite=Lax' + secure;
      };
    })();

    // ===== Lock scroll + Focus trap =====
    (function(){
      window.__lockScroll = function(on){
        document.documentElement.style.overflow = on ? 'hidden' : '';
      };

      window.__trapFocus = function(container, enabled){
        if(!container) return;
        const key = '__focusTrapHandler';
        if(!enabled){
          if(container[key]) container.removeEventListener('keydown', container[key]);
          container[key] = null;
          return;
        }
        container[key] = function(e){
          if(e.key !== 'Tab') return;
          const focusables = container.querySelectorAll(
            'a[href], button:not([disabled]), input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])'
          );
          if(!focusables.length) return;
          const first = focusables[0];
          const last = focusables[focusables.length - 1];
          if(e.shiftKey && document.activeElement === first){
            e.preventDefault(); last.focus();
          } else if(!e.shiftKey && document.activeElement === last){
            e.preventDefault(); first.focus();
          }
        };
        container.addEventListener('keydown', container[key]);
      };
    })();

    // ===== Theme (data-theme) =====
    (function(){
      const root = document.documentElement;
      const btns = document.querySelectorAll('.theme-toggle');

      const apply = (theme)=>{
        root.setAttribute('data-theme', theme);
        window.setCookie('theme', theme, 365);
        btns.forEach(btn => {
          const icon = btn.querySelector('i');
          if(icon){
            icon.className = theme === 'dark' ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
          }
        });
      };

      const saved = window.getCookie('theme');
      if(saved === 'dark' || saved === 'light'){
        apply(saved);
      }else{
        if(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches){
          root.setAttribute('data-theme', 'dark');
          btns.forEach(btn => {
            const icon = btn.querySelector('i');
            if(icon) icon.className = 'fa-solid fa-sun';
          });
        }
      }

      btns.forEach(btn => {
        btn.addEventListener('click', ()=>{
          const current = root.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
          apply(current === 'dark' ? 'light' : 'dark');
        });
      });
    })();

    // ===== Progress + Header shadow =====
    (function(){
      const bar = document.getElementById('scrollProgress');
      const header = document.getElementById('siteHeader');
      const onScroll = ()=>{
        const h = document.documentElement;
        const sc = h.scrollTop;
        const max = h.scrollHeight - h.clientHeight;
        if(bar) bar.style.width = (max ? (sc/max)*100 : 0) + '%';
        if(header) header.classList.toggle('scrolled', window.scrollY > 4);
      };
      window.addEventListener('scroll', onScroll, {passive:true});
      onScroll();
    })();

    // ===== Toasts =====
    (function(){
      const container = document.getElementById('messages-container');
      if(!container) return;

      const AUTOHIDE_MS = 5000;
      const HIDE_ANIM_MS = 250;

      container.querySelectorAll('.msg').forEach((el)=>{
        const closeBtn = el.querySelector('.msg-close');
        let timer = null;

        const remove = ()=>{
          if(!el || !el.parentNode) return;
          el.classList.add('is-hiding');
          setTimeout(()=>{ if(el && el.parentNode) el.remove(); }, HIDE_ANIM_MS);
        };
        const start = ()=>{
          if(el.dataset.autohide === 'false') return;
          timer = setTimeout(remove, AUTOHIDE_MS);
        };
        const stop = ()=>{ if(timer){ clearTimeout(timer); timer = null; } };

        if(closeBtn) closeBtn.addEventListener('click', remove);
        el.addEventListener('mouseenter', stop);
        el.addEventListener('mouseleave', start);
        start();
      });
    })();

    // ===== Drawer =====
    (function(){
      const drawer    = document.getElementById('mobileDrawer');
      const overlay   = document.getElementById('drawerOverlay');
      const hamburger = document.getElementById('hamburger');
      const closeBtn  = document.getElementById('drawerClose');
      if(!drawer || !overlay || !hamburger) return;

      const open = ()=>{
        drawer.classList.add('open');
        overlay.classList.add('show');
        overlay.setAttribute('aria-hidden', 'false');
        hamburger.classList.add('active');
        hamburger.setAttribute('aria-expanded','true');
        drawer.setAttribute('aria-hidden','false');
        window.__lockScroll(true);
        window.__trapFocus(drawer, true);
        const first = drawer.querySelector('a, button');
        if(first) first.focus();
      };

      const close = ()=>{
        drawer.classList.remove('open');
        overlay.classList.remove('show');
        overlay.setAttribute('aria-hidden', 'true');
        hamburger.classList.remove('active');
        hamburger.setAttribute('aria-expanded','false');
        drawer.setAttribute('aria-hidden','true');
        window.__lockScroll(false);
        window.__trapFocus(drawer, false);
        hamburger.focus();
      };

      hamburger.addEventListener('click', ()=> drawer.classList.contains('open') ? close() : open());
      if(closeBtn) closeBtn.addEventListener('click', close);
      overlay.addEventListener('click', (e)=>{ if(e.target === overlay) close(); });
      document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') close(); });

      drawer.addEventListener('click', (e)=>{
        const a = e.target.closest('a');
        if(a && a.href) close();
      });
    })();

    // ===== User menu =====
    (function(){
      const avatar = document.getElementById('userAvatar');
      const menu = document.getElementById('userMenu');
      if(!avatar || !menu) return;

      const close = ()=>{ menu.classList.remove('open'); avatar.setAttribute('aria-expanded','false'); };

      avatar.addEventListener('click', ()=>{
        const isOpen = menu.classList.toggle('open');
        avatar.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
      });

      document.addEventListener('click', (e)=>{
        if(!e.target.closest('#userMenu') && !e.target.closest('#userAvatar')) close();
      });
      document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') close(); });
    })();

    // ===== To top =====
    (function(){
      const toTop = document.getElementById('toTop');
      if(!toTop) return;
      const toggle = ()=>{ window.scrollY > 260 ? (toTop.style.display='grid') : (toTop.style.display='none'); };
      window.addEventListener('scroll', toggle, {passive:true}); toggle();
      toTop.addEventListener('click', ()=>window.scrollTo({top:0, behavior:'smooth'}));
    })();

    // ===== School Modal =====
    (function(){
      const modal = document.getElementById('schoolModal');
      const panel = modal ? modal.querySelector('.school-panel') : null;
      const openBtn = document.getElementById('openSchoolModal');
      const openBtnMobile = document.getElementById('openSchoolModalMobile');
      const closeBtn = document.getElementById('closeSchoolModal');
      const form = document.getElementById('schoolSwitchForm');
      const schoolIdField = document.getElementById('schoolIdField');
      const schoolList = document.getElementById('schoolList');
      const searchInput = document.getElementById('schoolSearch');

      if (!modal || !form || !schoolList || !panel) return;

      const openModal = () => {
        modal.classList.add('open');
        modal.setAttribute('aria-hidden', 'false');
        window.__lockScroll(true);
        window.__trapFocus(panel, true);
        setTimeout(() => { if(searchInput) searchInput.focus(); }, 150);
      };

      const closeModal = () => {
        modal.classList.remove('open');
        modal.setAttribute('aria-hidden', 'true');
        window.__lockScroll(false);
        window.__trapFocus(panel, false);
        if(openBtn) openBtn.focus();
      };

      if (openBtn) openBtn.addEventListener('click', openModal);
      if (openBtnMobile) openBtnMobile.addEventListener('click', openModal);
      if (closeBtn) closeBtn.addEventListener('click', closeModal);

      modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.classList.contains('open')) closeModal();
      });

      schoolList.addEventListener('click', (e) => {
        const item = e.target.closest('.school-item');
        if (item && !item.classList.contains('current-school')) {
          const schoolId = item.dataset.schoolId;
          schoolIdField.value = schoolId;
          form.submit();
        }
      });

      if(searchInput){
        searchInput.addEventListener('input', (e) => {
          const query = (e.target.value || '').toLowerCase().trim();
          const items = schoolList.querySelectorAll('li');
          items.forEach(li => {
            const btn = li.querySelector('.school-item');
            const name = btn ? (btn.dataset.schoolName || '').toLowerCase() : '';
            li.style.display = name.includes(query) ? '' : 'none';
          });
        });
      }
    })();
  </script>

  <!-- PWA Install Banner -->
  <div id="pwaInstallBanner" class="pwa-banner" role="region" aria-label="ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚">
    <div class="pwa-card">
      <div class="pwa-text">
        <p class="pwa-title">Ø«Ø¨Øª Ù…Ù†ØµØ© ØªÙˆØ«ÙŠÙ‚ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ</p>
        <p id="pwaInstallHint" class="pwa-sub">ÙŠÙ…ÙƒÙ†Ùƒ ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹ ÙˆØ§Ù„Ø¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ø£ÙØ¶Ù„.</p>
      </div>
      <div class="pwa-actions">
        <button id="pwaInstallBtn" class="pwa-btn" type="button" style="display:none">ØªØ«Ø¨ÙŠØª</button>
        <button id="pwaInstallClose" class="pwa-close" type="button" aria-label="Ø¥ØºÙ„Ø§Ù‚">
          <i class="fa-solid fa-xmark" aria-hidden="true"></i>
        </button>
      </div>
    </div>
  </div>

  <script nonce="{{ CSP_NONCE }}">
    // Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').catch(() => {});
      });
    }

    // PWA Install Prompt + iOS guidance
    (function(){
      const banner = document.getElementById('pwaInstallBanner');
      const btn = document.getElementById('pwaInstallBtn');
      const closeBtn = document.getElementById('pwaInstallClose');
      const hint = document.getElementById('pwaInstallHint');
      if (!banner || !btn || !closeBtn || !hint) return;

      const dismissedKey = 'pwa_install_dismissed_v1';
      const isStandalone = window.matchMedia && window.matchMedia('(display-mode: standalone)').matches;
      const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
      const isSafari = isIOS && /safari/i.test(navigator.userAgent) && !/crios|fxios|edgios/i.test(navigator.userAgent);
      const iosStandalone = Boolean(window.navigator.standalone);

      try { if (localStorage.getItem(dismissedKey) === '1') return; } catch (e) {}
      if (isStandalone || iosStandalone) return;

      function openBanner(){ banner.classList.add('open'); }
      function closeBanner(){
        banner.classList.remove('open');
        try{ localStorage.setItem(dismissedKey, '1'); }catch(e){}
      }

      closeBtn.addEventListener('click', closeBanner);

      let deferredPrompt = null;
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        btn.style.display = '';
        hint.textContent = 'Ø§Ø¶ØºØ· ØªØ«Ø¨ÙŠØª Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©.';
        openBanner();
      });

      btn.addEventListener('click', async () => {
        if (!deferredPrompt) return;
        deferredPrompt.prompt();
        try { await deferredPrompt.userChoice; }
        finally { deferredPrompt = null; closeBanner(); }
      });

      window.addEventListener('appinstalled', closeBanner);

      if (isSafari) {
        hint.textContent = 'Ø¹Ù„Ù‰ iPhone: Ù…Ù† Ø²Ø± Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø«Ù… "Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©".';
        btn.style.display = 'none';
        openBanner();
      }
    })();

    // Notifications/Circulars: WebSocket push (fallback to polling only if WS fails)
    (function() {
      const notifDot = document.getElementById('notifDot');
      const notifDotMobile = document.getElementById('notifDotMobile');
      const circDot = document.getElementById('circDot');
      const circDotMobile = document.getElementById('circDotMobile');
      if (!notifDot && !notifDotMobile && !circDot && !circDotMobile) return;

      const update = (dot, n) => {
        if (!dot) return;
        const v = Number(n || 0);
        if (v > 0) { dot.textContent = String(v); dot.style.display = 'flex'; }
        else { dot.style.display = 'none'; }
      };

      let current = { unread: 0, signatures_pending: 0, count: 0 };
      function applyCounts(data) {
        current.unread = Math.max(0, Number(data.unread || 0));
        current.signatures_pending = Math.max(0, Number(data.signatures_pending || 0));
        current.count = Math.max(0, Number(data.count || 0));
        update(notifDot, current.unread);
        update(notifDotMobile, current.unread);
        update(circDot, current.signatures_pending);
        update(circDotMobile, current.signatures_pending);
      }

      // ------------------ Fallback polling (disabled by default) ------------------
      // Only starts when WebSocket cannot connect / drops.
      const POLL_URL = '{% url "reports:unread_notifications_count" %}';
      const BASE_MS = 60000;
      const MAX_MS = 5 * BASE_MS;
      let pollTimerId = null;
      let pollInFlight = false;
      let pollBackoffMs = BASE_MS;
      let wsDisabled = false;

      function pollClearTimer() {
        if (pollTimerId) {
          clearTimeout(pollTimerId);
          pollTimerId = null;
        }
      }

      function pollScheduleNext(delayMs) {
        pollClearTimer();
        pollTimerId = setTimeout(pollTick, Math.max(1000, delayMs || BASE_MS));
      }

      function pollShouldRun() {
        return !document.hidden;
      }

      function pollTick() {
        if (!pollShouldRun()) return;
        if (pollInFlight) return;
        pollInFlight = true;

        fetch(POLL_URL, { credentials: 'same-origin' })
          .then(r => r.ok ? r.json() : Promise.reject(new Error('http_' + r.status)))
          .then(data => {
            // If session expired/logged out, stop all background reconnect/poll loops.
            // Avoids spamming server logs with unauthenticated WS attempts.
            try {
              if (data && data.authenticated === false) {
                wsDisabled = true;
                try { pollStop(); } catch(e) {}
                try { wsClearReconnect(); } catch(e) {}
                try { wsStopKeepalive(); } catch(e) {}
                try { if (ws) ws.close(); } catch(e) {}
                try { ws = null; } catch(e) {}
                return;
              }
            } catch (e) {}
            applyCounts(data || {});
            pollBackoffMs = BASE_MS;
            pollScheduleNext(BASE_MS);
          })
          .catch(() => {
            pollBackoffMs = Math.min(Math.round(pollBackoffMs * 1.8), MAX_MS);
            pollScheduleNext(pollBackoffMs);
          })
          .finally(() => {
            pollInFlight = false;
          });
      }

      function pollStart() {
        if (!pollShouldRun()) return;
        pollBackoffMs = BASE_MS;
        pollScheduleNext(2000);
      }

      function pollStop() {
        pollClearTimer();
      }

      function enablePollingFallback() {
        try {
          if (window.__srNotifPoll && typeof window.__srNotifPoll.stop === 'function') {
            window.__srNotifPoll.stop();
          }
        } catch (e) {}
        window.__srNotifPoll = { stop: pollStop };
        pollStart();
      }

      // ------------------ WebSocket (primary) ------------------
      // Ensure we never run more than one WS instance.
      try {
        if (window.__srNotifWs && typeof window.__srNotifWs.stop === 'function') {
          window.__srNotifWs.stop();
        }
      } catch (e) {}

      const activeSchoolId = (function(){
        const raw = '{{ SCHOOL_ID|default:"" }}';
        try { return raw ? parseInt(raw, 10) : null; } catch(e){ return null; }
      })();

      let ws = null;
      let wsTimer = null;
      let wsKeepaliveTimer = null;
      let wsBackoffMs = 1000;
      let wsStartedPollingFallback = false;
      let wsEverOpened = false;
      let wsFailedConnects = 0;
      let wsLastVisibilityProbeAt = 0;

      function wsStopKeepalive() {
        try { if (wsKeepaliveTimer) clearInterval(wsKeepaliveTimer); } catch(e) {}
        wsKeepaliveTimer = null;
      }

      function wsStartKeepalive() {
        wsStopKeepalive();
        // Keep the connection alive through proxies/LBs that close idle sockets.
        // Use a lightweight message that the server will ignore.
        wsKeepaliveTimer = setInterval(function(){
          try {
            if (document.hidden) return;
            if (ws && ws.readyState === 1) ws.send(JSON.stringify({ type: 'keepalive' }));
          } catch(e) {}
        }, 45000);
      }

      function wsClearReconnect() {
        if (wsTimer) { clearTimeout(wsTimer); wsTimer = null; }
      }

      function wsUrl() {
        const proto = (window.location.protocol === 'https:') ? 'wss' : 'ws';
        return proto + '://' + window.location.host + '/ws/notifications/';
      }

      function isRelevant(notificationSchoolId) {
        if (!activeSchoolId) return true;
        if (notificationSchoolId === null || notificationSchoolId === undefined || notificationSchoolId === '') return true;
        const sid = Number(notificationSchoolId);
        return sid === Number(activeSchoolId);
      }

      function handleDelta(msg) {
        if (msg.force_resync) {
          try { if (ws && ws.readyState === 1) ws.send(JSON.stringify({ type: 'resync' })); }
          catch(e) {}
          return;
        }

        if (!isRelevant(msg.notification_school_id)) return;

        const du = Number(msg.delta_unread || 0);
        const ds = Number(msg.delta_signatures_pending || 0);
        const dc = Number(msg.delta_count || 0);

        current.unread = Math.max(0, current.unread + du);
        current.signatures_pending = Math.max(0, current.signatures_pending + ds);
        current.count = Math.max(0, current.count + dc);
        update(notifDot, current.unread);
        update(notifDotMobile, current.unread);
        update(circDot, current.signatures_pending);
        update(circDotMobile, current.signatures_pending);
      }

      function wsConnect() {
        if (wsDisabled) return;
        if (!('WebSocket' in window)) {
          enablePollingFallback();
          return;
        }

        wsClearReconnect();

        try {
          ws = new WebSocket(wsUrl());
        } catch (e) {
          enablePollingFallback();
          return;
        }

        ws.onopen = function(){
          wsBackoffMs = 1000;
          wsStartedPollingFallback = false;
          wsEverOpened = true;
          wsFailedConnects = 0;
          try { pollStop(); } catch(e) {}
          wsStartKeepalive();
        };

        ws.onmessage = function(ev){
          let msg = null;
          try { msg = JSON.parse(ev.data); } catch(e) { return; }
          if (!msg || !msg.type) return;

          if (msg.type === 'counts') {
            applyCounts(msg);
            return;
          }

          if (msg.type === 'delta') {
            handleDelta(msg);
            return;
          }
        };

        ws.onerror = function(){
          // allow onclose to handle fallback
        };

        ws.onclose = function(ev){
          ws = null;
          wsStopKeepalive();

          if (wsDisabled) return;

          // If the server explicitly closes due to auth, stop reconnecting.
          try {
            const code = ev && typeof ev.code === 'number' ? ev.code : null;
            if (code === 4401 || code === 4403) {
              wsDisabled = true;
              try { pollStop(); } catch(e) {}
              wsClearReconnect();
              return;
            }
          } catch (e) {}

          // If we never managed to open, treat this as a failed handshake.
          if (!wsEverOpened) {
            wsFailedConnects = (wsFailedConnects || 0) + 1;
          }

          // Activate polling fallback after first WS failure.
          if (!wsStartedPollingFallback) {
            wsStartedPollingFallback = true;
            enablePollingFallback();
          }

          // If WS endpoint is consistently unavailable (e.g. served as plain HTTP and returns 404),
          // avoid tight reconnect loops that spam server logs. Keep polling fallback.
          const HARD_BACKOFF_MS = 10 * 60 * 1000; // 10 minutes
          const MAX_NORMAL_BACKOFF_MS = 30000;

          if (!wsEverOpened && wsFailedConnects >= 3) {
            const jitter = Math.floor(Math.random() * 1500);
            wsTimer = setTimeout(wsConnect, HARD_BACKOFF_MS + jitter);
            return;
          }

          wsBackoffMs = Math.min(Math.round(wsBackoffMs * 1.8), MAX_NORMAL_BACKOFF_MS);
          // Add jitter to avoid reconnect stampedes (deploys / Redis restart).
          const jitter = Math.floor(Math.random() * 500);
          wsTimer = setTimeout(wsConnect, wsBackoffMs + jitter);
        };
      }

      function wsStop() {
        wsClearReconnect();
        wsStopKeepalive();
        try { if (ws) ws.close(); } catch(e) {}
        ws = null;
      }

      document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
          // Do not force close WS; just avoid extra work.
          try { pollStop(); } catch(e) {}
          wsStopKeepalive();
        } else {
          // One-off resync when user returns.
          try { if (ws && ws.readyState === 1) ws.send(JSON.stringify({ type: 'resync' })); }
          catch(e) {}
          try { if (ws && ws.readyState === 1) wsStartKeepalive(); } catch(e) {}
          // If WS is down, fallback polling may be active; restart it.
          try { if (window.__srNotifPoll && typeof window.__srNotifPoll.stop === 'function') pollStart(); } catch(e) {}

          // If we previously entered hard backoff without ever opening, probe WS again on return.
          try {
            if (!ws && (!wsEverOpened) && (wsFailedConnects >= 3)) {
              const now = Date.now();
              if (wsLastVisibilityProbeAt && (now - wsLastVisibilityProbeAt) < 60000) return;
              wsLastVisibilityProbeAt = now;
              wsClearReconnect();
              wsTimer = setTimeout(wsConnect, 2500);
            }
          } catch(e) {}
        }
      }, { passive: true });

      window.__srNotifWs = { stop: wsStop };
      wsConnect();
    })();

    // Smart back: always return to the page the user came from (if possible).
    // Use: <a href="/fallback" data-smart-back="1">Ø±Ø¬ÙˆØ¹</a>
    (function(){
      function isSameOrigin(url){
        try { return new URL(url, window.location.href).origin === window.location.origin; }
        catch(e){ return false; }
      }

      window.smartBack = function(fallbackUrl){
        const fallback = fallbackUrl || '/';
        try{
          if (window.history && window.history.length > 1) {
            window.history.back();
            return;
          }
        } catch(e) {}

        try{
          const ref = document.referrer;
          if (ref && isSameOrigin(ref)) {
            window.location.href = ref;
            return;
          }
        } catch(e) {}

        window.location.href = fallback;
      };

      document.addEventListener('click', function(e){
        const el = e.target && e.target.closest ? e.target.closest('[data-smart-back]') : null;
        if (!el) return;
        const href = el.getAttribute('href') || '/';
        e.preventDefault();
        window.smartBack(href);
      }, true);
    })();
  </script>

  {% block scripts %}{% endblock %}
</body>
</html>
