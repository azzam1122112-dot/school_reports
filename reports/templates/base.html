{% load static %}
<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#2563eb" />
  <meta name="color-scheme" content="light dark" />

  <!-- PWA Meta Tags -->
  <link rel="manifest" href="{% static 'manifest.json' %}">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="ØªÙˆØ«ÙŠÙ‚">
  <link rel="apple-touch-icon" href="{% static 'img/logo1.png' %}">

  <title>{% block title %}Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±{% endblock %}</title>

  <!-- Performance -->
  <link rel="preload" href="{% static 'css/app.css' %}" as="style">
  <link rel="stylesheet" href="{% static 'css/app.css' %}" />

  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;800;900&display=swap" rel="stylesheet">

  <!-- Icons (ÙŠÙØ¶Ù‘Ù„ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ø§Ø³ØªØ¶Ø§ÙØªÙ‡Ø§ Ù…Ø­Ù„ÙŠØ§Ù‹) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" referrerpolicy="no-referrer" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/v4-shims.min.css" referrerpolicy="no-referrer" crossorigin="anonymous">

  <!-- Minimal base-only helpers (Ù„Ø§ ØªØ¹ÙŠØ¯ ØªØ¹Ø±ÙŠÙ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ app.css) -->
  <style>
    /* Prevent horizontal overflow and fix mobile layout */
    html, body {
      overflow-x: hidden;
      width: 100%;
      position: relative;
    }

    /* Skip link */
    .skip-link{
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 9999;
      background: var(--card);
      border: 1px solid var(--line-2);
      border-radius: 14px;
      padding: 10px 12px;
      font-weight: 950;
      text-decoration: none;
      transform: translateY(-140%);
      box-shadow: var(--shadow-lg);
    }
    .skip-link:focus{transform:none}

    /* Progress bar */
    .progress-bar{
      position: fixed;
      top: 0;
      right: 0;
      height: 3px;
      width: 0;
      background: linear-gradient(90deg, var(--brand), var(--accent));
      z-index: 9999;
      transition: width .2s ease;
    }

    /* Header shell */
    .site-header{
      background: rgba(255,255,255,.86);
      border-bottom: 1px solid var(--line-2);
      position: sticky;
      top: 0;
      z-index: var(--z-header);
      backdrop-filter: blur(10px) saturate(180%);
      transition: box-shadow .2s ease, background .2s ease, border-color .2s ease;
    }
    html[data-theme="dark"] .site-header{background: rgba(10,16,32,.70)}
    .site-header.scrolled{box-shadow: var(--shadow);}

    .hdr{
      display:flex;
      align-items:center;
      gap:10px;
      min-height: 72px;
      padding: 10px 0;
    }

    /* Brand */
    .hdr-brand{
      display:flex;
      align-items:center;
      gap:12px;
      text-decoration:none;
      color: var(--ink);
      min-width: 220px;
    }
    .hdr-brand img{
      width:42px;height:42px;
      border-radius: 14px;
      border: 1px solid var(--line-2);
      background: rgba(255,255,255,.65);
      object-fit: contain;
    }
    .hdr-brand-txt{display:grid;gap:2px;min-width:0}
    .hdr-brand-name{font-weight:950;font-size:1.05rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .hdr-brand-sub{font-weight:800;color:var(--muted);font-size:.88rem;white-space:nowrap}
    @media(max-width:520px){.hdr-brand-sub{display:none}}

    /* Desktop nav tabs */
    .hdr-nav{
      display:flex;
      align-items:center;
      gap:6px;
      margin-inline-start: 18px;
      margin-inline-end: auto;
      flex-wrap: wrap;
    }
    @media(max-width:1024px){.hdr-nav{display:none}}

    .tab{
      display:inline-flex;
      align-items:center;
      gap:8px;
      min-height:44px;
      padding: 0 14px;
      border-radius: 999px;
      text-decoration:none;
      font-weight: 950;
      color: var(--ink);
      border: 1px solid transparent;
      transition: background var(--t) var(--ease), transform var(--t-fast) var(--ease), color var(--t-fast) var(--ease);
    }
    .tab:hover{background: var(--brand-ghost); color: var(--brand); transform: translateY(-1px)}
    .tab.is-active{background: var(--brand-ghost); color: var(--brand-700); border-color: rgba(37,99,235,.18)}

    .pill{
      min-width: 22px;
      height: 22px;
      border-radius: 999px;
      background: var(--danger);
      color:#fff;
      display:inline-grid;
      place-items:center;
      font-size:.78rem;
      padding: 0 7px;
      font-weight: 950;
    }

    /* Right actions */
    .hdr-actions{display:flex;align-items:center;gap:10px}

    .icon-btn{
      position:relative;
      display:grid;
      place-items:center;
      width:44px;height:44px;
      border-radius: 999px;
      border: 1px solid var(--line-2);
      background: var(--card);
      color: var(--ink);
      text-decoration:none;
      transition: transform var(--t-fast) var(--ease), box-shadow var(--t) var(--ease), border-color var(--t) var(--ease);
    }
    .icon-btn:hover{transform: translateY(-1px); box-shadow: var(--shadow-sm); border-color: rgba(37,99,235,.18)}
    .dot{
      position:absolute;
      top: 6px;
      left: 6px;
      min-width: 18px;
      height: 18px;
      border-radius: 999px;
      background: var(--danger);
      color:#fff;
      font-size:.72rem;
      display:grid;
      place-items:center;
      padding: 0 5px;
      font-weight: 950;
    }

    /* Hamburger */
    .hamburger{
      display:none;
      width: var(--tap);
      height: var(--tap);
      border-radius: 14px;
      border: 1px solid var(--line-2);
      background: var(--card);
      align-items:center;
      justify-content:center;
      gap:4px;
      cursor:pointer;
    }
    .hamburger span{display:block;width:18px;height:2px;background:var(--ink);border-radius:2px;transition:all .18s ease;opacity:.9}
    .hamburger.active span:nth-child(1){transform:translateY(4px) rotate(45deg)}
    .hamburger.active span:nth-child(2){opacity:0}
    .hamburger.active span:nth-child(3){transform:translateY(-4px) rotate(-45deg)}
    @media(max-width:1024px){
      .hamburger{display:flex}
      .hdr-actions .icon-btn,
      .hdr-actions #openSchoolModal { display: none; }
    }

    /* Drawer Actions */
    .drawer-actions{
      display: none;
      padding: 16px;
      gap: 12px;
      justify-content: center;
      border-bottom: 1px solid var(--line-2);
      background: rgba(2,6,23,.02);
    }
    @media(max-width:1024px){
      .drawer-actions{ display: flex; }
    }

    /* User menu */
    .userbox{position:relative}
    .avatar{
      width:44px;height:44px;
      border-radius:999px;
      display:grid;
      place-items:center;
      font-weight: 950;
      border: 1px solid rgba(37,99,235,.18);
      background: var(--brand-ghost);
      color: var(--brand-ink);
      cursor:pointer;
      transition: transform var(--t-fast) var(--ease);
    }
    .avatar:hover{transform: translateY(-1px)}
    .menu{
      position:absolute;
      inset: calc(100% + 10px) 0 auto auto;
      min-width: 230px;
      background: var(--card);
      border: 1px solid var(--line-2);
      border-radius: 14px;
      box-shadow: var(--shadow-lg);
      padding: 8px;
      opacity: 0;
      transform: translateY(-6px) scale(.98);
      pointer-events:none;
      transition: all .18s ease;
      z-index: var(--z-modal);
    }
    .menu.open{opacity:1;transform:none;pointer-events:auto}
    .menu .mi{
      display:flex;
      gap:10px;
      align-items:center;
      padding: 10px 12px;
      border-radius: 12px;
      color: var(--ink);
      text-decoration:none;
      font-weight: 900;
    }
    .menu .mi:hover{background: var(--line-2)}
    .menu .meta{color: var(--muted); font-weight: 800; font-size: .9rem}

    /* PWA install banner */
    .pwa-banner{
      position: fixed;
      right: 14px;
      left: 14px;
      bottom: calc(14px + var(--safe-bottom));
      z-index: var(--z-toast);
      display: none;
    }
    .pwa-banner.open{display:block}
    .pwa-card{
      background: var(--card);
      border: 1px solid var(--line-2);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      padding: 12px;
      display:flex;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
    }
    .pwa-text{min-width:0}
    .pwa-title{font-weight:950;margin:0;color:var(--ink)}
    .pwa-sub{margin:2px 0 0;color:var(--muted);font-weight:800;font-size:.92rem}
    .pwa-actions{display:flex;gap:10px;align-items:center;flex:0 0 auto}
    .pwa-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      min-height:44px;
      padding: 0 14px;
      border-radius: 12px;
      border: 1px solid transparent;
      cursor:pointer;
      font-weight:950;
      text-decoration:none;
      background: var(--brand);
      color: #fff;
    }
    .pwa-btn:hover{filter:saturate(1.05) brightness(.98)}
    .pwa-close{
      width:44px;height:44px;
      border-radius: 12px;
      border: 1px solid var(--line-2);
      background: var(--card);
      color: var(--ink);
      cursor:pointer;
      display:grid;
      place-items:center;
    }
    .pwa-close:hover{box-shadow: var(--shadow-sm)}

    /* Drawer */
    .drawer-overlay{
      position: fixed;
      inset: 0;
      background: rgba(2,6,23,.45);
      backdrop-filter: blur(6px);
      z-index: calc(var(--z-header) + 1);
      opacity: 0;
      visibility: hidden;
      transition: opacity var(--t) var(--ease), visibility var(--t) var(--ease);
    }
    .drawer-overlay.show{opacity:1;visibility:visible}

    .drawer{
      position: fixed;
      top: 0;
      right: 0;
      left: auto !important;
      bottom: 0;
      width: min(340px, 88vw);
      background: var(--card);
      border-left: 1px solid var(--line-2);
      z-index: calc(var(--z-header) + 100);
      transform: translateX(100%);
      visibility: hidden;
      transition: transform .3s var(--ease), visibility 0s .3s;
      display:flex;
      flex-direction:column;
      overflow:auto;
      padding-bottom: var(--safe-bottom);
    }
    /* RTL fix: ensure drawer hides to the right */
    html[dir="rtl"] .drawer {
      transform: translateX(100%);
      right: 0;
      left: auto !important;
    }
    html[dir="rtl"] .drawer.open {
      transform: translateX(0);
    }
    .drawer.open{
      transform: translateX(0);
      visibility: visible;
      transition: transform .3s var(--ease), visibility 0s 0s;
    }
    .drawer-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 12px;
      border-bottom: 1px solid var(--line-2);
    }
    .drawer-title{font-weight:950}
    .drawer-nav{display:grid;padding:12px;gap:10px}
    .drawer-nav a{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 12px;
      border: 1px solid var(--line-2);
      border-radius: 14px;
      text-decoration:none;
      font-weight: 950;
      background: rgba(2,6,23,.01);
      transition: background var(--t) var(--ease), transform var(--t-fast) var(--ease), border-color var(--t) var(--ease);
    }
    .drawer-nav a:hover{background: rgba(37,99,235,.06); transform: translateY(-1px)}
    .drawer-nav a.is-active{border-color: rgba(37,99,235,.22); background: var(--brand-ghost); color: var(--brand-700)}
    .drawer-footer{margin-top:auto;padding:12px;border-top:1px solid var(--line-2);display:grid;gap:10px}

    /* Subscription banner */
    .sub-banner{
      border-bottom: 1px solid rgba(245,158,11,.28);
      background: rgba(255,251,235,.94);
      color: #7c2d12;
      padding: 12px 0;
      font-weight: 950;
    }
    html[data-theme="dark"] .sub-banner{
      background: rgba(124,45,18,.22);
      color: #fde68a;
      border-bottom-color: rgba(245,158,11,.22);
    }
    .sub-banner a{font-weight:950; text-decoration: underline; margin-inline-start: 8px}

    /* Messages container keeps your .msg styles in app.css */
    .messages{
      position: fixed;
      top: calc(var(--safe-top) + 78px);
      right: clamp(10px,2vw,16px);
      width: min(420px, calc(100vw - 20px));
      z-index: var(--z-toast);
      display:grid;
      gap:10px;
      margin:0;
      pointer-events:none;
    }
    .messages .msg{pointer-events:auto; position:relative}
    .msg-close{
      position:absolute;
      top: 8px;
      left: 8px;
      background: transparent;
      border: 0;
      cursor: pointer;
      opacity: .75;
      padding: 0;
      color: inherit;
    }
    .msg-close:hover{opacity:1}
    .msg-progress{position:absolute;bottom:0;left:0;height:3px;width:100%;background:rgba(0,0,0,.08);overflow:hidden}
    .msg-progress::after{
      content:"";
      position:absolute;bottom:0;left:0;height:3px;width:100%;
      background: currentColor;
      opacity:.25;
      animation: progress 3.2s linear forwards;
    }
    @keyframes progress{from{transform:translateX(-100%)}to{transform:none}}

    /* School modal (only minimal layout; details from app.css if you want later) */
    .school-modal{
      position: fixed;
      inset: 0;
      z-index: var(--z-modal);
      display:none;
      place-items:center;
      padding: 12px;
      background: rgba(2,6,23,.55);
      backdrop-filter: blur(8px);
    }
    .school-modal.open{display:grid}
    .school-panel{
      width: min(560px, 94vw);
      max-height: min(80vh, 720px);
      background: var(--card);
      border: 1px solid var(--line-2);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-lg);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      transform: scale(.98) translateY(10px);
      transition: transform .2s var(--ease);
    }
    .school-modal.open .school-panel{transform:none}
    .school-panel-h{
      padding: 14px 16px;
      border-bottom: 1px solid var(--line-2);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .school-panel-h b{font-weight:950}
    .school-panel-close{
      width:44px;height:44px;
      border-radius:999px;
      border: 1px solid var(--line-2);
      background: var(--card);
      cursor:pointer;
    }
    .school-panel-b{padding: 14px 16px; display:grid; gap:12px; overflow:auto}
    .school-search{min-height:48px}
    .school-list{margin:0;padding:0;list-style:none;display:grid;gap:10px}
    .school-item{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border: 1px solid var(--line-2);
      border-radius: 14px;
      background: rgba(2,6,23,.01);
      padding: 12px 14px;
      cursor:pointer;
      font-weight: 950;
      text-align:right;
      transition: transform var(--t-fast) var(--ease), box-shadow var(--t) var(--ease), border-color var(--t) var(--ease);
    }
    .school-item:hover{transform: translateY(-1px); box-shadow: var(--shadow-sm); border-color: rgba(37,99,235,.18)}
    .school-item.current-school{opacity:.75; cursor:not-allowed}
    .school-item-text{display:grid;gap:2px;min-width:0}
    .school-item-text b{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .school-item small{color: var(--muted); font-weight: 800; font-size: .85rem}
    .school-item .tag{
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--line-2);
      background: rgba(148,163,184,.14);
      font-size: .8rem;
      font-weight: 950;
      white-space: nowrap;
      min-width: 66px;
      text-align:center;
    }

    /* To top button uses app.css styles if present */
  </style>

  {% block head %}{% endblock %}
</head>

<body class="page">
  {% if SUBSCRIPTION_WARNING %}
    <div class="sub-banner" role="status" aria-live="polite">
      <div class="container">
        <i class="fas fa-exclamation-triangle" style="margin-inline-end:8px"></i>
        ØªÙ†Ø¨ÙŠÙ‡: Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ù…Ø¯Ø±Ø³Ø© ÙŠÙ†ØªÙ‡ÙŠ Ø®Ù„Ø§Ù„ {{ SUBSCRIPTION_DAYS_LEFT }} ÙŠÙˆÙ….
        <a href="{% url 'reports:my_subscription' %}">ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø¢Ù†</a>
      </div>
    </div>
  {% endif %}

  <a class="skip-link" href="#mainContent">ØªØ®Ø·ÙŠ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø­ØªÙˆÙ‰</a>
  <div class="progress-bar" id="scrollProgress"></div>

  <header class="site-header" id="siteHeader">
    <div class="container hdr">

      <button class="hamburger" id="hamburger" aria-label="ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©" aria-controls="mobileDrawer" aria-expanded="false">
        <span></span><span></span><span></span>
      </button>

      <a class="hdr-brand" href="{% url 'reports:home' %}">
        <img src="{% if SCHOOL_LOGO_URL %}{{ SCHOOL_LOGO_URL }}{% else %}{% static 'img/logo1.png' %}{% endif %}" alt="Ø§Ù„Ø´Ø¹Ø§Ø±" width="42" height="42" loading="eager" decoding="async">
        <div class="hdr-brand-txt">
          <div class="hdr-brand-name">{% if SCHOOL_NAME %}{{ SCHOOL_NAME }}{% else %}Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±{% endif %}</div>
          <div class="hdr-brand-sub">Ù…Ù†ØµØ© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„ØªØ°Ø§ÙƒØ±</div>
        </div>
      </a>

      {% with active=request.resolver_match.url_name %}
      <nav class="hdr-nav" aria-label="Ø±ÙˆØ§Ø¨Ø·">
        {% if request.user.is_authenticated %}
          <a class="tab {% if active == 'home' %}is-active{% endif %}" href="{% url 'reports:home' %}">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>

          {% url 'reports:assigned_to_me' as inboxUrl %}
          {% if inboxUrl %}
            <a class="tab {% if active == 'assigned_to_me' %}is-active{% endif %}" href="{{ inboxUrl }}">
              Ø§Ù„ÙˆØ§Ø±Ø¯
              {% if NAV_ASSIGNED_TO_ME %}<span class="pill">{{ NAV_ASSIGNED_TO_ME }}</span>{% endif %}
            </a>
          {% endif %}

          {% if SHOW_OFFICER_REPORTS_LINK %}
            <a class="tab {% if active == 'officer_reports' %}is-active{% endif %}" href="{% url 'reports:officer_reports' %}">ØªÙ‚Ø§Ø±ÙŠØ± Ù‚Ø³Ù…ÙŠ</a>
          {% endif %}

          {% if SHOW_ADMIN_DASHBOARD_LINK %}
            {% if request.user.is_superuser %}
              <a class="tab {% if active == 'platform_admin_dashboard' %}is-active{% endif %}" href="{% url 'reports:platform_admin_dashboard' %}">Ù„ÙˆØ­Ø© Ø§Ù„Ø¢Ø¯Ù…Ù†</a>
            {% else %}
              <a class="tab {% if active == 'admin_dashboard' %}is-active{% endif %}" href="{% url 'reports:admin_dashboard' %}">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±</a>
            {% endif %}
          {% endif %}
        {% else %}
          <a class="tab is-active" href="{% url 'reports:login' %}">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>
        {% endif %}
      </nav>
      {% endwith %}

      <div class="hdr-actions">
        {% if request.user.is_authenticated %}

          {% if USER_SCHOOLS|length > 1 %}
            <button type="button" class="btn btn-outline btn-sm" id="openSchoolModal" aria-haspopup="dialog" aria-controls="schoolModal" aria-expanded="false">
              <i class="fa-solid fa-school" aria-hidden="true"></i>
              <span style="font-weight:950;max-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">
                {% if SCHOOL_NAME %}{{ SCHOOL_NAME }}{% else %}Ø§Ø®ØªØ± Ù…Ø¯Ø±Ø³Ø©{% endif %}
              </span>
              <i class="fa-solid fa-chevron-down" aria-hidden="true"></i>
            </button>
          {% endif %}

          {% url 'reports:my_notifications' as myNotificationsUrl %}
          {% if myNotificationsUrl %}
            <a class="icon-btn" href="{{ myNotificationsUrl }}" aria-label="Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª" id="notifBell">
              <i class="fa-solid fa-bell"></i>
              <span class="dot" id="notifDot" {% if not NAV_NOTIFICATIONS_UNREAD %}style="display:none"{% endif %}>
                {{ NAV_NOTIFICATIONS_UNREAD|default:"" }}
              </span>
            </a>
          {% endif %}

          {% if CAN_SEND_NOTIFICATIONS and SEND_NOTIFICATION_URL %}
            <a class="icon-btn" href="{{ SEND_NOTIFICATION_URL }}" aria-label="Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±" title="Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±">
              <i class="fa-solid fa-paper-plane" aria-hidden="true"></i>
            </a>
          {% endif %}

          <button class="icon-btn theme-toggle" id="themeToggle" type="button" aria-label="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø«ÙŠÙ…" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø«ÙŠÙ…">
            <i class="fa-solid fa-moon"></i>
          </button>

          <div class="userbox">
            {% firstof request.user.name request.user.phone request.user.national_id "Ø­Ø³Ø§Ø¨ÙŠ" as display_name %}
            <button class="avatar" id="userAvatar" type="button" aria-haspopup="menu" aria-expanded="false" title="{{ display_name }}">
              {{ display_name|slice:":1" }}
            </button>
            <div class="menu" id="userMenu" role="menu" aria-label="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
              <div class="mi" tabindex="0" style="cursor:default">
                <div>
                  <div style="font-weight:950">{{ display_name }}</div>
                  <div class="meta">Ù…Ø±Ø­Ø¨Ø§Ù‹ ğŸ‘‹</div>
                </div>
              </div>
              <a href="{% url 'reports:logout' %}" class="mi" role="menuitem">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
            </div>
          </div>

        {% else %}
          <a class="tab is-active" href="{% url 'reports:login' %}">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>
        {% endif %}
      </div>
    </div>
  </header>

  <div class="drawer-overlay" id="drawerOverlay" aria-hidden="true"></div>
  <aside class="drawer" id="mobileDrawer" aria-hidden="true" aria-labelledby="drawerTitle">
    <div class="drawer-head">
      <div id="drawerTitle" class="drawer-title">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</div>
      <button class="btn btn-sm" id="drawerClose" aria-label="Ø¥ØºÙ„Ø§Ù‚">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>

    {% if request.user.is_authenticated %}
      <div class="drawer-actions">
        {% url 'reports:my_notifications' as myNotificationsUrlMobile %}
        {% if myNotificationsUrlMobile %}
          <a class="icon-btn" href="{{ myNotificationsUrlMobile }}" aria-label="Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª" id="notifBellMobile">
            <i class="fa-solid fa-bell"></i>
            <span class="dot" id="notifDotMobile" {% if not NAV_NOTIFICATIONS_UNREAD %}style="display:none"{% endif %}>
              {{ NAV_NOTIFICATIONS_UNREAD|default:"" }}
            </span>
          </a>
        {% endif %}

        {% if CAN_SEND_NOTIFICATIONS and SEND_NOTIFICATION_URL %}
          <a class="icon-btn" href="{{ SEND_NOTIFICATION_URL }}" aria-label="Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±" title="Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±">
            <i class="fa-solid fa-paper-plane" aria-hidden="true"></i>
          </a>
        {% endif %}

        <button class="icon-btn theme-toggle" type="button" aria-label="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø«ÙŠÙ…" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø«ÙŠÙ…">
          <i class="fa-solid fa-moon"></i>
        </button>
      </div>
    {% endif %}

    {% with active=request.resolver_match.url_name %}
    <nav class="drawer-nav" aria-label="Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©">
      {% if request.user.is_authenticated %}

        <a class="{% if active == 'home' %}is-active{% endif %}" href="{% url 'reports:home' %}">
          <span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
          <i class="fa-solid fa-house"></i>
        </a>

        {% url 'reports:assigned_to_me' as inboxUrl2 %}
        {% if inboxUrl2 %}
          <a class="{% if active == 'assigned_to_me' %}is-active{% endif %}" href="{{ inboxUrl2 }}">
            <span>Ø§Ù„ÙˆØ§Ø±Ø¯</span>
            <span>{% if NAV_ASSIGNED_TO_ME %}<span class="pill">{{ NAV_ASSIGNED_TO_ME }}</span>{% endif %}</span>
          </a>
        {% endif %}

        {% if SHOW_OFFICER_REPORTS_LINK %}
          <a class="{% if active == 'officer_reports' %}is-active{% endif %}" href="{% url 'reports:officer_reports' %}">
            <span>ØªÙ‚Ø§Ø±ÙŠØ± Ù‚Ø³Ù…ÙŠ</span>
            <i class="fa-solid fa-layer-group"></i>
          </a>
        {% endif %}

        {% if SHOW_ADMIN_DASHBOARD_LINK %}
          {% if request.user.is_superuser %}
            <a class="{% if active == 'platform_admin_dashboard' %}is-active{% endif %}" href="{% url 'reports:platform_admin_dashboard' %}">
              <span>Ù„ÙˆØ­Ø© Ø§Ù„Ø¢Ø¯Ù…Ù†</span>
              <i class="fa-solid fa-gauge-high"></i>
            </a>
          {% else %}
            <a class="{% if active == 'admin_dashboard' %}is-active{% endif %}" href="{% url 'reports:admin_dashboard' %}">
              <span>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±</span>
              <i class="fa-solid fa-gauge"></i>
            </a>
          {% endif %}
        {% endif %}

        <div class="drawer-footer">
          {% if USER_SCHOOLS|length > 1 %}
            <button type="button" class="btn btn-primary btn-block" id="openSchoolModalMobile">
              <i class="fa-solid fa-school" style="margin-inline-end:8px"></i>
              ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©
            </button>
          {% endif %}
          <a class="btn btn-outline btn-block" href="{% url 'reports:logout' %}">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
        </div>

      {% else %}
        <a class="{% if active == 'login' %}is-active{% endif %}" href="{% url 'reports:login' %}">
          <span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</span>
          <i class="fa-solid fa-right-to-bracket"></i>
        </a>
      {% endif %}
    </nav>
    {% endwith %}
  </aside>

  {% if messages %}
    <div class="messages" id="messages-container" aria-live="polite" aria-atomic="true">
      {% for message in messages %}
        <div class="msg {% if message.tags %}{{ message.tags }}{% else %}info{% endif %}" data-autohide="true">
          <button class="msg-close" aria-label="Ø¥ØºÙ„Ø§Ù‚"><i class="fa-solid fa-xmark"></i></button>
          {{ message }}
          <div class="msg-progress"></div>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <main class="container page-main" id="mainContent">
    {% block content %}{% endblock %}
  </main>

  <footer class="site-footer" aria-label="ØªØ°ÙŠÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…">
    <div class="container" style="padding:18px 0">
      <div class="row-between" style="flex-wrap:wrap; gap:12px">
        <div style="display:flex;align-items:center;gap:12px;min-width:0">
          <img src="{% if SCHOOL_LOGO_URL %}{{ SCHOOL_LOGO_URL }}{% else %}{% static 'img/logo1.png' %}{% endif %}" alt="Ø§Ù„Ø´Ø¹Ø§Ø±" width="42" height="42" style="border-radius:14px;border:1px solid var(--line-2);background:rgba(255,255,255,.65)">
          <div style="min-width:0">
            <div style="font-weight:950;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">
              {% if SCHOOL_NAME %}{{ SCHOOL_NAME }}{% else %}Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±{% endif %}
            </div>
            <div class="muted" style="font-weight:800;font-size:.92rem">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„ØªØ°Ø§ÙƒØ± â€” ØªØ¬Ø±Ø¨Ø© Ø¹Ø±Ø¨ÙŠØ© Ø§Ø­ØªØ±Ø§ÙÙŠØ©</div>
          </div>
        </div>

        <nav style="display:flex;gap:10px;flex-wrap:wrap" aria-label="Ø±ÙˆØ§Ø¨Ø· Ø³Ø±ÙŠØ¹Ø©">
          {% if request.user.is_authenticated %}
            <a class="btn btn-sm btn-outline" href="{% url 'reports:home' %}">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
            <a class="btn btn-sm btn-outline" href="{% url 'reports:my_reports' %}">ØªÙ‚Ø§Ø±ÙŠØ±ÙŠ</a>
            <a class="btn btn-sm btn-outline" href="{% url 'reports:my_requests' %}">Ø·Ù„Ø¨Ø§ØªÙŠ</a>
          {% else %}
            <a class="btn btn-sm btn-outline" href="{% url 'reports:login' %}">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>
          {% endif %}
        </nav>
      </div>

      <div class="muted" style="margin-top:12px;font-weight:800">
        Â© {% now "Y" %} Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.
      </div>
    </div>
  </footer>

  <button class="to-top" id="toTop" aria-label="Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø£Ø¹Ù„Ù‰">
    <i class="fa-solid fa-arrow-left-long" style="transform:rotate(90deg)"></i>
  </button>

  {% if request.user.is_authenticated %}
    {% if USER_SCHOOLS|length > 1 %}
      <div class="school-modal" id="schoolModal" aria-hidden="true">
        <div class="school-panel" role="dialog" aria-modal="true" aria-labelledby="schoolModalTitle" tabindex="-1">
          <div class="school-panel-h">
            <div>
              <b id="schoolModalTitle">Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„Ù…Ø¯Ø§Ø±Ø³</b>
              <div class="muted" style="font-weight:900;font-size:.9rem;margin-top:2px">Ø§Ø¨Ø­Ø« Ø«Ù… Ø§Ø®ØªØ± Ù…Ø¯Ø±Ø³Ø© Ù„Ù„ØªØ¨Ø¯ÙŠÙ„ ÙÙˆØ±Ø§Ù‹</div>
            </div>
            <button type="button" class="school-panel-close" id="closeSchoolModal" aria-label="Ø¥ØºÙ„Ø§Ù‚">
              <i class="fa-solid fa-xmark"></i>
            </button>
          </div>

          <div class="school-panel-b">
            <input type="search" class="input school-search" id="schoolSearch" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ù„Ù„Ø¨Ø­Ø«..." aria-label="Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¯Ø±Ø³Ø©">

            <form method="post" action="{% url 'reports:switch_school' %}" id="schoolSwitchForm">
              {% csrf_token %}
              <input type="hidden" name="next" value="{{ request.path }}">
              <input type="hidden" name="school_id" id="schoolIdField">

              <ul class="school-list" id="schoolList">
                {% for s in USER_SCHOOLS %}
                  <li>
                    <button type="button"
                      class="school-item {% if SCHOOL_ID and s.id == SCHOOL_ID %}current-school{% endif %}"
                      data-school-id="{{ s.id }}"
                      data-school-name="{{ s.name }}"
                    >
                      <div class="school-item-text">
                        <b>{{ s.name }}</b>
                        <small>{% if s.id == SCHOOL_ID %}Ù‡Ø°Ù‡ Ù‡ÙŠ Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©{% else %}Ø§Ø¶ØºØ· Ù„Ù„ØªØ¨Ø¯ÙŠÙ„{% endif %}</small>
                      </div>
                      <span class="tag">
                        {% if s.id == SCHOOL_ID %}Ø§Ù„Ø­Ø§Ù„ÙŠØ©{% else %}ØªØ¨Ø¯ÙŠÙ„{% endif %}
                      </span>
                    </button>
                  </li>
                {% endfor %}
              </ul>

              <noscript>
                <div class="stack" style="margin-top:10px">
                  <select name="school_id" class="select" style="min-height:48px;font-weight:900">
                    {% for s in USER_SCHOOLS %}
                      <option value="{{ s.id }}" {% if SCHOOL_ID and s.id == SCHOOL_ID %}selected{% endif %}>{{ s.name }}</option>
                    {% endfor %}
                  </select>
                  <button class="btn btn-primary btn-block" type="submit">ØªØ¨Ø¯ÙŠÙ„</button>
                </div>
              </noscript>
            </form>
          </div>
        </div>
      </div>
    {% endif %}
  {% endif %}

  <script>
    // Apply extra bottom spacing only when optional bottom nav exists
    (function(){
      if (document.querySelector('.bottom-nav')) {
        document.body.classList.add('has-bottom-nav');
      }
    })();

    // ===== Cookies (SameSite=Lax + Secure on https) =====
    (function(){
      window.getCookie = function(name){
        const parts = document.cookie ? document.cookie.split('; ') : [];
        for(const p of parts){
          const i = p.indexOf('=');
          const k = i > -1 ? p.slice(0,i) : p;
          if(k === name) return i > -1 ? decodeURIComponent(p.slice(i+1)) : '';
        }
        return null;
      };
      window.setCookie = function(name, value, days){
        const d = new Date(Date.now() + (days||365)*864e5);
        const secure = location.protocol === 'https:' ? '; Secure' : '';
        document.cookie = name + '=' + encodeURIComponent(value) + '; path=/; expires=' + d.toUTCString() + '; SameSite=Lax' + secure;
      };
    })();

    // ===== Lock scroll + Focus trap =====
    (function(){
      window.__lockScroll = function(on){
        document.documentElement.style.overflow = on ? 'hidden' : '';
      };

      window.__trapFocus = function(container, enabled){
        if(!container) return;
        const key = '__focusTrapHandler';
        if(!enabled){
          if(container[key]) container.removeEventListener('keydown', container[key]);
          container[key] = null;
          return;
        }
        container[key] = function(e){
          if(e.key !== 'Tab') return;
          const focusables = container.querySelectorAll(
            'a[href], button:not([disabled]), input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])'
          );
          if(!focusables.length) return;
          const first = focusables[0];
          const last = focusables[focusables.length - 1];
          if(e.shiftKey && document.activeElement === first){
            e.preventDefault(); last.focus();
          } else if(!e.shiftKey && document.activeElement === last){
            e.preventDefault(); first.focus();
          }
        };
        container.addEventListener('keydown', container[key]);
      };
    })();

    // ===== Theme (data-theme) =====
    (function(){
      const root = document.documentElement;
      const btns = document.querySelectorAll('.theme-toggle');

      const apply = (theme)=>{
        root.setAttribute('data-theme', theme);
        window.setCookie('theme', theme, 365);
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
        btns.forEach(btn => {
          const icon = btn.querySelector('i');
          if(icon){
            icon.className = theme === 'dark' ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
          }
        });
      };

      const saved = window.getCookie('theme');
      if(saved === 'dark' || saved === 'light'){
        apply(saved);
      }else{
        // Ø§ÙØªØ±Ø§Ø¶ÙŠ: Ø§ØªØ¨Ø¹ Ø§Ù„Ù†Ø¸Ø§Ù… (Ù„ÙƒÙ† Ù†Ø®Ø²Ù† Ø£ÙˆÙ„ Ù…Ø±Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ ÙÙ‚Ø·)
        if(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches){
          root.setAttribute('data-theme', 'dark');
          btns.forEach(btn => {
            const icon = btn.querySelector('i');
            if(icon) icon.className = 'fa-solid fa-sun';
          });
        }
      }

      btns.forEach(btn => {
        btn.addEventListener('click', ()=>{
          const current = root.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
          apply(current === 'dark' ? 'light' : 'dark');
        });
      });
    })();

    // ===== Progress + Header shadow =====
    (function(){
      const bar = document.getElementById('scrollProgress');
      const header = document.getElementById('siteHeader');
      const onScroll = ()=>{
        const h = document.documentElement;
        const sc = h.scrollTop;
        const max = h.scrollHeight - h.clientHeight;
        if(bar) bar.style.width = (max ? (sc/max)*100 : 0) + '%';
        if(header) header.classList.toggle('scrolled', window.scrollY > 4);
      };
      window.addEventListener('scroll', onScroll, {passive:true});
      onScroll();
    })();

    // ===== Toasts (pause on hover) =====
    (function(){
      const container = document.getElementById('messages-container');
      if(!container) return;

      container.querySelectorAll('.msg').forEach((el)=>{
        const closeBtn = el.querySelector('.msg-close');
        let timer = null;

        const remove = ()=>{ if (el && el.parentNode){ el.remove(); } };
        const start = ()=>{
          if(el.dataset.autohide === 'true'){
            timer = setTimeout(remove, 3400);
          }
        };
        const stop = ()=>{ if(timer){ clearTimeout(timer); timer = null; } };

        if(closeBtn) closeBtn.addEventListener('click', remove);
        el.addEventListener('mouseenter', stop);
        el.addEventListener('mouseleave', start);
        start();
      });
    })();

    // ===== Drawer =====
    (function(){
      const drawer    = document.getElementById('mobileDrawer');
      const overlay   = document.getElementById('drawerOverlay');
      const hamburger = document.getElementById('hamburger');
      const closeBtn  = document.getElementById('drawerClose');
      if(!drawer || !overlay || !hamburger) return;

      const open = ()=>{
        drawer.classList.add('open');
        overlay.classList.add('show');
        overlay.setAttribute('aria-hidden', 'false');
        hamburger.classList.add('active');
        hamburger.setAttribute('aria-expanded','true');
        drawer.setAttribute('aria-hidden','false');
        window.__lockScroll(true);
        window.__trapFocus(drawer, true);

        const first = drawer.querySelector('a, button');
        if(first) first.focus();
      };

      const close = ()=>{
        drawer.classList.remove('open');
        overlay.classList.remove('show');
        overlay.setAttribute('aria-hidden', 'true');
        hamburger.classList.remove('active');
        hamburger.setAttribute('aria-expanded','false');
        drawer.setAttribute('aria-hidden','true');
        window.__lockScroll(false);
        window.__trapFocus(drawer, false);
        hamburger.focus();
      };

      hamburger.addEventListener('click', ()=> drawer.classList.contains('open') ? close() : open());
      if(closeBtn) closeBtn.addEventListener('click', close);
      overlay.addEventListener('click', (e)=>{ if(e.target === overlay) close(); });
      document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') close(); });

      drawer.addEventListener('click', (e)=>{
        const a = e.target.closest('a');
        if(a && a.href) close();
      });
    })();

    // ===== User menu =====
    (function(){
      const avatar = document.getElementById('userAvatar');
      const menu = document.getElementById('userMenu');
      if(!avatar || !menu) return;

      const close = ()=>{ menu.classList.remove('open'); avatar.setAttribute('aria-expanded','false'); };

      avatar.addEventListener('click', ()=>{
        const isOpen = menu.classList.toggle('open');
        avatar.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
      });

      document.addEventListener('click', (e)=>{
        if(!e.target.closest('#userMenu') && !e.target.closest('#userAvatar')) close();
      });
      document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') close(); });
    })();

    // ===== To top =====
    (function(){
      const toTop = document.getElementById('toTop');
      if(!toTop) return;
      const toggle = ()=>{ window.scrollY > 260 ? (toTop.style.display='grid') : (toTop.style.display='none'); };
      window.addEventListener('scroll', toggle, {passive:true}); toggle();
      toTop.addEventListener('click', ()=>window.scrollTo({top:0, behavior:'smooth'}));
    })();

    // ===== School Modal =====
    (function(){
      const modal = document.getElementById('schoolModal');
      const panel = modal ? modal.querySelector('.school-panel') : null;
      const openBtn = document.getElementById('openSchoolModal');
      const openBtnMobile = document.getElementById('openSchoolModalMobile');
      const closeBtn = document.getElementById('closeSchoolModal');
      const form = document.getElementById('schoolSwitchForm');
      const schoolIdField = document.getElementById('schoolIdField');
      const schoolList = document.getElementById('schoolList');
      const searchInput = document.getElementById('schoolSearch');

      if (!modal || !form || !schoolList || !panel) return;

      const openModal = () => {
        modal.classList.add('open');
        modal.setAttribute('aria-hidden', 'false');
        window.__lockScroll(true);
        window.__trapFocus(panel, true);
        setTimeout(() => { if(searchInput) searchInput.focus(); }, 150);
      };

      const closeModal = () => {
        modal.classList.remove('open');
        modal.setAttribute('aria-hidden', 'true');
        window.__lockScroll(false);
        window.__trapFocus(panel, false);
        if(openBtn) openBtn.focus();
      };

      if (openBtn) openBtn.addEventListener('click', openModal);
      if (openBtnMobile) openBtnMobile.addEventListener('click', openModal);
      if (closeBtn) closeBtn.addEventListener('click', closeModal);

      modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.classList.contains('open')) closeModal();
      });

      schoolList.addEventListener('click', (e) => {
        const item = e.target.closest('.school-item');
        if (item && !item.classList.contains('current-school')) {
          const schoolId = item.dataset.schoolId;
          schoolIdField.value = schoolId;
          form.submit();
        }
      });

      if(searchInput){
        searchInput.addEventListener('input', (e) => {
          const query = (e.target.value || '').toLowerCase().trim();
          const items = schoolList.querySelectorAll('li');
          items.forEach(li => {
            const btn = li.querySelector('.school-item');
            const name = btn ? (btn.dataset.schoolName || '').toLowerCase() : '';
            li.style.display = name.includes(query) ? '' : 'none';
          });
        });
      }
    })();
  </script>

  <!-- PWA Install Banner (shown only when eligible or on iOS) -->
  <div id="pwaInstallBanner" class="pwa-banner" role="region" aria-label="ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚">
    <div class="pwa-card">
      <div class="pwa-text">
        <p class="pwa-title">Ø«Ø¨Øª Ù…Ù†ØµØ© ØªÙˆØ«ÙŠÙ‚ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ</p>
        <p id="pwaInstallHint" class="pwa-sub">ÙŠÙ…ÙƒÙ†Ùƒ ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹ ÙˆØ§Ù„Ø¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ Ø£ÙØ¶Ù„.</p>
      </div>
      <div class="pwa-actions">
        <button id="pwaInstallBtn" class="pwa-btn" type="button" style="display:none">ØªØ«Ø¨ÙŠØª</button>
        <button id="pwaInstallClose" class="pwa-close" type="button" aria-label="Ø¥ØºÙ„Ø§Ù‚">
          <i class="fa-solid fa-xmark" aria-hidden="true"></i>
        </button>
      </div>
    </div>
  </div>

  <script>
    // PWA Service Worker Registration
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        // Register from root so the SW can control the whole site.
        navigator.serviceWorker.register('/sw.js')
          .then(reg => console.log('Service Worker registered'))
          .catch(err => console.error('Service Worker registration failed:', err));
      });
    }

    // PWA Install Prompt (Chrome/Edge/Android) + iOS guidance
    (function(){
      const banner = document.getElementById('pwaInstallBanner');
      const btn = document.getElementById('pwaInstallBtn');
      const closeBtn = document.getElementById('pwaInstallClose');
      const hint = document.getElementById('pwaInstallHint');
      if (!banner || !btn || !closeBtn || !hint) return;

      const dismissedKey = 'pwa_install_dismissed_v1';
      const isStandalone = window.matchMedia && window.matchMedia('(display-mode: standalone)').matches;
      const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
      const isSafari = isIOS && /safari/i.test(navigator.userAgent) && !/crios|fxios|edgios/i.test(navigator.userAgent);
      const iosStandalone = Boolean(window.navigator.standalone);

      try {
        if (localStorage.getItem(dismissedKey) === '1') return;
      } catch (e) {}
      if (isStandalone || iosStandalone) return;

      function openBanner(){ banner.classList.add('open'); }
      function closeBanner(){
        banner.classList.remove('open');
        try{ localStorage.setItem(dismissedKey, '1'); }catch(e){}
      }

      closeBtn.addEventListener('click', closeBanner);

      let deferredPrompt = null;
      window.addEventListener('beforeinstallprompt', (e) => {
        // Save the event for triggering on user gesture.
        e.preventDefault();
        deferredPrompt = e;
        btn.style.display = '';
        hint.textContent = 'Ø§Ø¶ØºØ· ØªØ«Ø¨ÙŠØª Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©.';
        openBanner();
      });

      btn.addEventListener('click', async () => {
        if (!deferredPrompt) return;
        deferredPrompt.prompt();
        try {
          await deferredPrompt.userChoice;
        } finally {
          deferredPrompt = null;
          closeBanner();
        }
      });

      window.addEventListener('appinstalled', () => {
        closeBanner();
      });

      // iOS: no beforeinstallprompt, show guidance on Safari.
      if (isSafari) {
        hint.textContent = 'Ø¹Ù„Ù‰ iPhone: Ù…Ù† Ø²Ø± Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø«Ù… "Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©".';
        btn.style.display = 'none';
        openBanner();
      }
    })();

    // Notification Polling
    (function() {
      const notifDot = document.getElementById('notifDot');
      const notifDotMobile = document.getElementById('notifDotMobile');
      if (!notifDot && !notifDotMobile) return;

      function checkNotifications() {
        fetch('{% url "reports:unread_notifications_count" %}')
          .then(response => response.json())
          .then(data => {
            const updateDot = (dot) => {
              if (!dot) return;
              if (data.count > 0) {
                dot.textContent = data.count;
                dot.style.display = 'flex';
              } else {
                dot.style.display = 'none';
              }
            };
            updateDot(notifDot);
            updateDot(notifDotMobile);
          })
          .catch(err => console.error('Error fetching notifications:', err));
      }

      // Check every 60 seconds
      setInterval(checkNotifications, 60000);
    })();
  </script>

  {% block scripts %}{% endblock %}
</body>
</html>
