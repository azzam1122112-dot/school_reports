{% load static %}
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#2563eb" />
  <meta name="color-scheme" content="light" />
  <title>{% block title %}Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±{% endblock %}</title>

  <link rel="preload" href="{% static 'css/app.css' %}" as="style">
  <link rel="stylesheet" href="{% static 'css/app.css' %}" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;800;900&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" referrerpolicy="no-referrer">

  <style>
    :root{
      /* Ø§Ù„Ø£Ù„ÙˆØ§Ù† */
      --brand:#2563eb;
      --brand2:#3b82f6;
      --brand-ghost:#e8efff;
      --accent:#10b981;

      --ink:#0f172a;
      --muted:#64748b;

      --bg:#f8fafc;
      --card:#ffffff;
      --line:#e5e7eb;
      --line-2:#f1f5f9;
      --current-school-bg: #f0f9ff;
      --current-school-border: #93c5fd;

      /* Ø§Ù„Ø¸Ù„Ø§Ù„ */
      --shadow:0 8px 28px rgba(2,6,23,.08);
      --shadow2:0 20px 50px rgba(2,6,23,.16);
      --ring:0 0 0 3px rgba(37,99,235,.25);

      --tap:48px;

      /* Ø§Ù„Ø£Ù…Ø§Ù† */
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-right: env(safe-area-inset-right, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-left: env(safe-area-inset-left, 0px);
      
      --t-fast: all .18s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @media (prefers-color-scheme:dark){
      :root{
        --bg:#0b1220;
        --card:#0f1629;
        --ink:#e6ebff;
        --muted:#a9b8de;
        --line:#1b2744;
        --line-2:#142246;
        --current-school-bg: #0f1629;
        --current-school-border: #1e40af;
        --brand-ghost:#142c55;
      }
    }

    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{
      margin:0;
      font-family:'Tajawal',system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      color:var(--ink);
      background:var(--bg);
      line-height:1.75;
      display:flex;
      flex-direction:column;
      -webkit-font-smoothing:antialiased;
      text-rendering:optimizeLegibility;
    }
    img{max-width:100%;display:block}
    a{color:inherit}
    .container{width:100%;max-width:1240px;margin-inline:auto;padding:0 clamp(12px,3vw,24px)}
    .page-main{flex:1;padding:clamp(12px,2.5vw,24px) 0;animation:fadeUp .35s ease both}
    @keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}

    /* Accessibility */
    .skip-link{
      position:absolute; top:10px; right:10px; z-index:10001;
      background:var(--card); border:1px solid var(--line); border-radius:14px;
      padding:10px 12px; font-weight:900; text-decoration:none; color:var(--ink);
      transform:translateY(-140%); transition:transform .2s ease;
      box-shadow:var(--shadow2);
    }
    .skip-link:focus{transform:none; outline:none; box-shadow:var(--ring)}
    :focus-visible{outline:none; box-shadow:var(--ring)}
    @media (prefers-reduced-motion: reduce){
      *{animation:none!important;transition:none!important;scroll-behavior:auto!important}
    }

    /* Progress */
    .progress-bar{position:fixed;top:0;right:0;height:3px;width:0;background:linear-gradient(90deg,var(--brand),var(--accent));z-index:9999;transition:width .2s ease}

    /* ===== Header v2 ===== */
    .site-header{
      position:sticky;top:0;inset-inline:0;z-index:900;
      background:rgba(255,255,255,.82);
      border-bottom:1px solid var(--line-2);
      backdrop-filter:saturate(180%) blur(12px);
      transition:box-shadow .25s ease, background .25s ease, border-color .25s ease;
    }
    @supports not (backdrop-filter: blur(12px)){
      .site-header{background:var(--card)}
    }
    .site-header.scrolled{
      box-shadow:0 10px 30px rgba(2,6,23,.10);
      background:rgba(255,255,255,.92);
      border-color:#dfe7ff;
    }

    .hdr{display:flex;align-items:center;gap:12px;min-height:72px;padding:10px 0}

    .hdr-brand{
      display:flex;align-items:center;gap:12px;text-decoration:none;color:var(--ink);
      min-width:240px;
    }
    .hdr-brand img{
      width:42px;height:42px;object-fit:contain;border-radius:14px;
      background:#fff;border:1px solid var(--line);
      box-shadow:0 8px 18px rgba(2,6,23,.06);
    }
    .hdr-brand-txt{display:grid;gap:2px}
    .hdr-brand-name{font-weight:900;font-size:1.05rem;white-space:nowrap}
    .hdr-brand-sub{font-weight:800;color:var(--muted);font-size:.88rem;white-space:nowrap}
    @media(max-width:520px){.hdr-brand-sub{display:none}}

    .hdr-nav{display:flex;align-items:center;gap:6px;margin-inline-start:24px;margin-inline-end:auto;flex-wrap:wrap}
    .tab{
      display:inline-flex;align-items:center;gap:8px;min-height:44px;
      padding:0 14px;border-radius:999px;text-decoration:none;
      color:var(--ink);font-weight:900;border:1px solid transparent;
      transition:var(--t-fast);
    }
    .tab:hover{background:var(--brand-ghost);color:var(--brand)}
    .tab.is-active{background:var(--brand-ghost);color:var(--brand);border-color:#dbeafe}
    .pill{
      min-width:22px;height:22px;border-radius:999px;background:#ef4444;color:#fff;
      display:inline-grid;place-items:center;font-size:.78rem;padding:0 7px;font-weight:900;
    }

    .hdr-actions{display:flex;align-items:center;gap:10px}

    .icon-btn{
      position:relative;display:grid;place-items:center;
      width:44px;height:44px;border-radius:999px;
      border:1px solid var(--line);background:var(--card);
      color:var(--ink);text-decoration:none;transition:var(--t-fast);
    }
    .icon-btn:hover{transform:translateY(-1px);box-shadow:var(--shadow);border-color:#dbeafe}
    .dot{
      position:absolute;top:6px;left:6px;
      min-width:18px;height:18px;border-radius:999px;
      background:#ef4444;color:#fff;font-size:.72rem;
      display:grid;place-items:center;padding:0 5px;font-weight:900;
    }

    /* School Button - Enhanced */
    .school-btn{
      position:relative;
      display:inline-flex;align-items:center;gap:10px;
      min-height:44px; padding:6px 12px;
      border-radius:999px;border:1px solid var(--line);
      background:var(--card);cursor:pointer;font-weight:900;color:var(--ink);
      transition:var(--t-fast);
    }
    .school-btn:hover{transform:translateY(-1px);box-shadow:var(--shadow);border-color:#dbeafe}
    .school-btn i{color:var(--brand)}
    .school-btn-txt{display:grid;gap:2px;min-width:170px}
    .school-btn-top{font-size:.72rem;color:var(--muted);font-weight:900}
    .school-btn-name{font-size:.9rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    
    /* Pulse Effect */
    @keyframes pulse-ring {
      0% { box-shadow: 0 0 0 0 rgba(37,99,235, 0.4); }
      70% { box-shadow: 0 0 0 10px rgba(37,99,235, 0); }
      100% { box-shadow: 0 0 0 0 rgba(37,99,235, 0); }
    }
    .school-btn.pulse-active {
        animation: pulse-ring 2s infinite;
        background: var(--brand-ghost);
    }

    @media(max-width:1024px){.hdr-nav{display:none}}

    /* Hamburger */
    .hamburger{
      display:none;width:var(--tap);height:var(--tap);border-radius:14px;border:1px solid var(--line);
      align-items:center;justify-content:center;gap:4px;cursor:pointer;background:var(--card);
    }
    .hamburger span{display:block;width:18px;height:2px;background:#334155;border-radius:2px;transition:all .18s ease}
    .hamburger.active span:nth-child(1){transform:translateY(4px) rotate(45deg)}
    .hamburger.active span:nth-child(2){opacity:0}
    .hamburger.active span:nth-child(3){transform:translateY(-4px) rotate(-45deg)}
    @media(max-width:1024px){.hamburger{display:flex}}

    /* User menu */
    .userbox{position:relative}
    .avatar{
      width:44px;height:44px;border-radius:999px;display:grid;place-items:center;
      background:linear-gradient(180deg,#eef2ff,#fff);
      color:#1e40af;font-weight:900;border:1px solid #dbeafe;
      box-shadow:var(--shadow);cursor:pointer;transition:transform .18s ease;
    }
    .avatar:hover{transform:translateY(-1px)}
    .menu{
      position:absolute;inset:calc(100% + 10px) 0 auto auto;min-width:230px;background:var(--card);
      border:1px solid var(--line);border-radius:14px;box-shadow:0 20px 45px rgba(2,6,23,.14);
      padding:8px;opacity:0;transform:translateY(-6px) scale(.98);pointer-events:none;transition:all .18s ease;z-index:185;
    }
    /* Mobile: Ø§Ø¬Ø¹Ù„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØªØ¸Ù‡Ø± ÙŠÙ…ÙŠÙ† Ø§Ù„Ø´Ø§Ø´Ø© Ø¨Ø¯Ù„ Ø§Ù„ÙˆØ³Ø· */
    @media(max-width:520px){
      .menu{
        position:fixed;
        inset:auto;
        top:calc(var(--safe-top) + 78px);
        right:10px;
        left:auto;
        width:min(320px, calc(100vw - 20px));
        min-width:0;
        transform-origin: top right;
      }
    }
    .menu.open{opacity:1;transform:translateY(0) scale(1);pointer-events:auto}
    .menu .mi{display:flex;gap:10px;align-items:center;padding:10px 12px;border-radius:12px;color:var(--ink);text-decoration:none;font-weight:800}
    .menu .mi:hover{background:var(--line-2)}
    .menu .meta{color:var(--muted);font-size:.9rem;font-weight:800}

    /* Mobile drawer */
    .drawer-overlay{
      position:fixed;inset:0;background:rgba(2,6,23,.45);
      backdrop-filter:blur(6px);z-index:980;
      /* Initial state for transition */
      opacity: 0; visibility: hidden; transition: var(--t-fast);
    }
    .drawer{
      position:fixed; top:0; right:0; bottom:0; width:min(340px,88vw);
      background:var(--card); border-left:1px solid var(--line);
      z-index:990; transform:translateX(100%); 
      visibility: hidden;
      transition:transform .3s cubic-bezier(0.4, 0, 0.2, 1), visibility 0s .3s;
      display:flex;flex-direction:column; max-height:100vh;overflow:auto;
      padding-bottom:var(--safe-bottom);
    }
    .drawer.open{
      transform:translateX(0);
      visibility: visible;
      transition:transform .3s cubic-bezier(0.4, 0, 0.2, 1), visibility 0s 0s;
    }
    .drawer-overlay.show{opacity: 1; visibility: visible;}
    .drawer-head{display:flex;align-items:center;justify-content:space-between;padding:12px;border-bottom:1px solid var(--line)}
    .drawer-title{font-weight:900}
    .btn{display:inline-flex;align-items:center;justify-content:center;min-height:44px;padding:10px 14px;border-radius:14px;border:1px solid var(--line);background:var(--card);font-weight:900;cursor:pointer;text-decoration:none;color:var(--ink);transition:all .12s ease}
    .btn:hover{transform:translateY(-1px);box-shadow:var(--shadow)}
    .btn-primary{background:var(--brand);border-color:var(--brand);color:#fff}
    .drawer-nav{display:grid;padding:12px;gap:10px}
    .drawer-nav a{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:12px;border:1px solid var(--line);border-radius:14px;
      text-decoration:none;color:var(--ink);font-weight:900;
      background:linear-gradient(180deg,#fff,#fbfdff);
      transition:var(--t-fast);
    }
    .drawer-nav a:hover{background:var(--line-2)}
    .drawer-nav a.is-active{border-color:#c7d2fe;background:linear-gradient(180deg,#eef2ff,#ffffff);color:#1e40af}
    .drawer-footer{margin-top:auto;padding:12px;border-top:1px solid var(--line);display:flex;gap:10px;flex-wrap:wrap}

    /* Toasts (No change, they are excellent) */
    .messages{
      position:fixed;
      top:calc(var(--safe-top) + 78px);
      right:clamp(10px,2vw,16px);
      left:auto;
      width:min(420px, calc(100vw - 20px));
      z-index:950;
      display:grid;
      gap:10px;
      margin:0;
      pointer-events:none;
    }
    .msg{
      pointer-events:auto;
      position:relative;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.92);
      color:#0b1b3a;
      box-shadow:0 14px 40px rgba(2,6,23,.14);
      animation:fadeUp .28s ease both;
      overflow:hidden;
      font-weight:900;
    }
    .msg.success{background:rgba(240,255,246,.95);border-color:#c8f3d6;color:#064e3b}
    .msg.error{background:rgba(255,240,240,.95);border-color:#ffd4d4;color:#7f1d1d}
    .msg.warning{background:rgba(255,251,235,.95);border-color:#fed7aa;color:#7c2d12}
    .msg.info{background:rgba(239,246,255,.95);border-color:#bfdbfe;color:#0b1b3a}

    .msg-close{
      position:absolute;top:8px;left:8px;background:none;border:0;cursor:pointer;
      opacity:.7;transition:opacity .2s ease;padding:0;font-size:14px;color:inherit
    }
    .msg-close:hover{opacity:1}
    .msg-progress{position:absolute;bottom:0;left:0;height:3px;width:100%;background:rgba(0,0,0,0.08);overflow:hidden}
    .msg-progress::after{content:"";position:absolute;bottom:0;left:0;height:3px;width:100%;background:currentColor;opacity:.25;animation:progress 3.2s linear forwards}
    @keyframes progress{from{transform:translateX(-100%)}to{transform:none}}
    @media(max-width:520px){.messages{right:10px;left:10px;width:auto}}

    /* Footer v2 */
    .site-footer{border-top:1px solid var(--line-2);background:linear-gradient(180deg,#ffffff,#fbfdff)}
    .footer-v2{padding:18px 0;display:grid;gap:14px}
    .footer-row{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .footer-brand{display:flex;align-items:center;gap:12px}
    .footer-brand img{width:42px;height:42px;border-radius:14px;border:1px solid var(--line);background:#fff;object-fit:contain}
    .footer-brand b{font-weight:900}
    .footer-brand small{display:block;color:var(--muted);font-weight:800;margin-top:2px}
    .footer-links{display:flex;gap:10px;flex-wrap:wrap}
    .footer-links a{color:var(--ink);text-decoration:none;font-weight:900;padding:8px 10px;border-radius:14px}
    .footer-links a:hover{background:var(--brand-ghost);color:var(--brand)}
    .footer-copy{color:var(--muted);font-weight:800}

    /* To top */
    .to-top{
      position:fixed;left:16px;bottom:16px;z-index:880;
      display:none; width:44px;height:44px;border-radius:999px;border:1px solid var(--line);
      background:var(--card); place-items:center; box-shadow:var(--shadow); cursor:pointer;
      transition:transform .12s ease, box-shadow .12s ease;
    }
    .to-top:hover{transform:translateY(-2px); box-shadow:var(--shadow2)}

    /* School Modal - Enhanced Transitions */
    .school-modal{
      position:fixed;inset:0;z-index:12000;
      display:grid;place-items:center;
      padding:12px;background:rgba(2,6,23,0); /* Start transparent */
      backdrop-filter:blur(0px); /* Start no blur */
      opacity: 0; visibility: hidden;
      transition: opacity .3s ease, backdrop-filter .3s ease, visibility 0s .3s;
    }
    .school-modal.open{
      opacity: 1; visibility: visible;
      background:rgba(2,6,23,.55);
      backdrop-filter:blur(8px);
      transition: opacity .3s ease, backdrop-filter .3s ease, visibility 0s 0s;
    }
    
    .school-panel{
      width:min(560px,94vw);
      max-height:min(80vh,720px);
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow:0 40px 90px rgba(2,6,23,.28);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      /* Panel transition */
      transform: scale(.95) translateY(10px);
      transition: transform .3s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Springy effect */
    }
    .school-modal.open .school-panel{
      transform: scale(1) translateY(0);
    }
    
    .school-panel-h{
      padding:14px 16px;border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;gap:10px
    }
    .school-panel-h b{font-weight:900}
    .school-panel-close{
      width:44px;height:44px;border-radius:999px;border:1px solid var(--line);
      background:var(--card);cursor:pointer;transition:var(--t-fast)
    }
    .school-panel-close:hover{transform:rotate(90deg)}

    .school-panel-b{
      padding:14px 16px;
      display:grid;
      gap:12px;
      overflow-y: auto; /* Allow scrolling list */
      flex-grow: 1;
    }
    .school-search{
      width:100%;min-height:48px;border-radius:14px;border:1px solid var(--line);
      padding:12px 14px;font-weight:900;background:rgba(248,250,252,.9);color:var(--ink)
    }
    @media (prefers-color-scheme:dark){
      .school-search{background:#0b1833}
    }
    .school-list{margin:0;padding:0;list-style:none;display:grid;gap:10px}
    
    /* School Item - Detailed Design */
    .school-item{
      width:100%;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border:2px solid var(--line); /* Increased border for better feel */
      border-radius:14px;background:linear-gradient(180deg,#fff,#fbfdff);
      padding:12px 14px;cursor:pointer;font-weight:900;
      text-align:right;
      transition:var(--t-fast);
    }
    @media (prefers-color-scheme:dark){
      .school-item{background:linear-gradient(180deg,#0f1629,#0b1220)}
    }
    .school-item:hover{
      border-color:var(--brand);
      background:var(--brand-ghost);
      transform:translateY(-1px);
      box-shadow:var(--shadow);
    }
    .school-item.current-school{
      border-color:var(--current-school-border);
      background:var(--current-school-bg);
      pointer-events:none; /* Cannot click current school */
      box-shadow: 0 4px 12px rgba(37,99,235,.15);
    }

    .school-item-text {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 2px;
    }
    .school-item-text b { font-weight: 950; font-size: 1rem; }
    .school-item small{display:block;color:var(--muted);font-weight:800;margin-top:0px;font-size:.85rem}
    .school-item .tag{
      padding:6px 10px;border-radius:999px;
      background:#eef2ff;color:#1e40af;border:1px solid #dbeafe;
      font-size:.8rem;font-weight:900;white-space:nowrap;
      min-width: 60px; /* Standardize tag size */
      text-align: center;
    }
    .school-item.current-school .tag{
      background:#dcfce7;color:#065f46;border-color:#bbf7d0;
    }


    /* TV / Large */
    @media(min-width:1400px){
      body{font-size:18px}
      .hdr{min-height:78px}
      .tab{min-height:46px}
    }
  </style>

  {% block head %}{% endblock %}
</head>

<body class="page">
  {% if SUBSCRIPTION_WARNING %}
  <div style="background-color: #fff7ed; border-bottom: 1px solid #fdba74; color: #c2410c; padding: 12px; text-align: center; font-weight: bold;">
    <div class="container">
      <i class="fas fa-exclamation-triangle ml-2"></i>
      ØªÙ†Ø¨ÙŠÙ‡: Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ù…Ø¯Ø±Ø³Ø© ÙŠÙ†ØªÙ‡ÙŠ Ø®Ù„Ø§Ù„ {{ SUBSCRIPTION_DAYS_LEFT }} ÙŠÙˆÙ…. 
      <a href="{% url 'reports:my_subscription' %}" style="text-decoration: underline; margin-right: 8px;">ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø¢Ù†</a>
    </div>
  </div>
  {% endif %}
  <a class="skip-link" href="#mainContent">ØªØ®Ø·ÙŠ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø­ØªÙˆÙ‰</a>
  <div class="progress-bar" id="scrollProgress"></div>

  <header class="site-header" id="siteHeader">
    <div class="container hdr">
      <button class="hamburger" id="hamburger" aria-label="ÙØªØ­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©" aria-controls="mobile-drawer" aria-expanded="false">
        <span></span><span></span><span></span>
      </button>

      <a class="hdr-brand" href="{% url 'reports:home' %}">
        <img src="{% if SCHOOL_LOGO_URL %}{{ SCHOOL_LOGO_URL }}{% else %}{% static 'img/logo1.png' %}{% endif %}" alt="Ø§Ù„Ø´Ø¹Ø§Ø±" width="42" height="42" loading="eager" decoding="async">
        <div class="hdr-brand-txt">
          <div class="hdr-brand-name">{% if SCHOOL_NAME %}{{ SCHOOL_NAME }}{% else %}Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±{% endif %}</div>
          <div class="hdr-brand-sub">Ù…Ù†ØµØ© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„ØªØ°Ø§ÙƒØ±</div>
        </div>
      </a>

      {% with active=request.resolver_match.url_name %}
      <nav class="hdr-nav" aria-label="Ø±ÙˆØ§Ø¨Ø·">
        {% if request.user.is_authenticated %}
          <a class="tab {% if active == 'home' %}is-active{% endif %}" href="{% url 'reports:home' %}">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>

          {% url 'reports:assigned_to_me' as inbox_url %}
          {% if inbox_url %}
            <a class="tab {% if active == 'assigned_to_me' %}is-active{% endif %}" href="{{ inbox_url }}">
              Ø§Ù„ÙˆØ§Ø±Ø¯
              {% if NAV_ASSIGNED_TO_ME %}<span class="pill">{{ NAV_ASSIGNED_TO_ME }}</span>{% endif %}
            </a>
          {% endif %}

          {% if SHOW_OFFICER_REPORTS_LINK %}
            <a class="tab {% if active == 'officer_reports' %}is-active{% endif %}" href="{% url 'reports:officer_reports' %}">ØªÙ‚Ø§Ø±ÙŠØ± Ù‚Ø³Ù…ÙŠ</a>
          {% endif %}

          {% if SHOW_ADMIN_DASHBOARD_LINK %}
            {% if request.user.is_superuser %}
              <a class="tab {% if active == 'platform_admin_dashboard' %}is-active{% endif %}" href="{% url 'reports:platform_admin_dashboard' %}">Ù„ÙˆØ­Ø© Ø§Ù„Ø¢Ø¯Ù…Ù†</a>
            {% else %}
              <a class="tab {% if active == 'admin_dashboard' %}is-active{% endif %}" href="{% url 'reports:admin_dashboard' %}">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±</a>
            {% endif %}
          {% endif %}
        {% else %}
          <a class="tab is-active" href="{% url 'reports:login' %}">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>
        {% endif %}
      </nav>
      {% endwith %}

      <div class="hdr-actions">
        {% if request.user.is_authenticated %}

          {% if USER_SCHOOLS|length > 1 %}
            <button type="button" class="school-btn pulse-active" id="openSchoolModal" aria-haspopup="dialog" aria-controls="schoolModal" aria-expanded="false">
              <i class="fa-solid fa-school" aria-hidden="true"></i>
              <span class="school-btn-txt">
                <span class="school-btn-top">Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</span>
                <span class="school-btn-name">{% if SCHOOL_NAME %}{{ SCHOOL_NAME }}{% else %}Ø§Ø®ØªØ± Ù…Ø¯Ø±Ø³Ø©{% endif %}</span>
              </span>
              <i class="fa-solid fa-chevron-down" aria-hidden="true"></i>
            </button>
          {% endif %}

          {% url 'reports:my_notifications' as my_notifications_url %}
          {% if my_notifications_url %}
            <a class="icon-btn" href="{{ my_notifications_url }}" aria-label="Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª">
              <i class="fa-solid fa-bell"></i>
              {% if NAV_NOTIFICATIONS_UNREAD %}<span class="dot">{{ NAV_NOTIFICATIONS_UNREAD }}</span>{% endif %}
            </a>
          {% endif %}

          {% if CAN_SEND_NOTIFICATIONS and SEND_NOTIFICATION_URL %}
            <a class="icon-btn" href="{{ SEND_NOTIFICATION_URL }}" aria-label="Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±" title="Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±">
              <i class="fa-solid fa-bullhorn"></i>
            </a>
          {% endif %}

          <div class="userbox">
            {% firstof request.user.name request.user.phone request.user.national_id "Ø­Ø³Ø§Ø¨ÙŠ" as display_name %}
            <button class="avatar" id="userAvatar" type="button" aria-haspopup="menu" aria-expanded="false" title="{{ display_name }}">
              {{ display_name|slice:":1" }}
            </button>
            <div class="menu" id="userMenu" role="menu" aria-label="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
              <div class="mi" tabindex="0" style="cursor:default">
                <div>
                  <div style="font-weight:900">{{ display_name }}</div>
                  <div class="meta">Ù…Ø±Ø­Ø¨Ø§Ù‹ ğŸ‘‹</div>
                </div>
              </div>
              <a href="{% url 'reports:logout' %}" class="mi" role="menuitem">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
            </div>
          </div>

        {% else %}
          <a class="tab is-active" href="{% url 'reports:login' %}">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>
        {% endif %}
      </div>
    </div>
  </header>

  <div class="drawer-overlay" id="drawerOverlay"></div>
  <aside class="drawer" id="mobile-drawer" aria-hidden="true" aria-labelledby="drawerTitle">
    <div class="drawer-head">
      <div id="drawerTitle" class="drawer-title">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</div>
      <button class="btn" id="drawerClose" aria-label="Ø¥ØºÙ„Ø§Ù‚">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>

    {% with active=request.resolver_match.url_name %}
    <nav class="drawer-nav" aria-label="Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©">
      {% if request.user.is_authenticated %}
        <a class="{% if active == 'home' %}is-active{% endif %}" href="{% url 'reports:home' %}">
          <span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
          <i class="fa-solid fa-house"></i>
        </a>

        {% url 'reports:assigned_to_me' as inbox_url %}
        {% if inbox_url %}
          <a class="{% if active == 'assigned_to_me' %}is-active{% endif %}" href="{{ inbox_url }}">
            <span>Ø§Ù„ÙˆØ§Ø±Ø¯</span>
            <span>{% if NAV_ASSIGNED_TO_ME %}<span class="pill">{{ NAV_ASSIGNED_TO_ME }}</span>{% endif %}</span>
          </a>
        {% endif %}

        {% if SHOW_OFFICER_REPORTS_LINK %}
          <a class="{% if active == 'officer_reports' %}is-active{% endif %}" href="{% url 'reports:officer_reports' %}">
            <span>ØªÙ‚Ø§Ø±ÙŠØ± Ù‚Ø³Ù…ÙŠ</span>
            <i class="fa-solid fa-layer-group"></i>
          </a>
        {% endif %}

        {% if SHOW_ADMIN_DASHBOARD_LINK %}
          {% if request.user.is_superuser %}
            <a class="{% if active == 'platform_admin_dashboard' %}is-active{% endif %}" href="{% url 'reports:platform_admin_dashboard' %}">
              <span>Ù„ÙˆØ­Ø© Ø§Ù„Ø¢Ø¯Ù…Ù†</span>
              <i class="fa-solid fa-gauge-high"></i>
            </a>
          {% else %}
            <a class="{% if active == 'admin_dashboard' %}is-active{% endif %}" href="{% url 'reports:admin_dashboard' %}">
              <span>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±</span>
              <i class="fa-solid fa-gauge"></i>
            </a>
          {% endif %}
        {% endif %}

        <div class="drawer-footer">
          {% if USER_SCHOOLS|length > 1 %}
            <button type="button" class="btn btn-primary" id="openSchoolModalMobile" style="width:100%">
              <i class="fa-solid fa-school" style="margin-left:8px"></i>
              ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©
            </button>
          {% endif %}
          <a class="btn" href="{% url 'reports:logout' %}" style="flex-grow:1">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
        </div>
      {% else %}
        <a class="{% if active == 'login' %}is-active{% endif %}" href="{% url 'reports:login' %}">
          <span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</span>
          <i class="fa-solid fa-right-to-bracket"></i>
        </a>
      {% endif %}
    </nav>
    {% endwith %}
  </aside>

  {% if messages %}
    <div class="messages" id="messages-container" aria-live="polite" aria-atomic="true">
      {% for message in messages %}
        <div class="msg {% if message.tags %}{{ message.tags }}{% else %}info{% endif %}" data-autohide="true">
          <button class="msg-close" aria-label="Ø¥ØºÙ„Ø§Ù‚"><i class="fa-solid fa-xmark"></i></button>
          {{ message }}
          <div class="msg-progress"></div>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <main class="container page-main" id="mainContent">
    {% block content %}{% endblock %}
  </main>

  <footer class="site-footer" aria-label="ØªØ°ÙŠÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…">
    <div class="container footer-v2">
      <div class="footer-row">
        <div class="footer-brand">
          <img src="{% if SCHOOL_LOGO_URL %}{{ SCHOOL_LOGO_URL }}{% else %}{% static 'img/logo1.png' %}{% endif %}" alt="Ø§Ù„Ø´Ø¹Ø§Ø±" loading="lazy" decoding="async">
          <div>
            <b>{% if SCHOOL_NAME %}{{ SCHOOL_NAME }}{% else %}Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±{% endif %}</b>
            <small>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„ØªØ°Ø§ÙƒØ± â€” ØªØ¬Ø±Ø¨Ø© Ø¹Ø±Ø¨ÙŠØ© Ø§Ø­ØªØ±Ø§ÙÙŠØ©</small>
          </div>
        </div>

        <nav class="footer-links" aria-label="Ø±ÙˆØ§Ø¨Ø· Ø³Ø±ÙŠØ¹Ø©">
          {% if request.user.is_authenticated %}
            <a href="{% url 'reports:home' %}">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
            <a href="{% url 'reports:my_reports' %}">ØªÙ‚Ø§Ø±ÙŠØ±ÙŠ</a>
            <a href="{% url 'reports:my_requests' %}">Ø·Ù„Ø¨Ø§ØªÙŠ</a>
          {% else %}
            <a href="{% url 'reports:login' %}">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>
          {% endif %}
        </nav>
      </div>

      <div class="footer-copy">
        Â© {% now "Y" %} Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.
      </div>
    </div>
  </footer>

  <button class="to-top" id="toTop" aria-label="Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø£Ø¹Ù„Ù‰">
    <i class="fa-solid fa-arrow-left-long" style="transform:rotate(90deg)"></i>
  </button>

  {% if request.user.is_authenticated %}
    {% if USER_SCHOOLS|length > 1 %}
      <div class="school-modal" id="schoolModal">
        <div class="school-panel" role="dialog" aria-modal="true" aria-labelledby="schoolModalTitle">
          <div class="school-panel-h">
            <div>
              <b id="schoolModalTitle">Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„Ù…Ø¯Ø§Ø±Ø³</b>
              <div style="color:var(--muted);font-weight:900;font-size:.9rem;margin-top:2px">Ø§Ø¨Ø­Ø« Ø«Ù… Ø§Ø®ØªØ± Ù…Ø¯Ø±Ø³Ø© Ù„Ù„ØªØ¨Ø¯ÙŠÙ„ ÙÙˆØ±Ø§Ù‹</div>
            </div>
            <button type="button" class="school-panel-close" id="closeSchoolModal" aria-label="Ø¥ØºÙ„Ø§Ù‚">
              <i class="fa-solid fa-xmark"></i>
            </button>
          </div>

          <div class="school-panel-b">
            <input type="search" class="school-search" id="schoolSearch" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ù„Ù„Ø¨Ø­Ø«..." aria-label="Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¯Ø±Ø³Ø©">

            <form method="post" action="{% url 'reports:switch_school' %}" id="schoolSwitchForm">
              {% csrf_token %}
              <input type="hidden" name="next" value="{{ request.path }}">
              <input type="hidden" name="school_id" id="schoolIdField">

              <ul class="school-list" id="schoolList">
                {% for s in USER_SCHOOLS %}
                  <li>
                    <button type="button" 
                      class="school-item {% if SCHOOL_ID and s.id == SCHOOL_ID %}current-school{% endif %}" 
                      data-school-id="{{ s.id }}"
                      data-school-name="{{ s.name }}"
                    >
                      <div class="school-item-text">
                        <b>{{ s.name }}</b>
                        <small>{% if s.id == SCHOOL_ID %}Ù‡Ø°Ù‡ Ù‡ÙŠ Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©{% else %}Ø§Ø¶ØºØ· Ù„Ù„ØªØ¨Ø¯ÙŠÙ„{% endif %}</small>
                      </div>
                      <span class="tag">
                        {% if s.id == SCHOOL_ID %}Ø§Ù„Ø­Ø§Ù„ÙŠØ©{% else %}ØªØ¨Ø¯ÙŠÙ„{% endif %}
                      </span>
                    </button>
                  </li>
                {% endfor %}
              </ul>

              <noscript>
                <div style="margin-top:10px">
                  <select name="school_id" style="width:100%;min-height:48px;border-radius:14px;border:1px solid var(--line);padding:10px;font-weight:900">
                    {% for s in USER_SCHOOLS %}
                      <option value="{{ s.id }}" {% if SCHOOL_ID and s.id == SCHOOL_ID %}selected{% endif %}>{{ s.name }}</option>
                    {% endfor %}
                  </select>
                  <button class="btn btn-primary" type="submit" style="margin-top:10px;width:100%">ØªØ¨Ø¯ÙŠÙ„</button>
                </div>
              </noscript>
            </form>
          </div>
        </div>
      </div>
    {% endif %}
  {% endif %}

  <script>
    // Progress + Header shadow (No change)
    (function(){
      const bar = document.getElementById('scrollProgress');
      const header = document.getElementById('siteHeader');
      const onScroll = ()=>{
        const h = document.documentElement;
        const sc = h.scrollTop;
        const max = h.scrollHeight - h.clientHeight;
        if(bar) bar.style.width = (max ? (sc/max)*100 : 0) + '%';
        if(header) header.classList.toggle('scrolled', window.scrollY > 4);
      };
      window.addEventListener('scroll', onScroll, {passive:true});
      onScroll();
    })();

    // Toasts (No change)
    (function(){
      const container = document.getElementById('messages-container');
      if(!container) return;
      container.querySelectorAll('.msg').forEach((el)=>{
        const closeBtn = el.querySelector('.msg-close');
        if(closeBtn) closeBtn.addEventListener('click', ()=> el.remove());
        if(el.dataset.autohide === 'true'){
          setTimeout(()=>{ if (el && el.parentNode){ el.remove(); } }, 3400);
        }
      });
    })();

    // Drawer (Slight change to respect initial visibility via CSS)
    (function(){
      const drawer   = document.getElementById('mobile-drawer');
      const overlay  = document.getElementById('drawerOverlay');
      const hamburger= document.getElementById('hamburger');
      const closeBtn = document.getElementById('drawerClose');
      if(!drawer || !overlay || !hamburger) return;

      const lockScroll = (on)=>{ document.documentElement.style.overflow = on ? 'hidden' : ''; };

      const open = ()=>{
        drawer.classList.add('open');
        overlay.classList.add('show');
        hamburger.classList.add('active'); hamburger.setAttribute('aria-expanded','true');
        drawer.setAttribute('aria-hidden','false');
        lockScroll(true);
      };
      const close = ()=>{
        drawer.classList.remove('open');
        overlay.classList.remove('show');
        hamburger.classList.remove('active'); hamburger.setAttribute('aria-expanded','false');
        drawer.setAttribute('aria-hidden','true');
        lockScroll(false);
      };

      hamburger.addEventListener('click', ()=> drawer.classList.contains('open') ? close() : open());
      if(closeBtn) closeBtn.addEventListener('click', close);
      overlay.addEventListener('click', (e)=>{ if(e.target === overlay) close(); });
      document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') close(); });

      drawer.addEventListener('click', (e)=>{
        const a = e.target.closest('a');
        if(a && a.href) close();
      });
    })();

    // User menu (No change)
    (function(){
      const avatar = document.getElementById('userAvatar');
      const menu = document.getElementById('userMenu');
      if(!avatar || !menu) return;
      const close = ()=>{ menu.classList.remove('open'); avatar.setAttribute('aria-expanded','false'); };
      avatar.addEventListener('click', ()=>{
        const isOpen = menu.classList.toggle('open');
        avatar.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
      });
      document.addEventListener('click', (e)=>{
        if(!e.target.closest('#userMenu') && !e.target.closest('#userAvatar')) close();
      });
      document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') close(); });
    })();

    // To top (No change)
    (function(){
      const toTop = document.getElementById('toTop');
      if(!toTop) return;
      const toggle = ()=>{ window.scrollY > 260 ? (toTop.style.display='grid') : (toTop.style.display='none'); };
      window.addEventListener('scroll', toggle, {passive:true}); toggle();
      toTop.addEventListener('click', ()=>window.scrollTo({top:0, behavior:'smooth'}));
    })();
    
    // Cookies helper (No change)
    (function(){
      window.getCookie = function(name){
        const parts = document.cookie ? document.cookie.split('; ') : [];
        for(const p of parts){
          const i = p.indexOf('=');
          const k = i > -1 ? p.slice(0,i) : p;
          if(k === name) return i > -1 ? decodeURIComponent(p.slice(i+1)) : '';
        }
        return null;
      };
      window.setCookie = function(name, value, days){
        const d = new Date(Date.now() + (days||7)*864e5);
        const secure = location.protocol === 'https:' ? '; Secure' : '';
        document.cookie = name + '=' + encodeURIComponent(value) + '; path=/; expires=' + d.toUTCString() + '; SameSite=Lax' + secure;
      };
    })();

    // School Modal Logic - Enhanced
    (function(){
      const modal = document.getElementById('schoolModal');
      const openBtn = document.getElementById('openSchoolModal');
      const openBtnMobile = document.getElementById('openSchoolModalMobile');
      const closeBtn = document.getElementById('closeSchoolModal');
      const form = document.getElementById('schoolSwitchForm');
      const schoolIdField = document.getElementById('schoolIdField');
      const schoolList = document.getElementById('schoolList');
      const searchInput = document.getElementById('schoolSearch');
      
      if (!modal || !form || !schoolList) return;

      const lockScroll = (on)=>{ document.documentElement.style.overflow = on ? 'hidden' : ''; };

      const openModal = () => {
        modal.classList.add('open');
        modal.setAttribute('aria-hidden', 'false');
        lockScroll(true);
        // Focus the search input for immediate typing
        setTimeout(() => searchInput.focus(), 300);
      };

      const closeModal = () => {
        modal.classList.remove('open');
        modal.setAttribute('aria-hidden', 'true');
        lockScroll(false);
      };

      // 1. Open/Close Handlers
      if (openBtn) openBtn.addEventListener('click', openModal);
      if (openBtnMobile) openBtnMobile.addEventListener('click', openModal);
      closeBtn.addEventListener('click', closeModal);
      modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
      });
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.classList.contains('open')) closeModal();
      });

      // 2. School Selection Handler
      schoolList.addEventListener('click', (e) => {
        const item = e.target.closest('.school-item');
        if (item && !item.classList.contains('current-school')) {
          const schoolId = item.dataset.schoolId;
          schoolIdField.value = schoolId;
          form.submit();
        }
      });

      // 3. Search Filter Logic
      searchInput.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase().trim();
        const items = schoolList.querySelectorAll('li');
        
        items.forEach(li => {
          const name = li.querySelector('.school-item').dataset.schoolName.toLowerCase();
          if (name.includes(query)) {
            li.style.display = '';
          } else {
            li.style.display = 'none';
          }
        });
      });
      
      // 4. Initial Pulse check (If a school is selected, remove the pulse)
      const currentSchoolId = '{{ SCHOOL_ID|default:"" }}';
      if (openBtn && currentSchoolId) {
          // You might check an additional flag here if the system needs to force a school selection
          // For now, if SCHOOL_ID exists, we assume a school is selected.
          openBtn.classList.remove('pulse-active');
      }

    })();
  </script>
  {% block scripts %}{% endblock %}
</body>
</html>